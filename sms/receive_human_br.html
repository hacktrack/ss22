<?php
/*
	PHP script called by Human Gateway (human.com.br) via HTTP POST to deliver SMSs to IceWarp as e-mails.

	Human has configured to call URL http://myserver.mydomain.com/sms/human_receive.php

	The call from Human includes following GET variables:

		$_GET['id']     ==> a sequential number generated by her system
		$_GET['from']   ==> the cell number that sent the message
		$_GET['to']     ==> the cell number from Human Gateway corresponding to my account
		$_GET['msg']    ==> the short message (SMS) text
		$_GET['acount'] ==> NULL
		$_GET['date']   ==> Date/hour in format dd/mm/yyyy hh:mm:ss

    Notice in this case that the gateway ID and password of the gateway in IceWarp both have a value of "1".  
	More details in F1 help (HTTP Request ï¿½ Delivery Script section)

* Thanks to Eduardo de Carli (Grupo Baumgart/Vedacit) for the script. Notice it was designed for IceWarp Linux, so under Windows you will need to adjust the logging feature or comment it out.

 */
	
//	Log the receiving SMS to /opt/icewarp/html/sms/human.log
	error_log(date('d/m/Y H:i:s')." Human - id:".$_GET['id']."-from:".$_GET['from']."-to:".$_GET['to']."-msg:".$_GET['msg']."-acount".$_GET['acount']."-date:".$_GET['date']."\n",3,"/opt/icewarp/html/sms/human.log");

// 	Shared libraries
	define('SHAREDLIB_PATH', get_cfg_var('icewarp_sharedlib_path'));
	include(SHAREDLIB_PATH . 'api/api.php');
  
//      Build $url with gateway's parameters to pass to IceWarp API
//		id=1   	==> id of Human gateway in Icewarp SMS/General admin
//		pass=1 	==> password defined in Icewarp SMS/General admin
// for Human Gateway
$url = 
    'number=' . urlencode($_GET['from']) . 
    '&id=1' .  
    '&pass=1' .  
    '&data=' . urlencode($_GET['msg']);

//	Deliver SMS to IceWarp
	$api = new IceWarpAPI();
	$result = $api->SMSIncoming($url);

//	Result
	if (!$result) 
	{
		header('HTTP/1.1 503 Service Unavailable');
	}
?>
