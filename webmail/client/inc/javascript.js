
/* client/inc/class_alfresco.js */
(function(){var ACCOUNT='@@alfresco@@',DS='alfresco';function enabled(){return!!dataSet.get('accounts',[sPrimaryAccount,'ALFRESCO']);}
function getLastFolder(bFullPath){var path=Cookie.get(['last_used_folder','K'])||ACCOUNT;if(bFullPath)
return path;else
return Path.split(path,true).fid;}
function setLastFolder(folder){return Cookie.set(['last_used_folder','K'],ACCOUNT+'/'+folder);}
function getFolderInfo(folderId,aHandler){if((folderId&&!dataSet.get(DS,[ACCOUNT,folderId,'LOADED']))||(!folderId&&!dataSet.get(DS,[ACCOUNT]))){return WMFolders.list({aid:ACCOUNT,fid:folderId},'','',[parseFolder,[{aid:ACCOUNT,fid:folderId||''},aHandler]],[parseError,[folderId]]);}
else
if(aHandler)
executeCallbackFunction(aHandler,true,{aid:ACCOUNT,fid:folderId||''});};function parseFolder(aData,aFolder,aHandler){if(aData){if(aFolder&&~aFolder.fid.indexOf('/')){var tmp,aPath=aFolder.fid.split('/');for(;aPath.length>1;){aPath.pop();tmp=aPath.join('/');if(!dataSet.get(DS,[ACCOUNT,tmp])){dataSet.add(DS,[ACCOUNT,tmp],{TYPE:'F',RIGHTS:'rwtl',LOADED:false},true);}}}
aData=aData[ACCOUNT];for(var fid in aData){dataSet.add(DS,[ACCOUNT,fid],{TYPE:aData[fid].TYPE,RIGHTS:aData[fid].RIGHTS,LOADED:fid==aFolder.fid},true);if(aData[fid].SUBFOLDERS&&aData[fid].SUBFOLDERS.FOLDERS){var aSubFolders=aData[fid].SUBFOLDERS.FOLDERS;for(var sfid in aSubFolders){if(!dataSet.get(DS,[ACCOUNT,fid+'/'+sfid])){dataSet.add(DS,[ACCOUNT,fid+'/'+sfid],{TYPE:aData[fid].TYPE,RIGHTS:aData[fid].RIGHTS,LOADED:false},true);}}}
dataSet.update(DS,[ACCOUNT,fid]);}
if(aHandler)
executeCallbackFunction(aHandler,true,aFolder||{aid:ACCOUNT});}
else
if(sFolder){if(aHandler)
executeCallbackFunction(aHandler,false);}};function parseError(aData,id,sError,folderId){console.log('Alfresco',id,sError);if(folderId&&id=='404'){var ds=dataSet.get(DS,[ACCOUNT]),bUpd=false;for(var fid in ds){if(fid==folderId||fid.indexOf(folderId+'/')===0){delete ds[fid];bUpd=true;}}
if(bUpd)
dataSet.update(DS,[ACCOUNT]);}
if(gui.notifier)
gui.notifier._value({type:'alert',args:{header:'ALERTS::ALERT',text_plain:sError.escapeHTML()}});};window.Alfresco={getLastFolder:getLastFolder,setLastFolder:setLastFolder,getFolderInfo:getFolderInfo,enabled:enabled};})();

/* client/inc/class_cookie.js */
function class_cookie(){var me=this;this._toStore={};this._notSave=false;storage.library('gw_others');var tmp=GWOthers.get('COOKIE_SETTINGS','storage');if(tmp&&tmp.VALUES){var aData={};for(var i in tmp.VALUES)
try{if(tmp.VALUES[i].charAt(0)=='{'||tmp.VALUES[i].charAt(0)=='['){try{aData[i]=new Function("return "+tmp.VALUES[i])();}catch(e){aData[i]=new Function("return "+tmp.VALUES[i].replace(/'.*?':/gm,function(key){return"'"+(key.replace(/^'|':$/g,'').replace(/([^\\])'/g,"$1\\'"))+"':";}))();}}else{aData[i]=tmp.VALUES[i];}}
catch(r){aData[i]=tmp.VALUES[i];}
dataSet.add('cookies','',aData);}
dataSet.obey(this,'','cookies',true);dataSet.remove('storage',['COOKIE_SETTINGS']);this.__defaultViews={'C':{type:'C',view:'list_wide',sort:{column:'ITMCLASSIFYAS',type:'asc'}},'E':{type:'E',view:GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','event_view'),sort:{column:'EVENT_STARTDATE',type:'desc'}},'J':{type:'J',view:'list',sort:{column:'EVENT_STARTDATE',type:'desc'}},'G':{type:'G',view:'list',sort:{column:'ITM_DELETED',type:'desc'}},'M':{type:'M',view:'mail_view_wide',sort:{column:'DATE',type:'desc'}},'MH':{type:'M',view:'list',sort:{column:'DATE',type:'desc'}},'N':{type:'N',view:'list_wide',sort:{column:'EVNTITLE',type:'asc'}},'F':{type:'F',view:'list_wide',sort:{column:'EVNFILENAME',type:'asc'}},'K':{type:'K',view:'list',sort:{column:'EVNFILENAME',type:'asc'}},'Q':{type:'Q',view:'mail_view_wide',sort:{column:'QDATE',type:'desc'}},'QL':{type:'QL',view:'list',sort:{column:'SNDEMAIL',type:'asc'}},'T':{type:'T',view:'list',sort:{column:'TASK_ENDDATE',type:'desc'}},'I':{type:'I',view:'chat_view'},'Y':{type:'Y',view:'chat_view'},'W':{type:'W',view:'conference_view'},'S':{type:'X',view:'nothing'},'X':{type:'X',view:'nothing'}};this.__defaultRights=['r','i','w','t','l','k','x','a'];this._interval=setInterval(function(){me.store();},10000);};class_cookie.prototype.set=function(aPath,aData,bForce){if(!Is.Array(aPath))return;if(aPath[0]=='views'&&aPath[1]&&aPath[2]){var aFolType=this.__getViewType(aPath);if(aFolType.type){aPath.splice(0,3,'view',aFolType.type);if(aPath[2]=='columns')
dataSet.remove('cookies',aPath,true);if(aFolType.subtype&&(aPath[2]=='sort'||aPath.length<3)){aPath2=clone(aPath);aPath2[1]=aFolType.subtype;this.__set(aPath2,aData);if(aPath.length<3)
aData.sort=this.get([aPath[0],aPath[1],'sort']);else
return;}}
else
return;}
else
if(aPath[0]=='rights'&&aPath[1]&&aPath[2]&&aData&&arrayCompare(aData,this.__defaultRights)){if(!dataSet.get('cookies',aPath))
return;else
aData='';}
this.__set(aPath,aData,bForce);};class_cookie.prototype.__set=function(aPath,aData,bForce){if(!aData&&aPath.length>1)
dataSet.remove('cookies',aPath,bForce);else
dataSet.add('cookies',aPath,aData,bForce);if(bForce)
dataSet.update('cookies',aPath);this._notSave=false;};class_cookie.prototype.__getViewType=function(aPath){var sFolType=WMFolders.getType([aPath[1],aPath[2]]),sSubType='';if(sFolType=='M'){if(aPath[2]=='INBOX')
sSubType='MI';else
if(aPath[2].split('/').shift()==sPrimaryAccountAPREFIX){sSubType='MA';}
else{var d;if(dataSet.get('folders',[aPath[1],aPath[2],'RSS']))
d='R';else
d=dataSet.get('folders',[aPath[1],aPath[2],'DEFAULT']);switch(d){case'H':return{type:'MH'};case'S':case'D':case'R':sSubType='M'+d;}}}
return{type:sFolType,subtype:sSubType};};class_cookie.prototype.get=function(aPath){if(aPath){if(aPath[0]=='rights'&&aPath[1]&&aPath[2])
return dataSet.get('cookies',aPath)||this.__defaultRights;else
if(aPath[0]=='views'&&aPath[1]&&aPath[2]){var aFolType=this.__getViewType(aPath),tmp=Object.assign({},this.__defaultViews[aFolType.type],dataSet.get('cookies',['view',aFolType.type]));if(aFolType.subtype){if(tmp.sort)
tmp=Object.assign(tmp,{sort:dataSet.get('cookies',['view',aFolType.subtype,'sort'])||tmp.sort});}
return aPath.length>3?arrayPath(tmp,aPath.splice(3)):tmp;}}
return dataSet.get('cookies',aPath,true);};class_cookie.prototype.__update=function(sName,aDPath){if(aDPath&&aDPath[0])
this._toStore[aDPath[0]]=true;};class_cookie.prototype.store=function(aHandler){if(this._notSave||(window.navigator&&window.navigator.onLine===false))return;var yes=false,aData={};for(var i in this._toStore){yes=true;aData[i]=dataSet.get('cookies',[i]);if(typeof aData[i]=='object'){aData[i]=arrToString(aData[i]);if(aData[i].length==2)aData[i]='';}}
this._toStore={};if(yes){GWOthers.set('COOKIE_SETTINGS',aData,'storage');WMStorage.set({'resources':{'COOKIE_SETTINGS':dataSet.get('storage',['COOKIE_SETTINGS'])}},'storage','',aHandler);dataSet.remove('storage',['COOKIE_SETTINGS']);}
return yes;};

/* client/inc/class_folder.js */
(function(){function _deleteFolder(sAccountID,sFolderID){var aFolders=dataSet.get('folders',[sAccountID],true),bPerfm=false,bRefresh=false,sActive=dataSet.get('active_folder');for(var i in aFolders)
if(i==sFolderID||i.indexOf(sFolderID+'/')===0){bPerfm=true;if(sActive&&!bRefresh&&(sActive==sAccountID+'/'+i||sActive.indexOf(sAccountID+'/'+i+'/')==0))
bRefresh=true;delete aFolders[i];}
if(bRefresh)
gui.frm_main._selectView(_getNextFolder({aid:sAccountID,fid:sFolderID},aFolders));if(bPerfm)
dataSet.add('folders',[sAccountID],aFolders);WMFolders.remove({'aid':sAccountID,'fid':sFolderID},'folders');};function _getNextFolder(arg,aFolders){var sNextFolder,sType=WMFolders.getType(arg);switch(sType){case'X':return;case'I':var aFolders=aFolders||dataSet.get('folders',[arg.aid]),fid,fidPrivate;for(var i in aFolders){if(i!=arg.fid&&aFolders[i].TYPE=='I'){if(aFolders[i].OWNER==wm_folders.aux.private_owner){fidPrivate=i;break;}
if(!fid)
fid=i;}else if(aFolders[i].TYPE==='Y'){fidRoot=i;}}
sNextFolder=fidPrivate||fid||fidRoot;break;case'M':sNextFolder='INBOX';break;default:sNextFolder=Mapping.getDefaultFolderForGWType(sType);}
if(sNextFolder&&WMFolders.getType({aid:sPrimaryAccount,fid:sNextFolder}))
return{aid:sPrimaryAccount,fid:sNextFolder};};function _moveFolder(sAccount,sOldFolder,sNewFolder,bDeactivate){var sActive=dataSet.get('active_folder');if(sActive==sAccount+'/'+sOldFolder||sActive.indexOf(sAccount+'/'+sOldFolder+'/')==0){gui.frm_main.bar.tree.folders._invalidateActive();if(bDeactivate||sActive!=sAccount+'/'+sOldFolder)
gui.frm_main._selectView(_getNextFolder({aid:sAccount,fid:sOldFolder}));else{WMFolders.add({'aid':sAccount,'fid':sOldFolder,'name':sNewFolder},'folders','',[function(aData){if(gui.frm_main&&gui.frm_main.bar&&gui.frm_main.bar.tree&&gui.frm_main.bar.tree.folders&&gui.frm_main.bar.tree.folders.recent){gui.frm_main.bar.tree.folders.recent.recent=[];gui.frm_main.bar.tree.folders.recent.__search('');}
if(aData.aid&&aData.name){aData={aid:aData.aid,fid:aData.fid};gui.frm_main._selectView(aData);Folder.openFolder(aData);}
else
gui.frm_main._selectView(_getNextFolder({aid:sAccount,fid:sOldFolder}));}]);return;}}
WMFolders.add({'aid':sAccount,'fid':sOldFolder,'name':sNewFolder},'folders','',[function(){if(gui.frm_main&&gui.frm_main.bar&&gui.frm_main.bar.tree&&gui.frm_main.bar.tree.folders&&gui.frm_main.bar.tree.folders.recent){gui.frm_main.bar.tree.folders.recent.recent=[];gui.frm_main.bar.tree.folders.recent.__search('');}}]);};function _copyOrMoveAll(sDestAccount,sDestFolder,arg){if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){var ids=[arg.aid,arg.fid,Object.getOwnPropertyNames(gui.frm_main.main.list._aData)],sAction='moveall'===arg.method?'move':'copy';Item.__copyOrMoveItems(sDestAccount,sDestFolder,sAction,ids);}else{if(sDestAccount!=arg.aid||sDestFolder!=arg.fid)
WMFolders.action(arg,'folders','',arg.method,{aid:sDestAccount,fid:sDestFolder});}};function _addSharedFolder(bOK,aAddresses){if(bOK&&aAddresses[0].length){var tmp,aAccountInfo={aid:sPrimaryAccount,subscription:[]};for(var i=0;i<aAddresses[0].length;i++){tmp=MailAddress.splitEmailsAndNames(aAddresses[0][i]);if(tmp&&tmp[0]&&tmp[0].email){if(tmp[0].email.indexOf('@')<0)
tmp[0].email+='@'+dataSet.get('main',['domain']);aAccountInfo.subscription.push(tmp[0].email);}}
WMAccounts.subscribe(aAccountInfo,[_addSharedFolderResult]);}};function _addSharedFolderResult(aData){try{if(aData.IQ[0].ERROR)
gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::SUBSCRIBE_ERROR',args:[aData.IQ[0].ERROR[0].VALUE]}});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};function Folder(){}
Folder.addAccount=function(){gui._create('add_account','frm_addaddress','','',[_addSharedFolder],['ADDRESS_BOOK::SELECTED_ADDRESSES'],[''],'','',3);};Folder.setDefault=function(arg){WMFolders.add({'aid':arg.aid,'fid':arg.fid,'default':arg['default']},'folders','');};Folder.share=function(arg){gui._create('frm_sharing','frm_sharing','',~['I','Y'].indexOf(WMFolders.getType(arg))?'teamchat_folder':'',void 0,{aid:arg.aid,fid:arg.fid});};Folder.synchronize=function(arg,bSync,cb){WMFolders.subscribe(arg,'folders','',bSync?1:0,cb);};Folder.unsubscribe=function(arg,cb){if(dataSet.get('folders',[arg.aid,arg.fid,'SUBSCRIPTION_TYPE'])=='folder'){WMAccounts.unsubscribe({aid:arg.aid,subscription:[arg.fid]},[function(bOK){executeCallbackFunction(cb,bOK);}]);}};Folder.addVirtual=function(arg,cb){gui._create('frm_virtual','frm_virtual','','',arg.fid,'',cb);};Folder.addFolder=function(arg,cb){var sType=WMFolders.getType(arg);if(sType=='I'||sType=='Y')
gui._create('frm_addroom','frm_addroom','','',arg.aid,(sType=='I'?Path.basedir(arg.fid):arg.fid),cb,true);else
gui._create('frm_add_folder','frm_add_folder','','',arg.aid,arg.fid,cb);};Folder.clone=function(arg,cb){var org=dataSet.get('folders',[arg.aid,arg.fid]);if(org.TYPE=='I'&&(org.NAME||org.RELATIVE_PATH)){var sFolderName=[org.NAME||Path.basename(org.RELATIVE_PATH),getLang('CHAT::CLONE')].join(' '),aData={'type':org.TYPE,'aid':sPrimaryAccount,'clone':arg.aid+'/'+arg.fid};if(org.OWNER&&~org.OWNER.indexOf('##internalservicedomain.icewarp.com##')){aData.name=org.OWNER+'/TeamChat/'+sFolderName;aData.private=true;}
else
aData.name=Path.basedir(arg.fid)+'/'+sFolderName;WMFolders.add(aData,'folders','',[function(aFolderInfo){if(aFolderInfo){var aData={aid:aFolderInfo.aid,fid:aFolderInfo.name};gui.frm_main._selectView(aData);Folder.openFolder(aData);if(cb)
executeCallbackFunction(cb,aData);}}]);}};Folder.delete=function(arg){var ftype=WMFolders.getType(arg);if(ftype!='X'&&WMFolders.getRights(arg,'remove')){var frm=null;if(ftype=='VA')
frm=gui._create('frm_confirm','frm_confirm','','',[_deleteFolder,[arg.aid,arg.fid]],'CONFIRMATION::DELETE_ACCOUNT_CONFIRMATION','CONFIRMATION::DELETE_ACCOUNT',[Path.basename(arg['fid']).substr(sPrimaryAccountSPREFIX.length)]);else{if(arg.fid.indexOf('__@@VIRTUAL@@__')===0)
_deleteFolder(arg.aid,arg.fid);else{var sTrashFolder=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','trash'))[1],owner=dataSet.get('folders',[arg.aid,arg.fid,'OWNER']);if(sPrimaryAccount==arg.aid&&(ftype=='M'||(ftype=='E'&&sPrimaryAccountGWTRASH!='true'))&&sTrashFolder&&(!owner||owner==sPrimaryAccount)&&!dataSet.get('folders',[arg.aid,arg.fid,'SUBSCRIPTION_TYPE'])&&arg.fid.indexOf(sTrashFolder+'/')<0&&parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','move_to_trash'))>0&&WMFolders.getRights(arg,'modify')){var org=dataSet.get('folders',[arg.aid,arg.fid]),sTargetPathOriginal=sTrashFolder+'/'+(org.NAME||(org.RELATIVE_PATH&&Path.basename(org.RELATIVE_PATH))||arg.fid.split('/').pop()),sTargetPath=sTargetPathOriginal,inc=0;while(dataSet.get('folders',[sPrimaryAccount,sTargetPath])){sTargetPath=sTargetPathOriginal+' '+(++inc);}
_moveFolder(sPrimaryAccount,arg.fid,sTargetPath,true);}
else
frm=gui._create('frm_confirm','frm_confirm','','',[_deleteFolder,[arg.aid,arg.fid]],'CONFIRMATION::DELETE_FOLDER_CONFIRMATION','CONFIRMATION::DELETE_FOLDER',[dataSet.get('folders',[arg.aid,arg.fid,'NAME'])||Path.basename(arg['fid'])]);}}
if(frm&&frm.x_btn_ok)
addcss(frm.x_btn_ok._main,'color2');}
else
gui.notifier._value({type:'alert',args:{header:'',text:'CONTEXT_FOLDER::CANTDELETE'}});};Folder.move=function(arg){var ftype=WMFolders.getType(arg);if(ftype!='X'&&WMFolders.getRights(arg,'modify')){var frm=gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::MOVE_FOLDER',arg['aid'],arg['fid'],[function(aid,fid,f){_moveFolder(aid,f,(fid?fid+'/':'')+Path.basename(f));},[arg['fid']]],false,true);frm.tree_folder._isSelectable=function(idt){return idt.ftype!="X"||!!idt['public'];};}
else
gui.notifier._value({type:'alert',args:{header:'',text:'CONTEXT_FOLDER::CANTMOVE'}});};Folder.rename=function(arg){__moveFolder(arg);};Folder.save=function(arg){WMFolders.save_folder(arg);};Folder.empty=function(arg){var sFullPath=arg['aid']+'/'+arg['fid'],sTrashFolder=GWOthers.getItem('DEFAULT_FOLDERS','trash'),sFolderType=WMFolders.getType(arg),frm;if(sFullPath==sTrashFolder||sFolderType=='R'||sFolderType=='G'||parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','delete_emptyfolder'))>0)
frm=gui._create('frm_confirm','frm_confirm','','',[function(){WMFolders.__emptyFolder(arg['aid'],arg['fid']);}],'CONFIRMATION::EMPTY_FOLDER_CONFIRMATION','CONFIRMATION::EMPTY_FOLDER');else
frm=gui._create('frm_confirm','frm_confirm','','',[function(){WMFolders.__emptyFolder(arg['aid'],arg['fid'],true);}],'CONFIRMATION::EMPTY_FOLDER_CONFIRMATION','CONFIRMATION::EMPTY_TO_TRASH');addcss(frm.x_btn_ok._main,'color2');};Folder.markRead=function(arg){if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){OldMessage.markWithFlag([arg.aid,arg.fid,Object.getOwnPropertyNames(gui.frm_main.main.list._aData)],{'SEEN':true},true);}else{WMFolders.markItemsRead({'aid':arg.aid,'fid':arg.fid},'folders','',true);}};Folder.markUnread=function(arg){if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){OldMessage.markWithFlag([arg.aid,arg.fid,Object.getOwnPropertyNames(gui.frm_main.main.list._aData)],{'SEEN':false},true);}else{WMFolders.markItemsRead({'aid':arg.aid,'fid':arg.fid},'folders','',false);}};Folder.copyAll=function(arg){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::COPY_MAIL_TO',arg['aid'],arg['fid'],[_copyOrMoveAll,[arg]],false,false,dataSet.get("folders",[arg['aid'],arg['fid'],'TYPE']),'w');};Folder.moveAll=function(arg){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::MOVE_MAIL_TO',arg['aid'],arg['fid'],[_copyOrMoveAll,[arg]],false,false,dataSet.get("folders",[arg['aid'],arg['fid'],'TYPE']),'w');};Folder.changeChannel=function(arg){gui._create('frm_change_channel','frm_change_channel','','',arg.aid,arg.fid);};Folder.getActiveCalendar=function(){var f=dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS'])||{};for(var id in f){if(f[id])
return id;}};Folder.openFolder=function(arg){if(arg.name)
arg.fid=arg.name;try{var p;if((p=arg.fid.lastIndexOf('/'))>-1)
gui.frm_main.bar.tree.folders._open(arg.aid+'/'+arg.fid.substr(0,p),'minus');else
gui.frm_main.bar.tree.folders._open(arg.aid,'minus');}
catch(r){gui._REQUEST_VARS.debug&&console.log('Folder',r)};};Folder.lastId=function(arg,value){var id=0;if(arg&&arg.aid&&arg.fid){if(!value){id=dataSet.get('last_item',[arg.aid,arg.fid,'id']);if(!id){value=id=dataSet.get('folders',[arg.aid,arg.fid,'GROUPCHAT_LASTREADID']);}}
if(value){id=value;dataSet.add('last_item',[arg.aid,arg.fid,'id'],id);}}
return id||0;};window.Folder=Folder;})();

/* client/inc/class_item.js */
function Item(){};Item.COLORS={'RED':'1','BLUE':'2','GREEN':'3','GREY':'4','ORANGE':'5','CYAN':'6','BROWN':'7','PURPLE':'8','LIGHT_BLUE':'9','YELLOW':'A','COMPLETE':'Y','CLEAR':'Z'};Item.open=function(id,aOtherData,aValues,sFolderType,bForce){if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.itemview){if(!bForce&&dataSet.get('preview',id))return;dataSet.add('active_items',[id[0],id[1]],id[2]);var
aItemsInfo={"aid":id[0],"fid":id[1],"iid":id[2]},sFolderType=WMFolders.getType(id);if(sFolderType=='F')
aItemsInfo.values=['EVN_ID','EVNGRP_ID','EVNOWN_ID','EVN_METADATA','EVNLOCKOWN_ID','EVNMODIFIEDOWN_ID','EVN_EDITCOUNTER','EVN_CREATED','EVN_MODIFIED','EVNFOLDER','EVNORIGINALFOLDER','EVNTITLE','EVNTYPE','EVNNOTE','EVNDESCFORMAT','EVNLOCATION','EVNCOMPLETE','EVNCOLOR','EVNCLASS','EVNSHARETYPE','EVNTIMEFORMAT','EVNSTATUS','EVNURL','EVNSTARTDATE','EVNSTARTTIME','EVNENDDATE','EVNENDTIME','EVNRID','EVNUID','EVNFLAGS','EVNLOCKHASH','EVNLOCKINFO','EVNLOCKOWN_EMAIL','EVNLOCKAPPMASK','TICKET'];if(sFolderType==='N'||sFolderType==='T'||sFolderType==='C'||sFolderType==='E'||sFolderType==='F'){if(1==GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_inline_images')){aItemsInfo.values=['show_inline_images'];}}
WMItems.list(aItemsInfo,'preview');}
else
Item.openwindow(id,aValues,aOtherData,sFolderType);};Item.openwindow=function(id,aValues,aOtherData,sFolderType,oResponse,oFinished,bClone){if(!sFolderType){sFolderType=dataSet.get("folders",[id[0],id[1],'TYPE']);if(!sFolderType)
if(id[0]==sPrimaryAccount){if(id[1]=='__@@ADDRESSBOOK@@__'||id[1]=='@@mycard@@')
sFolderType='C';}
else
return;}
var type=Mapping.getFormNameByGWType(sFolderType);if(!aValues&&id[2]){var popups=gui._getChildObjects('main',type);for(var i in popups)
if(popups[i]._type===type&&popups[i]._sAccountID===id[0]&&popups[i]._sFolderID===id[1]&&popups[i]._sItemID===id[2])
return popups[i]._focus();var aItemsInfo={"aid":id[0],"fid":id[1],"iid":id[2]};if(aOtherData&&Is.Defined(aOtherData.EVNRCR_ID)&&Is.Defined(aOtherData.EVNSTARTDATE))
aItemsInfo.date=aOtherData.EVNSTARTDATE;if(sFolderType==='N'||sFolderType==='T'||sFolderType==='C'||sFolderType==='E'||sFolderType==='F'){if(1==GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_inline_images')){aItemsInfo.values=['show_inline_images'];}}
WMItems.list(aItemsInfo,null,null,null,[function(aData){if(aData&&aData[id[0]]&&aData[id[0]][id[1]]){if(id[1]=='@@mycard@@'){id[2]='';aValues=aData[id[0]][id[1]];delete aValues['/'];delete aValues['$'];delete aValues['#'];delete aValues['@'];for(var i in aValues)
if(Is.Object(aValues[i])){id[2]=i;break;}
aValues=aValues[id[2]]||{};}
else
aValues=aData[id[0]][id[1]][id[2]];}
else
if(id[1]=='@@mycard@@'){id[2]='';aValues={LOCATIONS:[{values:{LCTEMAIL1:sPrimaryAccount,LCTTYPE:'H'}}]};}
else
aValues={};var frm=gui._create('gw',type,'','',id[0],id[1],id[2],aValues,aOtherData,oResponse,bClone);if(oFinished)
executeCallbackFunction(oFinished,frm);}]);return;}
var frm=gui._create('gw',type,'','',id[0],id[1],id[2],aValues,aOtherData,oResponse,bClone);if(oFinished)
executeCallbackFunction(oFinished,frm);return frm;};Item.cloneEvent=function(id){WMItems.list({aid:id[0],fid:id[1],iid:id[2]},null,null,null,[function(aRes){if(aRes&&(aRes=aRes[id[0]])&&(aRes=aRes[id[1]])&&(aRes=aRes[id[2]])){var aItemsInfo={aid:id[0],fid:id[1],iid:[id[2]],account:id[0],folder:Path.slash(aRes['EVNFOLDER'])};WMItems.copy(aItemsInfo,'items','','folders',[function(bOK,aData){if(bOK){Item.__refreshView([id[0],id[1]],true);Item.openwindow([id[0],id[1],WMItems.__clientID(aData.Array.IQ[0].RESULT[0].ID[0].VALUE)]);}}]);}}]);};Item.print=function(ids){if(!ids||!ids[2].length)
return;var ids=ids,aItemsInfo={aid:ids[0],fid:ids[1]},sType=WMFolders.getType(ids);aItemsInfo.filter={search:'items:('+ids[2].join(' or ').replace(/\*/g,'')+')'};switch(sType){case'T':aItemsInfo.values=['EVNTITLE','EVNLOCATION','EVNNOTE','EVNDESCFORMAT','EVNSTATUS','EVNCOMPLETE','EVNENDDATE','EVNSTARTDATE','EVNTYPE'];WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[aItemsInfo.aid])&&(aData=aData[aItemsInfo.fid])){var out=[];for(var i in ids[2])
if(aData[ids[2][i]])
out.push(aData[ids[2][i]]);if(out.length){var frm;if(!(frm=gui.print))
frm=gui._create('print','frm_print');frm._add(sType,out);}}}]);break;case'N':aItemsInfo.filter=false;aItemsInfo.values=['show_inline_images'];aItemsInfo.iid=WMItems.__serverID(ids[2][0]);WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[aItemsInfo.aid])&&(aData=aData[aItemsInfo.fid])&&(aData=aData[ids[2][0]])){aData.NOTE_TEXT=aData.NOTES[0].values.NOTE_TEXT;var frm;if(!(frm=gui.print))
frm=gui._create('print','frm_print');frm._add(sType,aData);}}]);break;case'C':aItemsInfo.values=['ITMCLASSIFYAS','ITMTITLE','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMCLASS','ITMSUFFIX','ITMCOMPANY','ITMJOBTITLE','ITMDEPARTMENT','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTPHNPRIMARY','LCTPHNWORK1','LCTPHNWORK2','LCTPHNFAXWORK','LCTPHNHOME1','LCTPHNHOME2','LCTPHNFAXHOME','LCTPHNASSISTANT','LCTPHNCALLBACK','LCTPHNCOMPANY','LCTPHNCAR','LCTPHNISDN','LCTPHNOTHER','LCTPHNOTHERFAX','LCTPHNPAGER','LCTPHNFAXWORK','LCTPHNMOBILE','LCTPHNRADIO','LCTPHNTELEX','LCTPHNHEARING'];aItemsInfo.locations=true;aItemsInfo.filter.sort='ITMSURNAME,ITMFIRSTNAME,ITMCLASSIFYAS';WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[aItemsInfo.aid])&&(aData=aData[aItemsInfo.fid])){var tmp,out=[],loc;for(var i in ids[2])
if(aData[ids[2][i]]&&aData[ids[2][i]].ITMCLASS=='C'){tmp={PHONES:[]};for(var j in aData[ids[2][i]])
if(j==='LOCATIONS'){for(var k in aData[ids[2][i]][j])
if((loc=aData[ids[2][i]][j][k])&&(loc=loc.values)){if(loc.LCTTYPE==='H'){for(var l in loc)
loc[l]&&(tmp[l]=loc[l]);}
else{tmp[loc.LCTTYPE]={};for(var l in loc)
loc[l]&&(tmp[loc.LCTTYPE][l]=loc[l]);}}}
else
if(j.indexOf('LCTPHN')==0){if(aData[ids[2][i]][j])
tmp.PHONES.push({PHNTYPE:getLang('PHONE::'+j.toUpperCase()),PHNNUMBER:aData[ids[2][i]][j]});}
else
tmp[j]=aData[ids[2][i]][j];out.push(tmp);}
out.length&&(gui.print||gui._create('print','frm_print'))._add(sType,out);}}]);break;}};Item.create=function(sType,sAccount,sFolder){gui.frm_main.hmenu1.__createNewGW(sType);};Item.createInFolder=function(sAccount,sFolder,aValues,sFolderType){sFolderType=dataSet.get("folders",[sAccount,sFolder,'TYPE'])||sFolderType;if(sFolderType=='M'){newMessage=new NewMessage();newMessage.addSignature();if(aValues.PUSH_ATTACHMENTS){newMessage.aAttachments={'attachments':[]};for(var i in aValues.PUSH_ATTACHMENTS)
if(aValues.PUSH_ATTACHMENTS[i].fullpath)
newMessage.aAttachments.attachments.push({'values':{'class':'item','fullpath':aValues.PUSH_ATTACHMENTS[i].fullpath,'name':aValues.PUSH_ATTACHMENTS[i]['title']}});}
if(aValues.EVNTITLE)
newMessage.sSubject=aValues.EVNTITLE;gui._create('frm_compose','frm_compose','','',newMessage);}
else
if(sFolderType==='F'&&!aValues){gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[gui.frm_main,'__copyItem',[[sAccount,sFolder]]],sAccount,sFolder,'','r',false,['F','I','X'],'X');}
else
if(sFolderType==='I'&&aValues.PUSH_ATTACHMENTS){var aBuffer=[];aValues.PUSH_ATTACHMENTS.forEach(function(att){aBuffer.push({class:'item',description:att.title,size:att.size,fullpath:att.fullpath});});if(aBuffer.length==1){gui._create('chat_upload','frm_chat_upload','','',aBuffer[0].description,'',{aid:sAccount,fid:sFolder},[function(sName,sDesc,aArg){Item.CopyToChat(aBuffer,sName,sDesc,aArg,null,{aid:sAccount,fid:sFolder});}]);}
else{Item.CopyToChat(aBuffer,null,null,null,null,{aid:sAccount,fid:sFolder});}}else{Item.openwindow([sAccount,sFolder],aValues,null,sFolderType);}};Item.CopyToChat=function(aBuffer,sName,sDesc,aArg,comevnid,aPath,aHandler){if(aBuffer&&aBuffer.length){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNCLASS='F';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();if(comevnid)
aItemInfo.values.EVNCOMEVNID=comevnid;if(aBuffer.length==1){aItemInfo['values']['EVNRID']=aItemInfo['values']['EVNLOCATION']=aItemInfo['values']['EVNTITLE']=sName||aBuffer[0].name;aItemInfo['values']['EVNCOMPLETE']=aBuffer[0].size;if(Is.String(sDesc)&&sDesc.length){aItemInfo['values']['EVNNOTE']=sDesc;aItemInfo['values']['EVNDESCFORMAT']='text/plain';}}
for(var i=0,j=aBuffer.length;i<j;i++)
aItemInfo['ATTACHMENTS'].push({values:aBuffer[i]});WMItems.add([aPath.aid,aPath.fid],aItemInfo,'','','',[function(bOK,aData){if(bOK&&aHandler){executeCallbackFunction(aHandler,[bOK,aData,aArg]);}}]);}};Item.notify=function(id,sAction,sItemType,aVal){if(gui.socket){var f=dataSet.get('folders',[id[0],id[1]]);if(f){var aOut={'ACTION':sAction,'TYPE':'item','ITEM':WMItems.__serverID(id[2]),'FOLDER':f.RELATIVE_PATH||id[1],'FOLDER-TYPE':f.TYPE,'EMAIL':f.OWNER,'ORIGINATOR-ID':sPrimaryAccountGWID,'ORIGINATOR-NAME':dataSet.get('main',['fullname']),'ORIGINATOR-EMAIL':sPrimaryAccount,'ITEM-TYPE':sItemType||f.TYPE};if(aVal)
for(var k in aVal)
aOut[k]=aVal[k];gui.socket.api._notify(aOut);}}};Item.emailAttendees=function(id){return WMItems.list({aid:id[0],fid:id[1],iid:id[2]},null,null,null,[function(aData){var aTo=[];aData=((aData[id[0]]||{})[id[1]]||{})[id[2]]||{};var contacts=aData.CONTACTS||{};for(var i in contacts){aTo.push(MailAddress.createEmail(contacts[i].values.CNTCONTACTNAME,contacts[i].values.CNTEMAIL));}
var newMessage=new NewMessage();newMessage.sSubject=aData.EVNTITLE;newMessage.sTo=aTo.join(',');newMessage.addSignature();gui._create('frm_compose','frm_compose','','',newMessage,void 0,{context:'Item',fun:['emailAttendees'],args:[id]});}]);}
Item.set_lock=function(ids,bLock,bRefreshPreview,aHandler){WMItems.action({"aid":ids[0],"fid":ids[1],"iid":ids[2]},(bLock?'lock':'unlock'),[function(bOK){if(bOK){Item.notify(ids,(bLock?'lock':'unlock'),'-',{BODY:'1'});if(bRefreshPreview)
Item.__refreshView(ids,true);}
if(aHandler)
executeCallbackFunction(aHandler,bOK);}]);};Item.edit_value=function(sValue,id,sColumn,aOut){var aOut=aOut||{values:{}};if(sColumn=='EVNFILENAME'||sColumn=='CONVERT'){WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['ATTACHMENTS']},'','','',[function(aData){if((aData=aData[id[0]])&&(aData=aData[id[1]])&&(aData=aData[id[2]])&&(aData=aData.ATTACHMENTS)){for(var uid in aData){if(sColumn=='CONVERT'){aOut={ATTACHMENTS:[{"uid":uid,"values":{"convert":sValue}}]};}
else{aOut.values['EVNTITLE']=sValue;aOut.values['EVNLOCATION']=sValue;aOut.values['EVNRID']=sValue;aOut.ATTACHMENTS=[{"uid":uid,"values":{"description":sValue}}];}
Item.edit_value('',id,'',aOut);return;}}
Item.__refreshView(id,true);}]);return;}
else
if(sColumn)
aOut.values[sColumn]=sValue;WMItems.add(id,aOut,'items','','',[function(bOK){Item.__refreshView(id,true);}]);};Item.edit_tags=function(ids,aHandler){try{var iid=ids[2][0].replace(/\|\w+/,'');var tag_elm={M:'TAGS',C:'ITMCATEGORY'}[dataSet.get("folders",[ids[0],ids[1],'TYPE'])||'M']||'EVNTYPE',sInitString=WMItems.list({"aid":ids[0],"fid":ids[1],"iid":iid,"values":[tag_elm]})[ids[0]][ids[1]][iid][tag_elm];}
catch(r){return;}
var dialog=gui._create('categories','frm_categories','','',sInitString,[function(sTags,ids){var out={values:{}};out.values[tag_elm]=sTags;if((sTags||'').split(',').sort().join(',')!==(sInitString||'').split(',').sort().join(',')){WMItems.add(ids,out,'items','','',[function(bOK,aData,ids){if(bOK&&Is.Array(ids))
Item.__refreshView(ids,WMFolders.getType(ids)!='M');},[ids]]);}
if(aHandler)
executeCallbackFunction(aHandler);},[ids]]);dialog._onChange=function(){if(Is.Array(ids))
Item.__refreshView(ids,WMFolders.getType(ids)=='M');};};Item.addCert=function(id){gui._create('add_cert','frm_insert_item','','frm_insert_item_nobottomdiv',[Item.addCert_request,[id]],sPrimaryAccount,Mapping.getDefaultFolderForGWType('C'),'C','w',void 0,['C']);};Item.addCert_request=function(aItem,ids){if(aItem&&aItem[0]){aItem=aItem[0];WMItems.certificate({account:ids[0],folder:ids[1],item:ids[2],aid:aItem.aid,fid:aItem.fid,iid:aItem.id},[Item.addCert_response]);}};Item.addCert_response=function(aData){if(aData.error){var tmp='CERTIFICATE::';switch(aData.error){case'account_invalid_id':case'item_invalid_id':case'folder_does_not_exist':tmp+='INVALIDITEM';break;case'certificate_data_missing':tmp+='MISSING';}
gui.notifier._value({type:'alert',args:{header:'',text:tmp}});}
else{var obj=gui._create('confirm','frm_confirm','','',[Item.open,[[aData.data.aid,aData.data.fid,aData.data.iid]]],'CERTIFICATE::CERTIFICATE','CERTIFICATE::ASSIGNED');obj.x_btn_ok._value('POPUP_ITEMS::OPEN');obj=null;}};Item.recover=function(aIds,bAsk){var helper;helper=new ItemsRecoverHelper(aIds,bAsk,[Item.__recoverCallback]);helper.process();};Item.__recoverCallback=function(aFoldersMapping,aIds){WMItems.recover({'aid':aIds[0],'fid':aIds[1],'iid':aIds[2],'action':'recover'},'items','','folders',aFoldersMapping);if(!Item.__removeFromDataset(aIds))
Item.__refreshView(aIds,true);};Item.copy=function(ids){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::COPY_MAIL_TO',ids[0],ids[1],[Item.__copyOrMoveItems,['copy',ids]],false,false,dataSet.get("folders",[ids[0],ids[1],'TYPE']),'w');};Item.copyToAlfresco=function(ids){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::COPY_MAIL_TO','@@alfresco@@','',[Item.__copyOrMoveItems,['copy',ids]],false,true,'K');};Item.clone=function(ids){WMItems.copy({'aid':ids[0],'fid':ids[1],'iid':ids[2],'account':ids[0],'folder':ids[1],'duplicity':"rename"},'items','','folders',[function(bOK){Item.__refreshView([ids[0],ids[1]],true);}]);};Item.move=function(ids){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::MOVE_MAIL_TO',ids[0],ids[1],[Item.__copyOrMoveItems,['move',ids]],false,true,dataSet.get("folders",[ids[0],ids[1],'TYPE']),'w');};Item.copy_tch=function(files,opt){opt=opt||{};function __uploadhandler(aTo,aBuffer,sName,sDesc){if(aBuffer&&aBuffer.length){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNCLASS='F';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();if(aBuffer.length==1){aItemInfo['values']['EVNRID']=aItemInfo['values']['EVNLOCATION']=aItemInfo['values']['EVNTITLE']=sName||aBuffer[0].name;aItemInfo['values']['EVNCOMPLETE']=aBuffer[0].size;if(Is.String(sDesc)&&sDesc.length){aItemInfo['values']['EVNNOTE']=sDesc;aItemInfo['values']['EVNDESCFORMAT']='text/plain';}}
for(var i=0,j=aBuffer.length;i<j;i++){aItemInfo['ATTACHMENTS'].push({values:aBuffer[i]});}
WMItems.add(aTo,aItemInfo,'','','',[function(bOK,aData){if(bOK){gui.notifier._value({type:'message_sent_tch',args:[dataSet.get('folders',aTo).NAME||dataSet.get('folders',aTo).RELATIVE_PATH||'']});}else{if(aData==='item_create'){aData='ALERTS::FOLDER_INSUFFICIENT_RIGHTS';}else{aData='ERROR::'+aData;}
gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text:aData}});}}.bind(this)]);}};var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}
if(sFolder){gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){var __upload_buffer=[];files[2].forEach(function(file){var data=dataSet.get('items',[files[0],files[1],file]);if(data){var sFileName='';switch(WMFolders.getType([files[0],files[1]])){case'F':sFileName=data.EVNTITLE;break;case'M':sFileName=data.SUBJECT+'.eml';break;case'C':sFileName=data.ITMCLASSIFYAS+'.vcf';break;default:sFileName=data.EVNTITLE+'.ics';}}
__upload_buffer.push({'class':'item','description':sFileName.replace(/[<>:\/\\|?*""\[\]]/g,''),'size':data.SIZE,'fullpath':files[0]+'/'+files[1]+'/'+WMItems.__serverID(file),'client_id':file});});if(__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',__upload_buffer[0].description,'',{aid:aid,fid:fid},[function(sName,sDesc,aArg){if(opt.link){WMItems.action({"aid":files[0],"fid":files[1],"iid":__upload_buffer[0].client_id,nodes:{note:sDesc,folder:fid}},'document_link',[function(bOK){if(bOK)
gui.notifier._value({type:'message_sent_tch',args:[__upload_buffer[0].description]});else
gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text:'ALERTS::FOLDER_INSUFFICIENT_RIGHTS'}});}]);return;}
__uploadhandler([aid,fid],__upload_buffer,sName,sDesc,aArg);}]);}
else
if(opt.link){__upload_buffer.forEach(function(file){WMItems.action({"aid":files[0],"fid":files[1],"iid":file.client_id,nodes:{folder:fid}},'document_link',[function(bOK){if(bOK)
gui.notifier._value({type:'message_sent_tch',args:[file.description]});else
gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text:'ALERTS::FOLDER_INSUFFICIENT_RIGHTS'}});}]);});}
else{__uploadhandler([aid,fid],__upload_buffer);}}],true,true,['Y','I'],'',true);}};Item.invite_tch=function(sMail){var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}
if(sFolder){gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){gui._create('invite','frm_groupchat_invite','','',{aid:aid,fid:fid},[function(){gui.notifier._value({type:'success',args:{text:'CHAT::INVITATION_SENT'}});}],sMail);}],true,true,['Y','I'],'',true);}};Item.message_tch=function(sFolder,sBody,aHandler){function mssg(sFolder,sBody){var aItemInfo={values:{EVNNOTE:sBody,EVNSHARETYPE:'U'}};WMItems.add([sPrimaryAccount,sFolder],aItemInfo,'','','',aHandler);};if(!sFolder){var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}
if(sFolder){gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,sFolder){mssg(sFolder,sBody);}],true,true,['Y','I'],'',true);}}
else
mssg(sFolder,sBody);};Item.downloadMultiple=function(ids){WMItems.save_items({"aid":ids[0],"fid":ids[1],"iid":ids[2]},currentBrowser().indexOf('MSIE')<0);};Item.downloadSource=function(id,ext){var aUrl={'sid':dataSet.get('main',['sid']),'class':'item'+(ext||''),'fullpath':id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2].replace(/\|\w+/,''))};downloadItem(buildURL(aUrl));};Item.webdavURL=function(id,sAtId){try{if(!Is.Defined(sAtId)){var aData=WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['EVN_ID']})[id[0]][id[1]][id[2]];for(var sAtId in aData['ATTACHMENTS'])
break;if(!Is.Defined(sAtId))
return false;}
return'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':(sAtId.length?'attachmentticket':'itemticket'),'fullpath':id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2])+(sAtId.length?'/'+sAtId:'')});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
return false;};Item.downloadFile=function(id){try{var aData=WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['EVN_ID']})[id[0]][id[1]][id[2]];for(var sAtId in aData['ATTACHMENTS']){downloadItem(buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2])+'/'+sAtId}));return true;}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
return false;};Item.getPublicUrl=function(id){try{var aData=WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['EVN_ID']})[id[0]][id[1]][id[2]];for(var sAtId in aData['ATTACHMENTS'])
break;return aData.ATTACHMENTS[sAtId].values.TICKET||false;}catch(r){}
return false;};Item.remove=function(ids,bForce,oRepeating,oOriginator,iNext,aHandler)
{if(Is.Object(oRepeating)){var frm=gui._create('frm_confirm','frm_confirm_repeating','','',[Item.__removeWithRepeating,[ids,oRepeating,void 0,bForce,aHandler]],'REPEATING_CONFIRM::TITLE_DELETE','REPEATING_CONFIRM::TEXT_DELETE');if(oOriginator&&oOriginator._focus){frm.___returnFocus=function(){oOriginator._focus();};frm._add_destructor('___returnFocus');}
return;}
storage.library('gw_others');if(bForce){Item.__delete(ids,oOriginator,iNext,bForce,aHandler);return;}
else
if(dataSet.get("folders",[ids[0],ids[1],'TYPE'])=='M'&&parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','move_to_trash'))>0){var sTrashFolder=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','trash'))[1];if(sPrimaryAccount!=ids[0]){var sTrash=dataSet.get('accounts',[ids[0],'TRASHFOLDER']);if(sTrash)
sTrashFolder=Path.split(sTrash)[1];}
if(sTrashFolder!=ids[1]){var aFolders=dataSet.get('folders');if(!aFolders[ids[0]][sTrashFolder])
dataSet.add('folders',[ids[0],sTrashFolder],{'NAME':sTrashFolder,'TYPE':'M','RIGHTS':'rwmd'});Item.__copyOrMoveItems(ids[0],sTrashFolder,'move',[ids[0],ids[1],ids[2]]);if(oOriginator){if(oOriginator._focus)
oOriginator._focus();if(typeof iNext!='undefined')
oOriginator._value([iNext]);}
return;}}
if(gui.__bSkipDeleteConfirmation){Item.__delete(ids,oOriginator,iNext,false,aHandler);if(oOriginator&&oOriginator._focus)
oOriginator._focus();}
else
{var frm=gui._create('frm_confirm','frm_confirm','','noblur',[Item.__delete,[ids,oOriginator,iNext,false,aHandler]],'CONFIRMATION::DELETE_ITEM_CONFIRMATION','CONFIRMATION::DELETE_ITEM');frm._size(400,180);if(sPrimaryAccountGWTRASH){switch(WMFolders.getType(ids)){case'M':case'G':case'Q':case'QL':addcss(frm.x_btn_ok._main,'color2');break;default:frm.obj_label.__eIN.innerHTML+='<br>'+getLang('CONFIRMATION::DELETE_ITEM_TRASH');}}
else{addcss(frm.x_btn_ok._main,'color2');}
var skip=frm._create('skip','obj_button_check','footer','transparent simple x_btn_right');skip._value('POPUP_ITEMS::SKIP_DELETE');skip._tabIndex();skip._onclick=function(){gui.__bSkipDeleteConfirmation=this._checked()>0;};if(oOriginator&&oOriginator._focus){frm.___returnFocus=function(){if(oOriginator._focus)
oOriginator._focus();};frm._add_destructor('___returnFocus');}}};Item.setColor=function(id,sColor){var sOldColor=Item.getColor(id);if(!sOldColor||(sOldColor!=sColor)){dataSet.add('items',id.concat(['EVNCOLOR']),sColor);WMItems.add(id,{'values':{'EVNCOLOR':sColor}},'items');}};Item.getColor=function(id){return dataSet.get('items',id.concat(['EVNCOLOR']));};Item.hasReccurence=function(id,rcr_id){if(!Is.Object(id))return false;var tmpItm=dataSet.get('items',id);if(!Is.Object(tmpItm)||tmpItm.EVNCLASS=='O')return false;if(!Is.Defined(rcr_id))
rcr_id=tmpItm.EVNRCR_ID;return rcr_id?true:false;};Item.sendEmailTo=function(sLctEmail,aValues){if(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly())){window.location.href="mailto:"+sLctEmail;return;}
var newMessage=new NewMessage();newMessage.sTo=sLctEmail;newMessage.addSignature();if(aValues){for(var i in aValues)
if(Is.Function(newMessage[i]))
newMessage[i](aValues[i]);else
newMessage[i]=aValues[i];}
gui._create('frm_compose','frm_compose','','',newMessage);};Item.sendAsEmail=function(ids){var aData,sName='',sSize,sFTyle=(ids[1]=='@@mycard@@'?'C':dataSet.get('folders',[ids[0],ids[1],'TYPE'])),newMessage=new NewMessage();newMessage.addSignature();newMessage.aAttachments={'attachments':[]};for(var i in ids[2]){if(!Is.Defined(sName=dataSet.get('items',[ids[0],ids[1],ids[2][i],sFTyle=='C'?'ITMCLASSIFYAS':'EVNTITLE']))){aData=WMItems.list({"aid":ids[0],"fid":ids[1],"iid":ids[2][i],"values":[(sFTyle=='C'?'ITMCLASSIFYAS':'EVNTITLE')]});try{sName=aData[ids[0]][ids[1]][ids[2][i]][sFTyle=='C'?'ITMCLASSIFYAS':'EVNTITLE']||'';}
catch(r){continue;}}
sSize=dataSet.get('items',[ids[0],ids[1],ids[2][i],'EVNCOMPLETE']);if(sName){newMessage.sSubject=sName;if(sFTyle!='F')
sName+=sFTyle=='C'?'.vcf':'.ics';newMessage.aAttachments.attachments.push({'values':{'class':'item','fullpath':ids[0]+'/'+ids[1]+'/'+WMItems.__serverID(ids[2][i]),size:sSize,'name':sName}});}}
gui._create('frm_compose','frm_compose','','',newMessage);};Item.__convertToFolder=function(acc,fol,v){var t1=WMFolders.getType([acc,fol]),t2=WMFolders.getType(v.value[0]);var ids=[v.value[0].aid,v.value[0].fid,[]];for(var i in v.value)
ids[2].push(v.value[i].iid);gui.frm_main.dnd.remove_drag(true);if(fol=='SPAM_QUEUE/Whitelist'||fol=='SPAM_QUEUE/Blacklist'){if(t2=='M')
OldMessage.__blackOrWhiteList(ids,fol=='SPAM_QUEUE/Whitelist');}
else
if(t1!=t2){var title=[],name,mail,q,note,arg,out={},att=[];for(var i in v.value){arg={id:v.value[i].iid,fullpath:v.value[i].aid+'/'+v.value[i].fid+'/'+WMItems.__serverID(v.value[i].iid),embedded:true};var aReq={"aid":v.value[i].aid,"fid":v.value[i].fid,"iid":v.value[i].iid};if(t2=='P'||t2=='M')
aReq.values=['SUBJECT','SIZE','FROM','HTML','STATIC_FLAGS'];if(!(q=WMItems.list(aReq)[v.value[i].aid][v.value[i].fid][v.value[i].iid]))
return;switch(t2){case'R':try{if(typeof title[0]=='undefined')title.push(q.SUBJECT);note=note||q.TEXT||q.HTML;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
break;case'P':case'M':arg.title=q.SUBJECT||'';arg.size=q.SIZE||0;if(typeof title[0]=='undefined'){if(t1=='C'){var splited=MailAddress.splitEmailsAndNames(q.FROM);if(splited[0]){mail=splited[0].email;name=splited[0].name;}}
title.push(arg.title);note=q.HTML;if(q.STATIC_FLAGS&1)
out[t1=='C'||t1=='D'?'ITMDESCFORMAT':'EVNDESCFORMAT']='text/html';}
arg.title+=(arg.title?' - ':'')+WMItems.__serverID(v.value[i].iid)+'.eml';break;case'F':for(var sAtId in q['ATTACHMENTS'])
break;arg.title=q.EVNLOCATION;arg.size=q.EVNCOMPLETE||0;arg.type='push_attachment';if(typeof title[0]=='undefined'&&!note)
note=q.EVNNOTE;break;case'C':case'D':if(typeof title[0]=='undefined'&&!note)
note=q.ITMDESCRIPTION;arg.title=q.ITMCLASSIFYAS+'.vcf';break;case'N':case'T':case'E':case'J':if(typeof title[0]=='undefined'&&!note)
if(t2=='N')
note=q.NOTES&&q.NOTES[0].values?q.NOTES[0].values.NOTE_TEXT:'';else
note=q.EVNNOTE;arg.title=(q.EVNTITLE||q.ITMTITLE||'')+'.ics';}
att.push(arg);}
if(name)
parseNameToLocation(name,out);if(mail)
out.LOCATIONS=[{values:{LCTTYPE:'H',LCTEMAIL1:mail}}];if(note){switch(t1){case'C':case'D':out.ITMDESCRIPTION=note;break;case'N':out.NOTES=[{values:{NOTE_TEXT:note}}];break;case'I':break;default:out.EVNNOTE=note;}}
out.EVNTITLE=title.join(', ');if(t2!='R')
out.PUSH_ATTACHMENTS=att;Item.createInFolder(acc,fol,out);}
else
Item.__copyOrMoveItems(acc,fol,(v.ctrl?'copy':'move')+(v.select_all?'all':''),ids);};Item.__copyOrMoveItems=function(sDestAccount,sDestFolder,sAction,ids){if(sDestAccount&&sDestFolder&&(sAction!='move'||sDestAccount!=ids[0]||sDestFolder!=ids[1]))
{var aFolderProps=dataSet.get('folders',[ids[0],ids[1]],true),aNewFolderProps=dataSet.get('folders',[sDestAccount,sDestFolder],true),nFlag;if(aFolderProps&&(aFolderProps['TYPE']=='M'||aFolderProps['TYPE']=='Q')){if(typeof aFolderProps['RECENT']=='undefined')
aFolderProps['RECENT']=0;if(typeof aNewFolderProps!='undefined'&&!aNewFolderProps['RECENT'])
aNewFolderProps['RECENT']=0;for(var n in ids[2]){if(typeof aNewFolderProps!='undefined'&&!(nFlag=WMItems.getFlag([ids[0],ids[1],ids[2][n]],'SEEN','items'))){dataSet.add('folders',[sDestAccount,sDestFolder,'RECENT'],(++aNewFolderProps['RECENT']).toString(),true);}
if(sAction=='move'&&!nFlag){dataSet.add('folders',[ids[0],ids[1],'RECENT'],(--aFolderProps['RECENT']).toString(),true);}
if(typeof aFolderProps['COUNT']!=='undefined'){dataSet.add('folders',[ids[0],ids[1],'COUNT'],(--aFolderProps['COUNT']).toString(),true);}
if(typeof aNewFolderProps!='undefined'&&typeof aNewFolderProps['COUNT']!=='undefined'){dataSet.add('folders',[sDestAccount,sDestFolder,'COUNT'],(++aNewFolderProps['COUNT']).toString(),true);}}
dataSet.update('folders');}
switch(sAction)
{case'copyall':case'moveall':WMFolders.action({aid:ids[0],fid:ids[1]},'folders','',sAction,{aid:sDestAccount,fid:sDestFolder});break;case'copy':WMItems.copy({'aid':ids[0],'fid':ids[1],'iid':ids[2],'account':sDestAccount,'folder':sDestFolder},'items','','folders',[function(bOK){bOK&&gui.notifier._value({type:'success',args:{text:'NOTIFICATION::ITEMS_COPIED'}});Item.__refreshView([sDestAccount,sDestFolder],true);}]);break;case'move':if(sDestAccount!=ids[0]||sDestFolder!=ids[1])
{WMItems.move({'aid':ids[0],'fid':ids[1],'iid':ids[2],'account':sDestAccount,'folder':sDestFolder},'items','','folders',[function(){if(!Item.__removeFromDataset(ids))
Item.__refreshView(ids,true);}]);}
break;}}};Item.__removeWithRepeating=function(iState,ids,oRepeating,oOriginator,bForce,aHandler){var aValues={};bForce&&(aValues.skip_trash=1);switch(iState.toString()){case'2':aValues.EXPFOLLOWING='true';case'0':aValues.EXPDATE=oRepeating['EVNSTARTDATE'];WMItems.remove({'aid':ids[0],'fid':ids[1],'iid':ids[2],'values':ids[2].map(function(){return aValues})},'items','','folders',[function(bOK){if(aHandler)
executeCallbackFunction(aHandler,true);else
Item.__refreshView(ids,true);}]);break;default:Item.__delete(ids,void 0,void 0,bForce,aHandler);}};Item.__delete=function(ids,oOriginator,iNext,skip_trash,aHandler){if(oOriginator&&oOriginator._focus)
oOriginator._focus();for(var i in ids[2])
if(ids[2][i].indexOf('|')>-1)
delete ids[2][i];if(!count(ids[2]))return;var aFolderProps=dataSet.get('folders',[ids[0],ids[1]]);if(aFolderProps&&(aFolderProps['TYPE']=='M'||aFolderProps['TYPE']=='R')){var iRecent=aFolderProps['RECENT']||0;for(var n in ids[2])
if(!WMItems.getFlag(makeIDFromIDS(ids,n),'SEEN','items'))
iRecent--;dataSet.add('folders',[ids[0],ids[1],'RECENT'],(iRecent>0?aFolderProps['RECENT']:0).toString(),true);dataSet.update('folders',[ids[0],ids[1],'RECENT']);}
var data={'aid':ids[0],'fid':ids[1],'iid':ids[2]};if(skip_trash){data.values=ids[2].map(function(){return{skip_trash:1};});}
WMItems.remove(data,'items','','folders',[function(bOK){if(bOK){if(oOriginator&&typeof iNext!='undefined')
oOriginator._value([iNext]);if(!Item.__removeFromDataset(ids)&&!aHandler)
Item.__refreshView(ids);}else if(!aHandler){Item.__refreshView(ids);}
if(aHandler)
executeCallbackFunction(aHandler,bOK);}]);};Item.__removeFromDataset=function(ids)
{var sFolType=WMFolders.getType(ids);if(sFolType&&ids&&ids[2]){var n=0,i;for(i in ids[2])
if(dataSet.remove('items',makeIDFromIDS(ids,i),true))
n++;var iTotal=dataSet.get("items",[ids[0],ids[1],'/']);if(Is.Defined(iTotal))
dataSet.add("items",[ids[0],ids[1],'/'],parseInt(iTotal,10)-n,true);var sIt=dataSet.get('active_items',[ids[0],ids[1]]);if(Is.Defined(sIt)&&inArray(ids[2],sIt)>-1){dataSet.remove('active_items',[ids[0],ids[1]]);dataSet.remove('preview');}
if(sFolType!='E'||Cookie.get(['views',ids[0],ids[1],'view'])=='list_view'){dataSet.update('items');return true;}
else
return false;}};Item.__refreshView=function(ids,bNoRefresh){var aActive=getPathFromDataset('items'),ids=clone(ids);if(aActive&&((aActive[0]==ids[0]&&aActive[1]==ids[1])||(WMFolders.getType(ids)=='E'&&aActive[1]=='__@@VIRTUAL@@__/__@@EVENTS@@__'&&(ids[1]='__@@VIRTUAL@@__/__@@EVENTS@@__')))){gui.frm_main._selectView({'aid':ids[0],'fid':ids[1]},null,false,null,(bNoRefresh?false:true));if(bNoRefresh){if(gui.frm_main&&gui.frm_main.main){if(!Is.Array(ids[2]))
ids[2]=[ids[2]];if(gui.frm_main.main.mailview&&WMFolders.getType(ids)=='M'){for(var i in ids[2])
if(dataSet.get('preview',[ids[0],ids[1],ids[2][i]])){dataSet.remove('preview');OldMessage.open([ids[0],ids[1],ids[2][i]]);break;}}
else
if(gui.frm_main.main.itemview){for(var i in ids[2])
if(dataSet.get('preview',[ids[0],ids[1],ids[2][i]])){dataSet.remove('preview');Item.open([ids[0],ids[1],ids[2][i]]);break;}}}}}};Item.playFile=function(id){if(gui.audio){var q;if(Is.Array(id))
q={"aid":id[0],"fid":id[1],"iid":id[2]};else
if(Is.Object(id)&&id.iid)
q={"aid":id.aid,"fid":id.fid,"iid":id.iid};else
return;q.values=['EVN_ID'];try{WMItems.list(q,'','','',[function(aData){if(aData&&(aData=aData[q.aid])&&(aData=aData[q.fid])&&(aData=aData[q.iid]))
for(var sAtId in aData['ATTACHMENTS']){var sName=aData['ATTACHMENTS'][sAtId].values.ATTDESC||sAtId;if(Path.extension(sName)=='mp3')
gui.audio._value('server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':q.aid+'/'+q.fid+'/'+WMItems.__serverID(q.iid)+'/'+sAtId}),sName);}}]);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}}};Item.openPDF=function(id){var q;if(Is.Array(id))
q={aid:id[0],fid:id[1],iid:id[2]};else
if(Is.Object(id)&&id.iid)
q={aid:id.aid,fid:id.fid,iid:id.iid};else
return;q.values=['EVN_ID'];try{WMItems.list(q,'','','',[function(aData){if(aData&&(aData=aData[q.aid])&&(aData=aData[q.fid])&&(aData=aData[q.iid]))
for(var sAtId in aData['ATTACHMENTS']){var sName=aData['ATTACHMENTS'][sAtId].values.ATTDESC||sAtId;if(Path.extension(sName)=='pdf'){var url='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':q.aid+'/'+q.fid+'/'+WMItems.__serverID(q.iid)+'/'+sAtId});if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/)){downloadItem(url,true);}else{gui._create('pdf','frm_pdf')._load(url,sName);}
return;}}}]);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}};Item.editFile=function(id){if(Is.Array(id)){var frm=gui._create('text','frm_editor');frm._load(id);}};Item.officeSupport=function(sFile){var bDisabled=GWOthers.getItem('DOCUMENTS','disable_office')==1||GWOthers.getItem('RESTRICTIONS','disable_doc_integration')==1;var bSupport=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';var editable=~['doc','docx','dot','docm','dotx','dotm','docb','odt','rtf','xls','csv','xlsx','xla','xlam','xlsb','ods','xlsb','xlsm','xlt','xltm','xltx','ppt','pptx','odp','pps','ppsm','ppsx','pptm','ppa','ppam'].indexOf(Path.extension(sFile));return editable&&bSupport&&!bDisabled;};Item.imageSupport=function(sFile){return inArray(['jpg','jpeg','png','gif'],Path.extension(sFile))>-1;};Item.editSupport=function(sFile){return inArray(['txt','html','htm'],Path.extension(sFile))>-1;};Item.officeOpen=function(aItemInfo,aErrHandler,sExtension,sMode,callback){try{if(sMode==='external'){if(!sPrimaryAccountWebDAV){throw'webdav';}else if(aItemInfo.url){Item.officeWebdav(aItemInfo.url,aErrHandler,sExtension);}else{storage.library('wm_tools');new wm_tools().ticket(aItemInfo,'rwil',[Item.officeWebdav,[aErrHandler,sExtension]]);}
return;}
var aii,mode=0,folder_type=WMFolders.getType(aItemInfo),args=arguments,frm=gui._getChildObjects('main','frm_document_onlyoffice');args.has_access=WMFolders.getAccess(aItemInfo,folder_type==='I'?'edit_document':'modify');for(var id in frm){if((aii=frm[id].aItemInfo)&&((aii.url&&aii.url===aItemInfo.url)||(!aii.url&&aii.aid===aItemInfo.aid&&aii.fid===aItemInfo.fid&&aii.iid===aItemInfo.iid&&aii.attid===aItemInfo.attid))){return frm[id]._focus&&frm[id]._focus();}}
if(sMode==='view'){mode=1;}else if(!aItemInfo.url){var data=dataSet.get('items',[aItemInfo.aid,aItemInfo.fid,aItemInfo.iid])||{};if(data.EVNCOMPLETE>50*1024*1024){gui.notifier._value({type:'alert',args:{text:'ALERTS::TOO_LARGE_TO_EDIT'}});return Item.downloadFile([aItemInfo.aid,aItemInfo.fid,aItemInfo.iid]);}
if(data.EVNLOCKOWN_EMAIL){var document_editing_info=data.EVN_DOCUMENTEDITINGINFO&&JSON.parse(data.EVN_DOCUMENTEDITINGINFO);if(document_editing_info){if(document_editing_info.editor_ownid!==sPrimaryAccountGWID){mode=document_editing_info.newparticipantsmode<2;}}else{mode=((data.EVNLOCKOWN_EMAIL===sPrimaryAccount)&&args.has_access)?0:1;}}}
Item.filesEdit(aItemInfo,mode,args,callback,aErrHandler);}catch(err){console.warn('officeOpen',err);aErrHandler&&executeCallbackFunction(aErrHandler);}};Item.collaborate=function(aIds,callback){var iid=Array.isArray(aIds[2])?aIds[2][0]:aIds[2];WMItems.list({aid:aIds[0],fid:aIds[1],iid:iid,values:['evn_id','EVNDOCPASS_PLAIN']},null,null,null,[function(aData){aData&&gui._create('frm_collaboration','frm_collaboration','','',aData[aIds[0]][aIds[1]][iid]||aData[aIds[0]][aIds[1]][WMItems.__clientID(iid)],callback);}]);};Item.filesEdit=function(aItemInfo,mode,args,callback,aErrHandler){TeamChatAPI.filesEdit(aItemInfo,mode,{success:function(response){gui._create('doc','frm_document_onlyoffice')._open(aItemInfo,mode,args,response,callback);},error:function(e){if(e.error_details.indexOf('e_')===0){e.error=e.error_details;}
switch(e.error){case'e_document_invite_password':var frm=gui._create('password','frm_password','','',[function(password){aItemInfo.password=password;Item.filesEdit(aItemInfo,mode,args,callback,aErrHandler);}],'COLLABORATION::PASSWORD','',getLang('COLLABORATION::PASSWORD_PLACEHOLDER'));return frm._size(300,145,true);case'gw_error':gui.notifier._value({type:'alert',args:{text:'ERROR::'+e.error_details.toUpperCase()}});break;default:gui.notifier._value({type:'alert',args:{text:'ERROR::'+e.error.toUpperCase()}});}
aErrHandler&&executeCallbackFunction(aErrHandler);},context:this});}
Item.officeWebdav=function(sPath,aErrHandler,sExtension){if(sPath===false||!Item.officeSupport(Path.basename(sPath.indexOf('?')>-1?sPath.substr(0,sPath.indexOf('?')):sPath))){if(aErrHandler)
executeCallbackFunction(aErrHandler);return;}
var a=null;if("ActiveXObject"in window){try{a=new ActiveXObject("SharePoint.OpenDocuments.3");}catch(r){a=null;try{a=new ActiveXObject("SharePoint.OpenDocuments.2");}catch(r){a=null;try{a=new ActiveXObject("SharePoint.OpenDocuments.1");}catch(r){a=null;}}}
if(a==null){try{if((a=new ActiveXObject("com.sun.star.ServiceManager")))
if((a=a.createInstance("com.sun.star.frame.Desktop")))
return a.LoadComponentFromURL(sPath,"_blank",0,[]);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
a=null;}}
else
if(currentBrowser()!='Chrome'||currentBrowser(true)<42)
{var sType='',a=document.getElementById("SharePointPlugin")||null;if(a==null){if(IsBrowserPluginInstalled("application/x-sharepoint-webkit"))
sType="application/x-sharepoint-webkit";else
sType="application/x-sharepoint";try{a=mkElement("object",{'id':"SharePointPlugin",'type':sType,'width':0,'height':0,'style':{'visibility':"hidden"}});document.body.appendChild(a);}
catch(r){a=null;}}}
try{if(a.EditDocument)
setTimeout(function(){if(!a.EditDocument(sPath)&&aErrHandler)
executeCallbackFunction(aErrHandler);},0);else
throw true;}
catch(r){if((!sExtension||currentBrowser()!='Chrome'||currentBrowser(true)<42)&&navigator.javaEnabled()){if((a=document.getElementById("OfficeLauncher"))){try{a.openDocument(sPath,0,-1);Item.__officeFilePath='';return true;}
catch(err){if(!sExtension||currentBrowser()!='Chrome'||currentBrowser(true)<42){gui._create('confirm','frm_confirm','','',[function(){if(sPath){downloadItem(sPath,true);Item.__officeFilePath='';}}],'OFFICELAUNCHER::OFFICELAUNCHER','OFFICELAUNCHER::OPENFAILED');return false;}}}
else{Item.__officeFilePath=sPath;var elm=mkElement('div',{'style':{'position':"absolute",'top':"-1000px;"}});elm.innerHTML='<applet code="com.elementit.OfficeLauncher.OfficeLauncher" codebase="'+document.getElementsByTagName('base')[0].href+'client/inc/officelauncher/" archive="OfficeLauncher.jar" width="0" height="0" name="OfficeLauncher" id="OfficeLauncher" mayscript="true">'+'<param name="separate_jvm" value="true">'+'<param name="permissions" value="all-permissions">'+'<param name="MSOffice.Types.Access" value="accda,accdb,accdc,accde,accdp,accdr,accdt,accdu,ade,adp,maf,mam,maq,mar,mat,mda,mdb,mde,mdt,mdw,laccdb,snp">'+'<param name="MSOffice.Types.Excel" value="csv,dbf,dif,ods,pdf,prn,slk,xla,xlam,xls,xlsb,xlsm,xlsx,xlt,xltm,xltx,xlw,xml,xml,xps">'+'<param name="MSOffice.Types.Outlook" value="obi,oft,ost,prf,pst,msg,oab,iaf">'+'<param name="MSOffice.Types.PowerPoint" value="emf,odp,pdf,pot,potm,potx,ppa,ppam,pps,ppsm,ppsx,ppt,pptm,pptx,pptx,rtf,thmx,tif,wmf,xml,xps">'+'<param name="MSOffice.Types.Word" value="doc,docm,docx,dot,dotm,dotx,htm,html,mht,mhtml,odt,pdf,rtf,txt,wps,xml,xml,xps">'+'<param name="MSOffice.Types.FrontPage" value="btr,dwt,elm,fwp,htx,mso">'+'<param name="progressbar" value="true">'+'<param name="boxmessage" value="Loading OfficeLauncher Applet...">'+'</applet>';document.body.appendChild(elm);return;}}
if(sExtension){var type='';switch(sExtension){case'doc':case'dot':case'docx':case'docm':case'dotx':case'dotm':case'docb':case'odt':case'rtf':type='ms-word:ofe';break;case'xls':case'csv':case'xlsx':case'xla':case'xlam':case'xlsb':case'ods':case'xlsb':case'xlsm':case'xlt':case'xltm':case'xltx':type='ms-excel:ofe';break;case'ppt':case'pptx':case'odp':case'pps':case'ppsm':case'ppsx':case'pptm':case'ppa':case'ppam':type='ms-powerpoint:ofv';break;case'accda':case'accdb':case'accdc':case'accde':case'accdr':case'accdt':case'ade':case'adp':case'mda':type='ms-access:ofe';break;}
if(type){downloadItem(type+'|u|'+sPath,true);}}
else{gui._create('officelauncher_error','frm_no_java','','','','OFFICELAUNCHER::OFFICELAUNCHER','',getLang('OFFICELAUNCHER::NOLAUNCH'));if(sPath){downloadItem(sPath,true);Item.__officeFilePath='';}}}};Item.getAliasFromPath=function(sPath){if(sPath){var aPath=Path.split(sPath);if(aPath[0]!=sPrimaryAccount)
return aPath[0].toLowerCase();else
if(aPath[1].indexOf(sPrimaryAccountSPREFIX)===0)
return aPath[1].substr(sPrimaryAccountSPREFIX.length).split('/').shift().toLowerCase();}
else
console.warn('Item.getAliasFromPath',sPath);};

/* client/inc/class_items_recover_helper.js */
function ItemsRecoverHelper(aIds,bShowConfirm,aResponse){var
aFilteredIds=[aIds[0],aIds[1],this.__dropIdsWithoutOriginalFolder(aIds)];this.__bShowConfirm=true===bShowConfirm;this.__aResponse=aResponse;this.__aIds=aFilteredIds;this.__aIdsOrig=aIds;this.__aFoldersMapping=[];this.__aDeletedFolders=this.__getDeletedFolders(aFilteredIds);}
ItemsRecoverHelper.prototype.process=function(){var oConfirmDialog;if(this.__bShowConfirm){oConfirmDialog=gui._create('confirm','frm_confirm','','',[this,'__recoveryConfirmed'],'POPUP_ITEMS::RECOVER','CONFIRMATION::RECOVER_ITEM');oConfirmDialog.x_btn_ok._value('POPUP_ITEMS::RECOVER');}
else{this.__recoveryConfirmed();}};ItemsRecoverHelper.prototype.__dropIdsWithoutOriginalFolder=function(aIds){var i,oItem,aIdsWithOriginalFolder=[];for(i=0;i<aIds[2].length;i++){oItem=dataSet.get('items',[aIds[0],aIds[1],aIds[2][i]]);if(oItem.ITMORIGINALFOLDER&&''!==oItem.ITMORIGINALFOLDER){aIdsWithOriginalFolder.push(aIds[2][i]);}}
return aIdsWithOriginalFolder;};ItemsRecoverHelper.prototype.__finishRecovery=function(){if(this.__aIds[2].length<this.__aIdsOrig[2].length){gui.notifier._value({type:'alert',args:{text:'RECOVERY::SOME_ITEMS_SKIPPED'}});}
if(this.__aIds[2].length>0){executeCallbackFunction(this.__aResponse,this.__aFoldersMapping,this.__aIds);}};ItemsRecoverHelper.prototype.__recoveryConfirmed=function(){if(this.__aDeletedFolders.length>0){this.__mapDeletedFolder();}else{this.__finishRecovery();}};ItemsRecoverHelper.prototype.__mapDeletedFolder=function(){var oOrigFolder;oOrigFolder=this.__findFolderToBeMapped();if(undefined===oOrigFolder){this.__finishRecovery();}else{gui._create('confirm','frm_confirm','','',[this,'__showSelectFolderDialog',[oOrigFolder]],'RECOVERY::CANNOT_BE_RECOVERED_TITLE','RECOVERY::CANNOT_BE_RECOVERED_TEXT',[oOrigFolder.name,oOrigFolder.name]);}};ItemsRecoverHelper.prototype.__showSelectFolderDialog=function(oOrigFolder){var sFolderType;if(-1!==['I','W'].indexOf(oOrigFolder.type)){sFolderType=['Y','I'];}else{sFolderType=oOrigFolder.type;}
gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::MOVE_ITEM_TO',this.__aIds[0],this.__aIds[1],[this,'__folderSelected',[oOrigFolder]],false,false,sFolderType);};ItemsRecoverHelper.prototype.__folderSelected=function(sAccountId,sSelectedFolderName,oOrigFolder){if('__@@GWTRASH@@__'===sSelectedFolderName){gui._create('confirm','frm_confirm','','',[this,'__showSelectFolderDialog',[oOrigFolder]],'RECOVERY::FOLDER_NOT_SELECTED_TITLE','RECOVERY::FOLDER_NOT_SELECTED_TEXT');return;}
this.__aFoldersMapping.push({'source':oOrigFolder.name,'destination':sSelectedFolderName});this.__mapDeletedFolder();};ItemsRecoverHelper.prototype.__findFolderToBeMapped=function(){var i;for(i=0;i<this.__aDeletedFolders.length;i++){if(!this.__isFolderMapped(this.__aDeletedFolders[i].name)){return this.__aDeletedFolders[i];}}};ItemsRecoverHelper.prototype.__getDeletedFolders=function(aIds){var i,oItem,aDeletedFolders=[],oFolders=dataSet.get('folders',[aIds[0]]);for(i=0;i<aIds[2].length;i++){oItem=dataSet.get('items',[aIds[0],aIds[1],aIds[2][i]]);if(!oFolders.hasOwnProperty(Path.slash(oItem.ITMORIGINALFOLDER))){aDeletedFolders.push({'name':oItem.ITMORIGINALFOLDER,'type':oItem.ITMCLASS});}}
return aDeletedFolders;};ItemsRecoverHelper.prototype.__isFolderMapped=function(sFolderName){var i;for(i=0;i<this.__aFoldersMapping.length;i++){if(this.__aFoldersMapping[i].source===sFolderName){return true;}}
return false;};

/* client/inc/class_new_message.js */
function NewMessage(id){if(id)
this.__id=id;this.onSentCallback=[];this.onDisposeCallback=[];this.oHeaders={};this.signatureID=0;};NewMessage.crlf='<div><br></div>';NewMessage.signature=function(sRcp){var iAliasID=null,aTmp=dataSet.get('storage',['ALIASES','ITEMS']);if(GWOthers.getItem('RESTRICTIONS','disable_personalities')>0){for(var i in aTmp)
if(aTmp[i].VALUES.EMAIL.VALUE.toLowerCase()==sPrimaryAccount){iAliasID=i;break;}}
else{var aRcp={};if(sRcp){var tmp=MailAddress.splitEmailsAndNames(sRcp);for(var i in tmp)
aRcp[tmp[i].email.toLowerCase()]=true;}
else{var tmp=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','from');if(tmp&&(tmp=MailAddress.splitEmailsAndNames(tmp))){if(tmp[0]&&tmp[0].email.toLowerCase()!=sPrimaryAccount.toLowerCase())
aRcp[tmp[0].email.toLowerCase()]=true;else
aRcp[sPrimaryAccount.toLowerCase()]=true;}
else
aRcp[sPrimaryAccount.toLowerCase()]=true;}
for(var i in aTmp)
if(aTmp[i].VALUES&&((iAliasID==null&&aTmp[i].VALUES.EMAIL.VALUE.toLowerCase()==sPrimaryAccount)||(aTmp[i].VALUES.ENABLED&&aTmp[i].VALUES.ENABLED.VALUE=='1'&&aRcp[aTmp[i].VALUES.EMAIL.VALUE.toLowerCase()])))
iAliasID=i;}
if(iAliasID!=null){var bDelegate=aTmp[iAliasID].VALUES.ISDELEGATE&&aTmp[iAliasID].VALUES.ISDELEGATE.VALUE=='1';aTmp=aTmp[iAliasID].VALUES[Is.Defined(sRcp)?'SIGN2':'SIGN1']||{VALUE:'0'};var aSign=dataSet.get('storage',['SIGNATURE','ITEMS']);for(var i in aSign)
if(aSign[i].VALUES.ID&&aSign[i].VALUES.ID.VALUE==aTmp.VALUE||(aTmp.VALUE=='0'&&!aSign[i].VALUES.ID))
if(aSign[i].VALUES.TEXT){var signature=aSign[i].VALUES.TEXT.VALUE;if(signature.indexOf('<')<0)
signature=signature.replace(/(\r\n)|(\n)/gm,'<br>');return{text:(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','sign_separator')>0?'<div class="separator">-- </div>':'')+signature,id:(aSign[i].VALUES.ID?aSign[i].VALUES.ID.VALUE:0),delegate:bDelegate};}}
return{text:'',id:0,delegate:false};};NewMessage.linkFix=function(v){var tmp=document.implementation.createHTMLDocument("link").body;tmp.innerHTML=v;[].forEach.call(tmp.querySelectorAll('a[href]'),function(elm){try{elm.href=(elm.protocol?elm.protocol+(elm.protocol=='mailto:'?'':'//'):'')+elm.host+elm.pathname+elm.search+elm.hash;}
catch(r){elm.removeAttribute('href');}});return tmp.innerHTML;};NewMessage.compose_sms=function(aResponse){if(aResponse){for(var i in aResponse)
for(var j in aResponse[i]){delete aResponse[i][j]['/'];delete aResponse[i][j]['#'];delete aResponse[i][j]['$'];delete aResponse[i][j]['@'];var tmp='';for(var k in aResponse[i][j])
tmp+=(tmp?';':'')+MailAddress.createEmail(aResponse[i][j][k].ITMCLASSIFYAS,aResponse[i][j][k].LCTPHNMOBILE);if(tmp)
NewMessage.compose({sms:tmp});else
gui.notifier._value({type:'alert',args:{header:'MAIN_MENU::SMS',text:'CONFIRMATION::NO_MOBILE'}});}}
else
NewMessage.compose({sms:true});};NewMessage.compose=function(aRecipients,bIsHTML){var newMessage=new NewMessage();if(aRecipients instanceof OldMessage){newMessage.sTo=aRecipients.getTo();newMessage.sRcp=newMessage.sFrom=aRecipients.getFrom();newMessage.sCc=aRecipients.getCc();newMessage.sBcc=aRecipients.getBcc();newMessage.sTeamchat=aRecipients.getTeamchat();newMessage.sComment=aRecipients.getComment();newMessage.sSMS=aRecipients.getSms();newMessage.sSubject=aRecipients.getSubject();newMessage.setHtml(aRecipients.isHtml(true));newMessage.sBody=aRecipients.getBody();newMessage.aAttachments=aRecipients.copyAttachments(aRecipients.__id);}
else
if(typeof aRecipients=='object'){if(aRecipients.to)
newMessage.sTo=aRecipients.to;if(aRecipients.cc)
newMessage.sCc=aRecipients.cc;if(aRecipients.bcc)
newMessage.sBcc=aRecipients.bcc;if(aRecipients.sms)
newMessage.sSMS=aRecipients.sms;else
if(aRecipients.template)
newMessage.template=aRecipients.template;else
if(aRecipients.mailBody){newMessage.sBody=aRecipients.mailBody;newMessage.addSignature(true);}
else{if(aRecipients.alias)
newMessage.sRcp=MailAddress.createEmail('',aRecipients.alias);if(aRecipients.htmlBody){newMessage.sBody=aRecipients.htmlBody;}
newMessage.addSignature();}
if(aRecipients.teamchat){newMessage.sTeamchat=aRecipients.teamchat;if(aRecipients.teamchat_comment)
newMessage.sComment=aRecipients.teamchat_comment;}
if(aRecipients.subject)
newMessage.sSubject=aRecipients.subject;if(aRecipients.headers)
newMessage.oHeaders=aRecipients.headers;if(aRecipients.body){newMessage.sBody=aRecipients.body;newMessage.setHtml(false);}}
else
newMessage.addSignature();if(!aRecipients||(!aRecipients.sms&&!aRecipients.template))
newMessage.addvCard();if(bIsHTML!==void 0){newMessage.setHtml(bIsHTML);}
return gui._create('frm_compose','frm_compose','','',newMessage);};NewMessage.composeTemplate=function(){var f=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','templates')),frm=gui._create('template','frm_insert_item','','',[function(aPath){if(aPath=aPath[0]){var oldTemplate=new OldMessage([aPath.aid,aPath.fid,aPath.id]);NewMessage.compose(oldTemplate);}}],f[0],f[1],'M','',true);frm._title('COMPOSE::TEMPLATE');};NewMessage.prototype.isHtml=function(){if(!Is.Defined(this.__bHtml))
this.__bHtml=(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')||0)>0?true:false;return this.__bHtml;};NewMessage.prototype.setHtml=function(bHtml){this.__bHtml=bHtml?true:false;};NewMessage.prototype.save=function(bKeepAttachments,aNotify,aSettingsDefault,bTeamChat){var aMessageIQ=this.__loadCommonMessageIQ(bKeepAttachments,aSettingsDefault);aMessageIQ.to=this.sTo;aMessageIQ.cc=this.sCc;aMessageIQ.bcc=this.sBcc;aMessageIQ.action.email='false';if(this.sTeamchat){aMessageIQ.teamchat=this.sTeamchat;aMessageIQ.teamchat_comment=this.sComment||'';if(!this.__id_chat||this.__id_chat[1]!=this.sTeamchat.replace(/(::.+)$/g,''))
this.__id_chat={0:sPrimaryAccount,1:this.sTeamchat.replace(/(::.+)$/g,'')};aMessageIQ['action']['save_chat']={aid:this.__id_chat[0],fid:this.__id_chat[1]};if(this.__id_chat[2])aMessageIQ['action']['save_chat']['iid']=WMItems.__serverID(Array.isArray(this.__id_chat[2])?this.__id_chat[2][0]:this.__id_chat[2]);}
else
if(bTeamChat)
return false;if(!bTeamChat){if(aSettingsDefault.sms>0&&this.sSMS)
aMessageIQ.sms=this.sSMS;if(!this.__id){this.__id=[];var sTarget=Path.split(GWOthers.getItem('DEFAULT_FOLDERS',(this.template?'templates':'drafts')));this.__id[0]=sTarget[0];this.__id[1]=sTarget[1];}
aMessageIQ['action']['save']={"aid":this.__id[0],"fid":this.__id[1]};if(this.__id[2])aMessageIQ['action']['save']['iid']=Array.isArray(this.__id[2])?this.__id[2][0]:this.__id[2];}
storage.library('wm_messages');return message.add(aMessageIQ,'dummy','',[this,'__messageSaved',[aNotify,bTeamChat]],aNotify);};NewMessage.prototype.send=function(bKeepAttachments,aNotify,aSettingsDefault){var aSettingsDefault=aSettingsDefault||{};var aMessageIQ=this.__loadCommonMessageIQ(bKeepAttachments,aSettingsDefault);if(this.sTo==''&&this.sCc==''&&this.sBcc==''&&this.sSMS=='')
return false;aMessageIQ['action']['email']='true';if((typeof aSettingsDefault=='object'&&parseInt(aSettingsDefault['save_sent_message'])>0)||(typeof aSettingsDefault!='object'&&parseInt(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','save_sent_message'))>0)){var sSentFolder=Path.split(aSettingsDefault['sent']||GWOthers.getItem('DEFAULT_FOLDERS','sent'));aMessageIQ['action']['save']={"aid":sSentFolder[0],"fid":sSentFolder[1]};}
if(this.sTeamchat){aMessageIQ.teamchat=this.sTeamchat;aMessageIQ.teamchat_comment=this.sComment||'';if(!this.__id_chat||this.__id_chat[1]!=this.sTeamchat.replace(/(::.+)$/g,''))
this.__id_chat={0:sPrimaryAccount,1:this.sTeamchat.replace(/(::.+)$/g,'')};aMessageIQ['action']['save_chat']={aid:this.__id_chat[0],fid:this.__id_chat[1]};if(this.__id_chat[2])aMessageIQ['action']['save_chat']['iid']=WMItems.__serverID(Array.isArray(this.__id_chat[2])?this.__id_chat[2][0]:this.__id_chat[2]);}
if(GWOthers.getItem('MAIL_SETTINGS_GENERAL','smtp_relay')>0)
aMessageIQ['action']['smtp_relay']='true';var aDistribList=MailAddress.findDistribList({'to':this.sTo,'cc':this.sCc,'bcc':this.sBcc});for(var sTag in aDistribList)
aMessageIQ[sTag]=aDistribList[sTag];if(aSettingsDefault.sms>0&&this.sSMS)
aMessageIQ.sms=this.sSMS;var rst=GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'';if(rst.indexOf('c')<0&&window.sPrimaryAccountGW&&parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','auto_recipient_to_addressbook')))
aMessageIQ['action']['auto_addressbook']='true';if(aMessageIQ.body){storage.library('purify.wrapper','purify');var safeHtml=mkElement('div',{innerHTML:DOMPurify.sanitize(aMessageIQ.body)});[].forEach.call(safeHtml.querySelectorAll('[iw-remove='+(aMessageIQ.action.html_body==="true"?'html':'text')+']'),function(elm){elm.parentNode.removeChild(elm);});aMessageIQ.body=safeHtml.innerHTML;}
storage.library('wm_messages');return message.add(aMessageIQ,'dummy','',[this,'__messageSent',[aNotify]],aNotify);};NewMessage.prototype.dispose=function(){if(typeof this.onDisposeCallback=='object'&&this.onDisposeCallback.length>0)
for(var i in this.onDisposeCallback)
executeCallbackFunction(this.onDisposeCallback[i]);};NewMessage.prototype.addvCard=function(){if(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','append_vcard')>0){if(!this.aAttachments||!this.aAttachments.attachments)
this.aAttachments={'attachments':[]};this.aAttachments.attachments.push({'values':{'class':'item','fullpath':sPrimaryAccount+'/@@mycard@@/@@mycard@@','name':(dataSet.get('main',['fullname'])||'vCard')+'.vcf'}});}};NewMessage.prototype.addSignature=function(bBottom){if(!Is.Defined(this.sBody))
this.sBody='';else
this.sBody=this.sBody.replace('<div class="iw-signature">','<div>');var aSign=NewMessage.signature(this.sRcp),sSign=aSign.text?NewMessage.crlf+'<div class="iw-signature">'+aSign.text+'</div>':'';this.signatureID=aSign.id;this.bDelegate=aSign.delegate;if(!bBottom&&GWOthers.getItem('MAIL_SETTINGS_DEFAULT','sign_top')>0)
this.sBody=sSign+this.sBody;else
this.sBody=this.sBody+sSign;};NewMessage.prototype.__loadCommonMessageIQ=function(bKeepAttachments,aSettings){var aMessageIQ={};if(typeof aSettings!='object')
aSettings=GWOthers.get('MAIL_SETTINGS_DEFAULT','storage')['VALUES'];aMessageIQ['action']={"im":'false',"keep":(bKeepAttachments)?'true':'false',"html_body":(this.isHtml())?'true':'false'};if(aSettings.smart_attach>0){aMessageIQ['action'].smart_attach='true';if(aSettings.smart_path){var asap=Path.split(aSettings.smart_path);if(asap&&asap[1])
aMessageIQ['action'].smart_attach_folder=asap[1];}}
aMessageIQ['from']=aSettings['from']||getPrimaryAccountFromAddress();aMessageIQ['subject']=this.sSubject;if(aSettings.sms>0){aMessageIQ['action'].sms='true';aMessageIQ['text']=this.sBody;}
else
aMessageIQ['body']=this.sBody;if(this.sDeferred)
aMessageIQ['deferred_date']=this.sDeferred;var aHeaders=[];if(parseInt(aSettings['read_confirmation'])){aHeaders.push('X-Confirm-Reading-To: '+aMessageIQ['from']);aHeaders.push('Disposition-Notification-To: '+aMessageIQ['from']);}
for(var i in this.oHeaders)
aHeaders.push(i+': '+this.oHeaders[i]);if(this.sIn_Reply_To)
aHeaders.push('In-Reply-To: '+this.sIn_Reply_To);if(this.sReferences)
aHeaders.push('References: '+this.sReferences);if(parseInt(aSettings['priority']))
aHeaders.push('X-Priority: '+aSettings['priority']);if(aSettings['reply_to_address']){var aTmp=MailAddress.splitEmailsAndNames(aSettings['reply_to_address']);if(aTmp&&aTmp[0])
aHeaders.push('Reply-To: '+MailAddress.createEmail(aTmp[0].name,aTmp[0].email));}
if(this.bDelegate)
aHeaders.push('Sender: '+getPrimaryAccountFromAddress());if(!Is.Empty(aHeaders))
aMessageIQ['headers']=aHeaders;if(parseInt(aSettings['encrypt']))
aMessageIQ['action']['encrypt']='true';if(parseInt(aSettings['sign']))
aMessageIQ['action']['sign']='true';if(this.aAttachments){var aAttachments=this.aAttachments['attachments'];var sUploadFolId=this.aAttachments['folder'];var aAttachResult=[];for(var n in aAttachments){aAttachResult[n]={"class":(aAttachments[n]['class']?aAttachments[n]['class']:'file'),"type":'normal',"fullpath":(aAttachments[n]['class']?aAttachments[n]['fullpath']:sUploadFolId+'/'+aAttachments[n]['id'])};if(aAttachments[n]['description'])
aAttachResult[n]['description']=aAttachments[n]['description'];}
if(!Is.Empty(aAttachResult))
aMessageIQ['attachments']=aAttachResult;}
return aMessageIQ;};NewMessage.prototype.__messageSaved=function(bOK,sUId,sError,aNotify,bChat){if(bOK&&(sUId.length||(bChat&&bOK.TEAMCHAT_ID))){var bFirstTime=false;if(bChat){bOK.TEAMCHAT_ID=WMItems.__clientID(bOK.TEAMCHAT_ID);var sAction=this.__id_chat[2]!=bOK.TEAMCHAT_ID?'add':'update';this.__id_chat[1]=Path.slash(bOK.TEAMCHAT);this.__id_chat[2]=bOK.TEAMCHAT_ID;Item.notify(this.__id_chat,sAction,'M');if(bOK.TEAMCHAT_LINK_ID)
Item.notify([this.__id_chat[0],this.__id_chat[1],WMItems.__clientID(bOK.TEAMCHAT_LINK_ID)],'add','Y');}
else{if(this.__id[2]!=sUId){bFirstTime=true;this.__id[2]=sUId;this.onSentCallback.push([function(id){Item.remove(makeIDSFromID(id),true);},[this.__id]]);}
Item.__refreshView(this.__id,true);}
if(aNotify)
executeCallbackFunction(aNotify,true,bFirstTime,this,sError);}
else
if(aNotify)
executeCallbackFunction(aNotify,false,false,sUId,sError);};NewMessage.prototype.__messageSent=function(aOut,sUId,sError,aNotify){if(aOut&&!sError&&typeof this.onSentCallback=='object'&&this.onSentCallback.length)
for(var i in this.onSentCallback){pushParameterToCallback(this.onSentCallback[i],aOut);executeCallbackFunction(this.onSentCallback[i]);}
if(aNotify)
executeCallbackFunction(aNotify,aOut,sUId,sError);if(aOut&&!sError){if(aOut.TEAMCHAT&&aOut.TEAMCHAT_ID){aOut.TEAMCHAT_ID=WMItems.__clientID(aOut.TEAMCHAT_ID);var sAction=this.__id_chat[2]!=aOut.TEAMCHAT_ID?'add':'update';this.__id_chat[1]=Path.slash(aOut.TEAMCHAT);this.__id_chat[2]=aOut.TEAMCHAT_ID;Item.notify(this.__id_chat,sAction,'M');if(aOut.TEAMCHAT_LINK_ID)
Item.notify(this.__id_chat,'add','Y');}
if(gui.notifier){if(this.sDeferred){var d=new IcewarpDate(this.sDeferred);gui.notifier._value({type:'send_message_deferred',args:[aOut,d]});}else{gui.notifier._value({type:'message_sent',args:[aOut]});}}}};

/* client/inc/class_old_message.js */
function OldMessage(id,mailInfo){this.__id=id;this.__datasetItems={};dataSet.obey(this,null,'items');if(mailInfo){this.__mailInfo=mailInfo;}
else{this.__mailInfo=WMItems.list({"aid":this.__id[0],"fid":this.__id[1],"iid":this.__id[2],"values":OldMessage.__FULLMAIL_VALUES_DANGER})[this.__id[0]][this.__id[1]][this.__id[2]];delete this.__mailInfo['/'];}
for(var k in this.__mailInfo)
this.__datasetItems[k]=this.__mailInfo[k];};OldMessage.__FULLMAIL_VALUES=['TO','FROM','SENDER','CLEAN_HTML','CC','BCC','SMS','REPLY_TO','ATTACHMENTS','FLAGS','HAS_ATTACHMENT','HAS_EMBEDDED_ATTACHMENT','PRIORITY','TAGS','STATIC_FLAGS','SUBJECT','SMIME_STATUS','CONFIRM_ADDR','DATE','SIZE','CERTIFICATE','MESSAGE_ID','REFERENCES','IN_REPLY_TO','COLOR','DEFERRED_DELIVERY'];OldMessage.__FULLMAIL_VALUES_DANGER=['TO','FROM','SENDER','HTML','CC','BCC','SMS','REPLY_TO','ATTACHMENTS','FLAGS','HAS_ATTACHMENT','HAS_EMBEDDED_ATTACHMENT','PRIORITY','TAGS','STATIC_FLAGS','SUBJECT','SMIME_STATUS','CONFIRM_ADDR','DATE','SIZE','CERTIFICATE','MESSAGE_ID','REFERENCES','IN_REPLY_TO','REPLY_FULLPATH','FORWARD_FULLPATH','COLOR','KEEP_SEEN','DEFERRED_DELIVERY'];OldMessage.__TEXTMAIL_VALUES=['TO','FROM','SENDER','TEXT','CC','BCC','SMS','REPLY_TO','ATTACHMENTS','FLAGS','HAS_ATTACHMENT','HAS_EMBEDDED_ATTACHMENT','PRIORITY','TAGS','STATIC_FLAGS','SUBJECT','SMIME_STATUS','CONFIRM_ADDR','DATE','SIZE','CERTIFICATE','MESSAGE_ID','REFERENCES','IN_REPLY_TO','COLOR','DEFERRED_DELIVERY'];OldMessage.source=function(id){WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['SUBJECT','SOURCE']},'','','',[function(aData){if(aData&&(aData=aData[id[0]])&&(aData=aData[id[1]])&&(aData=aData[id[2]])){var frm=gui._create('source','obj_popup','','frm_source');frm._title(aData.SUBJECT||getLang('POPUP_ITEMS::SOURCE'),true);frm._defaultSize(-1,-1,900,620);frm._ondock=function(){return{title:this._title(),css:'ico_frm_source'}};frm._create('text','obj_text','main','obj_text100 noborder');frm.text._value(aData.SOURCE||'');}}]);};OldMessage.edit=function(id,aValues,bIsHTML){var cid,arr=gui._getChildObjects('main','frm_compose');for(var i in arr){if(arr[i].__message&&(cid=arr[i].__message.__id||arr[i].__message.__id_chat)&&cid[0]==id[0]&&cid[1]==id[1]&&cid[2]==(id[2].replace('|@@MAIN@@',''))){arr[i]._focus();return;}}
try{var oldMessage=new OldMessage(id);var newMessage=new NewMessage(id);}
catch(er){return;}
newMessage.sTo=oldMessage.getTo();newMessage.sRcp=newMessage.sFrom=oldMessage.getFrom();newMessage.sCc=oldMessage.getCc();newMessage.sBcc=oldMessage.getBcc();newMessage.sTeamchat=oldMessage.getTeamchat();newMessage.sComment=oldMessage.getComment();newMessage.sSMS=oldMessage.getSms();newMessage.sSubject=oldMessage.getSubject();newMessage.setHtml(oldMessage.isHtml(true));if(bIsHTML!==void 0){newMessage.setHtml(bIsHTML);}
newMessage.sBody=oldMessage.getBody();newMessage.aAttachments=oldMessage.copyAttachments(id);newMessage.iPriority=oldMessage.getPriority();newMessage.sDeferred=oldMessage.getDelay();if(Is.Object(aValues))
for(var k in aValues)
newMessage[k]=aValues[k];oldMessage.dispose();if(WMFolders.getType([id[0],id[1]])=='M'&&id[0]+'/'+id[1]!=GWOthers.getItem('DEFAULT_FOLDERS','templates')){newMessage.onSentCallback.push([Item.remove,[makeIDSFromID(id),true,'','','']]);if(oldMessage.__mailInfo.REPLY_FULLPATH){var tmp_id=oldMessage.__mailInfo.REPLY_FULLPATH.split('/');tmp_id[2]=[tmp_id[2]];newMessage.onSentCallback.push([OldMessage.markAsAnswered,[tmp_id]]);}
if(oldMessage.__mailInfo.FORWARD_FULLPATH){var tmp_id=oldMessage.__mailInfo.FORWARD_FULLPATH.split('/');tmp_id[2]=[tmp_id[2]];newMessage.onSentCallback.push([OldMessage.markAsForwarded,[oldMessage.__mailInfo.FORWARD_FULLPATH.split('/')]]);}}
gui._create('frm_compose','frm_compose','','',newMessage);return newMessage;};OldMessage.forward=function(id,bForwardAsMessage,bForwardResend,bIsHTML){try{var newMessage=new NewMessage(),oldMessage=[];if(Is.Array(id[2])){for(var i in id[2])
oldMessage.push(new OldMessage([id[0],id[1],id[2][i]]));}
else{oldMessage.push(new OldMessage(id));if(WMFolders.getType(id[0],id[1])=='M')
newMessage.oHeaders['X-Forward-Fullpath']=id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2]);}}
catch(er){return;}
if(!Is.Defined(bForwardAsMessage)){storage.library('gw_others');bForwardAsMessage=(GWOthers.getItem('MAIL_SETTINGS_GENERAL','forward_messages')!='inline');if(oldMessage[0].__mailInfo.REFERENCES)
newMessage.sReferences=oldMessage[0].__mailInfo.REFERENCES.trim();else
if(oldMessage[0].__mailInfo.IN_REPLY_TO)
newMessage.sReferences=oldMessage[0].__mailInfo.IN_REPLY_TO.split("\n").shift().trim()||'';if(oldMessage[0].__mailInfo.MESSAGE_ID){newMessage.sIn_Reply_To=oldMessage[0].__mailInfo.MESSAGE_ID.trim();newMessage.sReferences=(newMessage.sReferences?newMessage.sReferences+"\r\n\t":'')+newMessage.sIn_Reply_To;}}
if(bForwardResend){newMessage.sSubject=oldMessage[0].getSubject();newMessage.sTo=oldMessage[0].getTo();}else{newMessage.sSubject=OldMessage.__prefixParser(oldMessage[0].getSubject(),'Fw');}
if(bForwardAsMessage){newMessage.aAttachments={'attachments':[]};for(var i in oldMessage)
newMessage.aAttachments.attachments.push({'values':{'class':'message','fullpath':id[0]+'/'+id[1]+'/'+WMItems.__serverID(oldMessage[i].__id[2]),'name':'message_'+i+'.eml','size':oldMessage[i].getSize()}});}
else{if(bForwardResend)
newMessage.sBody=oldMessage[0].getBody();else
newMessage.sBody=oldMessage[0].quoteMessage(getLang('EMAIL::FORWARD_MESSAGE_HTML'));newMessage.aAttachments=oldMessage[0].copyAttachments(id);newMessage.setHtml(oldMessage[0].isHtml(true));}
if(bIsHTML!==void 0){newMessage.setHtml(bIsHTML);}
if(!bForwardResend)
newMessage.addSignature();var tmp_id=[oldMessage[0].__id[0],oldMessage[0].__id[1],[]];for(var i in oldMessage){if(oldMessage[i].__id[2].indexOf('|')<0)
tmp_id[2].push(oldMessage[i].__id[2]);newMessage.onDisposeCallback.push([oldMessage[i],oldMessage[i].dispose]);}
if(tmp_id[2].length)
newMessage.onSentCallback.push([OldMessage.markAsForwarded,[tmp_id]]);gui._create('frm_compose','frm_compose','','',newMessage,oldMessage[0]);};OldMessage.prototype.quoteMessage=function(sLabel,bReply){var sBody='';if(this.isHtml()){var sBase=this.getBase();if(sBase){var sBase2=document.location.protocol+'//'+document.location.hostname+'/',div=mkElement('div');div.innerHTML=this.getBody();var elms=div.getElementsByTagName('a');for(var i=elms.length-1;i>=0;i--)
if(elms[i].href&&elms[i].href.toLowerCase().indexOf(sBase2)===0)
elms[i].href=sBase+elms[i].href.substr(sBase2.length);var elms=div.getElementsByTagName('img');for(var i=elms.length-1;i>=0;i--)
if(elms[i].src&&elms[i].src.toLowerCase().indexOf(sBase2)===0)
elms[i].src=sBase+elms[i].src.substr(sBase2.length);sBody=div.innerHTML;div=null;}
else
sBody=this.getBody();}
else
sBody=this.getBody();var aTo=MailAddress.splitEmailsAndNames(this.getTo());return NewMessage.crlf+template.tmp('obj_mailview_quote',{html:this.isHtml(),label:sLabel||getLang('EMAIL::REPLY_MESSAGE_HTML'),from:OldMessage._parseRcp(this.getFrom()),to:OldMessage._parseRcp(this.getTo()),cc:OldMessage._parseRcp(this.getCc()),date:(new IcewarpDate(parseInt(this.getDate())*1000)).format('L LT'),subject:this.getSubject(),short:bReply&&aTo.length===1&&aTo[0].email===sPrimaryAccount?sPrimaryAccount:'',body:sBody});};OldMessage.replyTemplate=function(id,bReplyToAll){var f=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','templates')),frm=gui._create('template','frm_insert_item','','',[function(aPath){if(aPath=aPath[0])
OldMessage.reply(id,bReplyToAll,[aPath.aid,aPath.fid,aPath.id]);}],f[0],f[1],'M','',true);frm._title('COMPOSE::TEMPLATE');};OldMessage.reply=function(id,bReplyToAll,aTemplate,bSkipCreateComposeWindow,bIsHTML,bCopyAttachments){var extractMail=function(sMails,sExtract,aExtract){if(!sMails||!sExtract)return sMails;sExtract=sExtract.toLowerCase();var addr=MailAddress.splitEmailsAndNames(sMails),out=[],bSkip=false;for(var i=0,j=addr.length;i<j;i++)
if(sExtract==addr[i].email.toLowerCase())
bSkip=true;else
out.push(MailAddress.createEmail(addr[i].name,addr[i].email));if(!bSkip&&aExtract&&aExtract.length>0){out=[];for(var i=0,j=addr.length;i<j;i++)
if(inArray(aExtract,addr[i].email.toLowerCase())<0)
out.push(MailAddress.createEmail(addr[i].name,addr[i].email));}
return out.join(', ');};try{var oldMessage=new OldMessage(id);var newMessage=new NewMessage();if(aTemplate)
var oldTemplate=new OldMessage(aTemplate);}
catch(er){return;}
newMessage.sRcp=extractMail(oldMessage.getTo(),sPrimaryAccount);if(bReplyToAll){var sTo=oldMessage.getReply(),sMy=MailAddress.splitEmailsAndNames(id[0])[0].email.toLowerCase(),aAlias=dataSet.get('storage',['ALIASES','ITEMS']),aEx=[];for(var i in aAlias)
if(aAlias[i].VALUES.EMAIL.VALUE.toLowerCase()!=sMy)
aEx.push(aAlias[i].VALUES.EMAIL.VALUE.toLowerCase());newMessage.sTo=extractMail((sTo?sTo+', ':'')+oldMessage.getTo(),sMy,aEx)||sTo;newMessage.sCc=extractMail(oldMessage.getCc(),sMy);newMessage.sBcc=extractMail(oldMessage.getBcc());}
else{newMessage.sTo=oldMessage.getReply();if(sPrimaryAccountSMS){var aMails=MailAddress.splitEmailsAndNames(newMessage.sTo);if(aMails&&aMails[0]&&aMails[0].email&&(aMails[0].email=aMails[0].email.replace(/\"/g,''))&&aMails[0].email.indexOf('sms:')===0){var num=/sms\:([\+0-9]+)\@/g.exec(aMails[0].email);if(num&&(num=num[1])&&num!=aMails[0].name)
newMessage.sSMS=MailAddress.createEmail(aMails[0].name,num);else
newMessage.sSMS=MailAddress.createEmail('',aMails[0].name);newMessage.sTo='';}}}
if(!newMessage.sSMS){newMessage.sSubject=OldMessage.__prefixParser(oldMessage.getSubject(),'Re');newMessage.sBody=oldMessage.quoteMessage(getLang('EMAIL::REPLY_MESSAGE_HTML'),true);if(oldTemplate){newMessage.setHtml(oldMessage.isHtml(true)||oldTemplate.isHtml(true));var b=mkElement('div');b.innerHTML=oldTemplate.getBody();if(document.getElementsByClassName){var elm=b.getElementsByClassName('iw-signature');if(elm&&(elm=elm[0]))
elm.parentNode.removeChild(elm);newMessage.addSignature();}
else
if(oldTemplate.getBody().indexOf('<div class="iw-signature">')<0)
newMessage.addSignature();newMessage.sBody=b.innerHTML+newMessage.sBody;newMessage.aAttachments=oldTemplate.copyAttachments(aTemplate);}
else{newMessage.setHtml(oldMessage.isHtml(true));newMessage.addSignature();}
if(bCopyAttachments)
newMessage.aAttachments=oldMessage.copyAttachments(id);newMessage.addvCard();}
if(bIsHTML!==void 0){newMessage.setHtml(bIsHTML);}
if(oldMessage.__mailInfo.REFERENCES)
newMessage.sReferences=oldMessage.__mailInfo.REFERENCES.trim();else
if(oldMessage.__mailInfo.IN_REPLY_TO)
newMessage.sReferences=oldMessage.__mailInfo.IN_REPLY_TO.split("\n").shift().trim()||'';if(oldMessage.__mailInfo.MESSAGE_ID){newMessage.sIn_Reply_To=oldMessage.__mailInfo.MESSAGE_ID.trim();newMessage.sReferences=(newMessage.sReferences?newMessage.sReferences+"\r\n\t":'')+newMessage.sIn_Reply_To;}
if(id[2].indexOf('|')<0)
newMessage.onSentCallback.push([oldMessage,oldMessage.setAnswered]);newMessage.onDisposeCallback.push([oldMessage,oldMessage.dispose]);newMessage.oHeaders['X-Reply-Fullpath']=id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2]);!bSkipCreateComposeWindow&&gui._create('frm_compose','frm_compose','','',newMessage,oldMessage);return[newMessage,oldMessage];};OldMessage.redirect=function(id){var frm=gui._create('frm_addaddress','frm_addaddress','','',[OldMessage.__redirect,[id]],{'to':"DATAGRID_ITEMS_VIEW::TO"},{},'to',true);frm.x_btn_ok._onclick=function(){this._parent.__hide();this._parent.__ok=true;this._parent._onclose();};};OldMessage.whitelistSender=function(ids){gui._create('frm_confirm','frm_confirm','','',[OldMessage.__blackOrWhiteList,[ids,true]],'CONFIRMATION::WHITELIST_SENDER_CONFIRMATION','CONFIRMATION::WHITELIST_SENDER');};OldMessage.blacklistSender=function(ids){gui._create('frm_confirm','frm_confirm','','',[OldMessage.__blackOrWhiteList,[ids,false]],'CONFIRMATION::BLACKLIST_SENDER_CONFIRMATION','CONFIRMATION::BLACKLIST_SENDER');};OldMessage.whitelistDomain=function(ids){gui._create('frm_confirm','frm_confirm','','',[OldMessage.__blackOrWhiteList,[ids,true,true]],'CONFIRMATION::WHITELIST_SENDER_CONFIRMATION','CONFIRMATION::WHITELIST_DOMAIN');};OldMessage.blacklistDomain=function(ids){gui._create('frm_confirm','frm_confirm','','',[OldMessage.__blackOrWhiteList,[ids,false,true]],'CONFIRMATION::BLACKLIST_SENDER_CONFIRMATION','CONFIRMATION::BLACKLIST_DOMAIN');};OldMessage.deliver=function(ids){OldMessage.__quarantineAction(ids,'deliver')};OldMessage.whitelist=function(ids){OldMessage.__quarantineAction(ids,'whitelist');if(gui.notifier)
gui.notifier._value({type:'sender_whitelisted'});};OldMessage.blacklist=function(ids){OldMessage.__quarantineAction(ids,'blacklist');if(gui.notifier)
gui.notifier._value({type:'sender_blacklisted'});};OldMessage.__quarantineAction=function(ids,sAction){WMItems.quarantine({'aid':ids[0],'fid':ids[1],'iid':ids[2],'action':sAction},'items','','folders');Item.__removeFromDataset(ids);};OldMessage.setColor=function(ids,sColor){if(!Is.Array(ids[2]))
ids[2]=[ids[2]];for(var id,sOldColor,i=0;i<ids[2].length;i++){id=[ids[0],ids[1],ids[2][i]];sOldColor=OldMessage.getColor(id);if(!sOldColor||sOldColor!=sColor){dataSet.add('items',id.concat(['COLOR']),sColor);WMItems.add(id,{'values':{'COLOR':sColor}},'items','','',[function(bOK){if(bOK){if(dataSet.get('preview',id)){dataSet.add('preview',id.concat(['COLOR']),sColor);}}else{dataSet.add('items',id.concat(['COLOR']),sOldColor);}}]);}}};OldMessage.getColor=function(id){return dataSet.get('items',id.concat(['COLOR']))};OldMessage.open=function(id,bKeepSeen,bForceOpen){if(dataSet.get('preview',id)&&!bForceOpen)return;dataSet.add('active_items',[id[0],id[1]],id[2]);if((GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_inline_images')||0)<1||(dataSet.get('main',['spam_path'])==id[0]+'/'+id[1]&&(GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_images')||0)<1))
var def_val=OldMessage.__FULLMAIL_VALUES;else
var def_val=OldMessage.__FULLMAIL_VALUES_DANGER;if(dataSet.get('folders',[id[0],id[1],'TYPE'])=='M'){try{var message=new OldMessage(id,{});WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":def_val,"custom_values":{KEEP_SEEN:bKeepSeen}},'preview','','folders',[OldMessage.__mailviewCallback,[message,message.hasFlag('SEEN')]]);}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er)}}
else
WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":def_val},'preview','','folders');};OldMessage.delivery_report=function(id){gui._create('frm_delivery','frm_delivery','','',id);};OldMessage.openwindow=function(id,aSortInfo,aLockInfo,bIsHTML){var frms=gui._getChildObjects('main','frm_mail');if(frms.length)
for(var i=frms.length-1;i>=0;i--)
if(Is.Array(frms[i].__id)&&arrayCompare(frms[i].__id,id)){frms[i]._focus();return;}
gui._create('frm_mail','frm_mail','','',id,aSortInfo,aLockInfo,bIsHTML);};OldMessage.markWithFlag=function(ids,aFlags,bUpdFolders){WMItems.setFlag({"aid":ids[0],"fid":ids[1],"iid":ids[2]},aFlags,'items',bUpdFolders?'folders':'');};OldMessage.markAsRead=function(ids){OldMessage.markWithFlag(ids,{'SEEN':true},true);};OldMessage.markAsUnread=function(ids){OldMessage.markWithFlag(ids,{'SEEN':false},true);};OldMessage.markAsForwarded=function(ids){OldMessage.markWithFlag(ids,{'FORWARDED':true},false);};OldMessage.markAsAnswered=function(ids){OldMessage.markWithFlag(ids,{'ANSWERED':true},false);};OldMessage.__blackOrWhiteList=function(ids,bWhitelist,bDomain){var sFolder=bWhitelist?'SPAM_QUEUE/Whitelist':'SPAM_QUEUE/Blacklist';for(var i in ids[2]){var sender=dataSet.get('items',[ids[0],ids[1],ids[2][i],'FROM']);if(!sender||!(sender=MailAddress.splitEmailsAndNames(sender)))continue;sender=sender[0]['email'];if(bDomain)
sender=sender.split("@")[1];WMItems.add([sPrimaryAccount,sFolder],{'values':{'EMAIL':sender}},'items');}
var sSpam=Path.split(dataSet.get('main',['spam_path'])).pop();if(sSpam){if(bWhitelist&&ids[1]==sSpam)
Item.__copyOrMoveItems(sPrimaryAccount,'INBOX','move',ids);else
if(!bWhitelist&&ids[1]!=sSpam){if(!dataSet.get('folders',[sSpam]))
dataSet.add('folders',[sSpam],{'TYPE':'M','RIGHTS':'rw','NAME':getLang('COMMON_FOLDERS::SPAM'),'ACCESS':'rwmd'});Item.__copyOrMoveItems(sPrimaryAccount,sSpam,'move',ids);}}
if(gui.notifier){if(bWhitelist){gui.notifier._value({type:'sender_whitelisted'});}else{gui.notifier._value({type:'sender_blacklisted'});}}};OldMessage.__mailviewCallback=function(message,bPrevSeen,mailInfo){if(message&&mailInfo){message.__synchronizeFlags(mailInfo[message.__id[0]][message.__id[1]][message.__id[2]]);if(!bPrevSeen&&message.hasFlag('SEEN')&&(!message.__id||GWOthers.getItem('DEFAULT_FOLDERS','drafts')!=[message.__id[0],message.__id[1]].join('/'))&&message.getConfirmAddress()){if(gui.msg_read_confirm)
gui.msg_read_confirm._destruct();switch(GWOthers.getItem('READ_CONFIRMATION','send_confirmation')||'0'){case'0':var tmp=gui._create('msg_read_confirm','frm_confirm','','',[OldMessage.__createReadingConfirmation,[message]],'CONFIRMATION::CREATE_READING_CONFIRMATION_TITLE','CONFIRMATION::CREATE_READING_CONFIRMATION');tmp._modal(false);tmp.x_btn_ok._value('COMMON::YES');tmp.x_btn_cancel._value('COMMON::NO');break;case'1':OldMessage.__createReadingConfirmation(message);}}
else
message.dispose();}
return;};OldMessage.prototype.__synchronizeFlags=function(mailInfo){this.__mailInfo=mailInfo;var datasetItems=this.__datasetItems;function testAndSet(sItemName){if(datasetItems[sItemName]!=mailInfo[sItemName]){datasetItems[sItemName]=mailInfo[sItemName];return true;}
return false;}
var bChanged=false;bChanged|=testAndSet('FLAGS');bChanged|=testAndSet('HAS_ATTACHMENT');bChanged|=testAndSet('SMIME_STATUS');bChanged|=testAndSet('PRIORITY');if(bChanged&&dataSet.get('items',this.__id))
dataSet.update('items',this.__id);};OldMessage.__redirect=function(bOK,aAddresses,id,eForm){if(bOK&&eForm&&aAddresses&&aAddresses['to'].length){var aMessageInfo={"aid":id[0],"fid":id[1],"iid":id[2]};var aResult=MailAddress.findDistribList({'to':aAddresses['to'].join(', ')});for(var sTag in aResult)
aMessageInfo[sTag]=aResult[sTag];WMItems.redirect(aMessageInfo,'dummy','',[OldMessage.__redirect_result,[eForm]]);}};OldMessage.__redirect_result=function(eForm,aError){eForm.__ok=false;if(aError){eForm.__show();if(aError[0])
gui.notifier._value({type:'alert',args:{header:'ALERTS::'+aError[0].toUpperCase(),text_plain:aError[1]}});else
gui.notifier._value({type:'alert',args:{header:'',text_plain:aError[1]}});}
else{eForm._destruct();if(gui.notifier)
gui.notifier._value({type:'message_redirected'});}};OldMessage.__createReadingConfirmation=function(oldMessage){function setMessageVariables(sText,oldMessage){var date=new IcewarpDate(oldMessage.getDate()*1000,{locale:'en'}),sdate=date.format('rfc2822'),from=oldMessage.getFrom()?oldMessage.getFrom().escapeHTML():'',to=oldMessage.getTo()?oldMessage.getTo().escapeHTML():'',subject=oldMessage.getSubject()||'';sText=sText.replace(/\n/g,"<br />").replace(/%FROM%/g,from).replace(/%TO%/g,to).replace(/%DATE%/g,sdate).replace(/%SUBJECT%/g,subject);sText=sText.replace(/%FormatDateTime ([^%]+)[^%]*%/gm,function($0,$1){return date.format($1)});return sText;}
var newMessage=new NewMessage();newMessage.sTo=oldMessage.getConfirmAddress()||oldMessage.getFrom();newMessage.sSubject=setMessageVariables(GWOthers.getItem('READ_CONFIRMATION','subject'),oldMessage);newMessage.sBody=setMessageVariables(GWOthers.getItem('READ_CONFIRMATION','text'),oldMessage);oldMessage.dispose();newMessage.send(false,'',{'read_confirmation':false,'priority':4});};OldMessage.prototype.getFrom=function(){return toString(this.__datasetItems.FROM).trim();};OldMessage.prototype.getCc=function(){return toString(this.__datasetItems.CC).trim();};OldMessage.prototype.getBcc=function(){return toString(this.__datasetItems.BCC).trim();};OldMessage.prototype.getTeamchat=function(){return toString(this.__mailInfo.TEAMCHAT).trim();};OldMessage.prototype.getComment=function(){return toString(this.__mailInfo.TEAMCHAT_COMMENT).trim();};OldMessage.prototype.getTo=function(){return toString(this.__datasetItems.TO).trim();};OldMessage.prototype.getReply=function(){if(this.__mailInfo.REPLY_TO)
return toString(this.__mailInfo.REPLY_TO).trim();else
return this.getFrom();};OldMessage.prototype.getSubject=function(){return toString(this.__datasetItems.SUBJECT)};OldMessage.prototype.getFlags=function(){return this.__datasetItems.FLAGS};OldMessage.prototype.getDate=function(){return this.__datasetItems.DATE};OldMessage.prototype.getSize=function(){return this.__datasetItems.SIZE};OldMessage.prototype.hasAttachments=function(){return(this.__mailInfo.HAS_ATTACHMENT=='true')};OldMessage.prototype.hasEmbeddedAttachments=function(){return!!this.__mailInfo.HAS_EMBEDDED_ATTACHMENT};OldMessage.prototype.getSms=function(){return toString(this.__mailInfo.SMS)};OldMessage.prototype.getBody=function(){return toString(this.__mailInfo.HTML)};OldMessage.prototype.getPriority=function(){return toString(this.__mailInfo.PRIORITY)};OldMessage.prototype.getDelay=function(){return toString(this.__mailInfo.DEFERRED_DELIVERY)};OldMessage.prototype.getBase=function(){var sBase=this.__mailInfo.BASE_URL||'';if(sBase){if(sBase.indexOf('file://')===0)
sBase='';else{if(!(/\/$/gi.test(sBase)))
sBase+='/';if(!(/^((http)|(https))\:/gi.test(sBase)))
sBase='http://'+sBase;}}
return toString(sBase);};OldMessage.prototype.isHtml=function(bReply){if(bReply)
switch(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','reply_message').toString()){case'1':return false;case'2':return true;}
return(this.getStaticFlags()&1)?true:false;};OldMessage.prototype.getAttachments=function(){return this.__mailInfo.ATTACHMENTS};OldMessage.prototype.getStaticFlags=function(){return this.__mailInfo.STATIC_FLAGS};OldMessage.prototype.getConfirmAddress=function(){return toString(this.__mailInfo.CONFIRM_ADDR)};OldMessage.prototype.copyAttachments=function(id){var result={'attachments':[]},id=id||this.__id;if(this.hasAttachments()){var aOldAttachments=this.getAttachments(),aAttachFrame,aAttachResult;for(var sAttId in aOldAttachments){aAttachFrame=aOldAttachments[sAttId]['values'];if(aAttachFrame.SMART)
continue;aAttachResult={};aAttachResult['class']='attachment';aAttachResult['fullpath']=id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2])+'/'+sAttId;for(var sTag in aAttachFrame)
aAttachResult[sTag.toLowerCase()]=aAttachFrame[sTag];result['attachments'].push({'values':aAttachResult});}}
return result;};OldMessage.prototype.hasFlag=function(sFlagName){var nFlag;if((nFlag=this.getFlags())===undefined)return false;return WMItems.hasFlag(nFlag,sFlagName);};OldMessage.prototype.setFlags=function(aFlagNames){var bUpdateFolders=false;var aFlagPairs={};for(var i in aFlagNames){if(aFlagNames[i]=='SEEN')
bUpdateFolders=true;aFlagPairs[aFlagNames[i]]=true;}
if(bUpdateFolders)
WMItems.setFlag({"aid":this.__id[0],"fid":this.__id[1],"iid":[this.__id[2]]},aFlagPairs,'items','folders');else
WMItems.setFlag({"aid":this.__id[0],"fid":this.__id[1],"iid":[this.__id[2]]},aFlagPairs,'items');};OldMessage.prototype.setAnswered=function(){if(!this.hasFlag('SEEN'))
this.setFlags(['ANSWERED','SEEN']);else
this.setFlags(['ANSWERED']);};OldMessage.prototype.setForwarded=function(){if(!this.hasFlag('SEEN'))
this.setFlags(['FORWARDED','SEEN']);else
this.setFlags(['FORWARDED']);};OldMessage.prototype.dispose=function(){dataSet.disobey(this);};OldMessage.__prefixParser=function(sSubject,sType){if(typeof sSubject=='undefined')
return'';if(GWOthers.getItem('MAIL_SETTINGS_GENERAL','classic_prefix')>0)
return sType+': '+sSubject;var aSubjectSplit=sSubject.split(':');var sLast=sType;var sLastLow=(sLast?sLast.toLowerCase():'');var nCounter=1;var aResult=[];var nInArray=count(aSubjectSplit);var nItem=0;var aParcSplit,sShort,sShortLow,nNumber,bEnd;for(var n in aSubjectSplit){if(bEnd)
aResult.push(aSubjectSplit[n].trim());else{aParcSplit=aSubjectSplit[n].split('[');sShort=aParcSplit[0].trim();sShortLow=(sShort?sShort.toLowerCase():'');nItem++;if(aParcSplit[1])
nNumber=aParcSplit[1].substr(0,aParcSplit[1].indexOf(']')).trim()*1;else
nNumber=1;if(sShort.length<2||sShort.length>3||isNaN(nNumber)||nNumber<=0||nItem==nInArray){if(sLast){if(nCounter>1)
aResult.push(sLast+'['+nCounter+']');else
aResult.push(sLast);}
aResult.push(aSubjectSplit[n].trim());bEnd=true;}
else
if(sLastLow==sShortLow)
nCounter+=nNumber;else{if(sLast){if(nCounter>1)
aResult.push(sLast+'['+nCounter+']');else
aResult.push(sLast);}
sLast=sShort;sLastLow=sShortLow;nCounter=nNumber;}}}
return aResult.join(': ');};OldMessage.prototype.__update=function(){var datasetItems=dataSet.get('items',this.__id);if(datasetItems)
this.__datasetItems=datasetItems;};OldMessage._parseRcp=function(sRcp){return MailAddress.splitEmailsAndNames(sRcp).map(function(mail){var a=mkElement('a',{style:"font-family:Helvetica, sans-serif;font-size:12px;font-weight:300;line-height:150%;color:#0088CC;text-decoration:none;",href:'mailto:'+mail.email,text:mail.email}).outerHTML;if(mail.name)
mail.name=mail.name.replace(/([\"\\])/g,'\\$1').trim();return mail.name?mail.name+' ('+a+')':a;}).join(', ');};

/* client/inc/dragndrop.js */
function cDnD(){storage.css('dragndrop');this.value;this.droper={};this.startX;this.startY;this.addoffset=5;this.old_docmove;this.old_docup;this.old_keydown;this.old_keyup;};cDnD.prototype.registr_drop=function(obj,aType){if(typeof obj!='object'||!aType)return false;this.droper[obj._pathName]=aType;return true;};cDnD.prototype.create_drag=function(sHtml,aData,x,y,bCtrl){var me=this;if(typeof aData.type!='string')return;aData.x=x;aData.y=y;if(!this.eDiv)
this.eDiv=mkElement('div',{id:'dnd_element'});this.eDiv.innerHTML='<div class="dnd_ico">&nbsp;</div><div class="dnd_body">'+sHtml+'</div>';if(x||gui.__X)this.eDiv.style.left=((gui.__X||x)+this.addoffset)+'px';if(y||gui.__Y)this.eDiv.style.top=((gui.__Y||y)+this.addoffset)+'px';this.value=aData;if(aData.obj){if(aData.obj._ondragstart)
aData.obj._ondragstart(this.value);if(aData.obj._ondragover)
aData.obj._ondragover(this.value);}
if(!document.getElementById('dnd_element'))
document.getElementsByTagName('body')[0].appendChild(this.eDiv);if(bCtrl){this.__forceCtrl=true;addcss(this.eDiv,'ctrl');}
else{this.__forceCtrl=false;this.__keydown=function(e){var e=e||window.event;if(me.eDiv&&e.ctrlKey)
addcss(me.eDiv,'ctrl');me.value.ctrl=me.__forceCtrl||e.ctrlKey;};gui._obeyEvent('keydown',[this,'__keydown']);this.__keyup=function(e){var e=e||window.event;if(me.eDiv&&!e.ctrlKey)
removecss(me.eDiv,'ctrl');me.value.ctrl=me.__forceCtrl||e.ctrlKey;};gui._obeyEvent('keyup',[this,'__keyup']);}
this.__mousemove=function(e){if(window.getSelection)
window.getSelection().removeAllRanges();else
if(document.selection)
document.selection.empty();me.value.x=e.clientX;me.value.y=e.clientY;me.value.ctrl=me.__forceCtrl||e.ctrlKey;me.eDiv.style.left=(e.clientX+me.addoffset)+'px';me.eDiv.style.top=(e.clientY+me.addoffset)+'px';};gui._obeyEvent('mousemove',[this,'__mousemove']);this.__mouseup=function(e){me.value.x=e.clientX;me.value.y=e.clientY;me.value.ctrl=me.__forceCtrl||e.ctrlKey;me.remove_drag();};gui._obeyEvent('mouseup',[this,'__mouseup']);this.active_drop(1);};cDnD.prototype.active_drop=function(b){this.remove_masks();var me=this;for(var i in this.droper){if(inArray(this.droper[i],this.value.type)>-1){try{var mask='',obj=window;i.split('.').forEach(function(part){obj=obj[part];});if(obj._active_dropzone&&(mask=obj._active_dropzone(b?this.value:undefined))===false)
continue;if(b){if(!mask||!mask.parentNode){mask=mkElement('div',{className:'dropzone'});obj._main.appendChild(mask);}
this.__aMaskDivs.push(mask);mask.obj=obj;mask.onmouseout=function(e){if(this.obj._ondragout)
this.obj._ondragout(me.value);};mask.onmousemove=function(e){if(this.obj._ondragover)
this.style.cursor=this.obj._ondragover(me.value)==false?'not-allowed':'';};mask.onmouseup=function(e){me.value.target=this.obj;if(this.obj._ondrop)
this.obj._ondrop(me.value);if(this.obj._ondragout)
this.obj._ondragout(me.value);};}}
catch(e){delete this.droper[i];}}}};cDnD.prototype.remove_drag=function(){if(this.eDiv){gui._disobeyEvent('mousemove',[this,'__mousemove']);gui._disobeyEvent('mouseup',[this,'__mouseup']);gui._disobeyEvent('keydown',[this,'__keydown']);gui._disobeyEvent('keyup',[this,'__keyup']);try{this.eDiv.parentNode.removeChild(this.eDiv);}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}
this.active_drop();if(this.value&&this.value.obj&&this.value.obj._ondragend){this.value.obj._ondragend(this.value);}
this.value='';}
this.eDiv=null;};cDnD.prototype.remove_masks=function(){if(this.__aMaskDivs&&this.__aMaskDivs.length)
for(var i=this.__aMaskDivs.length-1;i>=0;i--)
if(this.__aMaskDivs[i]&&this.__aMaskDivs[i].parentNode)
this.__aMaskDivs[i].parentNode.removeChild(this.__aMaskDivs[i]);this.__aMaskDivs=[];};

/* client/inc/dropzone.js */
_me=dropzone.prototype;function dropzone(){};_me.__constructor=function(){this.__dropzones=[];this._add_destructor('__remove_dropzone');};_me._dropzone=function(eAnchor,body,css,callback){if(window.FormData){this.__dropzones.push({anchor:(eAnchor||this._main),body:body,css:css,callback:callback});if(this.__dropzones.length==1)
gui.frm_main._registr_dropzone(this);}};_me.__remove_dropzone=function(eAnchor){if(eAnchor)
this.__dropzones=this.__dropzones.filter(function(z){return z.anchor!==eAnchor;});else
this.__dropzones=[];if(!this.__dropzones.length)
gui.frm_main._remove_dropzone(this);};_me._showDropZone=function(e){for(var z,i=this.__dropzones.length-1;i>=0;i--){z=this.__dropzones[i];if(!z.anchor.parentNode){this.__remove_dropzone(z.anchor);continue;}
if(e&&(!this._ondropzone||this._ondropzone(e)!==false)){z.zone=mkElement('div',{className:'dropzone'});if(z.css)
addcss(z.zone,z.css);var tmpBody=z.body||'<div class="info"><h2>'+getLang('ATTACHMENT::DROPZONE')+'</h2></div>';if(Is.String(tmpBody))
z.zone.innerHTML=tmpBody;else
z.zone.innerHTML=tmpBody();var elm=mkElement('div',{className:'mask'});elm.addEventListener("dragenter",function(e){e.preventDefault();e.stopPropagation();addcss(z.zone,'active');},false);elm.addEventListener("dragleave",function(e){e.preventDefault();e.stopPropagation();removecss(z.zone,'active');},false);elm.addEventListener("drop",function(e){e.preventDefault();e.stopPropagation();e.cancelBubble=true;var files=[];for(var i=0;i<e.dataTransfer.files.length;i++){var file=e.dataTransfer.files[i];(file.size||file.type)&&files.push(file);};if(files.length&&this.__ondropfile)
this.__ondropfile(files);else
gui.notifier&&gui.notifier._value({type:'empty_file'});return false;}.bind(this),false);z.zone.appendChild(elm);z.anchor.appendChild(z.zone);z.callback&&z.callback(z.zone);}
else
if(z.zone){if(z.zone.parentNode)
z.zone.parentNode.removeChild(z.zone);delete z.zone;}}};

/* client/inc/frm_account.js */
_me=frm_account.prototype;function frm_account(){};_me.__constructor=function(aResponse,sAccountID,aData){var me=this;this._modal(true);this._dockable(false);this._resizable(false);this.__sAccountID=sAccountID;this.__aResponse=aResponse;if(Is.Defined(sAccountID)){this._title('POPUP_ACCOUNTS::EDIT_ACCOUNT');this._size(400,405,true);this._draw('frm_account','main');}else{this._title('POPUP_ACCOUNTS::ADD_ACCOUNT');this._size(400,435,true);this._draw('frm_account','main',{add:true,sPrimaryAccount:"!^"+sPrimaryAccount.quoteMeta()+"$"});this.SENTFOLDER._value(GWOthers.getItem('DEFAULT_FOLDERS','sent'));this.TRASHFOLDER._value(GWOthers.getItem('DEFAULT_FOLDERS','trash'));}
this.x_btn_ok._onclick=function(){this._disabled(true);me._title('POPUP_ACCOUNTS::VALIDATING');setTimeout('try{'+me._pathName+'.__validate()}catch(e){gui._REQUEST_VARS.debug && console.log(this._name||false,e);}',10);}
if(Is.Defined(sAccountID)&&Is.Defined(aData))
this._loadSettings(aData);else
this._setDefaultPort();if(!Is.Defined(sAccountID))this.EMAIL._onerror=function(isError){me.__bIsInputEmailValid=!isError;me.__enableOrDisableOK();};this.USERNAME._onerror=function(isError){me.__bIsInputUsernameValid=!isError;me.__enableOrDisableOK();};this.PROTOCOL._onchange=function(){me._setDefaultPort();}
this.SERVER._onerror=function(isError){me.__bIsInputServerValid=!isError;me.__enableOrDisableOK();}
this.PORT._onerror=function(isError){me.__bIsInputPortValid=!isError;me.__enableOrDisableOK();}
this.PASSWORD._onerror=function(isError){me.__bIsInputPassValid=!isError;me.__enableOrDisableOK();}
this.__bIsInputEmailValid=(!sAccountID)?this.EMAIL.__check():true;this.__bIsInputUsernameValid=this.USERNAME.__check();this.__bIsInputServerValid=this.SERVER.__check();this.__bIsInputPortValid=this.PORT.__check();this.__bIsInputPassValid=sAccountID?true:false;this.__enableOrDisableOK();};_me.__validate=function(){this._create('loading','obj_loader');this.loading._value(getLang('popup_accounts::validating'));WMAccounts.test({EMAIL:this.__sAccountID||this.EMAIL._value(),USERNAME:this.USERNAME._value(),PROTOCOL:this.PROTOCOL._value(),SERVER:this.SERVER._value(),PORT:this.PORT._value(),PASSWORD:this.PASSWORD._value(),SENTFOLDER:this.SENTFOLDER._value(),TRASHFOLDER:this.TRASHFOLDER._value(),DESCRIPTION:this.DESCRIPTION._value(),},[this,'__validateResponse']);};_me.__validateResponse=function(aData){if(this&&!this._destructed)
if(aData===false){this.loading._destruct();gui.notifier._value({type:'alert',args:{header:'',text:'POPUP_ACCOUNTS::INVALID'}});if(Is.Defined(this.__sAccountID))
this._title('POPUP_ACCOUNTS::EDIT_ACCOUNT');else
this._title('POPUP_ACCOUNTS::ADD_ACCOUNT');this.x_btn_ok._disabled(0);}
else{var aValues={};storeDataFromForm(this,aValues);executeCallbackFunction(this.__aResponse,aValues,this.__sAccountID);this._destruct();}};_me.__enableOrDisableOK=function(){var b=!(this.__bIsInputEmailValid&&this.__bIsInputUsernameValid&&this.__bIsInputServerValid&&this.__bIsInputPortValid&&this.__bIsInputPassValid);this.x_btn_ok._disabled(b);};_me._setDefaultPort=function(){switch(this.PROTOCOL._value()){case'imap':this.PORT._value(143);this.PORT.__check();break;case'pop3':this.PORT._value(110);this.PORT.__check();break;}};_me._loadSettings=function(aValues){aValues.SENTFOLDER=aValues.SENTFOLDER||GWOthers.getItem('DEFAULT_FOLDERS','sent');aValues.TRASHFOLDER=aValues.TRASHFOLDER||GWOthers.getItem('DEFAULT_FOLDERS','trash');loadDataIntoForm(this,aValues);};

/* client/inc/frm_account_oauth_settings.js */
_me=frm_account_oauth_settings.prototype;function frm_account_oauth_settings(){};_me.__constructor=function(){var me=this;this.oauth.__sortColumn='expires';this.oauth._addColumns({clientname:{title:"OAUTH::CLIENT_NAME",width:100},clientdescription:{title:"OAUTH::CLIENT_DESCRIPTION",width:50,mode:'%'},scopes:{title:"OAUTH::SCOPES",width:100},description:{title:"OAUTH::DESCRIPTION",width:50,mode:'%'},created:{title:"OAUTH::CREATED",width:150}});this.oauth._oncontext=function(e,elm,arg,sLineId){if(typeof sLineId==='undefined'){return;}
gui._create("cmenu","obj_context",'','',me);var aMenu=[{title:'ATTACHMENT::REMOVE',arg:[me,'__deleteItems',[[sLineId]]]}];gui.cmenu._fill(aMenu);gui.cmenu._place(e.clientX,e.clientY);};this.remove._onclick=function(){me.__deleteItems(me.oauth._value());};this.__fillDataGrid();};_me.__deleteItems=function(aIDs){var length=aIDs.length;if(length){this.remove._disabled(true);}
for(var i in aIDs){icewarpapi.send({commandname:'removeoauthauthorization',commandparams:{authorizationid:aIDs[i]}},{success:function(){if(!--length){this.remove._disabled(false);this.__fillDataGrid();}},error:function(error){gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::'+error}});if(!--length){this.remove._disabled(false);this.__fillDataGrid();}},context:this});}};_me.__fillDataGrid=function(){icewarpapi.send({commandname:'getoauthauthorizations'},{success:function(response){if(response){var aData={},items=Is.Array(response.item)?response.item:[response.item];for(var i in items){if(items.hasOwnProperty(i)){items[i].scopes=Is.Array(items[i].scopes.item)?items[i].scopes.item.join(', '):items[i].scopes.item;items[i].description=items[i].description||'';items[i].created=new IcewarpDate(items[i].created*1000).format('L LT');aData[items[i].id]={id:items[i].id,data:items[i]};}}
this.oauth._serverSort(aData);}},error:function(error){gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::'+error}});},context:this});};

/* client/inc/frm_add_folder.js */
_me=frm_add_folder.prototype;function frm_add_folder(){};_me.__constructor=function(sAccountID,sFolderID,aHandler,bOneAccount){this._modal(true);var me=this;if(!Is.Defined(sAccountID))return;this._title('FORM_FOLDERS::CREATE_NEW_FOLDER');this._size(300,500,true);this._draw('frm_add_folder','main');this.input_name._restrict('![/\\\\:\?\"\<\>\|\~]+','','^.{1,255}$');this.x_btn_ok._disabled(true);this.x_btn_ok._tabIndex();this.x_btn_cancel._tabIndex();function test(){var isError=!me.input_name.__check();me.x_btn_ok._disabled(isError);};this.select_type._onchange=function(){test();};this.input_name._onerror=function(){test();};this.input_name._onsubmit=function(){test();if(!me.x_btn_ok._disabled())
me.x_btn_ok._onclick();};if(sFolderID=='__@@VIRTUAL@@__/__@@EVENTS@@__'){var aCalendars=dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS'],true)||{};for(var i in aCalendars){if(aCalendars[i][0]){sFolderID=i;break;}}}
this.tree_folder._filter_rights('kl');if(bOneAccount){this.tree_folder.sFilterAccountId=sAccountID;}
this.tree_folder._fill();var sDefaultType='M';if(sFolderID&&(sDefaultType=WMFolders.getType([sAccountID,sFolderID]))&&WMFolders.getRights([sAccountID,sFolderID],'write')){if(sDefaultType=='Y'||sDefaultType=='I'){this.tree_folder._disabled(true);if(sDefaultType=='I')
sFolderID=Path.basedir(sFolderID);else
sDefaultType='I';}
else
if(sDefaultType=='M'&&dataSet.get('folders',[sAccountID,sFolderID,'RSS']))
sDefaultType='R';}
else
if(gui.frm_main.bar.tree.folders){sFolderID='';var aFilter=gui.frm_main.bar.tree.folders._sFilterFolderType||[];if(aFilter['E'])
sDefaultType='E';else
if(aFilter['C'])
sDefaultType='C';else
if(aFilter['F'])
sDefaultType='F';else
if(aFilter['T'])
sDefaultType='T';else
if(aFilter['N'])
sDefaultType='N';}
if(!this.tree_folder._setActive(sAccountID+(sFolderID?'/'+sFolderID:'')))
this.tree_folder._setActive(sAccountID);if(sDefaultType=='Y'||sDefaultType=='I'){this.select_type._fill({IU:getLang('CHAT::ROOM_PUBLIC'),IP:getLang('CHAT::ROOM_PRIVATE')});this.select_type._value('IU');}
else{var aFill={M:getLang('FOLDER_TYPES::MAIL')},Typ='M';if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');if(!dgw||dgw.indexOf('c')<0){aFill.C=getLang('FOLDER_TYPES::CONTACT');Typ=Typ||'C';}
if(!dgw||dgw.indexOf('e')<0){aFill.E=getLang('FOLDER_TYPES::EVENT');Typ=Typ||'E';}
if(!dgw||dgw.indexOf('j')<0){aFill.J=getLang('FOLDER_TYPES::JOURNAL');Typ=Typ||'J';}
if(!dgw||dgw.indexOf('n')<0){aFill.N=getLang('FOLDER_TYPES::NOTE');Typ=Typ||'N';}
if(!dgw||dgw.indexOf('t')<0){aFill.T=getLang('FOLDER_TYPES::TASK');Typ=Typ||'T';}
if(!dgw||dgw.indexOf('f')<0){aFill.F=getLang('FOLDER_TYPES::FILE');Typ=Typ||'F';}
if(!dgw||dgw.indexOf('r')<0){aFill.R=getLang('FOLDER_TYPES::RSS');Typ=Typ||'R';}}
this.select_type._fill(aFill);this.select_type._value(sDefaultType&&"MRCEJNTF".indexOf(sDefaultType)>-1?sDefaultType:Typ);}
this.x_btn_ok._onclick=function(){var aPath=Path.split(me.tree_folder.__activeNode),sAccountName=aPath[0],sFolderName=aPath[1],aFolders=dataSet.get('folders',[sAccountName]);test();if(this._disabled())
return false;if(sFolderName&&!aFolders[sFolderName]){gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::CREATE_ERROR'}});return;}
sFolderName=((sFolderName)?sFolderName+'/':'')+me.input_name._value().trim();var bFound=false;for(var f in aFolders)
if(f.toLowerCase()==sFolderName.toLowerCase()){bFound=true;break;}
if(sFolderName&&!bFound){var sFolderType=me.select_type._value(),bPrivate=0;if(sFolderType=='R'){var frm=gui._create('add_rss','frm_change_channel','','',sAccountName,sFolderName);frm._modal(true);me._destruct();return;}
else
if(sFolderType=='IU')
sFolderType='I';else
if(sFolderType=='IP'){sFolderType='I';bPrivate=1;}
me.__hide();WMFolders.add({'name':sFolderName,'type':sFolderType,'aid':sAccountName,'private':bPrivate},'folders','',[function(){if(aHandler){var arg=[].slice.call(arguments);arg.unshift(aHandler);executeCallbackFunction.apply(null,arg);}
me._destruct();}],[function(){gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::CREATE_ERROR'}});me.__show();}]);}
else
gui._create('alert','frm_alert','','',[function(){if(me.input_name)me.input_name._setRange(0,me.input_name._value().length);}],'','ALERTS::FOLDER_EXIST',[Path.basename(sFolderName).escapeHTML()]);};};

/* client/inc/frm_addaddress.js */
_me=frm_addaddress.prototype;function frm_addaddress(){};_me.__constructor=function(aOnPopupCloseResponse,aTabsNames,aTabsValues,sPreselect,bDistrList,bSwitch,bNoShared,bIsModal)
{var me=this;this._modal(bIsModal);this._distrList=bDistrList;this._title('SELECT_RECIPIENTS::SELECT_EMAILS');this._defaultSize(-1,-1,660,620);this._draw('frm_addaddress','main',{shared:!this._phoneList});this.__aData={'__@@ADDRESSBOOK@@__':getLang('ADDRESS_BOOK::ADDRESS_BOOK')};if(!this._phoneList&&!bNoShared)
this.__aData['__@@SHARED@@__']=getLang('ATTENDEES::SHARED');this.__aData['*']=getLang('COMPOSE::SELECT_C');if(sPrimaryAccountCHAT&&!this._phoneList)
this.__aData['**']=getLang('COMPOSE::SELECT_I');var sResourcesFolderName=dataSet.get('main',['resources_path']);if(Is.Defined(sResourcesFolderName)&&WMFolders.getType({aid:sPrimaryAccount,fid:sResourcesFolderName})=='C'){this.__aData[sResourcesFolderName]=sResourcesFolderName;}
switch(bSwitch){case 2:this._distrList=bDistrList!==false?true:false;this._sharedList=2;this._activeFolder="__@@SHARED@@__";break;case 3:this._sharedList=3;this._activeFolder="__@@SHARED@@__";break;case 4:if(this.__aData[sResourcesFolderName])
this._activeFolder=sResourcesFolderName;break;default:if(bSwitch)
this._phoneList=bSwitch;var f=GWOthers.getItem('DEFAULT_FOLDERS','ab');if(f!='__@@ADDRESSBOOK@@__'&&(f=Path.split(f))&&f[1]&&WMFolders.getType(f)=='C')
this._activeFolder=f[1];else
this._activeFolder="__@@ADDRESSBOOK@@__";}
this.__selected=sPreselect||'';var obj={input:[]};for(var i in aTabsNames)
obj.input.push({name:i,label:aTabsNames[i]});this._draw('frm_addaddress_line','right',obj);this.x_btn_ok._tabIndex();this.x_btn_cancel._tabIndex();for(var i in aTabsNames){if(!this.__selected.toString())this.__selected=i;this['button_'+i]._onclick=function(){var n=this._name.replace('button_','');if(me.__selected!=n){removecss(me['button_'+me.__selected]._main,'color1');removecss(me['input_'+me.__selected]._main,'active');addcss(me['button_'+n]._main,'color1');addcss(me['input_'+n]._main,'active');me.__selected=n;}
me.__add();};this['input_'+i]._onfocus=function(){var n=this._name.replace('input_','');if(me.__selected!=n){removecss(me['button_'+me.__selected]._main,'color1');removecss(me['input_'+me.__selected]._main,'active');addcss(me['button_'+n]._main,'color1');addcss(me['input_'+n]._main,'active');me.__selected=n;}};if(aTabsValues&&aTabsValues[i])
this['input_'+i]._value(MailAddress.splitEmails(aTabsValues[i]).join(', '));if(i==this.__selected){addcss(this['button_'+i]._main,'color1');addcss(this['input_'+i]._main,'active');}
this['input_'+i]._onchange=this['input_'+i]._onkeyup=function(){check_inp();};}
me.__ok=false;this.x_btn_ok._disabled(true);this.x_btn_ok._onclick=function(){me.__ok=true;me._destruct();};this._onclose=function(){if(typeof aOnPopupCloseResponse!='undefined'){var aReturnVars={};for(var i in aTabsNames)
aReturnVars[i]=MailAddress.splitEmails(me['input_'+i]._value());pushParameterToCallback(aOnPopupCloseResponse,me);executeCallbackFunction(aOnPopupCloseResponse,me.__ok,aReturnVars);}
return true;};var check_inp=function(sName){var b=true;for(var i in aTabsNames)
if(me['input_'+i]._value()){b=false;break;}
me.x_btn_ok._disabled(b);};check_inp();this.grid._cookiesEnabled=false;this.grid._default_columns=function(){if(me._phoneList)
return{'LABEL':{"title":'DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS',"width":50,encode:true,mode:'%','arg':{'sort':'asc'}},'PHONE':{"title":'DATAGRID_ITEMS_VIEW::LCTPHNMOBILE',"width":50,mode:'%',encode:true},'COMPANY':{"title":'DATAGRID_ITEMS_VIEW::ITMCOMPANY',"width":150,encode:true,'arg':{'sort':'asc'}},'DEPARTMENT':{"title":'DATAGRID_ITEMS_VIEW::ITMDEPARTMENT',"width":150,encode:true,'arg':{'sort':'asc'}}};if(me._activeFolder=='__@@SHARED@@__')
return{'LABEL':{"title":'DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS',"width":50,encode:true,mode:'%','arg':{'sort':'asc'}},'EMAIL':{"title":'DATAGRID_ITEMS_VIEW::CONTACT_EMAIL',"width":50,mode:'%',encode:true,'arg':{'sort':'asc'}}};else
return{'LABEL':{"title":'DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS',"width":50,encode:true,mode:'%','arg':{'sort':'asc'}},'EMAIL':{"title":'DATAGRID_ITEMS_VIEW::CONTACT_EMAIL',"width":50,mode:'%',encode:true},'COMPANY':{"title":'DATAGRID_ITEMS_VIEW::ITMCOMPANY',"width":150,'arg':{'sort':'asc'},encode:true},'DEPARTMENT':{"title":'DATAGRID_ITEMS_VIEW::ITMDEPARTMENT',"width":150,'arg':{'sort':'asc'},encode:true}};};this.grid._default_values=function(){if(me._phoneList)
return['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTPHNMOBILE','ITMCOMPANY','ITMDEPARTMENT'];if(me._activeFolder=='__@@SHARED@@__')
return['ITMTITLE','LCTEMAIL1','FLAGS','ITMCOMPANY'];else
return['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTTYPE','ITMCOMPANY','ITMDEPARTMENT'];};this.grid._serverOrder=function(sColumn,iSortType){var sSort=iSortType?'desc':'asc';if(!me._phoneList&&me._activeFolder=='__@@SHARED@@__'){if(sColumn=='LABEL')
return'ITMTITLE '+sSort+', LCTEMAIL1 asc';else
return'LCTEMAIL1 '+sSort+', ITMTITLE asc';}
else{switch(sColumn){case'COMPANY':return'ITMCOMPANY '+sSort+', ITMDEPARTMENT asc, ITMFIRSTNAME asc, ITMMIDDLENAME asc, ITMSURNAME asc';case'DEPARTMENT':return'ITMDEPARTMENT '+sSort+', ITMCOMPANY asc, ITMFIRSTNAME asc, ITMMIDDLENAME asc, ITMSURNAME asc';default:return(GWOthers.getItem('RESTRICTIONS','sortstring')=='1'?'ITMSORTSTRING '+sSort+',':'')+'ITMCLASSIFYAS '+sSort+', ITMFIRSTNAME '+sSort+', ITMMIDDLENAME '+sSort+', ITMSURNAME '+sSort+(me._phoneList?', LCTPHNMOBILE asc':'');}}};this.grid._prepareBody=function(aItems,sFolType){var aResult={},sPrefix,sName,sFullName,sCompany,aRow,sEmail;for(var sItId in aItems)
{if(aItems[sItId]['FLAGS']==4){if(me._activeFolder=='__@@SHARED@@__'&&aItems[sItId].LCTEMAIL1=='anyone'&&!aItems[sItId].ITMTITLE)
aItems[sItId].ITMTITLE=getLang('SHARING::ANONYMOUS');sName=aItems[sItId].ITMTITLE;aResult[sItId]={"id":sItId,"data":{'LABEL':[sName,sName],'EMAIL':aItems[sItId].LCTEMAIL1,'COMPANY':aItems[sItId].ITMCOMPANY,'DEPARTMENT':aItems[sItId].ITMDEPARTMENT},"arg":{'aid':aItems[sItId]['aid'],'fid':aItems[sItId]['fid'],'iid':sItId}};}
else
if(aItems[sItId]['ITMCLASS']=='L'){if(me._distrList){sPrefix='';sName=aItems[sItId]['ITMCLASSIFYAS']||aItems[sItId]['ITMTITLE']||'';if(aItems[sItId].aid!=sPrimaryAccount||sName.indexOf('::')>=0)
sPrefix=aItems[sItId].aid+'::'+aItems[sItId].fid+'::';else
if(aItems[sItId].fid!=Mapping.getDefaultFolderForGWType('C')&&aItems[sItId].fid!="__@@ADDRESSBOOK@@__")
sPrefix=aItems[sItId].fid+'::';aResult[sItId]={"id":sItId,"data":{'LABEL':'['+sPrefix+sName+']','EMAIL':'','COMPANY':aItems[sItId].ITMCOMPANY,'DEPARTMENT':aItems[sItId].ITMDEPARTMENT},"arg":{'aid':aItems[sItId]['aid'],'fid':aItems[sItId]['fid'],'iid':sItId}};}}
else{if(!aItems[sItId]['ITMCLASSIFYAS']){sFullName='';var aFullNameParts=['ITMTITLE','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX'];for(var n in aFullNameParts)
if(aItems[sItId][aFullNameParts[n]])
sFullName+=aItems[sItId][aFullNameParts[n]]+' ';sFullName.trim();}
else
sFullName=aItems[sItId]['ITMCLASSIFYAS'];sName=sFullName;aRow={};sCompany=aItems[sItId].ITMCOMPANY;if(me._phoneList){if(Is.Defined(aItems[sItId]['LCTPHNMOBILE'])){aRow={'LABEL':[sName,sFullName],'PHONE':[aItems[sItId]['LCTPHNMOBILE']],'COMPANY':sCompany,'DEPARTMENT':aItems[sItId].ITMDEPARTMENT};aResult[sItId]={"id":sItId,"data":aRow,"arg":{'aid':aItems[sItId]['aid'],'fid':aItems[sItId]['fid'],'iid':sItId,'phone':aItems[sItId]['LCTPHNMOBILE']}};}}
else{for(var i=1;i<4;i++)
if(Is.Defined(aItems[sItId]['LCTEMAIL'+i])){sEmail=aItems[sItId]['LCTEMAIL'+i];aRow={'LABEL':[sName,sFullName],'EMAIL':[sEmail,aItems[sItId]['LCTEMAIL'+i]],'COMPANY':sCompany,'DEPARTMENT':aItems[sItId].ITMDEPARTMENT};aResult[sItId+'#'+i]={"id":sItId+'#'+i,"data":aRow,"arg":{'aid':aItems[sItId]['aid'],'fid':aItems[sItId]['fid'],'iid':sItId}};}}}}
return aResult;};this.grid._onclick=function(e){if(e.type=='keydown'&&e.keyCode==13){me.__add();me.search._focus();me.search._select();}};this.grid._ondblclick=function(e,elm,col,row){if(row){me.__add();if(me.search._value().length>0)
me.search._setRange(0,me.search._value().length);}};this.grid._onkeypress=function(e){var s=String.fromCharCode(e.charCode);if(s&&(s=s.trim())&&!/[\x00-\x1F]/.test(s)){me.search._value(s);me.search._focus(true);}};this.grid._oncontext=function(e,elm,arg){if(arg&&arg.fid!='__@@SHARED@@__'&&arg.iid){var id=[arg['aid'],arg['fid'],arg['iid']];var menu=gui._create('context','obj_context');menu._place(e.clientX,e.clientY);menu._fill([{"title":'POPUP_ITEMS::EDIT','arg':[Item.openwindow,[id,null,null,dataSet.get(this._listener_data,[arg['aid'],arg['fid'],arg['iid'],'ITMCLASS'])=='L'?'L':'C']]}]);menu._onclick=function(e,elm,id,arg){if(!arg)return;executeCallbackFunction(arg);};}};this.grid._listen_data('contacts_'+this._pathName,'',true);switch(this._activeFolder){case'__@@SHARED@@__':case'__@@ADDRESSBOOK@@__':this.__changeFolder('',this._activeFolder);break;default:this.__changeFolder(sPrimaryAccount,this._activeFolder);}
this.select._value(this._activeFolder);this.select._onbeforechange=function(sOld,sNew){var sFolder;if(sNew=='*'){if(me.frm_select_folder&&!me.frm_select_folder._destructed)
me.frm_select_folder._destruct();if(me._activeFolder!='__@@SHARED@@__'&&WMFolders.getType([sPrimaryAccount,me._activeFolder])=='C')
sFolder=me._activeFolder;else
sFolder=Mapping.getDefaultFolderForGWType('C');me.frm_select_folder=gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',sPrimaryAccount,sFolder,[me,'__changeFolder'],true,true,'C','',true);return false;}
else
if(sNew=='**'){if(me.frm_select_folder&&!me.frm_select_folder._destructed)
me.frm_select_folder._destruct();if(WMFolders.getType([sPrimaryAccount,me._activeFolder])=='I')
sFolder=me._activeFolder;else{var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}}
me.frm_select_folder=gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[me,'__addRoom'],true,true,['Y','I'],'',true);return false;}};this.select._onchange=function(){if(this._value()!='*')
me.__changeFolder('',this._value());};this.search._onsearch=function(v,s){if((me.grid._defaultfilter||'')!=me.__defaultFilter()||(me.grid._SQLsearch||'')!=(v||'')||(me.grid._SQLfulltext||'')!=(s||'')){me.grid._defaultfilter=me.__defaultFilter();me.grid._SQLsearch=v;me.grid._SQLfulltext=s;me.grid._serverSort('','','',[me,'_selectFirst']);}};};_me._selectFirst=function(){if(!this._destructed){if(this.grid&&this.grid._selectFirst()){this.grid._focus();return true;}else
if(this.search){this.search._focus();var obj=this['input_'+this.__selected];var str=obj._value();var v=this.search._value();v=v.indexOf(':')==-1?v:v.substr(v.indexOf(':')+1);if(obj&&v&&v.length>2&&v.indexOf('@')&&v.indexOf('@')!=-1&&v.indexOf('@')!=v.length-1&&/^\S+$/.test(v)&&str.indexOf(v)==-1){obj._value(str?str+', '+v:v);this.search._select();}
return false;}}};_me.__add=function(){var obj;if(!(obj=this['input_'+this.__selected]))
return;var v=this.grid._value();if(v.length){var tmp,a=[],s=obj._value()||'',sData;if(s)
a=MailAddress.splitEmails(s);for(var i in v){if(typeof(tmp=this.grid.__valueData[v[i]])!='undefined'){sData='';if(this._phoneList)
sData=MailAddress.createEmail(tmp.data.LABEL[1],tmp.data.PHONE[0]);else{if(!tmp.data.EMAIL&&typeof tmp.data.LABEL=='string')
sData=tmp.data.LABEL;else
if(typeof tmp.data.EMAIL=='string'&&tmp.data.EMAIL.indexOf('[')==0)
sData=tmp.data.EMAIL;else
sData=MailAddress.createEmail(tmp.data.LABEL[1],typeof tmp.data.EMAIL=='object'?tmp.data.EMAIL[1]:tmp.data.EMAIL);}
sData.trim();if(sData&&inArray(a,sData)<0)
a.push(sData);}}
if(a.length){var str=a.join(', ');obj._value(str);obj._setRange(str.length);}}else if(this.grid._SQLsearch&&typeof this.grid._SQLsearch=="string"){var str=this.grid._SQLsearch;var v=obj._value();str=str.indexOf(':')==-1?str:str.substr(str.indexOf(':')+1);obj._value(v?v+', '+str:str);if(str.indexOf('@')!=-1)
this.search._focus();else
obj._focus();}};_me.__defaultFilter=function(){var filter='';if(this._activeFolder=='__@@SHARED@@__'){filter="has:email1";if(+GWOthers.getItem('RESTRICTIONS','disable_anyone'))
filter+=' AND -is:anyone';if(this._sharedList==3||+GWOthers.getItem('RESTRICTIONS','disable_group_sharing'))
filter+=' AND flags:0';}
else
if(WMFolders.getType([sPrimaryAccount,this._activeFolder])=='C'){if(this._phoneList)
filter="has:mobile";else
filter="has:email";}
return filter;};_me.__changeFolder=function(sAccount,sFolder){var sResourcesFolderName=dataSet.get('main',['resources_path']),sValue,aData;this._activeFolder=sFolder;this.grid._defaultfilter=this.__defaultFilter();this.search._setFolder({aid:sAccount||sPrimaryAccount,fid:sFolder},'C');this.search._focus();aData=clone(this.__aData);if(sAccount&&sFolder){if(sFolder===sResourcesFolderName){sValue=sFolder;}else{sValue=sAccount+'/'+sFolder;aData[sValue]=sFolder;this.select._fill(aData);}
this.select._value(sValue,true);}else{this.select._fill(aData);}
this.grid._serverSort({aid:sAccount||sPrimaryAccount,fid:this._activeFolder},this._activeFolder=='__@@SHARED@@__'?'EMAIL':'LABEL','',[this,'_selectFirst'],{groupbyemail:GWOthers.getItem('MAIL_SETTINGS_GENERAL','GROUP_CONTACTS_BY_EMAIL')=='1'});};_me.__addRoom=function(sAccount,sFolder){this.select._value(sAccount+'/'+this._activeFolder,true);this.search._focus();var obj;if(!(obj=this['input_'+this.__selected]))
return;var sName=dataSet.get('folders',[sAccount,sFolder,'NAME'])||dataSet.get('folders',[sAccount,sFolder,'RELATIVE_PATH'])||'';if(sName.length){sFolder+='::'+sName;obj._value(MailAddress.appendEmail(obj._value(),'['+sFolder+']'));}};

/* client/inc/frm_addroom.js */
function frm_addroom(){};frm_addroom.prototype={__constructor:function(sAccountID,sFolderID,aHandler,bMain){this._modal(true);this._size(400,480,true);this._title('CHAT::ADD_ROOM');this.__views={'main':'frm_addroom_main','public':'frm_addroom_public','private':'frm_addroom_private'};this.__data={aid:sAccountID,fid:sFolderID,handler:aHandler};if(bMain)
this._view(!this._getGroups().length?'private':'main');else
if(!sFolderID)
this._view('main');else
if(dataSet.get('folders',[sAccountID,Path.basedir(sFolderID),'PRIVATE_ROOT'])==="true")
this._view('private');else
this._view('public');this._focus();},_getGroups:function(){var ds=dataSet.get('folders',[sPrimaryAccount]),folders=[];for(var id in ds){if(ds[id].TYPE=='Y'&&Path.basedir(id)&&!(ds[Path.basedir(id)]||{}).PRIVATE_ROOT&&ds[id].RIGHTS&&~ds[id].RIGHTS.indexOf('k')){folders.push([Path.basedir(id),id]);}}
return folders;},_final:function(aData)
{if(aData.type==='private'){aData.group='private_'+dataSet.get('main',['domain'])+'@##internalservicedomain.icewarp.com##/TeamChat';}
else
if(WMFolders.getType([sPrimaryAccount,aData.group])!=='Y'){gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::CREATE_ERROR'}});return;}
this.btn_next._disabled(true);this._create('loader','obj_loader');var sFolderName=aData.group+'/'+aData.name;WMFolders.add({'name':sFolderName,'type':'I','aid':sPrimaryAccount,'private':aData.type==='private'},'folders','',[this,'_response_handler',[aData]],[this,'_error_handler']);},_response_handler:function(aFolderInfo,aData){if(aFolderInfo){if(aData.type==='private'&&aData.members){var aDistribList=MailAddress.findDistribList({'to':aData.members});var aItemInfo={aid:aFolderInfo.aid,fid:aFolderInfo.name,xmlarray:{TO:[{VALUE:aDistribList.to}]}};if(!Is.Empty(aDistribList.distrib)){storage.library('wm_messages');aItemInfo.xmlarray.DISTRIB=wm_messages.parse_distrib(aDistribList.distrib);}
WMFolders.action(aItemInfo,'','','add_member','',[function(bOK){if(!bOK){gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::INVITE_ERROR'}});}
this._success_handler(aFolderInfo);}.bind(this)]);}
else{this._success_handler(aFolderInfo);}}
else{this._error_handler();}},_success_handler:function(aFolderInfo){this._destruct();this.__data.handler&&executeCallbackFunction(this.__data.handler,aFolderInfo);gui.frm_main._selectView({aid:aFolderInfo.aid,fid:aFolderInfo.name});gui.frm_main.bar.tree.folders.inp_search._value('');gui.frm_main.bar.tree.folders.inp_search._onkeyup({keyCode:27});gui.frm_main.bar.tree.folders.__filter='';},_error_handler:function(){this.btn_next&&this.btn_next._disabled(false);this.loader&&this.loader._destruct();if(this.main&&this.main.name)
this.main.name._select();gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::CREATE_ERROR'}});}};

/* client/inc/frm_addroom_main.js */
function frm_addroom_main(){};frm_addroom_main.prototype={__constructor:function(view){view.data={};view.title('CHAT::ADD_ROOM_TITLE');view.buttons({'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});this._getAnchor('private').onclick=function(){view.view('private');}.bind(this);var bPublic=!!view.parent._getGroups().length;if(bPublic){this._getAnchor('public').onclick=function(){view.view('public');}.bind(this);}
else
addcss(this._getAnchor('public'),'disabled');}};

/* client/inc/frm_addroom_private.js */
function frm_addroom_private(){};frm_addroom_private.prototype={__constructor:function(view){this.__aData=view.data;view.title('CHAT::ADD_ROOM_PRIVATE_CAPTION');view.buttons({'btn_next':{value:'FORM_BUTTONS::CREATE',css:'color1',disabled:true,onclick:function(){view.parent._final({type:'private',name:this.name._value().trim(),members:this.members._value()});}.bind(this)},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});this.members.btn_members._onclick=function(){this.add_address=gui._create('add_address','frm_addaddress','','',[this,'_onPopupClose'],{members:'CHAT::MEMBERS'},{members:this.members._value()},'members',true,false,true);this.add_address._modal(true);}.bind(this);this.name._restrict('![/\\\\:\?\"\<\>\|\~]+','','^.{1,255}$');this.name._onerror=function(b){view.parent.btn_next._disabled(b);};this.name._onsubmit=function(){if(this.__check())
view.parent.btn_next._onclick();};},_onPopupClose:function(bOK,aAddresses){bOK&&this.members._value(aAddresses['members'].join(', '));delete this.add_address;}};

/* client/inc/frm_addroom_public.js */
function frm_addroom_public(){};frm_addroom_public.prototype={__constructor:function(view){view.title('CHAT::ADD_ROOM_PUBLIC_CAPTION');view.buttons({'btn_next':{value:'FORM_BUTTONS::CREATE',css:'color1',disabled:true,onclick:function(){view.parent._final({type:'public',name:this.name._value().trim(),group:this.group._getDataValue()});}.bind(this)},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});var groups=view.parent._getGroups(),select=0;if(view.data.fid){for(i=groups.length;i--;){if(groups[i][1]===view.data.fid){select=i;break;}}}
this.group._fill(groups);this.group._value(select);this.name._restrict('![/\\\\:\?\"\<\>\|\~]+','','^.{1,255}$');this.name._onerror=function(b){view.parent.btn_next._disabled(b);};this.name._onsubmit=function(){if(this.__check())
view.parent.btn_next._onclick();};}};

/* client/inc/frm_alert.js */
_me=frm_alert.prototype;function frm_alert(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution){var me=this;this._size(450,150,true);this._modal(true);this._dockable(false);this._resizable(false);this._draw('frm_confirm','main');this._title(sLabel1||'ALERTS::ALERT');this.obj_label._onchange=function(elm){me._size(450,this._main.offsetHeight+110,true);};if(typeof aSubstitution=='string')
this.obj_label._value(aSubstitution);else
if(sLabel2)
this.obj_label._value(getLang(sLabel2,aSubstitution));this._create('x_btn_ok','obj_button','footer','noborder ok');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse);me._destruct();};this.x_btn_ok._focus();this._onclose=function(bClose){if(bClose&&aResponse)
if(executeCallbackFunction(aResponse)===false)
return false;return true;};};

/* client/inc/frm_alert_suppress.js */
_me=frm_alert_suppress.prototype;function frm_alert_suppress(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution){var aPath;if(sLabel2&&sLabel2.indexOf('::')){this.obj_label._value(getLang(sLabel2,aSubstitution));aPath=sLabel2.toLowerCase().split('::');}
else
return false;this._create('conceal','obj_checkbox','message','','ALERTS::SUPPRESS');this.conceal._onclick=function(e){Cookie.set(['suppressed',aPath[0],aPath[1]],this._value()?0:1);};this._size(400,this._getAnchor('message').offsetHeight+120,true);};

/* client/inc/frm_autoresponder.js */
_me=frm_autoresponder.prototype;function frm_autoresponder(){};_me.__constructor=function(){var me=this;this.x_add._onclick=function(){var s=(this._parent.x_personality._value()||'').trim();if(!s)return;var aEmail=MailAddress.splitEmailsAndNames(s);s=MailAddress.createEmail(aEmail[0].name,aEmail[0].email);if(!s)return;var old=this._parent.x_persons._value();for(var i in old)
if(old[i].person==s)return;this._parent.x_persons._add([{'person':s}]);this._parent.x_personality._value('');this._parent.x_personality._focus();};this.x_personality._onsubmit=function(){this._parent.x_add._onclick();};this.x_remove._onclick=function(){this._parent.x_persons._removeSelected();};this.u_respondbetweenfrom.input._onchange=function(){var from_date=me.u_respondbetweenfrom._value();var to_date=me.u_respondbetweento._value();if(from_date>to_date)
me.u_respondbetweento._value(from_date);};this.u_respondbetweento.input._onchange=function(){var from_date=me.u_respondbetweenfrom._value();var to_date=me.u_respondbetweento._value();if(from_date>to_date)
me.u_respondbetweenfrom._value(to_date);};this.u_respond._onchange=function(){var v=this._value(),b=false;if(v=='0')
b=true;if(v=='3')
me.u_respondperiod._disabled(false);else
me.u_respondperiod._disabled(true);me.x_subject._disabled(b);me.x_respondercontent._disabled(b);me.u_respondonlyiftome._disabled(b);me.u_respondbetweenfrom._disabled(b);me.u_respondbetweento._disabled(b);me.x_persons._disabled(b);me.x_add._disabled(b);me.x_remove._disabled(b);me.x_personality._disabled(b);}
this.u_respond._onchange();};_me._value=function(aValues){if(Is.Defined(aValues)){loadDataIntoFormOnAccess(this,aValues);this.__parseContent(aValues['VALUES']['u_respondercontent']);if(aValues['VALUES']['u_norespondfor']){var tmp=[],persons=aValues['VALUES']['u_norespondfor'].split("\n");for(var i in persons)
if(persons[i])
tmp.push({'person':'<'+persons[i]+'>'});this.x_persons._add(tmp);}
this.u_respond._onchange();}else{var aReturn={};storeDataFromForm(this,aReturn);aReturn['u_respondercontent']=this.__getContent();var arr=[],tmp=this.x_persons._value();for(var i in tmp)
if(tmp[i].person)
arr.push(tmp[i].person.trim());aReturn['u_norespondfor']=arr.join("\n").replace(/[\<\>]/g,'');return aReturn;}};_me.__parseContent=function(sContent){var aTmp=sContent.split("\n");var aRest=[];for(var i in aTmp){if(aTmp[i].substring(0,2)=='$$'&&aTmp[i].substring(aTmp[i].length-2)=='$$'){var del,nam,val;del=aTmp[i].indexOf(' ',2);nam=aTmp[i].substring(2,del);val=aTmp[i].substring(del+1,aTmp[i].length-2);switch(nam){case'setactualfrom':break;case'setsubject':this.x_subject._value(val);break;default:aRest.push(aTmp[i]);continue;}}
else
aRest.push(aTmp[i]);}
this.x_respondercontent._value(aRest.join('\n'));}
_me.__getContent=function(aValues){var s2=this.x_subject._value(),sResult='';if(s2)
sResult+='$$setsubject '+s2+'$$\n';sResult+=this.x_respondercontent._value();return sResult;}
_me._parseRespond=function(){}

/* client/inc/frm_blackwhite.js */
_me=frm_blackwhite.prototype;function frm_blackwhite(){};_me.__constructor=function(sAcc,sFol){var bWhite=true;if(sFol.indexOf('Blacklist')>-1)
bWhite=false;this._size(350,150,true);this._draw('frm_blackwhite','main');this._title('BLACKWHITE::'+(bWhite?'WHITE':'BLACK'));this._acc=sAcc;this._fol=sFol;var me=this;this.EMAIL._onerror=function(b){me.x_btn_ok._disabled(b);};this.EMAIL._restrict('.+');this.EMAIL._onsubmit=function(){me.x_btn_ok._onclick();};this.x_btn_ok._onclick=function(){var id=[sAcc,sFol],aValues={'values':{}};storeDataFromForm(me,aValues['values']);if(aValues['values']['EMAIL'])
WMItems.add(id,aValues,'','','',[me,'_listFolder']);else
me._destruct();};};_me._listFolder=function(){var aItems=dataSet.get('items');for(var sAccId in aItems)
for(var sFolId in aItems[sAccId]);if(sAccId==this._acc&&sFolId==this._fol){var aSort=Cookie.get(['views',this._acc,this._fol,'sort']);gui.frm_main.main.list._serverSort({aid:this._acc,fid:this._fol},aSort['column'],aSort['type']);}
this._destruct();};

/* client/inc/frm_categories.js */
_me=frm_categories.prototype;function frm_categories(){};_me.__constructor=function(sInitString,aResponse){this._title('TAGS::TAGS');this._size(430,500,true);this._modal(true);this._dockable(false);var me=this;this.__tags={};this._draw('frm_categories','main');this._create('x_btn_ok','obj_button','footer','ok noborder color1');this.x_btn_ok._value('FORM_BUTTONS::CLOSE');this.x_btn_ok._onclick=function(){me._destruct();};this._onclose=function(b){me._updateTags();executeCallbackFunction(aResponse,me.tags._value());return true;};if(Is.Defined(sInitString))
this._updateTags(sInitString);var aColors={'*':getLang('COLOR_LABELS::NONE'),'#E7A1A2':['','cE7A1A2'],'#F9BA89':['','cF9BA89'],'#F7DD8F':['','cF7DD8F'],'#FCFA90':['','cFCFA90'],'#78D168':['','c78D168'],'#9FDCC9':['','c9FDCC9'],'#C6D2B0':['','cC6D2B0'],'#9DB7E8':['','c9DB7E8'],'#B5A1E2':['','cB5A1E2'],'#DAAEC2':['','cDAAEC2'],'#DAD9DC':['','cDAD9DC'],'#6B7994':['','c6B7994'],'#BFBFBF':['','cBFBFBF'],'#6F6F6F':['','c6F6F6F'],'#4F4F4F':['','c4F4F4F'],'#C11A25':['','cC11A25'],'#E2620D':['','cE2620D'],'#C79930':['','cC79930'],'#B9B300':['','cB9B300'],'#368F2B':['','c368F2B'],'#329B7A':['','c329B7A'],'#778B45':['','c778B45'],'#2858A5':['','c2858A5'],'#5C3FA3':['','c5C3FA3'],'#93446B':['','c93446B']};this.pd_color._fill(aColors);this.pd_color._value('*');this.pd_color._onchange=function(v){var arg;if(me.grid._value()[0]&&(arg=me.grid._aData[me.grid._value()[0]])){var v=this._value();v=v=='*'?'':v;if(arg.TAGCOLOR!=v){if(dataSet.get('tags',[arg.arg.TAGNAME])){dataSet.add('tags',[arg.arg.TAGNAME,'TEXTCOLOR'],colors.fast_contrast(v),true);dataSet.add('tags',[arg.arg.TAGNAME,'TAGCOLOR'],v);WMItems.add([sPrimaryAccount,'__@@TAGS@@__',[arg.id]],{values:{TAGCOLOR:v,TAGNAME:arg.arg.TAGNAME}},'','','',[function(){}]);}
else
WMItems.add([sPrimaryAccount,'__@@TAGS@@__',[arg.id]],{values:{TAGCOLOR:v,TAGNAME:arg.arg.TAGNAME}},'','','',[me,'__reload']);}}};this.grid._select_single=true;this.grid.__sortColumn='TAGNAME';this.grid._addColumns({'CHECK':{"title":'',"width":20,css:'check'},'COLOR':{"title":'',"width":20,css:'color'},'TAGNAME':{"title":'TAGS::TAGS',"width":100,mode:'%',arg:{'sort':'desc'}},'TAGCOUNT':{"title":'TAGS::USED',"width":50}});this.grid.__update=function(){var aData=dataSet.get('tags','',true),aOut={};var sName='',escSQL='';for(var i in me.__tags)
if(!aData[i])
aData[i]={TAGNAME:i,TAGCOUNT:1};var search=new GlobalTools.search();if(this._SQLfilter)
escSQL=this._SQLfilter.toString().escapeXML();for(var i in aData){if(Is.String(sName=aData[i].TAGNAME)){if(escSQL){if(search.within(sName.escapeXML()).find(escSQL))
sName=search.highlight('b');else
continue;}
else
sName=sName.escapeXML();aOut[aData[i].TAGNAME]={id:aData[i].ID,css:me.__tags[aData[i].TAGNAME]?'checked':'',arg:{TAGNAME:aData[i].TAGNAME,TAGCOLOR:aData[i].TAGCOLOR},data:{COLOR:'<span '+(aData[i].TAGCOLOR?'style="background-color: '+aData[i].TAGCOLOR+'"':'')+'></span>',TAGNAME:sName,TAGCOUNT:aData[i].TAGCOUNT}};}}
this._serverSort(aOut);var v=this._value(),b=!(v&&(v=v[0])&&aOut[v]);me.pd_color._disabled(b);me.btn_edit._disabled(b);me.btn_remove._disabled(b);};this.grid._listen_data('tags');this.grid._ondblclick=function(e1,e2,arg,row,cell){if(cell!='CHECK')
me._addOrRemoveTag(arg.TAGNAME);};this.grid._onkeydown=function(e){if(e.keyCode==32)
try{var arg=this._aData[this.__value[0]].arg;if(arg)
this._ondblclick(e,'',arg);}
catch(r){return;}};this.grid._onkeypress=function(e){var s=String.fromCharCode(e.charCode);if(s&&(s=s.trim())&&!/[\x00-\x1F]/.test(s)){me.search._focus(true);me.search._value(s);}};this.grid._onclick=function(e,e2,arg,row,cell){if(cell=='CHECK')
this._ondblclick(e,e2,arg);};this.grid._onchange=function(v){var b=true;if(v&&(v=v[0])){b=false;if(!me.pd_color._value(dataSet.get('tags',[v,'TAGCOLOR'])||'*',true))
me.pd_color._value('*',true);}
else
me.pd_color._value('*',true);me.pd_color._disabled(b);me.btn_edit._disabled(b);me.btn_remove._disabled(b);};this.search._onsearch=function(){var v=this._value();if(this._parent.grid._SQLfilter!=v){this._parent.grid._SQLfilter=v;this._parent.grid.__update();me._selectFirst();}};this.search._onkeydown=function(e){if(e.keyCode==13){if(e.ctrlKey)
me.btn_add._onclick();else
this._onsearch();}
if((e.keyCode==38||e.keyCode==40||e.keyCode==13)&&me.grid._value().length&&me.grid._aData[me.grid._value()[0]])
me.grid._focus();};this.btn_add._onclick=function(){var v=me.search._value();if(v&&(v=me.tags._decode(v)[0])&&(v=v.tag)){me._addOrRemoveTag(v,true);WMItems.add([sPrimaryAccount,'__@@TAGS@@__'],{values:{TAGNAME:v}},'','','',[me,'__reload']);me.search._value('');me.search._onsearch();me.grid._value([v],true);}
me.search._focus();};this.btn_edit._onclick=function(){var arg;if(Is.Defined(me.grid._value())&&(arg=me.grid._aData[me.grid._value()[0]])){var ds=dataSet.get('tags');var frm=gui._create('edit','frm_ok_cancel');frm._modal(true);frm._resizable(false);frm._size(350,180,true);frm._title('FORM_BUTTONS::EDIT');frm._draw('frm_tags_edit','main');frm.inp_select._fill(me.pd_color.__idTable);frm.inp_select._value(arg.arg.TAGCOLOR||'*');frm.inp_name._value(arg.arg.TAGNAME);frm.inp_name._restrict('![\,]','','.+','',[function(v){return!ds[v]||ds[v].ID===arg.id;}]);frm.inp_name._onerror=function(b){frm.x_btn_ok._disabled(b);frm.inp_select._disabled(b);};frm.x_btn_ok._onclick=function(){var v=frm.inp_name._value();if(v){WMItems.add([sPrimaryAccount,'__@@TAGS@@__',[arg.id]],{values:{TAGNAME:v,TAGCOLOR:frm.inp_select._value()=='*'?'':frm.inp_select._value()}},'','','',[me,'__reload',[arg,v]]);frm._destruct();}
else
frm.inp_name._focus();};frm.inp_name._onsubmit=function(){frm.x_btn_ok._onclick()};frm.inp_name._focus();}};this.btn_remove._onclick=function(){var arg;if(Is.Defined(me.grid._value())&&(arg=me.grid._aData[me.grid._value()[0]])){if(me.__tags[arg.arg.TAGNAME])
me._addOrRemoveTag(arg.arg.TAGNAME);if(arg.id)
WMItems.remove({'aid':sPrimaryAccount,'fid':'__@@TAGS@@__','iid':[arg.id]},'','','',[me,'__reload']);else
me.grid.__update();}};this.tags._onblur=function(){me._updateTags(null,true);};this.__reload();};_me._selectFirst=function(){if(!this.grid._selectFirst()){this.search._focus();return false;}
return true;};_me.__reload=function(bOK,response,arg,v){var sNewTags;if(bOK&&arg&&arg.arg&&v!=arg.arg.TAGNAME&&this.__tags[arg.arg.TAGNAME]){delete this.__tags[arg.arg.TAGNAME];this.__tags[v]=true;sNewTags=arrayKeys(this.__tags).join(', ');this.tags._value(sNewTags);if(this._onChange){this._onChange(sNewTags);}}
gui.frm_main._loadTags();};_me._addOrRemoveTag=function(sTag,bAdd){if(sTag){if(this.__tags[sTag]){if(bAdd)return;delete this.__tags[sTag];}
else
this.__tags[sTag]=true;this.tags._value(arrayKeys(this.__tags).join(', '));this.grid.__update();}};_me._updateTags=function(sTags,bRefresh){sTags=sTags||this.tags._value();var aSplit=[],atmp=sTags.split(','),aTags={};for(var i=0,j=atmp.length;i<j;i++)
if(atmp[i]&&(atmp[i]=atmp[i].trim())){aSplit.push(atmp[i]);aTags[atmp[i]]=true;}
if(compareObj(this.__tags,aTags))
bRefresh=false;this.__tags=aTags;this.tags._value(aSplit.join(', '));if(bRefresh)
this.grid.__update();};

/* client/inc/frm_certificate.js */
_me=frm_certificate.prototype;function frm_certificate(){};_me.__constructor=function(aData,oParent){var me=this;this._resizable(false);this._size(450,450,true);this._title('CERTIFICATE::CERTIFICATE');var aOut={purposes:{},data:aData};aOut.from=IcewarpDate.utct(aData.VALIDFROM[0].VALUE).format('L LT');aOut.to=IcewarpDate.utct(aData.VALIDTO[0].VALUE).format('L LT');if(aData.PURPOSES&&aData.PURPOSES[0]&&aData.PURPOSES[0].ITEM)
for(var i in aData.PURPOSES[0].ITEM)
if(aData.PURPOSES[0].ITEM[i].VAR1&&aData.PURPOSES[0].ITEM[i].VAR1[0]&&aData.PURPOSES[0].ITEM[i].VAR1[0].VALUE=='1'&&aData.PURPOSES[0].ITEM[i].VAR3&&aData.PURPOSES[0].ITEM[i].VAR3[0]&&aData.PURPOSES[0].ITEM[i].VAR3[0].VALUE)
switch(aData.PURPOSES[0].ITEM[i].VAR3[0].VALUE){case'sslclient':aOut.purposes.SSL=true;break;case'smimeencrypt':case'smimesign':aOut.purposes.SMIME=true;break;}
this._draw('frm_certificate','main',aOut);this._create('btn_ok','obj_button','footer','noborder simple ok color1');this.btn_ok._value('FORM_BUTTONS::OK');this.btn_ok._onclick=function(){me._destruct();};if(oParent){this._create('btn_download','obj_button','footer','noborder simple download');this.btn_download._value('ATTACHMENT::DOWNLOAD');this.btn_download._onclick=function(){var v=oParent.attachments._value();if(v.length)
oParent._save(v[0]);};}
this.btn_ok._focus();};

/* client/inc/frm_change_channel.js */
_me=frm_change_channel.prototype;function frm_change_channel(){};_me.__constructor=function(sAccountID,sFolderID){var me=this;this._title('POPUP_FOLDERS::CHANGE_CHANNEL');this._size(600,400,true);var aFolder=dataSet.get('folders',[sAccountID,sFolderID]);if(aFolder&&!aFolder.RSS){me._destruct();return;}
this._draw('frm_change_channel','main');if(aFolder){this.input_channel._disabled(true);this.x_rss_add._disabled(true);this.x_rss_remove._disabled(true);this.x_btn_ok._disabled(true);this.input_channels._disabled(true);WMFolders.list({aid:sAccountID,fid:sFolderID},'','',[this,'__fill']);}
this.x_rss_add._onclick=function(){var v=this._parent.input_channel._value().trim();if(v){var aData={};if(this._parent.input_channels.__idTable)
aData=this._parent.input_channels.__idTable;aData[v]=v;this._parent.input_channels._fill(aData);this._parent.input_channels._value(v);}
this._parent.input_channel._value('');this._parent.input_channel._focus();};this.x_rss_edit._onclick=function(){var v=this._parent.input_channel._value().trim(),s=this._parent.input_channels._value();if(v&&s&&(s=s[0]))
if(this._parent.input_channels.__idTable)
delete this._parent.input_channels.__idTable[s];this._parent.x_rss_add._onclick();};this.x_rss_remove._onclick=function(){var s=this._parent.input_channels._value(),v=this._parent.input_channels.__idTable;if(s.length&&v){for(var i in s)
delete v[s[i]];this._parent.input_channels._fill(v);}};this.input_channel._onsubmit=function(){me.x_rss_add._onclick();};this.input_channels._ondblclick=function(){var s=this._value();if(s&&(s=s[0]))
this._parent.input_channel._value(s);};this.x_btn_ok._onclick=function(){var aChannels=[],v=this._parent.input_channels.__idTable;if(Is.Empty(v))
this._parent.x_rss_add._onclick();for(var i in v)
aChannels.push(i);if(!aChannels.length)
aChannels.push('NULL');if(aFolder)
WMFolders.add({'aid':sAccountID,'fid':sFolderID,'channel':aChannels,'type':'M'},'folders');else
WMFolders.add({'aid':sAccountID,'name':sFolderID,'channel':aChannels,'type':'M'},'folders');me._destruct();}};_me.__fill=function(aData){var out={},sel;for(var aid in aData)
for(var fid in aData[aid])
for(var i in aData[aid][fid].CHANNELS){if(aData[aid][fid].CHANNELS[i]=='NULL')
continue;if(!sel)sel=aData[aid][fid].CHANNELS[i];out[aData[aid][fid].CHANNELS[i]]=aData[aid][fid].CHANNELS[i];}
this.input_channel._disabled(false);this.x_rss_add._disabled(false);this.x_rss_remove._disabled(false);this.input_channels._disabled(false);if(this.input_channels&&typeof sel!='undefined'){this.input_channels._fill(out);this.input_channels._value(sel);}
this.x_btn_ok._disabled(false);};

/* client/inc/frm_changepass.js */
_me=frm_changepass.prototype;function frm_changepass(){};_me.__constructor=function(aHandler,bExpirePass){this.__aHandler=aHandler;this._draw('frm_changepass','main',{expire:bExpirePass,policy:GWOthers.getItem('PASSWORD_POLICY','enable')});if(bExpirePass){this._size(450,300+this.obj_label._main.offsetHeight,true);this._closable(false);}
else
this._size(450,262,true);this._title('SIGN_UP::PASSWORD_CHANGE');this._resizable(false);this._dockable(false);this._modal(true);var me=this;this._create('btn_ok','obj_button','footer','noborder ok color1');this.btn_ok._value('FORM_BUTTONS::OK');this.btn_ok._onclick=function(){var old_pwd=this._parent.x_old_password._value(),new_pwd=this._parent.x_new_password._value();if(!old_pwd||!new_pwd||this._parent.x_new_password_conf._value()!=new_pwd)
return;var aAccounts=dataSet.get('accounts');var tmp=auth.hashid({"username":aAccounts[sPrimaryAccount].USERNAME}),rsa=new RSAKey();rsa.setPublic(tmp.hash,'10001');accounts.add({aid:sPrimaryAccount,OLDPASSWORD:rsa.encrypt(buildURL({p:old_pwd,t:tmp.time})),PASSWORD:rsa.encrypt(buildURL({p:new_pwd,t:tmp.time}))},'','',[me,'__saveHandler']);};this.btn_ok.__check=function(){me.btn_ok._disabled(!(me.x_old_password._value()&&me.x_new_password._value()&&me.x_new_password._value()==me.x_new_password_conf._value()&&me.x_new_password._value()!=me.x_old_password._value()));};this.x_old_password._onkeyup=this.btn_ok.__check;this.x_new_password._onkeyup=this.btn_ok.__check;this.x_new_password_conf._onkeyup=this.btn_ok.__check;this.btn_ok.__check();this.x_new_password._restrict([this,'__passcheck']);this.x_new_password_conf._restrict([this,'__passcheck2']);if(this.x_policy)
this.x_policy._onclick=function(){gui._create('alert','frm_alert','','keepleft',[function(){try{me.x_new_password._setRange(0,me.x_new_password._value().length);me.x_new_password_conf._value('');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}],'SETTINGS::PASSWORD_POLICY','',me._policyString());};};_me.__passcheck=function(){var sOld=this.x_old_password._value(),sNew=this.x_new_password._value();this.btn_ok.__check();if(sNew.length&&sOld==sNew){this.x_info._value(getLang('ALERTS::NEW_PASSWORD_MATCH'));return false;}
this.x_info._value('');this.x_new_password_conf.__check();return true;};_me.__passcheck2=function(){var sNew=this.x_new_password._value(),sCon=this.x_new_password_conf._value();this.btn_ok.__check();if(sNew!=sCon){if(!this.x_info._value())
this.x_info._value(getLang('ALERTS::INVALID_CPASSWORD'));return false;}
if(!this.x_new_password._checkError.length)
this.x_info._value('');return true;};_me.__saveHandler=function(sError,sValue){var me=this;switch(sError||''){case'':this._destruct();if(gui.notifier)
gui.notifier._value({type:'password_changed'});if(this.__aHandler)
executeCallbackFunction(this.__aHandler);break;case'account_old_password':case'account_bad_password':gui._create('alert','frm_alert','','',[function(){try{me.x_old_password._setRange(0,me.x_old_password._value().length);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}],'','',getLang('ALERTS::INVALID_PASSWORD'));break;case'account_password_policy':gui._create('alert','frm_alert','','keepleft',[function(){try{me.x_new_password._setRange(0,me.x_new_password._value().length);me.x_new_password_conf._value('');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}],'ALERTS::PASSWORD_POLICY','',this._policyString());break;case'account_save_1':case'account_save_7':gui._create('alert','frm_alert','','keepleft',[function(){try{me.x_new_password._setRange(0,me.x_new_password._value().length);me.x_new_password_conf._value('');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}],'','ALERTS::ACCOUNT_PASS_FAILURE');break;case'account_save_9':gui._create('alert','frm_alert','','keepleft',[function(){try{me.x_new_password._setRange(0,me.x_new_password._value().length);me.x_new_password_conf._value('');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}],'','',getLang('ALERTS::ACCOUNT_PASS_FAILURE')+'<ul><li>'+getLang('POLICY::LATIN')+'</li><li>'+getLang('POLICY::DIACRITICS')+'</li></ul>');break;default:gui.notifier._value({type:'alert',args:{header:'',text:sError+(sValue?': '+sValue:'')}});}};_me._policyString=function(){var s,str='<ul>',aResource=dataSet.get('storage',['PASSWORD_POLICY','ITEMS',0,'VALUES']);for(var i in aResource)
if(aResource[i].VALUE>0&&(s=getLang('POLICY::'+i,[aResource[i].VALUE],2)))
str+='<li>'+s+'</li>';str+='<li>'+getLang('POLICY::LATIN')+'</li>';str+='<li>'+getLang('POLICY::DIACRITICS')+'</li>';str+='</ul>';return getLang('ALERTS::PASSWORD_REQUIREMENTS')+str;};

/* client/inc/frm_chat.js */
_me=frm_chat.prototype;function frm_chat(){};_me.__constructor=function(){var me=this;this._title('IM::IM');this.__options={history:20};this._defaultSize(-1,-1,800,500);this.__tabIndex={};this._create('tabs','obj_vtabs');this.tabs._draw('frm_chat_search','main',null,true);this.tabs._create('inp_add','obj_suggest_im','header','inp_add obj_input_100');this.tabs.inp_add._getFocusElement().setAttribute('iw-focus','false');this.tabs.inp_add.__minWidth=400;this.tabs.inp_add._placeholder(getLang('IM::ADD_PH'));this.tabs.inp_add._onsubmit=function(){if(this._value().length){var aParsed=MailAddress.splitEmailsAndNames(this._value())[0];if(aParsed&&aParsed.email&&dataSet.get('xmpp',['roster',aParsed.email])){me.__im._chat(aParsed.email);this._value('');}
else{addcss(this._main,'error');return;}}
removecss(this._main,'error');};this.tabs.inp_add._onchange=function(){if(!this._value().length)
removecss(this._main,'error');};this.tabs.inp_add._onclose=function(e){if(this._value().length){this._value('');if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}};this.tabs._getAnchor('search_close').onclick=function(){this._onresize_end();removecss(this._main,'search');this.tabs.search._value('');this.tabs.search._onsubmit();}.bind(this);this.tabs.search._placeholder(getLang('IM::SEARCH_PH'));this.tabs.search._onclose=function(e){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();this.tabs._getAnchor('search_close').onclick();}.bind(this);this.tabs.search._onsubmit=function(){if(!(this.__im&&this.__im._is_active()))
return;var tab=this._getTab(),sFrom=this._getName(tab._name),s=this.tabs.search._value();if(tab&&tab.__search!=s){tab.__search=s;dataSet.remove('xmpp',['roster',sFrom,'last_history'],true);dataSet.remove('xmpp',['roster',sFrom,'history'],true);if(tab.chat){tab.chat._clear();if(tab.chat._request)
tab.chat._request(true);}}}.bind(this);this.tabs._create('menu','obj_hmenu','main','border');this.tabs.menu.__redraw=function(sJID){var a=[],b=sJID.indexOf('~')===0,sName=me._getUserName(sJID);a.push({"text":'',tooltip:'FORM_BUTTONS::SEARCH',"arg":'search',"css":'ico img ico_search',disabled:b||!sPrimaryAccountIMHISTORY});if(currentBrowser()!=='MSIE9'&&window.sPrimaryAccountSIP&&location.protocol=='https:'&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){a.push({"text":'',tooltip:'DIAL::VIDEO',"arg":'video',"css":'ico img ico_video'},{"text":'',tooltip:'DIAL::CALL',"arg":'call',"css":'ico img ico_call'});}
a.push({"anchor":'name',css:'name'});me.tabs.menu._fill(a);var eName=me.tabs.menu._getAnchor('name');if(b)
addcss(eName,'group');else
removecss(eName,'group');eName.innerHTML=sName.escapeHTML();eName.onclick=function(e){this._onclick(e,'','','vcard');}.bind(this);};this.tabs.menu._onclick=function(e,elm,id,arg){var sJID=this._getName(this.tabs._value());switch(arg){case'call':gui.frm_main._call(sJID);break;case'video':gui.frm_main._call(sJID,true);break;case'search':addcss(this._main,'search');this.tabs.search._focus();break;case'vcard':if(sJID.indexOf('~')!==0)
gui._create('frm_im_vcard','frm_im_vcard','','',sJID,me.__im.__xmpp);break;}}.bind(this);this.__title=function(v){var v=v;if(v.indexOf('~')===0){var aTmp=dataSet.get('xmpp',['roster']),g=v.replace(/^\~/g,'');v='';for(var i in aTmp)
if(aTmp[i].group==g)
v+=v?'; '+i:i;v=v||g;}
else{var aData=dataSet.get('xmpp',['roster',v]);if(aData.name)
v=getLang('STATUS::CHAT_WITH',[MailAddress.createEmail(aData.name,v,true)]);this._getAnchor('ico').className='obj_popupico '+(aData.type?encodeURIComponent('set_'+aData.type)+' ':'');if(this.__lastStatus)
removecss(this._main,this.__lastStatus);this.__lastStatus=(aData.show?encodeURIComponent(aData.show):'offline');addcss(this._main,this.__lastStatus);}
this._title(v,true);};if((GWOthers.getItem('IM','enter_send')||0)<1){this._create('btn_send','obj_button','footer','ok noborder color1 x_btn_right simple');this.btn_send._value('COMPOSE::SEND');this.btn_send._onclick=function(){me._send();};}
if(window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1)
this._listen('sip');};_me.__update=function(sDName,aDPath){if(gui.frm_main.sip){var ds=dataSet.get('sip');if(ds&&ds.state=='online')
switch(ds.activity){case'Phoning':case'Ringing':case'Calling':if(ds.p1&&this.__tabIndex[ds.p1])
this._sip_init(ds.p1);return;}}
var sJID=this.tabs&&this.tabs.menu&&this._getName(this.tabs._value());if(sJID)
this.tabs.menu.__redraw(sJID);};_me._sip_init=function(sName){var tab;if(sName&&(tab=this.__tabIndex[sName])&&(tab=this.tabs[tab])){if(!tab.sip||tab.sip._destructed){if(this.sip)
this.sip._destruct();this.sip=tab._create('sip','obj_chat_voip','chat');}}};_me._getRecipients=function(){var aTo=[],v=this.tabs._value();if(v&&(tab=this.tabs[v])){var sTo=tab.__sJID;if(sTo.indexOf('~')===0)
aTo=this.__im._getGroupUsers(sTo);aTo=(aTo&&aTo.length)?aTo:[sTo];}
return aTo;};_me._send=function(sMessage,bConference){var tab,sTo,v=this.tabs._value(),b=sMessage||this.tabs[v].text._value();if(b.length){if(v&&this.tabs[v])
sTo=this.tabs[v].__sJID;if(gui.frm_main&&gui.frm_main.sound&&GWOthers.getItem('IM','sound_notify')>0)
gui.frm_main.sound._play('im_out');if(bConference)
this.__im._send(sTo,b+' '+dataSet.get('conference',['information','url']),true);else
if(this.__im._send(sTo,b)){if(this.tabs&&(tab=this.tabs[v])){tab.text._value('');if(tab.text.__options&&tab.text.__options.memory&&tab.text.__options.memory.set){executeCallbackFunction(tab.text.__options.memory.set,'');}}
else{dataSet.remove('xmpp',['roster',sTo,'input'],true);}}
if(this.tabs&&this.tabs[v])
this.tabs[v]._animate();}
if(this.tabs&&this.tabs[v])
this.tabs[v].text._focus(true);};_me._compose=function(sJID){var tab,me=this,tmp=this.__tabIndex[sJID.split('/').shift()];if(sJID&&tmp&&(tab=this.tabs[tmp])){addcss(tab.__eLi,'im_compose',true);try{if(tab._isActive)
addcss(this.tabs.menu._getAnchor('avatar').parentNode,'im_compose');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
setTimeout(function(){try{me._wait(sJID)}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}},10000);}};_me._wait=function(sJID){var tab,tmp=this.__tabIndex[sJID.split('/').shift()];if(sJID&&tmp&&(tab=this.tabs[tmp])){removecss(tab.__eLi,'im_compose',true);try{if(tab._isActive)
removecss(this.tabs.menu._getAnchor('avatar').parentNode,'im_compose');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}}};_me._gone=function(sJID){if(sJID){var jid=sJID.split('/').shift(),tab=this._getChat(jid);if(tab&&tab.chat)
tab.chat._notice(jid,getLang('STATUS::GONE'));}};_me._getTab=function(tab){var tab=tab||this.tabs._value();if(tab&&(tab=this.tabs[tab]))
return tab;};_me._getName=function(sTab){for(var i in this.__tabIndex)
if(this.__tabIndex[i]==sTab)
return i;return false;};_me._onresize_end=function(){var tab=this.tabs._value();if(tab&&(tab=this.tabs[tab])&&tab._wasActivated)
tab.text._focus(true);return true;};_me._ondock=function(){var css='';var unread=0;var title='';for(var sFrom in this.__tabIndex){if(dataSet.get('xmpp',['roster',sFrom,'action'])){css='event';unread++;}}
if(unread===1)
title=getLang('IM::NEW_CHAT');else
if(unread>1)
title=getLang('IM::NEW_CHATS',[unread]);else
title=getLang('IM::CHAT_TITLE');return{title:title,css:css};};_me._onundock=function(){var tab=this.tabs._value();if(tab&&(tab=this.tabs[tab])&&tab._wasActivated){tab.text._focus(true);tab.chat._scroll();}
return true;};_me._onfocus=function(bSkipFocus){var tab=this.tabs._value();if(tab&&(tab=this.tabs[tab])&&tab._isActive){var sFrom=tab.__sJID;if(Cookie.get(['im','queue',sFrom])==1){Cookie.set(['im','queue',sFrom]);var oNot=dataSet.get('xmpp',['roster',sFrom,'notification']);if(oNot){try{oNot.close();}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
dataSet.remove('xmpp',['roster',sFrom,'notification'],true);}
dataSet.remove('xmpp',['roster',sFrom,'action']);dataSet.update('main',['im']);removecss(tab.__eLi,'im_event');}
else
dataSet.remove('xmpp',['roster',sFrom,'action']);}};_me._getChat=function(sFrom){if(this.__tabIndex[sFrom]&&this.tabs[this.__tabIndex[sFrom]])
return this.tabs[this.__tabIndex[sFrom]];};_me._getUserName=function(sFrom){var sName;if(sFrom.indexOf('~')===0){sName=sFrom.replace(/^\~/g,'');if(sName=='*')
sName=getLang('IM::OTHER');else
if(sName=='~')
sName=getLang('IM::NOT_LISTED');else
if(sFrom.indexOf(';')>-1)
sName=getLang('IM::SELECTED');}
else
if(!(sName=dataSet.get('xmpp',['roster',sFrom,'name']))){sName=sFrom;if(sName.indexOf('@')>0)
sName=sName.split('@').shift();}
return sName;};_me._createChat=function(sFrom,bActive,bTop){var tab=this._getChat(sFrom);if(!tab){var me=this;var sName=this._getUserName(sFrom),isGroup=sFrom.indexOf('~')===0;tab=this.tabs._create('tab','obj_tab_close','main',isGroup?'group':'',bTop);tab._wasActivated=false;tab.__sName=sName;tab.__sJID=sFrom;tab.__search='';if(!isGroup)
dataSet.add('xmpp',['roster',sFrom,'active'],false,true);if(sPrimaryAccountGW&&!isGroup)
tab._value(sName.escapeHTML()+'<i style="background-image: url(\''+getAvatarURL(sFrom)+'\')"></i><u><span></span><span></span><span></span></u>',true);else
tab._value(sName.escapeHTML()+'<u><span></span><span></span><span></span></u>',true);tab._animate=function(){removecss(this.__eLi,'im_compose');if(me._docked||!this._isActive||(this._isActive&&!this.text._hasFocus())){addcss(this.__eLi,'im_event');if(Cookie.get(['im','queue',this.__sJID])!=1){dataSet.add('xmpp',['roster',this.__sJID,'action'],'msg');Cookie.set(['im','queue',this.__sJID],1);dataSet.update('main',['im']);}}
else
dataSet.remove('xmpp',['roster',this.__sJID,'action']);if(this.__eLi.parentNode.firstChild!==this.__eLi&&!this.__animation){if('transition'in document.body.style){var offset=getSize(this.__eLi).y-getSize(this.__eLi.parentElement).y+this.__eLi.parentElement.scrollTop,height=this.__eLi.offsetHeight;this.__animation={etop:mkElement('li',{className:'anim top'})};this.__eLi.parentElement.insertBefore(this.__animation.etop,this.__eLi.parentNode.firstChild);if(this.__eLi.nextSibling){this.__animation.ebottom=mkElement('li',{className:'anim bottom'});this.__eLi.parentNode.insertBefore(this.__animation.ebottom,this.__eLi.nextSibling);}
var iDuration=Math.ceil(Math.min(500,offset*1.5));this.__eLi.style.transitionDuration='0ms';this.__eLi.style.top=offset+'px';addcss(this.__eLi,'animate');this.__animation.interval=setTimeout(function(){if(!this.__eLi)return;this.__eLi.style.transitionDuration=iDuration+'ms';this.__animation.etop.style.transitionDuration=iDuration+'ms';if(this.__animation.ebottom)this.__animation.ebottom.style.transitionDuration=iDuration+'ms';this.__eLi.style.top=this.__animation.etop.offsetTop+'px';this.__animation.etop.style.height=height+'px';if(this.__animation.ebottom)
this.__animation.ebottom.style.height='0';this.__animation.interval=setTimeout(function(){if(this.__eLi&&this.__eLi.parentNode){this.__eLi.parentNode.replaceChild(this.__eLi,this.__animation.etop);removecss(this.__eLi,'animate');this.__eLi.style.top='0';this.__eLi.style.transitionDuration='0ms';}
if(this.__animation.ebottom)
this.__animation.ebottom.parentNode.removeChild(this.__animation.ebottom);delete this.__animation;if(this._isActive)
tab._parent._getAnchor('header2').scrollTop=0;}.bind(this),iDuration+30);}.bind(this),100);}
else{this.__eLi.parentNode.insertBefore(this.__eLi,this.__eLi.parentNode.firstChild);if(this._isActive)
tab._parent._getAnchor('header2').scrollTop=0;}}};tab._onclose=function(){if(this.__animation){if(this.__animation.interval)
clearTimeout(this.__animation.interval);if(this.__animation.etop)
this.__animation.etop.parentNode.removeChild(this.__animation.etop);if(this.__animation.ebottom)
this.__animation.ebottom.parentNode.removeChild(this.__animation.ebottom);}
if(this.__search){dataSet.remove('xmpp',['roster',this.__sJID,'last_history'],true);dataSet.remove('xmpp',['roster',this.__sJID,'history'],true);}
else
if(sPrimaryAccountIMHISTORY){var ds=dataSet.get('xmpp',['roster',this.__sJID]);if(ds.invalid_history){delete ds.invalid_history;delete ds.last_history;delete ds.history;}
else
if(ds.history&&ds.history.length>40){delete ds.last_history;ds.history=ds.history.slice(-40);}}
if(count(me.__tabIndex)==1&&!me._destructed){Cookie.set(['im_recent'],[]);me._destruct();}};tab._oncontext=function(e){if(!me.__im)return;var id=this.__sJID,bLogin=!me.__im._is_active();if(!id||id.indexOf('~')==0)return;var aMenu=[{'title':'IM::VCARD','arg':{'method':'vcard',id:id},disabled:bLogin},{'title':'IM::SEND_MAIL','arg':{'method':'send',id:id}},{'title':'IM::SEND_FILE','arg':{'method':'file',id:id},disabled:bLogin},{'title':'-'},{'title':'IM::SUBSCRIPTION',nodes:[{'title':'IM::SEND','arg':{method:'sub_add',id:id}},{'title':'IM::REQUEST','arg':{method:'sub_get',id:id}},{'title':'IM::REMOVE','arg':{method:'sub_remove',id:id}}],disabled:bLogin}];var cmenu=gui._create("cmenu","obj_context",'','',this);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);cmenu._onclick=function(e,elm,id,arg){me.__im._oncontext(e,elm,id,arg);};};tab.__update=function(sDName,sDPath){if(sDName&&sDPath&&sDPath[0]=='roster'&&sDPath[1]==this.__sJID){var ds=dataSet.get(sDName,['roster',this.__sJID]);if(ds){var sStatus=me.__im._getStatus(this.__sJID);if(this.__eLi.__laststate!=sStatus){if(this.__eLi.__laststate)
removecss(this.__eLi,this.__eLi.__laststate);this.__eLi.__laststate=sStatus;addcss(this.__eLi,sStatus);if(this._isActive){me.__title(sDPath[1]);if(this.chat)
this.chat._notice(sDPath[1],getLang('STATUS::'+sStatus.toUpperCase()));}}
if(ds.action=='msg')
addcss(this.__eLi,'im_event');else
removecss(this.__eLi,'im_event');}}};tab.__onDestruct=function(){var uid=this.__sJID,nxt,bFound=false;for(var i in me.__tabIndex){if(i===this.__sJID){bFound=true;continue;}
var nxt=me.__tabIndex[i];if(bFound)
break;}
if(this._wasActivated){var usr=dataSet.get('xmpp',['roster',uid]);if(usr&&usr.show&&usr.show!='offline'&&'1'!==GWOthers.getItem('IM','disable_gone_message'))
me.__im.__xmpp._msg_status(uid+(usr.resource?'/'+usr.resource:''),'gone');}
if(!isGroup)
dataSet.remove('xmpp',['roster',sFrom,'active'],true);delete me.__tabIndex[uid];if(!me._destructed&&me.tabs[nxt])
me.tabs[nxt]._active();};tab.__addItems=function(files){this.__upload_buffer=files.map(function(file){return{'class':'item','description':file.title,'size':file.size,'fullpath':file.fullpath};});return this.upload._onuploadend();};tab._onactive=function(bFirstTime,bClick){if(this._destructed)
return;if(bFirstTime){this._draw('frm_chat_form','main');msiebox(this._getAnchor('msiebox'));this._create('upload','obj_upload');this.upload._onuploadstart=function(){this.text._create('info','obj_upload_info','block');addcss(this.text._main,'block');this.__upload_buffer=[];}.bind(this);this.upload._onuploadend=function(){removecss(this.text._main,'block');this.text.info&&this.text.info._destruct();if(this.__upload_buffer.length){if(sPrimaryAccountWebDAV){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();for(var i=0,j=this.__upload_buffer.length;i<j;i++)
aItemInfo['ATTACHMENTS'].push({values:this.__upload_buffer[i]});WMItems.add([sPrimaryAccount,'__@@UPLOAD@@__'],aItemInfo,'','','',[function(bOK,aData){if(bOK){if(aData&&this.__sJID){if(Array.isArray(aData)){aData.forEach(function(aData){me.__im._link(this.__sJID,{link:aData.att_link+'&id='+aData.id,desc:aData.name,size:aData.att_size});},this);}else{me.__im._link(this.__sJID,{link:aData.att_link+'&id='+aData.id,desc:aData.name,size:aData.att_size});}}}
else{}}.bind(this)]);}
else
this.__upload_buffer.forEach(function(v){if(v.size>0&&v.fullpath){var sFolder=Path.basedir(v.fullpath),sFile=Path.basename(v.fullpath);if(v['class']=='item')
sFolder=sFolder.substring(sFolder.indexOf('/')+1);if(window.sPrimaryAccountSOCKS)
me.__im.__xmpp._stream_send(sFolder,sFile,v['class'],v.size,v.description,sFrom,'');else
me.__im.__xmpp._oob_send(sFolder,sFile,v['class'],sFrom,'');this.chat._system(getLang('IM::UPLOADED',[v.description.escapeHTML()]));}}.bind(this));}}.bind(this);this.upload._onuploadsuccess=function(file){this.text.info&&this.text.info._handler(null);this.__upload_buffer.push({'class':'file','description':file.name,'size':file.size,'fullpath':file.folder+'/'+file.id});}.bind(this);this.upload._onuploadprogress=function(file,a,b,xhr){this.text.info&&this.text.info._value(file.name,a,b,[function(){xhr.abort()}]);}.bind(this);this.upload._dropzone(this._main,function(){return template.tmp('dropzone',{title:getLang('CHAT::DROP_TITLE',[tab.__sName.escapeHTML()])});},'item');var handlers={attach:[function(){gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[this,'__addItems'],sPrimaryAccount,'','','r',false,['F','X']);}.bind(this)],'conference':[function(){storage.library('wm_conference');wm_conference.create(function(conference){conference.join();conference.invite(me._getRecipients());});}],'geo':[function(){var sJID=this.__sJID;if(sJID&&"geolocation"in navigator)
navigator.geolocation.getCurrentPosition(function(pos){var aArg={lat:pos.coords.latitude,lon:pos.coords.longitude};me.__im._geo(sJID,aArg);});}.bind(this)],code:[me,'_code']};var old_oncontext=this.chat._oncontext;this.chat._oncontext=function(e){if(window.getSelection){var sel=window.getSelection();if(!sel.isCollapsed&&sel.rangeCount)
for(var range,i=0;i<sel.rangeCount;i++){range=sel.getRangeAt(i);if(!range.isCollapsed&&Is.Child(range.commonAncestorContainer||range.startContainer,this._main))
return true;}}
if(old_oncontext){if(old_oncontext(e)===false){return;}}
this.cmenu&&this.cmenu._destruct();e.cancelBubble=true;e.preventDefault();if(e.stopPropagation)
e.stopPropagation();if(!(me.__im&&me.__im._is_active()))return;var aMenu=[{'title':'CHAT::SHARE_FILE_OR_DOCUMENT','arg':{'method':'attach'},css:'ico2 attach'},{'title':'INSERT_CODE::TITLE','arg':{'method':'code'},css:'ico2 code'},{'title':'CHAT::NEW_CONFERENCE','arg':{'method':'conference'},css:'ico2 conference',disabled:!sPrimaryAccountCONFERENCE},{'title':'IM::GEO','arg':{'method':'geo'},css:'ico2 geo',disabled:!("geolocation"in navigator)||!GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')}];addcss(this._main,'color1');this.cmenu=gui._create("cmenu","obj_context",'','obj_chat_input_add',this);this.cmenu._fill(aMenu);this.cmenu._place(e.clientX,e.clientY,null,2);var btn=this;this.cmenu._obeyEvent('destructed',[function(){removecss(btn._main,'color1');}]);this.cmenu._onclick=function(e,elm,id,arg){if(arg.method&&handlers&&handlers[arg.method])
executeCallbackFunction(handlers[arg.method]);else
executeCallbackFunction(arg);};};this._create('text','obj_chat_input','text','',{block:true,smiles_enabled:true,handlers:handlers,memory:{set:[function(val){dataSet.add('xmpp',['roster',this.__sJID,'input'],val,true);}.bind(this)]}});this.text._value(dataSet.get('xmpp',['roster',this.__sJID,'input'])||'');this.text.input._placeholder(getLang('IM::MESSAGE_PH'));this.text.add._disabled(!(me.__im&&me.__im._is_active()));me.__im.__xmpp._obeyEvent('status',[function(){if(!this||this._destructed)
return false;this.text.add._disabled(!(me.__im&&me.__im._is_active()));}.bind(this)]);this.text._onsubmit=function(){if(me.__im&&me.__im._is_active()){var uid=this.__sJID,usr=dataSet.get('xmpp',['roster',uid]);if(usr){if(!isGroup){if(Is.Defined(this.__composing_timeout))
clearTimeout(this.__composing_timeout);this.__is_composing=false;me.__im.__xmpp._msg_status(uid+(usr.resource?'/'+usr.resource:''),'paused');}
me._send();}}
else
return false;}.bind(this);this.text._onpasteimage=function(aFiles){this.upload.file.__ondropfile(aFiles);}.bind(this);this.text._onkeydown=function(e){if(!isGroup&&me.__im&&me.__im._is_active()){var uid=this.__sJID,usr=dataSet.get('xmpp',['roster',uid]);if(usr){if(!this.__is_composing){this.__is_composing=true;me.__im.__xmpp._msg_status(uid+(usr.resource?'/'+usr.resource:''),'composing');}
if(Is.Defined(this.__composing_timeout))
clearTimeout(this.__composing_timeout);this.__composing_timeout=setTimeout(function(){this.__is_composing=false;me.__im.__xmpp._msg_status(uid+(usr.resource?'/'+usr.resource:''),'paused');}.bind(this),3000);}}}.bind(this);this.text._onclose=function(e){var out=false;switch(parseInt(GWOthers.getItem('IM','esc'))){case 1:this._dock();break;case 2:if(count(this.__tabIndex)>0)
this.tabs[this.tabs._value()]._close();else
out=true;}
if(!out){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();}
return out;}.bind(me);this.text.input._onfocus=function(e){this._onfocus();}.bind(me);if(sPrimaryAccountIMHISTORY&&!isGroup)
this.chat._request=function(bForce){if(dataSet.get('xmpp',['roster',sFrom,'last_history'])=='full')
return;var rqid=unique_id();this.__request_id=rqid;var items=20,aGet,h=dataSet.get('xmpp',['roster',sFrom,'history'])||[],iStart='',iOffset='';for(var i in h){if(h[i]&&Is.Defined(h[i].start)){iStart=h[i].start;iOffset=h[i].offset;}
break;}
this.__loading=1;aGet={'from':sFrom,'max':20,'start':iStart,'before':iOffset};if(this._parent.__search)
aGet.search=this._parent.__search;addcss(this._main,'loading');me.__im.__xmpp._history_get(aGet,[function(aData,rqid,sFrom){if(this&&!this._destructed&&this.__request_id==rqid){var arr=me.__history_parser(aData),h=dataSet.get('xmpp',['roster',sFrom,'history'])||[];if(items>arr.length)
dataSet.add('xmpp',['roster',sFrom,'last_history'],'full',true);dataSet.add('xmpp',['roster',sFrom,'history'],[].concat(arr,h),true);if(arr.length)
this._response(arr.reverse());}
removecss(this._main,'loading');}.bind(this),[rqid,sFrom]]);};if(!isGroup)
dataSet.add('xmpp',['roster',sFrom,'active'],true,true);var arr=dataSet.get('xmpp',['roster',sFrom,'history'],true);if(Is.Array(arr)){this.chat.__loading=1;this.chat._response(arr.reverse());}
else
if(this.chat._request)
this.chat._request();};me.__title(sFrom);me.tabs.menu.__redraw(sFrom);if(this.__search){this._parent.search._value(this.__search);addcss(me._main,'search');}
else
removecss(me._main,'search');removecss(this.__eLi,'im_event',true);if(me.__tabIndex[this.__sJID]){if(Cookie.get(['im','queue',this.__sJID])==1)
Cookie.set(['im','queue',this.__sJID]);if(dataSet.get('xmpp',['roster',this.__sJID,'action'])=='msg'){dataSet.remove('xmpp',['roster',this.__sJID,'action']);dataSet.update('main',['im']);}}
if(this.chat){this.text._focus();this.chat._scroll(0);}};this.__tabIndex[sFrom]=tab._name;tab._listen('xmpp',['roster',sFrom],true);tab.__update('xmpp',['roster',sFrom]);tab._add_destructor('__onDestruct');}
if(bActive)
this.tabs._value(tab._name);this.__update();return tab;};_me._code=function(){gui._create('insert_code','frm_insert_code','','',[function(sBody){this._send(sBody);}.bind(this)]);};_me.__transformImageMessages=function(msg){if(msg.EVENT&&msg.EVENT[0].ITEMS&&msg.EVENT[0].ITEMS[0].ITEM&&msg.EVENT[0].ITEMS[0].ITEM[0].GEOLOC)
msg.BODY=[{VALUE:{geoloc:msg.EVENT[0].ITEMS[0].ITEM[0].GEOLOC[0],type:"geoloc"}}];else
if(msg.X&&msg.X[0].URL)
msg.BODY=[{VALUE:{url:msg.X[0].URL[0].VALUE,desc:msg.X[0].DESC?msg.X[0].DESC[0].VALUE:'',size:msg.X[0].SIZE?msg.X[0].SIZE[0].VALUE:'',type:"file"}}];return msg;};_me._notice=function(sFrom,sBody){if(sBody){var sFrom=sFrom.split('/').shift(),tab=this.tabs[this.__tabIndex[sFrom]];if(tab)
tab.chat._notice(sFrom,sBody);}};_me._chat=function(sFrom,sTo,sBody,iDate,bHistory,bSkipQueue){var sFrom=sFrom.split('/').shift(),tab=this._getChat(sFrom);if(tab&&tab.chat)
if(sBody){if(tab.chat._request&&!Is.Defined(dataSet.get('xmpp',['roster',sFrom,'history']))){tab.chat._request();return;}
var iDate=iDate||(new IcewarpDate()).unix(),h=dataSet.get('xmpp',['roster',sFrom,'history'])||[];h.push({from:sTo||sFrom,body:sBody,reply:sTo?true:false,date:iDate});dataSet.add('xmpp',['roster',sFrom,'history'],h,true);if(sTo)
tab.chat._add(sTo,'',sBody,true,iDate);else
tab.chat._add(sFrom,'',sBody,false,iDate);}};_me.__history_parser=function(aData){var arr=[];try{if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.CHAT){if(aData.CHAT[0].TO){aData.CHAT[0].TO=aData.CHAT[0].TO.map(this.__transformImageMessages);for(var i in aData.CHAT[0].TO)
if(aData.CHAT[0].TO[i].BODY&&aData.CHAT[0].TO[i].BODY[0]&&aData.CHAT[0].TO[i].BODY[0].VALUE){arr.push({from:sPrimaryAccount,body:aData.CHAT[0].TO[i].BODY[0].VALUE,reply:true,date:(new IcewarpDate(aData.CHAT[0].ATTRIBUTES.START).utcOffset(new IcewarpDate().utcOffset()).add(aData.CHAT[0].TO[i].ATTRIBUTES.SECS,'seconds')).unix(),start:aData.CHAT[0].ATTRIBUTES.START,offset:aData.CHAT[0].TO[i].ATTRIBUTES.SECS});}}
if(aData.CHAT[0].FROM){aData.CHAT[0].FROM=aData.CHAT[0].FROM.map(this.__transformImageMessages);for(var i in aData.CHAT[0].FROM)
if(aData.CHAT[0].FROM[i].BODY&&aData.CHAT[0].FROM[i].BODY[0]&&aData.CHAT[0].FROM[i].BODY[0].VALUE){arr.push({from:aData.CHAT[0].FROM[i].ATTRIBUTES.JID,body:aData.CHAT[0].FROM[i].BODY[0].VALUE,reply:false,date:(new IcewarpDate(aData.CHAT[0].ATTRIBUTES.START).utcOffset(new IcewarpDate().utcOffset()).add(aData.CHAT[0].FROM[i].ATTRIBUTES.SECS,'seconds')).unix(),start:aData.CHAT[0].ATTRIBUTES.START,offset:aData.CHAT[0].FROM[i].ATTRIBUTES.SECS});}}
if(arr.length>0)
arr.sort(function arrsrt(a,b){return a.date-b.date;});}}
catch(e){console.log('frm_chat.__history_parser',e);}
return arr;};_me._onclose=function(b,e){if(b){if(e&&e.keyCode==27)
switch(parseInt(GWOthers.getItem('IM','esc'))){case 1:this._dock();case 0:return false;}
var r=[];[].forEach.call(this.tabs._getAnchor('links').querySelectorAll('li'),function(li){var t=this.tabs[li.id.split('/')[1]];if(t&&t.__sJID)
r.push(t.__sJID);}.bind(this));Cookie.set(['im_recent'],r);}
return true;};

/* client/inc/frm_chat_upload.js */
_me=frm_chat_upload.prototype;function frm_chat_upload(){};_me.__constructor=function(sName,sDesc,aFolder,aHandler){var me=this;this._modal(true);this._title('MAIN_MENU::NEW_UPLOAD');this._size(500,350,true);this._dockable(false);this._resizable(false);this.__count=5;this._draw('frm_chat_upload','main');sName=sName||getLang('EVENT_VIEW::NO_TITLE');this.input_name._value(sName);this.input_name._placeholder(sName);this._create("input_desc","obj_chat_input","text","",{smiles_enabled:GWOthers.getItem('CHAT','smiles')=='1',height:60});this.input_desc._folder(aFolder);if(sDesc)this.input_desc._value(sDesc);this.input_desc.input._placeholder(getLang('IM::COMMENT_PH'));function test(){me.x_btn_ok._disabled(!me.input_name.__check());};this.input_name._onerror=function(){test();};this.input_desc._onsubmit=this.input_name._onsubmit=function(){test();me.x_btn_ok._onclick();};this._create('x_btn_ok','obj_button','footer','ok noborder color1');this.x_btn_ok._tabIndex();this.x_btn_ok._text(getLang('FORM_BUTTONS::OK'));this.x_btn_ok._onclick=function(){try{if(aHandler){var sDesc=me.input_desc._value(),aArg;if(sDesc)
aArg={mentions:me.input_desc.input._mention()};executeCallbackFunction(aHandler,me.input_name._value(),sDesc,aArg);}}
catch(r){console.warn('upload error',r);}
me._destruct();};this.input_name._restrict([Is.Filename]);this.input_desc._main.addEventListener('keyup',this._onKeyup.bind(this));this._main.addEventListener("dragenter",function(e){me.x_btn_ok._onclick();e.preventDefault();e.stopPropagation();return false;},false);this._focus();this.input_desc._focus();};_me._onKeyup=function(){this.__interval&&this._stop();};_me._stop=function(){if(this.__interval){window.clearInterval(this.__interval);this.__interval=null;}
this.x_btn_ok._value('FORM_BUTTONS::OK');};

/* client/inc/frm_collaboration.js */
_me=frm_collaboration.prototype;function frm_collaboration(){};_me.__constructor=function(aValues,callback){var me=this;this.__callback=callback;this._add_destructor('__onClose');this._resizable(false);this._modal(true);this._draw('frm_collaboration','main');this._size(700,window.innerHeight<800?window.innerHeight:'auto',true);this._create('obj_scrollbar','obj_scrollbar')._scrollbar(this._getAnchor('main'));this._title('COMMON::SHARE');function processing(disable){me.enabled._disabled(disable);me.allowed_editing._disabled(disable);me.password_protected._disabled(disable);me.password._disabled(disable);me.save_password._disabled(disable);}
this.enabled._onclick=function(){var enabled=me.enabled._checked();var editable=me.allowed_editing._value();var protected=me.password_protected._checked();var password=me.password._value();processing(true);TeamChatAPI[enabled?'filesUninvite':'filesInvite'].call(TeamChatAPI,{id:aValues.EVN_ID,editable:editable,password:protected?password:''},{success:function(response){processing(false);me.enabled._value(!!response.inviteticket);aValues.INVITETICKET=response.inviteticket;me.__addCloseButton();},error:function(){gui.notifier._value({type:'alert',args:{header:'',text:'ALERTS::FILE_LOCKED_EDIT'}});processing(false);}});return false;};this.enabled._onchange=function(event,enabled){me._getAnchor('editing').classList[enabled?'remove':'add']('disabled');me._getAnchor('password').classList[enabled?'remove':'add']('disabled');me._getAnchor('share').classList[enabled?'remove':'add']('disabled');};this.allowed_editing._onclick=function(){var editable=me.allowed_editing._value();var protected=me.password_protected._checked();var password=me.password._value();processing(true);TeamChatAPI.filesInvite({id:aValues.EVN_ID,editable:!editable,password:protected?password:''},{success:function(){processing(false);me.allowed_editing._value(!editable);me.__addCloseButton();},error:function(){processing(false);}});return false;};this.password_protected._onclick=function(){var editable=me.allowed_editing._value();var protected=me.password_protected._checked();var password=me.password._value();if(protected||password){processing(true);TeamChatAPI.filesInvite({id:aValues.EVN_ID,editable:editable,password:protected?'':password},{success:function(){processing(false);me.password_protected._value(!protected);me._getAnchor('password_protected').classList[!protected&&password?'remove':'add']('hidden');me.__addCloseButton();},error:function(){processing(false);}});return false;}};this.password_protected._onchange=function(event,enabled){var sharing_enabled=me.enabled._checked();me._getAnchor('password_container').classList[!enabled||!sharing_enabled?'add':'remove']('hidden');me._getAnchor('password_protected').classList[(enabled&&me.password._value())?'remove':'add']('hidden');};this.password._onkeydown=function(e){if(e.keyCode===13){me.save_password._onclick();me.password._focus();}};this.password.__setMask({'toggle':['',getLang('COMMON::SHOW')]},[function(){if(me.password.__eIN.getAttribute('type')==='text'){me.password.__eIN.setAttribute('type','password');}else{me.password.__eIN.setAttribute('type','text');}}]);this.password._onchange=function(){if(me.__resetSavePasswordTimeout){clearTimeout(me.__resetSavePasswordTimeout);me.__resetSavePassword();}
me.save_password._main.classList[(me.password._value()===(aValues.EVNDOCPASS||''))?'add':'remove']('hidden');};this.__resetSavePassword=function(){if(me.save_password){me.save_password._disabled(false);me.save_password._value('FORM_BUTTONS::SAVE');me.save_password._main.classList.add('hidden');}};this.save_password._onclick=function(){var editable=me.allowed_editing._value();var password=me.password._value();processing(true);TeamChatAPI.filesInvite({id:aValues.EVN_ID,editable:editable,password:password},{success:function(){processing(false);me.save_password._disabled(true);me.save_password._value('FORM_BUTTONS::SAVED');me.__resetSavePasswordTimeout=setTimeout(me.__resetSavePassword.bind(me),2000);me._getAnchor('password_protected').classList[password?'remove':'add']('hidden');aValues.EVNDOCPASS=password;me.__addCloseButton();},error:function(){processing(false);}});};if(Item.officeSupport(aValues.EVNTITLE)){this._getAnchor('editing').classList.remove('hidden');}
this.enabled._value(!!aValues.INVITETICKET);this.enabled._onchange(void 0,!!aValues.INVITETICKET);this.allowed_editing._value(aValues.EVNDOCEDITABLE==='1');if(aValues.EVNDOCPASS){this.password._value(aValues.EVNDOCPASS.unentityify());this._getAnchor('password_container').classList.remove('hidden');}
this.password_protected._value(!!aValues.EVNDOCPASS);this._getAnchor('password_protected').classList[aValues.EVNDOCPASS?'remove':'add']('hidden');this._getAnchor('copy_to_clipboard').addEventListener('click',function(){var input=document.createElement('input');input.style.opacity=0;input.value=aValues.INVITETICKET;document.body.appendChild(input);input.select();document.execCommand('copy');input.parentElement.removeChild(input);me.__addCloseButton();me._getAnchor('link_copied').classList.remove('hidden');});this._getAnchor('email_toggle').addEventListener('click',function(){me._getAnchor('email_container').classList.remove('hidden');});this.address_book._onclick=function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],void 0,void 0,void 0,void 0,true,me._isModal());};this.send_email._onclick=function(){var emails=(me.email._value()||'').split(',');var length=emails.length;if(length){me.send_email._disabled(true);}
emails.forEach(function(sEmail){var email=MailAddress.splitEmailsAndNames(sEmail);if(email&&(email=email[0])&&(email=email.email)){WMItems.action({aid:aValues.aid,fid:aValues.fid,iid:aValues.EVN_ID,values:{EMAIL:email}},'notify_item',[function(){if(!--length){me.email._value('');me.send_email._disabled(false);me.__openSuccessPage(emails.map(function(sEmail){return MailAddress.splitEmailsAndNames(sEmail)[0].email;}));}}]);}});};if(aValues.EVNLOCKOWN_ID&&aValues.EVNLOCKOWN_ID!==sPrimaryAccountGWID){processing(true);}
var f=dataSet.get('folders',[sPrimaryAccount]);var has_teamchat=sPrimaryAccountTeamchatToken&&Object.keys(f).some(function(k){return f[k].TYPE==='I';});if(has_teamchat){this._getAnchor('teamchat').classList.remove('hidden');this._getAnchor('teamchat_toggle').addEventListener('click',function(){me._getAnchor('teamchat_container').classList.remove('hidden');});this.teamchat._onchange=function(){var a=MailAddress.splitEmails(this._value()),l=a.length;if(l>1){this._value(a.pop());}};this.lbl_chat._onclick=function(e){var sFolder,f=Cookie.get(['last']);if(f&&(f=f['I'])&&(f=Path.split(f))&&WMFolders.getType(f)=='I'){sFolder=f[1];}else{var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}}
sFolder&&gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){var sName=dataSet.get('folders',[aid,fid,'NAME'])||dataSet.get('folders',[aid,fid,'RELATIVE_PATH'])||'';if(sName.length){fid+='::'+sName;me.teamchat._value('['+fid+']');}}],true,true,['Y','I'],'',true);};this.send_teamchat._onclick=function(){var tc=me.teamchat._value(),folder;if(!tc){return;}
me.send_teamchat._disabled(true);folder=tc.split('[')[1].split('::')[0];WMItems.action({"aid":aValues.aid,"fid":aValues.fid,"iid":aValues.EVN_ID,nodes:{note:'',folder:folder}},'document_link',[function(){me.teamchat._value('');me.send_teamchat._disabled(false);me.__openSuccessPage([tc.split('::')[1].replace(/\]$/,'')]);}]);};}
this.reset_link._onclick=function(){gui._create('confirm','frm_confirm','','',[function(){WMItems.action({aid:aValues.aid,fid:aValues.fid,iid:aValues.EVN_ID},'collaboration_reset',[function(_,response){if(me.__callback&&me.__callback[0]){me.__callback[0]=me.__callback[0].bind(null,response.IQ[0].RESULT[0].ID[0].VALUE);}
me._destruct();}]);}],'COLLABORATION::RESET_LINK','COLLABORATION::RESET_LINK_HELPER');};this.back._onclick=function(){me.__closeSuccessPage();};this.__closeSuccessPage();};_me.__openSuccessPage=function(recipients){this.__addCloseButton();this._getAnchor('content').classList.add('hidden');this._getAnchor('success').classList.remove('hidden');if(recipients.length>1){this._getAnchor('text').innerHTML=getLang('COLLABORATION::SUCCESS_MESSAGE_MULTIPLE',[mkElement('span',{className:'name',textContent:recipients[0]}).outerHTML,mkElement('span',{className:'others',textContent:getLang('COLLABORATION::SUCCESS_MESSAGE_OTHER'+(recipients.length>2?'S':''),[recipients.length-1])}).outerHTML]);gui.tooltip._add(this._getAnchor('success').querySelector('.others'),recipients.slice(1).map(function(recipient){return recipient.entityify();}).join('<br>'),{hide:false,css:'dark pad',html:true});}else{this._getAnchor('text').innerHTML=getLang('COLLABORATION::SUCCESS_MESSAGE',[mkElement('span',{className:'name',textContent:recipients[0]}).outerHTML]);}};_me.__closeSuccessPage=function(){this._getAnchor('success').classList.add('hidden');this._getAnchor('content').classList.remove('hidden');};_me.__addCloseButton=function(){var me=this;if(!this.x_btn_ok){this._create('x_btn_ok','obj_button','footer','');this.x_btn_ok._tabIndex();this.x_btn_ok._value('FORM_BUTTONS::CLOSE');this.x_btn_ok._onclick=function(){this._disabled(true);me._destruct();};}};_me.__onAddNewFromAddressbook=function(bOK,aAddresses){if(bOK&&aAddresses&&aAddresses[0]){var emails=this.email._value().split(',');for(var i in aAddresses[0]){emails.push(aAddresses[0][i]);}
this.email._value(emails.filter(function(v,i,s){return s.indexOf(v)===i;}).join(','));}};_me.__onClose=function(){executeCallbackFunction(this.__callback);};

/* client/inc/frm_comment.js */
_me=frm_comment.prototype;function frm_comment(){};_me.__constructor=function(aData){this._getAnchor('close').onclick=function(){this._close();}.bind(this);this.__aData=clone(aData,true);dataSet.add('teamchat',[this.__aData.fid,'comment'],this.__aData.iid);var aTypes={R:'obj_groupchat_file',Z:'obj_groupchat_file',Q:'obj_groupchat_event',S:'obj_groupchat_conference',W:'obj_groupchat_invite',I:'obj_groupchat_message',Y:'obj_groupchat_mail'};msiebox(this._getAnchor('msiebox'));this._create('list','obj_groupchat','chat','private');this.list.__options.comments=false;this.list._serverSort({aid:this.__aData.aid,fid:this.__aData.fid},true,{sys_search:'comments:'+(WMItems.__serverID(this.__aData.iid))});if(aTypes[aData.EVNCLASS]){this._create('item',aTypes[this.__aData.EVNCLASS],'item','',this.__aData,this.list,{novideo:true,fulldate:true});this._getAnchor('item').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(hascss(elm,'mailto')){var email=elm.getAttribute('rel');if(email)
Item.sendEmailTo(email);}
else
if(elm.tagName=='SPAN'){if(hascss(elm,'mention')&&(id=elm.getAttribute('rel'))){var addr=MailAddress.splitEmailsAndNames(id);if((addr=addr[0])&&addr.email){this.text.input._addMention(addr);}}
else
if(hascss(elm,'private_msg')){var sMail=elm.getAttribute('rel');if(sMail){var addr=MailAddress.splitEmailsAndNames(sMail.urlDecode());if(addr&&addr[0]){var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',addr[0].name,addr[0].email);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;}}}}
else
if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();NewMessage.compose({to:elm.pathname});return false;}}.bind(this);this._getAnchor('item').oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();e.stopPropagation();var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','','',elm.pathname);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));return false;}};if(this.__aData.updateMe&&this.item.__update)
this.item.__update();this._scrollbar(this._getAnchor('item'),this._getAnchor('item').parentNode);this._getAnchor('toggle').onclick=function(){if(hascss(this._main,'full'))
removecss(this._main,'full');else
addcss(this._main,'full');}.bind(this);}
this.list._onclick=function(e,elm){if(hascss(elm,'mailto')){var email=elm.getAttribute('rel');if(email)
Item.sendEmailTo(email);}
else
if(elm.tagName=='SPAN'){if(hascss(elm,'mention')&&(id=elm.getAttribute('rel'))){var addr=MailAddress.splitEmailsAndNames(id);if((addr=addr[0])&&addr.email){this._parent.text.input._addMention(addr);}}
else
if(hascss(elm,'private_msg')){var sMail=elm.getAttribute('rel');if(sMail){var addr=MailAddress.splitEmailsAndNames(sMail.urlDecode());if(addr&&addr[0]){this.__options.autoscroll=false;var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',addr[0].name,addr[0].email);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));cmenu._onclose=function(){this.__options.autoscroll=true;return true;}.bind(this);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}}}}
else
if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();NewMessage.compose({to:elm.pathname});return false;}};this.list._oncontext=function(e,elm){if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();e.stopPropagation();var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','','',elm.pathname);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));return false;}};this.list._oncount=function(i){if(this.item&&this.item.__aData.META_COMMENTS&&this.item.__aData.META_COMMENTS.count==i)
return;this.list._fire(WMItems.__serverID(this.__aData.iid),'comment',{'ITEM-TYPE':'-','BODY':i});}.bind(this);if(aTypes[aData.EVNCLASS])
this.list.__aData[aData.iid]={obj:this.item};if(WMFolders.getRights({aid:this.__aData.aid,fid:this.__aData.fid}).write){this._create('upload','obj_upload');this.upload._onuploadstart=function(){this.text._create('info','obj_upload_info','block');addcss(this.text._main,'block');this.__upload_buffer=[];}.bind(this);this.upload._onuploadend=function(){removecss(this.text._main,'block');this.text.info&&this.text.info._destruct();if(this._parent&&!this._parent._destructed&&this.__upload_buffer.length){if(this.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',this.__upload_buffer[0].description,'',{aid:this.__aData.aid,fid:this.__aData.fid},[function(sName,sDesc,aArgs){if(this._parent&&!this._parent._destructed)
this._parent.__uploadhandler(this.__upload_buffer,sName,sDesc,aArgs,WMItems.__serverID(this.__aData.iid));}.bind(this)]);}
else
this._parent.__uploadhandler(this.__upload_buffer,'','','',WMItems.__serverID(this.__aData.iid));}}.bind(this);this.upload._onuploadsuccess=function(file){this.text.info&&this.text.info._handler(null);this.__upload_buffer.push({'class':'file','description':file.name,'size':file.size,'fullpath':file.folder+'/'+file.id});}.bind(this);this.upload._onuploadprogress=function(file,a,b,xhr){this.text.info&&this.text.info._value(file.name,a,b,[function(){xhr.abort()}]);}.bind(this);this.upload._dropzone(this._main,function(){return template.tmp('dropzone',{title:getLang('CHAT::DROP_TITLE',[Path.basename(this.__aData.fid)]),body:getLang('CHAT::DROP_BODY')});}.bind(this),'item');this._create("text","obj_chat_input","text","",{parseurl:true,block:true,remember:true,remember_path:[this.__aData.fid,this.__aData.iid],smiles_enabled:GWOthers.getItem('CHAT','smiles')=='1',handlers:{file:[this.upload,'_click'],attach:[this,'_attachFile'],event:[this._parent,'_addEvent',[WMItems.__serverID(this.__aData.iid)]],code:[this,'_code']},memory:{set:[function(val){dataSet.add('teamchat',[this.__aData.fid,this.__aData.iid,'input'],val,true);}.bind(this)],get:[function(){return dataSet.get('teamchat',[this.__aData.fid,this.__aData.iid,'input'])||'';}.bind(this)]}});this.text._folder({aid:this.__aData.aid,fid:this.__aData.fid});this.text.input._placeholder(getLang('IM::COMMENT_PH'));this.text._onpasteimage=function(aFiles){this.upload.file.__ondropfile(aFiles);}.bind(this);this.text._onsubmit=function(v,arg){if(v.length||(arg&&arg.url)){arg=arg||{};arg.comevnid=WMItems.__serverID(this.__aData.iid);this._message(v,arg,this.text.__private);}else
return false;}.bind(this);this.text._onclose=function(){this._close();}.bind(this);this.text._focus();}
this.item.__height=this.item._main.offsetHeight;var bResize=true,sEvent,article=this.item._main.querySelector('article');if(article){if((sEvent=browserEvent('transitionstart')))
article.addEventListener(sEvent,function(){bResize=false;});if((sEvent=browserEvent('transitionend')))
article.addEventListener(sEvent,function(){bResize=true;this.list._onresize();}.bind(this));}
this.list._onresize=function(){if(bResize){var h=this.item._main.offsetHeight,eb=this._getAnchor('body').offsetHeight,ioh=this.item._getAnchor('body').offsetHeight,bMin=hascss(this._main,'min'),bScroll=this.list.__body.scrollHeight>this.list.__body.clientHeight;if(!bMin)
this.item.__height=h;if(!bScroll&&eb-this.item.__height>300){if(bMin){var eCh=this.list.__body.lastChild;if(this.list.__body.scrollHeight-((eCh?eCh.offsetTop+eCh.offsetHeight:30)-this.list.__body.offsetTop)-30>this.item.__height-h){removecss(this._main,'min');return;}}
else
return;}
if(eb-this.item.__height<=300){addcss(this._main,'min');}
else
if(bScroll){if(bMin){if(this.list.__body.scrollTop==0)
removecss(this._main,'min');}
else
if(this.list.__body.scrollTop>0&&ioh>64){addcss(this._main,'min');}}}}.bind(this);this.list._onresize();this.list._onscroll=function(){this.list._onresize();}.bind(this);this.__closable=true;obj_popup.activeStack.add(this);this._add_destructor('__destructor');};_me._isModal=function(){return false;};_me.__destructor=function(){obj_popup.activeStack.remove(this);};_me._code=function(){gui._create('insert_code','frm_insert_code','','',[function(sBody){this._message(sBody,{comevnid:WMItems.__serverID(this.__aData.iid)});}.bind(this)]);};_me._attachFile=function(){if(this.__aData.aid&&this.__aData.fid){var sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[this.__aData.aid,sFolder]))
sFolder='';gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[this,'__addItems'],this.__aData.aid,sFolder,'','r',false,['F','X']);}};_me.__addItems=function(files){var me=this;me.__upload_buffer=[];files.forEach(function(file){me.__upload_buffer.push({'class':'item','description':file.title,'size':file.size,'fullpath':file.fullpath});});if(me.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',me.__upload_buffer[0].description,'',{aid:me.__aData.aid,fid:me.__aData.fid},[function(sName,sDesc,aArgs){me._parent.__uploadhandler(me.__upload_buffer,sName,sDesc,aArgs,WMItems.__serverID(me.__aData.iid));}]);}else
me._parent.__uploadhandler(me.__upload_buffer);};_me._message=function(sBody,aArgs,aPrivate){if(this.__aData.aid&&this.__aData.fid){var folder=this.__aData.aid+'/'+this.__aData.fid,recent=Cookie.get(['recent'])||[],index=recent.indexOf(folder);!!~index&&recent.splice(index,1);recent.unshift(folder);Cookie.set(['recent'],recent);var aItemInfo={values:{EVNNOTE:sBody,EVNSHARETYPE:'U'}};if(aPrivate){aItemInfo.values.EVNSHARETYPE='C';aItemInfo.values.EVNLINKID=aPrivate.email;}
if(aArgs){if(aArgs.url)
aItemInfo.values.EVNURL=aArgs.url;if(aArgs.title)
aItemInfo.values.EVNTITLE=aArgs.title;if(aArgs.desc)
aItemInfo.values.EVNLOCATION=aArgs.desc;if(aArgs.thumbnailimageid)
aItemInfo.values.THUMBNAILIMAGEID=aArgs.thumbnailimageid;var info={};if(aArgs.type)info.type=aArgs.type;if(aArgs.videourl)info.videourl=aArgs.videourl;if(aArgs.videotype)info.videotype=aArgs.videotype;if(!Is.Empty(info))
aItemInfo.values.LINKINFO=buildURL(info);if(aArgs.comevnid)
aItemInfo.values.EVNCOMEVNID=aArgs.comevnid;}
else
aArgs={};if(hascss(this._main,'full'))
removecss(this._main,'full');WMItems.add([this.__aData.aid,this.__aData.fid],aItemInfo,'','','',[this,'_response',[sBody,aArgs,aPrivate]]);}};_me._response=function(bOK,arg,sBody,aArgs,aPrivate){if(bOK){var x;if(arg.id&&arg.xml&&(x=arg.xml.IQ)&&(x=x[0].RESULT)&&(x=x[0])){var aData={id:WMItems.__clientID(arg.id),aid:this.__aData.aid,fid:this.__aData.fid,body:sBody,timestamp:x.EVN_CREATED?x.EVN_CREATED[0].VALUE:0,comevnid:aArgs.comevnid};if(aArgs){if(aArgs.url)
aData.url=aArgs.url;if(aArgs.desc)
aData.desc=aArgs.desc;if(aArgs.title)
aData.title=aArgs.title;if(aArgs.type)
aData.type=aArgs.type;if(aArgs.videotype)
aData.videotype=aArgs.videotype;if(aArgs.videourl)
aData.videourl=aArgs.videourl;if(aArgs.mentions){aData.mentions=aArgs.mentions;for(var m in aData.mentions){if(m==sPrimaryAccount){this.list._fire(arg.id,'add_mention',{'ITEM-TYPE':'I'},true);break;}}}}
if(aPrivate){aData.share='C';aData.contact_name=aPrivate.name||aPrivate.email;aData.contact_email=aPrivate.email;}
this.list._add_message(aData,true);this.list._fire(arg.id,'add',{'ITEM-TYPE':'I'},true);}}};_me._close=function(){dataSet.remove('teamchat',[this.__aData.fid,'comment']);this._destruct();};

/* client/inc/frm_compose.js */
_me=frm_compose.prototype;function frm_compose(){};_me.__constructor=function(oMessage,oOldMessage){if(!gui._REQUEST_VARS['mailto'])
this._defaultSize(-1,-1,900,620);var me=this;this.__bDisableSave=false;this.__bContactsOpened=false;this.__logoutOnDestruct=false;this.__message=oMessage;this.__message_old=oOldMessage;if(!this.__message.__id)
this.__removeOnDestruct=true;storage.library('gw_others');this.__settings=new cDataSet();this.__settings.add('VALUES','',GWOthers.get('MAIL_SETTINGS_DEFAULT','storage').VALUES);this.__options={};if(this.__message){this._settings('priority',this.__message.iPriority);}
this.__delay=parseInt(this._settings('send_delay')||0);this.__fixed_delay=false;if(sPrimaryAccountSMS&&this.__message.sSMS&&(GWOthers.getItem('RESTRICTIONS','disable_sms')||0)<1){this._title('COMPOSE::SMS');this._settings('sms','1');addcss(this._main,'sms');}
else
if(oMessage.template){this._title('COMPOSE::TEMPLATE');addcss(this._main,'template');this._settings('template','1');this.__removeOnDestruct=false;}
else
this._title('COMPOSE::NEWMAIL');this._settings('dropbox',(GWOthers.getItem('RESTRICTIONS','disable_dropbox')||0)<1&&typeof Dropbox!='undefined');var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');this.__sa_support=sPrimaryAccountWebDAV&&sPrimaryAccountGW>0&&(!dgw||dgw.indexOf('f')<0)&&(GWOthers.getItem('RESTRICTIONS','disable_smart')||0)<1;if(this.__sa_support){if(!dataSet.get('storage',['DEFAULT_FOLDERS','ITEMS','0','VALUES','SMART'])||dataSet.get('storage',['DEFAULT_FOLDERS','ITEMS','0','VALUES','SMART','ATTRIBUTES','DEFAULT']))
this._settings('smart_path',GWOthers.getItem('DEFAULT_FOLDERS','files'));else
this._settings('smart_path',GWOthers.getItem('DEFAULT_FOLDERS','smart'));}else
this._settings('smart_attach',0);this.__cert_support=false;var tmp,aCert=dataSet.get('storage',['CERTIFICATE','ITEMS']);if(Is.Object(aCert))
for(var i in aCert)
if(aCert[i].VALUES&&aCert[i].VALUES.INFO&&aCert[i].VALUES.INFO.VALUE){tmp=XMLTools.Str2Arr(aCert[i].VALUES.INFO.VALUE).INFO[0];if(tmp.VALIDTO[0].VALUE&&IcewarpDate.utct(tmp.VALIDTO[0].VALUE)>new IcewarpDate()){this.__cert_support=true;break;}}
if(!this.__cert_support){this._settings('encrypt','0');this._settings('sign','0');}
if(!this._settings('sms')){var aRcp={};if(oOldMessage&&(oOldMessage.getTo()||oOldMessage.getCc())){if(oOldMessage.getTo()){var tmp=MailAddress.splitEmailsAndNames(oOldMessage.getTo());for(var i in tmp)
aRcp[tmp[i].email.toLowerCase()]=true;}
if(oOldMessage.getCc()){var tmp=MailAddress.splitEmailsAndNames(oOldMessage.getCc());for(var i in tmp)
aRcp[tmp[i].email.toLowerCase()]=true;}}
else
if(oMessage&&oMessage.sRcp){var tmp=MailAddress.splitEmailsAndNames(oMessage.sRcp);for(var i in tmp)
aRcp[tmp[i].email.toLowerCase()]=true;}
else
if(this._settings('from')){var tmp=MailAddress.splitEmailsAndNames(this._settings('from'));if(tmp[0].email.toLowerCase()!=sPrimaryAccount.toLowerCase())
aRcp[tmp[0].email.toLowerCase()]=true;else
aRcp[sPrimaryAccount.toLowerCase()]=true;}
else
aRcp[sPrimaryAccount.toLowerCase()]=true;var bDisabled=GWOthers.getItem('RESTRICTIONS','disable_personalities')>0,aAlias={};if(!bDisabled){var iAliasID=null,tmp=dataSet.get('storage',['ALIASES','ITEMS']),sAlias='',sMail,iPrimaryID='',bFound=false;if(oOldMessage&&oOldMessage.__id[0]!=sPrimaryAccount)
sAlias=oOldMessage.__id[0].toLowerCase();else
if(oOldMessage&&oOldMessage.__id[0]==sPrimaryAccount&&oOldMessage.__id[1].indexOf(sPrimaryAccountSPREFIX)==0&&WMFolders.getAccess({aid:oOldMessage.__id[0],fid:oOldMessage.__id[1]},'modify'))
sAlias=oOldMessage.__id[1].substr(sPrimaryAccountSPREFIX.length).split('/').shift().toLowerCase();var sParimaryAlias=sPrimaryAccount.toLowerCase(),default_alias=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','from');if(default_alias&&(default_alias=MailAddress.splitEmailsAndNames(default_alias))&&(default_alias=default_alias[0])&&(default_alias=default_alias.email))
sParimaryAlias=default_alias.toLowerCase();for(var i in tmp)
if(tmp[i]&&tmp[i].VALUES&&tmp[i].VALUES.EMAIL&&(sMail=tmp[i].VALUES.EMAIL.VALUE.toLowerCase())){if(sAlias&&sAlias==sMail){aAlias[i]=[MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail,true),MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail)];iAliasID=i;bFound=true;}
else
if(sParimaryAlias==sMail){if(sParimaryAlias==sPrimaryAccount.toLowerCase())
aAlias[i]=[getPrimaryAccountFromAddress(true),getPrimaryAccountFromAddress()];else
aAlias[i]=[MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail,true),MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail)];if(aRcp[sMail]&&!bFound)
iAliasID=i;iPrimaryID=i;}
else
if(sMail&&tmp[i].VALUES.ENABLED&&tmp[i].VALUES.ENABLED.VALUE=='1'){aAlias[i]=[MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail,true),MailAddress.createEmail(tmp[i].VALUES.NAME?tmp[i].VALUES.NAME.VALUE:'',sMail)];if(aRcp[sMail]&&iAliasID==null)
iAliasID=i;}}
if(sAlias&&!bFound){aAlias['*']=[MailAddress.createEmail('',sAlias,true),MailAddress.createEmail('',sAlias)];iAliasID='*';}
else
if(iAliasID==null)
iAliasID=iPrimaryID;}
var rm=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','reply_myself');switch(rm){case'cc':case'bcc':var sReAlias='';if(!bDisabled&&iAliasID!=null&&aAlias[iAliasID])
sReAlias=aAlias[iAliasID][1];else
sReAlias=getPrimaryAccountFromAddress();this.__message[rm=='cc'?'sCc':'sBcc']=MailAddress.appendEmail(this.__message[rm=='cc'?'sCc':'sBcc'],sReAlias);}}
var disabled={disable_pe:count(aAlias)<2,disable_ab:sPrimaryAccountGW<1||(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1,disable_chat:!sPrimaryAccountCHAT,hide_pe:GWOthers.getItem('MAIL_SETTINGS_DEFAULT','show_from')!=1&&iAliasID==iPrimaryID&&sParimaryAlias==sPrimaryAccount.toLowerCase(),hide_cc:!this.__message.sCc&&(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','show_cc')!=1||this._settings('sms')),hide_bcc:!this.__message.sBcc&&(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','show_bcc')!=1||this._settings('sms')),ext_ab:GWOthers.getItem('GLOBAL_SETTINGS','external_contacts')?true:false,maxsize:dataSet.get('main',['message_size'])?true:false,sms:this._settings('sms'),disable_smart_attach:!this.__sa_support,disable_signing:!this.__cert_support||!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','sign'),disable_encryption_rule:GWOthers.getItem('MAIL_SETTINGS_DEFAULT','encrypt')!=='1'&&!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','encrypt'),disable_signing_rule:GWOthers.getItem('MAIL_SETTINGS_DEFAULT','sign')!=='1'&&!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','sign'),disable_encryption:!this.__cert_support||!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','encrypt'),disable_confirmation:!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','read_confirmation'),disable_delivery_report:sPrimaryAccountDELIVERY==1?false:true,allow_delaying:sPrimaryAccountSMTP==1,replyto:GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','reply_to_address'),template:this._settings('template'),disable_html:!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message')&&'0'===GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message'),att_menu:me._settings('dropbox')||GWOthers.getItem('RESTRICTIONS','disable_attach_item')!=='1'};this.__options.cc=!disabled.hide_cc;this.__options.bcc=!disabled.hide_bcc;this._draw('frm_compose','main',disabled);this._draw('frm_compose_options','options',disabled);this._draw('frm_compose_bottom','footer',disabled);this.mode_select._disabled(!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message'));this._getAnchor('mask').onclick=function(e){if(hascss(this._main,'mask_option')){this._options_toggle();removecss(this._main,'mask_option');}
else
if(hascss(this._main,'mask_delay')){this._delay_toggle();removecss(this._main,'mask_delay');}}.bind(this);var aLang=dataSet.get('storage',['SPELLCHECKER_LANGUAGES','ITEMS']),aTmp=[],aData={};for(var i in aLang)
if(aLang[i].VALUES&&aLang[i].VALUES.PATH&&aLang[i].VALUES.NAME)
aTmp.push([aLang[i].VALUES.PATH.VALUE,aLang[i].VALUES.NAME.VALUE]);if(aTmp.length){var aTmp=aTmp.sort(function(a,b){if(a[1]<b[1])
return 1;else
if(a[1]>b[1])
return-1;else
return 0;});for(var i=aTmp.length-1;i>=0;i--)
aData[aTmp[i][0]]=aTmp[i][1];aTmp=null;}
this.spellchecker._fill(aData);if(disabled.allow_delaying){this._draw('frm_compose_delay','delay',disabled);if(this.__delay){}
else
if(this.__message.sDeferred){this.__fixed_delay=true;var d=new IcewarpDate(this.__message.sDeferred);this.delay_time._value((d.hour()*60+d.minute())*60000,true);this.delay_date._value(d.format(IcewarpDate.JULIAN));}
this.delay_date._ondateselect=function(){me.__fixed_delay=true;var now=(new IcewarpDate()).format('julian');if(this._value()<now)
this._value(now,true);};this.delay_time._onchange=function(){me.__fixed_delay=true;};}
this.sent.__fillme=function(sFolder){var aPath,aData={'*':getLang('COMMON::NO')};if(me._settings('sent')){aPath=Path.split(me._settings('sent'));aData[aPath[0]+'/'+aPath[1]]=dataSet.get('folders',[aPath[0],aPath[1],'NAME'])||aPath[1];}
aPath=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','sent'));aData[aPath[0]+'/'+aPath[1]]=dataSet.get('folders',[aPath[0],aPath[1],'NAME'])||aPath[1];aData['+']=getLang('SELECT_FOLDER::SELECT_FOLDER');this._fill(aData);};this.sent.__fillme();this.sent._onchange=function(e){switch(this._value()){case'*':me._settings('save_sent_message',0);break;case'+':var aPath=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','sent'));gui._create('select_folder','frm_select_folder','','','SELECT_FOLDER::SELECT_FOLDER',aPath[0],aPath[1],[function(sAccount,sFolder){if(sAccount&&sFolder){me._settings('sent',sAccount+'/'+sFolder);me.sent.__fillme();me.sent._value(sAccount+'/'+sFolder);}}],true,true,'M','i',true);me.sent._value(me._settings('save_sent_message')?me._settings('sent'):'*');break;default:me._settings('save_sent_message',1);me._settings('sent',me.sent._value());}};this.spellchecker._onchange=function(e){me._settings('spellchecker',this._value());};if(this.reply_to_address)
this.reply_to_address._onblur=function(e){me._settings('reply_to_address',me.reply_to_address._value());};msiebox(this._getAnchor('msiebox'));if(this.from){this.from._fill(aAlias);if(iAliasID!=null)
this.from._value(iAliasID);var oGroup={},snd=MailAddress.splitEmailsAndNames(this.from._getDataValue())[0].email,grp=dataSet.get('storage',['GROUPS','ITEMS'])||{},acc=dataSet.get('accounts'),ali=dataSet.get('storage',['ALIASES','ITEMS']);for(var i in grp)
if(grp[i].VALUES.SENTFOLDER&&grp[i].VALUES.SENTFOLDER.VALUE)
oGroup[grp[i].VALUES.GROUP.VALUE]=sPrimaryAccount+'/'+grp[i].VALUES.SENTFOLDER.VALUE;for(var i in acc)
if(!acc[i].PRIMARY&&acc[i].SENTFOLDER)
oGroup[i]=acc[i].SENTFOLDER;for(var i in ali)
if(ali[i].VALUES&&!oGroup[ali[i].VALUES.EMAIL.VALUE]&&ali[i].VALUES.ENABLED.VALUE=='1'&&ali[i].VALUES.SENTFOLDER&&ali[i].VALUES.SENTFOLDER.VALUE)
oGroup[ali[i].VALUES.EMAIL.VALUE]=ali[i].VALUES.SENTFOLDER.VALUE;if(snd in oGroup){if(oGroup[snd]=='*'){me._settings('save_sent_message',0);me._settings('sent','');}
else
me._settings('sent',oGroup[snd]);if(this.sent){this.sent.__fillme();me.sent._value(me._settings('save_sent_message')?me._settings('sent'):'*');}}
this.from._onchange=function(){var signID,v=this._value();var snd=MailAddress.splitEmailsAndNames(this._getDataValue())[0].email;me._settings('save_sent_message',1);if(snd in oGroup){if(oGroup[snd]=='*'){me._settings('save_sent_message',0);me._settings('sent','');}
else
me._settings('sent',oGroup[snd]);}
else
me._settings('sent',GWOthers.getItem('DEFAULT_FOLDERS','sent'));if(me.sent){me.sent.__fillme();me.sent._value(me._settings('save_sent_message')?me._settings('sent'):'*');}
var aAlias=(dataSet.get('storage',['ALIASES','ITEMS',v])||{}).VALUES;if(aAlias){if(Is.Defined(me.__message.sRcp))
signID=aAlias.SIGN2?aAlias.SIGN2.VALUE:'';else
signID=aAlias.SIGN1?aAlias.SIGN1.VALUE:'';me.__message.bDelegate=aAlias.ISDELEGATE&&aAlias.ISDELEGATE.VALUE=='1';}
me._addSignature(signID);};}
this._getAnchor('switch').onclick=function(){if(!me.__options.max){me._layout_maximize(true);}
else{me._layout_minimize();}};if(!this._settings('sms')){this.x_btn_att._onclick=function(){me.attach_control.file._click();};if(this.x_btn_att._type=='obj_button_menu'){this.x_btn_att._menu(function(){var arr=[{title:'ATTACHMENT::FROM_COMPUTER',css:'ico2 att',arg:[function(){me.attach_control.file._click();}]}];if(me._settings('dropbox')){arr.push({title:'ATTACHMENT::FROM_DROPBOX',css:'ico2 dropbox',arg:[function(){me.body.__dropboxHandler();}]});}
if(GWOthers.getItem('RESTRICTIONS','disable_attach_item')!=='1'){arr.push({title:'ATTACHMENT::FROM_DOCUMENTS',css:'ico2 doc',arg:[function(){me.attach_control.item._onclick();}]});}
if(Alfresco.enabled()){arr.push({title:'ATTACHMENT::FROM_ALFRESCO',css:'ico2 alfresco',arg:[function(){me.attach_control.item._onclick('K');}]});}
return arr;},'compose_att_menu');}
this.body._emoji();var tmp=mkElement('A',{className:'ico icosign',title:getLang('SIGNATURE::SIGNATURE')});tmp.onclick=function(e){if(!me.body.__coded&&(!this.__cmenu||this.__cmenu._destructed)){var e=e||window.event,elm=this;var aFill=me.__genSignature();if(aFill){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();addcss(this,'active');this.__cmenu=gui._create('cmenu','obj_context',void 0,'height_200');this.__cmenu._onclose=function(){removecss(elm,'active');};this.__cmenu._fill(aFill);var pos=getSize(this);this.__cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);return false;}
else{if(me.__message.signatureID=='*'&&me._getSignature()==false)
gui._create('settings','frm_settings','','','mail_settings','signature');else
me._addSignature(me.__message.signatureID=='*'?0:'*');}}};this.body._getAnchor('additional').appendChild(tmp);this.x_btn_priority=this.body._create('x_btn_priority','obj_button_menu','additional_right','noborder transparent simple ico img priority');this.body.__output_format=true;}
function sendme(e){if(e.ctrlKey&&!me.__hidden&&!(me.x_btn_save||me.x_btn_send)._disabled()){if(me._settings('template')){me.__save();}
else{switch(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','ctrl_enter').toString()){case'1':if(me._settings('deferred'))
me._delay_toggle();me.__send(false,false,void 0,void 0,true);break;case'2':if(disabled.allow_delaying&&!me._settings('deferred'))
me._delay_toggle();default:me.__send(false,false);}}}
return false;};if(this.to){this.to._collapsedValue(this.__message.sTo);this.to._onsubmit=sendme;}
if(this.teamchat){this.teamchat._onsubmit=sendme;this.teamchat._onchange=function(){var a=MailAddress.splitEmails(this._value()),l=a.length,sFolder=(a[l-1]||'').replace(/[\[\]]/g,'');if(l>1){this._value(a.pop());}
var elm=me._main.querySelector('[data-toggle=chat_message]');if(elm)
window[l>0?'addcss':'removecss'](elm,'show');if(me.teamchat_message.__folder!=sFolder){me.teamchat_message._value('');me.teamchat_message.__folder=sFolder;}
me.teamchat_message._disabled(!l);var elm=me._main.querySelector('div.chat_message');if(l){removecss(me._main.querySelector('div.ico_teamchat'),'extended');if(elm)removecss(elm,'extended');me.teamchat_message._focus();}
else
if(elm){addcss(elm,'extended');}};if(this.__message.sTeamchat){this.teamchat._value('['+this.__message.sTeamchat+']');}
this.teamchat_message._onchange=function(){var elm=me._main.querySelector('[data-toggle=chat_message]');if(elm){window[this._value().length>0?'addcss':'removecss'](elm,'dot');}};this.teamchat_message._onblur=function(){this._onchange();};if(this.__message.sComment)
this.teamchat_message._value(this.__message.sComment);this.lbl_chat._onclick=function(e,aHandler){var sFolder,f=Cookie.get(['last']);if(f&&(f=f['I'])&&(f=Path.split(f))&&WMFolders.getType(f)=='I'){sFolder=f[1];}
else{var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}}
if(sFolder)
gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){var sName=dataSet.get('folders',[aid,fid,'NAME'])||dataSet.get('folders',[aid,fid,'RELATIVE_PATH'])||'';if(sName.length){fid+='::'+sName;me.teamchat._value('['+fid+']');if(aHandler)
executeCallbackFunction(aHandler);}}],true,true,['Y','I'],'',true);};}
this.cc._collapsedValue(this.__message.sCc);this.cc._onsubmit=sendme;this.bcc._collapsedValue(this.__message.sBcc);this.bcc._onsubmit=sendme;this.subject._value(this.__message.sSubject);this.subject._onsubmit=sendme;this.body.onkeydown=function(e){var e=e||window.event;if(e.ctrlKey&&!e.altKey&&(e.keyCode==83||e.keyCode==13)){if(e.preventDefault)
e.preventDefault();else
if(e.cancelBubble)
e.cancelBubble=true;if(me._settings('template'))
me.__save(e.keyCode==83);else
if(e.keyCode==83)
me.__save();else
sendme(e);return false;}};this.body._onesc=function(){me._close(true);};if(this.__sa_support&&this.attach){this._create('btn_smart','obj_checkbox','smart','ico smart');this.btn_smart._title('COMPOSE::SMARTATTACH');this.btn_smart._onchange=function(){me._settings('smart_attach',me._settings('smart_attach')=='1'?0:'1');};this.smart.__fillme=function(sFolder){var aData={'*':getLang('COMMON::NO')};if(me._settings('smart_path')){var aPath=Path.split(me._settings('smart_path'));aData[aPath[0]+'/'+aPath[1]]=dataSet.get('folders',[aPath[0],aPath[1],'NAME'])||aPath[1];}
aData['+']=getLang('SELECT_FOLDER::SELECT_FOLDER');this._fill(aData);};this.smart.__fillme();if(me._settings('smart_attach')=='1'){this.smart._value(me._settings('smart_path'));}
else
this.smart._value('*');this.smart._onchange=function(e){switch(this._value()){case'*':me._settings('smart_attach',0);break;case'+':var aPath=Path.split(me._settings('smart_path'));gui._create('select_folder','frm_select_folder','','','SELECT_FOLDER::SELECT_FOLDER',aPath[0],aPath[1],[function(sAccount,sFolder){if(sAccount&&sFolder){me._settings('smart_path',sAccount+'/'+sFolder);me._settings('smart_attach','1');if(me.body.select._value()=='disabled'&&me.attach._value()['attachments'].length>0&&me.body.select.__idTable['enabled'])
me.body.select._value('enabled');me.smart.__fillme();me.smart._value(sAccount+'/'+sFolder);}}],true,true,'F','i',true);this._value(me._settings('smart_attach')?me._settings('smart_path'):'*');break;default:me._settings('smart_attach','1');if(me.body.select._value()=='disabled'&&me.attach._value()['attachments'].length>0&&me.body.select.__idTable['enabled'])
me.body.select._value('enabled');}};this.__settings.on('VALUES',['smart_attach'],function(v){this.smart._value(this._settings('smart_attach')=='1'?this._settings('smart_path'):'*',true);this.btn_smart._value(this._settings('smart_attach')=='1',true);},this,true);}
this.body._onkeydown=function(e){switch(e.keyCode){case 13:if(e.ctrlKey&&!e.altKey){me.__send(false,false);return false;}
break;case 83:if(e.ctrlKey&&!e.altKey){me.__save();return false;}
break;case 27:if(me._onclose&&me._onclose()){me._destruct();return false;}}};if(!this._settings('sms')){this.body.__getSpellLang=function(){return me._settings('spellchecker')||GWOthers.getItem('MAIL_SETTINGS_DEFAULT','spellchecker');};this.body.__doc.onmousedown=function(){me._focus();};}
this._aMailSettingsGeneral=GWOthers.get('MAIL_SETTINGS_GENERAL','storage');if(sPrimaryAccountGW>0){var btn=function(){if(me.__bContactsOpened)
return;if(this._name=='btn_sms'||this._name=='lbl_sms'){var aTabsNames={'sms':"DATAGRID_ITEMS_VIEW::PHONE"},aTabsValues={'sms':me.sms._value()};gui._create('add_address','frm_addaddress','','',[me,'_onPopupClose'],aTabsNames,aTabsValues,'sms',false,['L'],true);}
else{if(me._settings('sms')==1){var aTabsNames={'cc':"DATAGRID_ITEMS_VIEW::CC",'bcc':"DATAGRID_ITEMS_VIEW::BCC"},aTabsValues={'cc':me.cc._value(),'bcc':me.bcc._value()};}
else{var aTabsNames={'to':"DATAGRID_ITEMS_VIEW::TO",'cc':"DATAGRID_ITEMS_VIEW::CC",'bcc':"DATAGRID_ITEMS_VIEW::BCC"},aTabsValues={'to':me.to._value(),'cc':me.cc._value(),'bcc':me.bcc._value()};}
switch(this._name){case'btn_to':case'lbl_to':gui._create('add_address','frm_addaddress','','',[me,'_onPopupClose'],aTabsNames,aTabsValues,'to',true,false,true);me.__bContactsOpened=true;break;case'btn_cc':case'lbl_cc':gui._create('add_address','frm_addaddress','','',[me,'_onPopupClose'],aTabsNames,aTabsValues,'cc',true,false,true);me.__bContactsOpened=true;break;case'btn_bcc':case'lbl_bcc':gui._create('add_address','frm_addaddress','','',[me,'_onPopupClose'],aTabsNames,aTabsValues,'bcc',true,false,true);me.__bContactsOpened=true;break;}}};this.btn_sms&&(this.btn_sms._onclick=btn);this.lbl_sms&&(this.lbl_sms._onclick=btn);this.lbl_to&&(this.lbl_to._onclick=btn);this.btn_to&&(this.btn_to._onclick=btn);this.lbl_cc&&(this.lbl_cc._onclick=btn);this.btn_cc&&(this.btn_cc._onclick=btn);this.lbl_bcc&&(this.lbl_bcc._onclick=btn);this.btn_bcc&&(this.btn_bcc._onclick=btn);}
if(GWOthers.getItem('GLOBAL_SETTINGS','external_contacts')){var btn_ext=function(){try{if(me.__ext_ab&&me.__ext_ab.closed===false)
me.__ext_ab.close();}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
if(!(me.__ext_ab=window.open(template.exe(GWOthers.getItem('GLOBAL_SETTINGS','external_contacts'),{"sid":dataSet.get('main',['sid']),"email":sPrimaryAccount})+'&'+buildURL({o:me._pathName,btn:({btn_to_ext:'to',btn_cc_ext:'cc',btn_bcc_ext:'bcc',btn_sms_ext:'sms'})[this._name]}),'external_contects','menubar=no,resizable=yes,status=no,location=no,width=300,height=300')))
gui.notifier._value({type:'alert',args:{header:'',text:'ALERTS::POPUP_BLOCKER'}});};if(this.btn_to_ext)
this.btn_to_ext._onclick=btn_ext;if(this.btn_cc_ext)
this.btn_cc_ext._onclick=btn_ext;if(this.btn_bcc_ext)
this.btn_bcc_ext._onclick=btn_ext;}
if(me._settings('sms')){this.sms._onsubmit=sendme;this.smsinfo._value(getLang('COMPOSE::SMS_INFO',[0,0]));this.body._onkeyup=function(){var tmp=this._value(),c,bSmall=false;if(tmp)
me._title(tmp.length>48?tmp.substr(0,48)+'...':tmp,true);else
me._title('COMPOSE::SMS');for(var i=tmp.length-1;i>-1;i--){c=tmp.charCodeAt(i);if(c!=0xA4&&inArray(GSM0338_To_Unicode_Charset,c)<0){bSmall=true;break;}}
var n=bSmall?70:160;if(tmp.length/n>1)
n=bSmall?67:153;c=Math.ceil(tmp.length/n);me.smsinfo._value((c>5?'<b>':'')+getLang('COMPOSE::SMS_INFO',[tmp.length,c])+(c>5?'</b>':''));};if(this.__message.sSMS!==true)
this.sms._value(this.__message.sSMS);this._fullbody(this.__message.sBody);this.body._onkeyup();}
else{this._fullbody(this.__message.sBody,function(){if(~['Mozilla','Safari'].indexOf(currentBrowser())){var doc=this.body._editor.el.ownerDocument;doc.getSelection().collapse(doc.body.firstChild);}
if(oMessage){if(oMessage.sTo&&!oMessage.sSubject){this.subject._focus();}else if(oMessage.sTo||(oMessage.sSMS&&oMessage.sSMS!==true)){this.body._focus(true,true);}else if(this.to){this.to._focus();}else{this.sms._focus();}}else if(this.to){this.to._focus();}else{this.sms._focus();}}.bind(this));if(GWOthers.getItem('RESTRICTIONS','disable_mailformat')==1){if(this.__message.isHtml())
this.body.select._fillLang({'enabled':"COMPOSE::HTML",'code':'RICH::CODE'});else
this.body.select._fillLang({'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});}
else
this.body.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});this.body.select._value(this.__message.isHtml()?'enabled':'disabled');this.subject._onkeyup=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>48)
sTitle=sTitle.substr(0,48)+'...';if(me._settings('template'))
sTitle+=' - '+getLang('COMPOSE::TEMPLATE');me._title(sTitle,true);}
else
if(me._settings('template'))
me._title('COMPOSE::TEMPLATE');else
me._title('COMPOSE::NEWMAIL');};this.subject._onkeyup();}
if(this.attach&&this.attach_control){this.attach._onchange=function(){var att=this._value().attachments;if(att.length){addcss(me._main,'att_list');if(me.maxsize){var isize=0;for(var i in att)
if(att[i].size)
isize+=parseInt(att[i].size,10);var q=dataSet.get('main',['message_size']),u=((isize+me.body._value().length)/1024)*1.333;me.maxsize._range(q);me.maxsize._value(u);me.maxsize._title(Math.ceil((u/q)*100)+'%');}}
else
removecss(me._main,'att_list');};if(this.__message.aAttachments&&this.__message.aAttachments.attachments.length){this.attach._value(this.__message.aAttachments);if(this._settings('smart_attach')&&this.body.select.__idTable['enabled']&&this.body.select._value()!='enabled')
this.body.select._value('enabled');}
this.body.__oUpload=this.attach_control;this.attach_control._onuploadstart=function(){if(me.x_btn_send)me.x_btn_send._disabled(true);if(me.x_btn_save)me.x_btn_save._disabled(true);if(me.x_btn_att)me.x_btn_att._disabled(true);me._create('progress','obj_upload_info','progress','bottom');};this.attach_control._onuploadprogress=function(file,a,b,xhr){me.progress._value(file.name,a,b,[function(){xhr.abort()}]);};this.attach_control._onuploadsuccess=function(){me.progress&&me.progress._handler(null);};this.attach_control._onuploadend=function(){if(me.__sa_support){if(Is.String(me._settings('smart_attach'))&&me._settings('smart_attach').indexOf('#')==0){var att=me.attach._value().attachments,isize=0;for(var i in att)
if(att[i].size)
isize+=parseInt(att[i].size,10);if(isize>(me._settings('smart_attach').substr(1)*1024)){me._settings('smart_attach','1');}}
if(me._settings('smart_attach')=='1'&&me.body.select.__idTable['enabled']&&me.body.select._value()=='disabled'&&me.attach._value()['attachments'].length>0)
me.body.select._value('enabled');}
if(me.x_btn_send)me.x_btn_send._disabled(false);if(me.x_btn_save)me.x_btn_save._disabled(false);if(me.x_btn_att)me.x_btn_att._disabled(false);me.progress&&me.progress._destruct();};this.attach_control._onremove=function(){if(me.x_btn_send)me.x_btn_send._disabled(false);if(me.x_btn_save)me.x_btn_save._disabled(false);if(me.x_btn_att)me.x_btn_att._disabled(false);};this.attach_control._dropzone(this.__eContainer,function(){return template.tmp('dropzone',{title:getLang('COMPOSE::DROP_TITLE'),body:getLang('COMPOSE::DROP_BODY')});},'item small',function(elm){elm.querySelector('.info').style.marginTop=(this._getAnchor('main').querySelector('tr').clientHeight+this.body._main.querySelector('tr').clientHeight-elm.querySelector('.info').clientHeight)/2+'px';}.bind(this));}
this._onclose=function(){if(me._destructed)return false;if(!me.__bDisableSave&&(me.__changed()||(me.__removeOnDestruct&&me.__message.__id))){setTimeout(function(){me._focus();if(!dataSet.get('main',['sid'])){try{gui._create('frm_confirm','frm_confirm','','',[me,'__confirmed'],'CONFIRMATION::EXPIRED','CONFIRMATION::EXPIRED_MSG');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}
else
if(!me.cdialog||me.cdialog._destructed){me.cdialog=gui._create('frm_confirm','frm_confirm_threestates','','',[me,'__confirmed'],'CONFIRMATION::SAVE_TITLE','CONFIRMATION::SAVE_CONFIRMATION','','CONFIRMATION::SAVE','FORM_BUTTONS::CANCEL','CONFIRMATION::DISCARD');me.cdialog._size(450,200,true);addcss(me.cdialog.x_btn_ok._main,'color1');me.cdialog.x_btn_cancel._onclick=function(){this._parent._destruct();};addcss(me.cdialog.x_btn_cancel2._main,'trash color2 x_btn_right');me.cdialog.x_btn_cancel2._onclick=function(){executeCallbackFunction([me,'__confirmed'],false);me._destruct();};}
else
me.cdialog._focus();},0);return false;}
else
return true;};this._bAutoSave=parseInt(this._aMailSettingsGeneral['VALUES']['autosave']);this._nAutoSaveInterval=parseInt(this._aMailSettingsGeneral['VALUES']['autosave_minutes'])*60000;if(this._bAutoSave&&this._nAutoSaveInterval)
this.__saveTimer=setTimeout(function(){try{this.__autoSave();}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}}.bind(this),this._nAutoSaveInterval);this._add_destructor('__onDestruct');if(oMessage){if(oMessage.sTo&&!oMessage.sSubject)
this.subject._focus();else
if(oMessage.sTo||(oMessage.sSMS&&oMessage.sSMS!==true))
this.body._focus(true,true);else
if(this.to)
this.to._focus();else
this.sms._focus();}
else
if(this.to)
this.to._focus();else
this.sms._focus();if(window.FormData&&!this._settings('sms')){this.body.__doc.addEventListener("paste",function(e){if(!me.attach_control.file.__ondropfile){return;}
var items=(e.clipboardData||(e.originalEvent||{}).clipboardData||{}).items||(window.clipboardData||{}).files||[];if([].some.call(items,function(item){return item.type==='text/html';})){return true;}
for(var i=0;i<items.length;i++){if(items[i].getAsFile&&items[i].type.indexOf('image')===0){var file=items[i].getAsFile();try{file=new File([file],'clipboard-'+new IcewarpDate()+'.png',{type:items[i].type});}catch(e){}
me.attach_control.file.__ondropfile([file],[me,'__richImage',[[e.rangeParent,e.rangeOffset]]]);}}},false);this.body.__doc.addEventListener("drop",function(e){e.stopPropagation();e.cancelBubble=true;if(e.dataTransfer.files.length>0){e.preventDefault();if(me.attach_control.file.__ondropfile){for(var b,files=[],i=0;i<e.dataTransfer.files.length;i++){b=false;if(e.dataTransfer.files[i].type.toLowerCase().indexOf('image/')===0){for(var j in me.attach.__idtable){if(e.dataTransfer.files[i].name==me.attach.__idtable[j].name&&e.dataTransfer.files[i].size==me.attach.__idtable[j].size){b=true;me.__richImage(me.attach.__idtable[j],e.dataTransfer.files[i].type,{},[e.rangeParent,e.rangeOffset]);break;}}}
if(!b)
files.push(e.dataTransfer.files[i]);}
if(files.length)
me.attach_control.file.__ondropfile(files,[me,'__richImage',[[e.rangeParent,e.rangeOffset]]]);}
return false;}},false);}
if(me.x_btn_send){this.x_btn_send._onclick=function(){me.__send(false,false,false,false,GWOthers.getItem('MAIL_SETTINGS_DEFAULT','send_undo')!='1');};this.x_btn_send._menu(function(){var arr=[];arr.push({title:'COMPOSE::SEND_NOW',arg:[function(){if(me._settings('deferred'))
me._delay_toggle();me.__send(false,false,void 0,void 0,true);}]});if(disabled.allow_delaying){arr.push({title:'COMPOSE::SEND_WITH_DELAY',arg:[function(){me._delay_toggle()}]});}
arr.push({title:'COMPOSE::SAVEINFO',arg:[function(){me.__save()}]});if(sPrimaryAccountCHAT&&me.teamchat){arr.push({title:'COMPOSE::SENDTCHAT',arg:[function(){if(me.teamchat._value()){if(!me.__bDisableSave)
me.__send(2,true);}
else{me.lbl_chat._onclick(null,[function(){if(!me.__bDisableSave&&me.teamchat._value())
me.__send(2,true);}]);}}]});}
return arr;},'compose_send_menu');}
if(this.x_btn_save)
this.x_btn_save._onclick=function(){me.__save();};if(this.x_btn_confirm){this.x_btn_confirm._onclick=function(){me._options_toggle('read_confirmation');};this.__settings.on('VALUES',['read_confirmation'],function(v){window[v=='1'?'addcss':'removecss'](this._main,'show');},this.x_btn_confirm,true);}
if(this.x_btn_delivery){this.x_btn_delivery._onclick=function(){me._options_toggle('delivery');};this.__settings.on('VALUES',['delivery'],function(v){window[v=='1'?'addcss':'removecss'](this._main,'show');},this.x_btn_delivery,true);}
if(this.x_btn_encrypt){this.x_btn_encrypt._onclick=function(){me._options_toggle('encrypt');};this.__settings.on('VALUES',['encrypt'],function(v){window[v=='1'?'addcss':'removecss'](this._main,'show');},this.x_btn_encrypt,true);}
if(this.x_btn_sign){this.x_btn_sign._onclick=function(){me._options_toggle('sign');};this.__settings.on('VALUES',['sign'],function(v){window[v=='1'?'addcss':'removecss'](this._main,'show');},this.x_btn_sign,true);}
if(this.x_btn_smart){this.x_btn_smart._onclick=function(){me._options_toggle('smart');};this.__settings.on('VALUES',['smart_attach'],function(v){window[v=='1'?'addcss':'removecss'](this._main,'show');},this.x_btn_smart,true);}
if(this.x_btn_priority){this.x_btn_priority._onclick=function(e){if(!this.cmenu||this.cmenu._destructed){e.stopPropagation&&e.stopPropagation();this.__eArrow.onclick({});}};this.x_btn_priority._main.onmousedown=function(e){if(this.cmenu&&!this.cmenu._destructed){var e=e||window.event;if(e.stopPropagation)e.stopPropagation();}}.bind(this.x_btn_priority);this.x_btn_priority._menu(function(){var arr=[{title:'EMAIL_PRIORITY::HIGH',css:'ico2 high',arg:[me,'_setPriority',[2]]},{title:'EMAIL_PRIORITY::NORMAL',css:'ico2 normal',arg:[me,'_setPriority',[3]]},{title:'EMAIL_PRIORITY::LOW',css:'ico2 low',arg:[me,'_setPriority',[4]]}];return arr;},'compose_priority_menu');this.__settings.on('VALUES',['priority'],function(v){this._main.setAttribute('iw-priority',({1:'high',2:'high',3:'',4:'low',5:'low'})[v]);this._title(getLang('SETTINGS::PRIORITY')+' - '+getLang(({1:'EMAIL_PRIORITY::HIGH',2:'EMAIL_PRIORITY::HIGH',3:'EMAIL_PRIORITY::NORMAL',4:'EMAIL_PRIORITY::LOW',5:'EMAIL_PRIORITY::LOW'})[v]),true);},this.x_btn_priority,true);}
if(this.x_btn_options){this.x_btn_options._onclick=function(){me._options_toggle();};if(this.read_confirmation){this.read_confirmation._onchange=function(){this._settings('read_confirmation',this.read_confirmation._value()?'1':'0');}.bind(this);this.__settings.on('VALUES','read_confirmation',function(v){this._value(v);},this.read_confirmation);}
if(this.sign){this.sign._onchange=function(){this._settings('sign',this.sign._value().toString());}.bind(this);this.__settings.on('VALUES','sign',function(v){this._value(v);},this.sign);}
if(this.encrypt){this.encrypt._onchange=function(){this._settings('encrypt',this.encrypt._value().toString());}.bind(this);this.__settings.on('VALUES','encrypt',function(v){this._value(v);},this.encrypt);}}
setTimeout(function(){if(!this.__message||!this.__message.ask_on_close)
this.__rememberState();}.bind(this),200);[].forEach.call(this._main.querySelectorAll('.toggle'),function(el){el.addEventListener('click',function(e){var toggle=e.target.getAttribute('data-toggle'),elm=me._main.querySelector('div.'+toggle);if(elm.classList.contains('extended')){elm.classList.remove('extended');if(toggle=='chat_message')
addcss(me._main.querySelector('div.toggle.teamchat'),'nodot');}else{elm.classList.add('extended');if(toggle=='chat_message')
removecss(me._main.querySelector('div.toggle.teamchat'),'nodot');}
if(toggle=='chat_message'&&me.teamchat_message._disabled()==false)
me.teamchat_message._focus();});});[(this.to||this.sms),this.cc,this.bcc,this.teamchat].forEach(function(obj){if(obj){obj._main.addEventListener('click',function(e){me._layout_maximize();});obj._main.addEventListener('keyup',function(e){me._layout_maximize();});}});var eBodyElm=this._settings('sms')?gui.frm_compose.body._getFocusElement():this.body.__doc;eBodyElm.addEventListener('keyup',function(e){me._layout_minimize();});eBodyElm.addEventListener('click',function(e){me._layout_minimize();});};_me._options_toggle=function(){if(hascss(this.x_btn_options._main,'active')){removecss(this._getAnchor('options'),'show');removecss(this.x_btn_options._main,'active');removecss(this._main,'mask_option');}
else{addcss(this._main,'mask_option');var aInitValues=this._settings();if(this.read_confirmation){this.read_confirmation._value(aInitValues['read_confirmation']);}
if(this.encrypt){this.encrypt._value(aInitValues['encrypt']);}
if(this.sign){this.sign._value(aInitValues['sign']);}
if(this.reply_to_address){this.reply_to_address._value(aInitValues['reply_to_address']);this.reply_to_address._placeholder(sPrimaryAccount);}
this.mode_select._fill(this.body.select.__idTable);if(!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message')&&'0'===GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')){this.mode_select._value('disabled');}
this.mode_select._onchange=function(){this.body.select._value(this.mode_select._value());}.bind(this);this.body.select._onchange=function(){this.mode_select._value(this.body.select._value(),true);}.bind(this);this.body.select._onchange();if(aInitValues['save_sent_message']==1)
this.sent._value(aInitValues['sent']||GWOthers.getItem('DEFAULT_FOLDERS','sent'));else
this.sent._value('*');this.spellchecker._value(aInitValues['spellchecker']||GWOthers.getItem('MAIL_SETTINGS_DEFAULT','spellchecker'));this._getAnchor('close_options').onclick=function(){this._options_toggle();}.bind(this);addcss(this._getAnchor('options'),'show');addcss(this.x_btn_options._main,'active');}};_me._delay_toggle=function(){if(hascss(this._getAnchor('delay'),'show')){removecss(this._getAnchor('delay'),'show');removecss(this._main,'mask_delay');this.x_btn_send._value('COMPOSE::SEND');delete(this.__message.sDeferred);this._settings('deferred',0);}
else{if(hascss(this.x_btn_options._main,'active'))
this._options_toggle();addcss(this._main,'mask_delay');if(!this.__fixed_delay){var d=new IcewarpDate();if(this.__delay){d.add(this.__delay,'minutes');}
else{if(d.minute()<30){d.minute(30);}
else{d.minute(0);d.add(1,'hours');}}
this.delay_time._value((d.hour()*60+d.minute())*60000,true);this.delay_date._value(d.format(IcewarpDate.JULIAN));}
this._getAnchor('close_delay').onclick=function(){this._delay_toggle();}.bind(this);addcss(this._getAnchor('delay'),'show');this.x_btn_send._value('COMPOSE::SEND_WITH_DELAY');this._settings('deferred',1);}};_me._settings=function(key,val){if(Is.String(key))
key=[key];if(Is.Defined(val)){this.__settings.add('VALUES',key,val);return val;}
else
return this.__settings.get('VALUES',key);};_me._layout_minimize=function(e){addcss(this._main,'minimize');this.__options.max=false;var a=[];if(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','show_from')!=1)
a.push(this._main.querySelector('div.box.from'));if(!this.cc._value())
a.push(this._main.querySelector('div.box.cc'));if(!this.bcc._value())
a.push(this._main.querySelector('div.box.bcc'));if(this.teamchat&&!this.teamchat._value())
a.push(this._main.querySelector('div.box.chat'));if(this.teamchat_message){a.push(this._main.querySelector('div.box.chat_message'));removecss(this._main.querySelector('div.toggle.teamchat'),'nodot');}
a.forEach(function(elm){addcss(elm,'extended')});};_me._layout_maximize=function(bFull){removecss(this._main,'minimize');var a=[];if(bFull){this.__options.max=true;a.push(this._main.querySelector('div.box.from'));}
if(bFull||this.cc._value())
a.push(this._main.querySelector('div.box.cc'));if(bFull||this.bcc._value())
a.push(this._main.querySelector('div.box.bcc'));if(this.teamchat&&(bFull||this.teamchat._value())){a.push(this._main.querySelector('div.box.chat'));if(this.teamchat_message._value()&&(bFull)){a.push(this._main.querySelector('div.box.chat_message'));addcss(this._main.querySelector('div.toggle.teamchat'),'nodot');}}
a.forEach(function(elm){removecss(elm,'extended')});};_me._setPriority=function(no){this._settings('priority',no);};_me._getSignature=function(id){var id=id||'0',aSign=dataSet.get('storage',['SIGNATURE','ITEMS']),signature='';if(id!='*')
for(var i in aSign)
if((aSign[i].VALUES.ID&&aSign[i].VALUES.ID.VALUE==id)||(id=='0'&&!aSign[i].VALUES.ID)){if(aSign[i].VALUES.TEXT){signature=aSign[i].VALUES.TEXT.VALUE;if(signature.indexOf('<')<0)
signature=signature.replace(/(\r\n)|(\n)/gm,'<br>');signature=(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','sign_separator')>0?'<div class="separator">-- </div>':'')+signature;}
break;}
return signature;};_me.__translateHTML=function(sHTML){return mkElement('div',{innerHTML:this.body.__exec('clean.html',[sHTML,true],true)},this.body.__doc).innerHTML.trim();};_me._addSignature=function(id){var signature=this._getSignature(id),elm=this.body.__doc.querySelector('div.iw-signature'),bFound=false;if(elm){if(Is.Defined(this.__message.signatureID)){var rx=/[\r\n]+|(<br>|&nbsp;)+$/g,old=this.__translateHTML(this._getSignature(this.__message.signatureID)).replace(rx,''),act=this.__translateHTML(elm.innerHTML).replace(rx,''),p;if(mkElement('div',{innerHTML:act}).textContent.replace(/\s+/g,'')==mkElement('div',{innerHTML:old}).textContent.replace(/\s+/g,'')){bFound=true;elm.innerHTML=this.__translateHTML(signature);}
else
if((p=act.lastIndexOf(old))>-1){removecss(elm,'iw-signature');if(signature.length){bFound=true;elm.innerHTML=this.__translateHTML(act.substr(0,p)+'<div class="iw-signature">'+signature+'</div>'+act.substr(p+old.length));}}
else{elm=null;}}
else{bFound=true;elm.innerHTML=this.__translateHTML(signature);}}
[].forEach.call(this.body.__doc.querySelectorAll('div.iw-signature'),function(div){if(div!==elm)
removecss(div,'iw-signature');});function isCRLF(node){return node.childNodes.length===1&&node.childNodes[0].tagName=='BR';};if(signature.length==0){if(bFound&&elm&&elm.parentNode){var tmp;if((tmp=elm.previousElementSibling)&&isCRLF(tmp))
tmp.parentNode.removeChild(tmp);if((tmp=elm.previousElementSibling)&&isCRLF(tmp))
tmp.parentNode.removeChild(tmp);if((tmp=elm.nextElementSibling)&&isCRLF(tmp)&&(!tmp.nextElementSibling||!hascss(tmp.nextElementSibling,'iw-reply-block')))
tmp.parentNode.removeChild(tmp);elm.parentNode.removeChild(elm);}}
else
if(!bFound){var quote=this.body.__doc.body.querySelector('div.iw-reply-block');if(quote){var tmp;if((tmp=quote.previousElementSibling)&&isCRLF(tmp))
tmp.insertAdjacentHTML('beforebegin',NewMessage.crlf+NewMessage.crlf+'<div class="iw-signature">'+signature+'</div>');else
quote.insertAdjacentHTML('beforebegin',NewMessage.crlf+NewMessage.crlf+'<div class="iw-signature">'+signature+'</div>'+NewMessage.crlf);}
else
this.body.__doc.body.insertAdjacentHTML('beforeend',NewMessage.crlf+NewMessage.crlf+'<div class="iw-signature">'+signature+'</div>');}
this.__message.signatureID=id;this.body._editor.size.syncIframe();this.body._focus();};_me.__richImage=function(aResponse,aFile,idtable,pos){if(aFile&&aFile.type&&aFile.type.toLowerCase().indexOf('image/')===0&&aResponse.folder&&aResponse.id){idtable.removed=true;try{this.body._focus(true);if(pos[0]){var r=this.body.__eFrame.contentWindow.getSelection().getRangeAt(0);r.setStart(pos[0],pos[1]);r.setEnd(pos[0],pos[1]);}}catch(err){gui._REQUEST_VARS.debug&&console.log(this._name||false,err)}
var src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'file','fullpath':aResponse.folder+'/'+aResponse.id});var id=+new Date();var sHTML='<img id="'+id+'" src="'+src+'" border="0">';this.body.__exec('html.insert',[sHTML,true]);if(this.body.select.__idTable['enabled'])
this.body.select._value('enabled');var image=this.body.__doc.getElementById(id);image&&image.addEventListener('load',function(e){this.body.__img_removeEdit();}.bind(this));}};_me.__genSignature=function(){var out=[],aTmp=dataSet.get('storage',['SIGNATURE','ITEMS']);for(var i in aTmp)
if(aTmp[i].VALUES.ID&&aTmp[i].VALUES.NAME)
out.push({text:aTmp[i].VALUES.NAME.VALUE,handler:[this,'_addSignature','',aTmp[i].VALUES.ID.VALUE],css:'ico2'+(this.__message.signatureID==aTmp[i].VALUES.ID.VALUE?' check':'')});if(out.length){out.push({title:'-'},{title:'SETTINGS::DEFAULT',handler:[this,'_addSignature','','0'],css:'ico2'+(!this.__message.signatureID||this.__message.signatureID=='0'?' check':'')},{title:'SIGNATURE::NONE',handler:[this,'_addSignature','','*'],css:'ico2'+(this.__message.signatureID=='*'?' check':'')});return out;}
else
return false;};_me.__onDestruct=function(){this.__saveTimer&&clearTimeout(this.__saveTimer);if(this.__removeOnDestruct&&this.__message.__id&&this.__message.__id[2])
Item.remove(makeIDSFromID(this.__message.__id),true);if(this.__message.__id_chat&&this.__message.__id_chat[2])
Item.set_lock(this.__message.__id_chat,false,false,'','M');this.__message.dispose();try{if(this.__ext_ab&&this.__ext_ab.closed===false)
this.__ext_ab.close();}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};_me.__autoSave=function(){if(this._destructed)
return;if(!this.__bDisableSave&&this.__changed())
this.__save(true);this.__saveTimer&&clearTimeout(this.__saveTimer);this.__saveTimer=setTimeout(function(){this.__autoSave&&this.__autoSave();}.bind(this),this._nAutoSaveInterval);};_me.__rememberState=function(){if(this.to)
this.__sSavedTo=this.to._value();else
this.__sSavedSMS=this.sms._value();this.__sSavedCc=this.cc._value();this.__sSavedBcc=this.bcc._value();this.__sSavedSubject=this.subject._value();this.__sSavedAtt=[];if(this.__message.aAttachments){var tmp=this.__message.aAttachments.attachments;for(var i in tmp)
this.__sSavedAtt.push(tmp[i].values||tmp[i]);}
if(this.teamchat){this.__sSavedChat=this.teamchat._value();this.__sSavedComment=this.teamchat_message._value();}
this.__sSavedBody=this.body._value();};_me.__changed=function(){try{if(this.attach){var att=this.attach._value();if(att&&(att=att.attachments)&&!arrayCompare(att,this.__sSavedAtt))
return true;}
if(this._settings('sms')){if(this.__sSavedSMS!=this.sms._value())
return true;}
else
if(this.__sSavedTo!=this.to._value())
return true;if(this.teamchat){if(this.__sSavedChat!=this.teamchat._value()||this.__sSavedComment!=this.teamchat_message._value())
return true;}
return this.__sSavedCc!=this.cc._value()||this.__sSavedBcc!=this.bcc._value()||this.__sSavedSubject!=this.subject._value()||this.__sSavedBody!=this.body._value();}
catch(e){console&&console.log('compose.__changed',e);return!this._destructed;}};_me.__confirmed=function(bSave){if(bSave)
this.__save();this.__bDisableSave=true;this._destruct();if(this.__logoutOnDestruct&&gui.frm_main)
gui.frm_main.__logout();};_me.__send=function(bSave,bKeepAttachments,bAutoSave,bSubject,bSendNow,aResponse){if(this.__bDisableSand)return;var aSettings=this.__settings.get('VALUES','',true),sRCP='';if(aSettings.sms)
sRCP=this.__message.sSMS=this.sms._value();else{if(!bSave&&!bSubject&&!this.subject._value()&&aSettings.check_subject>0){var me=this,frm=gui._create('subject','frm_confirm','','','','COMPOSE::NEWMAIL','COMPOSE::SUBJECT_EMPTY');frm.x_btn_ok._onclick=function(){me.__send(false,bKeepAttachments,bAutoSave,true,bSendNow);this._parent._destruct();};frm.x_btn_cancel._onclick=function(){me.subject._focus();this._parent._destruct();};return;}
var sAlias=getPrimaryAccountFromAddress();if(GWOthers.getItem('RESTRICTIONS','disable_personalities')!=1&&this.from)
if(this.from.__idTable[this.from._value()])
sAlias=this.from.__idTable[this.from._value()][1];else
sAlias=getPrimaryAccountFromAddress();if(aSettings.sign=='1'){var tmp,bValid=false,aEA=[],sEA='',sAliasMail=MailAddress.splitEmailsAndNames(sAlias)[0].email.toLowerCase(),aCert=dataSet.get('storage',['CERTIFICATE','ITEMS']);if(Is.Object(aCert))
for(var i in aCert)
if(aCert[i].VALUES&&aCert[i].VALUES.INFO&&aCert[i].VALUES.INFO.VALUE){tmp=XMLTools.Str2Arr(aCert[i].VALUES.INFO.VALUE).INFO[0];if(tmp.SUBJECTALTNAME&&tmp.SUBJECTALTNAME[0].VALUE)
aEA=MailAddress.splitEmailsAndNames(tmp.SUBJECTALTNAME[0].VALUE);else
if(tmp.SUBJECT&&tmp.SUBJECT[0].EMAILADDRESS&&tmp.SUBJECT[0].EMAILADDRESS[0].VALUE)
aEA=MailAddress.splitEmailsAndNames(tmp.SUBJECT[0].EMAILADDRESS[0].VALUE);else
continue;for(var j in aEA)
if(aEA[j].email){sEA=aEA[j].email.toLowerCase();if(sEA==sAliasMail){if(tmp.VALIDTO&&tmp.VALIDTO[0].VALUE&&IcewarpDate.utct(tmp.VALIDTO[0].VALUE)<(new IcewarpDate()))
continue;bValid=true;break;}}}
if(!bValid){if(bSave)
aSettings.sign=0;else{var me=this,frm=gui._create('cert','frm_confirm','','','','COMPOSE::SIGN','COMPOSE::NOSIGN');addcss(frm.x_btn_ok._main,'send');frm.x_btn_ok._value('COMPOSE::SEND');frm.x_btn_ok._onclick=function(){me._settings('sign',0);me.__send(bSave,bKeepAttachments,bAutoSave,bSubject,bSendNow);this._parent._destruct();};frm.x_btn_cancel._onclick=function(){me.subject._focus();this._parent._destruct();};return;}}}
aSettings.from=sAlias;var value=this.body.select._value();this.__message.setHtml((value==='enabled'||value==='code')?true:false);}
if(this.to)
sRCP+=this.__message.sTo=this.to._value();sRCP+=this.__message.sCc=this.cc._value();sRCP+=this.__message.sBcc=this.bcc._value();if(!bSave&&!sRCP.trim().length){var me=this,frm=gui._create('recipient','frm_confirm','','','','COMPOSE::NEWMAIL','COMPOSE::RCP_EMPTY');frm.x_btn_ok._onclick=function(){if(me._settings('sms'))
me.sms._focus();else
me.to._focus();this._parent._destruct();};addcss(frm.x_btn_ok._main,'color2');return;}
if(this.teamchat){this.__message.sTeamchat=this.teamchat._value().replace(/^\[(.+)\]$/g,'$1');this.__message.sComment=this.teamchat_message._value();}
if(this._settings('deferred')===1){bSendNow=true;if(this.__delay&&!this.__fixed_delay){var d=new IcewarpDate(new Date,{locale:'en'});d.add(this.__delay,'minutes');}
else{var now=new IcewarpDate(new Date(),{locale:'en'});var d=IcewarpDate.julian(this.delay_date._value(),this.delay_time._value()/60000,{locale:'en'});if(d.isBefore(now))
d=now;}
this.__message.sDeferred=d.format('rfc2822');}else{delete this.__message.sDeferred;}
this.__bDisableSave=true;this.__bDisableSand=true;this.__message.sSubject=this.subject._value();this.__message.sBody=this._fullbody();if(this.attach)
this.__message.aAttachments=this.attach._value();if(bSave){if((bSave==2&&!this.__message.sTeamchat)||!this.__message.save(bKeepAttachments,[this,'__messageSaved',[bAutoSave,aResponse,bSave==2]],aSettings,bSave==2)){this.__errorAlert('ALERTS::MESSAGE_NOT_SAVED');this.__bDisableSave=false;this.__bDisableSand=false;return;}
else
if(!bAutoSave&&(this._settings('template')||bSave==2))
this.__hide();}
else{if(aSettings.read_confirmation==2){this.__bDisableSand=false;var me=this,frm=gui._create('read_confirm','frm_confirm','','',null,'CONFIRMATION::CREATE_READING_CONFIRMATION_TITLE','CONFIRMATION::SEND_READING_CONFIRMATION');frm.x_btn_ok._value('COMMON::YES');frm.x_btn_ok._onclick=function(){this._disabled(true);this._parent._destruct();executeCallbackFunction([me,'__rconfirm',[true]]);};frm.x_btn_cancel._value('COMMON::NO');frm.x_btn_cancel._onclick=function(){this._disabled(true);this._parent._destruct();executeCallbackFunction([me,'__rconfirm',[false]]);};return;}
if(this.body._nightMode&&this.body._nightMode.active){this.body._nightMode.reset();}
if(bSendNow){if(this.__message.send(bKeepAttachments,[this,'__messageSent'],aSettings)){this.__hide();return true;}}else{this.__bDisableSand=false;this.__hide();this.__send(true,true,true,false,false,[function(bOK){if(bOK){if(this.__message.aAttachments&&this.__message_old&&this.__message_old.__id&&(this.__message_old.hasAttachments()||this.__message_old.hasEmbeddedAttachments())){WMItems.list({aid:this.__message.__id[0],fid:this.__message.__id[1],iid:this.__message.__id[2],values:['HAS_ATTACHMENT','HAS_EMBEDDED_ATTACHMENT','ATTACHMENTS','HTML']},'','','',[function(aData){if(aData&&(aData=aData[this.__message.__id[0]])&&(aData=aData[this.__message.__id[1]])&&(aData=aData[this.__message.__id[2]])){var draft=new OldMessage(this.__message.__id,aData);if(draft.hasEmbeddedAttachments())
this.__message.sBody=draft.getBody();if(draft.hasAttachments())
this.__message.aAttachments.attachments=draft.copyAttachments(this.__message.__id).attachments.map(function(v){return v.values;});this.__sendNotify(aSettings);}
else{this.__show();}}.bind(this)]);}
else
this.__sendNotify(aSettings);}
else{this.body.__nightMode();this.__show();}}.bind(this)]);return true;}}};_me.__sendNotify=function(aSettings){if(gui.notifier){gui.notifier._value({type:'send_message',args:{interval:5,callback:{success:function(){this.__message.send(true,[this,'__messageSent'],aSettings);},cancel:function(){this.__bDisableSand=false;this.__show();this._focus();},context:this}}});}
else{this.__message.send(true,[this,'__messageSent'],aSettings);}};_me.__rconfirm=function(b){this._settings('read_confirmation',b?1:0);this.__send();};_me.__save_recipients=function(){var rcp=(this.__message.sTo||'')+';'+(this.__message.sCc||'')+';'+(this.__message.sBcc||'');if(!rcp)return;function clean(emails){for(var i=emails.length-1;i>=0;i--){if(emails[i].email){for(j=i-1;j>=0;j--){if(emails[j].email&&emails[i].email.toLowerCase()==emails[j].email.toLowerCase()){emails.splice(i,1);break;}}}
else
emails.splice(i,1);}
return emails;};var emails=clean(MailAddress.splitEmailsAndNames(rcp).reverse());if((rcp=Cookie.get(['suggest_address']))){emails=emails.concat(MailAddress.splitEmailsAndNames(rcp));emails=clean(emails);}
emails=emails.slice(0,10);var out='';for(var i=0;i<emails.length;i++)
out+=(out.length>0?';':'')+(emails[i].email.indexOf('[')==0?emails[i].email:MailAddress.createEmail(emails[i].name,emails[i].email));Cookie.set(['suggest_address'],out);};_me.__messageSaved=function(bOK,bFirstTime,message,sError,bAutoSave,aResponse,bTeamChat){var sSavedFolder;if(this._destructed)
return;if(bOK){if(bFirstTime&&dataSet.get('folders',[message.__id[0],message.__id[1],'DEFAULT'])==='D'){var count=dataSet.get('folders',[message.__id[0],message.__id[1],'COUNT'])||0;dataSet.add('folders',[message.__id[0],message.__id[1],'COUNT'],++count);}
if(!bAutoSave){if(gui.notifier){sSavedFolder=(message.hasOwnProperty('template')&&true===message.template)?'templates':'drafts';gui.notifier._value({type:bTeamChat?'message_sent_tch':'message_saved',args:[GWOthers.getItem('DEFAULT_FOLDERS',sSavedFolder).replace(sPrimaryAccount+'/','')]});}
if(this._settings('template')||bTeamChat){this._destruct();return true;}}
this.__rememberState();if(!this.__locked&&message.__id_chat&&message.__id_chat[2]){Item.set_lock(this.__message.__id_chat,true,false,[function(bOK){this.__locked=1;}.bind(this)],'M');}
if(aResponse)
executeCallbackFunction(aResponse,true);}
else{this.__errorAlert('ALERTS::MESSAGE_NOT_SAVED',message,sError);if(aResponse)
executeCallbackFunction(aResponse,false,sError);}
if(!bAutoSave&&(this._settings('template')||bTeamChat))
this.__show();this.__bDisableSave=false;this.__bDisableSand=false;};_me.__messageSent=function(aOut,sUID,sError)
{if(this._destructed)
return;if(sUID=='imap_internal'||sUID=='save_certificate_missing'){if(sUID=='save_certificate_missing')
sError=getLang('ALERTS::SAVE_CERTIFICATE_MISSING');gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text_plain:sError}});aOut=true;}
if(aOut){this.__save_recipients();this.__removeOnDestruct=false;this._destruct();if(Is.Object(aOut)){if(sPrimaryAccountDELIVERY&&this._settings('delivery')==1)
gui._create('frm_delivery','frm_delivery','','','',aOut);}
this.__exeEvent('onsend',true,{"owner":this});}
else{this.__bDisableSave=false;this.__bDisableSand=false;this.__show();this.__errorAlert('',sUID,sError);}
return false;};_me._onPopupClose=function(bOK,aAddresses){if(bOK){if(aAddresses['sms'])
this.sms._value(aAddresses['sms'].join(', '));else{if(this.to)
this.to._value(aAddresses['to'].join(', '));if(aAddresses['cc'].length||aAddresses['bcc'].length){var elm;this.cc._value(aAddresses['cc'].join(', '));if(aAddresses['cc'].length&&(elm=this._main.querySelector('.box.extended.cc')))
removecss(elm,'extended');this.bcc._value(aAddresses['bcc'].join(', '));if(aAddresses['bcc'].length&&(elm=this._main.querySelector('.box.extended.bcc')))
removecss(elm,'extended');this.cc._tabIndex('',1);this.bcc._tabIndex('',2);if((elm=this._main.querySelector('.box.extended.subject')))
removecss(elm,'extended');this.subject._focus(true);}}}
this.__bContactsOpened=false;};_me.__contacts=function(aData){if(Is.Object(aData)){if(this.sms)
this.sms._value(aData.sms);if(this.to)
this.to._value(aData.to);if(this.cc)
this.cc._value(aData.cc);if(this.bcc)
this.bcc._value(aData.bcc);}
else{var out={};if(this.sms)
out.sms=this.sms._value();if(this.to)
out.to=this.to._value();if(this.cc)
out.cc=this.cc._value();if(this.bcc)
out.bcc=this.bcc._value();return out;}};_me.__errorAlert=function(sTitle,sUID,sError){var sErrOut;if(sUID){sUID=sUID.toUpperCase();switch(sUID){case'FOLDER_INSUFFICIEND_RIGHTS':case'DEFAULT_FOLDER_MISSING':case'DISTRIBUTION_LIST_INVALID_ID':case'SMTP_FROM_FAILED':case'SMTP_RECIPIENTS_FAILED':case'SMTP_DATA_NOT_ACCEPTED':case'PERSONAL_CERTIFICATE':case'NO_RECIPIENT_CERTIFICATE':case'RECIPIENT_CERTIFICATE_EXPIRED':sErrOut=getLang('ALERTS::'+sUID);break;}}
if(sError)
sErrOut=(sErrOut?sErrOut+"\n":'')+sError.unescapeHTML();if(!sErrOut)
sErrOut=getLang('ALERTS::MAILINGFAILED')+(sUID?' ('+sUID+')':'');if(gui[this._name+'_error'])
gui[this._name+'_error']._destruct();gui.notifier._value({type:'alert',args:{header:sTitle||'ALERTS::MESSAGE_NOT_SENT',text_plain:sErrOut}});};_me.__save=function(bAutoSave){if(!this._destructed){if(!bAutoSave)
this.__removeOnDestruct=false;if(!this.__bDisableSave&&this.__changed())
this.__send(true,true,bAutoSave);return true;}};_me._ondock=function(){return{css:this._settings('sms')?'sms':''};};_me._fullbody=function(v,callback){var isSms=this._settings('sms');if(Is.Defined(v)){if(isSms){this.body._value(v.removeTags());return;}
this.body._value(v.replace(/<p[^>]*?>(&nbsp;)?<\/p>/g,''),false,false,function(){[].forEach.call(this.body.__doc.querySelectorAll('span[iw-to="'+sPrimaryAccount+'"]'),function(elm){elm.style.display='none';});csstool.prefix('.iw-reply-block',this.body.__doc,{tagOnly:true,removeIW:true});callback&&callback();}.bind(this));}
else if(isSms){return this.body._value();}
else{var html=this.body._value(null,false,true);if(this.__message.isHtml())
html=DOMPurify.sanitize(html);var div=mkElement('div',{innerHTML:html}),newStyle=mkElement('style',{type:"text/css"});csstool.copy(this.body.__doc,newStyle,{useIW:true,skipIW:true});div.insertBefore(newStyle,div.firstChild||null);return div.innerHTML;}};

/* client/inc/frm_confirm.js */
_me=frm_confirm.prototype;function frm_confirm(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution){var me=this;this._size(400,200,true);this._resizable(false);this._dockable(false);this._modal(true);this._draw('frm_confirm','main');this.obj_label._onchange=function(elm){me._size(400,this._main.offsetHeight+120,true);};if(sLabel1)this._title(sLabel1);if(sLabel2)
this.obj_label._value(getLang(sLabel2,aSubstitution));else
if(aSubstitution)
this.obj_label._value(aSubstitution);this._create('x_btn_ok','obj_button','footer','ok color1 noborder');this.x_btn_ok._tabIndex();this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){this._disabled(true);executeCallbackFunction(aResponse);me._destruct();};this._create('x_btn_cancel','obj_button','footer','cancel noborder');this.x_btn_cancel._tabIndex();this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct()};this.x_btn_ok._focus();};

/* client/inc/frm_confirm_repeating.js */
_me=frm_confirm_repeating.prototype;function frm_confirm_repeating(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution,bNoFollowing,sButton1Label,sButton2Label){this._draw('frm_confirm','main');var me=this;this._size(350,300,true);this._resizable(false);this._dockable(false);this._modal(true);if(sLabel1)this._title(sLabel1);if(sLabel2)this.obj_label._value(getLang(sLabel2,aSubstitution));this._create('btn_0','obj_button','footer','button1 color1 max');this.btn_0._tabIndex();this.btn_0._value(sButton1Label||'REPEATING_CONFIRM::BTN_THIS');this.btn_0._onclick=function(){executeCallbackFunction(aResponse,0);me._remove_destructor('_onclose');me._destruct();}
if(!bNoFollowing){this._create('btn_1','obj_button','footer','button3 max');this.btn_1._tabIndex();this.btn_1._value('REPEATING_CONFIRM::BTN_ALLFROMNOW');this.btn_1._onclick=function(){executeCallbackFunction(aResponse,2);me._remove_destructor('_onclose');me._destruct();}}
this._create('btn_2','obj_button','footer','button2 max');this.btn_2._tabIndex();this.btn_2._value(sButton2Label||'REPEATING_CONFIRM::BTN_ALL');this.btn_2._onclick=function(){executeCallbackFunction(aResponse,1);me._remove_destructor('_onclose');me._destruct();}
this.btn_0._focus();};

/* client/inc/frm_confirm_select.js */
_me=frm_confirm_select.prototype;function frm_confirm_select(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution,aFill,sDefault,bCompulsory){var me=this;this._create('select','obj_select','message');this.select._fill(aFill);if(sDefault)
this.select._value(sDefault);this.select._onchange=function(){me.x_btn_ok._disabled(false);}
this._size(400,this._getAnchor('message').offsetHeight+82+30,true);if(bCompulsory)
me.x_btn_ok._disabled(true);this.x_btn_ok._onclick=function(){this._disabled(true);me.select._disabled(true);executeCallbackFunction(aResponse,me.select._value());me._destruct();};this.x_btn_cancel._onclick=function(){me._destruct();}
this.x_btn_ok._onkeypress=this.x_btn_cancel._onkeypress=function(e){if(e.keyCode==27)
this._onclick();};this.x_btn_ok._focus();};

/* client/inc/frm_confirm_suppress.js */
_me=frm_confirm_suppress.prototype;function frm_confirm_suppress(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution){var aPath;if(sLabel2&&sLabel2.indexOf('::')){this.obj_label._value(getLang(sLabel2,aSubstitution));aPath=sLabel2.toLowerCase().split('::');}
else
return false;this._create('conceal','obj_checkbox','message','','CONFIRMATION::SUPPRESS');this.conceal._onclick=function(e){Cookie.set(['suppressed',aPath[0],aPath[1]],this._value()?0:1);};this._size(400,this._getAnchor('message').offsetHeight+120,true);};

/* client/inc/frm_confirm_threestates.js */
_me=frm_confirm_threestates.prototype;function frm_confirm_threestates(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution,sOKLabel,sCancelLabel,sCancel2Label){var me=this;this.x_btn_ok._value(sOKLabel||'');this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse,true);me._destruct();};this.x_btn_cancel._value(sCancelLabel||'');this.x_btn_cancel._onclick=function(){executeCallbackFunction(aResponse,false);me._destruct();};this._create('x_btn_cancel2','obj_button','footer','noborder simple cancel');this.x_btn_cancel2._tabIndex();this.x_btn_cancel2._value(sCancel2Label||'FORM_BUTTONS::CANCEL');this.x_btn_cancel2._onclick=function(){me._destruct()};};

/* client/inc/frm_contact.js */
_me=frm_contact.prototype;function frm_contact(){};_me.__constructor=function(){this._defaultSize(-1,-1,650,620);this._draw('frm_contact','main',{sort_as:GWOthers.getItem('RESTRICTIONS','sortstring')=='1',disable_html:!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message')&&'0'===GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')});if(this._sFolderID=='@@mycard@@'){this.__initForm('MAIN_MENU::VCARD');if(this.x_btn_delete)
this.x_btn_delete._destruct();}
else
this.__initForm('CONTACT::CONTACT');this.maintab.tab1.ITMCATEGORY.input._onChange=function(){this.__refreshView=true;}.bind(this);};_me.__print=function(aValues){var atmp,ainf=['LCTSTREET','LCTCITY','LCTSTATE','LCTCOUNTRY','LCTZIP','LCTWEBPAGE'];if(aValues.LOCATIONS)
for(var i in aValues.LOCATIONS){if(aValues.LOCATIONS[i].values.LCTTYPE=='H'){aValues.values=objConcat(aValues.values,aValues.LOCATIONS[i].values);aValues.values.PHONES=[];for(var j in aValues.LOCATIONS[i].values)
if(j.indexOf('LCTPHN')==0&&aValues.LOCATIONS[i].values[j])
aValues.values.PHONES.push({PHNTYPE:getLang('PHONE::'+j),PHNNUMBER:aValues.LOCATIONS[i].values[j]});}
atmp={};for(var j in ainf)
if(aValues.LOCATIONS[i].values[ainf[j]])
atmp[ainf[j]]=aValues.LOCATIONS[i].values[ainf[j]];if(!Is.Empty(atmp))
aValues.values[aValues.LOCATIONS[i].values.LCTTYPE]=atmp;}
aValues=aValues.values;if(!gui.print)
gui._create('print','frm_print');gui.print._add('C',aValues);};_me.__showAvatar=function(sType,sPath){var me=this,sURL='./server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':sType,'fullpath':sPath,'no':unique_id()}),img=new Image();img.onload=function(){var elm=document.getElementById(me.maintab.tab1._pathName+'#avatar_image');if(elm){if(currentBrowser()=='MSIE7'){addcss(elm,'msie');var span=elm.getElementsByTagName('SPAN');if(span&&span[0])
span[0].parentNode.removeChild(span[0]);}
if(this.height>10&&this.width>10){if(currentBrowser()=='MSIE7'){var img=mkElement('img'),span=mkElement('span');span.style.width=elm.clientWidth+'px';span.style.height=elm.clientHeight+'px';span.appendChild(img);if(this.width>this.height){var r=this.height/elm.clientHeight;img.style.height=elm.clientHeight+'px';if((this.width/r)>elm.clientWidth)
img.style.right=(((this.width/r)-elm.clientWidth)/2)+'px';}
else{var r=this.width/elm.clientWidth;img.style.width=elm.clientWidth+'px';if((this.height/r)>elm.clientHeight)
this.style.bottom=(((this.height/r)-elm.clientHeight)/2)+'px';}
img.src=sURL;elm.style.backgroundImage='none';elm.insertBefore(span,elm.firstChild);}
else
elm.style.backgroundImage='url("'+sURL+'")';elm.style.backgroundColor='#FFFFFF';addcss(elm,'removable');me.maintab.tab1.X_AVATAR._main.style.display='none';elm.title=getLang('POPUP_ITEMS::DELETE');}
else{elm.style.backgroundImage='';elm.style.backgroundColor='';removecss(elm,'removable');me.maintab.tab1.X_AVATAR._main.style.display='block';elm.title="";}}};img.src=sURL;};_me.__loadItems=function(){if(!this.maintab)return;var me=this;var oTabs=this.maintab;if(Is.Defined(this._aValues['LOCATIONS'])){var aLocation;var aLocations=this._aValues['LOCATIONS'];for(var i in aLocations){aLocation=aLocations[i];switch(aLocation['values']['LCTTYPE']){case'H':this._sHomeLocation=aLocation;break;case'O':this._sOtherLocation=aLocation;break;case'B':this._sBusinessLocation=aLocation;break;}
if(aLocation['values']['LCT_ID'])
aLocation['uid']=i;}}
loadDataIntoForm(oTabs.tab1,this._aValues);oTabs.tab1.X_NAME._value(createNameFromLocation(this._aValues));oTabs.tab1.X_NAME._onblur=function(){me.__genClassifyAs();};oTabs.tab1.ITMCOMPANY._onkeyup=function(e){if((e.which||e.keyCode)!=9)
me.__genClassifyAs();};oTabs.tab1.X_BTN_NAME._onclick=function(){gui._create('frm_name','frm_name','','',oTabs.tab1.X_NAME,me._aValues);};oTabs.tab1.ITMCLASSIFYAS._onblur=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>32)
sTitle=sTitle.substr(0,32)+'...';if(me._sFolderID!='@@mycard@@')
me._title(sTitle+(me._aValues.ITMFOLDER?' - '+me._aValues.ITMFOLDER:''),true);}
else
if(me._sFolderID!='@@mycard@@')
me._title(getLang('CONTACT::CONTACT')+(me._aValues.ITMFOLDER?' - '+me._aValues.ITMFOLDER:''),true);};this.__genClassifyAs(oTabs.tab1.ITMCLASSIFYAS._value()?true:false);oTabs.tab1.ITMCLASSIFYAS._onblur();var av=document.getElementById(this.maintab.tab1._pathName+'#avatar_image');if(currentBrowser()=='MSIE7')
addcss(av,'msie');if(!this.__readonly){addcss(av,'enabled');oTabs.tab1.X_AVATAR._setFileTypes('image/*','');oTabs.tab1.X_AVATAR._setPostParam('resize',1);oTabs.tab1.X_AVATAR._setPostParam('width',800);oTabs.tab1.X_AVATAR._setPostParam('height',800);oTabs.tab1.X_AVATAR._onuploadstart=function(){me.x_btn_ok._disabled(true);me._create('image_processing','obj_loader');me.image_processing._value(getLang('COMMON::PROCESSING'));};oTabs.tab1.X_AVATAR._onuploadend=function(arg){me.x_btn_ok._disabled(false);if(me.image_processing){me.image_processing._destruct();}
if(arg&&(arg=arg[arg.length-1])&&arg.folder&&arg.id){me.__showAvatar('file',arg.folder+'/'+arg.id);me.__avatarChanged=true;}};av.onmousemove=function(e){var e=e||window.event,elm=me.maintab.tab1.X_AVATAR._main,pos=getSize(this);x=e.clientX-pos.x-7,y=e.clientY-pos.y-7;if(x<0)
x=0;else
if(x>pos.w)
x=pos.w;if(y<0)
y=0;else
if(y>pos.h)
y=pos.h;elm.style.left=x+'px';elm.style.top=y+'px';};av.onclick=function(e){var elm=document.getElementById(me.maintab.tab1._pathName+'#avatar_image');if(hascss(elm,'removable')){var conf=gui._create('delete_avatar_confirm','frm_confirm','','',[me,function(){var img=elm.getElementsByTagName('IMG');for(var i=img.length-1;i>=0;i--)
img[i].parentNode.removeChild(img[i]);elm.style.backgroundImage='';elm.style.backgroundColor='';this.maintab.tab1.X_AVATAR._main.style.display='block';removecss(elm,'removable');elm.title="";me.__avatarDeleted=true;me.__avatarChanged=false;oTabs.tab1.X_AVATAR._reset(true);}],'POPUP_ITEMS::CONTACTS','CONFIRMATION::DELETE_AVATAR');addcss(conf.x_btn_ok._main,'color2');}};oTabs.tab1.X_AVATAR._dropzone(oTabs.tab1._main);}
if(Is.Defined(me._aValues['ATTACHMENTS']))
for(var i in me._aValues['ATTACHMENTS'])
if(me._aValues['ATTACHMENTS'][i].values.ATTTYPE=='P'){this.__showAvatar('attachment',me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID)+'/'+i);break;}
var loc={'LCTPHNWORK1':'X_PHONE1','LCTPHNHOME1':'X_PHONE2','LCTPHNFAXWORK':'X_PHONE3','LCTPHNMOBILE':'X_PHONE4'};loc_used=[];for(var name in loc){oTabs.tab1[loc[name]]._value(name);oTabs.tab1[loc[name]]._listen(this._pathName,['phones']);}
if(Is.Defined(this._sHomeLocation)){if(Is.Defined(this._sHomeLocation['values']['LCTEMAIL1']))
oTabs.tab1.X_EMAIL1._value(this._sHomeLocation['values']['LCTEMAIL1']);if(Is.Defined(this._sHomeLocation['values']['LCTEMAIL2']))
oTabs.tab1.X_EMAIL2._value(this._sHomeLocation['values']['LCTEMAIL2']);if(Is.Defined(this._sHomeLocation['values']['LCTEMAIL3']))
oTabs.tab1.X_EMAIL3._value(this._sHomeLocation['values']['LCTEMAIL3']);for(var name in loc){if(Is.Defined(this._sHomeLocation['values'][name])){delete loc[name];loc_used.push(name);}}
var k=Object.keys(loc);for(var sPhnName in this._sHomeLocation.values)
if(sPhnName.indexOf('LCTPHN')===0&&this._sHomeLocation.values[sPhnName]){dataSet.add(this._pathName,['phones',sPhnName],this._sHomeLocation.values[sPhnName]);if(k.length&&loc_used.indexOf(sPhnName)==-1){oTabs.tab1[loc[k.shift()]]._value(sPhnName);}}}
this._obeyEvent('destructed',[function(){dataSet.remove(me._pathName,null,true);}]);if(this.__readonly)
oTabs.tab1._readonly();else{oTabs.tab1._onactive=function(){this.X_NAME._focus();};oTabs.tab1.X_NAME._focus();}
oTabs.tab2._onactive=function(bFirstTime){if(bFirstTime){loadDataIntoForm(this,me._aValues);if(Is.Defined(me._sHomeLocation)){this.X_HOME_ADDRESS._value(me._sHomeLocation);if(Is.Defined(me._sHomeLocation['values']['LCTWEBPAGE']))
this.X_HOMEPAGE._value(me._sHomeLocation['values']['LCTWEBPAGE']);}
if(Is.Defined(me._sOtherLocation)){this.X_OTHER_ADDRESS._value(me._sOtherLocation);if(Is.Defined(me._sOtherLocation['values']['LCTWEBPAGE']))
this.X_HOMEPAGE2._value(me._sOtherLocation['values']['LCTWEBPAGE']);}}
if(me.__readonly){this._readonly();this.ITMGENDER._disabled(true);}
else
this.X_HOME_ADDRESS._focus();};oTabs.tab3._onactive=function(bFirstTime){if(bFirstTime){loadDataIntoForm(this,me._aValues);if(Is.Defined(me._sBusinessLocation)){this.X_OFFICE_ADDRESS._value(me._sBusinessLocation);if(Is.Defined(me._sBusinessLocation['values']['LCTWEBPAGE']))
this.X_WEB._value(me._sBusinessLocation['values']['LCTWEBPAGE']);}}
if(me.__readonly)
this._readonly();else
this.ITMPROFESSION._focus();};oTabs.tab4._onactive=function(bFirstTime){if(bFirstTime){this.ITMDESCRIPTION.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});if(gui._rtl||!me._aValues||!me._aValues.ITMDESCFORMAT||me._aValues.ITMDESCFORMAT.toLowerCase()!='text/plain')
this.ITMDESCRIPTION.select._value('enabled');else
this.ITMDESCRIPTION.select._value('disabled');this.ITMDESCRIPTION._onesc=function(){me._close(true);};loadDataIntoForm(this,me._aValues);}
if(me.__readonly)
this._readonly();else
this.ITMDESCRIPTION._focus();};if(oTabs.tab5)
oTabs.tab5._onactive=function(bFirstTime){if(bFirstTime){if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});if(me._aValues.fullpath)
this.X_ATTACHMENTS._value({'values':out});else
this.X_ATTACHMENTS._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID),'values':out});}
else
if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}
this.X_ATTACHMENTS._onuploadstart=function(){me.x_btn_ok._disabled(true);};this.X_ATTACHMENTS._onuploadend=function(){me.x_btn_ok._disabled(false);};if(me.__readonly)
this._readonly();else
this.X_ATTACHMENTS.file._dropzone(this._main);}};if(oTabs.tab6)
oTabs.tab6._onactive=function(bFirstTime){if(bFirstTime){if(Is.Defined(me._aValues['CERTIFICATES'])){var tmp,aCerts=[];for(var i in me._aValues['CERTIFICATES']){if(me._aValues['CERTIFICATES'][i].values.INFO){tmp=XMLTools.Str2Arr(me._aValues['CERTIFICATES'][i].values.INFO).INFO[0];aCerts.push({'id':i,'name':(tmp.SUBJECT[0].CN?tmp.SUBJECT[0].CN[0].VALUE:(tmp.SUBJECT[0].EMAILADDRESS?tmp.SUBJECT[0].EMAILADDRESS[0].VALUE:'')),'class':'attachment','expires':tmp.VALIDTO[0].VALUE,'serial':tmp.SERIALNUMBER?tmp.SERIALNUMBER[0].VALUE:'','data':tmp});}
else
if(me._aValues['CERTIFICATES'][i].values['class']=='item'){aCerts.push({'id':i,'name':getLang('MAIL_VIEW::CERTIFICATE'),'class':'item','fullpath':me._aValues['CERTIFICATES'][i].values.fullpath});}}
this.X_CERT._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+me._sItemID,'values':aCerts});}
if(me.__readonly)
this._readonly();else
this.X_CERT.file._dropzone(this._main);}};var mandatory=GWOthers.getItem('GLOBAL_SETTINGS','mandatory_contact_fields');if(this._sFolderID=='@@mycard@@'&&mandatory&&GWOthers.getItem('RESTRICTIONS','mandatory_user_info')=='1'&&Cookie.get(['suppressmandatory'])!=1){this.__mandatoryfields=[];var checkall=function(error){me.x_btn_ok._disabled(true);var tabs={};for(var i=me.__mandatoryfields.length;i;i--){var tab=me.__mandatoryfields[i-1]._parent._type=='obj_tab'?me.__mandatoryfields[i-1]._parent:me.__mandatoryfields[i-1]._parent._parent;if(hascss(me.__mandatoryfields[i-1]._main,"error")){tabs[tab._name]=tab._main;error=true;}
for(var t in mandatory)
oTabs[t]._incorrect(false);for(var t in tabs)
oTabs[t]._incorrect(true);if(!error)
me.x_btn_ok._disabled(false);}
return error;};if(mandatory.indexOf('(')!=-1){var tmp=mandatory.split(';');mandatory={};for(var i=tmp.length;i;i--){var m=tmp[i-1].match(/^(tab[0-9]+)\((.+)\)$/i);mandatory[m[1]]=m[2].toUpperCase().split(',');}}else
mandatory={tab1:mandatory.toUpperCase().split(',')};for(var tab in mandatory){this.maintab[tab]._active();for(var i=mandatory[tab].length;i;i--){var field=mandatory[tab][i-1];if(field.indexOf('_')!=-1){field=field.split('_');field=oTabs[tab]['X_'+field[0]+'_ADDRESS']['LCT'+field[1]];}else
field=oTabs[tab][field]||oTabs[tab]["X_"+field]||oTabs[tab]["ITM"+field];if(field){this.__mandatoryfields.unshift(field);field._onerror=checkall;if(field._restrict)
field._restrict(".+");else console.warn("No restrict!",tab,field);}}}}
if(me._aValues['PUSH_ATTACHMENTS']&&this.maintab.tab5)
this.maintab.tab5._active();};_me.__genClassifyAs=function(bNoValue){var tab1=this.maintab.tab1,aValues={},aFill={};if(createNameFromLocation(this._aValues)==tab1.X_NAME._value()){aValues.ITMFIRSTNAME=this._aValues.ITMFIRSTNAME;aValues.ITMMIDDLENAME=this._aValues.ITMMIDDLENAME;aValues.ITMSURNAME=this._aValues.ITMSURNAME;}
else
parseNameToLocation(tab1.X_NAME._value(),aValues);aValues.ITMCLASSIFYAS=createNameFromLocation({ITMFIRSTNAME:aValues.ITMFIRSTNAME,ITMMIDDLENAME:aValues.ITMMIDDLENAME,ITMSURNAME:aValues.ITMSURNAME});var tmp=(aValues.ITMSURNAME||'');if(aValues.ITMFIRSTNAME||aValues.ITMMIDDLENAME){tmp+=(tmp?', ':'')+(aValues.ITMFIRSTNAME||'');if(aValues.ITMMIDDLENAME)
tmp+=(aValues.ITMFIRSTNAME?' ':'')+aValues.ITMMIDDLENAME;}
if(tmp)
aFill[tmp]=tmp;else
tmp='';if(aValues.ITMCLASSIFYAS)
aFill[aValues.ITMCLASSIFYAS]=aValues.ITMCLASSIFYAS;if(tab1.ITMCOMPANY._value()){aFill[tmp+' ('+tab1.ITMCOMPANY._value()+')']=tmp+' ('+tab1.ITMCOMPANY._value()+')';aFill[tab1.ITMCOMPANY._value()+(tmp?' ('+tmp+')':'')]=tab1.ITMCOMPANY._value()+(tmp?' ('+tmp+')':'');}
if(bNoValue){tab1.ITMCLASSIFYAS._fill(aFill);}
else{var f=Object.keys(tab1.ITMCLASSIFYAS.__idTable).indexOf(tab1.ITMCLASSIFYAS._value());tab1.ITMCLASSIFYAS._fill(aFill);var k=Object.keys(tab1.ITMCLASSIFYAS.__idTable),v=k[0];if(~f&&Is.Defined(k[f]))
v=k[f];tab1.ITMCLASSIFYAS._value(v);tab1.ITMCLASSIFYAS._onblur();}};_me.__saveItems=function(aValues){var tab1=this.maintab.tab1,tab2=this.maintab.tab2,tab3=this.maintab.tab3,tab4=this.maintab.tab4,tab5=this.maintab.tab5,tab6=this.maintab.tab6,aHome,aOther,aBusiness,tmpClassifyAs=aValues.values.ITMCLASSIFYAS;if(tab4&&tab4._wasActivated){aValues.values.ITMDESCFORMAT=tab4.ITMDESCRIPTION.select._value()==='disabled'?'text/plain':'text/html';tab4.ITMDESCRIPTION.__output_format=aValues.values.ITMDESCFORMAT!=='text/plain';aValues.values.ITMDESCRIPTION=tab4.ITMDESCRIPTION._value();}
if(createNameFromLocation(this._aValues)==tab1.X_NAME._value()){aValues.values.ITMTITLE=this._aValues.ITMTITLE;aValues.values.ITMFIRSTNAME=this._aValues.ITMFIRSTNAME;aValues.values.ITMMIDDLENAME=this._aValues.ITMMIDDLENAME;aValues.values.ITMSURNAME=this._aValues.ITMSURNAME;aValues.values.ITMSUFFIX=this._aValues.ITMSUFFIX;}
else
parseNameToLocation(tab1.X_NAME._value(),aValues.values);aValues.values.ITMCLASSIFYAS=tmpClassifyAs||createNameFromLocation(aValues.values);if(Is.Defined(tab2.X_HOME_ADDRESS)){aHome=tab2.X_HOME_ADDRESS._value();aHome['values']['LCTWEBPAGE']=tab2.X_HOMEPAGE._value();aOther=tab2.X_OTHER_ADDRESS._value();aOther['values']['LCTWEBPAGE']=tab2.X_HOMEPAGE2._value();}
else{if(Is.Defined(this._sHomeLocation))
aHome=this._sHomeLocation;else
aHome={'values':{}};if(Is.Defined(this._sOtherLocation))
aOther=this._sOtherLocation;else
aOther={'values':{}};}
if(Is.Defined(tab3.X_OFFICE_ADDRESS)){aBusiness=tab3.X_OFFICE_ADDRESS._value();aBusiness['values']['LCTWEBPAGE']=tab3.X_WEB._value();}
else{if(Is.Defined(this._sBusinessLocation))
aBusiness=this._sBusinessLocation;else
aBusiness={'values':{}};}
aHome['values']['LCTEMAIL1']=tab1.X_EMAIL1._value();aHome['values']['LCTEMAIL2']=tab1.X_EMAIL2._value();aHome['values']['LCTEMAIL3']=tab1.X_EMAIL3._value();aHome['values']['LCTIM']=tab1.X_IM1._value();var aPhones=dataSet.get(this._pathName,['phones']);for(var s in aPhones)
aHome['values'][s]=aPhones[s];var aLocations=[],bIsHome=false;if(!isFormEmpty(aHome)){aHome['values']['LCTTYPE']='H';aLocations.push(aHome);bIsHome=true;}
if(!isFormEmpty(aBusiness)){if(!Is.Empty(aPhones))
for(var s in aPhones)
aBusiness['values'][s]='';aBusiness['values']['LCTTYPE']='B';aLocations.push(aBusiness);}
if(!isFormEmpty(aOther)){if(!Is.Empty(aPhones))
for(var s in aPhones)
aOther['values'][s]='';aOther['values']['LCTTYPE']='O';aLocations.push(aOther);}
if(aLocations.length){if(!bIsHome)
aLocations.push({values:{LCTTYPE:'H'}});aValues['LOCATIONS']=aLocations;}
var aAttachments;if(tab5&&tab5.X_ATTACHMENTS&&!Is.Empty(aAttachments=tab5.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=aAttachments;if(tab1.X_AVATAR&&(this.__avatarChanged||this.__avatarDeleted)){for(var i in this._aValues['ATTACHMENTS'])
if(this._aValues['ATTACHMENTS'][i].values.ATTTYPE=='P'){if(!aValues['ATTACHMENTS'])
aValues['ATTACHMENTS']=[];aValues['ATTACHMENTS'].push({uid:i});break;}
aAttachments=tab1.X_AVATAR._value();if(!Is.Empty(aAttachments)&&aAttachments.values.length){if(!aValues['ATTACHMENTS'])
aValues['ATTACHMENTS']=[];aAttachments=aAttachments.values[aAttachments.values.length-1];aValues['ATTACHMENTS'].push({values:{"class":'image',description:aAttachments.name,fullpath:aAttachments.folder+'/'+aAttachments.id}});}}
if(tab6){if(tab6.X_CERT){var v;if(!Is.Empty(v=tab6.X_CERT._value())&&count(v)>0){aValues['CERTIFICATES']=[];var tmp;for(var i in v)
if(v[i].uid)
aValues['CERTIFICATES'].push(v[i]);else
if(v[i].fullpath){tmp={'values':{'class':v[i]['class']||'file','fullpath':v[i].fullpath}};if(v[i].passphrase)
tmp.values.PASSPHRASE=v[i].passphrase;aValues['CERTIFICATES'].push(tmp);}}}
else
if(this._aValues['CERTIFICATES'])
for(var i in this._aValues['CERTIFICATES'])
if(this._aValues['CERTIFICATES'][i].values['class']=='item'){if(!aValues['CERTIFICATES'])
aValues['CERTIFICATES']=[];aValues['CERTIFICATES'].push(this._aValues['CERTIFICATES'][i]);}}
if(GWOthers.getItem('RESTRICTIONS','mandatory_user_info')=='1'&&this._sFolderID=='@@mycard@@')
Cookie.set(['suppressmandatory'],1);};

/* client/inc/frm_delivery.js */
_me=frm_delivery.prototype;function frm_delivery(){};_me.__constructor=function(aID,aData){var me=this;this.__id=aID;this.__sent=GWOthers.getItem('DEFAULT_FOLDERS','sent')===this.__id[0]+'/'+this.__id[1];this._title('POPUP_ITEMS::DELIVERY_REPORT');this._defaultSize(-1,-1,600,500);this._draw('frm_delivery','main',{sent:this.__sent});msiebox(this._getAnchor('msiebox'));this.grid._cookiesEnabled=false;this.grid._addColumns({'EMAIL':{"title":'DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS',"width":100,mode:'%'},'STATUS':{"title":'DATAGRID_ITEMS_VIEW::EVNSTATUS',"width":200,css:'status'},'TIME':{"title":'DATAGRID_ITEMS_VIEW::DATE',"width":115}});this._create('x_btn_refresh','obj_button','footer','refresh color1 noborder');this.x_btn_refresh._disabled(true);this.x_btn_refresh._value('FORM_BUTTONS::REFRESH');this._create('x_btn_cancel','obj_button','footer','cancel noborder');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct()};this._create('x_btn_revoke','obj_button','footer','trash color2 x_btn_right noborder');this.x_btn_revoke._disabled(true);this.x_btn_revoke._value('FORM_BUTTONS::REVOKE');this.x_btn_revoke._onclick=function(){this._disabled(true);me.__tools.revoke_sent(me._aItemInfo,[me,'__revoked',[me._aItemInfo]]);};if(this.__sent){this.x_btn_send._onclick=function(){this._disabled(true);me.__tools.revoke_sent(me._aItemInfo,[me,'__resend',[me._aItemInfo]]);};this.x_btn_edit._onclick=function(){var newMessage=OldMessage.edit(me.__id,{ask_on_close:true});delete newMessage.__id;me.x_btn_revoke._onclick();};}
if(!Is.Object(aData)){var aData=WMItems.list({aid:aID[0],fid:aID[1],iid:aID[2],values:['DATE','X_MESSAGE_ID','MESSAGE_ID']});if(!aData||!(aData=aData[aID[0]])||!(aData=aData[aID[1]])||!(aData=aData[aID[2]]))
aData=null;}
if(aData.X_MESSAGE_ID||aData.MESSAGE_ID){storage.library('wm_tools');this.__tools=new wm_tools();this._aItemInfo={date:aData.DATE||aData.TIME,id:aData.X_MESSAGE_ID||aData.MESSAGE_ID};this._add_destructor('__onDestruct');this.x_btn_refresh._onclick=function(){me.__onDestruct();this._disabled(true);this._value('FORM_BUTTONS::REFRESH');me.__tools.delivery_report(me._aItemInfo,[me,'__fill']);};this.x_btn_refresh._onclick();}
else{gui._create('alert','frm_alert','','',[this,'_destruct'],'POPUP_ITEMS::DELIVERY_REPORT','ALERTS::IMAP_NULL');}};_me.__revoked=function(bOK,aItemInfo){if(bOK){if(this.__sent)
Item.remove([this.__id[0],this.__id[1],[this.__id[2]]],true);this._destruct();}
else
this.x_btn_revoke._disabled(false);};_me.__resend=function(bOK,aItemInfo){if(bOK){WMItems.action({aid:this.__id[0],fid:this.__id[1],iid:this.__id[2]},'resend',[function(bOK){if(bOK){if(this.__sent)
Item.remove([this.__id[0],this.__id[1],[this.__id[2]]],true);this._destruct();}
else
this.x_btn_send._disabled(false);}.bind(this)]);}
else
this.x_btn_send._disabled(false);};_me.__fill=function(aData){if(Is.Array(aData)&&aData.length){this.grid._placeholder();var aOut=[],d,bQueue=false,me=this,tmp;aData.sort(function(a,b){if(a.status==b.status){if(a.email<b.email)
return-1;else
if(a.email>b.email)
return 1;}
else
if(a.status=='error'||(a.status<b.status&&b.status!='error'))
return-1;else
if(b.status=='error'||(a.status>b.status&&a.status!='error'))
return 1;return 0;});this.x_btn_refresh._disabled(false);this.x_btn_revoke._disabled(true);var bEdit=true;for(var i=0;i<aData.length;i++){d=IcewarpDate.unix(aData[i].time);if(!bQueue&&aData[i].status=='queue')
bQueue=true;tmp={data:{EMAIL:aData[i].email,STATUS:[getLang('DELIVERY_STATUS::'+aData[i].status.toUpperCase()),'',getLang('DELIVERY_STATUS::'+aData[i].status.toUpperCase()+'_INFO')],TIME:d.format('L LT')},css:aData[i].status};if(aData[i].error)
tmp.data.STATUS=[tmp.data.STATUS[0]+' ('+aData[i].error+')','',aData[i].error];if(aData[i].status==='sent'||aData[i].status==='delivered')
bEdit=false;else
if(aData[i].status==='deferred'||this.__sent)
this.x_btn_revoke._disabled(false);aOut.push(tmp);}
if(this.__sent){this.x_btn_send._disabled(!bEdit);this.x_btn_edit._disabled(!bEdit);}
this.grid._fill(aOut);this.__onDestruct();if(bQueue){if(this.__timer)
window.clearInterval(this.__timer);this.__timer=window.setInterval(function(){me.__counter--;if(me.__counter<1){me.__onDestruct();me.x_btn_refresh._onclick();}
me.x_btn_refresh._text(getLang('FORM_BUTTONS::REFRESH')+' ('+me.__counter+')');},1000);me.x_btn_refresh._disabled(false);}
else
me.x_btn_refresh._value('FORM_BUTTONS::REFRESH');}
else{this.grid._placeholder(getLang('ERROR::NO_DATA'));this.x_btn_refresh._disabled(false);}};_me.__onDestruct=function(){this.__counter=10;if(this.__timer)
window.clearInterval(this.__timer);};

/* client/inc/frm_device.js */
_me=frm_device.prototype;function frm_device(){};_me.__constructor=function(sItemID){this.__sItemID=sItemID;this._title('DEVICES::OPTIONS');this._size(500,440,true);this._create('loader','obj_loader');this.x_btn_ok._disabled(true);if(Is.Defined(this.__sItemID))
WMItems.list({aid:sPrimaryAccount,fid:'__@@DEVICES@@__',iid:this.__sItemID},'','','',[this,'__init']);};_me.__init=function(aData){try{var aData=aData[sPrimaryAccount]['__@@DEVICES@@__'][this.__sItemID],aXML=XMLTools.Str2Arr(aData.SETTINGS_XML).SETTINGS[0];}
catch(r){this._destruct();}
var check=function(){tab0['mailfolders']._disabled(tab0['groupware']._value()==2);tab0['archive']._disabled(tab0['groupware']._value()!=2&&tab0['mailfolders']._value()!=1);tab0['publicfolders']._disabled(tab0['groupware']._value()==0&&tab0['mailfolders']._value()!=1);tab0['sharedfolders']._disabled(tab0['publicfolders']._disabled());tab1['mailinterval']._disabled(tab1['mailfilter']._value()<1);tab1['calendarinterval']._disabled(tab1['calendarfilter']._value()==0);tab1['taskssync']._disabled(tab1['tasksasevents']._value()!=1);tab1['taskssynctype']._disabled(tab1['taskssync']._disabled()||tab0['groupware']._value()==0);tab1['notessync']._disabled(tab1['notesaseventsortasks']._value()==0||tab1['tasksasevents']._value()==1);tab1['notessynctype']._disabled(tab1['notesaseventsortasks']._value()==0||tab0['groupware']._value()==0);if(tab1['mailfilter']._checked()&&aXML.MAILS[0].MAXINTERVAL[0].VALUE>0)
if(tab1['mailinterval']._value()==0||aXML.MAILS[0].MAXINTERVAL[0].VALUE<tab1['mailinterval']._value())
tab1['mailinterval']._value(aXML.MAILS[0].MAXINTERVAL[0].VALUE);if(tab1['calendarfilter']._checked()&&aXML.EVENTS[0].MAXINTERVAL[0].VALUE>0)
if(tab1['calendarinterval']._value()==0||aXML.EVENTS[0].MAXINTERVAL[0].VALUE<tab1['calendarinterval']._value())
tab1['calendarinterval']._value(aXML.EVENTS[0].MAXINTERVAL[0].VALUE);if(tab0['groupware']._value()==0){if(tab1['tasksasevents']._checked())
tab1['taskssynctype']._value(1,true);if(tab1['notesaseventsortasks']._checked())
tab1['notessynctype']._value(1,true);}
if(tab1['tasksasevents']._value()==1&&tab1['notesaseventsortasks']._value()==1&&tab1['notessync']._value()==2)
tab1['notessync']._value(1);};this._title(getLang('DEVICES::OPTIONS')+' - '+(aData.FRIENDLY_NAME||aData.MODEL||WMItems.__serverID(this.__sItemID)),true);this.loader._destruct();this._draw('frm_device','main');var tab0=this.maintab.folders;tab0['groupware']._value(aXML.FOLDERS[0].GROUPWARE[0].VALUE);tab0['groupware']._onchange=check;tab0['mailfolders']._value(aXML.FOLDERS[0].MAIL[0].VALUE);tab0['mailfolders']._onchange=check;tab0['archive']._value(aXML.FOLDERS[0].ARCHIVE[0].VALUE);tab0['publicfolders']._value(aXML.FOLDERS[0].PUBLIC[0].VALUE);tab0['sharedfolders']._value(aXML.FOLDERS[0].SHARED[0].VALUE);var tab1=this.maintab.sync;tab1['mailfilter']._value(aXML.MAILS[0].ENABLED[0].VALUE);tab1['mailfilter']._onchange=check;tab1['mailinterval']._value(aXML.MAILS[0].INTERVAL[0].VALUE);tab1['calendarfilter']._value(aXML.EVENTS[0].ENABLED[0].VALUE);tab1['calendarfilter']._onchange=check;tab1['calendarinterval']._value(aXML.EVENTS[0].INTERVAL[0].VALUE);tab1['tasksasevents']._value(aXML.TASKS[0].ENABLED[0].VALUE);tab1['tasksasevents']._onchange=check;tab1['taskssynctype']._value(aXML.TASKS[0].MERGE[0].VALUE);tab1['taskssynctype']._onchange=check;tab1['taskssync']._value(aXML.TASKS[0].INCOMPLETE[0].VALUE);tab1['notesaseventsortasks']._value(aXML.NOTES[0].ENABLED[0].VALUE);tab1['notesaseventsortasks']._onchange=check;tab1['notessync']._value(aXML.NOTES[0].ENABLED[0].VALUE=='0'?'1':aXML.NOTES[0].ENABLED[0].VALUE);tab1['notessync']._onchange=check;tab1['notessynctype']._value(aXML.NOTES[0].MERGE[0].VALUE);tab1['notessynctype']._onchange=check;var tab2=this.maintab.device;tab2.friendly_name._value(aData.FRIENDLY_NAME||'');check();var me=this;this.x_btn_ok._onclick=function(){me.__hide();var tmp,aOut={SETTINGS:[{FOLDERS:[{}],MAILS:[{}],EVENTS:[{}],TASKS:[{}],NOTES:[{}]}]};tmp=aOut.SETTINGS[0].FOLDERS[0];tmp.groupware=[{VALUE:tab0['groupware']._value()}];tmp.MAIL=[{VALUE:tab0['mailfolders']._value()}];tmp.ARCHIVE=[{VALUE:tab0['archive']._value()?1:0}];tmp.PUBLIC=[{VALUE:tab0['publicfolders']._value()?1:0}];tmp.SHARED=[{VALUE:tab0['sharedfolders']._value()?1:0}];tmp=aOut.SETTINGS[0].MAILS[0];tmp.ENABLED=[{VALUE:tab1['mailfilter']._value()?1:0}];tmp.INTERVAL=[{VALUE:tab1['mailinterval']._value()}];tmp=aOut.SETTINGS[0].EVENTS[0];tmp.ENABLED=[{VALUE:tab1['calendarfilter']._value()?1:0}];tmp.INTERVAL=[{VALUE:tab1['calendarinterval']._value()}];tmp=aOut.SETTINGS[0].TASKS[0];tmp.ENABLED=[{VALUE:tab1['tasksasevents']._value()?1:0}];tmp.MERGE=[{VALUE:tab1['taskssynctype']._value()}];tmp.INCOMPLETE=[{VALUE:tab1['taskssync']._value()}];tmp=aOut.SETTINGS[0].NOTES[0];tmp.ENABLED=[{VALUE:tab1['notesaseventsortasks']._value()?tab1['notessync']._value():0}];tmp.MERGE=[{VALUE:tab1['notessynctype']._value()}];WMItems.action({aid:sPrimaryAccount,fid:'__@@DEVICES@@__',iid:me.__sItemID,values:{SETTINGS_XML:XMLTools.Arr2Str(aOut),FRIENDLY_NAME:tab2.friendly_name._value()}},'edit',[me,'__saveHandler']);};this.x_btn_ok._disabled(false);if(aData.REMOTEWIPE!='-1'){if(aData.REMOTEWIPE=='1')
tab2.x_btn_wipe._value('DEVICES::RESET');if((GWOthers.getItem('RESTRICTIONS','disable_wipe')||0)<1){tab2.x_btn_wipe._onclick=function(){if(aData.REMOTEWIPE=='1')
me.__action(me.__sItemID,'resetwipe');else
gui._create('frm_confirm','frm_confirm','','',[me,'__action',[me.__sItemID,'setwipe']],'DEVICES::WIPE','DEVICES::WIPE_CONFIRMATION');};tab2.x_btn_wipe._disabled(false);}}};_me.__saveHandler=function(bOK){if(bOK===true){this.__response(true);if(gui.notifier)
gui.notifier._value({type:'item_saved'});}
else
this.__show();};_me.__action=function(v,sAction){this.__hide();WMItems.action({aid:sPrimaryAccount,fid:'__@@DEVICES@@__',iid:v},sAction,[this,'__response']);};_me.__response=function(bOK){if(bOK===true){if(gui.devices&&gui.devices._refresh)
gui.devices._refresh();this._destruct();}
else{this.__show();}};

/* client/inc/frm_devices.js */
_me=frm_devices.prototype;function frm_devices(){};_me.__constructor=function(){var me=this;this._title('MAIN_MENU::DEVICES');this._size(630,400,true);this._create('grid','obj_datagrid2','main');this.grid._cookiesEnabled=false;this.grid.__preload=1000;this.grid._default_columns=function(){return{REMOTEWIPE:{title:'',width:20,css:'ico state',type:'static'},DEVICE:{title:"DEVICES::DEVICE_MODEL",css:'ico model',width:160},DEVICETYPE:{title:"DEVICES::DEVICE_TYPE",width:130},PROTOCOLVERSION:{title:"DEVICES::PROTOCOL",width:70},REGISTERED:{title:"DEVICES::REGISTERED",width:110},LASTSYNC:{title:"DEVICES::LASTSYNC",width:110,arg:{sort:'asc'}}};};this.grid._listen_data('devices','',false);this.grid._prepareBody=function(aItems,sFolType){var aRow={},tmp=[],d1=new IcewarpDate(),d2=new IcewarpDate(),aResult={};me.__devices=aItems;for(var id in aItems){if(aItems[id].LASTSYNC){d1=IcewarpDate.unix(aItems[id].LASTSYNC||0);}
if(aItems[id].REGISTERED){d2=IcewarpDate.unix(aItems[id].REGISTERED||0);}
aRow={"id":id,"data":{'DEVICE':(aItems[id].FRIENDLY_NAME||aItems[id].MODEL||WMItems.__serverID(id)),'DEVICETYPE':(aItems[id].OS||aItems[id].DEVICETYPE),'PROTOCOLVERSION':aItems[id].PROTOCOLVERSION,'REGISTERED':aItems[id].REGISTERED&&d2?d2.format('L LT'):'','LASTSYNC':aItems[id].LASTSYNC&&d1?[d1.format('L LT'),aItems[id].LASTSYNC]:''},css:'',arg:{'id':id}};var os=aItems[id].OS||aItems[id].DEVICETYPE||'';if(/android/ig.test(os))
aRow.css='android ';else
if(/(windows)|(wp)|(outlook)/ig.test(os))
aRow.css='windows ';else
if(/blackberry/ig.test(os))
aRow.css='berry ';else
if(/(ipad)|(ios)|(apple)/ig.test(os))
aRow.css='apple ';switch(aItems[id].REMOTEWIPE){case'1':aRow.css+='wipe';aRow.data.REMOTEWIPE=['','',getLang('DEVICES::WIPING')];break;case'-1':aRow.css+='no_wipe';aRow.data.REMOTEWIPE=['','',getLang('DEVICES::NOWIPE')];break;}
tmp.push(aRow);}
if(this.__sortColumn=='LASTSYNC')
if(this.__sortType=='1')
tmp.sort(function(a,b){return b.data.LASTSYNC[1]-a.data.LASTSYNC[1];});else
tmp.sort(function(a,b){return a.data.LASTSYNC[1]-b.data.LASTSYNC[1];});for(var i in tmp)
aResult[tmp[i].id]=tmp[i];return aResult;};this.grid._ondblclick=function(e,elm,arg,row,col){if(row)
me.btn_detail._onclick();};this._create('btn_detail','obj_button','footer','settings noborder');this.btn_detail._value('POPUP_ITEMS::PROPERTIES');this.btn_detail._disabled(true);this.btn_detail._onclick=function(){var v=me.grid._value();for(var i in v)
gui._create('device','frm_device','main','',v[i]);};this._create('btn_del','obj_button','footer','noborder color2 trash x_btn_right');this.btn_del._value('POPUP_ITEMS::DELETE');this.btn_del._disabled(true);this.btn_del._onclick=function(){var v=me.grid._value();if(v.length)
gui._create('frm_confirm','frm_confirm','','',[me,'_action',[v,'delete']],'POPUP_ITEMS::DELETE','DEVICES::DELETE_CONFIRMATION');};this.grid._onclick=function(){var v=this._value(),b=v.length<0,b1=b,b2=b;if(!b){var b1=true,b2=true;for(var i in v)
if(!b1&&!b2)
break;else
if(me.__devices[v[i]])
if(me.__devices[v[i]].REMOTEWIPE=='0')
b1=false;else
if(me.__devices[v[i]].REMOTEWIPE=='1')
b2=false;}
me.btn_detail._disabled(b);me.btn_del._disabled(b);};this.grid._serverSort({aid:sPrimaryAccount,fid:'__@@DEVICES@@__'},'LASTSYNC','desc');};_me._action=function(v,sAction){if(sAction){this.btn_detail._disabled(true);this.btn_del._disabled(true);if(sAction=='delete')
this.grid._value([]);WMItems.action({aid:sPrimaryAccount,fid:'__@@DEVICES@@__',iid:v},sAction,[this,'_refresh']);}};_me._refresh=function(){this.grid._serverSort({aid:sPrimaryAccount,fid:'__@@DEVICES@@__'},'','',[this.grid,'_onclick']);};

/* client/inc/frm_dial.js */
_me=frm_dial.prototype;function frm_dial(){};_me.__constructor=function(sSearch,aPhones){if(gui.conference){gui.notifier._value({type:'alert',args:{header:'MAIN_MENU::CONFERENCE',text:'CONFERENCE::NOCALLALLOWED'}});this._destruct();return;}
if(!IceSIP.supported()||document.location.protocol!='https:'){var nortc=gui._create('no_webrtc','frm_confirm','','',[function(){window.open('https://www.icewarp.com/support/troubleshoot_webrtc/?'+buildURL({ishttps:(location.protocol.indexOf("https")===0?'1':'0'),lang:GWOthers.getItem('LAYOUT_SETTINGS','language')}));}],'SIP::SIP',document.location.protocol=='https:'?'SIP::NOWEBRTC':'SIP::NOTSECURE');nortc.x_btn_ok._value('ERROR::TROUBLESHOOT');addcss(nortc.x_btn_ok._main,'help');this._destruct();return;}
if(dataSet.get('sip',['media'])=='requesting'){gui.notifier._value({type:'sip_external',args:{header:'SIP::SIP',text:'SIP::GETTINGMEDIA'}});this._destruct();return;}
var me=this;this._defaultSize(-1,-1,650,366);this._title('DIAL::CALL');this._draw('frm_dial','main',{ab:(!sPrimaryAccountGW||(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1)});this.list._select_single=true;this.list._addColumns({'AVATAR':{width:20,type:'static',css:'avatar',display:'all'},'TYPE':{width:20,type:'static',css:'ico type',display:'all'},'CALL':{title:'DATAGRID_ITEMS_VIEW::EVNTITLE','width':290,encode:true,display:'all'},'DATE':{title:'DATAGRID_ITEMS_VIEW::EVENT_STARTDATE','width':120,display:'all'},'DURATION':{title:'DATAGRID_ITEMS_VIEW::EVENT_STARTDATE','width':120,display:'all'}});var CV=+GWOthers.getItem('LAYOUT_SETTINGS','compact_view');var rows=2.8;switch(CV){case 1:rows=2;break;case 2:rows=1;break;}
this._list_options={rows:rows,filters:[{search:'',text:'COMMON::ALL'},{search:'missed',text:'DIAL::MISSED'}],size:2500};this.list._small(this._list_options);this.list._serverSort=function(){var me=this;WMStorage.get({'resources':['sip_calls']},'','',[function(aData){var out=[];if(aData&&aData.SIP_CALLS){var aData=aData.SIP_CALLS.ITEMS,itm,rcp;for(var i in aData){itm=aData[i].VALUES;if(!me._smallfilter||(itm.INOUT.VALUE=='IN'&&(itm.STATUS.VALUE=='FAILED'||itm.STATUS.VALUE=='CANCELLED'))){rcp=(itm.INOUT.VALUE=='OUT'?itm.TO.VALUE:itm.FROM.VALUE);if(rcp)
out.push({data:{TYPE:'&nbsp;',AVATAR:(sPrimaryAccountGW?'<div style="background-image: url(\''+getAvatarURL(rcp)+'\')"></div>':'<div></div>'),CALL:rcp,DATE:IcewarpDate.unix(itm.UNIXSTAMP.VALUE).format(IcewarpDate.SHORT_L),DURATION:itm.STATUS.VALUE=='ANSWERED'&&itm.DURATION.VALUE>0?parseJulianTime(itm.DURATION.VALUE):''},arg:{call:rcp},css:itm.STATUS.VALUE+' '+itm.INOUT.VALUE});}}}
if(me&&!me._destructed)
me._fill(out);}],true);};this.list._onclick=function(e,elm,arg,id,col,aClickType){if(arg&&arg.call)
me.number._value(arg.call);};this.list._ondblclick=function(e,elm,arg,id,col,aClickType){if(arg&&arg.call){me.number._value(arg.call);if(!me.call._disabled())
me.call._onclick();}};this.list._serverSort();this.number.__minWidth='300';this.number._checksize=function(){};this.add._onclick=function(){if(me.pbook)
me.pbook._destruct();me.pbook=gui._create('pbook','frm_phonebook','','',[function(v){if(me.number)me.number._value(v);}]);};this.btn_0._onclick=function(){var sip=gui.frm_main.sip,v={btn_0:0,btn_1:1,btn_2:2,btn_3:3,btn_4:4,btn_5:5,btn_6:6,btn_7:7,btn_8:8,btn_9:9,btn_star:'*',btn_sharp:'#'}[this._name],str=me.number._value().toString();if(sip&&dataSet.get('sip',['activity'])=='Phoning'){sip._dtmf(v);me.number._value(str+v);me.number._focus();}
else{var pos=me.number._getCartPos();me.number._value(str.substr(0,pos)+v+str.substring(pos));me.number._setRange(pos+1);}};this.btn_1._onclick=this.btn_0._onclick;this.btn_2._onclick=this.btn_0._onclick;this.btn_3._onclick=this.btn_0._onclick;this.btn_4._onclick=this.btn_0._onclick;this.btn_5._onclick=this.btn_0._onclick;this.btn_6._onclick=this.btn_0._onclick;this.btn_7._onclick=this.btn_0._onclick;this.btn_8._onclick=this.btn_0._onclick;this.btn_9._onclick=this.btn_0._onclick;this.btn_star._onclick=this.btn_0._onclick;this.btn_sharp._onclick=this.btn_0._onclick;this.number._qvalue=function(v){if(Is.Object(v))
v=v.value;var a=MailAddress.splitEmailsAndNames(v);if((a=a[0])&&Is.String(a.email))
this._value(a.email||'');};this.number._query=function(v){this.__last_qdata=v;var tmp=v.replace(/"/g,'\\"');var aFilter={search:'phone:"'+tmp+'" OR classify:"'+tmp+'" OR title:"'+tmp+'" OR name:"'+tmp+'"',sort:'ITMCLASSIFYAS, ITMFIRSTNAME, ITMSURNAME',limit:this._limit};WMItems.list({'aid':sPrimaryAccount,'fid':"__@@ADDRESSBOOK@@__",'values':['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTPHNHOME1','LCTPHNHOME2','LCTPHNASSISTANT','LCTPHNWORK1','LCTPHNWORK2','LCTPHNCALLBACK','LCTPHNCOMPANY','LCTPHNCAR','LCTPHNMOBILE','LCTPHNOTHER','LCTPHNPRIMARY','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'],'filter':aFilter},'','','',[this,'_parse']);};this.number._obeyEvent('onkeydown',[function(e){if(e.keyCode==13&&me.number._value().length&&me.call&&!me.call._disabled())me.call._onclick();}]);this.call._onclick=function(){var calling=false;if(this._name=='video'&&IceSIP&&!IceSIP.supported())
gui.notifier._value({type:'sip_external',args:{header:'SIP::SIP',text:'SIP::VIDEONOTSUPPORTED'}});else
calling=gui.frm_main._call(me.number._value(),this._name=='video',undefined,this._name=='screen');if(calling){me.call._disabled(true);if(me.video)
me.video._disabled(true);}};if(window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){if(GWOthers.getItem('SIP','mode')=='integrate'){var arrow=mkElement('div',{className:'arrow'});arrow.onclick=function(e){var e=e||window.event;if(!this.__cmenu||this.__cmenu._destructed){this.__cmenu=gui._create('cmenu','obj_context','','frm_dial_external');var aMenu=[{title:'SIP::EXTERNAL',css:'ico extphone',arg:[gui.frm_main,'_call',[me.number._value(),false,true]]}];if(navigator.browser&&navigator.browser.application=='Chrome'&&location.protocol.indexOf("https")===0)
aMenu.push({title:'SIP::SCREEN',css:'ico screen',arg:[gui.frm_main,'_call',[me.number._value(),false,false,true]]});this.__cmenu._fill(aMenu);var pos=getSize(arrow);this.__cmenu._place(pos.x+pos.w/2,pos.y+pos.h/2+5,null,2);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}};this.call._main.appendChild(arrow);this._mode('sip');if(this.video){this.video._onclick=this.call._onclick;this.video._disabled(false);}
if(!gui.frm_main.sip){this._create('loader','obj_loader')._value(getLang('PRELOADER::STARTUP'));gui.frm_main._create('sip','obj_sip','','',function(ok){if(!ok){gui.notifier._value({type:'sip_not_reachable',args:{header:'SIP::SIP',text:'SIP::REGISTRATION_FAILED'}});me._destruct();}});}
else{var stat=dataSet.get('sip',['state']);if(!stat||stat==null||stat=='offline'||stat=='failed'){this._create('loader','obj_loader')._value(getLang('PRELOADER::STARTUP'));gui.frm_main.sip._login(function(ok){if(!ok){gui.notifier._value({type:'sip_not_reachable',args:{header:'SIP::SIP',text:'SIP::REGISTRATION_FAILED'}});me._destruct();}});}}}}!this._destructed&&this._listen('sip');};_me._value=function(n){if(Is.Defined(n))
this.number._value(n);else
return this.number._value();};_me._onclose=function(){if(dataSet.get('sip',['media'])=='requesting'){gui.notifier._value({type:'sip_external',args:{header:'SIP::SIP',text:'SIP::GETTINGMEDIA'}});return false;}else
return true;};_me._mode=function(v){if(Is.String(v)){this.__mode=v||'ext';removecss(this.call._main,'external','screen');if(this.__mode=='ext'){addcss(this.call._main,'external');this.call._value('DIAL::DIAL');}
else if(this.__mode=='screen'){addcss(this.call._main,'screen');this.call._value('DIAL::DIAL');}
else
this.call._value('DIAL::CALL');}
else
return this.__mode||'ext';};_me.__update=function(sDName){var ds=dataSet.get('sip');if(ds&&ds.state=='online'){addcss(this._main,'online');this._mode('sip');if(this.loader)
this.loader._destruct();switch(ds.type){case'PreparingCall':this.call._disabled(true);if(this.video)
this.video._disabled(true);break;case'IncomingCall':case'CallEstablished':case'Calling':this._undock();this.__hide();break;case'CallCanceled':case'CallFinished':this.__show();this.call._disabled(false);if(this.video)
this.video._disabled(false);this.list._serverSort();break;}
return;}
this._mode('ext');removecss(this._main,'online');};_me._onresize=function(e,sType){if(!this.__position.max&&sType){var pos1=getSize(this.call._main.parentNode.parentNode),pos2=getSize(this.call._main),dif=pos2.y+pos2.h-pos1.y-pos1.h,y=this.__position.y,h=this.__position.h;if(dif>0){switch(sType){case't':case'lt':case'rt':y-=dif;default:h+=dif;}
this._place(this.__position.x,y,this.__position.w,h);}}};

/* client/inc/frm_distrib.js */
_me=frm_distrib.prototype;function frm_distrib(){};_me.__constructor=function(){this._defaultSize(-1,-1,700,570);this._draw('frm_distrib','main');this.__initForm('DISTRIB_LIST::DISTRIB_LIST');};_me.__loadItems=function(){if(!this.maintab)return;var me=this;loadDataIntoForm(this.maintab.tab1,this._aValues);this.maintab.tab1.ITMCLASSIFYAS._onkeyup=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>32)
sTitle=sTitle.substr(0,32)+'...';me._title(sTitle+(me._aValues.ITMFOLDER?' ('+me._aValues.ITMFOLDER+')':''),true);}
else
me._title(getLang('DISTRIB_LIST::DISTRIB_LIST')+(me._aValues.ITMFOLDER?' ('+me._aValues.ITMFOLDER+')':''),true);};this.maintab.tab1.ITMCLASSIFYAS._onkeyup();this.maintab.tab1.ITMCLASSIFYAS._onerror=function(b){me.x_btn_ok._disabled(b);};if(this.maintab.tab1.ITMCLASSIFYAS._checkError.length)
me.x_btn_ok._disabled(true);if(this._aValues['ITMTITLE']&&!this._aValues['ITMCLASSIFYAS'])
this.maintab.tab1.ITMCLASSIFYAS._value(this._aValues['ITMTITLE']);if(Is.Defined(this._aValues['LOCATIONS']))
this.maintab.tab1.X_MEMBERS._value(this._aValues['LOCATIONS']);this.maintab.tab2._onactive=function(bFirstTime){if(bFirstTime){if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});if(me._aValues.fullpath)
this.X_ATTACHMENTS._value({'values':out});else
this.X_ATTACHMENTS._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID),'values':out});}
else
if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}}}
if(me._aValues['PUSH_ATTACHMENTS'])
this.maintab.tab2._active();};_me.__saveItems=function(aValues){var members;if(!Is.Empty(members=this.maintab.tab1.X_MEMBERS._value()))
aValues['LOCATIONS']=members;aValues['values']['ITMCLASS']='L';var attachments;if(this.maintab.tab2.X_ATTACHMENTS&&!Is.Empty(attachments=this.maintab.tab2.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=attachments;};

/* client/inc/frm_document_onlyoffice.js */
function frm_document_onlyoffice(){}
frm_document_onlyoffice.types={text:['doc','docx','dot','docm','dotx','dotm','docb','odt','rtf'],spreadsheet:['xls','csv','xlsx','xla','xlam','xlsb','ods','xlsb','xlsm','xlt','xltm','xltx'],presentation:['ppt','pptx','odp','pps','ppsm','ppsx','pptm','ppa','ppam']};frm_document_onlyoffice.prototype.__constructor=function(){this._defaultSize(-1,-1,1200,800,true);this._title('DOCUMENT::TITLE');this._create('loader','obj_loader');this._draw('frm_document_onlyoffice','main');this.__id='onlyoffice_placeholder'+unique_id();this._getAnchor('editor').appendChild(mkElement('div',{id:this.__id}));if(typeof DocsAPI===typeof void 0){document.head.appendChild(mkElement('script',{src:'/webdocuments/web-apps/apps/api/documents/api.js'}));}
this.__document_changed=false;this.__document_saved=true;};frm_document_onlyoffice.prototype._ondock=function(){return this.__document_type?{css:'ico_'+this.__document_type}:{};};frm_document_onlyoffice.prototype._getType=function(url){var a=document.createElement('a');a.href=url;a=a.pathname.split('/').pop().split('.').pop().toLowerCase();var type;for(var i in frm_document_onlyoffice.types){if(~frm_document_onlyoffice.types[i].indexOf(a)){type=i;}}
return type;};frm_document_onlyoffice.prototype._open=function(aItemInfo,mode,reopen_arguments,response,callback){if(!Is.Object(aItemInfo)){return;}
if((aItemInfo.EVN_ID&&aItemInfo.EVNTITLE)||!(aItemInfo.aid&&aItemInfo.fid)){this._open_success(aItemInfo,mode,reopen_arguments,response,callback);}
else{WMItems.list(aItemInfo,'','','',[function(aData){aData=aData[aItemInfo.aid][aItemInfo.fid][WMItems.__clientID(aItemInfo.iid)];aItemInfo.EVNTITLE=aItemInfo.attid||aData.EVNTITLE;this._open_success(aItemInfo,mode,reopen_arguments,response,callback);}.bind(this)]);}};frm_document_onlyoffice.prototype._open_success=function(aItemInfo,mode,reopen_arguments,response,callback){if(Is.Object(response)&&response.data&&(!response.data.document||!response.data.document.fileType)){gui.notifier._value({type:'alert',args:{text:'ALERTS::FILE_NOT_FOUND'}});this._destruct();return;}
if(callback){this.callback=callback;}
var wmpath=document.location.origin+document.location.pathname;if(typeof DocsAPI===typeof void 0){return setTimeout(function(){this._open(aItemInfo,mode,reopen_arguments,response);}.bind(this),50);}
if(+DocsAPI.DocEditor.version().split('.')[0]>4){this._main.className+=' ribbon';}
if(+DocsAPI.DocEditor.version().split('.')[0]>5){this._main.classList.add('hide-topbar');}
var data=aItemInfo;if(!aItemInfo.url){var d=dataSet.get('items',[aItemInfo.aid,aItemInfo.fid,aItemInfo.iid]);if(d){for(var i in d){data[i]=d[i];}}}
data.EVNTITLE&&this._title(data.EVNTITLE,true);gui.socket&&gui.socket.api._obeyEvent('onnotify',[this,'__notify']);this.aItemInfo={aid:aItemInfo.aid,fid:aItemInfo.fid,iid:aItemInfo.iid,url:aItemInfo.url,ticket:aItemInfo.ticket,attid:aItemInfo.attid};this.reopen_arguments=reopen_arguments;this.mode=response.mode;response.data.documentType=response.data.documentType||this._getType(aItemInfo.url)||'text';response.data.editorConfig=response.data.editorConfig||{};response.data.document.fileType=(response.data.document.fileType||response.data.document.filetype).toLowerCase();response.data.editorConfig.customization=response.data.editorConfig.customization||{};response.data.editorConfig.customization.about=false;response.data.editorConfig.customization.chat=false;response.data.editorConfig.customization.feedback=false;response.data.editorConfig.customization.logo={image:wmpath+'client/skins/default/images/transparent.gif',url:'javascript: return false;'};response.data.editorConfig.lang=GWOthers.getItem('LAYOUT_SETTINGS','language')||'en';response.data.events={onDocumentStateChange:function(event){this.__document_changed=this.__document_changed||event.data;this.__document_saved=!event.data;}.bind(this),onAppReady:function(){var doc=this.__eMain.querySelector('iframe').contentWindow.document;doc.head.appendChild(mkElement('link',{rel:'stylesheet',type:'text/css',href:wmpath+'client/skins/default/css/onlyoffice.css'}));doc.head.appendChild(mkElement('link',{rel:'stylesheet',type:'text/css',href:wmpath+'client/skins/default/css/onlyoffice_'+response.data.documentType+'.css'}));doc.body.addEventListener('click',function(e){this._focus();}.bind(this),true);this.loader&&this.loader._destruct();}.bind(this),onWarning:function(event){console.warn("ONLYOFFICE Document Editor reports an warning: code "+event.data.warningCode+", description "+event.data.warningDescription);},onError:function(event){console.warn("ONLYOFFICE Document Editor reports an error: code "+event.data.errorCode+", description "+event.data.errorDescription);}};this._editor=new DocsAPI.DocEditor(this.__id,response.data);if(WMFolders.getType(aItemInfo)=='I'&&mode!=response.mode&&response.mode==1){this.__readonly();gui.notifier._value({type:'alert',args:{text:'ALERTS::COULD_NOT_EDIT'}});}
else
if(response.data.editorConfig.mode==='view'){this.__readonly(false,reopen_arguments.has_access);}
if(data){if(data.EVNLINKEXTRAS){var extras=parseURL(data.EVNLINKEXTRAS);for(var i in extras){data[i.toUpperCase()]=data[i.toUpperCase()]||extras[i];}}
if(data.EVN_DOCUMENTEDITINGINFO){var document_editing_info;try{document_editing_info=JSON.parse(data.EVN_DOCUMENTEDITINGINFO);data.EVNLOCKOWN_EMAIL=data.EVNLOCKOWN_EMAIL||document_editing_info.editor_email;}catch(e){}}
if(data.EVNLOCKOWN_EMAIL&&data.EVNLOCKOWN_EMAIL!==sPrimaryAccount){this.__readonly(data);}}
addcss(this._main,'ico_'+response.data.documentType);this.__document_type=response.data.documentType;if(data.EVNCLASS==='R'||data.EVNCLASS==='Z'){addcss(this._main,'chat');this.btn_bubble._onclick=function(){Cookie.set(['aux','comments_info'],1);removecss(this._main,'splash','chat-new');addcss(this._main,'chat-open');}.bind(this);this._getAnchor('chat_room').textContent=dataSet.get('folders',[data.aid,data.fid,'NAME']);this._getAnchor('chat_icon').onclick=function(e){this.btn_bubble._onclick();}.bind(this);this._getAnchor('chat_close').onclick=function(e){removecss(this._main,'chat-open');}.bind(this);this._create('comment','obj_comment','comment','',data);if(!Cookie.get(['aux','comments_info']))
setTimeout(function(){if(this&&!this._destructed&&!Cookie.get(['aux','comments_info']))
addcss(this._main,'splash');}.bind(this),500);}};frm_document_onlyoffice.prototype.__notify=function(aData){if(this._destructed)
return;switch(aData.ACTION){case'unlock':var aFolder=dataSet.get('folders',[this.aItemInfo.aid,this.aItemInfo.fid]),rp=Path.slash(aData.FOLDER);if((aFolder.RELATIVE_PATH===rp||this.aItemInfo.fid===rp)&&aData.ITEM===WMItems.__serverID(this.aItemInfo.iid)){dataSet.add('items',[this.aItemInfo.aid,this.aItemInfo.fid,this.aItemInfo.iid,'EVNLOCKOWN_EMAIL'],sPrimaryAccount);dataSet.add('items',[this.aItemInfo.aid,this.aItemInfo.fid,this.aItemInfo.iid,'EVN_DOCUMENTEDITINGINFO'],'');this.__reload();}
break;case'comment':if(!hascss(this._main,'chat-open')){addcss(this._main,'chat-new');}}};frm_document_onlyoffice.prototype.__reload=function(){var panel=this.__eContainer.querySelector('.panel');panel&&panel.parentNode.removeChild(panel);this.__eContainer.querySelector('.container2').classList.add('has-panel');this.__eContainer.appendChild(mkElement('div',{className:'table panel'},false,[mkElement('div',{className:'cell'},false,[mkElement('div',{className:'label',textContent:getLang('DOCUMENT::READ_ONLY_MODE')})]),mkElement('div',{className:'cell middle'},false,[mkElement('div',{className:'name',textContent:getLang('DOCUMENT::DOCUMENT_UNLOCKED')}),mkElement('div',{className:'button',textContent:getLang('DOCUMENT::RELOAD'),onclick:function(){this._remove_destructor('_onclose');this._destruct();Item.officeOpen.apply(Item,this.reopen_arguments);}.bind(this)})]),mkElement('div',{className:'cell last'},false)]));};frm_document_onlyoffice.prototype.__request=function(data){var room=dataSet.get('folders',[sPrimaryAccount,this.aItemInfo.fid]);var group='';if(room.TYPE=='I'&&room.NAME){group=this.aItemInfo.fid.split('/');group.splice(-1,1,room.NAME);group=group.join('/');}
var body=getLang('DOCUMENT::REQUEST_UNLOCK_TEXT',[data.EVNTITLE,(group||room.NAME||room.RELATIVE_PATH)]);var body_header=getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_GREETINGS',[dataSet.get('xmpp',['roster',data.EVNLOCKOWN_EMAIL,'name'])||data.EVNLOCKOWN_EMAIL]);if(!dataSet.get('xmpp',['roster',data.EVNLOCKOWN_EMAIL])||~['both','none','offline','',void 0].indexOf(dataSet.get('xmpp',['roster',data.EVNLOCKOWN_EMAIL,'show']))){if((TeamChatAPI&&TeamChatAPI.teamChatOnly())||sPrimaryAccountGUEST){Item.sendEmailTo(data.EVNLOCKOWN_EMAIL,{sBody:'<div>'+body_header+'</div><div><br></div><div>'+body+'</div>',sSubject:getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_SUBJECT',[(group||room.NAME||room.RELATIVE_PATH)+'/'+data.EVNTITLE]),addSignature:false});}else{NewMessage.compose({to:data.EVNLOCKOWN_EMAIL,subject:getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_SUBJECT',[(room.NAME||room.RELATIVE_PATH)+'/'+data.EVNTITLE]),mailBody:'<div>'+body_header+'</div><div><br></div><div>'+body+'</div>'});}}else{gui.frm_main.im._activate(data.EVNLOCKOWN_EMAIL);gui.frm_main.im._chat(data.EVNLOCKOWN_EMAIL);gui.frm_chat.tabs[gui.frm_chat.tabs._value()].text._value(body);gui.frm_chat._focus();}};frm_document_onlyoffice.prototype.__readonly=function(data,has_access){this.__eContainer.querySelector('.container2').classList.add('has-panel');var panel=this.__eContainer.querySelector('.table.panel');panel&&panel.parentNode.removeChild(panel);this.__eContainer.appendChild(mkElement('div',{className:'table panel'},false,[mkElement('div',{className:'cell'},false,[mkElement('div',{className:'label',textContent:getLang('DOCUMENT::READ_ONLY_MODE')})]),data?mkElement('div',{className:'cell middle'},false,[mkElement('div',{className:'avatar'},false,[mkElement('img',{src:getAvatarURL(data.EVNLOCKOWN_EMAIL)})]),mkElement('div',{className:'name',textContent:getLang('DOCUMENT::NAME_IS_EDITING_THIS_DOCUMENT',[dataSet.get('xmpp',['roster',data.EVNLOCKOWN_EMAIL,'name'])||data.EVNLOCKOWN_EMAIL])}),mkElement('div',{className:'button',textContent:getLang('DOCUMENT::REQUEST_UNLOCK'),onclick:function(){this.__request(data);}.bind(this)})]):false,has_access?mkElement('div',{className:'cell middle'},false,[mkElement('div',{className:'button',textContent:getLang('DOCUMENT::SWITCH_TO_EDIT_MODE'),onclick:function(){this._remove_destructor('_onclose');this._destruct();this.reopen_arguments[3]='force_edit';Item.officeOpen.apply(Item,this.reopen_arguments);}.bind(this)})]):false,mkElement('div',{className:'cell last'})].filter(Boolean)));};frm_document_onlyoffice.prototype._onclose=function(){if(this.__closing)
return;this.__closing=true;this._remove_destructor('_onclose');gui.socket&&gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);var timeout=setInterval(function(){if(this.__document_saved){clearInterval(timeout);if(this.aItemInfo&&(this.mode!==void 0)&&this.mode!==2){var final_cb={};TeamChatAPI.filesStopEdit(this.aItemInfo,{success:function(){if(this.__document_changed&&this.callback&&this.callback.success){this.callback.success.call(this.callback.context||null,final_cb);if(this.aItemInfo.url)
final_cb.success&&final_cb.success.call(final_cb.context||null);}
(this._editor||{}).destroyEditor&&this._editor.destroyEditor();this._destruct();},error:function(){console.error(arguments);this.__document_changed&&this.callback&&this.callback.error&&this.callback.error.call(this.callback.context||null);(this._editor||{}).destroyEditor&&this._editor.destroyEditor();this._destruct();},context:this},{success:function(){!this.aItemInfo.url&&final_cb.success&&final_cb.success.call(final_cb.context||null);},context:this});}else{this._destruct();}}}.bind(this),50);};

/* client/inc/frm_duplicity.js */
_me=frm_duplicity.prototype;function frm_duplicity(){};_me.__constructor=function(aParams){var me=this;this._size(450,230,true);this._modal(true);this._dockable(false);this._resizable(false);this._draw('frm_duplicity','main');this._title('DUPLICITY::DUPLICITY');this._create('x_btn_rename','obj_button','footer','noborder simple ok color1');this.x_btn_rename._value('FORM_BUTTONS::RENAME');this.x_btn_rename._onclick=function(){me.__action(me.filename._value());};this._create('x_btn_rewrite_all','obj_button','footer','noborder simple cancel color2 x_btn_right');this.x_btn_rewrite_all._value('FORM_BUTTONS::REWRITE_ALL');this.x_btn_rewrite_all._onclick=function(){me.__action(null,true);};this._create('x_btn_rewrite','obj_button','footer','noborder cancel color2 x_btn_right');this.x_btn_rewrite._value('FORM_BUTTONS::REWRITE');this.x_btn_rewrite._onclick=function(){me.__action();};this.__req=aParams.request;this.__att=[];this.__id=0;for(var i=0,j=aParams.duplicate.ITEM.length;i<j;i++)
this.__att.push({'class':aParams.duplicate.ITEM[i].CLASS[0].VALUE,'fullpath':aParams.duplicate.ITEM[i].FULLPATH[0].VALUE,'name':aParams.duplicate.ITEM[i].NAME[0].VALUE,'freename':aParams.duplicate.ITEM[i].FREENAME[0].VALUE});this.filename._restrict([Is.Filename]);this.filename._onsubmit=function(){me.x_btn_rename._onclick();};this.filename._onerror=function(b){me.x_btn_rename._disabled(b);};this.__init();};_me.__init=function(bNext){if(bNext)
this.__id++;var att=this.__att[this.__id];if(att){this.text._value(getLang('DUPLICITY::LABEL',[att.name]));this.filename._value(att.freename);this.filename._setRange(0,att.freename.indexOf('.')>-1?att.freename.lastIndexOf('.'):0);}
else
this._destruct();};_me._onclose=function(){this.__init(true);return false;};_me.__action=function(sName,bAll){var err=this.__att[this.__id],args=[];for(var i=0,j=this.__req.args.length;i<j;i++)
args.push(this.__req.args[i]);switch(this.__req.type){case'add':var aItemInfo=clone(args[1],true);if(args[1].ATTACHMENTS){if(Is.String(sName)&&aItemInfo.values){if(aItemInfo.values.EVNTITLE)
aItemInfo.values.EVNTITLE=sName;if(aItemInfo.values.EVNLOCATION)
aItemInfo.values.EVNLOCATION=sName;if(aItemInfo.values.EVNRID)
aItemInfo.values.EVNRID=sName;}
aItemInfo.ATTACHMENTS.splice(0,this.__id);for(var v,i=0;i<aItemInfo.ATTACHMENTS.length;i++){if((v=aItemInfo.ATTACHMENTS[i].values)&&(!v.fullpath||v.fullpath==err.fullpath)){if(Is.String(sName))
v.description=sName;else
aItemInfo.replace=true;if(bAll){this.__id=this.__att.length-1;break;}}
else{aItemInfo.ATTACHMENTS.splice(i,1);i--;}}
args[1]=aItemInfo;}
else
this.__init(true);break;case'move':case'copy':var aItemInfo=clone(args[0],true),iid=WMItems.__clientID(Path.basename(err.fullpath));aItemInfo.iid.splice(0,this.__id);for(var i=0;i<aItemInfo.iid.length;i++){if(iid==aItemInfo.iid[i]){if(Is.String(sName)){aItemInfo.duplicity="rename";aItemInfo.rename=sName;}
else
aItemInfo.duplicity="replace";if(bAll){this.__id=this.__att.length-1;break;}}
else{aItemInfo.iid.splice(i,1);i--;}}
args[0]=aItemInfo;break;default:this.__init(true);return;}
WMItems[this.__req.type].apply(WMItems,args);this.__init(true);};

/* client/inc/frm_edit_attendee.js */
_me=frm_edit_attendee.prototype;function frm_edit_attendee(){};_me.__constructor=function(sFormName,sTitle,aResponse,aValues,sID,bAttendee){var me=this;this._title(sTitle);this._size(350,250,true);this._draw(sFormName,'main');this._modal(true);if(bAttendee){this.CNTCONTACTNAME._disabled(true);this.CNTEMAIL._disabled(true);this.CNTROLE._disabled(true);this.CNTSTATUS._disabled(true);}
this._sID=sID;this._create('x_ok','obj_button','footer','ok noborder');this.x_ok._value('FORM_BUTTONS::OK');this.x_ok._disabled(true);this.x_ok._onclick=function(){if((me.CNTEMAIL&&me.CNTEMAIL._checkError.length)||(me.LCTEMAIL1&&me.LCTEMAIL1._checkError.length))
return;executeCallbackFunction(aResponse,me._value(),me._sID);me._destruct();};this._create('x_cancel','obj_button','footer','cancel noborder');this.x_cancel._value('FORM_BUTTONS::CANCEL');this.x_cancel._onclick=function(){me._destruct()};if(!bAttendee){if(this.CNTEMAIL)
this.CNTEMAIL._onerror=function(b){me.x_ok._disabled(b);};if(this.LCTEMAIL1)
this.LCTEMAIL1._onerror=function(b){me.x_ok._disabled(b);};}
if(Is.Object(aValues))
this._value(aValues);};_me._value=function(aValues){if(Is.Object(aValues))
loadDataIntoForm(this,aValues);else{var aValues={};storeDataFromForm(this,aValues);return aValues;}};

/* client/inc/frm_edit_header.js */
_me=frm_edit_header.prototype;function frm_edit_header(){};_me.__constructor=function(oOpener){var me=this;this._title('FILTERS::EDIT_HEADER');this._size(500,336,true);this._resizable(false);this._modal(true);this._draw('frm_edit_header','main');this.__opener=oOpener;this.__value=[];var aTypes=[getLang('FILTERS::ADDEDIT'),getLang('FILTERS::DELETE')];this.grid._addColumns([{title:"FILTERS::ACTION",width:100},{title:"FILTERS::HEADER",width:100,mode:'%',encode:true}]);function fillGrid(){var tmp=[];for(var i in me.__value)
if(me.__value[i])
tmp.push({data:[(aTypes[me.__value[i].substr(0,1)]),me.__value[i].substr(1)]});me.grid._fill(tmp);};if(typeof this.__opener.__aValues=='string'){var val=this.__opener.__aValues.split("\n");for(var i in val)
if(val[i])
this.__value.push(val[i]);fillGrid();}
this.edit._onclick=this.add._onclick=function(){if(this._name=='edit'){var id=me.grid._value(),v;if(Is.Empty(id)||!Is.Defined(v=me.__value[id[0]]))
return;}
me.popup=gui._create('add','frm_ok_cancel');me.popup._modal(true);me.popup.__resizable=false;me.popup._size(300,180,true);me.popup._draw('frm_edit_header_edit','main');if(this._name=='add'){me.popup._title('FILTERS::EDIT');me.popup.x_btn_ok._onclick=function(){me.__value.push(this._parent['action']._value()+this._parent['header']._value());fillGrid();me.grid._value([me.__value.length-1]);me.popup._destruct();me._focus();};}
else{me.popup._title('FILTERS::EDIT');me.popup['action']._value(v.charAt(0));me.popup['header']._value(v.substr(1));me.popup.x_btn_ok._onclick=function(){me.__value[id[0]]=this._parent['action']._value()+this._parent['header']._value();fillGrid();me.popup._destruct();me._focus();};}};this.grid._ondblclick=function(){me.edit._onclick();};this.remove._onclick=function(){var a=me.grid._value();if(!Is.Empty(a)){for(var i in a)
me.__value.splice(a[i],1);fillGrid();}};this.x_btn_ok._onclick=function(){me.__opener.__aValues=me.__value.length?me.__value.join("\n"):'';me._destruct();};};

/* client/inc/frm_editor.js */
_me=frm_editor.prototype;function frm_editor(){};_me.__constructor=function(){this._title('FILE::FILE');this._defaultSize(-1,-1,600,400);this.x_btn_ok._disabled(true);this.x_btn_ok._value('FORM_BUTTONS::SAVE');this.x_btn_ok._onclick=function(){this._disabled(true);this._parent._onsave();};this.x_btn_cancel._onclick=function(){if(this._parent._onclose(true))
this._parent._destruct();};this._create('x_btn_print','obj_button','footer','ico img print noborder transparent simple x_btn_right');this.x_btn_print._disabled(true);this.x_btn_print._title('MAIN_MENU::PRINT');this.x_btn_print._onclick=function(){gui.printer._print(this._parent.inp._value(),this._parent.inp._type=='obj_text');};};_me._loadContent=function(filename,content){this._title(filename,true);switch(Path.extension(filename).toLowerCase()){case'txt':this._create('inp','obj_text','main','obj_text100 noborder');break;case'htm':case'html':this._create('inp','obj_wysiwyg');this.inp.__insert_image=true;break;default:this._destruct();return;}
this.inp._value(content,void 0,void 0,function(){this.__inpdata=this.inp._value();}.bind(this));this.inp._readonly(true);this.x_btn_ok._disabled(false);this.x_btn_ok._value('FORM_BUTTONS::CLOSE');this.x_btn_ok._onclick=function(){this._destruct();}.bind(this);this.x_btn_cancel._destruct();this.x_btn_print._disabled(false);};_me._load=function(id){if(Is.Array(id)){this.__id=id;this._create('preloader','obj_loader');this.preloader._value('Loading');WMItems.list({"aid":id[0],"fid":id[1],"iid":id[2],"values":['DATA','EVNTITLE','EVNLOCKOWN_ID']},'','','',[this,'__response']);}};_me.__response=function(aData){var me=this;if(aData&&(aData=aData[this.__id[0]])&&(aData=aData[this.__id[1]])&&(aData=aData[this.__id[2]])&&aData.EVNTITLE){if(this.preloader)
this.preloader._destruct();this.__aData=aData;switch(Path.extension(aData.EVNTITLE).toLowerCase()){case'txt':this._create('inp','obj_text','main','obj_text100 noborder');break;case'htm':case'html':this._create('inp','obj_wysiwyg');this.inp.__insert_image=true;break;default:this._destruct();return;}
if(!aData.EVNLOCKOWN_ID)
Item.set_lock(this.__id,true,true,[this,'__unlock_on_destruct']);this._title(aData.EVNTITLE,true);this.inp._value(aData.DATA||'',void 0,void 0,function(){this.__inpdata=this.__currentSaveState=this.inp._value();}.bind(this));if(aData.EVNLOCKOWN_ID&&aData.EVNLOCKOWN_ID!==sPrimaryAccountGWID){this.__readonly(true);}
else{this.x_btn_ok._disabled(false);if(!this.__autoSaveInterval&&GWOthers.getItem('DOCUMENTS','autosave')==1&&GWOthers.getItem('DOCUMENTS','autosave_minutes')>0){this.__autoSaveInterval=setInterval(function(){me._onsave(true);},60000*GWOthers.getItem('DOCUMENTS','autosave_minutes'));this._add_destructor('__end_autosave');}}
this.inp._focus();this.x_btn_print._disabled(false);}
else
this._destruct();};_me.__readonly=function(b){if(b){this.x_btn_ok._disabled(true);this.inp._readonly(true);gui.socket&&gui.socket.api._obeyEvent('onnotify',[this,'__notify']);this._add_destructor('__socket_destructor');this._draw('frm_editor_info','header',{unlock:true,name:getLang('DOCUMENT::NAME_IS_EDITING_THIS_DOCUMENT',[dataSet.get('xmpp',['roster',this.__aData.EVNLOCKOWN_EMAIL,'name'])||this.__aData.EVNLOCKOWN_EMAIL]),src:getAvatarURL(this.__aData.EVNLOCKOWN_EMAIL)});this._getAnchor('header').querySelector('div.button').onclick=function(){this.__unlock_request();}.bind(this);this.__onCreateChild(null,null,'header');}
else{this._draw('frm_editor_info','header');this._getAnchor('header').querySelector('div.button').onclick=function(){this._destruct();gui._create(this._name,'frm_editor')._load(this.__id);}.bind(this);}};_me.__notify=function(aData){if((aData.ACTION!=='unlock')||this._destructed)
return;var aFolder=dataSet.get('folders',[this.__id[0],this.__id[1]]),rp=Path.slash(aData.FOLDER);if((aFolder.RELATIVE_PATH===rp||this.__id[1]===rp)&&aData.ITEM===WMItems.__serverID(this.__id[2]))
this.__readonly(false);};_me.__socket_destructor=function(){gui.socket&&gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);};_me.__unlock_request=function(){TeamChatAPI.requestUnlock(this.__id[1],this.__aData.EVNTITLE,this.__aData.EVNLOCKOWN_EMAIL);};_me.__end_autosave=function(){if(this.__autoSaveInterval){clearInterval(this.__autoSaveInterval);}};_me.__unlock_on_destruct=function(){this._add_destructor('__unlock');};_me.__unlock=function(){Item.set_lock(this.__id,false,true);};_me._onsave=function(bAuto){if(this.__id){if(!bAuto)
this.__hide();this.__inpdata=this.inp._value();if(bAuto&&this.__inpdata==this.__currentSaveState)
return false;else
this.__currentSaveState=this.__inpdata;WMItems.add(this.__id,{values:{DATA:this.__inpdata}},'','','',[this,'__saved',[bAuto]],bAuto);}};_me.__saved=function(bOK,aData,bAuto){if(bAuto)
return false;if(bOK){var aItems=dataSet.get('items');for(var sAccId in aItems)
for(var sFolId in aItems[sAccId])
break;if(sAccId==this.__id[0]&&sFolId==this.__id[1]){try{Item.__refreshView(this.__id,true);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}}
this._destruct();if(gui.notifier)
gui.notifier._value({type:'item_saved'});if(this.__id&&WMFolders.getType(this.__id)=='F'&&GWOthers.getItem('GW_MYGROUP','ownautorevisionmode')!='1')
gui._create('revision','frm_revision','','',{aid:this.__id[0],fid:this.__id[1],iid:this.__id[2]},true);}
else{this.__show();this.x_btn_ok._disabled(false);this.x_btn_ok._focus();}};_me._onclose=function(bHandle){if(!this.x_btn_ok._disabled()&&bHandle&&this.inp&&this.__inpdata!=this.inp._value()){if(this.cdialog&&!this.cdialog._destructed)
this.cdialog._focus();else{var me=this;me.cdialog=gui._create('frm_confirm','frm_confirm_threestates','','',[function(bOK){if(bOK)me._onsave();else me._destruct();}],'CONFIRMATION::SAVE','CONFIRMATION::SAVE_FILE','','CONFIRMATION::SAVE','FORM_BUTTONS::CANCEL','CONFIRMATION::DISCARD');addcss(me.cdialog.x_btn_ok._main,'color1');me.cdialog.x_btn_cancel._onclick=function(){this._parent._destruct();me.inp._focus();};addcss(me.cdialog.x_btn_cancel2._main,'trash color2 x_btn_right');me.cdialog.x_btn_cancel2._onclick=function(){me._destruct();};}
return false;}
else
return true;};_me._onfocus=function(){if(this.inp)
this.inp._focus();};

/* client/inc/frm_event2.js */
_me=frm_event2.prototype;function frm_event2(){};_me.__constructor=function(){storage.library('purify.wrapper','purify');this.__attendee=!!(this._aValues.EVNFLAGS&2);if(!Object.keys(this._aValues).length){return this._destruct();}
if(this._repeating){this.__hide&&this.__hide();gui._create('frm_confirm_repeating','frm_confirm_repeating','','',[this,'__editRepeating'],'REPEATING_CONFIRM::TITLE_EDIT','REPEATING_CONFIRM::TEXT_EDIT','',this.__attendee)._onclose=function(){this._destruct();return true;}.bind(this);}else{this.__constructor2();}};_me._onclose=function(b){if(b){if(this._userEdited()){var callback=this._bClone?'__confirmedClone':'__confirmed';gui._create('frm_confirm','frm_confirm','','',[this,callback],'CONFIRMATION::ARE_YOU_SURE','CONFIRMATION::ALL_CHANGES_WILL_BE_LOST');return false;}
else
if(this._bClone){this.__confirmedClone(true);}}
return true;};_me.__confirmedClone=function(bForce){var refreshParameters=[this._sAccountID,this._sFolderID,[this._sItemID]];var removeParameters={'aid':refreshParameters[0],'fid':refreshParameters[1],'iid':refreshParameters[2]};!bForce&&this.__hide();WMItems.remove(removeParameters,'items','','folders',[function(bOK){if(bOK){!bForce&&this._close(false);Item.__refreshView(refreshParameters);}else{!bForce&&this.__show();}}.bind(this)]);};_me.__editRepeating=function(nType){switch(parseInt(nType)){case 2:this._aValues['EXPFOLLOWING']='true';case 0:this._aValues['EXPDATE']=this._aReccurenceValues['EVNSTARTDATE'];if(this._aValues['EVNSTARTTIME']<0){this._aValues['EVNSTARTDATE']=this._aValues._TZEXPEVNSTARTDATE;this._aValues['EVNENDDATE']=this._aValues._TZEXPEVNENDDATE;}else{this._aValues['_TZEVNSTARTDATE']=this._aValues._TZEXPEVNSTARTDATE;this._aValues['_TZEVNSTARTTIME']=this._aValues._TZEXPEVNSTARTTIME;this._aValues['_TZEVNENDDATE']=this._aValues._TZEXPEVNENDDATE;this._aValues['_TZEVNENDTIME']=this._aValues._TZEXPEVNENDTIME;}}
this.__constructor2();};_me.__constructor2=function(){this._defaultSize(-1,-1,800,550);this._aValues=this._aValues||{};this._aValues.EVNCLASS=this._aValues.EVNCLASS||'E';var me=this,gchat=WMFolders.getType([this._sAccountID,this._sFolderID])=='I';this.__real_email=sPrimaryAccount;if(~this.__real_email.indexOf('@##')){this.__real_email=this.__real_email.split('@##')[0].replace('_','@');}
this.__oresponse=this.__oresponse||{};if(this.__oresponse.propose){this.__readonly=true;}
this.__show();var aData={};if(this._aValues.EVNCLASS==='O'||this._aValues.EXPDATE)
aData.noRepeat=true;if(this._aValues.EXPDATE)
aData.occurrence=true;if(!Is.Defined(this._id[2])){var sFolder='';if(WMFolders.getAccess({aid:this._id[0],fid:this._id[1]},'write')){if(!this._sFolderID.indexOf('__@@VIRTUAL@@__/')){var aFolders=dataSet.get('folders',[this._id[0],this._id[1],'VIRTUAL','FOLDERS']);for(var i in aFolders||{}){if(aFolders[i]){sFolder=i;break;}}}else{sFolder=this._id[1];}}
this._id[1]=sFolder||Mapping.getDefaultFolderForGWType('E');this.x_btn_ok._value('FORM_BUTTONS::CREATE');}
var sOwner=me._aValues.EVNORGANIZER?MailAddress.splitEmailsAndNames(me._aValues.EVNORGANIZER)[0].email:'';if(!sOwner){var meta='';if(this._aValues['EVN_METADATA']&&(meta=parseURL(this._aValues['EVN_METADATA']))&&meta.core_own_email){sOwner=meta.core_own_email;}
else{var tmpf=Path.split(this._id[1])[0];if(~(dataSet.get('folders',[this._id[0],tmpf,'TYPE'])||'').indexOf('A'))
sOwner=tmpf.replace(/~/g,'');else{sOwner=me._sAccountID;}}}
this.__evnid={aid:me._id[0],fid:me._id[1],iid:me._id[2],owner_id:sOwner};if(Is.Defined(this._aValues._TZID)){this._aValues['EVNSTARTDATE']=this._aValues._TZEVNSTARTDATE;this._aValues['EVNENDDATE']=this._aValues._TZEVNENDDATE;this._aValues['EVNSTARTTIME']=this._aValues._TZEVNSTARTTIME;this._aValues['EVNENDTIME']=this._aValues._TZEVNENDTIME;this._aValues['TZID']=this._aValues._TZID;}
if(!Is.Defined(this._id[2])){aData.path=true;}
aData.guest=!!sPrimaryAccountGUEST;aData.conference=sPrimaryAccountCONFERENCE&&dataSet.get('accounts',[sPrimaryAccount,'MEETING_PROVIDER'])=='jitsi';this._draw('frm_event2','main',aData);if(!Is.Defined(this._id[2])||this.__oresponse.propose){addcss(this._getAnchor('block_time'),'active');}
this.EVNTYPE.input._onChange=function(){this.__refreshView=true;}.bind(this);if(gchat){if(!Is.Defined(this._id[2])){this._aValues['CONTACTS']=this._aValues['CONTACTS']||{};this._aValues['CONTACTS'][getFreeKey(this._aValues['CONTACTS'])]={values:{CNTEMAIL:'__@@groupchat@@__',CNTCONTACTNAME:getLang('ATTENDEES::ALL_ATTENDEES'),CNTROLE:'Q',CNTSTATUS:'B',NEW:true}};}
else
if(this._aValues['CONTACTS']){for(var i in this._aValues['CONTACTS']){if(this._aValues['CONTACTS'].hasOwnProperty(i)&&this._aValues['CONTACTS'][i].values&&this._aValues['CONTACTS'][i].values.CNTEMAIL==='__@@groupchat@@__'&&!this._aValues['CONTACTS'][i].values.CNTCONTACTNAME){this._aValues['CONTACTS'][i].values.CNTCONTACTNAME=getLang('ATTENDEES::ALL_ATTENDEES');break;}}}}
this._getAnchor('collapse_time').addEventListener('click',function(e){e.stopPropagation();me._closeBlocks();me._getAnchor('block_time').classList.remove('active');});this._create('_scrollbar','obj_scrollbar');this._scrollbar._scrollbar(this._getAnchor('left_content'),this._getAnchor('left_column'));this._create('_scrollbar2','obj_scrollbar');this._scrollbar2._scrollbar(this._getAnchor('user_list'),this._getAnchor('user_list_container'));if(this.x_include_in_my_cal){this.X_PATH._onchange=function(value){var folder=value.split('/');var account=folder.shift();var paths=folder.slice();folder=folder.join('/');var is_public=false;while(!is_public&&paths.length){is_public=dataSet.get('folders',[account,paths.join('/'),'PUBLIC']);paths.pop();}
var folder_data=dataSet.get('folders',[account,folder]);if((folder_data&&(!folder_data.OWNER||(folder_data.OWNER===me.__real_email)))||is_public){me.x_include_in_my_cal._main.setAttribute('hidden','');me.x_include_in_my_cal._checked(false);}else{me.x_include_in_my_cal._main.removeAttribute('hidden');}
if(me.x_list){if(WMFolders.getType([account,folder])==='E'){me.x_list.__users.some(function(user){if(user.email==='__@@groupchat@@__'){user.active=true;return true;}});me.x_list._removeUser();}else{me.x_list._addUser({email:'__@@groupchat@@__',name:getLang('ATTENDEES::ALL_ATTENDEES'),role:'Q',status:'B',action:'new'});}}};}
if(!Is.Defined(this._id[2])){if(gchat){this.X_PATH._disabled(true);}}else{this.X_PATH._main.parentNode.parentNode.setAttribute('hidden','');}
this.X_PATH._value(this._id[0]+'/'+this._id[1]);if(this.MEETING_ACTION){var mp=this._getAnchor('meeting_password');this.MEETING_ACTION._onchange=function(event,checked){if(checked){removecss(mp,'hidden');}else{addcss(mp,'hidden');}};this.MEETING_ACTION._value(this._aValues.conference);if(this._aValues.EVNMEETINGID){if(this.MEETING_PASSWORD){this.MEETING_PASSWORD._value(this._aValues.EVNMEETINGPASSWORD);this.MEETING_PASSWORD._readonly(this._aValues.EXPFOLLOWING||this._aValues.EXPDATE||this.__readonly||this.__attendee);}
this._aValues.MEETING_ACTION=this.MEETING_ACTION._checked(true);removecss(mp,'hidden');addcss(this._main,'join_conference');this._start_conference._onclick=function(){storage.library('wm_conference');wm_conference.get(this._aValues.EVNMEETINGID).join();}.bind(this);}else{this.MEETING_ACTION._disabled(!!this.__oresponse.propose||this.__attendee);if(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly())){this.MEETING_ACTION._main.parentNode.parentNode.setAttribute('hidden','');}}}
this.MEETING_PASSWORD&&this.MEETING_PASSWORD.__setMask({'toggle':['',getLang('COMMON::SHOW'),2]},[function(){if(me.MEETING_PASSWORD.__eIN.getAttribute('type')==='text'){me.MEETING_PASSWORD.__eIN.setAttribute('type','password');}else{me.MEETING_PASSWORD.__eIN.setAttribute('type','text');}}]);this._create('X_TIMEINTERVAL','obj_timeinterval2','','',true,true,{startDate:this.startDate,startTime:this.startTime,endDate:this.endDate,endTime:this.endTime,durationDays:this.durationDays,durationTime:this.durationTime,timezone:this.timezone,tzlink:this.tzlink,allDay:this.allDay});this.X_REMINDERS._fillLang({'0':'REMINDER::NONE','0M':['REMINDER::MINUTESBEFORE',['0']],'10M':['REMINDER::MINUTESBEFORE',['10']],'30M':['REMINDER::MINUTESBEFORE',['30']],'1H':['REMINDER::HOURSBEFORE',['1']],'2H':['REMINDER::HOURSBEFORE',['2']],'1D':['REMINDER::DAYSBEFORE',['1']],'2D':['REMINDER::DAYSBEFORE',['2']],'7D':'REMINDER::WEEKBEFORE','*':'SETTINGS::CUSTOM'});var last_remind_value;this.X_REMINDERS._onbeforechange=function(){last_remind_value=this.__value;};this.X_REMINDERS._onchange=function(){if(this.__value==='*'){if(this.popup&&!this.popup._destructed){this.popup._focus();}
else{this.popup=gui._create('frm_reminders','obj_popup','','frm_reminders');this.popup._size(420,145,true);this.popup._modal(true);this.popup._resizable(false);this.popup._dockable(false);this.popup._create('btn_ok','obj_button','footer','ok noborder color1')._value('FORM_BUTTONS::OK');this.popup._create('btn_cancel','obj_button','footer','cancel noborder')._value('FORM_BUTTONS::CANCEL');this.popup._onclose=function(b){if(b){me.X_REMINDERS._value(last_remind_value);me.X_REMINDERS._focus();}
return true;};this.popup.btn_cancel._onclick=function(){me.X_REMINDERS._value(last_remind_value);this._parent._destruct();me.X_REMINDERS._focus();};this.popup._title('REMINDER::REMINDER');this.popup._create('X_REMINDERS','obj_reminder','main','','EVENT_SETTINGS');this.popup.X_REMINDERS._value([me._reminderKeyToObject(last_remind_value)]);this.popup.btn_ok._onclick=function(){me._setReminderSelect(this.X_REMINDERS._value());this._destruct();}.bind(this.popup);this.popup.X_REMINDERS.reminder_1.time.x_text._onerror=function(error){this.btn_ok._disabled(error);}.bind(this.popup);}}
else
if(this.popup&&!this.popup._destructed)
this.popup._destruct();};this.X_REMINDERS._onkeydown=function(e){if(this.popup&&!this.popup._destructed){if(e.keyCode==27||e.keyCode==9)
this.popup._close(true);if(e.keyCode==27){if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}}};if(me.__oresponse.propose&&!this._aValues.RECURRENCES){this.X_REPEATING._disabled(true);}
else{var last_repeating_value;this.X_REPEATING._onbeforechange=function(){last_repeating_value=this.__value;};this.X_REPEATING._onselect=function(){if(this.__value==='*'){if(this.popup&&!this.popup._destructed){this.popup._focus();}
else{this.popup=gui._create('frm_repeatings','obj_popup','','frm_repeatings');this.popup._size(650,370,true);this.popup._modal(true);this.popup._resizable(false);this.popup._dockable(false);this.popup._create('btn_ok','obj_button','footer','ok noborder color1')._value('FORM_BUTTONS::OK');this.popup._create('btn_cancel','obj_button','footer','cancel noborder')._value('FORM_BUTTONS::CANCEL');this.popup._onclose=function(b){if(b){me.X_REPEATING._value(last_repeating_value);me.X_REPEATING._focus();}
return true;};this.popup.btn_cancel._onclick=function(){me.X_REPEATING._value(last_repeating_value);this._parent._destruct();me.X_REPEATING._focus();};this.popup._title('EVENT::REPEAT');this.popup._create('X_REPEATING','obj_repeating','main','');this.popup.X_REPEATING._onerror=function(has_error){this._parent.btn_ok._disabled(has_error);};this.popup.X_REPEATING._value(me.X_REPEATING.__rcrvalue||me._repeatingKeyToObject(last_repeating_value));this.popup.X_REPEATING._setDate(IcewarpDate.julian(me.X_TIMEINTERVAL._value().EVNSTARTDATE));if(me.__oresponse.propose){this.popup.btn_ok._disabled(true);}
else{this.popup.btn_ok._onclick=function(){var restricted=this.X_REPEATING.container._getChildObjects().some(function(child){return child.__check&&!child.__check();});if(restricted){return;}
var rec=(this.X_REPEATING._value()||{}).values||{};if(rec&&+rec.RCRMONTHREPETITION){var d=IcewarpDate.julian(me.X_TIMEINTERVAL.startDate._value());d.date(rec.RCRDAYREPETITION);var now=new IcewarpDate();if(now.format('julian')>d.format('julian')){d.month(d.month()+1);}
me.X_TIMEINTERVAL.startDate._value(d.format('julian'));me.X_TIMEINTERVAL.__setFrom();}
me._setRecurrenceSelect([this.X_REPEATING._value()]);this._destruct();}.bind(this.popup);}}}else{if(this.popup&&!this.popup._destructed)
this.popup._destruct();if(!me.__oresponse.propose&&this.__value!==last_repeating_value){last_repeating_value=this.__value;me._setRecurrenceSelect([me._repeatingKeyToObject(this._value())]);}}
if(me.__oresponse.propose){me._setRecurrenceSelect([me.X_REPEATING.__rcrvalue],true);}};this.X_REPEATING._onkeydown=this.X_REMINDERS._onkeydown;}
this.EVNLOCATION._oncreateOptionList=function(bSkipUpdate){if(this.___init)
return;this.___init=true;var resources_path=dataSet.get('main',['resources_path']);if(resources_path){var aItemsInfo={aid:sPrimaryAccount,fid:resources_path,filter:{sort:'ITMCLASSIFYAS',search:'category:Room'},values:['ITMCLASSIFYAS','LCTEMAIL1']};WMItems.list(aItemsInfo,'','','',[function(tmp){if(tmp){var out={},sEmail;for(var i in tmp)
for(var j in tmp[i]){delete tmp[i][j]['/'];delete tmp[i][j]['#'];delete tmp[i][j]['$'];delete tmp[i][j]['@'];for(var k in tmp[i][j]){sEmail=MailAddress.createEmail(tmp[i][j][k].ITMCLASSIFYAS,tmp[i][j][k].LCTEMAIL1);out[sEmail]=sEmail;}}
me.EVNLOCATION.__out=out;if(!bSkipUpdate){me.EVNLOCATION._fill(out);me.EVNLOCATION._show();}}}]);}};var autoadded_resource;this.EVNLOCATION.__eIN.addEventListener('blur',function(){if(autoadded_resource){me.x_list.__users.forEach(function(user){user.active=user.name===autoadded_resource.name&&user.email===autoadded_resource.email;});me.x_list._removeUser();}
if(~this.value.indexOf('@')){autoadded_resource=MailAddress.splitEmailsAndNames(this.value)[0];autoadded_resource.role='S';me.x_list._addUser(autoadded_resource);}});this.X_LOCMAP._value([this.EVNLOCATION,'_value']);this.X_LOCMAP._callback_function=function(input){me.EVNLOCATION._value(input);};this.EVNLOCATION._disabled(this.__attendee||this.__readonly);this._initGooglePlacesAutocomplete(GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key'));[].forEach.call(this._main.querySelectorAll('.block'),function(block){block.addEventListener('click',function(e){me._closeBlocks();if(this.classList.contains('attendees')&&!this.classList.contains('active')){me.x_suggest._focus();}
if(this.classList.contains('time')&&me.__readonly&&!me.__oresponse.propose){return;}
this.classList.add('active');});});this.EVNTITLE._onfocus=function(){me._closeBlocks();me._closeNote();};this.EVNTITLE._disabled(this.__readonly);this.EVNTITLE._onkeyup=(function(){var sAppendix='';if(me._aValues.EVNFOLDER&&me._aValues.EVNFOLDER!='@@trash@@'){var sFolder=Path.slash(me._aValues.EVNFOLDER),ds=dataSet.get('folders',[sPrimaryAccount,sFolder]);if(ds&&ds.NAME){var aPath=sFolder.split('/');aPath.pop();aPath.push(ds.NAME);sAppendix=' - '+aPath.join('/');}
else{sAppendix=' - '+sFolder;}}
return function(){me._title((this._value()||getLang('EVENT::EVENT'))+sAppendix,true);me.x_freebusy._title(this._value()||getLang('EVENT::EVENT'));};})();function openNote(e){var note=me.x_note.__originalValue.EVNNOTE||'';if(me.x__note){return;}
if(me.x_note.__originalValue.EVNDESCFORMAT!=='text/html'){note=note.escapeHTML();}
e&&e.stopPropagation();me.x_freebusy._main.style.zIndex=-1;me.x_freebusy._main.style.opacity=0;me._create('x__note','obj_wysiwyg','right_content','',{readonly:me.__readonly});me.x__note.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});if(gui._rtl||!me.x_note.__originalValue.EVNDESCFORMAT||me.x_note.__originalValue.EVNDESCFORMAT.toLowerCase()!=='text/plain'){me.x__note.select._value('enabled');}else{me.x__note.select._value('disabled');}
if(!me.__readonly){me.x__note._focus();}
me.x__note._value(note);me.x__note._main.parentNode.appendChild(mkElement('div',{innerText:getLang(me.__readonly?'FORM_BUTTONS::CLOSE':'COMMON::DONE'),className:'close done_editing',onclick:function(){me.__forced_note=false;me._closeNote();}}),me.x__note._main);}
this.x_note.__originalValue=this.x_note.__originalValue||{};this.x_note.__originalValue.EVNDESCFORMAT=this._aValues.EVNDESCFORMAT;this.x_note.__originalValue.EVNNOTE=this._aValues.EVNNOTE||'';this.x_note._obeyEvent('onclick',[openNote]);if(me.__readonly&&!this.x_note.__originalValue.EVNNOTE.length)
this.x_note._disabled(true);this._getAnchor('left_column').addEventListener('click',function(){me._closeNote();});this.X_ATTACHMENTS.attachments._addColumns({ico:{css:'file_type',type:'static',width:20},name:{title:"DATAGRID_ITEMS_VIEW::EVNFILENAME",encode:true,arg:{sort:'asc'}},size:{title:"DATAGRID_ITEMS_VIEW::EVNFILESIZE",width:60,css:'size',arg:{sort:'asc'}},remove:{css:'remove',type:'static',width:20}});this.X_ATTACHMENTS.attachments._getAnchor('container2').addEventListener('click',function(e){var match=e.target.id.match(/(\d)\/remove$/);if(match){me.X_ATTACHMENTS._remove(me.X_ATTACHMENTS.attachments._aData[match[1]].id);}});if(this.__readonly){this.X_ATTACHMENTS._disabled(true);}else{this.X_ATTACHMENTS.file._dropzone(this._getAnchor('container'),function(){return template.tmp('dropzone',{title:getLang('COMPOSE::DROP_TITLE'),body:getLang('COMPOSE::DROP_BODY')});},'item small');this.X_ATTACHMENTS._onuploadstart=function(){me.x_btn_ok._disabled(true);};this.X_ATTACHMENTS._onuploadend=function(){me.x_btn_ok._disabled(false);};this._getAnchor('attach_preview').addEventListener('click',function(){if(!me.X_ATTACHMENTS.__idtable.filter(function(attachement){return!attachement.removed;}).length){me.X_ATTACHMENTS.add_item._onclick();}});}
this.EVNTYPE.input.plus.__eIN.setAttribute('placeholder',getLang('TAGS::ADD_TAGS'));this.EVNTYPE.input._disabled(this.__readonly);this.EVNTYPE.input._onchange=function(){var elm=me.EVNTYPE.input._getAnchor('tag');elm&&elm.lastElementChild&&elm.lastElementChild.scrollIntoView();};if(!me.__readonly){addcss(this._getAnchor('add_tags'),'click');this._getAnchor('add_tags').addEventListener('click',function(e){me.EVNTYPE.button._onclick();});this._getAnchor('tags_preview').addEventListener('click',function(e){setTimeout(function(){if(!me.EVNTYPE._value()){me.EVNTYPE.input.plus._focus();}},0);});}
var loc=me._aValues.EVNLOCATION;if(loc&&loc.indexOf('@')<0)
loc='';if(loc&&(loc=MailAddress.splitEmailsAndNames(loc)[0])&&Is.Email(loc.email)){me._aValues['CONTACTS']=me._aValues['CONTACTS']||{};var bFound=false;for(var i in me._aValues['CONTACTS']){if(me._aValues['CONTACTS'][i].values.CNTEMAIL==loc.email){bFound=true;break;}}
if(!bFound){me._aValues['CONTACTS'][getFreeKey(me._aValues['CONTACTS'])]={values:{CNTEMAIL:loc.email,CNTCONTACTNAME:loc.name,CNTROLE:'S',CNTSTATUS:'B',NEW:true}};}}
if(me.__originalLocation&&me.__originalLocation!=this.EVNLOCATION._value()){for(var i in me._aValues['CONTACTS']){if(me._aValues['CONTACTS'][i].values&&me._aValues['CONTACTS'][i].values.CNTEMAIL===me.__originalLocation){delete me._aValues['CONTACTS'][i];break;}}}
var users=[];var users2=[];for(var i in me._aValues.CONTACTS){var value=me._aValues.CONTACTS[i].values;users.push(value.CNTEMAIL);users2.push({email:value.CNTEMAIL,name:value.CNTCONTACTNAME,role:value.CNTROLE,status:value.CNTSTATUS,id:value.CNT_ID});};this.x_freebusy._init({evnid:me._aValues.EVN_ID,users:users});this.x_freebusy._onchange=function(d){me.X_TIMEINTERVAL._value({EVNSTARTDATE:d.startdate,EVNSTARTTIME:d.starttime,EVNENDDATE:d.enddate,EVNENDTIME:d.endtime,},true);me._previewTimeBlock();};var guest=sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly());if(guest||this.__attendee){this.x_address_book_icon._main.classList.remove('noborder');this.x_address_book_icon._disabled(true);}
else{this.x_address_book_icon._onclick=function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],void 0,void 0,void 0,void 0,true);gui.address_book._modal(true);};}
this.x_suggest._single=true;this.x_suggest._itemClass=['C'];this.x_suggest._disobeyEvent('change',[this.x_suggest,'_checksize']);this.x_suggest._checksize=function(){};this.x_suggest._placeholder(getLang('ATTENDEES::QUICK_ADD'));this.x_suggest._onsubmit=function(){if(!this._checkError.length){var tmp=MailAddress.splitEmailsAndNames(this._value());this._value('');if(tmp&&tmp[0]&&tmp[0].email){me.__onAddNewFromAddressbook(true,[[MailAddress.createEmail(tmp[0].name,tmp[0].email)]]);}}};this.x_suggest.__minWidth=400;this.x_suggest._onmouseselect=this.x_suggest._onsubmit;this.x_suggest._restrict([function(v){if(v==='')return true;var tmp=MailAddress.splitEmailsAndNames(v);if(tmp&&tmp[0]&&tmp[0].email){return Is.Email(tmp[0].email);}
return false;}]);this.x_suggest._disabled(this.__readonly||this.__attendee);if(!this.__readonly&&!guest&&!this.__attendee){this.x_suggest._main.appendChild(mkElement('div',{className:'add',onclick:function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],void 0,void 0,void 0,void 0,true);gui.address_book._modal(true);}}));}
this.x_list=this._getAnchor('user_list');this.x_list.__users=[];this.x_list.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,bRemove=false;if(elm.tagName=='SPAN'){bRemove=true;elm=elm.parentNode;};if(!elm.id){elm=elm.parentNode;}
var id=elm.id.substr((me._pathName+'.list/').length);if(this.__users[id]&&id>0){if(this.__users[id].active&&(e.ctrlKey||e.metaKey)){removecss(elm,'active');this.__users[id].active=false;}
else{if(!e.ctrlKey&&!e.metaKey){var active=this._getActive();var tmp;for(var i in active){try{tmp=document.getElementById(me._pathName+'.list/'+active[i]);removecss(tmp,'active');this.__users[active[i]].active=false;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}}
addcss(elm,'active');this.__users[id].active=true;}
if(bRemove)
me.x_list._removeUser();else{var pos=e.clientX-getSize(elm).x;if(pos<40&&!gui._rtl||gui._rtl&&pos>205){this.oncontextmenu&&this.oncontextmenu(e);e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();if(e.stopPropagation)
e.stopPropagation();return false;}}}};if(!this.__attendee){this.x_list.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(!elm.id){elm=elm.parentNode;}
if(elm.tagName=='SPAN')
elm=elm.parentNode;var id=elm.id.substr((me._pathName+'.list/').length);if(this.__users[id]&&id>0){var aMenu,pos=getSize(elm);if(e.clientX-pos.x<20&&me.__attendee)
return;var cmenu=gui._create('cmenu','obj_context','','obj_timetable_context');cmenu._onclick=function(e,elm,id,arg){var usr;if((usr=me.x_list.__users[arg.id])){usr[arg.key]=arg.value;me.x_list._editUser(usr,arg.id);}};if(e.clientX-pos.x<20&&!gui._rtl||gui._rtl&&e.clientX-pos.x<228){aMenu=[{'title':'ATTENDEES::STATUS_P',css:'bg_status_P','arg':{'id':id,'key':'status',value:''}},{'title':'ATTENDEES::STATUS_A',css:'bg_status_A','arg':{'id':id,'key':'status',value:'A'}},{'title':'ATTENDEES::STATUS_D',css:'bg_status_D','arg':{'id':id,'key':'status',value:'D'}}];cmenu._fill(aMenu);cmenu._place(gui._rtl?pos.x+218:pos.x+10,pos.y+pos.h,150,2);}
else{aMenu=[{'title':'ATTENDEES::ROLE_Q',css:'bg_role_Q','arg':{'id':id,'key':'role',value:'Q'}},{'title':'ATTENDEES::ROLE_S',css:'bg_role_S','arg':{'id':id,'key':'role',value:'S'}},{'title':'ATTENDEES::ROLE_T',css:'bg_role_T','arg':{'id':id,'key':'role',value:'T'}}];cmenu._fill(aMenu);cmenu._place(gui._rtl?pos.x+236:pos.x+30,pos.y+pos.h,150,2);}}
return false;};}
this.x_list.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(!elm.id){elm=elm.parentNode;}
if(elm.id&&elm.id.indexOf((me._pathName+'.list/'))==0){var active=this._getActive();if(active.length){var user=this.__users[active[0]];gui._create('edit_dialog','frm_edit_attendee','','','frm_edit_attendee','ATTENDEES::EDIT_TITLE',[me,'__onEdit'],{CNT_ID:user.id,CNTEMAIL:user.email,CNTCONTACTNAME:user.name,CNTROLE:user.role,CNTSTATUS:user.status},active,me.__attendee);}}
else
if(elm.tagName!='SPAN'&&!me.__attendee)
gui._create('edit_dialog','frm_edit_attendee','','','frm_edit_attendee','ATTENDEES::ADD_TITLE',[me,'__onAddNew'],'','',me.__owner!=me.__real_email);};this.x_list._getActive=function(){var active=[];for(var i in this.__users)
if(this.__users[i]&&this.__users[i].active&&this.__users[i].action!='remove')
active.push(i);return active;};var ulp=this._getAnchor('user_list_preview');this.x_list._fill=function(scroll_to_last){var c=0,css,out=mkElement('div');var folder=me.__evnid.fid?dataSet.get('folders',[me.__evnid.aid,Path.slash(me.__evnid.fid)])||{}:{};var bIsOrganizer=!me.__evnid.iid||this.__users.some(function(user){return user.email===me.__real_email&&user.role==='G';})||~(folder.RIGHTS||'').indexOf('w')||(me.__evnid.owner_id===sPrimaryAccount);var myself=false;this.__users=this.__users.sort(function(a,b){return(a.role==='G')?-1:(b.role==='G');});for(var i=0;i<this.__users.length;i++){if(this.__users[i].action=='remove')
continue;css='';if(this.__users[i].status)
css='status_'+this.__users[i].status;if(this.__users[i].role)
css+=(css?' ':'')+'role_'+this.__users[i].role;out.appendChild(mkElement('div',{id:me._pathName+'.list/'+i,className:(this.__users[i].active?'active':'')+(this.__users[i].css?' '+this.__users[i].css:'')+' '+css,unselectable:'on',title:this.__users[i].email,innerHTML:'<div class="img" style="background-image: url(\''+getAvatarURL(this.__users[i].email)+'\')"></div>'+(this.__users[i].email===me.__real_email?getLang('COMMON::YOU'):(this.__users[i].name||this.__users[i].email).escapeHTML())+((!i&&WMFolders.getType(me._id)=='I'&&this.__users[i].role=='Q')||!(this.__users[i].role!='G'&&bIsOrganizer)?'':(me.__attendee?'':'<span></span>'))}));if(this.__users[i].email===me.__real_email){myself=true;}
c++;}
this.innerHTML=out.innerHTML;out=null;if(scroll_to_last){this.lastElementChild.scrollIntoView();}
if(me._container)
me._container.style.height=(c>8?(c*25)+'px':'100%');if(this.__users.length===1){myself=false;}
ulp.textContent=getLang('ATTENDEES::ATTENDEES'+(myself?'_MYSELF':''),[this.__users.length-(myself?1:0)]);};this.x_list._addUser=function(aInfo,bNoUpdate,bSkipNew,bNoScroll){me.__forced_note=false;me._closeNote();if(aInfo.email&&aInfo.email.indexOf('[')===0){(new wm_tools()).distrib({name:aInfo.email},[this,'_addGroup',[aInfo.role,bNoUpdate,bSkipNew,bNoScroll]]);return false;}else{aInfo.email=aInfo.email.toLowerCase();for(var i=this.__users.length-1;i>-1;i--)
if(this.__users[i].email==aInfo.email&&this.__users[i].action!='remove')
return false;if(!bSkipNew){aInfo.action='new';ulb.classList.add('expanded');}
this.__users.push(aInfo);this._fill(!bNoScroll);if(!bNoUpdate)
me.x_freebusy._users(this.__users.map(function(user){return user.email;}));return true;}};this.x_list._addGroup=function(aData,sRole,bNoUpdate,bSkipNew,bNoScroll){for(var i in aData){aData[i].role=sRole;this._addUser(aData[i],true,bSkipNew,bNoScroll);}
if(!bNoUpdate)
me.x_freebusy._users(this.__users.map(function(user){return user.email;}));};this.x_list._editUser=function(aValues,iid){if(Is.Defined(iid)&&this.__users[iid]){for(var i=this.__users.length-1;i>-1;i--)
if(i!=iid&&this.__users[i].email==aValues.email){aValues.email=this.__users[iid].email;break;}
var doUpd=false;if(this.__users[iid].email!=aValues.email)
doUpd=true;for(var i in aValues)
this.__users[iid][i]=aValues[i];if(this.__users[iid].action!=='new'){this.__users[iid].action='edit';}
this._fill();if(doUpd)
me.x_freebusy._users(this.__users.map(function(user){return user.email;}));}
else{aValues.checked=true;this._addUser(aValues);}};this.x_list._removeUser=function(){var rem=false;for(var i in this.__users)
if(this.__users[i]&&this.__users[i].active){if(this.__users[i].action=='new')
this.__users.splice(i,1);else
this.__users[i].action='remove';rem=true;}
if(rem){this._fill();me.x_freebusy._users(this.__users.map(function(user){return user.email;}));}};this.x_list._getAttendees=function(){var aResult=[];for(var i in this.__users){switch(this.__users[i]['action']){case'remove':aResult.push({'uid':this.__users[i]['id']});break;case'edit':aResult.push({'uid':this.__users[i].id,'values':{CNTCONTACTNAME:this.__users[i].name,CNTEMAIL:this.__users[i].email,CNTROLE:this.__users[i].role,CNTSTATUS:this.__users[i].status,CNT_ID:this.__users[i].id}});break;case'new':aResult.push({'values':{CNTCONTACTNAME:this.__users[i].name,CNTEMAIL:this.__users[i].email,CNTROLE:this.__users[i].role,CNTSTATUS:this.__users[i].status,CNT_ID:this.__users[i].id}});default:break;}}
return aResult;};var ulp=this._getAnchor('user_list_preview');var ulc=this._getAnchor('user_list_collapse');var ulb=this._getAnchor('user_list_block');ulp.addEventListener('click',function(){ulb.classList.add('expanded');});ulc.addEventListener('click',function(){ulb.classList.remove('expanded');});var acc=MailAddress.splitEmailsAndNames(sOwner||me.__real_email)[0];acc.css='main_account';acc.role='G';acc.status='A';var aAccInfo=dataSet.get('accounts',[sOwner||me.__real_email]);if(aAccInfo&&aAccInfo['FULLNAME'])
acc.name=aAccInfo['FULLNAME'];users2.forEach(function(user){this.x_list._addUser(user,false,!!me._id[2],true);},this);if(WMFolders.getType([this._sAccountID,this._sFolderID])!=='I')
this.x_list._addUser(acc,false,true,true);this.__initForm('EVENT::EVENT');var datetime=this.X_TIMEINTERVAL._value();this.x_freebusy._value({startdate:datetime.EVNSTARTDATE,starttime:datetime.EVNSTARTTIME,enddate:datetime.EVNENDDATE,endtime:datetime.EVNENDTIME,tzid:datetime.TZID,title:this.EVNTITLE._value()||getLang('EVENT::EVENT')});if(this._aValues.EVNNOTE){this._showNote(this._aValues.EVNNOTE,this._aValues.EVNDESCFORMAT==='text/plain');openNote();}
this._closeBlocks();if(!me._id[2]||this.x_list.__users.length<10){ulb.classList.add('expanded');}};_me._closeNote=function(){if(!this.x__note||this.__forced_note){return;}
var
isPlainText=this.x__note.select._value()==='disabled',value=this.x__note._value(),close;this.x_note.__originalValue.EVNDESCFORMAT=isPlainText?'text/plain':'text/html';if(isPlainText){value=value.unescapeHTML();}
this.x_note.__originalValue.EVNNOTE=value;this._showNote(value,isPlainText);this.x_freebusy._main.style.zIndex=0;this.x_freebusy._main.style.opacity=1;this.x__note._destruct();close=this._main.querySelector('.done_editing');close&&close.parentNode.removeChild(close);};_me._showNote=function(value,isPlainText){if(!isPlainText){var tmp=document.implementation.createHTMLDocument('').body;tmp.innerHTML=DOMPurify.sanitize(value);value=tmp.textContent||tmp.innerText||'';}
if(value.trim()){this.x_note._value(value.escapeHTML());this.x_note._main.classList.add('filled');}
else{this.x_note._value(getLang('EVENT::ADD_NOTE'));this.x_note._main.classList.remove('filled');}};_me.__onEdit=function(aValues,iid){this.x_list._editUser({name:aValues.CNTCONTACTNAME,email:aValues.CNTEMAIL,role:aValues.CNTROLE,status:aValues.CNTSTATUS,id:aValues.CNT_ID},iid);};_me.__onAddNew=function(aValues){var out={name:aValues.CNTCONTACTNAME,email:aValues.CNTEMAIL,role:~this.EVNLOCATION.__out.indexOf(aValues.CNTEMAIL)?'S':aValues.CNTROLE};if(aValues.CNTSTATUS!=='P')
out.status=aValues.CNTSTATUS;this.x_list._addUser(out);};_me.__onAddNewFromAddressbook=function(bOK,aAddresses,sRole){if(bOK&&aAddresses[0]){var tmp,bUpdate=false;for(var i in aAddresses[0]){tmp=MailAddress.splitEmailsAndNames(aAddresses[0][i]);if(typeof tmp[0]==='object'){var resource=false;for(var i in this.EVNLOCATION.__out||{}){resource=MailAddress.splitEmailsAndNames(this.EVNLOCATION.__out[i])[0].email===tmp[0].email;if(resource){break;}}
tmp[0].role=resource?'S':(Is.String(sRole)?sRole:'Q');bUpdate=this.x_list._addUser(tmp[0],true);}}
if(bUpdate){this.x_freebusy._users(this.x_list.__users.map(function(user){return user.email;}));}}};_me._initGooglePlacesAutocomplete=function(API_KEY){if(!API_KEY){return;}
if(!document.getElementById('googleapis')){document.head.appendChild(mkElement('script',{id:'googleapis',src:'https://maps.googleapis.com/maps/api/js?key='+API_KEY+'&libraries=places&callback='+this._pathName+'.__googlePlacesAutocompleteCallback',}));}else{this.__googlePlacesAutocompleteCallback();}};_me.__googlePlacesAutocompleteCallback=function(){var me=this;var service=new google.maps.places.AutocompleteService();var last_value='';this.EVNLOCATION.__eIN.addEventListener('keyup',function(e){if(e.target.value){me.EVNLOCATION._custom_list_className='powered_by_google';if(last_value!==e.target.value){last_value=e.target.value;service.getQueryPredictions({input:e.target.value},function(results){var out={};for(var i in me.EVNLOCATION.__out){if(~me.EVNLOCATION.__out[i].toLowerCase().indexOf(e.target.value)){out[i]=me.EVNLOCATION.__out[i];}}
(results||[]).forEach(function(result){out[result.description]=result.description;});me.EVNLOCATION._fill(out);me.EVNLOCATION._show();});}else{me.EVNLOCATION._show();}}else{me.EVNLOCATION._custom_list_className='';me.EVNLOCATION.block&&!me.EVNLOCATION.block._destructed&&me.EVNLOCATION.block._destruct();me.EVNLOCATION._fill(me.EVNLOCATION.__out);}});};_me._closeBlocks=function(){this._previewTimeBlock();this._previewMemoBlock();};_me._previewTimeBlock=function(){var v=this.X_TIMEINTERVAL._value();this._getAnchor('time_preview').innerHTML=[new iMipRecurrence(this._repeatToImip(this.X_REPEATING.__rcrvalue),IcewarpDate.julian(v.EVNSTARTDATE,v.EVNSTARTTIME),v.EVNTIMEFORMAT!=='F',IcewarpDate.julian(v.EVNENDDATE,v.EVNENDTIME)).toString('dddd D, MMM').replace(),(this.X_REMINDERS._value()&&this.X_REMINDERS._value()!=='0')?getLang('REMINDER::REMINDER')+' '+this._reminderObjectToText(this._reminderKeyToObject(this.X_REMINDERS._value())):false].filter(Boolean).join('<br>');};_me._previewMemoBlock=function(){var attachments=this.X_ATTACHMENTS.__idtable.filter(function(attachement){return!attachement.removed;});this._getAnchor('attach_preview').innerHTML=attachments.length?getLang('ATTACHMENT::N_ATTACHMENTS',[attachments.length.toString()]):getLang('ATTACHMENT::ADD_ATTACHMENT');var tags=[].map.call(this.EVNTYPE.input.__etag.querySelectorAll('span'),function(tag){return'<span style="'+tag.getAttribute('style')+'">'+tag.textContent.entityify()+'</span>';});this._getAnchor('tags_preview').innerHTML=tags.length?tags.join(''):getLang('TAGS::ADD_TAGS');};_me._setReminderSelect=function(REMINDERS){var rem;for(var i in REMINDERS){if(REMINDERS[i].values&&(!REMINDERS[i].values.RMNTIME||(+REMINDERS[i].values.RMNDAYSBEFORE||+REMINDERS[i].values.RMNHOURSBEFORE||+REMINDERS[i].values.RMNMINUTESBEFORE))){rem=REMINDERS[i];break;}}
if(!rem){this.X_REMINDERS._value('0');}else{if(~[1,2,7].indexOf(+rem.values.RMNDAYSBEFORE)){this.X_REMINDERS._value(rem.values.RMNDAYSBEFORE+'D');}else if(~[1440,2880,10080].indexOf(+rem.values.RMNMINUTESBEFORE)){this.X_REMINDERS._value(rem.values.RMNMINUTESBEFORE/1440+'D');}else if(~[1,2].indexOf(+rem.values.RMNHOURSBEFORE)){this.X_REMINDERS._value(rem.values.RMNHOURSBEFORE+'H');}else if(~[60,120].indexOf(+rem.values.RMNMINUTESBEFORE)){this.X_REMINDERS._value(rem.values.RMNMINUTESBEFORE/60+'H');}else if(~[0,10,30].indexOf(+rem.values.RMNMINUTESBEFORE)){this.X_REMINDERS._value(rem.values.RMNMINUTESBEFORE+'M');}else{this.X_REMINDERS._value('*',true);}
this.X_REMINDERS.__eLBL.innerHTML=this._reminderObjectToText(rem.values);}
this.X_REMINDERS.__value=rem;};_me._reminderKeyToObject=function(key){switch(key){case'0':return'';case'0M':return{values:{RMNDAYSBEFORE:0,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:0}};case'10M':return{values:{RMNDAYSBEFORE:0,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:10}};case'30M':return{values:{RMNDAYSBEFORE:0,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:30}};case'1H':return{values:{RMNDAYSBEFORE:0,RMNHOURSBEFORE:1,RMNMINUTESBEFORE:00}};case'2H':return{values:{RMNDAYSBEFORE:0,RMNHOURSBEFORE:2,RMNMINUTESBEFORE:0}};case'1D':return{values:{RMNDAYSBEFORE:1,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:0}};case'2D':return{values:{RMNDAYSBEFORE:2,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:0}};case'7D':return{values:{RMNDAYSBEFORE:7,RMNHOURSBEFORE:0,RMNMINUTESBEFORE:0}};}
if(key&&key.values){key.values.RMNDAYSBEFORE=key.values.RMNDAYSBEFORE||0;key.values.RMNHOURSBEFORE=key.values.RMNHOURSBEFORE||0;key.values.RMNMINUTESBEFORE=key.values.RMNMINUTESBEFORE||0;}
return key;};_me._reminderObjectToText=function(value){var v=(value||{}).values||value;if(!v){return'REMINDER::NONE';}
if(+v.RMNDAYSBEFORE===7||+v.RMNMINUTESBEFORE===10080){return getLang('REMINDER::WEEKBEFORE');}else if(+v.RMNDAYSBEFORE){return getLang('REMINDER::DAYSBEFORE',[+v.RMNDAYSBEFORE]);}else if(+v.RMNHOURSBEFORE){return getLang('REMINDER::HOURSBEFORE',[+v.RMNHOURSBEFORE]);}else if(+v.RMNMINUTESBEFORE){if(+v.RMNMINUTESBEFORE%1440===0){return getLang('REMINDER::DAYSBEFORE',[+v.RMNMINUTESBEFORE/1440]);}else if(+v.RMNMINUTESBEFORE%60===0){return getLang('REMINDER::HOURSBEFORE',[+v.RMNMINUTESBEFORE/60]);}}
return getLang('REMINDER::MINUTESBEFORE',[+v.RMNMINUTESBEFORE]);};_me._setRecurrenceSelect=function(RECURRENCES,bNoUpdate){var rec;for(var i in RECURRENCES){rec=RECURRENCES[i];}
if(!rec||!rec.values){this.X_REPEATING._value('0');}else{if(!+rec.values.RCRCOUNT){if(+rec.values.RCRDAYREPETITION===1&&+rec.values.RCRMONTHREPETITION===0){this.X_REPEATING._value('D',bNoUpdate);}else if(+rec.values.RCRWEEKREPETITION===1&&(rec.values.RCRDAYOFWEEKNUMBER==0||+rec.values.RCRDAYOFWEEKNUMBER===[1,2,4,8,16,32,64][IcewarpDate.julian(this.X_TIMEINTERVAL._value().EVNSTARTDATE).day()])){this.X_REPEATING._value('W',bNoUpdate);}else if(+rec.values.RCRWEEKREPETITION===2&&(rec.values.RCRDAYOFWEEKNUMBER==0||+rec.values.RCRDAYOFWEEKNUMBER===[1,2,4,8,16,32,64][IcewarpDate.julian(this.X_TIMEINTERVAL._value().EVNSTARTDATE).day()])){this.X_REPEATING._value('F',bNoUpdate);}else if(+rec.values.RCRMONTHREPETITION===1&&+rec.values.RCRDAYREPETITION===IcewarpDate.julian(this.X_TIMEINTERVAL._value().EVNSTARTDATE).date()){this.X_REPEATING._value('M',bNoUpdate);}else if(+rec.values.RCRYEARREPETITION===1){this.X_REPEATING._value('Y',bNoUpdate);}else{this.X_REPEATING._value('*',true);this.X_REPEATING.__eLBL.innerHTML=new iMipRecurrence(this._repeatToImip(rec)).toString();}}else{this.X_REPEATING._value('*',true);this.X_REPEATING.__eLBL.innerHTML=new iMipRecurrence(this._repeatToImip(rec)).toString();}}
this.X_REPEATING.__rcrvalue=rec;};_me._repeatingKeyToObject=function(key){switch(key){case'0':return void 0;case'D':return{values:{RCRDAYREPETITION:1,RCRDAYOFWEEKNUMBER:0,RCRWEEKREPETITION:0,RCRWEEKOFMONTHNUMBER:0,RCRMONTHREPETITION:0,RCRMONTHOFYEARNUMBER:0,RCRYEARREPETITION:0,RCRENDDATE:"",RCRCOUNT:""}};case'W':return{values:{RCRDAYREPETITION:0,RCRDAYOFWEEKNUMBER:0,RCRWEEKREPETITION:1,RCRWEEKOFMONTHNUMBER:0,RCRMONTHREPETITION:0,RCRMONTHOFYEARNUMBER:0,RCRYEARREPETITION:0,RCRENDDATE:"",RCRCOUNT:""}};case'F':return{values:{RCRDAYREPETITION:0,RCRDAYOFWEEKNUMBER:0,RCRWEEKREPETITION:2,RCRWEEKOFMONTHNUMBER:0,RCRMONTHREPETITION:0,RCRMONTHOFYEARNUMBER:0,RCRYEARREPETITION:0,RCRENDDATE:"",RCRCOUNT:""}};case'M':return{values:{RCRDAYREPETITION:IcewarpDate.julian(this.X_TIMEINTERVAL._value().EVNSTARTDATE).date(),RCRDAYOFWEEKNUMBER:0,RCRWEEKREPETITION:0,RCRWEEKOFMONTHNUMBER:0,RCRMONTHREPETITION:1,RCRMONTHOFYEARNUMBER:0,RCRYEARREPETITION:0,RCRENDDATE:"",RCRCOUNT:""}};case'Y':return{values:{RCRDAYREPETITION:0,RCRDAYOFWEEKNUMBER:0,RCRWEEKREPETITION:0,RCRWEEKOFMONTHNUMBER:0,RCRMONTHREPETITION:0,RCRMONTHOFYEARNUMBER:0,RCRYEARREPETITION:1,RCRENDDATE:"",RCRCOUNT:""}};}
return key;};_me._repeatToImipWeekDay=function(v){if(+v.RCRDAYOFWEEKNUMBER){var days=[];['SU','MO','TU','WE','TH','FR','SA'].forEach(function(h,k){if(+v.RCRDAYOFWEEKNUMBER&Math.pow(2,k)){days.push((+v.RCRWEEKOFMONTHNUMBER||'')+h);}});if(days.length){return'BYDAY='+days.join(',');}}};_me._repeatToImip=function(repeat){var v=(repeat||{}).values||repeat;if(!v){return'';}
var freq;var interval;var specific=[];var limit;if(+v.RCRYEARREPETITION){freq='YEARLY';interval=v.RCRYEARREPETITION;if(+v.RCRMONTHOFYEARNUMBER){specific.push('BYMONTH='+v.RCRMONTHOFYEARNUMBER);}
specific.push(this._repeatToImipWeekDay(v));}else if(+v.RCRMONTHREPETITION){freq='MONTHLY';interval=v.RCRMONTHREPETITION;specific.push(this._repeatToImipWeekDay(v));if(+v.RCRDAYREPETITION){specific.push('BYMONTHDAY='+v.RCRDAYREPETITION);}}else if(+v.RCRWEEKREPETITION){freq='WEEKLY';interval=v.RCRWEEKREPETITION;specific.push(this._repeatToImipWeekDay(v));}else if(+v.RCRDAYREPETITION){freq='DAILY';interval=v.RCRDAYREPETITION;}
if(+v.RCRCOUNT){limit='COUNT='+v.RCRCOUNT;}else if(+v.RCRENDDATE){limit='UNTIL='+IcewarpDate.julian(+v.RCRENDDATE).format('YYYYMMDD[T]HHmmss[Z]');}
return['FREQ='+freq,'INTERVAL='+interval,specific.filter(Boolean).join(';'),limit].filter(Boolean).join(';');};_me.__print=function(aValues){this.__forced_note=false;this._closeNote();aValues=aValues.values;if('text/html'===aValues.EVNDESCFORMAT){aValues.EVNNOTE=DOMPurify.sanitize(aValues.EVNNOTE);}
if((aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE)>0){if((aValues._TZEVNSTARTTIME||aValues.EVNSTARTTIME)>0){aValues.COUNT_DATE=IcewarpDate.julian(aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE).setTime(aValues._TZEVNSTARTTIME||aValues.EVNSTARTTIME,true).format('L LT');}else{aValues.COUNT_DATE=IcewarpDate.julian(aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE).setTime(0).format('L');}
if((aValues._TZEVNENDTIME||aValues.EVNENDTIME)>0){aValues.COUNT_DATE+=' - '+IcewarpDate.julian(aValues._TZEVNENDDATE||aValues.EVNENDDATE).setTime(aValues._TZEVNENDTIME||aValues.EVNENDTIME,true).format('L LT');}else{aValues.COUNT_DATE+=' - '+IcewarpDate.julian(aValues._TZEVNENDDATE||aValues.EVNENDDATE).setTime(0).format('L');}}else
aValues.COUNT_DATE='';if(!gui.print)
gui._create('print','frm_print');gui.print._add('E',aValues);};_me.__loadItems=function(){var me=this;this._setRecurrenceSelect(this._aValues.RECURRENCES,true);for(var i in this._aValues.REMINDERS){this.__reminderID=i;break;}
if(!this._aValues.TZID){this._aValues.TZID=GWOthers.getItem('CALENDAR_SETTINGS','timezone');this._aValues.EVNTIMEFORMAT='Z';}
if(this._aValues.EVNSTARTDATE===void 0){this._aValues=arrConcat(this._aValues,getActualEventTime());}
var me=this;this.X_TIMEINTERVAL._value(this._aValues);this.X_TIMEINTERVAL._onchange=function(){me.__forced_note=false;me._closeNote();me._aValues['EVNSTARTDATE']=this._value().EVNSTARTDATE;var datetime=me.X_TIMEINTERVAL._value();me.x_freebusy._value({startdate:datetime.EVNSTARTDATE,starttime:Math.max(datetime.EVNSTARTTIME,0),enddate:datetime.EVNENDDATE,endtime:Math.max(datetime.EVNENDTIME,0),tzid:datetime.TZID,title:me.EVNTITLE._value()||getLang('EVENT::EVENT')},true);};if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues['ATTACHMENTS'][i]['values']['FULLPATH']||me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});this.X_ATTACHMENTS._value({path:!me._aValues.fullpath&&me._sItemID?me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID):void 0,values:out});}else if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}
loadDataIntoForm(this,this._aValues);if(!this._aValues['EVN_ID']){this.X_EVNFLAGS._value(GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','event_show_as'));if(+GWOthers.getItem('EVENT_SETTINGS','DEFAULT_REMINDER')){this._setReminderSelect([{values:{RMNMINUTESBEFORE:GWOthers.getItem('EVENT_SETTINGS','TIME')/60000}}]);}else{this.X_REMINDERS._value('0');}}else{this._setReminderSelect(this._aValues.REMINDERS);var tmp='S',flg=this._aValues.EVNFLAGS?this._aValues.EVNFLAGS*1:0;if((flg&16)===16){tmp='O';}else if((flg&4)===4){tmp='F';}else if((flg&8)===8){tmp='T';}
this.X_EVNFLAGS._value(tmp);}
if((this._aValues.EVNFLAGS&64)||(~['I','Y'].indexOf((dataSet.get('folders',[this._id[0],this._id[1]])||{}).TYPE))){this.X_REMINDERS._value('');this.X_REMINDERS._disabled(true);this.X_REMINDERS._main.parentNode.parentNode.setAttribute('hidden','');}
this.EVNTITLE._onkeyup();this._closeBlocks();};_me.__onBeforeSave=function(){!this.EVNTITLE._value()&&this.EVNTITLE._value(getLang('EVENT_VIEW::NEWAPPOINTMENT'));this.__forced_note=false;this._closeNote();this._sItemID=this._sItemID||'';};_me.__saveItems=function(aValues){var addon;if(this.x_note.__originalValue){aValues.values.EVNDESCFORMAT=this.x_note.__originalValue.EVNDESCFORMAT;aValues.values.EVNNOTE=this.x_note.__originalValue.EVNNOTE.replace(/<br>/g,'<br />');}
if(aValues.values.EVNNOTE){aValues.values.EVNNOTE=aValues.values.EVNNOTE.replace(/>\n</g,'><');}
if(!Is.Defined(this._id[2]))
this._id=Path.split(this.X_PATH._value());if(this._aValues.EVNFLAGS)
aValues.values.EVNFLAGS=this._aValues.EVNFLAGS&~(4|8|16);else
aValues.values.EVNFLAGS=0;var tmp={F:4,T:8,O:16,S:0};aValues.values.EVNFLAGS|=(aValues.values.EVNFLAGS||0)|tmp[this.X_EVNFLAGS._value()];aValues.values=arrConcat(aValues.values,this.X_TIMEINTERVAL._value());if(!Is.Empty(addon=this._reminderKeyToObject(this.X_REMINDERS._value()))){if(this.__reminderID){addon.uid=this.__reminderID;}
aValues['REMINDERS']=[addon];}else if(this.__reminderID){aValues['REMINDERS']=[{uid:this.__reminderID}];}
if(aValues.values['MEETING_ACTION']==1){if(this._aValues.EVNMEETINGID&&(this._aValues.EVNMEETINGID!==true)){aValues.values['MEETING_ACTION']='edit';}else{aValues.values['MEETING_ACTION']='create';}}
delete aValues.values['btn_meet'];if(this.X_REPEATING&&!Is.Empty(addon=this._repeatingKeyToObject(this.X_REPEATING.__rcrvalue))){if(addon.values&&addon.values.RCRENDDATE&&addon.values.RCRENDDATE<aValues.values.EVNSTARTDATE)
addon.values.RCRENDDATE=aValues.values.EVNSTARTDATE;aValues['RECURRENCES']=[addon];if(this._aValues.RECURRENCES&&Is.Object(this._aValues.RECURRENCES[this._aValues.EVNRCR_ID])&&compareObj(this._aValues.RECURRENCES[this._aValues.EVNRCR_ID],addon,true)){delete aValues.RECURRENCES;}}
else
delete aValues.RECURRENCES;if(this.x_include_in_my_cal&&this.x_include_in_my_cal._checked()){this.x_list._addUser({email:this.__real_email,name:'',role:'Q'});}
if(!Is.Empty(addon=this.x_list._getAttendees())){aValues['CONTACTS']=addon;if(!(aValues.values.EVNFLAGS&2))
aValues.values.EVNFLAGS=aValues.values.EVNFLAGS|1;else
aValues.values.EVNFLAGS=aValues.values.EVNFLAGS&~1;}
if(!this._sItemID&&this._sAccountID===this.__real_email){var sFolderID=this._sFolderID;if(sFolderID==='__@@VIRTUAL@@__/__@@EVENTS@@__'){var aCalendars=dataSet.get('folders',[this.__real_email,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS']);for(var i in aCalendars)
if(aCalendars[i]){sFolderID=i;break;}}
if(sFolderID.indexOf(dataSet.get('main',['resources_path'])+'/')==0){var bFound=false;if(aValues['CONTACTS']){for(var i in aValues['CONTACTS'])
if(aValues['CONTACTS'][i].values.CNTEMAIL==this.__real_email){bFound=true;break;}}else
aValues['CONTACTS']=[];if(!bFound){aValues['CONTACTS'].push({values:{CNTEMAIL:this.__real_email,CNTROLE:'Q'}});aValues.values.EVNFLAGS|=1;}}}
if(aValues.values.EVNLOCATION&&aValues.values.EVNLOCATION.indexOf('@')>-1){var aMail=MailAddress.splitEmailsAndNames(aValues.values.EVNLOCATION);if(aMail&&aMail[0]&&aMail[0].email){var aOld={},found=false;if(this._aValues&&this._aValues.CONTACTS)
aOld=this._aValues.CONTACTS;if(aValues&&aValues.CONTACTS)
for(var i in aValues.CONTACTS)
if(aValues.CONTACTS[i].values&&aValues.CONTACTS[i].values.CNTEMAIL==aMail[0].email){found=true;break;}
else
if(aValues.CONTACTS[i].uid)
delete aOld[aValues.CONTACTS[i].uid];if(!found&&!Is.Empty(aOld))
for(var i in aOld)
if(aOld[i].values&&aOld[i].values.CNTEMAIL==aMail[0].email){found=true;break;}
if(!found){if(!aValues.CONTACTS)aValues.CONTACTS=[];aValues.CONTACTS.push({values:{CNTEMAIL:aMail[0].email,CNTCONTACTNAME:aMail[0].name,CNTROLE:'S'}});aValues.values.EVNFLAGS|=1;}}}
if(this._aValues.CONTACTS&&this.__originalLocation&&aValues.values.EVNLOCATION!=this.__originalLocation){var email=MailAddress.splitEmailsAndNames(this.__originalLocation)[0].email;if(!aValues.CONTACTS)aValues.CONTACTS=[];for(var i in this._aValues.CONTACTS){if(this._aValues.CONTACTS[i].values&&this._aValues.CONTACTS[i].values.CNTEMAIL==email){aValues.CONTACTS.push({uid:i});break;}}}
if(!Is.Empty(addon=this.x_list._getAttendees())){for(var i in addon)
if(addon[i].action=='remove'){this._notify_attendees=true;break;}}
if(this.X_ATTACHMENTS&&!Is.Empty(addon=this.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=addon;if(aValues.values['TZID']=='F'){aValues.values['EVNTIMEFORMAT']='F';delete aValues.values['TZID'];}else
if(aValues.values['EVNTIMEFORMAT']=='Z'){aValues.values['_TZEVNSTARTDATE']=aValues.values['EVNSTARTDATE'];aValues.values['_TZEVNENDDATE']=aValues.values['EVNENDDATE'];aValues.values['_TZEVNSTARTTIME']=aValues.values['EVNSTARTTIME'];aValues.values['_TZEVNENDTIME']=aValues.values['EVNENDTIME'];aValues.values['_TZID']=aValues.values['TZID'];delete aValues.values['EVNSTARTDATE'];delete aValues.values['EVNENDDATE'];delete aValues.values['EVNSTARTTIME'];delete aValues.values['EVNENDTIME'];delete aValues.values['TZID'];}
if(this._aValues['EXPDATE'])
aValues.values['EXPDATE']=this._aValues['EXPDATE'];if(this._aValues['EXPFOLLOWING'])
aValues.values['EXPFOLLOWING']=this._aValues['EXPFOLLOWING'];};

/* client/inc/frm_file.js */
_me=frm_file.prototype;function frm_file(){};_me.__constructor=function(){this._skip_teamchat_choose_folder=arguments[6];var me=this;this._defaultSize(-1,-1,740,315);this._create('x_btn_ok','obj_button','footer','noborder color1');this.x_btn_ok._value('FORM_BUTTONS::SAVE');if(!this._sItemID){this._size(740,this._skip_teamchat_choose_folder?290:315);this._resizable(false);this._draw('frm_file_main','main',{folders:(this._aValues.fullpath)?true:false,teamchat:!!this._skip_teamchat_choose_folder});this.__tab1=this;this._create('X_ATTACHMENTS','obj_upload_edit','attach','noborder');this.X_ATTACHMENTS._create('btn_blank','obj_button','controls','simple ico blank');this.X_ATTACHMENTS.btn_blank._value('FILE::BLANK_DOC');this.X_ATTACHMENTS.btn_blank._disabled(this.__readonly);this.X_ATTACHMENTS.btn_blank._main.onmousedown=function(e){var e=e||window.event;if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;};this.X_ATTACHMENTS.btn_blank._onclick=function(e){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;if(this.cmenu&&!this.cmenu._destructed){this.cmenu._destruct();delete this.cmenu;return;}
var pos=getSize(this._main),aMenu=[{"title":'MAIN_MENU::NEW_WORD','arg':'.docx'},{"title":'MAIN_MENU::NEW_EXCEL','arg':'.xlsx'},{"title":'MAIN_MENU::NEW_PPOINT','arg':'.pptx'},{"title":'MAIN_MENU::NEW_TEXT','arg':'.txt'},{"title":'MAIN_MENU::NEW_HTML','arg':'.html'}];this.cmenu=gui._create("cmenu","obj_context",'','',this),this.cmenu._fill(aMenu);this.cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',1);this.cmenu._onclick=function(e,elm,id,arg){if(arg){me.X_ATTACHMENTS._value({'values':[{"name":arg,"class":'document'}]});me.X_ATTACHMENTS._rename(me.X_ATTACHMENTS.list.__idtable.length-1);}};};}
else{this._size(false,585);this._draw('frm_file','main',{folders:(this._aValues.fullpath)?true:false,revisions:(this._aValues.REVISIONS?true:false),disable_html:!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message')&&'0'===GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')});this.__tab1=this.maintab.tab1;this._create('X_ATTACHMENTS','obj_upload_edit_single','attach','big noborder');this.X_ATTACHMENTS.list.__hasRemove=false;if(this._aValues.EVNLOCKOWN_ID&&this._aValues.EVNLOCKOWN_ID!=sPrimaryAccountGWID)
this.__readonly=true;}
if(this.__tab1.EVNNOTE){this.__tab1.EVNNOTE.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});this.__tab1.EVNNOTE.select._value('enabled');this.__tab1.EVNNOTE._onesc=function(){me._close(true);};this.__tab1.EVNNOTE._rtl&&this.__tab1.EVNNOTE.__eFrame.contentDocument.body.setAttribute('dir','rtl');this.__tab1.EVNNOTE._onresize=function(){var frmtbl=me._getAnchor('main').querySelector('.popupmaindialog > .frmtbl');frmtbl&&me._size(false,frmtbl.offsetHeight+88);};}else{this._create('EVNNOTE','obj_chat_input','text','',{smiles_enabled:GWOthers.getItem('CHAT','smiles')=='1'});this.EVNNOTE.input._placeholder(getLang('IM::COMMENT_PH'));this.EVNNOTE.input._onsubmit=function(){!me.x_btn_ok._disabled()&&me.x_btn_ok._onclick();};this.EVNNOTE.input._onresize=function(){var frmtbl=me._getAnchor('main').querySelector('.popupmaindialog > .frmtbl');frmtbl&&me._size(false,frmtbl.offsetHeight+88);};this.EVNNOTE._folder({aid:this._sAccountID,fid:this._sFolderID});}
this._create('x_btn_cancel','obj_button','footer','cancel noborder simple');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct()};this.__tab1._getAnchor('msiebox')&&msiebox(this.__tab1._getAnchor('msiebox'));if(this.x_btn_ok)
this.x_btn_ok._disabled(true);this.X_ATTACHMENTS._disabled(this.__readonly);this.X_ATTACHMENTS._onchange=function(){var sName=getLang('FILE::FILE');if(this.__idtable)
for(var i=this.__idtable.length-1;i>-1;i--)
if(!this.__idtable[i].removed&&this.__idtable[i].name){sName=this.__idtable[i].description||this.__idtable[i].name||'';if(sName.length>64)
sName=sName.substr(0,50)+'..'+Path.extension(sName);break;}
me._title(sName+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:'')+(me._aValues.EVNEXPIRE>0?' - '+getLang('FILE::EXPIRE',[IcewarpDate.unix(me._aValues.EVNEXPIRE).format('L')]):''),true);};this.__initForm('FILE::FILE');if(this.__tab1.x_folders){if(this._sItemID){this.__tab1.x_folders._destruct();this.__tab1._getAnchor('folder').classList.add('readonly');}else{this.__tab1.x_folders._onclick=function(){gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',me._sAccountID,me._sFolderID,[me,'__changeFolder'],true,true,['F','Y','I'],'',false,'wk');};}}
this.X_ATTACHMENTS._onuploadstart=function(){if(this._parent.x_btn_ok)
this._parent.x_btn_ok._disabled(true);if(this._parent.x_btn_cancel)
this._parent.x_btn_cancel._disabled(true);};this.X_ATTACHMENTS._onuploadend=function(){me.__checkEnableForm();if(this._parent.x_btn_cancel)
this._parent.x_btn_cancel._disabled(false);};if(!this.__readonly&&this.X_ATTACHMENTS._dropzone)
this.X_ATTACHMENTS._dropzone(this.__eContainer);if((((this._aValues['ATTACHMENTS']||[])[0]||{})['values']||{})['ATTDESC']){this.X_ATTACHMENTS.btn_blank._disabled(true);this.X_ATTACHMENTS.file._disabled(true);}
this.__tab1._getAnchor('main').onscroll=function(){me.__tab1._getAnchor('main').scrollTop=0;}.bind(this);if(this.__tab1.EVNTYPE)
this.__tab1.EVNTYPE.input._onChange=function(){this.__refreshView=true;}.bind(this);this.__checkEnableForm(void 0,false);};_me._onresize=function(){var
dialogHeight=this._getAnchor('main').querySelector('.popupmaindialog').offsetHeight,height=dialogHeight-300;height=Math.max(height,90);this.__tab1.EVNNOTE._main.style.height=height+'px';};_me.__checkEnableForm=function(b,show_error){var disabled=false;show_error=show_error===void 0?true:show_error;if(this.x_btn_ok){var that=this;if(!this._getAnchor('name')){that=this.maintab.tab1;}
var is_filename=Is.Filename(that._getAnchor('name').value);if(is_filename){that._getAnchor('name').classList.remove('error');}else if(show_error){that._getAnchor('name').classList.add('error');}
disabled=Is.Defined(b)?b:!is_filename;this.x_btn_ok._disabled(disabled);}
return!disabled;};_me.__print=function(aValues){aValues=aValues.values;if(!gui.print)
gui._create('print','frm_print');gui.print._add('F',aValues);};_me.__loadItems=function(){var me=this;if(this.__tab1.EVNNOTE.select){if(!this._aValues||!this._aValues.EVNDESCFORMAT||this._aValues.EVNDESCFORMAT.toLowerCase()!='text/plain')
this.__tab1.EVNNOTE.select._value('enabled');else
this.__tab1.EVNNOTE.select._value('disabled');}
this._title(getLang('FILE::FILE')+(this._aValues.EVNFOLDER?' - '+this._aValues.EVNFOLDER:'')+(this._aValues.EVNEXPIRE>0?' - '+getLang('FILE::EXPIRE',[IcewarpDate.unix(this._aValues.EVNEXPIRE).format('L')]):''),true);if(this._aValues['ATTACHMENTS']||this._aValues['PUSH_ATTACHMENTS']){var out=[],tmp;for(var i in this._aValues['ATTACHMENTS']){tmp={'name':(this._aValues['ATTACHMENTS'][i]['values']['ATTDESC']||'').unescapeHTML(),'class':this._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'size':this._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']};if(this._aValues['ATTACHMENTS'][i]['values']['fullpath'])
tmp.fullpath=this._aValues['ATTACHMENTS'][i]['values']['fullpath'];else
if(this._aValues.fullpath)
tmp.fullpath=this._aValues.fullpath;else
if(this._sItemID)
tmp.folder=this._sAccountID+'/'+this._sFolderID+'/'+WMItems.__serverID(this._sItemID);out.push(tmp);}
if(this._aValues['PUSH_ATTACHMENTS']){this.X_ATTACHMENTS.list._value({path:this._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,this._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:[{'name':this._aValues['PUSH_ATTACHMENTS'][0]['title'],'id':this._aValues['PUSH_ATTACHMENTS'][0]['id'],'size':this._aValues['PUSH_ATTACHMENTS'][0]['size'],'class':this._aValues['PUSH_ATTACHMENTS'][0]['embedded']?'item':'itemlink','fullpath':this._aValues['PUSH_ATTACHMENTS'][0]['fullpath']}]});}else if(this._aValues.fullpath||!this._sItemID)
this.X_ATTACHMENTS.list._value({'values':out});else
this.X_ATTACHMENTS.list._value({'path':this._sAccountID+'/'+this._sFolderID+'/'+WMItems.__serverID(this._sItemID),'values':out});var extension;var mime='';if(this._aValues.PUSH_ATTACHMENTS){extension=(this._aValues.PUSH_ATTACHMENTS[0].title||'').split('.').pop();}else if(Array.isArray(this._aValues['ATTACHMENTS'])){extension=(this._aValues['ATTACHMENTS'][0]['values']['ATTDESC']||'').split('.').pop();}else{Object.keys(this._aValues['ATTACHMENTS']).filter(function(key){return this._aValues.ATTACHMENTS[key].values.ATTTYPE==='attachment';},this).forEach(function(key){extension=(this._aValues.ATTACHMENTS[key].values.ATTDESC||'').split('.').pop();this._aValues.ATTACHMENTS[key].values.ATTPARAMS&&(mime=this._aValues.ATTACHMENTS[key].values.ATTPARAMS.split('=')[1]);},this);}
this.X_ATTACHMENTS._main.style.display='none';var label;if(~mime.indexOf('video')){label=getLang('ITEMVIEW::MIME_VIDEO');}else if(~mime.indexOf('audio')){label=getLang('ITEMVIEW::MIME_SOUND');}else if(~mime.indexOf('image')){label=getLang('ITEMVIEW::MIME_IMG');}else if(~mime.indexOf('template')){label=getLang('ITEMVIEW::MIME_TPL');}else if(~mime.indexOf('spreadsheet')||~mime.indexOf('ms-excel')){label=getLang('ITEMVIEW::MIME_SS');}else if(~mime.indexOf('document')||~mime.indexOf('msword')){label=getLang('ITEMVIEW::MIME_DOC');}else if(~mime.indexOf('compressed')){label=getLang('ITEMVIEW::MIME_ARCHIVE');}else{switch(extension.toLowerCase()){case'pdf':label=getLang('ITEMVIEW::MIME_PDF');break;case'txt':label=getLang('ITEMVIEW::MIME_TXT');break;case'docx':label=getLang('ITEMVIEW::MIME_DOC');break;case'xlsx':label=getLang('ITEMVIEW::MIME_SS');break;case'pptx':label=getLang('ITEMVIEW::MIME_PRESENTATION');break;default:label=getLang('ITEMVIEW::MIME_TXT');break;}}
var that=this;if(!this._getAnchor('icon')){that=this.maintab.tab1;}else{this.x_btn_ok._value('MAIN_MENU::NEW_DOCUMENT');this.x_btn_ok._main.classList.add('new_document');}
that._getAnchor('icon').appendChild(mkElement('div',{className:'icon ico_'+extension,text:label}));that._getAnchor('extension').textContent='.'+extension;if(!WMFolders.getAccess({aid:this._sAccountID,fid:this._sFolderID}).write){this._sFolderID=Mapping.getDefaultFolderForGWType('F');this._sAccountID=sPrimaryAccount;}
this.__changeFolder(this._sAccountID,this._sFolderID,this._sItemID);if(this._skip_teamchat_choose_folder&&~['I','Y'].indexOf(WMFolders.getType([this._sAccountID,this._sFolderID]))){this.__tab1.x_folders._destruct();}else{this.__tab1.x_folders._value('DOCUMENT::CHANGE_FOLDER');}
that._getAnchor('name').value=this.X_ATTACHMENTS.__idtable[0].name.split('.').slice(0,-1).join('.');that._getAnchor('name').focus();that._getAnchor('name').setAttribute('placeholder',getLang('DOCUMENT::NAME_HELPER'));that._getAnchor('name').addEventListener('keyup',function(evn){if(evn.keyCode===13){if(!this.__checkEnableForm()){return;}
evn.target.disabled=true;evn.target.setAttribute('disabled','disabled');evn.target.blur();return this.x_btn_ok._onclick();}
for(var i in this.X_ATTACHMENTS.__idtable){this.X_ATTACHMENTS.__idtable[i].description=that._getAnchor('name').value+'.'+extension;}
var sName=getLang('FILE::FILE');if(this.X_ATTACHMENTS.__idtable)
for(var i=this.X_ATTACHMENTS.__idtable.length-1;i>-1;i--)
if(!this.X_ATTACHMENTS.__idtable[i].removed&&this.X_ATTACHMENTS.__idtable[i].name){sName=this.X_ATTACHMENTS.__idtable[i].description||this.X_ATTACHMENTS.__idtable[i].name;if(sName.length>64)
sName=sName.substr(0,50)+'..'+Path.extension(sName);break;}
this._title(sName+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:'')+(me._aValues.EVNEXPIRE>0?' - '+getLang('FILE::EXPIRE',[IcewarpDate.unix(me._aValues.EVNEXPIRE).format('L')]):''),true);this.__checkEnableForm();}.bind(this));this._colapsed=true;that._getAnchor('separator')&&that._getAnchor('separator').addEventListener('click',function(){this._onresize();if(this._colapsed){that._getAnchor('separator_text').textContent=getLang('DOCUMENT::SHOW_LESS_OPTIONS');that._getAnchor('separator').classList.add('less');var frmtbl=that._getAnchor('main').querySelector('.popupmaindialog > .frmtbl');frmtbl&&this._size(false,frmtbl.offsetHeight+88);this._resizable(true);}else{that._getAnchor('separator_text').textContent=getLang('DOCUMENT::SHOW_MORE_OPTIONS');that._getAnchor('separator').classList.remove('less');this._size(740,315);this._resizable(false);}
this._colapsed=!this._colapsed;}.bind(this));}
loadDataIntoForm(this.__tab1,this._aValues);if(this.__readonly&&this.__tab1._type!=='obj_tab'){this.EVNNOTE&&this.EVNNOTE._disabled(true);this.EVNTYPE&&this.EVNTYPE._readonly(true);}
if(this.maintab&&this.maintab['revisions'])
this.maintab['revisions']._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));var btncheck=function(){var l=me.maintab['revisions'].list._value().length<1,b=me.x_btn_ok._disabled()||l||(me.__readonly?true:false);me.maintab['revisions'].download._disabled(l);me.maintab['revisions'].edit._disabled(b);me.maintab['revisions'].revert._disabled(b);me.maintab['revisions'].remove._disabled(b);};this.list.__sortColumn='DATE';this.list.__sortType='desc';this.list._addColumns({DATE:{title:"DATAGRID_ITEMS_VIEW::DATE",width:120,arg:{sort:'asc'}},OWNER:{title:"DATAGRID_ITEMS_VIEW::SNDOWNER",width:200,arg:{sort:'asc'}},COMMENT:{title:"MAIL_VIEW::COMMENT",width:100,mode:'%',encode:true}});this.list._onchange=function(){btncheck();};this.list._fill2=function(){var aData=[];for(var id in me._aValues['REVISIONS']){aData.push({data:{DATE:[IcewarpDate.unix(me._aValues['REVISIONS'][id].values.REVTIMESTAMP).format('L'),me._aValues['REVISIONS'][id].values.REVTIMESTAMP],OWNER:me._aValues['REVISIONS'][id].values.REVEMAIL,COMMENT:[me._aValues['REVISIONS'][id].values.REVCOMMENT,'',me._aValues['REVISIONS'][id].values.REVCOMMENT]},arg:{id:id}});}
this._fill(aData);btncheck();};this.list._fill2();this.list._ondblclick=function(){this._parent.download._onclick();};this.list._oncontext=function(e,elm,arg,row,col){if(arg&&arg.id){if(inArray(this._value(),row)<0)
this._value([row]);var cmenu=gui._create('cmenu','obj_context');cmenu._fill([{title:'ATTACHMENT::DOWNLOAD',arg:[me.maintab.revisions.download,'_onclick']},{title:'ITEM::EDIT_COMMENT',arg:[me.maintab.revisions.edit,'_onclick'],disabled:me.maintab.revisions.edit._disabled()},{title:'ITEM::REVERT',arg:[me.maintab.revisions.revert,'_onclick'],disabled:me.maintab.revisions.revert._disabled()},{title:'ATTACHMENT::REMOVE',arg:[me.maintab.revisions.remove,'_onclick'],disabled:me.maintab.revisions.remove._disabled()}]);cmenu._place(e.clientX,e.clientY);}};var click=function(){if(this._disabled())return;for(var attid in me._aValues['ATTACHMENTS'])
break;var v=this._parent.list._value();if(attid&&v){if(this._name=='remove'){var uids=[];for(var i in v)
if(this._parent.list._aData[v[i]]&&this._parent.list._aData[v[i]].arg)
uids.push({uid:this._parent.list._aData[v[i]].arg.id});if(uids.length)
WMItems.add([me._sAccountID,me._sFolderID,me._sItemID],{revisions:uids},'','','',[function(bOK){if(bOK==true){for(var i in uids)
delete me._aValues['REVISIONS'][uids[i].uid];me.maintab.revisions.list._fill2();}
else{}}]);}
else
if((v=v[0])&&(v=this._parent.list._aData[v])&&(v=v.arg))
switch(this._name){case'download':downloadItem(buildURL({'sid':dataSet.get('main',['sid']),'class':'revision','fullpath':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID)+'|'+v.id+'/'+attid}));break;case'edit':this._parent.list._editColumn(this._parent.list._value()[0],'COMMENT',{},[function(sComment){WMItems.add([me._sAccountID,me._sFolderID,me._sItemID],{revisions:[{uid:v.id,values:{revcomment:sComment}}]},'','','',[function(bOK){if(bOK==true)
me._aValues['REVISIONS'][v.id].values.REVCOMMENT=sComment;me.maintab.revisions.list._fill2();}]);return sComment.escapeHTML();}]);break;case'revert':WMItems.action({aid:me._sAccountID,fid:me._sFolderID,iid:me._sItemID,values:{revision:v.id}},'revert_to_revision',[function(bOK){me._destruct();Item.openwindow([me._sAccountID,me._sFolderID,me._sItemID]);}]);break;}}};this.download._onclick=click;this.edit._onclick=click;this.revert._onclick=click;this.remove._onclick=click;}};};_me.__changeFolder=function(sAccount,sFolder,sItem){this._sAccountID=sAccount;this._sFolderID=sFolder;this._id=[sAccount,sFolder];if(sItem){this._id.push(sItem);}
var sPath,data=dataSet.get('folders',[sAccount,sFolder]);if(WMFolders.getType(this._id)=='I'&&data.OWNER&&~data.OWNER.indexOf('##internalservicedomain.icewarp.com##')){var yf=dataSet.get('folders',[sAccount,Path.basedir(sFolder)]);sPath=(yf.NAME||yf.RELATIVE_PATH)+'/'+data.NAME;}
else{if(sFolder.indexOf(sPrimaryAccountSPREFIX)===0)
sFolder=sFolder.substr(sPrimaryAccountSPREFIX.length);if(data.NAME)
sPath=Path.basedir(sFolder)+'/'+data.NAME;else
sPath=sFolder;}
(this._getAnchor('folder')?this:this.maintab.tab1)._getAnchor('folder').textContent=sPath;this.__sharetype();};_me.__saveItems=function(aValues){var is_teamchat_folder=WMFolders.getType({aid:this._sAccountID,fid:this._sFolderID})==='I';if(this.__tab1.EVNNOTE.select&&!is_teamchat_folder){aValues['values']['EVNDESCFORMAT']=(this.__tab1.EVNNOTE.select._value()==='disabled')?'text/plain':'text/html';this.__tab1.EVNNOTE.__output_format=aValues.values.EVNDESCFORMAT!=='text/plain';}else{aValues['values']['EVNDESCFORMAT']='text/plain';this.__tab1.EVNNOTE.__output_format=false;}
if(is_teamchat_folder&&this.__tab1.EVNNOTE.__doc){aValues.values.EVNNOTE=this.__tab1.EVNNOTE.__doc.body.textContent.replace(/\n/g,' ');}else{aValues.values.EVNNOTE=this.__tab1.EVNNOTE._value();}
var addon;aValues['values']['EVNCLASS']='F';if(!Is.Empty(addon=this.X_ATTACHMENTS.list._value())){if(this._sItemID||addon.length==1){aValues['values']['EVNLOCATION']=aValues['values']['EVNTITLE']=addon[addon.length-1]['values']['description'];aValues['values']['EVNRID']=aValues['values']['EVNLOCATION'];aValues['values']['EVNCOMPLETE']=this.X_ATTACHMENTS.list._getSize();}
var now=new IcewarpDate();aValues['values']['EVNSTARTDATE']=now.format(IcewarpDate.JULIAN);aValues['values']['EVNSTARTTIME']=now.format(IcewarpDate.JULIAN_TIME);if(this._sItemID&&!Is.Empty(this._aValues)&&addon.length>1){addon[1].uid=addon[0].uid;addon.shift();}
if(addon.length==1&&addon[0].values.description)
aValues.values.EVNTITLE=aValues.values.EVNLOCATION=aValues.values.EVNRID=addon[0].values.description;aValues['ATTACHMENTS']=addon;}};_me._openFileAndListFolder=function(bOk,aData,bAuto){this._listFolder(bOk,aData,bAuto);if(!bAuto&&bOk===true&&aData.name){if(Item.officeSupport(aData.name)){var arg={EVN_ID:aData.teamchat_link||aData.id,EVNCLASS:aData.teamchat_link?'R':'F',EVNTITLE:aData.name,aid:this._id[0],fid:this._id[1],iid:WMItems.__clientID(aData.id)};Item.officeOpen(arg,[Item.downloadFile,[[arg['aid'],arg['fid'],arg['iid']]]],Path.extension(aData.name).toLowerCase());}else{Item.editFile([this._id[0],this._id[1],WMItems.__clientID(aData.id)]);}}};

/* client/inc/frm_gmap.js */
_me=frm_gmap.prototype;function frm_gmap(){};_me.__constructor=function(sAddress,callback_function){this._title('MAP::MAP');this._size(600,400,true);this._draw('frm_gmap','main');this._init_address=sAddress;this._initGooglePlacesAutocomplete(GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key'));if(callback_function){this._getAnchor('callback').removeAttribute('hidden');this.callback._onclick=function(){callback_function(this.address._value());this._destruct();}.bind(this);}};_me._initGooglePlacesAutocomplete=function(API_KEY){if(!API_KEY){return;}
if(!document.getElementById('googleapis')){document.head.appendChild(mkElement('script',{id:'googleapis',src:'https://maps.googleapis.com/maps/api/js?key='+API_KEY+'&libraries=places&callback='+this._pathName+'.__googlePlacesAutocompleteCallback',}));}else{this.__googlePlacesAutocompleteCallback();}};_me.__googlePlacesAutocompleteCallback=function(){function setPlace(place){infowindow.close();marker.setVisible(false);if(!place.geometry){return console.log("No details available for input:",place.name);}
if(place.geometry.viewport){map.fitBounds(place.geometry.viewport);}else{map.setCenter(place.geometry.location);map.setZoom(17);}
marker.setPosition(place.geometry.location);marker.setVisible(true);var place_icon=infowindowContent.querySelector('.place-icon');if(place.icon){place_icon.src=place.icon;place_icon.removeAttribute('hidden');}else{place_icon.setAttribute('hidden','');}
var place_name=infowindowContent.querySelector('.place-name');if(place.name){place_name.textContent=place.name;place_name.removeAttribute('hidden');}else{place_name.setAttribute('hidden','');}
var place_address=infowindowContent.querySelector('.place-address');if(place.formatted_address){place_address.textContent=place.formatted_address;place_address.removeAttribute('hidden');}else{place_address.setAttribute('hidden','');}
infowindow.open(map,marker);}
var map=new google.maps.Map(this._getAnchor('map'));var autocomplete=new google.maps.places.Autocomplete(this.address.__eIN);autocomplete.bindTo('bounds',map);var infowindow=new google.maps.InfoWindow();var infowindowContent=this._getAnchor('infowindow-content');infowindow.setContent(infowindowContent);var marker=new google.maps.Marker({map:map,anchorPoint:new google.maps.Point(0,-29)});google.maps.event.addListener(marker,'click',function(){infowindow.open(map,marker);});autocomplete.addListener('place_changed',function(){setPlace(autocomplete.getPlace());});if(this._init_address){this.address._value(this._init_address);var geocoder=new google.maps.Geocoder();geocoder.geocode({'address':this._init_address},function(results,status){if(status==google.maps.GeocoderStatus.OK){if(status!=google.maps.GeocoderStatus.ZERO_RESULTS){setPlace(results[0]);infowindow.open(map,marker);}}else{console.log("Geocode was not successful for the following reason:",status);}});}};

/* client/inc/frm_groupchat_invite.js */
_me=frm_groupchat_invite.prototype;function frm_groupchat_invite(){};_me.__constructor=function(aFolder,aResponse,sMail){var me=this;this._title('CHAT::INVITE');this._size(500,400,true);this._create('folder','obj_label','header')._value(dataSet.get('folders',[aFolder.aid,aFolder.fid,'NAME'])||Path.basename(aFolder.fid));this._create('btn_invite','obj_button','footer','noborder color1 add2')._value('CONFERENCE::INVITE');this.btn_invite._disabled(true);this._create('btn_close','obj_button','footer','noborder cancel')._value('FORM_BUTTONS::CLOSE');this._draw('frm_groupchat_invite','main',{disable_ab:(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1||gui._REQUEST_VARS['tconly']||sPrimaryAccountGUEST});msiebox(this._getAnchor('msiebox'));this._scrollbar(this._getAnchor('main'));this.rcp._onchange=function(){this._parent.btn_invite._disabled(this._value().length<1);};sMail&&me.rcp._value(sMail);if(this.btn_to)
this.btn_to._onclick=function(){if(!me.address||me.address._destructed)
me.address=gui._create('add_address','frm_addaddress','','',[function(bOK,aData){if(bOK)
me.rcp._value(aData.to.join(','));}],{to:"DATAGRID_ITEMS_VIEW::TO"},{to:me.rcp._value()},'to',true,false,true);};this.btn_invite._onclick=function(){var aDistribList=MailAddress.findDistribList({'to':this._parent.rcp._value()});var aItemInfo={aid:aFolder.aid,fid:aFolder.fid,xmlarray:{TO:[{VALUE:aDistribList.to}],COMMENT:[{VALUE:this._parent.note._value()}]}};if(!Is.Empty(aDistribList.distrib)){storage.library('wm_messages');aItemInfo.xmlarray.DISTRIB=wm_messages.parse_distrib(aDistribList.distrib);}
me.__hide();WMFolders.action(aItemInfo,'','','add_member','',[function(bOK){if(bOK){executeCallbackFunction(aResponse);me._destruct();}
else{gui.notifier._value({type:'alert',args:{header:'',text:'FORM_FOLDERS::INVITE_ERROR'}});me.__show();}}]);};this.btn_close._onclick=function(){me._destruct()};};

/* client/inc/frm_gw.js */
_me=frm_gw.prototype;function frm_gw(){};_me.__constructor=function(sAccountID,sFolderID,sItemID,aValues,aReccurenceValues,oResponse,bClone){if(!Is.Defined(sAccountID)||!Is.Defined(sFolderID)){this._destruct();return;}
var me=this;this._sAccountID=sAccountID;this._sFolderID=sFolderID;this._sItemID=Is.Defined(sItemID)?sItemID:false;this._aReccurenceValues=aReccurenceValues;this._bClone=bClone||false;this.__refreshView=false;this.__oresponse=oResponse;if(Is.Object(aValues)){this._aValues=aValues;}
else
this._aValues={};this._id=[sAccountID,sFolderID];if(this._sItemID)this._id.push(sItemID);this._repeating=Is.Object(aReccurenceValues)&&this._aValues['EVNRCR_ID']&&this._aValues['EVNCLASS']!='O';if((this._sFolderID=='@@mycard@@'&&this._sAccountID==sPrimaryAccount&&GWOthers.getItem('RESTRICTIONS','disable_vcardedit')>0)||(this._sItemID&&!(WMFolders.getAccess({'aid':this._sAccountID,'fid':(this._aValues&&this._aValues.EVNFOLDER?this._aValues.EVNFOLDER.replace(/\\/g,'/'):this._sFolderID)},'modify'))&&(!this._aValues||!(this._aValues.EVNOWN_ID==sPrimaryAccountGWID||this._aValues.ITMOWN_ID==sPrimaryAccountGWID))))
this.__readonly=true;if(this._type=='frm_note'&&!this.__readonly&&GWOthers.getItem('DOCUMENTS','autosave')==1&&GWOthers.getItem('DOCUMENTS','autosave_minutes')>0){this.__autoSaveInterval=setInterval(function(){me.__storeItems(true);},60000*GWOthers.getItem('DOCUMENTS','autosave_minutes'));this._add_destructor('__end_autosave');}};_me._onclose=function(b){if(b&&(this._userEdited()||this.__autosaveid)){gui._create('frm_confirm','frm_confirm','','',[this,'__confirmed'],'CONFIRMATION::ARE_YOU_SURE','CONFIRMATION::ALL_CHANGES_WILL_BE_LOST');return false;}
if(this.__refreshView){this._refreshListAndPreview();}
return true;};_me.__confirmed=function(){this._close();};_me.__end_autosave=function(){if(this.__autoSaveInterval)
clearInterval(this.__autoSaveInterval);};_me.__stringifyForm=function(){var aValues={'values':{}};storeDataFromForm(this,aValues['values']);aValues.values[this._type=='frm_contact'||this._type=='frm_distrib'?'ITMSHARETYPE':'EVNSHARETYPE']=this.X_ITMSHARETYPE._value();this.__saveItems(aValues);return JSON.stringify(aValues);};_me.__initForm=function(sTitle){this._title(sTitle);this.__loadItems();this.__createFooter();if(!this._bClone&&!this._aValues.PUSH_ATTACHMENTS&&(this._sItemID||Is.Empty(this._aValues)))
this.__currentSaveState=this.__stringifyForm();};_me._userEdited=function(){return(this.__currentSaveState||'').replace(/\xA0|&nbsp;/g,' ')!=(this.__stringifyForm()||'').replace(/\xA0|&nbsp;/g,' ');};_me.__saveItems=function(aValues){};_me.__loadItems=function(aValues){};_me.__createFooter=function(){var me=this;if(this._sItemID&&!sPrimaryAccountGUEST){this._create('x_btn_share','obj_button','footer','color1 simple x_btn_right'+(this._type==='frm_file'?' select':''));this.x_btn_share._value('MAIN_MENU::SHARE');if(!sPrimaryAccountGUEST||me._aValues.TICKET){this.x_btn_share._onclick=function(e){if(me._type!=='frm_file'){return Item.sendAsEmail([me._sAccountID,me._sFolderID,[me._sItemID]]);}
if(!this.__cmenu||this.__cmenu._destructed){var pos=getSize(this.__eIN),aMenu=[];if(!sPrimaryAccountGUEST)
aMenu.push({title:'POPUP_ITEMS::SEND_AS_EMAIL','arg':[Item.sendAsEmail,[[me._sAccountID,me._sFolderID,[me._sItemID]]]]});if(me._aValues.TICKET)
aMenu.push({title:'ITEM::PUBLIC','arg':[me,'_publicURL']});this.__cmenu=gui._create('cmenu','obj_context'),this.__cmenu._fill(aMenu);this.__cmenu._place(pos.x+pos.w/2,pos.y,'',3);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}};}
else
this.x_btn_share._disabled(true);}
if(this._type!='frm_distrib'&&this._type!='frm_file'){this._create('x_btn_print','obj_button','footer','noborder transparent ico img print simple x_btn_right');this.x_btn_print._title('MAIN_MENU::PRINT');this.x_btn_print._onclick=function(){if(me.__print)
me.__print(me.__readItems());};}
this._create('X_ITMSHARETYPE','obj_sharing','footer','toright');if(this._sItemID){this._create('x_btn_delete','obj_button','footer','noborder transparent ico img trash simple x_btn_right');this.x_btn_delete._title('MAIN_MENU::DELETE');this.x_btn_delete._onclick=function(){if(me._repeating)
gui._create('frm_confirm','frm_confirm_repeating','','',[function(state){Item.__removeWithRepeating(state,[me._sAccountID,me._sFolderID,[me._sItemID]],me._aReccurenceValues);me._destruct();if(me.__oresponse)
executeCallbackFunction(me.__oresponse,false);}],'REPEATING_CONFIRM::TITLE_DELETE','REPEATING_CONFIRM::TEXT_DELETE');else{var frm=gui._create('frm_confirm','frm_confirm','','',[function(){Item.__delete([me._sAccountID,me._sFolderID,[me._sItemID]]);me._destruct();if(me.__oresponse)
executeCallbackFunction(me.__oresponse,false);}],'CONFIRMATION::DELETE_ITEM_CONFIRMATION','CONFIRMATION::DELETE_ITEM');frm._size(400,180);frm.obj_label.__eIN.innerHTML+='<br>'+getLang('CONFIRMATION::DELETE_ITEM_TRASH');}};}
if(this.__readonly){this.x_btn_ok._disabled(1);if(this.x_btn_revision)
this.x_btn_revision._disabled(1);if(this.x_btn_delete)
this.x_btn_delete._disabled(1);}
else{this.x_btn_ok._onclick=function(){if(this._disabled())return;this._disabled(true);if(me._type=='frm_file'&&me._sItemID&&!Is.Empty(me.X_ATTACHMENTS._value())&&GWOthers.getItem('GW_MYGROUP','ownautorevisionmode')!='1')
me.__revision=true;if(me.__onBeforeSave)
me.__onBeforeSave();if(me.__storeItems())
me.__hide();else
this._disabled(false);};this.x_btn_cancel._onclick=function(e){if(me.__autosaveid&&GWOthers.getItem('DOCUMENTS','autosave')==1)
Item.__delete([me._sAccountID,me._sFolderID,[me._sItemID]]);me._close(true,e);};}
this.__sharetype();};_me.__sharetype=function(){if(this.X_ITMSHARETYPE){if(this.__readonly){this.X_ITMSHARETYPE._disabled(true);}
else
if(WMFolders.getType([this._sAccountID,this._sFolderID])=='I'){this.X_ITMSHARETYPE._disabled(true);this.X_ITMSHARETYPE._value('U');this._aValues['EVNSHARETYPE']='U';return;}
else{this.X_ITMSHARETYPE._disabled(this._sItemID&&(this._aValues.EVNOWN_ID||this._aValues.ITMOWN_ID)!==sPrimaryAccountGWID&&!WMFolders.getRights({aid:this._sAccountID,fid:this._sFolderID},'owner'));}
if(this._aValues['ITM_ID']){if(this._aValues['ITMSHARETYPE']=='P')
this.X_ITMSHARETYPE.__privateValue='P';this.X_ITMSHARETYPE._value(this._aValues['ITMSHARETYPE']);}
else
if(this._aValues['EVN_ID']){if(this._aValues['EVNSHARETYPE']=='P')
this.X_ITMSHARETYPE.__privateValue='P';this.X_ITMSHARETYPE._value(this._aValues['EVNSHARETYPE']);}
else{var types={frm_contact:'contact_sharing',frm_distrib:'contact_sharing',frm_journal:'journal_sharing',frm_note:'note_sharing',frm_file:'file_sharing',frm_task:'task_sharing'};types[Mapping.getFormNameByGWType('E')]='event_sharing';this.X_ITMSHARETYPE._value(GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS',types[this._type]));}}};_me._publicURL=function(){this._sItemID&&Item.collaborate([this._sAccountID,this._sFolderID,[this._sItemID]]);};_me.__readItems=function(bFilter){var aValues={'values':{}};for(var i in this._aValues)
if(typeof this._aValues[i]!='object')
aValues.values[i]=this._aValues[i];storeDataFromForm(this,aValues['values']);if(bFilter){for(var key in aValues.values){if(!!~this.__filterOut.indexOf(key.toLowerCase())){delete aValues.values[key];}}}
aValues.values[this._type=='frm_contact'||this._type=='frm_distrib'?'ITMSHARETYPE':'EVNSHARETYPE']=this.X_ITMSHARETYPE._value();this.__saveItems(aValues);return aValues;};_me.__filterOut=['startdate','starttime','timezone','enddate','endtime','durationdays','durationtime','allday','tzlink'];_me.__storeItems=function(bAuto){var me=this;if(this._userEdited()||(!bAuto&&this._aValues.PUSH_ATTACHMENTS)){var aValues={'values':{}};storeDataFromForm(this,aValues['values']);for(var key in aValues.values){if(!!~this.__filterOut.indexOf(key.toLowerCase())){delete aValues.values[key];}}
aValues.values[this._type=='frm_contact'||this._type=='frm_distrib'?'ITMSHARETYPE':'EVNSHARETYPE']=this.X_ITMSHARETYPE._value();if(this._aValues.EVNCLASS)
aValues.values.EVNCLASS=this._aValues.EVNCLASS;if(this._aValues.EVNCOMEVNID)
aValues.values.EVNCOMEVNID=this._aValues.EVNCOMEVNID;this.__saveItems(aValues);var not_me_attendees=[];if(this._aValues.CONTACTS){for(var i in this._aValues.CONTACTS){if(this._aValues.CONTACTS[i].CNTEMAIL!==sPrimaryAccount){not_me_attendees.push(this._aValues.CONTACTS[i]);}}}
if(!bAuto&&this._type==Mapping.getFormNameByGWType('E')&&this._sItemID&&not_me_attendees.length){if(this._repeating||this._notify_attendees){gui._create('frm_confirm','frm_confirm','','',[function(){WMItems.add(me._id,aValues,'','','',[me,'_listFolder']);me.__hide();}],'CONFIRMATION::INFORM_ATTENDEES','CONFIRMATION::NOTIFY_OR_DISCARD');return false;}
gui._create('frm_confirm','frm_confirm','','',[function(){WMItems.add(me._id,aValues,'','','',[me,'_listFolder']);}],'CONFIRMATION::INFORM_ATTENDEES','CONFIRMATION::SEND_EVENT_UPDATE');gui.frm_confirm.x_btn_cancel._value('CONFIRMATION::SUPPRESS_EVENT_UPDATE');gui.frm_confirm.x_btn_cancel._onclick=function(){aValues.values=aValues.values||{};aValues.values['SKIP_INVITATION']=1;WMItems.add(me._id,aValues,'','','',[me,'_listFolder']);gui.frm_confirm._destruct();};return true;}
if(!Is.Empty(aValues))
return WMItems.add(this._id,aValues,'','','',[this,this._type==='frm_file'?'_openFileAndListFolder':'_listFolder',[bAuto]],bAuto);else
this.__currentSaveState=this.__stringifyForm();}
else
if(!bAuto){if(this.__autosaveid){this._listFolder(true,{},false);}
else
this._close();}};_me._listFolder=function(bOk,oData,bAuto){if(!bOk){switch(oData){case'item_create':var me=this;var frm=gui._create('create_default','frm_confirm','','',[function(){me._id[1]=me._sFolderID=Mapping.getDefaultFolderForGWType(WMFolders.getType([me._sAccountID,me._sFolderID]));me._id[0]=me._sAccountID=sPrimaryAccount;me.x_btn_ok._onclick();}],'ALERTS::FOLDER_INSUFFICIENT_RIGHTS','ERROR::ITEM_CREATE');frm.x_btn_cancel._onclick=function(){frm._destruct();me.__stored=true;me._close();};break;}
this.__show();this.x_btn_ok._disabled(false);return;}
if(!this._destructed){this.__currentSaveState=this.__stringifyForm();if(bOk==2){this.__stored=true;this._close();return;}
if(bAuto&&oData.id){if(this._id.length==2){this._sItemID=oData.id;this._id.push(oData.id);this.__autosaveid=true;}
return;}}
var aPath=Path.split(dataSet.get('active_folder'));if(gui.frm_main.main&&aPath[0]==this._sAccountID&&aPath[1]==this._sFolderID){this._refreshListAndPreview();}
this.__stored=true;this._close();if(gui.notifier)
gui.notifier._value({type:'item_saved',args:[this._sAccountID,this._sFolderID,this._sItemID]});if(this.__oresponse)
executeCallbackFunction(this.__oresponse,bOk,oData);if(this.__revision)
gui._create('revision','frm_revision','','',{aid:this._sAccountID,fid:this._sFolderID,iid:this._sItemID},true);if(gui.socket){var f=dataSet.get('folders',[this._sAccountID,this._sFolderID]);if(f){var aOut={'ACTION':this._sItemID?'edit':'add','TYPE':'item','ITEM':oData.id,'FOLDER':f.RELATIVE_PATH,'FOLDER-TYPE':f.TYPE,'EMAIL':sPrimaryAccount,'NAME':dataSet.get('main',['fullname'])||dataSet.get('main',['user']),'ITEM-TYPE':this._aValues.EVNCLASS||f.TYPE,'owner':this._pathName};gui.socket.api._notify(aOut);}}
return false;};_me._refreshListAndPreview=function(){Item.__refreshView([this._sAccountID,this._sFolderID,this._sItemID],!!this._sItemID||this.__refreshView);};

/* client/inc/frm_help.js */
_me=frm_help.prototype;function frm_help(){};_me.__constructor=function(sActiveTab){this._title('HELP::HELP');this._size(800,600,true);this._addListeners();var guest=sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly());this._draw('frm_help','main',{chat:sPrimaryAccountCHAT,guest:guest});storage.library('gw_others');function nightMode(frame){if(GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){var onload=frame.__eFrame.onload;frame.__eFrame.onload=function(){onload&&onload.call(this);storage.library('night_mode');NightMode(frame.__eFrame.contentWindow).activate();};}
return frame;}
if(this.maintab.help){nightMode(this.maintab.help._create("frame","obj_frame","main","border"))._src('client/help.html?lang='+GWOthers.getItem('LAYOUT_SETTINGS','language'));}
if(this.maintab.chat){this.maintab.chat._onactive=function(bFirstTime){bFirstTime&&nightMode(this._create("frame","obj_frame","main","border"))._src('client/chat.html?lang='+GWOthers.getItem('LAYOUT_SETTINGS','language')+(guest?'&guest=1':''));};};if(this.maintab.license){this.maintab.license._onactive=function(bFirstTime){bFirstTime&&nightMode(this._create("frame","obj_frame","main","border"))._src(GWOthers.getItem('PATHS','install')+'?sid='+dataSet.get('main',['sid']));};}
if(this.maintab.apps){this.maintab.apps._onactive=function(bFirstTime){if(bFirstTime){var frame=nightMode(this._create("frame","obj_frame","main","border"));if(!guest){var onload=frame.__eFrame.onload;frame.__eFrame.onload=function(){[].forEach.call(this.contentDocument.querySelectorAll('.circle, .i.note'),function(item){item.classList.contains('item-5')||item.parentNode.removeChild(item);});onload&&onload.call(this);};}
frame._src('client/apps.html?lang='+GWOthers.getItem('LAYOUT_SETTINGS','language'));}};}
this.maintab.about._onactive=function(bFirstTime){bFirstTime&&nightMode(this._create("frame","obj_frame","main","border"))._src('client/about.html?lang='+GWOthers.getItem('LAYOUT_SETTINGS','language'));};this.maintab[sActiveTab]&&this.maintab[sActiveTab]._active();};_me._messageHandler=function(e){switch(e.data){case'open_apps':gui.help.maintab.apps._active(null,true);break;case'download_apps':window.open('https://www.icewarp.com/downloads/','icewarp_download');break;case'whatsnew':gui._create('whatsnew','frm_whatsnew');break;}};_me._addListeners=function(){window.addEventListener('message',this._messageHandler);this._add_destructor('__removeListener');};_me.__removeListener=function(){window.removeEventListener('message',this._messageHandler);};

/* client/inc/frm_im_add.js */
_me=frm_im_add.prototype;function frm_im_add(){};_me.__constructor=function(xmpp,sGroup,sJID,sName,sTab){this._size(490,400,true);this._resizable(false);this._title('FORM_BUTTONS::ADD');this._draw('frm_im_add','main');this.__gateways=[];if(xmpp){if(sJID&&sJID.toLowerCase().indexOf('xmpp:')==0)
sJID=sJID.substr(5);this.__xmpp=xmpp;this.__xmpp._gateway_list(dataSet.get('main',['domain']),[this,'_refresh',[sGroup,sJID,sName,sTab]]);}
else
this._destruct();};_me.__constructor2=function(sGroup,sJID,sName,sTab){var me=this;this.maintab.user._onactive=function(bFirstTime){if(GWOthers.getItem('RESTRICTIONS','DISABLE_IM_CONTACT_MANAGEMENT')==1){this.gateway._disabled(true);this.jid._disabled(true);this.nick._disabled(true);this.group._disabled(true);me.x_btn_ok._disabled(true);}
else{if(bFirstTime){if(sJID)
this.jid._value(sJID);if(sName)
this.nick._value(sName);var aGroups={'*':getLang('IM::OTHER')},aRoster=dataSet.get('xmpp',['roster']);if(aRoster)
for(var i in aRoster)
if(aRoster[i].group&&!aGroups[aRoster[i].group])
aGroups[aRoster[i].group]=aRoster[i].group;this.group._fill(aGroups);this.group._value(sGroup||'*');var aGW={'*':getLang('SETTINGS::DEFAULT')};for(var i in me.__gateways)
if(me.__gateways[i].check)
aGW[me.__gateways[i].id]=me.__gateways[i].data.name+' ('+me.__gateways[i].data.jid+')';this.gateway._fill(aGW);this.gateway._value('*');this.gateway._onchange=function(){if(aGW[this._parent.group._value()])
this._parent.group._value(this._value());};this.group._onsubmit=this.nick._onsubmit=this.jid._onsubmit=function(){me.x_btn_ok._onclick();}
this.group._onclose=this.nick._onclose=this.jid._onclose=function(){me.x_btn_cancel._onclick();}}
me.x_btn_ok._onclick=function(){var jid=me.maintab.user.jid._value();if(jid){if(me.maintab.user.gateway._value()!='*')
jid=jid.replace('@','%')+'@'+me.maintab.user.gateway._value();executeCallbackFunction([me.__xmpp,'_user_add'],jid,me.maintab.user.nick._value(),me.maintab.user.group._value());me._destruct();}};}
me.x_btn_ok._value('FORM_BUTTONS::OK');};this.maintab.gateway._onactive=function(bFirstTime){if(bFirstTime){this.grid.__sortColumn='name';this.grid._addColumns({'check':{width:20,arg:{sort:'asc'},'css':'ico check',"type":'static',"text":'&nbsp;'},'ico':{width:20,'css':'ico gw',"type":'static',"text":'&nbsp;'},'name':{title:"DATAGRID_ITEMS_VIEW::NAME",width:50,mode:'%',arg:{sort:'asc'}},'jid':{title:"IM::JABBER_ID",width:50,mode:'%',arg:{sort:'asc'}},'type':{title:"DATAGRID_ITEMS_VIEW::TYPE",width:80,arg:{sort:'asc'}}});this.grid._onclick=function(e,elm,arg,id,col){var gwid;if(col=='check'&&this._aData[id]&&(gwid=this._aData[id].id)){for(var i in me.__gateways)
if(me.__gateways[i].id==gwid){if(me.__gateways[i].check){if(me.__gateways[i].data&&me.__gateways[i].data.jid){Cookie.set(['im','queue',me.__gateways[i].data.jid]);me.__xmpp._user_remove([me.__gateways[i].data.jid]);}}
else
this._ondblclick();break;}}};this.grid._ondblclick=function(){me.x_btn_ok._onclick();};this.add._disabled(true);this.add._onclick=function(){var v=this._parent.gateway._value();if(v){gui._create('addgtw','frm_im_addgtw','','',me.__xmpp,v,sGroup);this._parent.gateway._value('');}};this.gateway._onkeyup=function(){this._parent.add._disabled(this._value()?false:true);};this.gateway._onsubmit=function(){this._parent.add._onclick();};this.grid._serverSort(me.__gateways);}
me.x_btn_ok._value('IM::REGISTR');me.x_btn_ok._onclick=function(){var v=me.maintab.gateway.grid._value();if(v&&v[0]&&me.maintab.gateway.grid._aData[v[0]])
gui._create('addgtw','frm_im_addgtw','','',me.__xmpp,me.maintab.gateway.grid._aData[v[0]].id,sGroup);};me.x_btn_ok._disabled(false);};if(sTab=='gateway')
this.maintab._value('gateway');else
this.maintab.user._onactive(true);};_me._refresh=function(aResponse,sGroup,sJID,sName,sTab){if(Is.Empty(aResponse))
this.__constructor2(sGroup,sJID,sName,sTab);else{var aData=[];for(var i in aResponse)
if(aResponse[i].CATEGORY=='gateway')
aData.push({id:aResponse[i].JID,data:{'name':aResponse[i].NAME,'jid':aResponse[i].JID,'type':aResponse[i].TYPE||''}});this.__gateways=aData;this.__constructor2(sGroup,sJID,sName,sTab);this._listen('xmpp',['roster']);}};_me.__update=function(sName,aDPath){var aGW={'*':getLang('SETTINGS::DEFAULT')};if(this.__gateways.length){var aRoster=dataSet.get('xmpp',['roster']);if(aRoster){this.__gateways.map(function(g){g.css='ico_'+g.data.type.replace(' ','-');if(aRoster[g.id]){g.css+=' check';aGW[g.id]=g.data.name+' ('+g.data.jid+')';}
return g;});}}
if(this.maintab.gateway&&this.maintab.gateway.grid)
this.maintab.gateway.grid._serverSort(this.__gateways);if(this.maintab.user&&this.maintab.user.gateway){this.maintab.user.gateway._fill(aGW);if(!aGW[this.maintab.user.gateway._value()])
this.maintab.user.gateway._value('*');}};

/* client/inc/frm_im_addgtw.js */
_me=frm_im_addgtw.prototype;function frm_im_addgtw(){};_me.__constructor=function(xmpp,jid){this._size(400,300,true);this._title('IM::ADD_SERVICE');this.__obj=[];this.__xmpp=xmpp;this.__jid=jid;this.x_btn_ok._disabled(true);xmpp._gateway_registr('',jid,[this,'__registr']);};_me.__registr=function(aData){if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.ATTRIBUTES.TYPE=='result'){var sInfo='',me=this;if(aData.QUERY[0].REGISTERED){this.__obj=[];sInfo=getLang('IM::REGISTRED');addcss(this.x_btn_ok._main,'color2');this.x_btn_ok._value('FORM_BUTTONS::REMOVE');this.x_btn_ok._onclick=function(){me.__xmpp._user_remove([me.__jid],[function(){me._destruct()}]);};this.x_btn_ok._disabled(false);}
else{for(var i in aData.QUERY[0])
if(i=='ATTRIBUTES')
continue;else
if(i=='INSTRUCTIONS')
sInfo=aData.QUERY[0].INSTRUCTIONS[0].VALUE;else
this.__obj.push({id:'X_'+this.__obj.length,name:i.toLowerCase(),type:i=='PASSWORD'?'obj_password':'obj_input'});this.x_btn_ok._onclick=function(){var aData={};if(me.__obj.length)
for(var i in me.__obj)
aData[me.__obj[i].name.toUpperCase()]=[{VALUE:me[me.__obj[i].id]._value()}];me.__xmpp._gateway_registr(aData,me.__jid,[me,'__response']);};this.x_btn_ok._disabled(false);}
if(this.__obj.length||sInfo){this._draw('frm_im_addgtw','main',{form:this.__obj,info:sInfo});if(this.__obj.length)
this[this.__obj[0].id]._focus();}}
else
this._destruct();};_me.__response=function(aData){if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.ATTRIBUTES&&aData.ATTRIBUTES.TYPE=='result')
this._destruct();else
gui.notifier._value({type:'alert',args:{header:'',text:'IM::ERROR_REGISTR'}});};

/* client/inc/frm_im_file.js */
_me=frm_im_file.prototype;function frm_im_file(){};_me.__constructor=function(oXMPP,sUser){var me=this;this.__xmpp=oXMPP;this.__to=sUser;this._size(450,248,true);this._resizable(false);this._title(getLang('IM::SEND_FILE')+' - '+(dataSet.get('xmpp',['roster',sUser,'name'])||sUser),true);this.x_btn_ok._disabled(true);this._draw('frm_im_file','main');this.att._oncontext=null;this.att._onuploadstart=function(){me.x_btn_ok._disabled(true);me.x_btn_cancel._disabled(true);};this.att._onuploadend=function(){me.x_btn_ok._disabled(false);me.x_btn_cancel._disabled(false);};this.att._onchange=function(){var b=Is.Empty(this.list._value());me.x_btn_ok._disabled(b);};this._onclose=function(){return!this.x_btn_cancel._disabled();};this.x_btn_ok._onclick=function(){var v=me.att._value(),sFolder,sFile;for(var i in v)
if(v[i]&&v[i].values&&v[i].values.fullpath){sFolder=v[i].values.fullpath.substring(0,v[i].values.fullpath.lastIndexOf('/'));if(v[i].values['class']=='item')
sFolder=sFolder.substring(sFolder.indexOf('/')+1);sFile=v[i].values.fullpath.substring(v[i].values.fullpath.lastIndexOf('/')+1);if(window.sPrimaryAccountSOCKS)
me.__xmpp.stream_send(sFolder,sFile,v[i].values['class'],v[i].values.size,v[i].values.description,me.__to,me.text._value());else
me.__xmpp.oob_send(sFolder,sFile,v[i].values['class'],me.__to,me.text._value());}
me._destruct();};this.att._dropzone(this.__eContainer);};

/* client/inc/frm_im_vcard.js */
_me=frm_im_vcard.prototype;function frm_im_vcard(){};_me.__constructor=function(sTo,xmpp){this._size(450,315,true);this._resizable(false);this.__base64=[];if(sTo){this.__to=sTo||'';this._title(MailAddress.createEmail(dataSet.get('xmpp',['roster',sTo,'name']),this.__to.replace(/^\~/g,'')),true);}
else
this._title('IM::VCARD');this._draw('frm_im_vcard','main',{edit:this.__to?0:1});this.maintab.general.NUMBER.__email=sTo||sPrimaryAccount;this._create('loader','obj_loader');xmpp._vcard(this.__to,'',[this,'__value'],[function(){this._destruct();}.bind(this)]);};_me._refresh=function(sB64,sHash,sType){if(sType&&sB64)
this.__base64=[sType,sB64,sHash];var av=document.getElementById(this.maintab.general._pathName+'#avatar');if(av){av.src=getAvatarURL(this.__to||sPrimaryAccount);av=null;}};_me.__value=function(aData){if(this._destructed)return;var oTab;if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.VCARD&&(aData=aData.VCARD[0])){this.loader&&this.loader._destruct();oTab=this.maintab.general;this._refresh();if(aData.FN)
oTab.FN._value(aData.FN[0].VALUE);if(aData.NICKNAME)
oTab.NICKNAME._value(aData.NICKNAME[0].VALUE);if(aData.BDAY)
oTab.BDAY._value(aData.BDAY[0].VALUE);if(aData.TEL&&aData.TEL[0].NUMBER)
oTab.NUMBER._value(aData.TEL[0].NUMBER[0].VALUE);if(aData.URL)
oTab.URL._value(aData.URL[0].VALUE);if(aData.EMAIL&&aData.EMAIL[0].USERID)
oTab.USERID._value(aData.EMAIL[0].USERID[0].VALUE);oTab=this.maintab.work;if(aData.ORG&&aData.ORG[0].ORGNAME)
oTab.ORGNAME._value(aData.ORG[0].ORGNAME[0].VALUE);if(aData.ORG&&aData.ORG[0].ORGUNIT)
oTab.ORGUNIT._value(aData.ORG[0].ORGUNIT[0].VALUE);if(aData.TITLE)
oTab.TITLE._value(aData.TITLE[0].VALUE);if(aData.ROLE)
oTab.ROLE._value(aData.ROLE[0].VALUE);if(aData.ADR){var aValues={values:{}};if(aData.ADR[0].STREET)
aValues.values.LCTSTREET=aData.ADR[0].STREET[0].VALUE;if(aData.ADR[0].LOCALITY)
aValues.values.LCTCITY=aData.ADR[0].LOCALITY[0].VALUE;if(aData.ADR[0].REGION)
aValues.values.LCTSTATE=aData.ADR[0].REGION[0].VALUE;if(aData.ADR[0].PCODE)
aValues.values.LCTZIP=aData.ADR[0].PCODE[0].VALUE;if(aData.ADR[0].CTRY)
aValues.values.LCTCOUNTRY=aData.ADR[0].CTRY[0].VALUE;this.maintab.location.location._value(aValues);}
if(aData.DESC)
this.maintab.about.DESC._value(aData.DESC[0].VALUE);}
else{var aData={};oTab=this.maintab.general;aData.FN=[{VALUE:oTab.FN._value()}];aData.NICKNAME=[{VALUE:oTab.NICKNAME._value()}];aData.BDAY=[{VALUE:oTab.BDAY._value()}];aData.TEL=[{NUMBER:[{VALUE:oTab.NUMBER._value()}]}];aData.URL=[{VALUE:oTab.URL._value()}];aData.EMAIL=[{USERID:[{VALUE:oTab.USERID._value()}]}];oTab=this.maintab.work;aData.TITLE=[{VALUE:oTab.TITLE._value()}];aData.ROLE=[{VALUE:oTab.ROLE._value()}];aData.ORG=[{ORGNAME:[{VALUE:oTab.ORGNAME._value()}],ORGUNIT:[{VALUE:oTab.ORGUNIT._value()}]}];var aValues=this.maintab.location.location._value();aData.ADR=[{STREET:[{VALUE:aValues.values.LCTSTREET}],LOCALITY:[{VALUE:aValues.values.LCTCITY}],REGION:[{VALUE:aValues.values.LCTSTATE}],PCODE:[{VALUE:aValues.values.LCTZIP}],CTRY:[{VALUE:aValues.values.LCTCOUNTRY}]}];aData.DESC=[{VALUE:this.maintab.about.DESC._value()}];if(this.__base64.length)
aData.PHOTO=[{TYPE:[{VALUE:'image/'+(this.__base64[0]||'').substr(this.__base64[0].lastIndexOf('/')+1)}],BINVAL:[{VALUE:this.__base64[1]}]}];return aData;}};

/* client/inc/frm_imgview.js */
_me=frm_imgview.prototype;function frm_imgview(){};_me.__constructor=function(){var me=this;storage.library('load-image.all.min','loadimage');this._place('0%','0%',"100%","100%");this._zIndex();this.__queue=[];this._getAnchor('close').onclick=function(){me._destruct();};this._getAnchor('full').onclick=function(){if(!document.fullscreenElement&&!document.mozFullScreenElement&&!document.webkitFullscreenElement){if(me._main.requestFullscreen)
me._main.requestFullscreen();else
if(me._main.mozRequestFullScreen)
me._main.mozRequestFullScreen();else
if(me._main.webkitRequestFullscreen)
me._main.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);}
else{if(document.cancelFullScreen)
document.cancelFullScreen();else
if(document.mozCancelFullScreen)
document.mozCancelFullScreen();else
if(document.webkitCancelFullScreen)
document.webkitCancelFullScreen();}};this._getAnchor('container').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='DIV')
if(hascss(elm,'go')){if(hascss(elm,'prev'))
me._prev();else
me._next();}
else
me._destruct();};var eInput=this._getAnchor('input');eInput.focus();eInput.onkeydown=function(e){var e=e||window.event;this.value='';switch(e.keyCode){case 37:case 38:case 33:me._prev();break;case 39:case 40:case 34:case 32:me._next();break;case 27:me._destruct();break;case 107:case 109:case 13:case 9:break;default:return true;}
e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};AttachEvent(this._main,'onclick',function(e){eInput.focus();});gui._obeyEvent('resize',[this,'__resize']);this._add_destructor('__resizeDestruct');};_me._next=function(){var bFound=false;for(var i in this.__queue){if(i==this.__value)
bFound=true;else
if(bFound){this._value(i);return i;}}
for(var i in this.__queue){this._value(i);return i;}};_me._prev=function(){var out;for(var i in this.__queue){if(Is.Defined(out)&&i==this.__value)
break;out=i;}
this._value(out);return out;};_me._fill=function(aData){this.__queue=Is.Object(aData)?aData:[];if(this.__queue.length==1)
addcss(this._main,'single');else
removecss(this._main,'single');};_me._value=function(v){if(Is.Defined(v)){if(this.__queue[v]&&this.__value!=v){addcss(this._main,'loading');var me=this,imageUrl=this.__queue[v].url;var anchor=me._getAnchor('image'),oldElm=anchor.firstChild;if(oldElm)
removecss(oldElm,'show');if(this.__queue[v].title.match(/\.gif[^\w]?/)){this.__gif=true;var me=this,img=new Image();img.onload=function(){if(me._destructed){img=null;return;}
var anchor=me._getAnchor('image');while(anchor.firstChild){anchor.removeChild(anchor.firstChild);}
removecss(me._main,'loading');anchor.appendChild(this);me.__resize();};img.onerror=function(){console.log("Error loading image "+imageUrl);};img.src=this.__queue[v].url;}else{this.__gif=false;loadImage(imageUrl,function(img){if(me._destructed){img=null;return;}
if(img.type==="error"){console.log("Error loading image "+imageUrl);}
else{if(oldElm){oldElm.parentNode.removeChild(oldElm);oldElm=null;}
anchor.appendChild(img);me.__resize();removecss(me._main,'loading');addcss(img,'show');}},{orientation:true});}
this._getAnchor('label').innerHTML=this.__queue[v].title?this.__queue[v].title.toString().escapeHTML():'';this.__value=v;return true;}
return false;}
else
return this.__value||null;};_me.__resize=function(e,w,h){var anchor=this._getAnchor('image'),img;if((img=anchor.firstChild)){if(this.__gif){w=w||img.naturalWidth;h=h||img.naturalHeight;}
else{w=w||img.width;h=h||img.height;}
if(anchor.clientWidth>w&&anchor.clientHeight>h){img.style.width=w+'px';img.style.height=h+'px';}
else
if((w/h)<(anchor.clientWidth/anchor.clientHeight)){img.style.height=anchor.clientHeight+'px';img.style.width=(w/h*anchor.clientHeight)+'px';}
else{img.style.height=(h/w*anchor.clientWidth)+'px';img.style.width=anchor.clientWidth+'px';}
img.style.left=Math.ceil((anchor.clientWidth-img.offsetWidth)/2)+'px';img.style.top=Math.ceil((anchor.clientHeight-img.offsetHeight)/2)+'px';}};_me.__resizeDestruct=function(){gui._disobeyEvent('resize',[this,'__resize']);};

/* client/inc/frm_input.js */
_me=frm_input.prototype;function frm_input(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,sLabel3){var me=this;this._size(300,145,true);this._resizable(false);this._dockable(false);this._modal(true);this._draw('frm_input','main');this._create('obj_input','obj_input','input','obj_input_100');this.obj_input._onsubmit=function(){me.x_btn_ok._onclick();};this.obj_input._onclose=function(){me.x_btn_cancel._onclick();};if(sLabel1)this._title(sLabel1);if(sLabel2)this.obj_input._value(sLabel2);if(sLabel3)this.obj_input._placeholder(sLabel3);this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse,me.obj_input._value());me._destruct();};this.obj_input._focus();};

/* client/inc/frm_insert_code.js */
_me=frm_insert_code.prototype;function frm_insert_code(){};_me.__constructor=function(aHandler){var me=this;storage.library('obj_highlight');this._modal(true);this._draw('frm_insert_code','main');this._size(800,500,true);this._title('INSERT_CODE::TITLE');if(!window.hljs){storage.library('highlight.pack','highlight');}
var languages={'auto':getLang('INSERT_CODE::AUTODETECT')};hljs.listLanguages().sort(function(a,b){return(obj_highlight.__casing[a]||a).localeCompare(obj_highlight.__casing[b]||b);}).forEach(function(language){languages[language]=obj_highlight.__casing[language]||language;});this.language._fill(languages);this._getAnchor('code').addEventListener('paste',function(e){setTimeout(me.autodetectLanguage.bind(me),0);});this._getAnchor('code').addEventListener('keyup',function(e){me.x_btn_ok._disabled(!e.target.value.trim());});this._getAnchor('code').addEventListener('keydown',function(e){if(!e.shiftKey&&(e.keyCode||e.which)===9){e.preventDefault();var s=this.selectionStart;this.value=this.value.substring(0,this.selectionStart)+"\t"+this.value.substring(this.selectionEnd);this.selectionEnd=s+1;}});this.x_btn_ok._disabled(true);this.x_btn_ok._value('INSERT_CODE::INSERT');this.x_btn_ok._onclick=function(){me.autodetectLanguage();var language=me.language._value();language=language==='auto'?'':(' '+language);executeCallbackFunction(aHandler,'```'+language+'\n'+me._getAnchor('code').value+'\n```');me._destruct();};};_me.autodetectLanguage=function(){if(this.language._value()==='auto'){var highlight=hljs.highlightAuto(this._getAnchor('code').value);this.language._value(highlight.language);}};

/* client/inc/frm_insert_item.js */
_me=frm_insert_item.prototype;function frm_insert_item(){};_me.__constructor=function(aResponse,sAccount,sFolder,sType,sRight,bNoFolders,aAllowedFolders,aPreselectedFolder){this._default_folder=sFolder;this._default_account=sAccount;this._modal(true);var me=this;this._dataSet='tmp_'+this._name;this.__value={};this._title('INSERT_ITEM::INSERT_ITEM');if(bNoFolders){this._draw('frm_insert_item','main');this._size(800,500,true);}else{this._draw('frm_insert_item_folders','main');this._size(1000,500,true);aAllowedFolders.some(function(v,i,a){return v==='F'&&a.push('K')});}
this._placeShift();this.datagrid._default_values=function(sFolType){switch(sFolType){case'I':return['EVN_ID','EVNTITLE','EVN_MODIFIED','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVNCOMPLETE'];case'K':return WMItems.default_values('F');default:return WMItems.default_values(sFolType);}};this.datagrid._listen_data(this._dataSet,'',true);this.datagrid._onchange=function(){if(this.__value.length>0){var val={},tmp;for(var i in this.__value)
if(me.__value[this.__value[i]])
val[this.__value[i]]=me.__value[this.__value[i]];else{var f=this._getFolder();if((tmp=dataSet.get(this._listener_data,[f.aid,f.fid,this.__value[i]])))
val[this.__value[i]]=tmp;}
me.__value=val;}};this.datagrid._ondblclick=function(){me.x_btn_ok._onclick();};if(!bNoFolders){this.filter.__filter=this.__filterTree.bind(this);if(TeamChatAPI&&TeamChatAPI.teamChatOnly()){aPreselectedFolder='X';aAllowedFolders=['X','I'];}
if(1===aAllowedFolders.length){addcss(this._main,'nofilter');}
if((aResponse[0].upload||aResponse[0].file)){(aResponse[0].upload||aResponse[0].file)._dropzone(this._main.querySelector('.upload'),function(){return template.tmp('dropzone',{body:getLang('CHAT::DROP_BODY'),title:aResponse[0]._type==='frm_main_chat'?getLang('CHAT::DROP_TITLE',[Path.basename(aResponse[0].__fid)]):getLang('ATTACHMENT::DROPZONE')});},'item');(aResponse[0].upload||aResponse[0].file).file._obeyEvent('onuploadstart',[function(){if(me&&!me._destructed)
me._destruct();return false;}]);this.upload_button._onclick=function(){(aResponse[0].upload||aResponse[0].file).__active_folder=[sAccount,sFolder];(aResponse[0].upload||aResponse[0].file)._click();};}else if(aAllowedFolders){aAllowedFolders=aAllowedFolders.filter(function(folder){return folder!=='X';});aPreselectedFolder=aAllowedFolders[0];}
this._create('tree_folder','obj_tree_folder2','tree','scroll',sAccount,sType)._opt={privateRootActive:false};this.filter.__filter(aPreselectedFolder||'X');aAllowedFolders&&this.filter.__aTypes.forEach(function(type){var elm=this.filter._getAnchor('buttons').querySelector('span.'+type.toLowerCase());elm&&elm.classList[!~aAllowedFolders.indexOf(type)?'add':'remove']('hidden');},this);this.tree_folder._onactivate=function(id){var arg=Path.split(id,true),sType=dataSet.get("folders",[arg['aid'],arg['fid'],'TYPE']);if(me.radio)
if(sType=='M'){me.radio._disabled(true);me.radio._value('embedded');}
else
me.radio._disabled(false);me._search(arg);me.datagrid._SQLsearch=sType==='I'?'gchat:files':'';me.datagrid._SQLfulltext='';me.datagrid._serverSort(arg);removecss(me._getAnchor('search'),'active');};}
me._getAnchor('search').onclick=function(){this.classList.add('active');this.querySelector('input').focus();};if(sFolder){if(WMFolders.getType([sAccount,sFolder])!='X'){if(this.tree_folder)
this.tree_folder._setActive((sAccount||sPrimaryAccount)+'/'+sFolder);else
this.datagrid._serverSort({aid:(sAccount||sPrimaryAccount),fid:sFolder});}
this._search({aid:(sAccount||sPrimaryAccount),fid:sFolder});}
this.x_btn_ok._onclick=function(){var v=me.datagrid._value();if(v.length){var aItem,aResult=[],sType,tmp;for(var i in v){if(!(aItem=me.__value[v[i]]))continue;sType=WMFolders.getType(aItem);tmp={'id':v[i],'fullpath':aItem.aid+'/'+aItem.fid+'/'+WMItems.__serverID(v[i]),'embedded':(!me.radio||me.radio._value()=='embedded'),'aid':aItem.aid,'fid':aItem.fid};switch(sType){case'M':tmp.title=(aItem['SUBJECT']?aItem['SUBJECT']+' - ':'')+WMItems.__serverID(v[i])+'.eml';break;case'C':tmp.title=aItem['ITMCLASSIFYAS']+'.vcf';break;case'I':case'K':case'F':tmp.title=aItem['EVNLOCATION'];tmp.size=aItem['EVNCOMPLETE'];break;case'E':case'J':case'N':case'T':tmp.title=aItem['EVNTITLE']+'.ics';break;default:tmp.title=getLang('INSERT_ITEM::UNTITLED');}
aResult.push(tmp);}
if(Is.Defined(aResponse))
executeCallbackFunction(aResponse,aResult);}
me._destruct();};this._onclose=function(){dataSet.remove(me._dataSet);if(aResponse[0]&&(aResponse[0].upload||aResponse[0].file)&&(aResponse[0].upload||aResponse[0].file).__remove_dropzone){(aResponse[0].upload||aResponse[0].file).__remove_dropzone(this._main.querySelector('.upload'));}
return true;};};_me._search=function(aFolder){this._create('search','obj_item_search','search','',aFolder);if(aFolder){if(!aFolder.ftype)
aFolder.ftype=WMFolders.getType(aFolder);this._getAnchor('search').querySelector('.label').innerHTML=getLang(({F:'SEARCH::IN_FILES',C:'SEARCH::IN_CONTACTS',T:'SEARCH::IN_TASKS',E:'SEARCH::IN_CALENDARS',M:'SEARCH::IN_EMAILS',N:'SEARCH::IN_NOTES',I:'SEARCH::IN_FILES'})[aFolder.ftype]||'MAIN_MENU::SEARCH');this.search._onsearch=function(v,s){if(dataSet.get("folders",[aFolder['aid'],aFolder['fid'],'TYPE'])==='I'){if(v){v+=' AND ';}
v+='gchat:files';}
this._parent.datagrid._SQLsearch=v;this._parent.datagrid._SQLfulltext=s;this._parent.datagrid._serverSort();};}};_me.__customViewOn=function(){this._main.querySelector('.upload').classList.remove('hidden');};_me.__customViewOff=function(){this._main.querySelector('.upload').classList.add('hidden');};_me.__customViewLabel=function(){return getLang('ATTACHMENT::UPLOAD');};_me.__filterTree=function(id){var oTree=this.tree_folder,activate=sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType(id);if(id==='I'){activate=sPrimaryAccount+'/'+this._default_folder;}
this.search.search._value('',true);oTree.__filter='';this.__customViewOff();this._main.setAttribute('view',id);switch(id){case'I':oTree._filter_folder(['I','Y']);break;case'M':oTree._filter_folder(['M','R','QL','Q']);activate=sPrimaryAccount+'/INBOX';break;case'E':oTree._filter_folder(['E']);break;case'B':oTree._filter_folder(['B','G','QL','Q']);activate=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES']['trash'];break;case'X':oTree._filter_folder(['X']);this.__customViewOn();break;case'K':oTree._filter_folder(['K']);if(this.alfresco_folder){var aPath=this.alfresco_folder._getActive();if(Is.String(aPath[1]))
this.datagrid._serverSort({aid:aPath[0],fid:aPath[1]});break;}
this._create('alfresco_folder','obj_tree_folder','tree','alfresco_folder noroot scroll','@@alfresco@@');this.alfresco_folder._listen_data('alfresco');this.alfresco_folder._onactivate=function(id,bChange){if(bChange){var aPath=Path.split(id,true);this._search(aPath);this.datagrid._SQLsearch='';this.datagrid._SQLfulltext='';this.datagrid._serverSort(aPath);removecss(this._getAnchor('search'),'active');if(this.radio){this.radio._disabled(true);this.radio._value('embedded');}}}.bind(this);this.alfresco_folder._onclick=function(e,elm,id){var aPath=Path.split(id,true);Alfresco.getFolderInfo(aPath.fid,[function(bOK,aFolder){if(bOK)
Alfresco.setLastFolder(aFolder.fid);}]);};Alfresco.getFolderInfo();var sLastFolder;if(this._default_account=='@@alfresco@@'&&this._default_folder)
sLastFolder=this._default_folder;else
sLastFolder=Alfresco.getLastFolder();if(sLastFolder){Alfresco.getFolderInfo(sLastFolder,[function(bOK,aFolder){if(bOK&&aFolder.fid.length){this.alfresco_folder._setActive(Path.build(aFolder));}}.bind(this)]);}
break;default:oTree._filter_folder([id]);}
for(var i in this.filter.__aTypes){(oTree._sFilterFolderType[this.filter.__aTypes[i]]?addcss:removecss)(this.filter._getAnchor(this.filter.__aTypes[i]),'active');}
if(!~['X','K'].indexOf(id)){oTree._fill();oTree._setActive(activate);}};

/* client/inc/frm_jitsi.js */
function frm_jitsi(){};frm_jitsi.prototype.__constructor=function(){if(!sPrimaryAccountCONFERENCE){return;}
this._draw('frm_jitsi');this.focus._onclick=this._focus.bind(this);this.leave._onclick=this._close.bind(this);gui._obeyEvent('conference_started',[this,'_updateGUI']);gui._obeyEvent('conference_started',[this,'_createConferenceJournal']);gui._obeyEvent('conference_ended',[this,'_updateGUI']);addEventListener('message',function(event){if(event.data.type==='conference'){wm_conference.get(event.data.cid).receiveMessage(event);}},false);var last_running_conference_timstamp=localStorage.getItem('last_running_conference_timestamp');if(last_running_conference_timstamp&&last_running_conference_timstamp>(+new Date()-10000)){this.__brc=this._bindRunningConference.bind(this);addEventListener('click',this.__brc);addEventListener('keypress',this.__brc);}
addEventListener('click',function(event){var tmp;if(event.target.tagName==='A'&&(tmp=event.target.href.match(wm_conference.linkRegExp))){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();wm_conference.get(tmp[2]+'_'+tmp[1]).join();}});};frm_jitsi.prototype._bindRunningConference=function(){removeEventListener('click',this.__brc);removeEventListener('keypress',this.__brc);this.window=window.open('','jitsi_'+sPrimaryAccount,'menubar=no,location=no,scrollbars=no,status=no,width=100,height=100');try{if(this.window.document.body.innerHTML){}else{this.window.close();this.window=null;}}catch(e){}
if(this.window){var id=this.window.location.toString().split('/').pop().replace('#','')+'_'+this.window.location.hostname;var conference=wm_conference.get(id);conference.window=this.window;conference.isRunning=true;dataSet.add('main',['conference'],id);conference.postMessage({event:'load'});conference.getDetail(function(){gui.__exeEvent('conference_started');});}};frm_jitsi.prototype._focus=function(){wm_conference.get(dataSet.get('main',['conference'])).focus();gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@MEETINGS@@__'});gui.frm_main.main._view('progress');};frm_jitsi.prototype._close=function(){wm_conference.get(dataSet.get('main',['conference'])).close();};frm_jitsi.prototype._updateGUI=function(){var conference=wm_conference.get(dataSet.get('main',['conference']));this.focus.__eIN.value=getLang('CONFERENCE::CONFERENCE_IN_PROGRESS',[conference.data.subject||conference.id||getLang('CONFERENCE::TITLE')]);};frm_jitsi.prototype._createConferenceJournal=function(){var conference=wm_conference.get(dataSet.get('main',['conference']));var now=new IcewarpDate();var then=now.clone().add(30,'minutes');var contacts=[];if(!conference){return;}
for(var i in conference.data.CONTACTS||[]){contacts.push(conference.data.CONTACTS[i]);}
WMItems.add(GWOthers.getItem('DEFAULT_FOLDERS','JOURNAL').split('/'),{values:{EVNTITLE:conference.data.subject,EVNNOTE:conference.data.EVNNOTE||('<a href="'+conference.getLink()+'">'+getLang('CONFERENCE::LINK')+'</a>'),EVNDESCFORMAT:conference.data.EVNDESCFORMAT||'text/html',EVNLOCATION:'Conference|',EVNMEETINGID:conference.id.split(/[_@]/)[0],EVNFLAGS:1,EVNSHARETYPE:'U',EVNTIMEFORMAT:'Z',_TZEVNSTARTDATE:now.format(IcewarpDate.JULIAN),_TZEVNSTARTTIME:now.format(IcewarpDate.JULIAN_TIME),_TZEVNENDDATE:then.format(IcewarpDate.JULIAN),_TZEVNENDTIME:then.format(IcewarpDate.JULIAN_TIME),_TZID:GWOthers.getItem('CALENDAR_SETTINGS','timezone')},CONTACTS:contacts.length?contacts:void 0},'','','',[function(bOk,aData){if(!bOk||!gui.socket){return;}
var f=dataSet.get('folders',[sPrimaryAccount,Mapping.getDefaultFolderForGWType('J')]);f&&gui.socket.api._notify({ACTION:'add',TYPE:'item',ITEM:aData.id,FOLDER:f.RELATIVE_PATH,'FOLDER-TYPE':f.TYPE,EMAIL:sPrimaryAccount,'ITEM-TYPE':'J'});}.bind(this)]);};

/* client/inc/frm_journal.js */
_me=frm_journal.prototype;function frm_journal(){};_me.__constructor=function(){this._defaultSize(-1,-1,650,620);var me=this,aData={};if(this._aValues.EVNFLAGS&&this._aValues.EVNFLAGS&2)
aData.schedule=true;this._draw('frm_journal','main',aData);msiebox(this.maintab.tab1._getAnchor('msiebox'));this.maintab.tab1.EVNNOTE.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});this.maintab.tab1.X_TYPE._fillLang({'Conversation':"JOURNAL::CONVERSATION",'Document':"JOURNAL::DOCUMENT",'E-mail Message':"JOURNAL::E-MAIL_MESSAGE",'Fax':"JOURNAL::FAX",'Letter':"JOURNAL::LETTER",'Conference':"JOURNAL::CONFERENCE",'Conference Cancellation':"JOURNAL::CONFERENCE_CANCELLATION",'Conference Request':"JOURNAL::CONFERENCE_REQUEST",'Conference Response':"JOURNAL::CONFERENCE_RESPONSE",'Microsoft Office Access':"JOURNAL::MICROSOFT_OFFICE_ACCESS",'Microsoft Office Excel':"JOURNAL::MICROSOFT_OFFICE_EXCEL",'Microsoft PowerPoint':"JOURNAL::MICROSOFT_POWERPOINT",'Microsoft Visio':"JOURNAL::MICROSOFT_VISIO",'Microsoft Word':"JOURNAL::MICROSOFT_WORD",'Note':"JOURNAL::NOTE",'Phone Call':"JOURNAL::PHONE_CALL",'Remote Session':"JOURNAL::REMOTE_SESSION",'Task':"JOURNAL::TASK",'Task Request':"JOURNAL::TASK_REQUEST",'Task Response':"JOURNAL::TASK_RESPONSE"});this.maintab.tab1.X_TYPE._value('Phone Call');if(Is.Defined(this._aValues._TZID)){this._aValues['EVNSTARTDATE']=this._aValues._TZEVNSTARTDATE;this._aValues['EVNENDDATE']=this._aValues._TZEVNENDDATE;this._aValues['EVNSTARTTIME']=this._aValues._TZEVNSTARTTIME;this._aValues['EVNENDTIME']=this._aValues._TZEVNENDTIME;this._aValues['TZID']=this._aValues._TZID;}
this.__initForm('JOURNAL::JOURNAL');this.maintab.tab3.X_ATTACHMENTS.file._dropzone(this.__eContainer);this.maintab.tab3.X_ATTACHMENTS._onuploadstart=function(){this._parent._active();me.x_btn_ok._disabled(true);};this.maintab.tab3.X_ATTACHMENTS._onuploadend=function(){me.x_btn_ok._disabled(false);};};_me.__print=function(aValues){aValues=aValues.values;if((aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE)>0){if((aValues._TZEVNSTARTTIME||aValues.EVNSTARTTIME)>0){aValues.COUNT_DATE=IcewarpDate.julian(aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE).setTime(aValues._TZEVNSTARTTIME||aValues.EVNSTARTTIME,true).format('L LT');}else{aValues.COUNT_DATE=IcewarpDate.julian(aValues._TZEVNSTARTDATE||aValues.EVNSTARTDATE).setTime(0,true).format('L');}
if((aValues._TZEVNENDTIME||aValues.EVNENDTIME)>0){aValues.COUNT_DATE+=' - '+IcewarpDate.julian(aValues._TZEVNENDDATE||aValues.EVNENDDATE).setTime(aValues._TZEVNENDTIME||aValues.EVNENDTIME,true).format('L LT');}else{aValues.COUNT_DATE+=' - '+IcewarpDate.julian(aValues._TZEVNENDDATE||aValues.EVNENDDATE).setTime(0,true).format('L');}}
else
aValues.COUNT_DATE='';if(!gui.print)
gui._create('print','frm_print');gui.print._add('J',aValues);};_me.__loadItems=function(){if(!this._aValues.TZID){this._aValues.TZID=GWOthers.getItem('CALENDAR_SETTINGS','timezone');this._aValues.EVNTIMEFORMAT='Z';}
var me=this,tab1=this.maintab.tab1;if(gui._rtl||!this._aValues||!this._aValues.EVNDESCFORMAT||this._aValues.EVNDESCFORMAT.toLowerCase()!='text/plain')
tab1.EVNNOTE.select._value('enabled');else
tab1.EVNNOTE.select._value('disabled');tab1.X_TIMEINTERVAL._value(this._aValues);loadDataIntoForm(tab1,this._aValues);tab1.EVNTITLE._onkeyup=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>32)
sTitle=sTitle.substr(0,32)+'...';me._title(sTitle+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);}
else
me._title(getLang('JOURNAL::JOURNAL')+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);};tab1.EVNTITLE._onkeyup();if(Is.Defined(this._aValues['EVNLOCATION'])&&this._aValues['EVNLOCATION']!='undefined'){var aTypeLocation=this._aValues['EVNLOCATION'].split('|');tab1.X_TYPE._value(aTypeLocation[0]);tab1.X_COMPANY._value(aTypeLocation[1]);}
if(this.maintab.tab2)
this.maintab.tab2._onactive=function(bFirstTime){if(bFirstTime){if(Is.Defined(me._aValues['CONTACTS']))
this.X_ATTENDEES._value(me._aValues['CONTACTS']);}}
if(this.maintab.tab3)
this.maintab.tab3._onactive=function(bFirstTime){if(bFirstTime){if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});if(me._aValues.fullpath)
this.X_ATTACHMENTS._value({'values':out});else
this.X_ATTACHMENTS._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID),'values':out});}
else
if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}}}
if(me._aValues['PUSH_ATTACHMENTS']&&this.maintab.tab3)
this.maintab.tab3._active();};_me.__saveItems=function(aValues){aValues['values']['EVNDESCFORMAT']=this.maintab.tab1.EVNNOTE.select._value()=='disabled'?'text/plain':'text/html';aValues['values']['EVNLOCATION']=this.maintab.tab1.X_TYPE._value()+'|'+this.maintab.tab1.X_COMPANY._value();aValues['values']=arrConcat(aValues['values'],this.maintab.tab1.X_TIMEINTERVAL._value());if(aValues.values['TZID']=='F'){aValues.values['EVNTIMEFORMAT']='F';delete aValues.values['TZID'];}
else
if(aValues.values['EVNTIMEFORMAT']=='Z'){aValues.values['_TZEVNSTARTDATE']=aValues.values['EVNSTARTDATE'];aValues.values['_TZEVNENDDATE']=aValues.values['EVNENDDATE'];aValues.values['_TZEVNSTARTTIME']=aValues.values['EVNSTARTTIME'];aValues.values['_TZEVNENDTIME']=aValues.values['EVNENDTIME'];aValues.values['_TZID']=aValues.values['TZID'];delete aValues.values['EVNSTARTDATE'];delete aValues.values['EVNENDDATE'];delete aValues.values['EVNSTARTTIME'];delete aValues.values['EVNENDTIME'];delete aValues.values['TZID'];}
var addon;if(this.maintab.tab2&&this.maintab.tab2.X_ATTENDEES){if(!Is.Empty(addon=this.maintab.tab2.X_ATTENDEES._value())){aValues['CONTACTS']=[];addon.forEach(function(item){if(!item.values){return aValues['CONTACTS'].push(item);}
item.values.CNTROLE=item.values.CNTROLE||'Q';item.values.CNTSTATUS=item.values.CNTSTATUS||'B';aValues['CONTACTS'].push(item);});aValues['values'].EVNFLAGS=1;}else{aValues['values'].EVNFLAGS='';}}
if(this.maintab.tab3&&this.maintab.tab3.X_ATTACHMENTS&&!Is.Empty(addon=this.maintab.tab3.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=addon;}

/* client/inc/frm_mail.js */
_me=frm_mail.prototype;function frm_mail(){};_me.__constructor=function(id,aSortInfo,aLockInfo,bIsHTML){this.__bIsHTML=bIsHTML;this._filter=aSortInfo;this._defaultSize(-1,-1,900,630);this._create('menu','obj_hmenu','header','obj_pupup_menu');if(id&&aLockInfo&&WMFolders.getType(id)=='I'){this._create('lock','obj_label','main','lock ico');this.__lock(aLockInfo);this.lock._onclick=function(){if(this._lockInfo.EVNLOCKOWN_ID===sPrimaryAccountGWID){Item.set_lock([id[0],id[1],this._lockInfo.id],false,false);}
else
if(this._lockInfo.EVNLOCKOWN_EMAIL){var room=dataSet.get('folders',[id[0],id[1]]);var group='';if(room.TYPE=='I'&&room.NAME){group=id[1].split('/');group.splice(-1,1,room.NAME);group=group.join('/');}
var sign_top=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','sign_top');GWOthers.setItem('MAIL_SETTINGS_DEFAULT','sign_top',0);var body=getLang('DOCUMENT::REQUEST_UNLOCK_TEXT',[this._lockInfo.EVNTITLE,(group||room.NAME||room.RELATIVE_PATH)],bIsHTML);var body_header=getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_GREETINGS',[dataSet.get('xmpp',['roster',this._lockInfo.EVNLOCKOWN_EMAIL,'name'])||this._lockInfo.EVNLOCKOWN_EMAIL]);NewMessage.compose({to:this._lockInfo.EVNLOCKOWN_EMAIL,subject:getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_SUBJECT',[(room.NAME||room.RELATIVE_PATH)+'/'+this._lockInfo.EVNTITLE]),mailBody:'<div>'+body_header+'</div><div><br></div><div>'+body+'</div>'});GWOthers.setItem('MAIL_SETTINGS_DEFAULT','sign_top',sign_top);}}.bind(this);gui.socket&&gui.socket.api._obeyEvent('onnotify',[this,'__notify']);}
this._create('view','obj_mailview','main');this.view._onkeypress=function(e){if(e.keyCode==27)
me._destruct();};this._add_destructor('__destruct');this.__request(id);};_me.__notify=function(aData){var id;if(aData.TYPE=="item"&&aData.ITEM&&(id=WMItems.__clientID(aData.ITEM))&&id==this._lockInfo.id){switch(aData.ACTION){case'unlock':this.__lock();break;case'lock':var aLockInfo={id:id,EVNLOCKOWN_ID:aData['ORIGINATOR-ID'],EVNLOCKOWN_NAME:aData['ORIGINATOR-NAME'],EVNLOCKOWN_EMAIL:aData['ORIGINATOR-EMAIL']};this.__lock(aLockInfo);break;}}};_me.__lock=function(aLockInfo){if(aLockInfo)
this._lockInfo=aLockInfo;if(aLockInfo&&aLockInfo.EVNLOCKOWN_ID){if(aLockInfo.EVNLOCKOWN_ID===sPrimaryAccountGWID){this.lock._value(getLang('FILE::LOCKED_BY_ME'));removecss(this.lock._main,'color2');}
else{this.lock._value(aLockInfo.EVNLOCKOWN_EMAIL?getLang('FILE::LOCKED_BY',[aLockInfo.EVNLOCKOWN_EMAIL]):getLang('FILE::LOCKED'));addcss(this.lock._main,'color2');}
addcss(this._main,'locked');}
else
removecss(this._main,'locked');};_me.__request=function(id){if(Is.Object(id)){this._title('COMMON::LOADING');this._create('loader','obj_loader','box');this.__id=id;this.__folder_type=WMFolders.getType(this.__id);if((GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_inline_images')||0)<1||(dataSet.get('main',['spam_path'])==this.__id[0]+'/'+this.__id[1]&&(GWOthers.getItem('MAIL_SETTINGS_GENERAL','show_images')||0)<1))
var def_val=OldMessage.__FULLMAIL_VALUES;else
var def_val=OldMessage.__FULLMAIL_VALUES_DANGER;WMItems.list({"aid":this.__id[0],"fid":this.__id[1],"iid":this.__id[2],"values":def_val},'','','',[this,'__response']);}};_me.__response=function(aData){if(this._destructed)
return;if(!aData){this._destruct();return;}
var me=this;if(!this._listener){this._listener='mailview_window';for(var no=0;;no++)
if(dataSet.get(this._listener))
this._listener='mailview_window_'+no;else
break;dataSet.add(this._listener,'',true,true);}
switch(this.__folder_type){case'I':default:if(this.__id[2].indexOf('|')<0){var message=new OldMessage(this.__id,[]);OldMessage.__mailviewCallback(message,message.hasFlag('SEEN'),aData);}
this.menu._onclick=function(e,elm,id,sAction){if(typeof sAction=='object')
executeCallbackFunction(sAction);else
switch(sAction){case'print':me.view._print();break;case'delete':Item.remove([me.__id[0],me.__id[1],[me.__id[2]]]);me._destruct();break;case'reply_to_sender':OldMessage.reply(me.__id,false,void 0,void 0,me.__bIsHTML);break;case'reply_to_all':OldMessage.reply(me.__id,true,void 0,void 0,me.__bIsHTML);break;case'forward':OldMessage.forward(me.__id,void 0,void 0,me.__bIsHTML);break;case'forward_att':OldMessage.forward(me.__id,true,false,me.__bIsHTML);break;case'redirect':OldMessage.redirect(me.__id);break;case'prev':case'next':me._prevNext(sAction=='prev');}};dataSet.add(this._listener,'',aData);this.__update(aData);}
this.loader&&this.loader._destruct();};_me._prevNext=function(bPrev){this._fillmenu();var me=this,iRow=0;this._filter.row=parseInt(this._filter.row,10)||0;this._filter.offset=parseInt(this._filter.offset,10)||0;if(this.__idTable){var bFound=false;for(var i in this.__idTable){if(this.__idTable[i]==this.__id[2]){this._filter.row=iRow;bFound=true;break;}
iRow++;}
var id;if(bFound&&((bPrev&&this._filter.row>0&&(id=this.__idTable[this._filter.row-1]))||(!bPrev&&this._filter.row<19&&(id=this.__idTable[this._filter.row+1])))){this.__request([this.__id[0],this.__id[1],id]);return;}}
var aFilter={sort:this._filter.sort,search:this._filter.search,limit:20,offset:this._filter.offset+this._filter.row-10>0?this._filter.offset+this._filter.row-10:0};WMItems.list({"aid":this.__id[0],"fid":this.__id[1],"filter":aFilter},'','','',[function(aData){if(aData&&aData[me.__id[0]]&&aData[me.__id[0]][me.__id[1]]){aData=aData[me.__id[0]][me.__id[1]];delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var bFound=false,iRow=0,ids=[];for(var i in aData){ids.push(i);if(i==me.__id[2]){me._filter=aFilter;me._filter.row=iRow;bFound=true;}
iRow++;}
if(bFound){me.__idTable=ids;if(bPrev&&me._filter.row>0)
me.__request([me.__id[0],me.__id[1],me.__idTable[me._filter.row-1]]);else
if(!bPrev&&me._filter.row<19&&me.__idTable[me._filter.row+1])
me.__request([me.__id[0],me.__id[1],me.__idTable[me._filter.row+1]]);else
me._fillmenu(true);}
else
if(ids.length){var id='';if(Is.Array(me.__idTable)&&me.__idTable.length)
if(bPrev&&me._filter.row>0){for(var i=me._filter.row-1;i>=0;i--){if(inArray(ids,me.__idTable[i])>-1){id=me.__idTable[i];break;}}}
else
if(!bPrev){for(var i=me._filter.row;i<me.__idTable.length;i++){if(inArray(ids,me.__idTable[i])>-1){id=me.__idTable[i];break;}}}
if(!id)
id=ids[me._filter.row]||ids[ids.length-1];me.__request([me.__id[0],me.__id[1],id]);}}}]);};_me.__update=function(aData){if(aData){for(var aid in aData)
for(var fid in aData[aid]){delete aData[aid][fid]['#'];delete aData[aid][fid]['/'];delete aData[aid][fid]['$'];delete aData[aid][fid]['@'];for(var iid in aData[aid][fid]);}
if(!(aData=aData[aid][fid][iid])||!aData.aid)return;if(aData.SUBJECT){this._title(aData.SUBJECT,true);}
else
this._title('MAIL_VIEW::NOSUBJECT');this._fillmenu(true);if(!this.view._listener){this.view._listen(this._listener,this._listenerPath);}}};_me.__destruct=function(){if(this._listener)
dataSet.remove(this._listener,'',true);if(this.__folder_type=='I')
gui.socket&&gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);return true;};_me._fillmenu=function(bPrevNext){var me=this,folders=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES'],aMenu=[],draft=this._lockInfo&&this._lockInfo.draft,bUser=!sPrimaryAccountGUEST&&!(TeamChatAPI&&TeamChatAPI.teamChatOnly());if(bUser){if(draft){aMenu.push({"title":'POPUP_ITEMS::FORWARD_AS_MESSAGE','arg':'forward_att',css:'ico2 forward'},{"title":'-'});}
else{if(this.__sFolderID!=folders['drafts']&&this.__sFolderID!=folders['sent'])
aMenu.push({"title":'MAIN_MENU::REPLY_TO_SENDER','arg':'reply_to_sender',css:'ico2 reply'});aMenu.push({"title":'MAIN_MENU::REPLY_TO_ALL','arg':'reply_to_all',css:'ico2 reply_all'},{"title":'MAIN_MENU::FORWARD','arg':'forward',css:'ico2 forward'});}
if(this._filter)
aMenu.push({"text":'',tooltip:'COMMON::PREVIOUS','arg':'prev','disabled':!bPrevNext,'css':'ico2 img prev'},{"text":'',tooltip:'COMMON::NEXT','arg':'next','disabled':!bPrevNext,'css':'ico2 img next'});}
aMenu.push({title:'MAIN_MENU::PRINT','arg':'print',css:'ico2 print'});if(bUser){aMenu.push({title:'COMMON::MORE','arg':'options','css':'ico2 more noarrow',keep:true,nodetype:'click',callback:[function(){var aData=arrayPath(dataSet.get(me._listener,me._listenerPath),me.__id)||{};try{var aMenu=obj_context_item.prototype.__createMailMenu.call(null,me.__id,[me.__id[0],me.__id[1],[me.__id[2]]],false,aData.FROM,WMFolders.getAccess(me.__id),true,{noactions:true});}
catch(r){aMenu=[];}
return aMenu;}]});if(WMFolders.getType(this.__id)!=='I')
aMenu.push({title:'MAIN_MENU::DELETE','arg':'delete',disabled:(this.__id[2].indexOf('|')>-1||!WMFolders.getAccess(this.__id,'remove')),css:'color2 ico2 delete'});}
this.menu._fill(aMenu);};

/* client/inc/frm_mail_print.js */
_me=frm_mail_print.prototype;function frm_mail_print(){};_me.__constructor=function(aResponse,aOpt){var me=this;this._size(450,300,true);this._dockable(false);this._resizable(false);this._draw('frm_mail_print','main',aOpt);this._title('PRINT::OPTIONS');var c=Cookie.get(['mailview_print']);for(var sObj in c)
if(this[sObj]&&this[sObj]._checked)
this[sObj]._checked(true);this._create('x_btn_ok','obj_button','footer','noborder ok color1');this.x_btn_ok._value('MAIN_MENU::PRINT');this.x_btn_ok._onclick=function(){var o=me._getChildObjects('','obj_checkbox'),aOpt={};for(var i in o)
if(o[i]._checked&&o[i]._disabled()===false){aOpt[o[i]._name]=o[i]._checked();Cookie.set(['mailview_print',o[i]._name],aOpt[o[i]._name]?1:0);}
me._destruct();executeCallbackFunction(aResponse,aOpt);};this._create('x_btn_cancel','obj_button','footer','cancel noborder simple');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct();};this.x_btn_ok._focus();};

/* client/inc/frm_main.js */
_me=frm_main.prototype;function frm_main(){};frm_main.recent_sorted=false;_me.__constructor=function(bAlreadySynced)
{var me=this;this.__refreshFolderTimeout={};this._main.setAttribute('selected','folder');gui._main.addEventListener('contextmenu',function(e){var e=e||window.event;e.ctrlKey&&e.stopPropagation&&e.stopPropagation();return true;},true);this._create('title','obj_title');if('onpopstate'in window&&'pushState'in history){window.onpopstate=function(e){history.pushState(parseURL(),document.title,document.pathname);me.title._refresh(true);};}
gui._create('focus','obj_focus');storage.library('dragndrop');this.dnd=new cDnD();gui._create('tooltip','obj_tooltip');if(!Is.Defined(gui._REQUEST_VARS['mailto'])&&!gui._REQUEST_VARS['cc']&&!gui._REQUEST_VARS['bcc']){this.sound=gui._create('sound','obj_sound');this.audio=gui._create('audio','obj_audio');gui._create('notifier','obj_notifier');gui._create('printer','obj_print');window.onbeforeunload=function(e){e=e||window.event;if(typeof e.clientX=='undefined'||e.clientX<0||e.clientY<0){switch(GWOthers.getItem('LAYOUT_SETTINGS','confirm_exit').toString()){case'1':if(gui._getChildObjects('main','frm_compose').length<1)
break;case'2':e.cancelBubble=true;if(e.stopPropagation){e.stopPropagation();e.preventDefault();}
return getLang('CONFIRMATION::UNLOAD');}
if(!e.explicitOriginalTarget||e.explicitOriginalTarget==document){if(gui.connection)
gui.connection._destruct();if(gui.frm_main){if(gui.frm_main.im)
gui.frm_main.im._destruct();gui.frm_main.__onDestruct();}}}};if(window.WebSocket){gui._create('socket','obj_websocket');gui.socket._create('api','obj_websocket_api');gui._create('subscriber','obj_subscriber');if(!sPrimaryAccountGUEST)
gui.socket._create('xmpp','obj_websocket_xmpp');var refresh_timeout;gui.socket.api._obeyEvent('onnotify',[function(aData){if((aData['ORIGINATOR-EMAIL']||aData.EMAIL)!==sPrimaryAccount&&aData['ITEM-TYPE']==='F'&&aData['TYPE']==='item'&&~['update','add'].indexOf(aData.ACTION)){var sFolder,aFolders=dataSet.get('folders',[sPrimaryAccount]);for(var sFolder in aFolders){if(((aData.EMAIL===sPrimaryAccount&&!aFolders[sFolder].OWNER)||(aFolders[sFolder].OWNER===aData.EMAIL))&&aFolders[sFolder].RELATIVE_PATH===Path.slash(aData.FOLDER)){break;}}
if(dataSet.get('folders',[sPrimaryAccount,sFolder,'TYPE'])!=='F'&&(GWOthers.getItem('CHAT','visual_notify')=='0'||dataSet.get('folders',[sPrimaryAccount,sFolder,'NOTIFY'])!='1')){return;}
WMItems.list({"aid":sPrimaryAccount,"fid":sFolder,"iid":aData.ITEM},'','','',[function(response){aData.data=response[sPrimaryAccount][sFolder]['*'+aData.ITEM];aData.data&&gui.notifier._value({type:'document_'+(aData.ACTION==='add'?'added':'edited'),args:aData,save:true});}]);return;}
if(aData&&aData.EMAIL){if(aData.ACTION&&aData.EMAIL!=sPrimaryAccount&&('folder'===aData.TYPE||'acl'==aData.TYPE||('item'===aData.TYPE&&'W'===aData['ITEM-TYPE']&&aData.ACTION==='add'))){switch(aData.ACTION){case'delete':case'update':case'add':refresh_timeout&&clearTimeout(refresh_timeout);refresh_timeout=setTimeout(function(){WMAccounts.refresh({'aid':sPrimaryAccount},'folders',undefined,[me,me.__newTeamchatRoomCallback,[aData]]);},1000);}}
else
if(aData.ACTION=='add'&&aData['FOLDER-TYPE']=='I'&&aData.FOLDER){switch(aData['ITEM-TYPE']){case'R':if(aData.COMEVNID)
break;case'I':case'W':case'Y':case'Q':case'S':var folder=Path.slash(aData.FOLDER),aFolders=dataSet.get('folders',[sPrimaryAccount]),aActive=Path.split(dataSet.get('active_folder'));for(var fid in aFolders)
if(aFolders[fid].OWNER==aData.EMAIL&&aFolders[fid].RELATIVE_PATH==folder){if(!aFolders[fid].SYNC||aFolders[fid].SYNC==='0'){return;}
var i;if((aActive[0]==sPrimaryAccount)&&(aActive[1]==fid)&&gui.frm_main.main.tabs.room._isActive){i=0;}
else{i=parseInt(aFolders[fid].RECENT||0)+1;}
dataSet.add('folders',[sPrimaryAccount,fid,'RECENT'],i.toString());me.__addTeamchatFolderToRecent(fid);break;}
dataSet.add('folders',[sPrimaryAccount,fid,'GROUPCHAT_LASTACTIVITY'],Math.floor(new Date().getTime()/1000).toString());if(dataSet.get('folders',[sPrimaryAccount,fid,'NOTIFY'])=='1'&&(aData.TITLE||aData.BODY||'').indexOf('/')!==0){var aFolder=dataSet.get('folders',aActive);if(aFolder.OWNER==aData.EMAIL&&aFolder.RELATIVE_PATH==folder&&gui.frm_main.main.tabs.room._isActive)
return;if(GWOthers.getItem('CHAT','visual_notify')>'0'){gui.notifier._value({type:'teamchat',save:true,args:{data:aData,text_plain:aData.TITLE||aData.BODY},timeout:5000,aHandler:[function(aData){var folder=Path.slash(aData.FOLDER),aFolders=dataSet.get('folders',[sPrimaryAccount]);if(folder)
for(var fid in aFolders)
if(aFolders[fid].OWNER==aData.EMAIL&&aFolders[fid].RELATIVE_PATH==folder){gui.frm_main._selectView({aid:sPrimaryAccount,fid:fid});gui.frm_main.filter.__filter('I');break;}},[aData]]});}
if(GWOthers.getItem('CHAT','sound_notify')>'0'&&gui.frm_main.sound){gui.frm_main.sound._play('chat');}}}}
else
if(aData.FOLDER&&aData.ACTION&&aData.ITEM&&~['F','I','Y'].indexOf(aData['FOLDER-TYPE'])){var folder=Path.slash(aData.FOLDER),aFolders=dataSet.get('folders',[sPrimaryAccount]),fid=null;for(var i in aFolders){if((aFolders[i].OWNER||sPrimaryAccount)==aData.EMAIL&&aFolders[i].RELATIVE_PATH==folder){fid=i;break;}}
var ds;if(fid&&(ds=dataSet.get('items',[sPrimaryAccount,fid,WMItems.__clientID(aData.ITEM)]))){var bUpdate=false;switch(aData.ACTION){case"lock":ds.EVNLOCKOWN_EMAIL=aData['ORIGINATOR-EMAIL'];ds.EVNLOCKOWN_ID=aData['ORIGINATOR-ID'];bUpdate=true;break;case"unlock":ds.EVNLOCKOWN_EMAIL=sPrimaryAccount;ds.EVNLOCKOWN_ID='';bUpdate=true;break;case"start_edit":case"join_edit":case"stop_edit":case"edit_session_finished":bUpdate=true;break;case"update":case"add":if(aData.TIME>0){ds.EVN_MODIFIED=aData.TIME;bUpdate=true;}}
if(bUpdate){dataSet.update('items',[sPrimaryAccount,fid,WMItems.__clientID(aData.ITEM)]);}}}
else
if(aData.SERVICE==='SMTP'&&aData.EMAIL===sPrimaryAccount&&aData.ACTION==='add'){me.__refreshFolderTimeout[aData.FOLDER]=me.__refreshFolderTimeout[aData.FOLDER]||setTimeout(function(){delete me.__refreshFolderTimeout[aData.FOLDER];WMFolders.sync({aid:sPrimaryAccount,fid:aData.FOLDER},'folders','',[gui.frm_main,'_refreshItems',[sPrimaryAccount]]);},Math.max(Math.random()*60000,15000));}}}]);}}
storage.library('class_folder');storage.library('class_item');storage.library('class_items_recover_helper');storage.library('class_old_message');storage.library('class_new_message');var aAccounts=dataSet.get('accounts');this.__goNextCount=0;for(var sAccId in aAccounts)
if(aAccounts[sAccId])
if(aAccounts[sAccId]['PRIMARY']){if(!bAlreadySynced)
dataSet.add('folders',[sAccId],WMAccounts.refresh({'aid':sAccId})[sAccId]);}
else
if((GWOthers.getItem('RESTRICTIONS','disable_otheraccounts')||0)<1||aAccounts[sAccId].TYPE=='rss'){this.__goNextCount++;WMFolders.list({'aid':sAccId},'folders',[sAccId],[this,'_goNext']);}
if(sPrimaryTelemetry){storage.library('telemetry');gui._create('telemetry','telemetry');}
if(!this.__goNextCount)
this.__constructor2();};_me.__mkAd=function(){return mkElement('ins',{'class':'adsbygoogle','data-ad-client':GWOthers.getItem('BANNER_OPTIONS','customer_id').trim(),'data-ad-slot':GWOthers.getItem('BANNER_OPTIONS','below_code')});};_me.__prepareTopBanner=function(){var sEnabled=GWOthers.getItem('RESTRICTIONS','enable_adsense');if('1'!==sEnabled){return;}
var top_type=GWOthers.getItem('BANNER_OPTIONS','top_type');var banner;if(!top_type||top_type==='none'){return;}
if(top_type==='url'){this._main.classList.add('has-banner');document.getElementById('banner-container').style.backgroundImage='url('+GWOthers.getItem('BANNER_OPTIONS','top_url')+')';return;}
if(top_type==='code'){(window.adsbygoogle=window.adsbygoogle||[]).push({});if(!document.getElementById('adsbygoogle')){var script=document.createElement('script');script.id='adsbygoogle';script.type='text/javascript';script.src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";document.head.appendChild(script);}
this._main.classList.add('has-banner');banner=this.__mkAd();document.getElementById('banner-container').appendChild(banner);return;}};_me.__prepareIMBanner=function(){var sEnabled=GWOthers.getItem('RESTRICTIONS','enable_adsense');if('1'!==sEnabled){return;}
var top_type=GWOthers.getItem('BANNER_OPTIONS','below_type');var below_code=GWOthers.getItem('BANNER_OPTIONS','below_code');var below_url=GWOthers.getItem('BANNER_OPTIONS','below_url');var ad,banner;if(!top_type||top_type==='none'||!this.im||(top_type==='code'&&!below_code)||(top_type==='url'&&!below_url)){return;}
ad=mkElement('div',{'class':'adsense-im'});banner;if(top_type==='url'){banner=mkElement('div',{'class':'adsense-im-banner'});banner.style.backgroundImage='url('+GWOthers.getItem('BANNER_OPTIONS','below_url')+')';}
if(top_type==='code'){(window.adsbygoogle=window.adsbygoogle||[]).push({});if(!document.getElementById('adsbygoogle')){var script=document.createElement('script');script.id='adsbygoogle';script.type='text/javascript';script.src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js";document.head.appendChild(script);}
banner=this.__mkAd();banner.classList.add('adsense-im-banner');}
ad.appendChild(banner);this.im._main.appendChild(ad);this.im._main.classList.add('with-banner');};_me._goNext=function(){this.__goNextCount--;if(!this.__goNextCount)
this.__constructor2();};_me.__constructor2=function(){var me=this;if(window.FormData){this.__dropzones=[];this.__dragtimer=null;this.__filedrag=true;document.addEventListener("dragover",function(e){if(me.__filedrag){e.preventDefault();if(me.__dragtimer==null)
me.__file_dragover(e);else
window.clearTimeout(me.__dragtimer);me.__dragtimer=window.setTimeout(function(){me.__dragtimer=null;me.__file_dragover(false);},500);}},false);document.addEventListener("drop",function(e){if(me.__filedrag)e.preventDefault();},false);document.addEventListener("dragstart",function(e){me.__filedrag=false;},true);document.addEventListener("dragend",function(e){me.__filedrag=true;},true);}
if(Is.Defined(gui._REQUEST_VARS['mailto'])||gui._REQUEST_VARS['cc']||gui._REQUEST_VARS['bcc']){var head={to:unescape(gui._REQUEST_VARS['mailto']||''),subject:unescape(gui._REQUEST_VARS['subject']||''),cc:unescape(gui._REQUEST_VARS['cc']||''),bcc:unescape(gui._REQUEST_VARS['bcc']||''),mailBody:unescape(gui._REQUEST_VARS['body']||'')};var frm=NewMessage.compose(head);frm._maximize();frm._resizable(false);frm._dockable(false);frm._onclose=function(b){if(b)
self.close();return false;};frm._obeyEvent('onhide',[function(){if(!gui.loader)
gui._create('loader','obj_loader');gui.loader._value(getLang('COMMON::SENDING'));}]);frm._obeyEvent('onshow',[function(){if(gui.loader)
gui.loader._destruct();}]);frm._obeyEvent('onsend',[function(){addcss(gui.loader._main,'alert');gui.loader._value(getLang('MESSAGE::CLOSE_WINDOW'));self.close();}]);return;}
this._loadTags(true);var aFolders=dataSet.get('folders','',true),aItems=Cookie.get(['folders']);if(typeof aItems=='object'){for(var aid in aItems){if(!aFolders[aid]){Cookie.set(['folders',aid],'');}
else
for(var fid in aItems[aid])
if(!aFolders[aid][fid])
Cookie.set(['rights',aid,fid],'');}}
var aRights=Cookie.get(['rights']);if(typeof aRights=='object'){for(var sAccId in aRights){if(!aFolders[sAccId]){Cookie.set(['rights',sAccId],'');continue;}
for(var sFolId in aRights[sAccId]){if(!aFolders[sAccId][sFolId])
Cookie.set(['rights',sAccId,sFolId],'');}}}
Cookie.get(['rights',sAccId,sFolId],'');if(typeof Cookie.get(['views'])=='object')
Cookie.set(['views']);var aTree=Cookie.get(['tree']);if(Is.Array(aTree)&&aTree.length){Cookie.set(['tree'],aTree.filter(function(v){if(v.indexOf('other/')===0){v=v.substring(6);}
var p=Path.split(v,true);if(p.fid.length){var bSub=false;for(var f in aFolders[p.aid])
if(f!=p.fid&&f.indexOf(p.fid+'/')==0){bSub=true;break;}
return bSub&&aFolders[p.aid]&&(aFolders[p.aid][p.fid]||p.fid!='SPAM_QUEUE'||p.fid!='__@@VIRTUAL@@__');}
else
if(p.aid==='root::other'){return true;}
else
if(p.aid){return aFolders[p.aid];}}));}
var oActiveFolder={},sActiveFolder='',sFilter='',sInitPage='';if(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly())){Cookie.set(['filter_tree'],'I,Y');if(Cookie.get(['last'])&&Cookie.get(['last'].I)){var __parts=Cookie.get(['last']).I.split('/');var __email=__parts.shift();var __relative=__parts.join('/');var folder=dataSet.get('folders',[__email,__relative]);if(folder){oActiveFolder={aid:__email,fid:__relative};sActiveFolder=Cookie.get(['last']).I;}}
if(!sActiveFolder){for(var n in aFolders[sPrimaryAccount])
if(aFolders[sPrimaryAccount][n].TYPE=='I'){oActiveFolder={aid:sPrimaryAccount,fid:n};sActiveFolder=oActiveFolder.aid+'/'+oActiveFolder.fid;break;}
if(!sActiveFolder)
sInitPage='h';}}
else{sInitPage=GWOthers.getItem('LAYOUT_SETTINGS','init_page');if(gui._REQUEST_VARS['page']){var page=gui._REQUEST_VARS['page'].toLowerCase();switch(page){case'home':sInitPage='h';Cookie.set(['filter_tree'],'');break;case'inbox':sInitPage='i';Cookie.set(['filter_tree'],'M');break;default:if(!sPrimaryAccountGW||(page==='chat'&&!sPrimaryAccountCHAT))
break;var filter={tasks:'T',contacts:'C',documents:'F',journal:'J',notes:'N',calendar:'E',chat:'I,Y'}[page];if(filter&&(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf(filter)==-1){sInitPage='';Cookie.set(['filter_tree'],filter);if(page==='chat'){oActiveFolder={aid:sPrimaryAccount,fid:gui._REQUEST_VARS.RoomID};dataSet.add('teamchat',['forced_last_read_id'],WMItems.__serverID(gui._REQUEST_VARS.PostID||''));}
else
oActiveFolder={aid:sPrimaryAccount,fid:Mapping.getDefaultFolderForGWType(filter)};sActiveFolder=oActiveFolder.aid+'/'+oActiveFolder.fid;}}}}
this._draw('frm_main');this.dock._onchange=function(b){window[b?'addcss':'removecss'](me._getAnchor('container'),'dock');};this._create('bar','obj_barmenu','left');this.bar._listen('cookies',['barmenu']);this.bar._create('top','obj_barmenu_block','top','obj_barmenu_main')._size(0);if(GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0){this.bar._create('fav','obj_barmenu_favorites',{target:'top',first:false},'',0,'FAVORITES::FAVORITES');}
this.bar._create('tree','obj_barmenu_block','middle','all');this.bar.tree._create('slide','obj_slide')._create('1','obj_slide_panel')._create('folders','obj_tree_folder2_context');this.bar.tree.folders=this.bar.tree.slide['1'].folders;if(!sPrimaryAccountGUEST){var btn=this.bar.tree._create('add_container','obj_block','','add_container')._create('btn_add','obj_button','','btn_add ico add color1 simple btn_important');btn._onclick=function(e){var sFolderID=Path.split(dataSet.get('active_folder'));if(sFolderID&&sFolderID[0]==sPrimaryAccount&&sFolderID[1]&&~['I','Y'].indexOf(WMFolders.getType({aid:sPrimaryAccount,fid:sFolderID[1]})))
sFolderID=sFolderID[1];else
sFolderID='';try{this._getFocusElement().blur()}catch(r){}
Folder.addFolder({aid:sPrimaryAccount,fid:sFolderID},[Folder.openFolder]);};}
dataSet.on('active_folder',[],function(){var sActiveFolder=dataSet.get('active_folder'),aPath=Path.split(sActiveFolder,true),sType=WMFolders.getType(aPath);if(aPath.aid&&aPath.fid=='~')
this.tree.folders._setActive(aPath.aid);else
this.tree.folders._setActive(sActiveFolder);if(sType==="I"||sType==='Y'){this.tree.add_container&&this.tree.add_container.btn_add._value('CHAT::ADD_ROOM');gui.frm_main.main.text&&gui.frm_main.main.text._private();this.fav&&this.fav._destruct();if(!this.top.switch){this.top._create('switch','obj_button_recent','','switch');this.top._size(55);this.tree.folders.inp_search._placeholder(getLang('CHAT::FILTER_ROOMS'));}
if(!this.tree.slide['2']){this.tree.slide._create('2','obj_slide_panel')._create('recent','obj_tree_list');this.tree.slide['2'].recent.inp_search._placeholder(getLang('CHAT::FILTER_ROOMS'));}
if(!this.tree.slide['3']){this.tree.slide._create('3','obj_slide_panel')._create('unsubscribed','obj_tree_folder2_archive');this.tree.slide['3'].unsubscribed.inp_search._placeholder(getLang('CHAT::FILTER_ROOMS'));}
var active_groupchat_view=+dataSet.get('cookies',['active_groupchat_view']);if(active_groupchat_view===2&&!~(dataSet.get('cookies',['recent'])||[]).indexOf(dataSet.get('cookies',['last','I'])))
active_groupchat_view=1;this.top.switch._value(active_groupchat_view);}
else{this.tree.add_container.btn_add._value('MAIN_MENU::ADD_FOLDER');this.tree.add_container.btn_add._disabled(false);if(this.top.switch){this.top.switch._destruct();this.top._size(0);this.tree.folders.inp_search._placeholder(getLang('POPUP_FOLDERS::FILTER_FOLDERS'));}
if(!this.fav&&GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0)
this._create('fav','obj_barmenu_favorites',{target:'top',first:false},'',0,'FAVORITES::FAVORITES');this.tree.slide._value('1');this.tree.folders.btn_all._disabled(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()));if(this.tree.slide['2'])
this.tree.slide['2']._destruct();if(this.tree.slide['3'])
this.tree.slide['3']._destruct();}},this.bar);this.bar.tree.folders._create('btn_all','obj_button','search','simple noborder transparent ico img all');if(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))
this.bar.tree.folders.btn_all._disabled(true);else{this.bar.tree.folders.btn_all._title('COMMON::SHOW_ALL');this.bar.tree.folders.btn_all._onclick=function(){if(hascss(this._main,'active')){var aFolder=Path.split(dataSet.get('active_folder'));if(aFolder[1]){var sType=WMFolders.getType(aFolder);switch(sType){case'QL':case'G':sType='B';case'M':if(GWOthers.getItem('DEFAULT_FOLDERS','trash').split('/')[1]==aFolder)
sType='B';case'C':case'E':case'F':case'N':case'T':case'I':gui.frm_main.filter.__filter(sType);removecss(this._main,'active');break;}}}else{addcss(this._main,'active');gui.frm_main.filter.__filter('A');}
Cookie.set(['show_all_folders'],+hascss(this._main,'active'));};}
this._changeViewSize(GWOthers.getItem('LAYOUT_SETTINGS','compact_view')||"0",true);this._create('hmenu1','obj_hmenu_basic','menu1','obj_hmenu_basic');this._create('toolbar','obj_hmenu_toolbar','toolbar1','transparent');this._create('preview','obj_hmenu_preview','menu3');this._create('density','obj_hmenu_density','menu3');this._create('notifications','obj_hmenu_notifications','menu3');this._create('stat','obj_hmenu_status','menu3','obj_hmenu_status');this.search=this._create('search','obj_item_search','menu2');function toggleSearch(e){if(me.search._main.classList.contains('collapsed')){me.search._main.classList.remove('collapsed');me.search.search._focus();}else if(e.offsetX>120&&!me.search._value()){me.search._main.classList.add('collapsed');}};this.search.search._obeyEvent('change',[function(e,arg){if(arg.owner._value().length){toggleSearch({});}}]);this.search._main.addEventListener('click',toggleSearch);this.search._tabIndex();if(this.search.__resize){this.search.search._obeyEvent('onkeyup',[this.search.__resize]);this.search.search._obeyEvent('change',[this.search.__resize]);}
this._initResize();if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1){this._create('im','obj_im','im');}
if(window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){if(GWOthers.getItem('SIP','mode')=='integrate'&&GWOthers.getItem('SIP','start')>0)
this.__sipAutoLogin=setTimeout(function(){if(me&&GWOthers.getItem('SIP','start')>0&&!me.sip)
me._create('sip','obj_sip');},GWOthers.getItem('SIP','webrtc')==1?2000:15000);}
if(!sActiveFolder){if(sInitPage=='r'){if(sActiveFolder=Cookie.get(['last_folder'])){var aTmp=Path.split(sActiveFolder);if(WMFolders.getType(aTmp)=='X')
sActiveFolder='';else{oActiveFolder.aid=aTmp[0];if(aTmp[1])
oActiveFolder.fid=aTmp[1];}}
else{sActiveFolder=sPrimaryAccount+'/INBOX';oActiveFolder={'aid':sPrimaryAccount,'fid':'INBOX'};}}
else
if(sInitPage=='i'){sActiveFolder=sPrimaryAccount+'/INBOX';oActiveFolder={'aid':sPrimaryAccount,'fid':'INBOX'};}
if(!sActiveFolder||sInitPage=='h'){sActiveFolder=sPrimaryAccount;oActiveFolder={'aid':sPrimaryAccount};}}
this.bar.tree.folders._handleNode(oActiveFolder);sFilter=((TeamChatAPI&&TeamChatAPI.teamChatOnly()&&'I,Y')||Cookie.get(['filter_tree'])||WMFolders.getType(oActiveFolder));if(!Is.String(sFilter)||sFilter=='X')
sFilter='M';if(sFilter=='M'||(sInitPage=='i'&&sFilter.indexOf('M')<0))
sFilter='M,R,QL,Q';else
if(sFilter=='B')
sFilter='B,G,QL,Q';else
if(sFilter=='E')
if(dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__'])){dataSet.add('active_folder','',sPrimaryAccount+'/__@@VIRTUAL@@__/__@@EVENTS@@__',true);}
else{sFilter='';Cookie.set(['filter_tree'],'');}
if(sFilter){this.bar.tree.folders._filter_folder(sFilter.split(','));this.bar.tree.folders._fill();}
if(+Cookie.get(['show_all_folders'])){this.bar.tree.folders.btn_all._active(true);gui.frm_main.filter.__filter('A');}
if(gui._REQUEST_VARS['page']==='chat'&&sPrimaryAccountCHAT){gui.frm_main.filter.__filter('I');}
this._title();if(oWM_INIT&&!oWM_INIT.__refreshed)
this._getNew(true);this._add_destructor('__onDestruct');if(sPrimaryAccountGW){this.__RMN_get();this.__rmnInterval1=setInterval(function(){me.__RMN_get()},600000);this.__rmnInterval2=setInterval(function(){me.__RMN_check()},20000);}
if(GWOthers.getItem('LAYOUT_SETTINGS','activity')>0&&!gui._REQUEST_VARS['tconly']){var activity_last=new IcewarpDate(),activity_time=parseInt(GWOthers.getItem('LAYOUT_SETTINGS','activity'),10);activity_time=(activity_time>5?activity_time:5)*60;this.__activity=function(){activity_last=new IcewarpDate();};gui._obeyEvent('click',[this,'__activity']);gui._obeyEvent('mousemove',[this,'__activity']);gui._obeyEvent('focus',[this,'__activity']);setInterval(function(){if((new IcewarpDate()).unix()-activity_last.unix()>activity_time)
me.__logout(true);},60000);}
function whatsNew(){if(GWOthers.getItem('GLOBAL_SETTINGS','disable_whatsnew')!='1'&&(!TeamChatAPI||!TeamChatAPI.teamChatOnly())){var tmp=(GWOthers.getItem('LOGIN_SETTINGS','version')||'').split('.');if(Cookie.get(['whatsnew'])!=tmp[0]+'.'+tmp[1]+'.'+tmp[2])
setTimeout(function(){gui._create('whatsnew','frm_whatsnew');if(gui.gw)gui.gw._focus();},1000);}};if(dataSet.get('accounts',[sPrimaryAccount,'PASSEXPIRED']))
gui._create('expired','frm_changepass','','',[whatsNew],true);else
whatsNew();if(GWOthers.getItem('RESTRICTIONS','mandatory_user_info')=='1'&&Cookie.get(['suppressmandatory'])!=1){Item.openwindow([sPrimaryAccount,'@@mycard@@','@@mycard@@'],'','','C',null,[function(frm){frm._closable(false);frm._modal(true);frm._title("POPUP_ITEMS::MANDATORYDETAILS");if(GWOthers.getItem('GLOBAL_SETTINGS','mandatory_contact_fields')){if(frm.x_btn_cancel)
frm.x_btn_cancel._main.style.display='none';}
else
Cookie.set(['suppressmandatory'],1);}]);}
if(gui._REQUEST_VARS['open']){var sFolder=Path.basedir(gui._REQUEST_VARS['open']),sRID=WMItems.__clientID(Path.basename(gui._REQUEST_VARS['open']));if(sFolder&&sRID){WMItems.list({aid:sPrimaryAccount,fid:sFolder,rid:sRID},'','','',[function(aData){if(aData&&(aData=aData[sPrimaryAccount])&&(aData=aData[sFolder])){for(var i in aData)
if(aData[i].aid){var aPath=[sPrimaryAccount,sFolder,i];if(WMFolders.getType(aPath)=='M'){if(GWOthers.getItem('DEFAULT_FOLDERS','drafts')==sPrimaryAccount+'/'+sFolder)
OldMessage.edit(aPath);else
OldMessage.openwindow(aPath);}
else
Item.openwindow(aPath);break;}}
else{}}]);}
else{}}
if(gui._REQUEST_VARS.telemetry)
gui._create('frm_telemetry','frm_telemetry');this.dnd.registr_drop(this,['item','folder']);this.__prepareTopBanner();this.__prepareIMBanner();function hashChangeHandler(arg){var view=(arg.hash.match(/view=(\w+)/)||[])[1];var filter=view&&gui.frm_main.filter._main.querySelector('.'+view);filter&&filter.click();}
this._create('hash','hash');this.hash._obeyEvent('hashchange',[hashChangeHandler]);hashChangeHandler({hash:this.hash._getHash()});gui._obeyEvent('folderSelected',[this,'__select_handler',['folder']]);gui._obeyEvent('itemSelected',[this,'__select_handler',['item']]);this._create('jitsi','frm_jitsi','self','');gui._obeyEvent('conference_started',[this,'_updateConferenceTopBar']);gui._obeyEvent('conference_ended',[this,'_updateConferenceTopBar']);};_me._updateConferenceTopBar=function(){gui.frm_main._main.classList[dataSet.get('main',['conference'])?'add':'remove']('conference_in_progress');};_me.__select_handler=function(aData,e,sType){if(sType!=='item'||aData.length==3)
this._main.setAttribute('selected',sType);};_me._active_dropzone=function(v){var l=this._getAnchor('left');if(v)
removecss(l,'small');else
if(!l.__keep)
addcss(l,'small');return false;};_me._call=function(n,bVideo,bExt,bScreen){if(gui.conference){gui.notifier._value({type:'alert',args:{header:'MAIN_MENU::CONFERENCE',text:'CONFERENCE::NOCALLALLOWED'}});return false;}
if(n)
if(!bExt&&this.sip){if(dataSet.get('sip',['state'])=='online')
this.sip._call(n,bVideo,bScreen);else
this.sip._login(function(bOK){if(bOK)
gui.frm_main.sip._call(n,bVideo,bScreen);else
gui._create('alert','frm_alert','','','','SIP::ERROR','SIP::REGISTRATION_FAILED');});}
else
if(!bExt&&window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1&&GWOthers.getItem('SIP','mode')=='integrate'){this._create('sip','obj_sip','','',function(bOK){if(bOK)
gui.frm_main.sip._call(n,bVideo,bScreen);else
gui._create('alert','frm_alert','','','','SIP::ERROR','SIP::REGISTRATION_FAILED');});}
else{storage.library('wm_messages');message.dial(n,[function(bOK){if(bOK&&gui.notifier)
gui.notifier._value({type:'sip_external'});}]);}};_me._loadTags=function(bSynchro){if(sPrimaryAccountGW){if(bSynchro)
this.__parseTags(WMItems.list({aid:sPrimaryAccount,fid:'__@@TAGS@@__'}));else
WMItems.list({aid:sPrimaryAccount,fid:'__@@TAGS@@__'},'','','',[this,'__parseTags']);}};_me.__parseTags=function(aData){var aOut={};if(aData[sPrimaryAccount]&&(aData=aData[sPrimaryAccount]['__@@TAGS@@__'])){delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var sColor;for(var i in aData)
if(aData[i].TAGNAME){if(aData[i].TAGCOLOR)
sColor=colors.fast_contrast(aData[i].TAGCOLOR);else
sColor='#000000';aOut[aData[i].TAGNAME]={TAGNAME:aData[i].TAGNAME,TAGCOUNT:aData[i].TAGCOUNT,TAGCOLOR:aData[i].TAGCOLOR,TEXTCOLOR:sColor,ID:i};}}
dataSet.add('tags','',aOut);};_me._changeViewSize=function(v,bNoSave){document.body.className=document.body.className.replace('compact','');document.body.className=document.body.className.replace('small','');gui.frm_main.main&&gui.frm_main.main.list&&(gui.frm_main.main.list._original_height=33);var rows=2.8;switch(+v){case 1:rows=2;addcss(document.body,'small');break;case 2:rows=1;addcss(document.body,'compact');gui.frm_main.main&&gui.frm_main.main.list&&(gui.frm_main.main.list._original_height=25);break;}
if(gui.dial){gui.dial._list_options.rows=rows;gui.dial.list._small(gui.dial._list_options);gui.dial.list._serverSort();}
if(!bNoSave){if(gui.frm_main.main&&gui.frm_main.main.list)
gui.frm_main.main&&gui.frm_main.main.list._serverSort();}};_me.__file_dragover=function(e){for(var i=0;i<this.__dropzones.length;i++)
if(this.__dropzones[i]&&!this.__dropzones[i]._destructed&&this.__dropzones[i]._pathName&&Is.Function(this.__dropzones[i]._showDropZone))
this.__dropzones[i]._showDropZone(e);else
this.__dropzones.splice(i,1);};_me._registr_dropzone=function(obj){if(obj&&!obj._destructed&&Is.Function(obj._showDropZone)){for(var i=0;i<this.__dropzones.length;i++)
if(this.__dropzones[i]===obj)return true;this.__dropzones.push(obj);return true;}
return false;};_me._remove_dropzone=function(obj){this.__dropzones=this.__dropzones||[];for(var i=0;i<this.__dropzones.length;i++)
if(this.__dropzones[i]===obj){this.__dropzones.splice(i,1);break;}};_me._title=function(sFolder,iSelected,iTotal){if(this.title){var sOut='',aAccount,sPgTitle=GWOthers.getItem('LAYOUT_SETTINGS','title')||'';if((aAccount=dataSet.get('accounts',[sPrimaryAccount]))){if(sFolder){sOut+=sFolder;if(iTotal>0)
sOut+=' ['+(iSelected>0?iSelected+'/':'')+iTotal+']';sOut+=' - ';}
this.title._add(sOut+(sPgTitle?sPgTitle+' - ':'')+MailAddress.createEmail(aAccount.FULLNAME,sPrimaryAccountGUEST?aAccount.USERNAME:sPrimaryAccount,true));}}};_me.__RMN_get=function(){if(TeamChatAPI&&TeamChatAPI.teamChatOnly()){return;}
if(gui.__online){var iReminder=parseInt(Cookie.get(['reminders']),10),iDate=(new IcewarpDate()).format(IcewarpDate.JULIAN);if(!Is.Number(iReminder)||iReminder<iDate-7)
iReminder=iDate-7;else
if(iReminder>=iDate)
iReminder=iDate-1;WMItems.list({aid:sPrimaryAccount,fid:'__@@REMINDERS@@__',values:['CTZ'],filter:{INTERVAL:iReminder+'-'+(iDate+1)}},'','','',[this,'__RMN_parse']);}
else{var d=new IcewarpDate();Cookie.set(['reminders'],d.format(IcewarpDate.JULIAN));}};_me.__RMN_check=function(bShow){var iTame=(new IcewarpDate()).unix(),aData=dataSet.get('reminders'),out={},eventId;if(aData){for(var i in aData)
if(aData[i].unix<iTame)
out[aData[i].sha1]=aData[i];if(!Is.Empty(out))
if(bShow||gui.frm_reminder){if(!gui.frm_reminder){gui._create('frm_reminder','frm_reminder');for(eventId in out){gui.notifier._value({type:'reminder',args:[out[eventId]]});}}
gui.frm_reminder._fill(out);if(gui.gw&&gui.gw._isModal())
gui.gw._focus(true);}
else
this.__RMN_get();}};_me.__RMN_parse=function(aData){if(Is.Object(aData)){storage.library('sha1');var aOut=[],tStemp=0;for(var i in aData)
for(var j in aData[i]){delete aData[i][j]['/'];delete aData[i][j]['#'];delete aData[i][j]['$'];delete aData[i][j]['@'];for(var k in aData[i][j]){if(!tStemp||tStemp>aData[i][j][k].REMINDERUNIXTIME)
tStemp=aData[i][j][k].REMINDERUNIXTIME;aOut.push({aid:sPrimaryAccount,fid:aData[i][j][k].EVNFOLDER,iid:WMItems.__clientID(aData[i][j][k].EVN_ID),startdate:aData[i][j][k].EVNSTARTDATE,starttime:aData[i][j][k].EVNSTARTTIME,conferenceid:aData[i][j][k].EVNMEETINGID?parseInt(aData[i][j][k].EVNMEETINGID):'',organizer:aData[i][j][k].EVNORGANIZER,unix:aData[i][j][k].REMINDERUNIXTIME,rid:k,sha1:SHA1(k),'class':aData[i][j][k].EVNCLASS,'title':aData[i][j][k].EVNTITLE});}}
aOut=aOut.sort(function(a,b){return a.unix-b.unix});var d=new IcewarpDate();if(tStemp>0)
d=IcewarpDate.unix(tStemp);Cookie.set(['reminders'],d.format(IcewarpDate.JULIAN));dataSet.add('reminders','',aOut,true);this.__RMN_check(true);}};_me.__onDestruct=function(){if(this.__sipAutoLogin)
clearTimeout(this.__sipAutoLogin);if(gui.dial)
gui.dial._destruct();if(this.sip)
this.sip._destruct();if(sPrimaryAccountGW){clearInterval(this.__rmnInterval1);clearInterval(this.__rmnInterval2);}};_me._getNew=function(bMain){var aAccounts=dataSet.get('accounts');if(!aAccounts||!gui.__online)return;var disable_other=(GWOthers.getItem('RESTRICTIONS','disable_otheraccounts')==1);if(!Is.Empty(this.__refreshFolderTimeout)){Object.keys(this.__refreshFolderTimeout).forEach(function(s){clearTimeout(s);});this.__refreshFolderTimeout={};}
for(var sAccId in aAccounts){if(!aAccounts[sAccId]||(disable_other&&!aAccounts[sAccId]['PRIMARY']&&aAccounts[sAccId]['TYPE']!='rss'))
continue;accounts.refresh({'aid':sAccId},'folders','',[gui.frm_main,'_refreshItems',[sAccId]]);}};_me._refreshItems=function(sAccId)
{var aSelected=this.bar.tree.folders._getActive();if(aSelected[0]==sAccId&&aSelected[1])
{var sFolID=aSelected[1];if(WMFolders.getType([sAccId,sFolID])!='X')
this.bar.tree.folders._handleNode({'aid':sAccId,'fid':sFolID},true);else{dataSet.remove('items');dataSet.remove('preview');this.bar.tree.folders._handleNode({'aid':sPrimaryAccount,'fid':'~'},true);}}
var id;if(gui.frm_main.main&&gui.frm_main.main.itemview&&gui.frm_main.main.itemview.__reloadme&&(id=gui.frm_main.main.itemview.__activeItemID)&&id[0]==sAccId)
Item.open(id,'','','',true);};_me._selectView=function(aFolder,sView,bUpdate,oDate,bForceUpdate,sSearch,bNoTreeUpdate){dataSet.remove('items','',true);if(sView==='work_view'){sView='workweek_view';}
if(this._lastView==='work_view'){this._lastView='workweek_view';}
aFolder=aFolder||{};if(!aFolder['fid']){if(!aFolder['aid'])
aFolder['aid']=sPrimaryAccount;aFolder['fid']='~';}
var aView=Cookie.get(['views',aFolder.aid,aFolder.fid]),sFolType=aView.type;if(sFolType==='E'&&aView.view==='work_view'){aView.view='workweek_view';}
else
if(sFolType==='I'&&aView.view){aView.view='chat_view';}
if(sView&&aView.view!=sView){if(sFolType=='E'&&sView.indexOf('list')==0)
Cookie.set(['views',aFolder['aid'],aFolder['fid'],'prev'],{'list_view':'1','list_wide':'2'}[sView]);Cookie.set(['views',aFolder['aid'],aFolder['fid'],'view'],sView);}
else
if(sFolType=='X')
sView='nothing';else
sView=aView.view;if(sView!=this._lastView){gui.__exeEvent('viewSelected',sView);this._main.setAttribute('view',sView||'');}
var bNewFolder=false;if(dataSet.get('current_folder')!=aFolder['aid']+'/'+aFolder['fid']||this._lastView!=sView){bNewFolder=true;dataSet.add('current_folder','',aFolder['aid']+'/'+aFolder['fid']);}
if(sView!=this._lastView||(sView!='month_view'&&bForceUpdate))
{if((sView=='day_view'||sView=='week_view'||sView=='workweek_view')&&(this._lastView=='day_view'||this._lastView=='week_view'||this._lastView=='workweek_view'))
{if(!oDate){var oDate=new IcewarpDate();if(this.main.calendar._selection&&this.main.calendar._selection.startdate){oDate=IcewarpDate.julian(this.main.calendar._selection.startdate);}
else if(this.main.calendar.__allDaySelection&&this.main.calendar.__allDaySelection.startdate){oDate=IcewarpDate.julian(this.main.calendar.__allDaySelection.startdate);}else{var aRange=this.main.calendar._range();if(aRange['start']){oDate=IcewarpDate.julian(aRange['start']);}}}}
else{if(this.main){if(this._lastView=='day_view'||this._lastView=='week_view'||this._lastView=='workweek_view'||this._lastView=='month_view')
oDate=oDate||this.main._getDate();else
oDate=new IcewarpDate();this.main._destruct();}
else
oDate=new IcewarpDate();switch(sView){case'mail_view':case'mail_view_wide':case'mail_view_list':dataSet.remove('preview');this._create('main',{mail_view:'frm_main_mail',mail_view_wide:'frm_main_mail_wide',mail_view_list:'frm_main_mail_list'}[sView]);break;case'list':case'list_wide':case'list_view':dataSet.remove('preview');this._create('main',{list:'frm_main_datagrid',list_wide:'frm_main_datagrid_wide',list_view:'frm_main_datagrid_view'}[sView]);break;case'day_view':case'week_view':case'workweek_view':this._create('main','frm_main_calendar_dayweek','','','items');break;case'month_view':this._create('main','frm_main_calendar_month','','','items',oDate);break;case'chat_view':this._create('main','frm_main_chat','','','items');break;case'conference_view':this._create('main','frm_main_conference');break;case'nothing':default:this._create('main','frm_main_home');break;}}
if(gui.frm_main.main&&gui.frm_main.main.list&&(GWOthers.getItem('LAYOUT_SETTINGS','compact_view')==2)){gui.frm_main.main.list._original_height=25;}
if(this.main&&this.main._showsearch)
this.main._showsearch(aFolder,sView=='list_view'||sView=='list'||sView=='list_wide'||sView=='frm_main_mail'||sView=='frm_main_mail_wide'||sView=='frm_main_mail_list',sSearch);}
else{switch(sView){case'day_view':case'workweek_view':case'week_view':if(!oDate){oDate=new IcewarpDate();if(this.main.calendar._selection&&this.main.calendar._selection.startdate){oDate=new IcewarpDate(this.main.calendar._selection.startdate,{format:IcewarpDate.JULIAN});}else{var aRange=this.main.calendar._range();if(aRange['start']){oDate=new IcewarpDate(aRange['start'],{format:IcewarpDate.JULIAN});}}}}
if(this.main&&this.main._showsearch&&dataSet.get('active_folder')!=aFolder['aid']+'/'+aFolder['fid']){this.main._showsearch(aFolder,sView=='list'||sView=='list_view'||sView=='list_wide',sSearch);}}
if(bNewFolder){dataSet.add('active_folder','',aFolder['aid']+'/'+aFolder['fid'],bNoTreeUpdate);}
removecss(this._getAnchor('menu2'),'hidden');var bSelectFolder=true;switch(sView){case'nothing':case'home':break;case'conference_view':this.main._serverSort();if(dataSet.get('accounts',[sPrimaryAccount,'MEETING_PROVIDER'])!=='jitsi'){addcss(this._getAnchor('menu2'),'hidden');}
break;case'day_view':case'week_view':case'workweek_view':this.main._setDate(oDate,sView=='day_view'?1:7,sView=='workweek_view');this.main._serverSort(sView);break;case'chat_view':case'month_view':this.main._serverSort(sView);break;case'mail_view':case'mail_view_wide':case'list_view':case'list_wide':var aActiveMails=dataSet.get('active_items');if(!aActiveMails||!aActiveMails[aFolder['aid']]||!aActiveMails[aFolder['aid']][aFolder['fid']])
dataSet.remove('preview');if(this.main.list){this.main.list._serverSort(aFolder,aView['sort']['column'],aView['sort']['type'],[this,'__synchroDatasetHandler',[aFolder['aid'],aFolder['fid'],!!aFolder.elm]]);bSelectFolder=false;}
if(bNewFolder)
gui.__exeEvent('resize');break;default:if(this.main.list){this.main.list._serverSort(aFolder,aView['sort']['column'],aView['sort']['type'],[this,'__taskReminderBellIconTooltip']);bSelectFolder=false;}}
this._lastView=sView;if(bSelectFolder||aFolder.elm){gui.__exeEvent('folderSelected',aFolder);}
if(GWOthers.getItem('LAYOUT_SETTINGS','init_page')=='r'){Cookie.set(['last_folder'],aFolder['aid']+'/'+aFolder['fid']);}
return bNewFolder;};_me.__taskReminderBellIconTooltip=function(){var me=this;setTimeout(function(){if(!me.main.list){return;}
[].forEach.call(me.main.list._main.querySelectorAll('.col_TASK_STARTDATE, .col.reminder .reminder'),function(elm){if(!elm._mouseenter){elm.addEventListener('mouseenter',function(e){if(elm._mouseenter<2){var id=gui.frm_main.main.list._aData[e.target.getAttribute('id').split('/')[1]].arg;WMItems.list(id,'','','',[function(data){var reminders=data[id.aid][id.fid][id.iid].REMINDERS;for(var i in reminders){if(+reminders[i].values.RMNTIME){e.target&&e.target.setAttribute('title',IcewarpDate.unix(reminders[i].values.RMNTIME).format('DD/MM/YYYY HH:mm'));break;}else if(reminders[i].values.RMNMINUTESBEFORE){e.target&&e.target.setAttribute('title',frm_event2.prototype._reminderObjectToText(reminders[i]));break;}}}]);elm._mouseenter=2;}});elm._mouseenter=1;}});},50);};_me.__synchroDatasetHandler=function(sAccId,sFolId,bNoSelect)
{var sActiveItem=dataSet.get('active_items',[sAccId,sFolId]);var preselected=false;var aItems=dataSet.get('items',[sAccId,sFolId]);if(!sActiveItem){preselected=Object.keys(aItems).some(function(v){if(v.indexOf('*')===0){sActiveItem=v;return true;}});}
this.__taskReminderBellIconTooltip();if(sActiveItem){if(!aItems||!parseInt(aItems['/']||0)){dataSet.remove('active_items',[sAccId,sFolId]);dataSet.remove('preview');return;}
if(this.main.list){var v=this.main.list._value();if(!v.length||(aItems&&!aItems[v[0]])){this.main.list._value([sActiveItem],false,false,bNoSelect);}}
if(this.main.mailview){var keep_seen=dataSet.get('active_items',[sAccId,sFolId]);if(preselected){clearTimeout(this.__mark_as_read_timeout);this.__mark_as_read_timeout=setTimeout(function(){keep_seen&&dataSet.get('preview',[sAccId,sFolId,sActiveItem])&&dataSet.get('active_items',[sAccId,sFolId])==sActiveItem&&OldMessage.markAsRead([sAccId,sFolId,[sActiveItem]]);},5000);}
OldMessage.open([sAccId,sFolId,sActiveItem],!keep_seen);}
else
if(this.main.itemview){Item.open([sAccId,sFolId,sActiveItem]);}}};_me._acceptChangedIP=function(){if(!gui.reauth||gui.reauth._destructed)
gui._create('reauth','frm_reauth');};_me.__logout=function(bSkip){if(this._destructed)return;if(!bSkip){var aChild=gui._getChildObjects('','frm_compose');for(var i in aChild){if(!aChild[i].__logoutOnDestruct&&aChild[i]._onclose())
aChild[i]._destruct();else{aChild[i].__show();aChild[i].__logoutOnDestruct=true;return;}}}
if(this.im&&!this.im._destructed){this.im._destruct([this,'__logout',[true]]);return;}
this.__onDestruct();if(gui.connection)
gui.connection._destruct();if(window.Cookie)
window.clearInterval(window.Cookie._interval);var sURL=GWOthers.getItem('LAYOUT_SETTINGS','logout_url')||dataSet.get('main',['referrer_url'])||(document.location.protocol+'//'+document.location.hostname+(document.location.port?':'+document.location.port:'')+document.location.pathname);if(TeamChatAPI&&TeamChatAPI.teamChatOnly())
sURL+='?'+buildURL({tconly:1,token:TeamChatAPI.getToken(),notifyuri:TeamChatAPI.getNotifyURI()});auth.logout();dataSet.remove('main','',true);dataSet.remove('cookies','',true);dataSet.remove('accounts','',true);dataSet.remove('folders','',true);dataSet.remove('items','',true);dataSet.remove('preview','',true);dataSet.remove('active_items','',true);dataSet.remove('active_folder','',true);dataSet.remove('settings','',true);window.onbeforeunload=null;if(sURL&&!sURL.match(/^https?:\/\//)){sURL=document.location.protocol+'//'+sURL;}
document.location.replace(sURL);return;};_me.__showConferenceDialog=function(aid,fid,iid){if(aid&&fid&&iid&&WMFolders.getType([aid,fid])==='C'){WMItems.list({"aid":aid,"fid":fid,"iid":iid},'','','',[function(aData){var aValues=aData[aid];if(aValues&&(aValues=aValues[fid])&&(aValues=aValues[iid])){storage.library('wm_conference');wm_conference.create(function(conference){var email,emails=[];for(var i in aValues['LOCATIONS']){email=aValues['LOCATIONS'][i]['values']['LCTEMAIL1']||aValues['LOCATIONS'][i]['values']['LCTEMAIL2']||aValues['LOCATIONS'][i]['values']['LCTEMAIL3'];if(email)emails.push(email);}
if(emails.length)
conference.invite(emails);});}}]);}
else{storage.library('wm_conference');wm_conference.create(function(conference){conference.join();});}};_me.__showDialDialog=function(aid,fid,iid){if(aid&&fid&&iid&&WMFolders.getType([aid,fid])==='C'){WMItems.list({"aid":aid,"fid":fid,"iid":iid},'','','',[function(aData){var aValues=aData[aid];if(aValues&&(aValues=aValues[fid])&&(aValues=aValues[iid])){var aLocations=aValues['LOCATIONS'],v,nPhone,sName,aPhones={};for(var i in aLocations){if(aLocations[i]['values']['LCTTYPE']=='H'){if((v=aLocations[i].values)){for(var j in v)
if(v[j]&&j.indexOf('LCTPHN')==0){nPhone=v[j].trim();if(j=='LCTPHNOTHER'&&nPhone.indexOf('sip:')===0){nPhone=nPhone.substring(nPhone.indexOf(':')+1);sName=getLang('PHONE::SIP');}
else
sName=getLang('PHONE::'+j.toUpperCase(),'',2);aPhones[nPhone]=(sName?'['+sName+'] ':'')+nPhone;}
if(v.LCTEMAIL1)
aPhones[v.LCTEMAIL1]=v.LCTEMAIL1;if(v.LCTEMAIL2)
aPhones[v.LCTEMAIL2]=v.LCTEMAIL2;if(v.LCTEMAIL3)
aPhones[v.LCTEMAIL3]=v.LCTEMAIL3;}
break;}}
var c=count(aPhones);if(c){for(var sPhone in aPhones){if(c>1)
gui._create('im_phone','frm_confirm_select','','',[function(n){gui.frm_main._call(n);}],'MAIN_MENU::DIAL','DIAL::SELECT_CONTECT',null,aPhones,sPhone);else
gui.frm_main._call(sPhone);break;}}}}]);}};_me.__showSMSDialog=function(aid,fid,ids){if(ids&&WMFolders.getType([aid,fid])==='C'){var tmp=Is.Array(ids)?ids:[ids];for(var i in tmp)
tmp[i]=WMItems.__serverID(tmp[i]);var aFilter={search:"has:mobile AND items:"+tmp.join(' OR ')},aValues=['ITMCLASSIFYAS','LCTPHNMOBILE'];WMItems.list({'aid':aid,'fid':fid,'values':aValues,'filter':aFilter},'','','',[NewMessage.compose_sms]);}
else
NewMessage.compose_sms();};_me._pin_im=function(){var c=(Cookie.get(['hide_im'])||'').toString(),b=document.body.clientWidth<1350,v='';switch(c){case'1':v=b?'2':'';break;case'2':v=b?'':'1';break;default:v=b?'2':'1';}
Cookie.set(['hide_im'],v);gui.frm_main._rightDock(v=='2');};_me._pin_barmenu=function(){var c=(Cookie.get(['hide_tree'])||'').toString(),b=document.body.clientWidth<1100,v='';switch(c){case'1':v=b?'2':'';break;case'2':v=b?'':'1';break;default:v=b?'2':'1';}
Cookie.set(['hide_tree'],v);gui.frm_main._resize_handler();};_me.__addTeamchatFolderToRecent=function(sFolderPath){var aRecent=Cookie.get(['recent'])||[],sFolderAbsPath=sPrimaryAccount+'/'+sFolderPath,i;i=aRecent.indexOf(sFolderAbsPath);if(-1!==i){aRecent.splice(i,1);}
aRecent.unshift(sFolderAbsPath);Cookie.set(['recent'],aRecent);};_me.__newTeamchatRoomCallback=function(aData){var aFolders=dataSet.get('folders',[sPrimaryAccount]),sFolderId;if(sPrimaryAccountGUEST&&!Object.keys(aFolders).some(function(sFolder){return aFolders[sFolder].TYPE==='I';})){return gui._create("confirm","frm_alert","","",[function(){gui.frm_main.__logout();}],'MAIN_MENU::LOGOUT','ERROR::MISSING_TEAMCHAT');}
if(aData.ACTION=='add'){for(sFolderId in aFolders){if(aFolders.hasOwnProperty(sFolderId)&&aFolders[sFolderId].RELATIVE_PATH===Path.slash(aData.FOLDER)){this.__addTeamchatFolderToRecent(sFolderId);return;}}}
else
if(WMFolders.getType(Path.split(dataSet.get('active_folder')))==='X'){gui.frm_main._selectView();}};_me.__copyItem=function(aIds,aDest){var ids=[aIds[0].aid,aIds[0].fid,aIds.map(function(aId){return aId.id;})];Item.__copyOrMoveItems(aDest[0],aDest[1],'copy',ids);};

/* client/inc/frm_main_calendar.js */
_me=frm_main_calendar.prototype;function frm_main_calendar(){};_me.__constructor=function(sDataset){gui.frm_main._title();var me=this;this._hasWorkView=parseInt(GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins'))&&parseInt(GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends'));this.__sDataset=sDataset;dataSet.obey(this,null,sDataset);dataSet.remove('main_calendar');this.calendar._listen_data('main_calendar');this.calendar._onchange=function(aValues,bRefresh){me._onItemChange(1,aValues,false,bRefresh);};this.calendar._onactivate=function(aValues){gui.__exeEvent('itemSelected',[me.__aid,me.__fid].concat(aValues.length?aValues:[]));};this.calendar._onadd=function(aValues){me._onItemAdd(aValues);};this.calendar._onremove=function(id,shift_key){var oRepeating;if(Item.hasReccurence([me.__aid,me.__fid,id])){oRepeating=dataSet.get('items',[me.__aid,me.__fid,id]);}
Item.remove([me.__aid,me.__fid,[me._stripPipe(id)]],shift_key||false,oRepeating,this);};this.calendar._ondblclick=function(e,elm,arg){switch(arg._event){case'event':var oRepeating=dataSet.get('items',[me.__aid,me.__fid,arg['id']]);Item.open([me.__aid,me.__fid,me._stripPipe(arg['id'])],oRepeating);break;case'allday':case'blank':if(!this.__rights.write)
return;arg['enddate']=arg['startdate'];if(arg._event=='allday')
arg['enddate']++;var nStartTime=(arg['starttime']>=0)?arg['starttime']/60:-1;var nEndTime=(arg['starttime']>=0)?(arg['starttime']/60)+30:-1;if(arg._event=='blank'&&nEndTime==1440){nEndTime=0;arg['enddate']++;}
var aInterval={'EVNSTARTDATE':arg['startdate'],'EVNSTARTTIME':nStartTime,'EVNENDDATE':arg['enddate'],'EVNENDTIME':nEndTime};Item.openwindow([me.__aid,me.__fid],aInterval);break;}};this.calendar._oncontext=function(e,elm,arg){var aMenu='',cmenu;arg['aid']=me.__aid;arg['fid']=me.__fid;switch(arg._event){case'allday':case'blank':arg['enddate']=arg['startdate'];if(arg._event=='allday'){arg['enddate']++;}
var nStartTime=(arg['starttime']>=0)?arg['starttime']/60:-1,nEndTime=(arg['starttime']>=0)?(arg['starttime']/60)+30:-1,date=IcewarpDate.julian(arg['startdate']);aMenu=[{"title":'POPUP_ITEMS::NEW','arg':[Item.createInFolder,[arg['aid'],arg['fid'],{'EVNSTARTDATE':arg['startdate'],'EVNSTARTTIME':nStartTime,'EVNENDDATE':arg['enddate'],'EVNENDTIME':nEndTime}]],'disabled':!this.__rights.write}];break;case'selection':var nStartTime;if(arg['starttime']>=0){nStartTime=arg['starttime']/60;}else{nStartTime=-1;arg['enddate']++;}
var nEndTime=(arg['endtime']>=0)?arg['endtime']/60:-1;aMenu=[{"title":'POPUP_ITEMS::NEW','arg':[Item.createInFolder,[arg['aid'],arg['fid'],{'EVNSTARTDATE':arg['startdate'],'EVNSTARTTIME':nStartTime,'EVNENDDATE':arg['enddate'],'EVNENDTIME':nEndTime}]],'disabled':!this.__rights.write}];if(!Is.Empty(arg['contains'])){for(var i in arg['contains']){if(arg['contains'][i].indexOf('|')<0){aMenu.push({"title":'-'},{"title":'POPUP_ITEMS::DELETE_SELECTED','arg':[Item.remove,[[arg['aid'],arg['fid'],arg['contains']]]],'disabled':!this.__rights.remove});break;}}}
break;case'event':var origItem=me._stripPipe(arg['id']),id=[arg['aid'],arg['fid'],origItem],ids=[arg['aid'],arg['fid'],[origItem]];if(Item.hasReccurence([arg['aid'],arg['fid'],arg['id']])){var oRepeating=dataSet.get('items',[arg['aid'],arg['fid'],arg['id']]);}
var itmRights={'read':true,'write':true,'modify':true,'remove':true,'owner':true};if(arg.owner!=sPrimaryAccountGWID){itmRights=this.__rights;}
cmenu=gui._create("cmenu","obj_context_item");aMenu=cmenu.__createGWMenu(id,ids,'E',false,oRepeating,itmRights);var nStartTime=(arg['starttime']>=0)?arg['starttime']/60:-1,nEndTime=(arg['starttime']>=0)?(arg['starttime']/60)+30:-1;for(var i in aMenu){if(aMenu[i].title=='MAIN_MENU::NEW'){aMenu[i].arg=[Item.createInFolder,[arg['aid'],arg['fid'],{'EVNSTARTDATE':arg['startdate'],'EVNSTARTTIME':nStartTime,'EVNENDDATE':arg['enddate'],'EVNENDTIME':nEndTime}]];break;}}
break;}
if(aMenu){if(arg._event!='event'){aMenu.push({"title":'-'},{"title":'MAIN_MENU::DAY_VIEW','arg':[gui.frm_main,'_selectView',[{aid:me.__aid,fid:me.__fid},'day_view',true,date]]},{"title":'MAIN_MENU::WEEK_VIEW','arg':[gui.frm_main,'_selectView',[{aid:me.__aid,fid:me.__fid},'week_view',true,date]]});if(me._hasWorkView){aMenu.push({"title":'MAIN_MENU::WORKWEEK_VIEW','arg':[gui.frm_main,'_selectView',[{aid:me.__aid,fid:me.__fid},'workweek_view',true,date]]});}
aMenu.push({"title":'MAIN_MENU::MONTH_VIEW','arg':[gui.frm_main,'_selectView',[{aid:me.__aid,fid:me.__fid},'month_view',true,date]]},{"title":'MAIN_MENU::EVENTS_LIST','arg':[gui.frm_main,'_selectView',[{aid:me.__aid,fid:me.__fid},'list_view',true]]});}
if(!cmenu){cmenu=gui._create("cmenu","obj_context_item");}
cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);}else{cmenu._destruct();}};};_me._showsearch=function(aFolder,bFocus){if(aFolder){gui.frm_main.search._setFolder(aFolder);gui.frm_main.search._deactivate();gui.frm_main.search._onsearch=function(v){gui.frm_main._selectView(aFolder,'list_view',true,'','',this._value());};gui.frm_main.search._focus(bFocus);}};_me._print=function(bCalendar){this.__getFolder();var range=this.calendar._range();if(bCalendar&&this.calendar){var frame=mkElement('iframe',{style:{left:'-500px',top:0,height:'1px',width:'1px',position:'absolute',zIndex:0}});document.body.appendChild(frame);var doc=frame.contentDocument||frame.contentWindow.document,html="<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Strict//EN\"\n\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd\">"+'<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">'+"\n<head>\n"+'<meta http-equiv="x-dns-prefetch-control" content="off" />'+'<base href="'+document.location.protocol+'//'+document.location.hostname+(document.location.port?':'+document.location.port:'')+document.location.pathname+'" />'+"\n</head>\n<body></body>\n</html>";doc.open('text/html','replace');doc.write(html);doc.getElementsByTagName('head')[0].appendChild(mkElement('link',{type:"text/css",rel:"stylesheet",href:"client/skins/index.css"},doc));doc.getElementsByTagName('head')[0].appendChild(mkElement('link',{type:"text/css",rel:"stylesheet",href:'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'style.css'})},doc));doc.getElementsByTagName('head')[0].appendChild(mkElement('link',{type:"text/css",rel:"stylesheet",href:'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'print_calendar.css'})},doc));var header=mkElement('div',{className:'print_calendar'},doc);var dstr=IcewarpDate.julian(range.start).format('L');if(range.start<range.end){dstr+=' - '+IcewarpDate.julian(range.end).format('L');}
var cal=false;if(this.__aid==sPrimaryAccount&&this.__fid=='__@@VIRTUAL@@__/__@@EVENTS@@__'){cal=[];var cf=dataSet.get('folders',[this.__aid,this.__fid,'VIRTUAL','FOLDERS']);if(cf){for(var i in cf){cal.push({name:i,color:getCalendarColor(i.str_replace('\\','/'))});}}}
header.innerHTML=template.tmp('print_calendar',{date:dstr,calendars:cal});doc.body.appendChild(header);var tree=this.calendar._main.cloneNode(true);if(hascss(tree,'day')||hascss(tree,'week')){var top=GWOthers.getItem('CALENDAR_SETTINGS','day_begins')||9;var bottom=GWOthers.getItem('CALENDAR_SETTINGS','day_ends')||15;var events=tree.getElementsByClassName('obj_evnviewevn');var original_events=this.calendar._main.getElementsByClassName('obj_evnviewevn');var times=tree.getElementsByClassName('tline');var i=events.length;while(i--){var day=original_events[i];if(day){var y=parseInt(day.offsetTop);var t=Math.floor(y/52);var b=Math.ceil((y+parseInt(day.style.height))/52);top=Math.min(top,t);bottom=Math.max(bottom,b);}}
top=Math.floor(top);var i=events.length;while(i--){var day=events[i];if(day){day.style.top=parseInt(day.style.top)-top*52+'px';}}
var h=(bottom-top)*52;tree.getElementsByClassName('obj_evnview_main')[0].style.height=h+'px';tree.style.height='auto';while(times[0]&&times[0].hasChildNodes()&&times[0].children[bottom]){times[0].removeChild(times[0].children[bottom]);}
while(times[0]&&top--){times[0].removeChild(times[0].children[0]);}
times[0].parentNode.removeChild(tree.getElementsByClassName('time1')[0]);times[0].parentNode.removeChild(tree.getElementsByClassName('time2')[0]);}
var add=tree.querySelector('.obj_evnviewblock');add&&add.parentNode.removeChild(add);doc.body.appendChild(tree);doc.body.onload=function(){frame.contentWindow.focus();if(frame.contentWindow.document.queryCommandSupported('print')){frame.contentWindow.document.execCommand('print',false,null);}else{frame.contentWindow.print();}
setTimeout(function(){},1000);};doc.close();}
else{var aValues=['EVNTITLE','EVNLOCATION','EVNSTARTDATE','EVNSTARTTIME','EVNENDDATE','EVNENDTIME','EVNRCR_ID','EVNCLASS','EVNTYPE','EVNNOTE'];WMItems.list({"aid":this.__aid,"fid":this.__fid,"values":aValues,"filter":{'interval':range['start']+'-'+range['end']}},'','','',[this,'__print']);}};_me.__print=function(aData){var tmp=[];for(var i in aData)
for(var j in aData[i]){for(var k in aData[i][j])
if(typeof aData[i][j][k]=='object'&&(aData[i][j][k].EVNCLASS=='E'||aData[i][j][k].EVNCLASS=='O')){if(aData[i][j][k].EVNSTARTDATE>0){if(aData[i][j][k].EVNSTARTTIME>0){aData[i][j][k].COUNT_DATE=IcewarpDate.julian(aData[i][j][k].EVNSTARTDATE).setTime(aData[i][j][k].EVNSTARTTIME,true).format('L LT');}else{aData[i][j][k].COUNT_DATE=IcewarpDate.julian(aData[i][j][k].EVNSTARTDATE).setTime(0,true).format('L');}
if(aData[i][j][k].EVNENDTIME>0){aData[i][j][k].COUNT_DATE+=' - '+IcewarpDate.julian(aData[i][j][k].EVNSTARTDATE).setTime(aData[i][j][k].EVNENDTIME,true).format('L LT');}else{aData[i][j][k].COUNT_DATE+=' - '+IcewarpDate.julian(aData[i][j][k].EVNENDDATE).setTime(0,true).format('L');}}else
aData[i][j][k].COUNT_DATE='';tmp.push(aData[i][j][k]);}
tmp=tmp.sort(function(a,b){var x=a['EVNSTARTDATE']-b['EVNSTARTDATE'];if(x==0)
x=(a['EVNSTARTTIME']-b['EVNSTARTTIME']);if(x==0)
x=a['EVNENDDATE']-b['EVNENDDATE'];if(x==0)
x=(a['EVNENDTIME']-b['EVNENDTIME']);return x;});for(var i=0;i<tmp.length;i++)
(gui.print||gui._create('print','frm_print'))._add('E',tmp[i]);return;}};_me.__update=function()
{if(Is.Defined(this.calendar)){this.calendar._rights(WMFolders.getAccess({'aid':this.__aid,'fid':this.__fid}));this.__refresh();}};_me._serverSort=function(sView)
{this.__getFolder();var range=this.calendar._range();if(!Is.Defined(range['start'])){this.calendar._rights(WMFolders.getAccess({'aid':this.__aid,'fid':this.__fid}));return;}
var aValues=WMItems.default_values('EI');WMItems.list({"aid":this.__aid,"fid":this.__fid,"values":aValues,"filter":{'interval':range['start']+'-'+range['end']}},'items');if(!this.calendar_view){this._create("calendar_view","obj_hmenu_calendar_view",'change_view');}
this.calendar_view.__menu({aid:this.__aid,fid:this.__fid});};_me._onItemAdd=function(aValues){var aResultValues={'EVNTITLE':aValues.title,'EVNSHARETYPE':GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','event_sharing'),'EVNFLAGS':{F:4,T:8,O:16,S:0}[GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','event_show_as')]||0};if(aValues.starttime<0){aResultValues['EVNSTARTTIME']=-1;aResultValues['EVNENDTIME']=-1;aResultValues['EVNSTARTDATE']=aValues.startdate;aResultValues['EVNENDDATE']=aValues.enddate;aResultValues['EVNTIMEFORMAT']='F';}else{aResultValues['_TZEVNSTARTTIME']=aValues.starttime/60;aResultValues['_TZEVNENDTIME']=aValues.endtime/60;aResultValues['_TZEVNSTARTDATE']=aValues.startdate;aResultValues['_TZEVNENDDATE']=aValues.enddate;aResultValues['_TZID']=GWOthers.getItem('CALENDAR_SETTINGS','timezone');aResultValues['EVNTIMEFORMAT']='Z';}
aResultValues={values:aResultValues};if(this.__aid==sPrimaryAccount){var fid=this.__fid;if(fid=='__@@VIRTUAL@@__/__@@EVENTS@@__'){var aCalendars=dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS']);for(var i in aCalendars)
if(aCalendars[i]){fid=i;break;}}
if(fid.indexOf(dataSet.get('main',['resources_path'])+'/')==0){aResultValues.values.EVNFLAGS|=1;aResultValues['CONTACTS']=[{values:{CNTEMAIL:sPrimaryAccount,CNTROLE:'Q'}}];}}
if(aResultValues.values.EVNSTARTTIME<0)
aResultValues.values.EVNENDDATE++;var aReminderDefault=GWOthers.get('EVENT_SETTINGS','storage');if(aReminderDefault&&(aReminderDefault=aReminderDefault['VALUES'])&&aReminderDefault.default_reminder=='1'){var time=aReminderDefault.time,days=0,hours=0,minutes=0;if(time>0){var days=Math.floor(time/86400000);time%=86400000;var hours=Math.floor(time/3600000);time%=3600000;var minutes=Math.floor(time/60000);}
aResultValues.REMINDERS=[{values:{RMNDAYSBEFORE:days,RMNHOURSBEFORE:hours,RMNMINUTESBEFORE:minutes}}];}
WMItems.add([this.__aid,this.__fid],aResultValues,'dummy','','',[this,'__addEventHandler',[this.__aid,this.__fid,true]]);};_me._onItemChange=function(nEditType,aValues,bIgnoreRepeating,bRefresh){var sAccId=this.__aid;var sFolId=this.__fid;var sItId=aValues['id']?this._stripPipe(aValues['id']):'';var bRepeats=sItId?Item.hasReccurence([sAccId,sFolId,aValues['id']]):false;if(bRepeats){nEditType=0;}
var nStartTime=(aValues['starttime']>=0)?aValues['starttime']/60:-1;var nEndTime=(aValues['endtime']>=0)?aValues['endtime']/60:-1;var aResultValues={'EVNSTARTTIME':nStartTime,'EVNENDTIME':nEndTime};if(Is.Defined(aValues['evntimeformat'])){aResultValues.EVNTIMEFORMAT=aValues['evntimeformat'];}
if(Is.Defined(aValues['title'])&&aValues['title']){aResultValues.EVNTITLE=aValues['title'];}
switch(nEditType.toString()){case'2':if(bRepeats)
aResultValues['EXPFOLLOWING']='true';case'0':if(bRepeats){var oRepeating=dataSet.get('items',[sAccId,sFolId,aValues['id']]);aResultValues['EXPDATE']=oRepeating['EVNSTARTDATE'];aResultValues['EVNSTARTDATE']=aValues['startdate'];aResultValues['EVNENDDATE']=(nStartTime>=0)?aValues['enddate']:aValues['enddate']+1;break;}
default:if(!bRepeats||sItId==aValues['id']){aResultValues['EVNSTARTDATE']=aValues['startdate'];aResultValues['EVNENDDATE']=(nStartTime>=0)?aValues['enddate']:aValues['enddate']+1;}else{var oRepeating1=dataSet.get('items',[sAccId,sFolId,aValues['id']]);aResultValues['EVNSTARTDATE']=parseInt(aValues.osd)+parseInt(aValues.startdate)-parseInt(oRepeating1.EVNSTARTDATE);aResultValues['EVNENDDATE']=parseInt(aValues.oed)+parseInt(aValues.enddate)-parseInt(oRepeating1.EVNENDDATE);}}
WMItems.add([sAccId,sFolId,sItId],{"values":aResultValues},'dummy','','',[this,'__addEventHandler',[sAccId,sFolId,bRepeats,bRefresh]]);};_me._stripPipe=function(s){return s.split('|')[0];};_me._createEvent=function()
{var aSelection=clone(this.calendar._selection);if(!Is.Empty(aSelection)){var nStartTime;if(aSelection['starttime']>=0)
nStartTime=aSelection['starttime']/60;else{nStartTime=-1;aSelection['enddate']++;}
var nEndTime=(aSelection['endtime']>=0)?aSelection['endtime']/60:-1;var aInterval={'EVNSTARTDATE':aSelection['startdate'],'EVNSTARTTIME':nStartTime,'EVNENDDATE':aSelection['enddate'],'EVNENDTIME':nEndTime};Item.openwindow([this.__aid,this.__fid],aInterval);}else{Item.openwindow([this.__aid,this.__fid],getActualEventTime());}};_me._getDate=function(){var aSelection=this.calendar._selection;if(aSelection&&aSelection.startdate){var date=new IcewarpDate(aSelection.startdate,{format:IcewarpDate.JULIAN});return date;}else{return(this.__date)?this.__date:new IcewarpDate();}};_me.__onServerResponse=function(sAccId,sFolId,nStart,nEnd)
{if(!Is.Defined(this.calendar))
return;var aRange=this.calendar._range();if(this.__aid==sAccId&&this.__fid==sFolId&&aRange['start']==nStart&&aRange['end']==nEnd)
this.__refresh();};_me.__refresh=function(){var aValues=dataSet.get('items',[this.__aid,this.__fid]),aFillData=[];for(var i in aValues){if(i==='/'||i==='#'||i==='$'||i==='@'){continue;}
try{aFillData.push({'starttime':(aValues[i]['EVNSTARTTIME']>=0)?aValues[i]['EVNSTARTTIME']*60:-1,'endtime':(aValues[i]['EVNENDTIME']>=0)?aValues[i]['EVNENDTIME']*60:-1,'startdate':aValues[i]['EVNSTARTDATE'],'enddate':parseInt(aValues[i]['EVNENDDATE'],10)+(aValues[i]['EVNSTARTTIME']<0?-1:0),'evntimeformat':aValues[i]['EVNTIMEFORMAT'],'evnflags':aValues[i]['EVNFLAGS'],'title':aValues[i]['EVNTITLE'],'conferenceid':aValues[i]['EVNMEETINGID']?parseInt(aValues[i]['EVNMEETINGID']):undefined,'osd':aValues[i]['OSD'],'oed':aValues[i]['OED'],'evnrcr_id':aValues[i]['EVNRCR_ID'],'rmnevn_id':aValues[i]['RMNEVN_ID'],'evnclass':aValues[i]['EVNCLASS'],'evntype':aValues[i]['EVNTYPE'],'evnsharetype':aValues[i]['EVNSHARETYPE'],'location':aValues[i]['EVNLOCATION'],'owner':aValues[i]['EVNOWN_ID'],'evnfolder':aValues[i]['EVNFOLDER'],'evnowneremail':aValues[i]['EVNOWNEREMAIL'],'fcolor':(this.__aid==sPrimaryAccount&&this.__fid=='__@@VIRTUAL@@__/__@@EVENTS@@__'&&aValues[i]['EVNFOLDER']?getCalendarColor(Path.slash(aValues[i]['EVNFOLDER'])):''),'id':i});}catch(e){console.log(e);}}
dataSet.add('main_calendar','',aFillData,true);dataSet.update('main_calendar');};_me.__addEventHandler=function(bOk,sAccId,sFolId,bRec,bRefresh){if(bOk==false){this.__update();}
if(bRec||bRefresh){this._serverSort();}};_me.__getStartDay=function(){storage.library('gw_others');var aCalendarSettings=(new gw_others).get('CALENDAR_SETTINGS','storage')['VALUES'];if(aCalendarSettings['begin_on_today']!='0'){return(new IcewarpDate()).day();}else{if(Is.Defined(aCalendarSettings['week_begins'])){var aDays={'sunday':0,'monday':1,'tuesday':2,'wednesday':3,'thursday':4,'friday':5,'saturday':6};return aDays[aCalendarSettings['week_begins']];}else{return 0;}}};_me.__getWorkingHours=function(){storage.library('gw_others');var sTime={};sTime['start']=GWOthers.getItem('CALENDAR_SETTINGS','day_begins');sTime['end']=GWOthers.getItem('CALENDAR_SETTINGS','day_ends');return sTime;};_me.__getFolder=function(){var path=Path.split(dataSet.get('current_folder'),true);this.__aid=path.aid;this.__fid=path.fid;};

/* client/inc/frm_main_calendar_dayweek.js */
_me=frm_main_calendar_dayweek.prototype;function frm_main_calendar_dayweek(){};_me.__constructor=function(){var me=this;this.__step=0;var wwbegin=parseInt(GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins'));var wwends=parseInt(GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends'));if(wwbegin&&wwends){this.__workweeklength=wwbegin>wwends?8-wwbegin+wwends:wwends-wwbegin+1;this.__workweekstarts=(new IcewarpDate()).day(wwbegin).weekday();}
this._create('inp_calendar','obj_input_calendar','slot1','noborder bold','',true,{week:true});this.inp_calendar._ondateselect=function(){if(this._value()!=me.__date.format(IcewarpDate.JULIAN)){me._setDate((new IcewarpDate(this._value(),{format:IcewarpDate.JULIAN})),me.__step,me.__workweek);me._serverSort();}};this.previous._onclick=function(){var range=me.calendar._range();var dStart=range['start']-(me.__workweek?7:me.__step);me.calendar._range(dStart,range['end']-(me.__workweek?7:me.__step));me._setDate(IcewarpDate.julian(dStart),me.__step,me.__workweek);me._serverSort();};this.next._onclick=function(){var range=me.calendar._range();var dStart=range['start']+(me.__workweek?7:me.__step);me.calendar._range(dStart,range['end']+(me.__workweek?7:me.__step));me._setDate(IcewarpDate.julian(dStart),me.__step,me.__workweek);me._serverSort();};this.today._onclick=function(){me._setDate(new IcewarpDate(),me.__step,me.__workweek);me._serverSort();};this._main.querySelector('.frmtbl tr').appendChild(mkElement('td',{class:"alternative_calendar"}));};_me._updateLabel=function(juldate){var oDate=new IcewarpDate(juldate,{format:IcewarpDate.JULIAN});if(this.inp_calendar){this.inp_calendar._value(juldate);}else{this.inp_month._value(oDate.month(),true);this.inp_year._value(oDate.year(),true);}};_me._setDate=function(date,iStep,bWork){this.__step=iStep||this.__step;this.__date=date||new IcewarpDate();var hours=this.__getWorkingHours();var julianDate=this.__date.format(IcewarpDate.JULIAN);this.__workweek=bWork||false;if(this.__step>1){if(bWork){this.__step=this.__workweeklength;}
if(GWOthers.getItem('CALENDAR_SETTINGS','begin_on_today')!='0'){IcewarpDate.Locale.setCustomWeekStart((new IcewarpDate()).day());IcewarpDate.Locale.chooseLocale(GWOthers.getItem('LAYOUT_SETTINGS','language'));}
bWork?this.__date.weekday(this.__workweekstarts%7):this.__date.weekday(0);julianDate=this.__date.format(IcewarpDate.JULIAN);this.today._value('CALENDAR::THIS_WEEK');}else{this.today._value('CALENDAR::TODAY');}
this._updateLabel(julianDate);this.calendar._range(julianDate,julianDate+this.__step-1,hours['start'],hours['end']);};

/* client/inc/frm_main_calendar_month.js */
_me=frm_main_calendar_month.prototype;function frm_main_calendar_month(){};_me.__constructor=function(sDataset,_date){this.__date=new IcewarpDate(_date);var me=this;this._main.querySelector('.frmtbl tr').appendChild(mkElement('td',{class:"alternative_calendar"}));this.inp_month._ondateselect=function(){if(this._value()!=me.__date.format(IcewarpDate.JULIAN)){var d=this._getObjectDate();me.__date.month(d.month());me.__date.year(d.year());me._updateLabel();}};this.previous._onclick=function(){me.__date.subtract(1,'month');me._updateLabel();};this.next._onclick=function(){me.__date.add(1,'month');me._updateLabel();};this.today._onclick=function(){me.__date=new IcewarpDate();me._updateLabel();};this._updateLabel(true);};_me._updateLabel=function(bSkip){this.inp_month._value(this.__date,true);this.calendar._range(this.__date.format(IcewarpDate.JULIAN));if(!bSkip)
this._serverSort();};

/* client/inc/frm_main_chat.js */
_me=frm_main_chat.prototype;function frm_main_chat(){};_me.__constructor=function(sDataset){gui.frm_main._title();var me=this;this.__sDataset=sDataset;this.__updateTab={};this._draw('frm_main_chat','main',{guest_user:sPrimaryAccountGUEST});this._add_destructor('__pushOfflineStatus');msiebox(this._getAnchor('msiebox'));this._create('upload','obj_upload');this.upload._onuploadstart=function(){me.text._create('info','obj_upload_info','block');addcss(me.text._main,'block');me.__upload_buffer=[];me.upload.__aid=me.__aid;me.upload.__fid=me.__fid;};this.upload._onuploadend=function(){removecss(me.text._main,'block');me.text.info&&me.text.info._destruct();if(me.__upload_buffer.length){if(me.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',me.__upload_buffer[0].description,'',{aid:me.upload.__aid||me.__aid,fid:me.upload.__fid||me.__fid},[function(sName,sDesc,aArg){me.__upload_buffer[0].description=sName;me.__uploadhandler(me.__upload_buffer,sName,sDesc,aArg);}.bind(me)]);}
else
me.__uploadhandler(me.__upload_buffer,'','','');}};this.upload._onuploadsuccess=function(file){me.text.info&&me.text.info._handler(null);me.__upload_buffer.push({'class':'file','description':file.name,'size':file.size,'fullpath':file.folder+'/'+file.id});};this.upload._onuploadprogress=function(file,a,b,xhr){me.text.info&&me.text.info._value(file.name,a,b,[function(){xhr.abort()}]);};this.upload._dropzone(this._main,function(){return template.tmp('dropzone',{title:getLang('CHAT::DROP_TITLE',[dataSet.get('folders',[me.__aid,me.__fid]).NAME||dataSet.get('folders',[me.__aid,me.__fid]).RELATIVE_PATH]),body:getLang('CHAT::DROP_BODY')});},'item');this.upload._ondropzone=function(){return!me.comment;};this.__input_menu_handlers={word:[this,'_word'],excel:[this,'_excel'],ppoint:[this,'_ppoint'],code:[this,'_code'],attach:[this,'_attachFile'],event:[this,'_addEvent'],conference:(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))?void 0:[this,'_addConference'],invite:[this,'_addMember'],email:(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))?void 0:[this,'_addEmail']};this._create("text","obj_chat_input","text","",{guest:!sPrimaryAccountGUEST,parseurl:true,block:true,smiles_enabled:GWOthers.getItem('CHAT','smiles')=='1',handlers:this.__input_menu_handlers,memory:{set:[function(val){dataSet.add('teamchat',[me.__fid,'input'],val,true);}],get:[function(){return dataSet.get('teamchat',[me.__fid,'input'])||'';}]}});this.text.input._placeholder(getLang('IM::MESSAGE_PH'));this.text._onsubmit=function(v,arg){if(v.length||(arg&&arg.url)){if(!!~v.toLowerCase().indexOf('/giphy ')){storage.library('giphy');return Giphy.translateFromInput(v);}
me._message(v,arg,this.__private);}else{return false;}};this.text._onpasteimage=function(aFiles){me.upload.file.__ondropfile(aFiles);};this.text._focus();this._keyupListener();this._init_tabs();if(gui.socket){gui._obeyEvent('blur',[this,'__pushBackgroundStatus']);}};_me.__pushBackgroundStatus=function(){gui.socket&&WMFolders.getType([this.__aid,this.__fid])==='I'&&gui.socket.api._pushGroupChatStatus(obj_groupchat._BACKGROUND);};_me.__pushOfflineStatus=function(){gui.socket&&WMFolders.getType([this.__aid,this.__fid])==='I'&&gui.socket.api._pushGroupChatStatus(obj_groupchat._OFFLINE);gui._disobeyEvent('blur',[this,'__pushBackgroundStatus']);};_me._keyupListener=function(){this.text.input._obeyEvent('onkeyup',[this,'__keyupHandler']);};_me.__keyupHandler=function(){if(this.timer){clearTimeout(this.timer);}else{gui.socket.api._pushGroupChatStatus(obj_groupchat._TYPING);}
this.timer=setTimeout(function(){gui.socket.api._pushGroupChatStatus(obj_groupchat._ONLINE);this.timer=false;}.bind(this),1000);};_me.__uploadhandler=function(aBuffer,sName,sDesc,aArg,comevnid){if(aBuffer&&aBuffer.length){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNCLASS='F';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();if(comevnid)
aItemInfo.values.EVNCOMEVNID=comevnid;if(aBuffer.length==1){aItemInfo['values']['EVNRID']=aItemInfo['values']['EVNLOCATION']=aItemInfo['values']['EVNTITLE']=sName||aBuffer[0].name;aItemInfo['values']['EVNCOMPLETE']=aBuffer[0].size;if(Is.String(sDesc)&&sDesc.length){aItemInfo['values']['EVNNOTE']=sDesc;aItemInfo['values']['EVNDESCFORMAT']='text/plain';}}
for(var i=0,j=aBuffer.length;i<j;i++)
aItemInfo['ATTACHMENTS'].push({values:aBuffer[i]});WMItems.add([this.upload.__aid||this.__aid,this.upload.__fid||this.__fid],aItemInfo,'','','',[function(bOK,aData){if(bOK){(Array.isArray(aData)?aData:[aData]).forEach(function(aData){this.tabs.room.list._fire(aData.id,'add',{'ITEM-TYPE':'R'});},this);if(aArg)
for(var m in aArg.mentions)
if(m==sPrimaryAccount&&this.tabs.room.list){data.forEach(function(aData){this.tabs.room.list._fire(aData.id,'add_mention',{'ITEM-TYPE':'I'},true);},this);break;}}}.bind(this)]);}};_me._init_tabs=function(){var me=this;this.tabs._onchange=function(sTab){if(sTab){if(this[sTab].list&&this[sTab].list&&this[sTab].list._search&&GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'){gui.frm_main.search._value(gui.frm_main.search._value(),true);}else
gui.frm_main.search._deactivate();}
var op=[],hints=[];switch(sTab){case'files':hints=['title:','before:','after:','smaller:','greater:'];op=[['title:',getLang('SEARCH_HINTS::TITLE')],['after:',getLang('SEARCH_HINTS::AFTER_F')],['before:',getLang('SEARCH_HINTS::BEFORE_F')],['smaller:',getLang('SEARCH_HINTS::SMALLER')],['greater:',getLang('SEARCH_HINTS::GREATER')]];break;case'events':hints=['title:'];op=[['title:',getLang('SEARCH_HINTS::TITLE')],['description:',getLang('SEARCH_HINTS::DESCRIPTION')],['after:',getLang('SEARCH_HINTS::AFTER_E')],['before:',getLang('SEARCH_HINTS::BEFORE_E')],['location:',getLang('SEARCH_HINTS::LOCATION')],['is:free',getLang('SEARCH_HINTS::ISFREE')],['is:busy',getLang('SEARCH_HINTS::ISBUSY')]];break;case'members':hints=['name:'];op=[['name:',getLang('SEARCH_HINTS::NAME')],['email:',getLang('SEARCH_HINTS::EMAIL')]];break;default:gui.frm_main.search._setFolder({aid:me.__aid,fid:me.__fid});return;}
gui.frm_main.search.search.__operators=op;gui.frm_main.search.search.__hints=hints;};this.tabs.room._onclick=function(e,elm){if(this.tabs&&this._parent._parent._main.offsetWidth<1100&&!this.tabs._main.contains(elm)){var t=this.tabs._value();if(t){this.tabs[t]&&this.tabs[t].__deactive(true);this.tabs._value('');}}};this.__global_context_menu=function(e){this.cmenu&&this.cmenu._destruct();if(e.target!==this._getAnchor('main')){return false;}
e.cancelBubble=true;e.preventDefault();if(e.stopPropagation)
e.stopPropagation();var aMenu=[];if(me.__input_menu_handlers['word']||me.__input_menu_handlers['excel']||me.__input_menu_handlers['ppoint']||me.__input_menu_handlers['note']){aMenu.push({'title':'CHAT::CREATE_NEW_DOCUMENT',css:'ico2 file',nodes:[me.__input_menu_handlers['word']?{'title':'main_menu::new_word','arg':{'method':'word'},css:'ico2 word'}:false,me.__input_menu_handlers['excel']?{'title':'main_menu::new_excel','arg':{'method':'excel'},css:'ico2 excel'}:false,me.__input_menu_handlers['ppoint']?{'title':'main_menu::new_ppoint','arg':{'method':'ppoint'},css:'ico2 ppoint'}:false,me.__input_menu_handlers['note']?{'title':'main_menu::new_note','arg':{'method':'note'},css:'ico2 note'}:false].filter(Boolean)});}
if(me.__input_menu_handlers['attach']){aMenu.push({'title':'CHAT::SHARE_FILE_OR_DOCUMENT','arg':{'method':'attach'},css:'ico2 attach'});}
if(me.__input_menu_handlers['code']){aMenu.push({'title':'INSERT_CODE::TITLE','arg':{'method':'code'},css:'ico2 code'});}
if(me.__input_menu_handlers['conference']){aMenu.push({'title':'CHAT::NEW_CONFERENCE','arg':{'method':'conference'},css:'ico2 conference',disabled:!sPrimaryAccountCONFERENCE});}
if(me.__input_menu_handlers['event'])
aMenu.push({'title':'IM::NEW_EVENT','arg':{'method':'event'},css:'ico2 event'});if(me.__input_menu_handlers['email'])
aMenu.push({'title':'CHAT::NEW_EMAIL','arg':{'method':'email'},css:'ico2 email'});if(me.__input_menu_handlers['geo'])
aMenu.push({'title':'IM::GEO','arg':{'method':'geo'},css:'ico2 geo',disabled:!("geolocation"in navigator)||!GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')});addcss(this._main,'color1');this.cmenu=gui._create("cmenu","obj_context",'','obj_chat_input_add',this);this.cmenu._fill(aMenu);this.cmenu._place(e.clientX,e.clientY,null,2);var btn=this;this.cmenu._obeyEvent('destructed',[function(){removecss(btn._main,'color1');}]);this.cmenu._onclick=function(e,elm,id,arg){if(arg.method&&me.__input_menu_handlers&&me.__input_menu_handlers[arg.method])
executeCallbackFunction(me.__input_menu_handlers[arg.method]);else
executeCallbackFunction(arg);};}
this._create('toolbar','obj_chat_toolbar');this.tabs.room.list._onclick=function(e,elm){var id;if(hascss(elm,'mailto')){var email=elm.getAttribute('rel');if(email)
Item.sendEmailTo(email);}
else
if(elm.tagName=='SPAN'){if(hascss(elm,'mention')&&(id=elm.getAttribute('rel'))){var addr=MailAddress.splitEmailsAndNames(id);if((addr=addr[0])&&addr.email){me.text.input._addMention(addr);}}
else{if(hascss(elm,'private_msg')){var sMail=elm.getAttribute('rel');if(sMail){var addr=MailAddress.splitEmailsAndNames(sMail.urlDecode());if(addr&&addr[0]){this.__options.autoscroll=false;var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',addr[0].name,addr[0].email);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));cmenu._onclose=function(){this.__options.autoscroll=true;return true;}.bind(this);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}}}
else
if(hascss(elm,'show_gpins')){me.panel._value('pins');me.panel.pins.btn_switch._value(1);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}}}
else
if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();NewMessage.compose({to:elm.pathname});return false;}};this.tabs.room.list._onresponse=function(aPath,aAttr){if(!this._destructed&&this.__aid==aPath.aid&&this.__fid==aPath.fid){if(aAttr&&Is.Defined(aAttr.LAST_PINNED_ITEM)){this.__lastPin={aid:this.__aid,fid:this.__fid,time:parseInt(aAttr.LAST_PINNED_ITEM||0)};if(parseInt(Cookie.get(['folders',this.__aid,this.__fid,'gpin'])||0)<parseInt(aAttr.LAST_PINNED_ITEM||0)){if(this.panel&&this.panel._value()=='pins'&&this.panel.pins.btn_switch._value()=='1')
Cookie.set(['folders',this.__aid,this.__aid,'gpin'],aAttr.LAST_PINNED_ITEM);else
addcss(this._main,'gpin');return;}}
removecss(this._main,'gpin');}}.bind(this);this.tabs.room.list._oncontext=function(e,eTarget){var id,aData,elm;if((elm=Is.Child(eTarget,'SECTION',this._main))&&(id=elm.getAttribute('rel'))&&this.__aData[id]&&this.__aData[id].obj){if(eTarget.tagName=='A'&&eTarget.protocol==='mailto:'){e.preventDefault();e.stopPropagation();var pos=getSize(eTarget),cmenu=gui._create('cmenu','obj_context_link','','','',eTarget.pathname);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));return false;}
if(window.getSelection){var sel=window.getSelection();if(!sel.isCollapsed&&sel.rangeCount)
for(var range,i=0;i<sel.rangeCount;i++){range=sel.getRangeAt(i);if(!range.isCollapsed&&Is.Child(range.commonAncestorContainer||range.startContainer,this._main))
return true;}}
aData=this.__aData[id].obj.__aData;if(aData.EVNCOMEVNID&&this.__aData[id].obj.item){if(Is.Child(eTarget,this.__aData[id].obj.item._main.parentElement,this._main)){elm=this.__aData[id].obj.item._main.parentElement;aData=this.__aData[id].obj.item.__aData;}}
addcss(elm,'active2');var arr=[];var linkextras=aData.EVNLINKEXTRAS?parseURL(aData.EVNLINKEXTRAS):{};if(Item.officeSupport(linkextras.EvnTitle)){var iid=(aData.EVNLINKID.indexOf('*')===0?'':'*')+aData.EVNLINKID;var aArgAuto=[Item.officeOpen,[{aid:aData.aid,fid:aData.fid,iid:iid},[Item.downloadFile,[aData.aid,aData.fid,iid]],Path.extension(linkextras.EvnTitle)]];var aArgWeb=[Item.officeOpen,[{aid:aData.aid,fid:aData.fid,iid:iid},[Item.downloadFile,[aData.aid,aData.fid,iid]],Path.extension(linkextras.EvnTitle)]];var aArgWebView=[Item.officeOpen,[{aid:aData.aid,fid:aData.fid,iid:iid},[Item.downloadFile,[aData.aid,aData.fid,iid]],Path.extension(linkextras.EvnTitle),'view']];var aArgExt=[Item.officeOpen,[{aid:aData.aid,fid:aData.fid,iid:iid},[Item.downloadFile,[aData.aid,aData.fid,iid]],Path.extension(linkextras.EvnTitle),'external']];var bIWD=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';arr.push({title:'POPUP_ITEMS::OPEN',arg:aArgAuto,'nodes':[{"title":'DOCUMENT::OPENDOCUMENT','arg':aArgWeb,disabled:!bIWD},{"title":'DOCUMENT::OPENDOCUMENTVIEW','arg':aArgWebView,disabled:!bIWD},{"title":'OFFICELAUNCHER::OFFICESUITE','arg':aArgExt}]});}
if(aData.EVNCLASS==='R'){linkextras.EvnTicket&&arr.push({title:'POPUP_ITEMS::DOWNLOAD_FILE',arg:[function(){downloadItem(linkextras.EvnTicket,true);}]},{title:'MAIN_MENU::SHARE',arg:[function(){this.__aData[id].obj._share(aData);}.bind(this)]});}else if(aData.EVNURL){arr.push({title:'POPUP_ITEMS::OPEN',arg:[function(){window.open(aData.EVNURL);}]});}
if(arr.length)
arr.push({title:'-'});arr.push({title:'IM::QUOTE',arg:[function(){me.text.input._value('"'+aData.EVNNOTE+'" ');me.text.input._focus();}],disabled:!aData.EVNNOTE||!WMFolders.getAccess({aid:me.__aid,fid:me.__fid},'write')});if(aData.EVNCLASS!='Q'&&aData.iid&&aData.EVNLINKTYPE!='10'&&(aData.EVNCLASS!='W'||aData.EVNLINKTYPE=='5')){arr.push({title:'FORM_BUTTONS::EDIT',arg:[function(){gui.frm_main.main.tabs.room.list._edit(aData.iid);}],disabled:!(aData.EVNOWNEREMAIL==sPrimaryAccount||WMFolders.getAccess({aid:me.__aid,fid:me.__fid},'modify'))});}
arr.push({title:'-'},{title:'FORM_BUTTONS::REMOVE',css:'color2',arg:[function(){me._remove(aData,elm)}],disabled:!(aData.EVNOWNEREMAIL==sPrimaryAccount||WMFolders.getAccess({aid:me.__aid,fid:me.__fid},'remove'))});var cmenu=gui._create("cmenu","obj_context",'','');cmenu._fill(arr);cmenu._place(e.clientX,e.clientY);cmenu._onclose=function(){removecss(elm,'active2');};return false;}else{me.__global_context_menu.call(this,e);}};this.panel.mentions._onactive=function(bFirst){removecss(me._main,'mention');if(bFirst){this._draw('frm_main_chat_room_mentions','main');this._getAnchor('close').onclick=function(){this.__deactive();}.bind(this);this.list.__options.type='mentions';this.list._placeholder('CHAT::NOMENTIONS');this.list._serverSort({aid:me.__aid,fid:me.__fid},true);this.list._onclick=function(e,elm){var sec=Is.Child(elm,'SECTION',this._main);if(sec){var aData,id=sec.getAttribute('rel');if(this.__aData[id]&&(aData=this.__aData[id].data)){me.tabs._value('room');me.tabs.room.list._serverSort({aid:aData.aid,fid:aData.fid},false,{until:aData.iid,highlight:true});}}};}};this.tabs.room.list._obeyEvent('onnotify',[function(e,arg){if(!arg.data){return;}
switch(arg.data.ACTION){case'add_pin':case'add_global_pin':if(arg.data.SERVICE=="GW"&&arg.data.ACTION=="add_global_pin"){if(this.panel&&(this.panel._value()!='pins'||this.panel.pins.btn_switch._value()!='1'))
addcss(this._main,'gpin');else
Cookie.set(['folders',this.__aid,this.__fid,'gpin'],arg.data.BODY);}
removecss(this._main,'newpin');setTimeout(function(fid){if(this._main&&fid==this.__fid){addcss(this._main,'newpin');setTimeout(function(fid){if(this._main&&fid==this.__fid)
removecss(this._main,'newpin');}.bind(this,this.__fid),1000);}}.bind(this,this.__fid),100);break;case'add':if(arg.data.MENTIONS){var mentions=parseParamLine(arg.data.MENTIONS);if(mentions[0].values.EMAIL===sPrimaryAccount){if(this.panel&&this.panel._value()!='mentions')
addcss(this._main,'mention');removecss(this._main,'newmention');setTimeout(function(fid){if(this._main&&fid==this.__fid){addcss(this._main,'newmention');setTimeout(function(fid){if(this._main&&fid==this.__fid)
removecss(this._main,'newmention');}.bind(this,this.__fid),1000);}}.bind(this,this.__fid),100);}}
if(!arg.data.SERVICE){if(arg.data['ITEM-TYPE']=='R')
this._serverSort('files');if(arg.data['ITEM-TYPE']=='Q')
this._serverSort('events');}
break;case'mention':if(arg.data.BODY===sPrimaryAccount){if(this.panel&&this.panel._value()!='mentions')
addcss(this._main,'mention');removecss(this._main,'newmention');setTimeout(function(fid){if(this._main&&fid==this.__fid){addcss(this._main,'newmention');setTimeout(function(fid){if(this._main&&fid==this.__fid)
removecss(this._main,'newmention');}.bind(this,this.__fid),1000);}}.bind(this,this.__fid),100);}
break;}}.bind(this)]);this.panel.pins._onactive=function(bFirst){if(bFirst){this._draw('frm_main_chat_room_pins','main');this._getAnchor('close').onclick=function(){this.__deactive();}.bind(this);this.list._placeholder('CHAT::NOPINS');this.btn_switch._fill(['SHARING::PUBLIC','SHARING::PRIVATE']);this.btn_switch._onchange=function(){this.list.__options.type=this.btn_switch._value()=='1'?'global_pins':'my_pins';this.list._serverSort({aid:me.__aid,fid:me.__fid},true,{search:gui.frm_main.search._value()});if(this.btn_switch._value()=='1'){if(me.__lastPin&&me.__lastPin.aid==me.__aid&&me.__lastPin.fid==me.__fid&&parseInt(Cookie.get(['folders',me.__aid,me.__fid,'gpin'])||0)<parseInt(me.__lastPin.time||0))
Cookie.set(['folders',me.__aid,me.__fid,'gpin'],me.__lastPin.time||'');removecss(me._main,'gpin');}
Cookie.set(['folders',me.__aid,me.__fid,'tab'],this.btn_switch._value()=='1'?'pins':'local');}.bind(this);this.btn_switch._value(Cookie.get(['folders',me.__aid,me.__fid,'tab'])=='local'?'2':'1');this.list._onclick=function(e,elm){var sec=Is.Child(elm,'SECTION',this._main);if(sec){var aData,id=sec.getAttribute('rel');if(this.__aData[id]&&(aData=this.__aData[id].data)){me.tabs._value('room');me.tabs.room.list._serverSort({aid:aData.aid,fid:aData.fid},false,{until:aData.iid,highlight:true,search:me.tabs.room.list.__aRequestData.filter?me.tabs.room.list.__aRequestData.filter.search:''});}}};}
else
if(gui.frm_main.search._value()!=this.list._search())
this.list._search(gui.frm_main.search._value());if(this.btn_switch._value()=='1'){if(me.__lastPin&&me.__lastPin.aid==me.__aid&&me.__lastPin.fid==me.__fid&&parseInt(Cookie.get(['folders',me.__aid,me.__fid,'gpin'])||0)<parseInt(me.__lastPin.time||0))
Cookie.set(['folders',me.__aid,me.__fid,'gpin'],me.__lastPin.time||'');removecss(me._main,'gpin');}};this.panel._onchange=function(sTab){if(sTab){addcss(this._parent._main,'show');if(sTab=='pins'&&this.pins.btn_switch._value()=='2')
sTab='local';Cookie.set(['folders',me.__aid,me.__fid,'tab'],sTab);}
else{if(!this._value())
removecss(this._parent._main,'show');Cookie.set(['folders',me.__aid,me.__fid,'tab']);}};this.tabs.files._onactive=function(bFirstTime){if(bFirstTime){this.sort._fillMe=function(){var sType=Cookie.get(['folders',me.__aid,me.__fid,'files','sort'])||'EVN_MODIFIED',sSort=Cookie.get(['folders',me.__aid,me.__fid,'files','sortdir'])||'desc';var a=[{html:getLang('SORT::SORT_BY')+':',css:'label'},{title:'',css:'obj_context',nodetype:'click',nodes:[{title:'CHAT::SORT_NAME',arg:['EVNTITLE']},{title:'CHAT::SORT_DATE',arg:['EVN_MODIFIED']},{title:'CHAT::SORT_SIZE',arg:['EVNCOMPLETE']},{title:'-'},{title:({EVNTITLE:'SORT::EVNTITLE_ASC',EVN_MODIFIED:'SORT::DATE_ASC',EVNCOMPLETE:'SORT::SIZE_ASC'})[sType],arg:['','asc']},{title:({EVNTITLE:'SORT::EVNTITLE_DESC',EVN_MODIFIED:'SORT::DATE_DESC',EVNCOMPLETE:'SORT::SIZE_DESC'})[sType],arg:['','desc']}]}];a[1].nodes.map(function(v){if(v.arg){v.css="ico2";if(v.arg[0]){if(v.arg[0]==sType){v.css+=" check";a[1].title=v.title;}
v.arg[1]=sSort;}
else{if(v.arg[1]==sSort){v.css+=" check";}
v.arg[0]=sType;}}});this._fill(a,'static');};this.sort._onclick=function(e,elm,id,arg){Cookie.set(['folders',me.__aid,me.__fid,'files','sort'],arg[0]);Cookie.set(['folders',me.__aid,me.__fid,'files','sortdir'],arg[1]);this.list._serverSort({aid:me.__aid,fid:me.__fid},me.__updateTab[this._name],true);this.sort._fillMe();}.bind(this);this.sort._fillMe();}
this.list._serverSort({aid:me.__aid,fid:me.__fid},me.__updateTab[this._name],{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});var old_oncontext=this.list._oncontext;this.list._oncontext=function(e,elm){e.preventDefault();if(me.__global_context_menu.call(this.list,e,elm)===false&&old_oncontext){old_oncontext.call(this.list,e,elm);};}.bind(this);};this.tabs.events._onactive=function(bFirstTime){this.list._serverSort({aid:me.__aid,fid:me.__fid},me.__updateTab[this._name],{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});var old_oncontext=this.list._oncontext;this.list._oncontext=function(e,elm){e.preventDefault();if(me.__global_context_menu.call(this.list,e,elm)===false&&old_oncontext){old_oncontext.call(this.list,e,elm);};}.bind(this);};this.tabs.members._onactive=function(bFirstTime){if(bFirstTime){this.list._onclick=function(e,elm){var sec=Is.Child(elm,'SECTION',this._main);if(sec){var aData,id=sec.getAttribute('rel');if(this.__aData[id]&&(aData=this.__aData[id].data))
if(hascss(elm,'mailto'))
Item.sendEmailTo(aData.FRTEMAIL);else
if(hascss(elm,'im')){if(sPrimaryAccountIM&&aData.FRTEMAIL&&gui.frm_main.im&&gui.frm_main.im._status!='offline')
gui.frm_main.im._chat(aData.FRTEMAIL);}
else
if(hascss(elm,'remove')){gui._create('gchat_remove','frm_confirm','','',[function(){me._removeMember(aData,sec);}],'IM::REMOVE','CHAT::REMOVE_ACCOUNT',[aData.FRTNAME||aData.FRTEMAIL]);}
else
me.text.input._addMention({name:aData.FRTNAME,email:aData.FRTEMAIL});}};}
this.list._serverSort({aid:me.__aid,fid:me.__fid},me.__updateTab[this._name],{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});var old_oncontext=this.list._oncontext;this.list._oncontext=function(e,elm){e.preventDefault();if(me.__global_context_menu.call(this.list,e,elm)===false&&old_oncontext){old_oncontext.call(this.list,e,elm);};}.bind(this);};this.tabs.room._onactive=function(bFirstTime){this.list._serverSort({aid:me.__aid,fid:me.__fid},false,{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});me.text._focus();};gui._obeyEvent('resize',[this,'__resizeHandler']);this.__resizeHandler();};_me._message=function(sBody,aArgs,aPrivate){if(this.__aid&&this.__fid){var active_folder=dataSet.get('active_folder'),recent=Cookie.get(['recent'])||[],index=recent.indexOf(active_folder);!!~index&&recent.splice(index,1);recent.unshift(active_folder);Cookie.set(['recent'],recent);var aItemInfo={values:{EVNNOTE:sBody,EVNSHARETYPE:'U'}};if(aPrivate){aItemInfo.values.EVNSHARETYPE='C';aItemInfo.values.EVNLINKID=aPrivate.email;}
if(aArgs){if(aArgs.url)
aItemInfo.values.EVNURL=aArgs.url;if(aArgs.title)
aItemInfo.values.EVNTITLE=aArgs.title;if(aArgs.desc)
aItemInfo.values.EVNLOCATION=aArgs.desc;if(aArgs.thumbnailimageid)
aItemInfo.values.THUMBNAILIMAGEID=aArgs.thumbnailimageid;var info={};if(aArgs.type)info.type=aArgs.type;if(aArgs.videourl)info.videourl=aArgs.videourl;if(aArgs.videotype)info.videotype=aArgs.videotype;if(!Is.Empty(info))
aItemInfo.values.LINKINFO=buildURL(info);if(aArgs.comevnid)
aItemInfo.values.EVNCOMEVNID=aArgs.comevnid;}
aArgs=aArgs||{};aArgs.aid=this.__aid;aArgs.fid=this.__fid;WMItems.add([this.__aid,this.__fid],aItemInfo,'','','',[this,'_response',[sBody,aArgs,aPrivate]]);}};_me._remove=function(aData,elm){var me=this;WMItems.remove({aid:aData.aid,fid:aData.fid,iid:[aData.iid]},'','','',[function(bOK){if(bOK&&me.__aid==aData.aid&&me.__fid==aData.fid){if(elm&&elm.id){var id=elm.id.substr(elm.id.lastIndexOf('#')+1);me.tabs.room.list._remove(id,aData.iid);}}}]);};_me._removeMember=function(aData,elm){var me=this,aItemInfo={aid:aData.aid,fid:aData.fid.replace(/^__@@GROUP@@__\//gi,''),xmlarray:{ACCOUNT:[{VALUE:WMItems.__serverID(aData.iid)}]}};WMFolders.action(aItemInfo,'','','remove_member','',[function(bOK){if(bOK&&me.__aid==aData.aid&&'__@@GROUP@@__/'+me.__fid==aData.fid){if(elm&&elm.id){var id=elm.id.substr(elm.id.lastIndexOf('#')+1);if(me.tabs.members)
me.tabs.members.list._remove(id,aData.iid);}}
else{}}]);};_me._showsearch=function(aFolder,bFocus,sFilter){if(aFolder){if(this.__aid&&this.__fid&&(this.__aid!=aFolder.aid||this.__fid!=aFolder.fid)){if(this.tabs&&this.tabs.room&&this.tabs.room._wasActivated){if(this.comment&&!this.comment._destructed)
this.comment._destruct();if(this.tabs._value()!='room'){var t=['room','files','events','members'];for(var i=t.length-1;i>=0;i--)
if(this.tabs&&this.tabs[t[i]]&&this.tabs[t[i]]._wasActivated&&this.tabs[t[i]].list)
this.tabs[t[i]].list._clear();}}}
this.__aid=aFolder.aid;this.__fid=aFolder.fid;Cookie.set(['last','I'],this.__aid+'/'+this.__fid);this.toolbar._setFolder(aFolder);gui.frm_main.search._setFolder(aFolder);var me=this;gui.frm_main.search._onsearch=function(v){if(me.tabs){var tab=me.tabs[me.tabs._value()];if(tab.list&&tab.list._search)
tab.list._search(v);if(me.panel._value()&&(tab=me.panel[me.panel._value()]))
tab.list._search(v);}};this.text._disabled(!WMFolders.getRights(aFolder,'write'));if(this.panel){var obj=this.panel._getChildObjects('','obj_tab_core');for(var tab in obj){if((tab=obj[tab]._name)&&this.panel[tab]&&this.panel[tab].list){if(this.panel[tab]&&this.panel[tab]._wasActivated){this.panel[tab]._clean();this.panel[tab]._wasActivated=false;}}}
switch(Cookie.get(['folders',this.__aid,this.__fid,'tab'])){case'pins':case'local':this.panel._value('pins');break;case'mentions':this.panel._value('mentions');break;default:var t=this.panel._value();this.panel[t]&&this.panel[t].__deactive(true);this.panel._value('');}}
if(this.tabs._value()!='room')
this.tabs._value('room');gui.frm_main.search._focus(bFocus);}
this.text._folder(aFolder);this.text.input._value(dataSet.get('teamchat',[aFolder.fid,'input'])||'');this.text._focus();removecss(this._main,'mention');removecss(this._main,'gpin');if(dataSet.get('teamchat',[aFolder.fid,'comment'])){var iid=dataSet.get('teamchat',[aFolder.fid,'comment']),aItemsInfo={aid:aFolder.aid,fid:aFolder.fid,iid:iid};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[aFolder.aid])&&(aData=aData[aFolder.fid])&&(aData=aData[iid])){aData.iid=iid;gui.frm_main.main._create('comment','frm_comment','','',aData);}
else
dataSet.remove('teamchat',[aFolder.fid]);}]);}};_me._response=function(bOK,arg,sBody,aArgs,aPrivate){if(bOK&&!this._destructed&&aArgs&&aArgs.aid===this.__aid&&aArgs.fid===this.__fid){var x;if(arg.id&&arg.xml&&(x=arg.xml.IQ)&&(x=x[0].RESULT)&&(x=x[0])){var aData={id:WMItems.__clientID(arg.id),body:sBody,timestamp:x.EVN_CREATED?x.EVN_CREATED[0].VALUE:0};objConcat(aData,aArgs);if(aArgs.mentions){for(var m in aData.mentions)
if(m==sPrimaryAccount&&this.tabs.room.list){this.tabs.room.list._fire(arg.id,'add_mention',{'ITEM-TYPE':'I'},true);break;}}
if(aPrivate){aData.share='C';aData.contact_name=aPrivate.name||aPrivate.email;aData.contact_email=aPrivate.email;}
if(this.tabs._value()!='room')
this.tabs._value('room');else{this.tabs.room.list._add_message(aData);this._serverSort('room');}}}};_me._serverSort=function(sType){if(!sType||this.tabs._value()=='room'||this.tabs._value()==sType){if(this.__getFolder()){var tab=this.tabs[this.tabs._value()];if(this.tabs._value()=='room'){var lastID=dataSet.get('teamchat',['forced_last_read_id'])||Folder.lastId({aid:this.__aid,fid:this.__fid})||'0';if(tab.list.__aRequestData.counter){dataSet.remove('teamchat',['forced_last_read_id']);}
if(!tab.list.__aRequestData.folder||tab.list.__aRequestData.folder.aid!=this.__aid||tab.list.__aRequestData.folder.fid!=this.__fid)
tab.list._serverSort({aid:this.__aid,fid:this.__fid},this.tabs._value()==sType,{until:WMItems.__clientID(lastID),search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});else
tab.list._serverSort({aid:this.__aid,fid:this.__fid},this.tabs._value()==sType,{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});}
else
if(tab._onactive){this.__updateTab[tab._name]=true;tab._onactive();}
this._main.style.display='';}else{this._main.style.display='none';}}
if(this.tabs&&this.tabs.room){if(this.tabs.notify){var value=+dataSet.get('folders',[this.__aid,this.__fid,'NOTIFY'])>0;this.tabs.notify._value(value,true);}}
if(sType&&this.tabs._value()!=sType)
this.__updateTab[sType]=true;};_me.__getFolder=function(){return this.__aid==sPrimaryAccount&&this.__fid&&WMFolders.getType([this.__aid,this.__fid])=='I';};_me._addEvent=function(comevnid){if(this.__aid&&this.__fid){var aOut=getActualEventTime();if(comevnid)
aOut.EVNCOMEVNID=comevnid;Item.openwindow([this.__aid,this.__fid],aOut,null,'E',[function(bOK,aData){if(bOK&&!this._destructed&&this.tabs&&this.tabs.room&&this.tabs.room.list){this.tabs.room.list._fire(aData.id,'add',{'ITEM-TYPE':'Q'});this.tabs.room.list._fire(aData.id,'add',{'ITEM-TYPE':'E'});}}.bind(this)]);}};_me._addEmail=function(){var name=dataSet.get('folders',[this.__aid,this.__fid,'NAME'])||dataSet.get('folders',[this.__aid,this.__fid,'RELATIVE_PATH']);NewMessage.compose({teamchat:this.__fid+'::'+this.__fid.split('/')[0]+'/'+name});};_me._manageMember=function(){if(this.__aid&&this.__fid)
gui._create('frm_sharing','frm_sharing','',~['I','Y'].indexOf(WMFolders.getType({aid:this.__aid,fid:this.__fid}))?'teamchat_folder':'',[function(bOK){if(bOK)
me._serverSort('members');}],{aid:this.__aid,fid:this.__fid});};_me._addMember=function(){if(this.__aid&&this.__fid){gui._create('invite','frm_groupchat_invite','','',{aid:this.__aid,fid:this.__fid},[function(){gui.notifier._value({type:'success',args:{text:'CHAT::INVITATION_SENT'}});this._serverSort('members');}.bind(this)]);}};_me._sendEmail=function(){if(this.__aid||this.__fid){var name=dataSet.get('folders',[this.__aid,this.__fid,'NAME'])||dataSet.get('folders',[this.__aid,this.__fid,'RELATIVE_PATH']),newMessage=new NewMessage();newMessage.addSignature();newMessage.sTo='['+this.__fid+'::'+name+']';newMessage.sSubject='';gui._create('frm_compose','frm_compose','','',newMessage);}};_me._word=function(){this.__createNewGW('F','.docx');};_me._excel=function(){this.__createNewGW('F','.xlsx');};_me._ppoint=function(){this.__createNewGW('F','.pptx');};_me._note=function(){this.__createNewGW('N');};_me._code=function(){gui._create('insert_code','frm_insert_code','','',[function(sBody){this._message(sBody);}.bind(this)]);};_me.__createNewGW=function(sType,sDoc){var aActive=gui.frm_main.bar.tree.folders._getActive(),sFolder,sAccount,bActual=false;if(aActive[0]!=''||aActive[1]!=''){var sFolType=WMFolders.getType(aActive);if(sType==sFolType||(sType=='L'&&sFolType=='C')||((sType=='F'||sType=='N')&&(sFolType=='I'||sFolType=='Y')))
bActual=true;}
if(bActual){sAccount=aActive[0];sFolder=aActive[1];}else{sAccount=sPrimaryAccount;sFolder=Mapping.getDefaultFolderForGWType(sType);}
if(sType=='E')
Item.openwindow([sAccount,sFolder],getActualEventTime(),null,'E');else{var aValues;if(sDoc)
aValues={'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':sDoc}}]};Item.openwindow([sAccount,sFolder],aValues,null,sType,(sType==='F'||sType==='N')?[function(bOK,aData){var me=gui.frm_main.main;if(bOK&&me.tabs&&me.tabs.room){me.tabs.room.list._fire(aData.id,'add',{'ITEM-TYPE':'R'})||me._serverSort('');}}]:false,null,sType==='F');}};_me._attachFile=function(){if('1'===GWOthers.getItem('RESTRICTIONS','disable_attach_item')){this.upload._click();return;}
if(this.__aid&&this.__fid){gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[this,'__addItems'],this.__aid,this.__fid,'','r',false,['M','F','I','X']);}};_me.__addItems=function(files){var me=this;me.__upload_buffer=[];files.forEach(function(file){me.__upload_buffer.push({'class':'item','description':file.title,'size':file.size,'fullpath':file.fullpath});});if(me.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',me.__upload_buffer[0].description,'',{aid:me.__aid,fid:me.__fid},[function(sName,sDesc,aArg){me.__uploadhandler(me.__upload_buffer,sName,sDesc,aArg);}]);}else
me.__uploadhandler(me.__upload_buffer);};_me._addConference=function(){if(this.__aid&&this.__fid){var frm=Item.openwindow([sPrimaryAccount,this.__fid],{EVNCLASS:'E',conference:true,EVNSHARETYPE:'U',EVNTIMEFORMAT:'Z',EVNFLAGS:1,MEETING_ACTION:1},null,'E',[function(bOK){if(bOK&&this.tabs&&this.tabs.room){this._serverSort('room');}}.bind(this)]);frm._modal(true);frm.MEETING_ACTION._disabled(true);}};_me.__resizeHandler=function(){if(!this||this._destructed)
return false;else{var w=this._main.offsetWidth;if(w>1100)
addcss(this._main,'wide');else
removecss(this._main,'wide');if(w>1100&&w<1800)
addcss(this._main,'fixed');else
removecss(this._main,'fixed');if(this.panel&&!this.panel._destructed&&w>1100){var offset=0;if(hascss(gui.frm_main._main,'rdock')&&!hascss(gui.frm_main._main,'rd_small')){offset=gui.frm_main._getAnchor('im').offsetWidth;}
this.panel._main.style[gui._rtl?'left':'right']=offset+'px';}
else
this.panel._main.removeAttribute('style');}};

/* client/inc/frm_main_conference.js */
_me=frm_main_conference.prototype;function frm_main_conference(){};_me.__constructor=function(){this.__opt={full:dataSet.get('accounts',[sPrimaryAccount,'MEETING_PROVIDER'])=='jitsi'};gui.frm_main.title._add(getLang('CONFERENCE::TITLE'));if(this.__opt.full){addcss(this._main,'full');}
this._draw('frm_main_conference','main',{full:this.__opt.full});gui._obeyEvent('conference_started',[this,'_updateView']);gui._obeyEvent('conference_ended',[this,'_updateView']);this._updateView(true);};_me._updateView=function(bForce){if(!this||this._destructed)
return false;if(dataSet.get('main',['conference']))
this._view('progress');else if(bForce||(this.__currentView==='progress'))
this._view('home');};_me._view=function(sView,aData,bDestructOld){if(this.__currentView===sView)
return;var o;switch(sView){case'name':o=this._create('name','obj_conference_name','view_pane');break;case'schedule':o=this._create('schedule','obj_conference_schedule','view_pane');break;case'progress':o=this._create('progress','obj_conference_progress','view_pane');break;default:o=this._create('home','obj_conference_home','view_pane');}
this.__currentView=sView;if(o){var back=this._getAnchor('back');if(o.__opt&&o.__opt.back_button){back.textContent=o.__opt.back_button;back.onclick=function(){this._view(o.__opt.back_action||'home',null,true);}.bind(this);addcss(this._main,'back');}
else
removecss(this._main,'back');if(o.__destructTimer)
clearTimeout(o.__destructTimer);if(this.__current){addcss(this.__current._main,'flyout');removecss(o._main,'flyout');addcss(o._main,'flyin');if(bDestructOld||['obj_conference_schedule','obj_conference_name'].indexOf(this.__current._type)==-1){this.__current.__destructTimer=setTimeout(function(){if(this&&!this._destructed)
this._destruct();}.bind(this.__current),500);}}
this.__current=o;}};_me._showsearch=function(aFolder,bFocus){this.__aid=aFolder.aid;this.__fid=aFolder.fid;if(this.__opt.full){this.tabs._onchange=function(sTab){if(sTab){if(this[sTab].list&&this[sTab].list&&this[sTab].list._search&&GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1')
gui.frm_main.search._value(gui.frm_main.search._value(),true);else
gui.frm_main.search._deactivate();}};this.tabs.upcoming._onactive=function(){this.list.__options.search='afterend:now';this.list._serverSort(aFolder,false,{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});};this.tabs.history._onactive=function(bFirst){if(bFirst){this._create('list','obj_list_conference','','history');this.list.__options.order='desc';}
var journal=GWOthers.getItem('DEFAULT_FOLDERS','JOURNAL').split('/');this.list._serverSort({aid:journal[0],fid:journal[1]},false,{search:GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'?gui.frm_main.search._value():''});};this.tabs._value('upcoming');gui.frm_main.search._onsearch=function(v){if(this.tabs){var tab=this.tabs[this.tabs._value()];if(tab.list&&tab.list._search)
tab.list._search(v);}}.bind(this);gui.frm_main.search._setFolder(aFolder);gui.frm_main.search._focus(bFocus);}};_me._serverSort=function(bForce){if(this.__opt.full){if(bForce)
this.tabs._value(this.tabs._value());else
this.tabs[this.tabs._value()].list._serverSort();}};_me._scheduleConference=function(){Item.openwindow([sPrimaryAccount,frm_main_conference.FOLDER],{conference:true});};

/* client/inc/frm_main_datagrid.js */
_me=frm_main_datagrid.prototype;function frm_main_datagrid(){};_me.__constructor=function(){var me=this;if(this._anchors['container'])
this._create("itemview","obj_itemview",'container','','preview');this._create("list","obj_datagrid2_ext");this.list.info={_value:function(iSelect,iTotal){var aFolder=me.list._getFolder();gui.frm_main._title(dataSet.get('folders',[aFolder.aid,aFolder.fid,'NAME'])||Path.basename(aFolder.fid),iSelect,iTotal);}};this.list._tabIndex();};_me.__update=function(aFolder){if(!aFolder['aid']||!aFolder['fid'])return;var aSort=Cookie.get(['views',aFolder.aid,aFolder.fid,'sort']);this.list._serverSort(aFolder,aSort['column'],aSort['type']);};_me._changeview=function(sView){if(!sView)
switch(this._type){case'frm_main_datagrid':sView='list_view';break;case'frm_main_datagrid_view':sView='list_wide';break;case'frm_main_datagrid_wide':sView='list';break;}
this._parent._selectView(this.list._getFolder(),sView,false,'',false,this.list?this.list._SQLsearch:'');};_me._showsearch=function(aFolder,bFocus,sFilter){if(aFolder){var me=this;var sFType=WMFolders.getType(aFolder);if(sFType=='E'){if(!this.toolbar){addcss(this._main,'toolbar');this._create('toolbar','obj_hmenu_calendar_view','','');}
this.toolbar.__menu(aFolder);}
else
if(this.toolbar){this.toolbar._destruct();removecss(this._main,'toolbar');}
var old=gui.frm_main.search._getFolder(),keep=(old&&WMFolders.getType(old)==WMFolders.getType(aFolder)&&GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1');gui.frm_main.search._setFolder(aFolder);if((sFType=='C'||sFType=='F')&&WMFolders.getAccess(aFolder,'write')){if(this.upload)
this.upload._destruct();var sTarget='main';switch(this._type){case'frm_main_datagrid_view':case'frm_main_datagrid_wide':sTarget='list';}
this._create('upload','obj_upload_edit',sTarget,'quick_upload','ATTACHMENT::QUICK_ADD',sFType=='C'?'ATTACHMENT::QUICK_CONTACT':'');this.upload._onuploadstart=function(){me._uploading=true;me.list._create('progress','obj_upload_info','','bottom');};this.upload._onuploadend=function(arg){me._uploading=false;if(this._destructed)
return;me.list&&me.list.progress&&me.list.progress._destruct();var v=this._value();if(v&&v.length&&aFolder)
if(sFType=='C'){storage.library('wm_import');var oImport=new wm_import();for(var i=0;i<v.length;i++)
if(v[i].values&&Path.extension(v[i].values.description)=='vcf')
oImport.import_data({'action':'vcard','account':aFolder.aid,'folder':aFolder.fid,'lines':0,'path':v[i].values.fullpath},[function(bOK){if(bOK===true){me.__update(aFolder);if(gui.notifier)
gui.notifier._value({type:'item_saved',args:[aFolder.aid,aFolder.fid],group:'quick_vcf'});}}]);}
else{var now=new IcewarpDate(),aValues={values:{EVNSHARETYPE:GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','file_sharing'),EVNSTARTDATE:now.format(IcewarpDate.JULIAN),EVNSTARTTIME:now.hour()*60+now.minute()},ATTACHMENTS:v};WMItems.add([aFolder.aid,aFolder.fid],aValues,'','','',[function(aResponse){me.__update(aFolder);if(Is.Array(aResponse)&&aResponse[0]&&gui.notifier)
gui.notifier._value({type:'item_saved',args:[aFolder.aid,aFolder.fid]});}]);}
this.file._setFolder('');this._remove();};this.upload._onuploadsuccess=function(file){me.list&&me.list.progress&&me.list.progress._handler(null);};this.upload._onuploadprogress=function(file,a,b,xhr){me.list&&me.list.progress&&me.list.progress._value(file.name,a,b,[function(){xhr.abort()}]);};this.upload._dropzone(this._getAnchor(sTarget),function(){if(sFType=='C')
return template.tmp('dropzone',{title:getLang('CONTACT::DROP_TITLE'),body:getLang('CONTACT::DROP_BODY')});else
return template.tmp('dropzone',{title:getLang('ATTACHMENT::DROP_TITLE'),body:getLang('ATTACHMENT::DROP_BODY')});},'item small');}
else
if(this.upload){this.upload.progress&&this.upload.progress._destruct();this.upload._destruct();removecss(this._main,'quick');}
if(sFilter){this.list._SQLsearch=sFilter;gui.frm_main.search._value(sFilter,true);}
else
if(keep)
this.list._SQLsearch=gui.frm_main.search._value();else{this.list._SQLsearch='';gui.frm_main.search._deactivate();}
this.list._SQLfulltext='';gui.frm_main.search._onsearch=function(v){if(v&&aFolder.aid==sPrimaryAccount&&aFolder.fid.indexOf('SPAM_QUEUE/')==0&&v.indexOf('from:')<0)
v='from:"'+v+'"';me.list._SQLsearch=v;me.list._serverSort();}
if(bFocus)
gui.frm_main.search._focus();}
else
if(this.list)
this.list._SQLsearch=sFilter||'';};

/* client/inc/frm_main_home.js */
_me=frm_main_home.prototype;function frm_main_home(){};_me.__constructor=function(){gui.frm_main._title();this._create('scrollbar','obj_scrollbar')._scrollbar(this._main);var aAccount=dataSet.get('accounts',[sPrimaryAccount]);if(sPrimaryAccountGUEST)
this._draw('frm_main_home','main');else{this._draw('frm_main_home','main',{enable_quota:(aAccount.MBOX_QUOTA?true:false),enable_smsquota:(aAccount.SMS_LIMIT>0?true:false),enable_banner:GWOthers.getItem('HOMEPAGE_SETTINGS','banner')>0,enable_application:GWOthers.getItem('HOMEPAGE_SETTINGS','application')>0&&(GWOthers.getItem('RESTRICTIONS','disable_licenses')||0)<1});if(aAccount.MBOX_QUOTA||aAccount.SMS_LIMIT>0)
WMAccounts.list({aid:sPrimaryAccount},'','','',[this,'__quotaupdate']);if(GWOthers.getItem('HOMEPAGE_SETTINGS','banner')>0){var eBanner=this._getAnchor('banner');if(eBanner){eBanner.style.height=(GWOthers.getItem('HOMEPAGE_SETTINGS','banner_height')||60)+'px';var eFrame=this._create("frame","obj_frame","banner");eFrame._sandbox(['allow-forms','allow-pointer-lock','allow-popups','allow-scripts','allow-same-origin']);eFrame._src(GWOthers.getItem('HOMEPAGE_SETTINGS','banner_url')||('client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/banner.html'));}}
var eLicense=this._getAnchor('license');if(eLicense)
eLicense.onclick=function(e){gui._create('license','frm_help',void 0,void 0,'license');return false;};}
this.x_last_ip._value(aAccount['LAST_IP']);this.x_current_ip._value(aAccount['CURRENT_IP']);if(aAccount['LAST_TIME']){this.x_last_time._value(new IcewarpDate(aAccount['LAST_TIME']*1000).format('L LT'));}
if(aAccount['CURRENT_TIME']){this.x_current_time._value(new IcewarpDate(aAccount['CURRENT_TIME']*1000).format('L LT'));}};_me.__quotaupdate=function(aAccount){if(aAccount&&(aAccount=aAccount[sPrimaryAccount])){if(aAccount.MBOX_QUOTA&&this.quota){this.x_quota._value(roundTo(aAccount.MBOX_USAGE/1024,1)+' '+getLang('UNITS::MB')+' / '+roundTo(aAccount.MBOX_QUOTA/1024,1)+' '+getLang('UNITS::MB'));this.quota._range(aAccount.MBOX_QUOTA);this.quota._value(aAccount.MBOX_USAGE||0);this.quota._title(roundTo(aAccount.MBOX_USAGE/aAccount.MBOX_QUOTA*100,1)+'% ('+roundTo(aAccount.MBOX_USAGE/1024,1)+' '+getLang('UNITS::MB')+' / '+roundTo(aAccount.MBOX_QUOTA/1024,1)+' '+getLang('UNITS::MB')+')');}
if(aAccount.SMS_LIMIT&&this.smsquota){this.x_smsquota._value(aAccount.SMS_SENT+' / '+aAccount.SMS_LIMIT+' SMS');this.smsquota._range(aAccount.SMS_LIMIT);this.smsquota._value(aAccount.SMS_SENT||0);this.smsquota._title(Math.ceil(aAccount.SMS_SENT/(aAccount.SMS_LIMIT/100))+'% ('+aAccount.SMS_SENT+' / '+aAccount.SMS_LIMIT+')');}}};

/* client/inc/frm_main_mail.js */
_me=frm_main_mail.prototype;function frm_main_mail(){};_me.__constructor=function(){var me=this;if(this._anchors['container'])
this._create("mailview","obj_mailview",'container','','preview','',1);if(!this.list)
this._create("list","obj_datagrid2_ext");this.list.info={_value:function(iSelect,iTotal){var aFolder=me.list._getFolder();gui.frm_main._title(dataSet.get('folders',[aFolder.aid,aFolder.fid,'NAME'])||Path.basename(aFolder.fid),iSelect,iTotal);}};this.list._tabIndex();};_me._changeview=function(sView){if(!sView)
switch(this._type){case'frm_main_mail':sView='mail_view_wide';break;case'frm_main_mail_wide':sView='mail_view_list';break;case'frm_main_mail_list':sView='mail_view';break;}
this._parent._selectView(this.list._getFolder(),sView,false,'',false,this.list._SQLsearch);};_me._showsearch=function(aFolder,bFocus,sFilter){if(aFolder){gui.frm_main.search._setFolder(aFolder);if(sFilter){this.list._SQLsearch=sFilter;gui.frm_main.search._value(sFilter,true);}
else
if(GWOthers.getItem('LAYOUT_SETTINGS','keep_search')=='1'){this.list._SQLsearch=gui.frm_main.search._value();}
else{this.list._SQLsearch='';gui.frm_main.search._deactivate();}
this.list._SQLfulltext='';var me=this;gui.frm_main.search._onsearch=function(v,s){me.list._SQLsearch=v;me.list._SQLfulltext=s;me.list._serverSort();}
if(bFocus)
gui.frm_main.search._focus();}};

/* client/inc/frm_manage_users.js */
_me=frm_manage_users.prototype;function frm_manage_users(){};_me.__constructor=function(aHandler,aEmails){this.__aHandler=aHandler;var me=this;this.__aData={};Array.isArray(aEmails)&&aEmails.forEach(function(sEmail){this.__aData[sEmail]=true;},this);this._size(700,450,true);this.__bFormEnabled=true;this._draw('frm_manage_users','main');this._create('x_btn_ok','obj_button','footer','noborder color1 ok');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){me.__save();};this._create('x_btn_cancel','obj_button','footer','noborder cancel simple');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct();};this.users._row_height=40;this.users._addColumns({user:{title:"SHARING::PEOPLE_YOU_INVITED",width:100,mode:'%',type:'static'},x:{css:'remove',width:30,mode:'px',type:'static'}});this.users._obeyEvent('onclick',[function(e,args){if(me.__bFormEnabled&&args.cell==='x'){me._remove();return;}}]);this.inp_add.__setMask({address_book:['',getLang('ADDRESS_BOOK::ADDRESS_BOOK')]},[function(){me.__bFormEnabled&&gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],[''],'',false);}]);this.inp_add._disobeyEvent('change',[this.inp_add,'_checksize']);this.inp_add._checksize=function(){};this.inp_add._placeholder(getLang('SHARING::ENTER_ADDRESS'));this.inp_add._qvalue=function(v){if(Is.Object(v)){v=v.value;}
this._value(v);this._setRange(v.length);};this.inp_add._onsubmit=function(){var tmp=MailAddress.splitEmailsAndNames(this._value());this._value('');if(tmp&&tmp[0]&&tmp[0].email)
me.__onAddNewFromAddressbook(true,[[MailAddress.createEmail(tmp[0].name,tmp[0].email)]]);};this.inp_add._onmouseselect=this.inp_add._onsubmit;this.inp_add._disabled(!this.__bFormEnabled);this.inp_add._focus();this.__aData2=clone(this.__aData,true);this._fill();};_me._remove=function(){var v=this.users._value();if(Is.Empty(v))return;try{this.__aData[this.users._aData[v[0]].arg.user]=['~'];this._fill();}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}
if(!this.users._aData[v[0]]&&this.users._aData.length>0){v=[this.users._aData.length-1];this.users._value(v);}};_me._fill=function(){var aData=[];for(var i in this.__aData)
if(this.__aData[i][0]!='~'){aData.push({data:{user:'<img class="avatar" src="'+getAvatarURL(i)+'"> '+(i=='anyone'?getLang('SHARING::ANONYMOUS'):i.escapeHTML()),x:''},arg:{user:i},css:Is.Array(this.__aData[i])?this.__aData[i].join(' '):''});}
this.users._fill(aData);};_me.__onAddNewFromAddressbook=function(bOK,aAddresses){if(bOK&&aAddresses&&aAddresses[0]){var tmp;for(var i in aAddresses[0]){tmp=MailAddress.splitEmailsAndNames(aAddresses[0][i]);if(tmp&&(tmp=tmp[0])&&tmp.email&&(!this.__aData[tmp.email]||this.__aData[tmp.email][0]==='~'))
this.__aData[tmp.email]=['r','l'];}
this._fill();}};_me.__save=function(){this.x_btn_ok._disabled(true);var d1=clone(this.__aData,true),d2=clone(this.__aData2,true);if(!Is.Empty(this.__aData)){for(var i in d2)
if(d1[i]&&arrayCompare(d2[i],d1[i]))
delete d1[i];if(Is.Empty(d1)){this.__success_handler([]);return;}}
this.__success_handler(Object.keys(d1));};_me.__success_handler=function(aData){this._destruct();if(this.__aHandler)
executeCallbackFunction(this.__aHandler,aData);};_me.__error_handler=function(arr,id,str){if(id&&str){switch(id){case'groupware_setacl':var id=str.match(/id:(.*?)\s/)||[];var error='GROUPWARE_SETACL';var source=this.__aFolderInfo.aid;if(this.__aFolderInfo.fid){error='GROUPWARE_SETACL_FOLDER';source=dataSet.get('folders',[this.__aFolderInfo.aid,this.__aFolderInfo.fid,'NAME'])||this.__aFolderInfo.fid;}
gui.notifier._value({type:'alert',args:{header:'POPUP_FOLDERS::SHARING',text_plain:getLang('ERROR::'+error,[source,id[1]])}});break;default:gui.notifier._value({type:'alert',args:{header:'POPUP_FOLDERS::SHARING',text_plain:str}});}
this.x_btn_ok._disabled(false);}else
this.__success_handler([]);};

/* client/inc/frm_name.js */
_me=frm_name.prototype;function frm_name(){};_me.__constructor=function(oInput,aLCTval){var me=this;this._title('CONTACT::FULL_NAME');this._resizable(false);this._dockable(false);this._size(400,280,true);this._modal(true);this._draw('frm_name','main');var aLang=getLang('NAME_PREFIX'),aFill={};for(var i in aLang)
aFill[aLang[i]]=aLang[i];this.ITMTITLE._fill(aFill);aLang=getLang('NAME_SUFFIX');aFill={};for(var i in aLang)
aFill[aLang[i]]=aLang[i];this.ITMSUFFIX._fill(aFill);if(oInput&&!oInput._destructed&&createNameFromLocation(aLCTval)!=oInput._value())
parseNameToLocation(oInput._value(),aLCTval);this.ITMTITLE._value(aLCTval.ITMTITLE);this.ITMFIRSTNAME._value(aLCTval.ITMFIRSTNAME);this.ITMMIDDLENAME._value(aLCTval.ITMMIDDLENAME);this.ITMSURNAME._value(aLCTval.ITMSURNAME);this.ITMSUFFIX._value(aLCTval.ITMSUFFIX);this._create('btn_ok','obj_button','footer','noborder simple color1 ok');this.btn_ok._value('FORM_BUTTONS::OK');this.btn_ok._onclick=function(){if(oInput&&!oInput._destructed){var out={ITMTITLE:me.ITMTITLE._value().trim(),ITMFIRSTNAME:me.ITMFIRSTNAME._value().trim(),ITMMIDDLENAME:me.ITMMIDDLENAME._value().trim(),ITMSURNAME:me.ITMSURNAME._value().trim(),ITMSUFFIX:me.ITMSUFFIX._value().trim()};oInput._value(createNameFromLocation(out));oInput._onblur();oInput._focus();for(var i in out)
aLCTval[i]=out[i];}
me._destruct();};};

/* client/inc/frm_no_java.js */
_me=frm_no_java.prototype;function frm_no_java(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution,sOKLabel,sCancelLabel,sCancel2Label){var me=this;removecss(this.x_btn_ok._main,'ok','color1');removecss(this.x_btn_cancel._main,'cancel');removecss(this.x_btn_cancel2._main,'cancel');this._draw('frm_no_java','message',{message:this.obj_label._value()});this.x_btn_ok._value('ERROR::CONTACTADMIN');addcss(this.x_btn_ok._main,'send');this.x_btn_ok._onclick=function(){window.open('/#support','menubar=no,resizable=yes,status=no,location=no');me._destruct();}
this.x_btn_cancel._value('ERROR::TROUBLESHOOT');addcss(this.x_btn_cancel._main,'settings');this.x_btn_cancel._onclick=function(){window.open('http://www.icewarp.com/support/troubleshoot_webphone/?lang='+GWOthers.getItem('LAYOUT_SETTINGS','language'),'menubar=no,resizable=yes,status=no,location=no');me._destruct();}
this.x_btn_cancel2._value('FORM_BUTTONS::OK');addcss(this.x_btn_cancel2._main,'ok');this._size(500,300,-1,-1)};

/* client/inc/frm_note.js */
_me=frm_note.prototype;function frm_note(){};_me.__constructor=function(){var me=this;this._defaultSize(-1,-1,800,600);storage.library('purify.wrapper','purify');this._draw('frm_note','main');msiebox(this.maintab.tab1._getAnchor('msiebox'));this.maintab.tab1.NOTE_TEXT.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});this.maintab.tab1.NOTE_TEXT._onesc=function(){me._close(true);};this.maintab.tab2.X_ATTACHMENTS.file._dropzone(this.__eContainer);this.maintab.tab2.X_ATTACHMENTS._onuploadstart=function(){this._parent._active();me.x_btn_ok._disabled(true);};this.maintab.tab2.X_ATTACHMENTS._onuploadend=function(){me.x_btn_ok._disabled(false);};if(!WMFolders.getAccess([this._sAccountID,this._sFolderID,this._sItemID]).remove){this.x_btn_delete&&this.x_btn_delete._disabled(1);}
this.maintab.tab1.EVNTYPE.input._onChange=function(){this.__refreshView=true;}.bind(this);setTimeout(function(){this.__initForm('NOTE::NOTE');}.bind(this),5);};_me.__confirmed=function(){if(this.__autosaveid)
Item.__delete([this._sAccountID,this._sFolderID,[this._sItemID]]);this._close();};_me.__print=function(aValues){if(aValues.NOTES)
aValues.values.NOTE_TEXT=aValues.NOTES[0].values.NOTE_TEXT;aValues=aValues.values;if('text/html'===aValues.EVNDESCFORMAT){aValues.NOTE_TEXT=DOMPurify.sanitize(aValues.NOTE_TEXT);}
if(!gui.print)
gui._create('print','frm_print');gui.print._add('N',aValues);};_me.__loadItems=function(){var me=this,tab1=this.maintab.tab1;if(gui._rtl||!this._aValues||!this._aValues.EVNDESCFORMAT||this._aValues.EVNDESCFORMAT.toLowerCase()!='text/plain')
tab1.NOTE_TEXT.select._value('enabled');else
tab1.NOTE_TEXT.select._value('disabled');loadDataIntoForm(tab1,this._aValues);tab1.EVNTITLE._restrict(/\S+/);tab1.EVNTITLE._onerror=function(bError){me.x_btn_ok._disabled(bError);};this.x_btn_ok._disabled(!tab1.EVNTITLE._validate());tab1.EVNTITLE._onkeyup=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>32)
sTitle=sTitle.substr(0,32)+'...';me._title(sTitle+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);}
else
me._title(getLang('NOTE::NOTE')+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);};tab1.EVNTITLE._onkeyup();if(this._aValues)
try{this.maintab.tab1.NOTE_TEXT._value(this._aValues.NOTES[0].values.NOTE_TEXT||'');}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}
if(this.maintab.tab2)
this.maintab.tab2._onactive=function(bFirstTime){if(bFirstTime){if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});if(me._aValues.fullpath)
this.X_ATTACHMENTS._value({'values':out});else
this.X_ATTACHMENTS._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID),'values':out});}
else
if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}}}
if(me._aValues['PUSH_ATTACHMENTS']&&this.maintab.tab2)
this.maintab.tab2._active();};_me.__saveItems=function(aValues){var addon;if(this.maintab.tab2&&this.maintab.tab2.X_ATTACHMENTS&&!Is.Empty(addon=this.maintab.tab2.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=addon;aValues.values.EVNDESCFORMAT=this.maintab.tab1.NOTE_TEXT.select._value()=='disabled'?'text/plain':'text/html';this.maintab.tab1.NOTE_TEXT.__output_format=aValues.values.EVNDESCFORMAT!=='text/plain';aValues['NOTES']=[{values:{NOTE_TEXT:this.maintab.tab1.NOTE_TEXT._value()}}];if(!aValues.values.EVNTITLE){if(aValues.values.NOTE_TEXT&&aValues.values.NOTE_TEXT.removeTags()){aValues.values.EVNTITLE=aValues.values.NOTE_TEXT.substr(0,2048).removeTags().trim();if(aValues.values.EVNTITLE.length>128)
aValues.values.EVNTITLE=aValues.values.EVNTITLE.substr(0,128)+'...';}else{aValues.values.EVNTITLE=getLang('NOTE::NEW');}}
delete aValues.values.NOTE_TEXT;};

/* client/inc/frm_notify.js */
_me=frm_notify.prototype;function frm_notify(){};_me.__constructor=function(ids){this.__id=ids;this._title('NOTIFY::TITLE');this._defaultSize(-1,-1,600,400);this._draw('frm_notify','main');msiebox(this._getAnchor('msiebox'));this.btn_copy._onclick=function(){if(this._parent.add_address&&!this._parent.add_address._destructed)
this._parent.add_address._focus();else
this._parent.add_address=gui._create('add_address','frm_addaddress','','',[this._parent,'__onPopupClose'],{'copy':"ADDRESS_BOOK::SELECTED_ADDRESSES"},{'copy':this._parent.inp_copy._value()},'copy',true);};this.comment._placeholder(getLang('NOTIFY::COMMENT'));this.x_btn_ok._onclick=function(){var aItemInfo={aid:this._parent.__id[0],fid:this._parent.__id[1],iid:this._parent.__id[2],values:{all:this._parent.ch_all._value()?'1':'0',copy_to:this._parent.inp_copy._value(),comment:this._parent.comment._value()}};this._parent.__hide();WMItems.action(aItemInfo,'notify',[this._parent,'__notified']);};this.inp_copy._onchange=this.ch_all._onchange=function(){this._parent.__test();};};_me.__test=function(){this.x_btn_ok._disabled(!this.ch_all._value()&&!this.inp_copy._value());};_me.__onPopupClose=function(bOK,aAddresses){if(bOK&&aAddresses['copy'])
this.inp_copy._value(aAddresses['copy'].join(', '));};_me.__notified=function(aResponse,aError){if(aResponse==false){this.__show();}
else{if(gui.notifier)
gui.notifier._value({type:'message_sent'});this._destruct();}};

/* client/inc/frm_ok_cancel.js */
_me=frm_ok_cancel.prototype;function frm_ok_cancel(){};_me.__constructor=function(){var me=this;this._create('x_btn_ok','obj_button','footer','ok noborder color1');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){me._destruct();};this._create('x_btn_cancel','obj_button','footer','cancel noborder');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct();};};

/* client/inc/frm_password.js */
_me=frm_password.prototype;function frm_password(){};_me.__constructor=function(aResponse,sLabel1,sLabel2,sPlaceholder){var me=this;this._size(250,145,true);this._resizable(false);this._dockable(false);this._modal(true);this._draw('frm_input','main');this._create('obj_input','obj_password','input','obj_input_100');this.obj_input._focus();this.obj_input._onsubmit=function(){me.x_btn_ok._onclick();};this.obj_input._onclose=function(){me.x_btn_cancel._onclick();};if(sLabel1)this._title(sLabel1);if(sLabel2)this.obj_input._value(sLabel2);this.obj_input._onchange=function(){this.x_btn_ok._disabled(!this.obj_input._value());}.bind(this);this.x_btn_ok._disabled(!this.obj_input._value());if(sPlaceholder)this.obj_input._placeholder(sPlaceholder);this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse,me.obj_input._value());me._destruct();};};

/* client/inc/frm_pdf.js */
_me=frm_pdf.prototype;function frm_pdf(){};_me.__constructor=function(){this._defaultSize(-1,-1,900,620);this._title('ATTACHMENT::PDF');this._create('frame','obj_frame');};_me._load=function(url,sTitle){if(url){if(url.indexOf('http')!=0)
url='../../../../'+url;this.frame._src('client/inc/pdfjs/web/?'+buildURL({file:url+(sTitle?'#'+sTitle:''),lang:GWOthers.getItem('LAYOUT_SETTINGS','language')}));if(sTitle)
this._title(sTitle,true);}};

/* client/inc/frm_permissions.js */
function frm_permissions(){};frm_permissions.prototype.__constructor=function(options){this.__options=options||{};this.__options.permissions=this.__options.permissions||[];this._modal(true);this._size(500,210,true);this._title(getLang('SHARING::PERMISSIONS'),true);this._draw('frm_permissions','main',{teamchat:this.__options.teamchat});this.__options.permissions.forEach(function(permission){this[permission]._checked(true);},this);this._create('x_btn_ok','obj_button','footer','noborder color1 ok');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=this.__save.bind(this);this._create('x_btn_cancel','obj_button','footer','noborder cancel simple');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){this._destruct();}.bind(this);};frm_permissions.prototype.__save=function(){if(this.__options.callback){var permissions=this._getChildObjects('','obj_checkbox').map(function(checkbox){return checkbox._value()&&checkbox._name;}).filter(Boolean);executeCallbackFunction([this.__options.callback],permissions);}
this._destruct();};

/* client/inc/frm_phonebook.js */
_me=frm_phonebook.prototype;function frm_phonebook(){};_me.__constructor=function(aResponse){var me=this;this._size(450,550,true);this._modal(true);this._dockable(false);this._title('DIAL::PBOOK');this._draw('frm_phonebook','main');this._activeFolder='__@@ADDRESSBOOK@@__';this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse,me._value());me._destruct();};this.filter._value(Cookie.get(['sip','filter'])!='off'?true:false);this.filter._onchange=function(){this._parent.search._onsearch();Cookie.set(['sip','filter'],this._checked()?'on':'off');};if(this.filter._checked())
this.grid._SQLsearch='has:sip';else
this.grid._SQLsearch='';this.grid._cookiesEnabled=false;this.grid._listen_data('contacts_'+me._pathName,'',true);this.grid._default_columns=function(){return{'LABEL':{"title":'DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS',"width":150,'arg':{'sort':'desc'}},'COMPANY':{"title":'DATAGRID_ITEMS_VIEW::ITMCOMPANY',"width":100},'DEPARTMENT':{"title":'DATAGRID_ITEMS_VIEW::ITMDEPARTMENT',"width":150}};};this.grid._default_values=function(){return['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTPHNHOME1','LCTPHNHOME2','LCTPHNASSISTANT','LCTPHNWORK1','LCTPHNWORK2','LCTPHNFAXHOME','LCTPHNFAXWORK','LCTPHNCALLBACK','LCTPHNCOMPANY','LCTPHNCAR','LCTPHNISDN','LCTPHNMOBILE','LCTPHNOTHER','LCTPHNOTHERFAX','LCTPHNPAGER','LCTPHNPRIMARY','LCTPHNRADIO','LCTPHNTELEX','LCTPHNHEARING','ITMCOMPANY','ITMDEPARTMENT'];};this.grid._serverOrder=function(sColumn,iSortType){var sSort=iSortType?'desc':'asc';return'ITMCLASSIFYAS '+sSort+', ITMTITLE '+sSort+', ITMFIRSTNAME '+sSort+', ITMMIDDLENAME '+sSort+', ITMSURNAME '+sSort+', ITMSUFFIX '+sSort+', ITMCOMPANY '+sSort+', ITMDEPARTMENT '+sSort;};this.grid._onchange=function(v){if(v&&v[0]){var arg=this._aData[v[0]].arg;if(arg){var a={};for(var i in arg)
if(i.indexOf('LCTPHN')==0&&arg[i]&&!a[arg[i]])
if(i=='LCTPHNOTHER'&&arg[i].toLowerCase().indexOf('sip:')==0){var tel=arg.LCTPHNOTHER.substring(arg.LCTPHNOTHER.indexOf(':')+1);a[tel]='['+getLang('PHONE::SIP')+'] '+tel;}
else
a[arg[i]]='['+getLang('PHONE::'+i)+'] '+arg[i];if(arg.LCTEMAIL1)a[arg.LCTEMAIL1]=arg.LCTEMAIL1;if(arg.LCTEMAIL2)a[arg.LCTEMAIL2]=arg.LCTEMAIL2;if(arg.LCTEMAIL3)a[arg.LCTEMAIL3]=arg.LCTEMAIL3;me._value(a);}}};this.grid._onclick=function(e,x,arg){if(e.type=='keydown'&&e.keyCode==13)
me.select._focus();};this.grid._ondblclick=null;this.grid._onkeypress=function(e){var s=String.fromCharCode(e.charCode);if(s&&(s=s.trim())&&!/[\x00-\x1F]/.test(s)){this._parent.search._focus(true);this._parent.search._value(s);}};this.grid._prepareBody=function(aItems,sFolType){var aResult={},sName,sFullName,aRow,aFullNameParts=['ITMTITLE','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX'];if(this._parent._SQLsearch)
var rxp=new RegExp('('+this._parent._SQLsearch+')',"gi");for(var sItId in aItems)
{if(!aItems[sItId]['ITMCLASSIFYAS']){sFullName='';for(var n in aFullNameParts)
if(aItems[sItId][aFullNameParts[n]])
sFullName+=aItems[sItId][aFullNameParts[n]]+' ';sFullName.trim();}
else
sFullName=aItems[sItId]['ITMCLASSIFYAS'];if(this._parent._SQLsearch)
sName=sFullName.replace(rxp,"<b>$1</b>");else
sName=sFullName;aRow={'LABEL':[sName,sFullName],'COMPANY':[aItems[sItId]['ITMCOMPANY']],'DEPARTMENT':[aItems[sItId]['ITMDEPARTMENT']]};aResult[sItId+'#1']={"id":sItId,"data":aRow,"arg":aItems[sItId]};}
return aResult;};this.search._onsearch=function(){var f=this._parent.filter._checked()?'has:sip':'has:phone',v=this._value();this._parent._SQLsearch=v;if(v)
f+=(f?' AND ':'')+'(classify:'+v+' OR company:'+v+' OR department:'+v+' OR name:'+v+' OR email:'+v+')';if(this._parent.grid._SQLsearch===f)return;window[v?'addcss':'removecss'](this._main,'active');this._parent.grid._SQLsearch=f;this._parent.grid._serverSort('','','',[me,'__selectFirst']);};this.search._onkeydown=function(e){if(e.keyCode==13)
this._onsearch();if((e.keyCode==38||e.keyCode==40||e.keyCode==13)&&this._parent.grid._value().length&&this._parent.grid._aData[this._parent.grid._value()[0]])
this._parent.grid._focus();};this.search._placeholder(getLang('FORM_BUTTONS::SEARCH')+'...');this.grid._serverSort({aid:sPrimaryAccount,fid:me._activeFolder},'LABEL','',[me,'__selectFirst']);this.search._focus(true);};_me.__selectFirst=function(){if(!this.grid._selectFirst()){this.search._focus();return false;}
return true;};_me._value=function(v){if(Is.Defined(v)){this.select._fill(v);for(var i in v){this.select._value(i);break;}}
else
return this.select._value()||'';};

/* client/inc/frm_print.js */
_me=frm_print.prototype;function frm_print(){};_me.__constructor=function(){if(currentBrowser()=='Opera'){gui.notifier._value({type:'alert',args:{header:'',text:'PRINT::OPERA'}});this._destruct();return;}
this__template=new cTemplate();this__template.strict=false;var me=this;this._title('PRINT::PREVIEW');this._size(450,500,true);this._create("frame","obj_frame","main");this.__data={};this.__libs=0;var
sHTML="<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n"+'<html lang="'+document.documentElement.lang+'">\n<head>\n'+'\n</head>\n<body></body>\n</html>';this.frame._write(sHTML);AttachEvent(this.frame.__doc,"onclick",function(e){var e=e||window.event,elm=e.srcElement||e.target;if(elm.tagName=='SPAN'&&elm.id&&hascss(elm,'btnx')){var id=elm.id.substr(me._pathName.length+1).split('/');if(me.__data[id[0]])
for(var i=me.__data[id[0]].length-1;i>=0;i--)
if(me.__data[id[0]][i].id==id[1]){me.__data[id[0]].splice(i,1);me._fill(id[0]);break;}}});var link=mkElement('link','',this.frame.__doc);link.setAttribute("type","text/css");link.setAttribute("rel","stylesheet");link.setAttribute("href","client/skins/default/css/frm_print_all.css");link.onload=function(){me.__load()};this.frame.__doc.getElementsByTagName('head')[0].appendChild(link);link=mkElement('link','',this.frame.__doc);link.setAttribute("type","text/css");link.setAttribute("rel","stylesheet");link.setAttribute("media","print");link.setAttribute("href","client/skins/default/css/frm_print_print.css");link.onload=function(){me.__load()};this.frame.__doc.getElementsByTagName('head')[0].appendChild(link);link=null;this._create('x_btn_ok','obj_button','footer','ok noborder color1');this.x_btn_ok._value('MAIN_MENU::PRINT');this.x_btn_ok._onclick=function(){me.frame._print();};this._create('x_btn_cancel','obj_button','footer','cancel noborder simple');this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct()};};_me._add=function(sType,aData){if(sType){this.__data[sType]=this.__data[sType]||[];if(Is.Array(aData)){if(aData.EVNNOTE)
aData.EVNNOTE=mkElement('div',{innerHTML:aData.EVNNOTE}).innerHTML;else
if(aData.NOTE_TEXT)
aData.NOTE_TEXT=mkElement('div',{innerHTML:aData.NOTE_TEXT}).innerHTML;for(var i in aData){aData[i]=this.__parse(sType,aData[i]);this.__data[sType].push({id:unique_id(),data:aData[i],out:this__template.tmp('print_'+sType.toLowerCase(),aData[i])});}}
else{if(aData.EVNNOTE)
aData.EVNNOTE=mkElement('div',{innerHTML:aData.EVNNOTE}).innerHTML;else
if(aData.NOTE_TEXT)
aData.NOTE_TEXT=mkElement('div',{innerHTML:aData.NOTE_TEXT}).innerHTML;aData=this.__parse(sType,aData);this.__data[sType].push({id:unique_id(),data:aData,out:this__template.tmp('print_'+sType.toLowerCase(),aData)});}
this._fill(sType);}};_me._fill=function(sType){if(sType){var elm=this.frame.__doc.getElementById(sType);if(Is.Empty(this.__data[sType])){if(elm)
elm.parentNode.removeChild(elm);delete this.__data[sType];return;}
var html='';switch(sType){case'C':this.__data[sType].sort(function(a,b){if(a.data.ITMSURNAME>b.data.ITMSURNAME)
return 1;else
if(a.data.ITMSURNAME<b.data.ITMSURNAME)
return-1;else
if(a.data.ITMCLASSIFYAS>b.data.ITMCLASSIFYAS)
return 1;else
if(a.data.ITMCLASSIFYAS<b.data.ITMCLASSIFYAS)
return-1;else
return 0;});var last,s;for(var i in this.__data[sType]){s=(this.__data[sType][i].data.ITMSURNAME||this.__data[sType][i].data.ITMCLASSIFYAS||'').trim().charAt(0).toUpperCase();html+='<div class="card">';if(last!=s){last=s;html+='<div class="char">'+(last||'...')+'</div>';}
html+='<span class="btnx" id="'+this._pathName+'/'+sType+'/'+this.__data[sType][i].id+'"></span>'+this.__data[sType][i].out+'</div>';}
break;default:for(var i in this.__data[sType])
html+='<div class="card"><span class="btnx" id="'+this._pathName+'/'+sType+'/'+this.__data[sType][i].id+'"></span>'+this.__data[sType][i].out+'</div>';}
if(!elm){elm=mkElement('div',{id:sType},this.frame.__doc);this.frame.__doc.body.appendChild(elm);}
elm.innerHTML=html;}
this._focus();};_me.__parse=function(sType,aData){switch(sType){case'T':if(aData.EVNENDDATE){aData.evnenddate=IcewarpDate.julian(aData.EVNENDDATE).format('L');}
if(aData.EVNSTARTDATE){aData.evnstartdate=IcewarpDate.julian(aData.EVNSTARTDATE).format('L');}
if(aData.EVNSTATUS){aData.evnstatus=getLang({I:'TASK::IN_PROGRESS',N:'TASK::WAITING',B:'TASK::NOT_STARTED',M:'TASK::COMPLETED',Q:'TASK::DEFERRED'}[aData.EVNSTATUS]);switch(aData.EVNSTATUS){case'I':case'Q':case'N':if(aData.EVNCOMPLETE*1>0){aData.evncomplete=(aData.EVNCOMPLETE*1)+'%';}}}
break;case'C':if(aData.ITMBDATE){if(+aData.ITMBDATE)
aData.ITMBDATE=IcewarpDate.julian(aData.ITMBDATE).format('L');else
delete aData.ITMBDATE;}
if(aData.ITMGENDER){switch(aData.ITMGENDER){case'1':aData.ITMGENDER=getLang('CONTACT::MALE');break;case'2':aData.ITMGENDER=getLang('CONTACT::FEMALE');break;default:delete aData.ITMGENDER;}}}
return aData;};_me.__load=function(){this.__libs++;if(this.__libs==2&&GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){storage.library('night_mode');NightMode(this.frame.__eFrame.contentWindow).activate();}};

/* client/inc/frm_propose.js */
_me=frm_propose.prototype;function frm_propose(){};_me.__constructor=function(aItem,aIMIP,aHandler){this._size(750,570,true);this._dockable(false);this._closable(true);this._title('MAIL_VIEW::PROPOSE');this._draw('frm_propose','main');this.__aItem=clone(aItem,true);var DS=new cDataSet();DS.add('imip','',aIMIP.VCALENDAR[0]);var owner=DS.get('imip',['VEVENT',0,'ORGANIZER',0,'VALUE']).replace(/^mailto\:/ig,'');this._create('X_SCHEDULE','obj_schedule','body','',owner,true,null,true);var tmp=DS.get('imip',['VEVENT',0,'ATTENDEE']),aAtt=[],aRConv={'REQ-PARTICIPANT':'Q','OPT-PARTICIPANT':'T'},aSConv={'NEEDS-ACTION':'B','ACCEPTED':'A','DECLINED':'D','TENTATIVE':'T','DELEGATED':'E'};for(var i=0;i<tmp.length;i++)
aAtt.push({values:{CNTEMAIL:tmp[i].VALUE,CNTCONTACTNAME:tmp[i].ATTRIBUTES.CN||'',CNTROLE:aRConv[(tmp[i].ATTRIBUTES.ROLE||'').toUpperCase()]||'Q',CNTSTATUS:aSConv[(tmp[i].ATTRIBUTES.PARTSTAT||'').toUpperCase()]||'N',CNTRSVP:(tmp[i].ATTRIBUTES.RSVP||'').toUpperCase()=='TRUE'?1:0,CNTEXPECT:''}});this.X_SCHEDULE._attendees(aAtt);var tmp=DS.get('imip',['VEVENT',0,'DTSTART',0]),time=tmp.VALUE.indexOf('T')>-1;var a=(tmp.ATTRIBUTES&&tmp.ATTRIBUTES['X-UNIXTIME'])?IcewarpDate.unix(tmp.ATTRIBUTES['X-UNIXTIME']):new IcewarpDate(tmp.VALUE);var tmp=DS.get('imip',['VEVENT',0,'DTEND',0]);var b=(tmp.ATTRIBUTES&&tmp.ATTRIBUTES['X-UNIXTIME'])?IcewarpDate.unix(tmp.ATTRIBUTES['X-UNIXTIME']):new IcewarpDate(tmp.VALUE);var old={EVNSTARTDATE:a.format(IcewarpDate.JULIAN),EVNSTARTTIME:time?a.format(IcewarpDate.JULIAN_TIME):-1,EVNENDDATE:b.format(IcewarpDate.JULIAN),EVNENDTIME:time?b.format(IcewarpDate.JULIAN_TIME):-1,EVNTIMEFORMAT:'Z'};this.X_SCHEDULE.X_TIMEINTERVAL._value(old,true);this.X_SCHEDULE.X_TIMEINTERVAL._onchange=function(noSync){var v=this._value();if(noSync||v.EVNSTARTDATE!=old.STARTDATE||v.EVNSTARTTIME!=old.STARTTIME||v.EVNENDDATE!=old.ENDDATE||v.EVNENDTIME!=old.ENDTIME){old.STARTDATE=v.EVNSTARTDATE;old.STARTTIME=v.EVNSTARTTIME;old.ENDDATE=v.EVNENDDATE;old.ENDTIME=v.EVNENDTIME;this._parent.X_TIMETABLE._value(old);}};this.X_SCHEDULE.X_TIMEINTERVAL._onchange(true);document.querySelector(':focus')||this.X_SCHEDULE.X_TIMEINTERVAL.startTime.__eIN.focus();this.x_btn_ok._onclick=function(){aItem.gwparams=this._parent.X_SCHEDULE.X_TIMEINTERVAL._value();WMItems.imip(aItem,'propose',aHandler);this._parent._destruct();};};

/* client/inc/frm_public_url.js */
_me=frm_public_url.prototype;function frm_public_url(){}
_me.__sendAsEmail=function(sEmail,aIds){var email=MailAddress.splitEmailsAndNames(sEmail);if(email&&(email=email[0])&&(email=email.email)){WMItems.action({aid:aIds[0],fid:aIds[1],iid:aIds[2][0].replace('*',''),values:{EMAIL:email}},'notify_item',[function(bOK){if(bOK){gui.notifier._value({type:'message_sent'});this._destruct();}else{this.search&&this.search.__eIN&&this.search.__eIN.select();}}.bind(this)]);}};_me.__constructor=function(aIds,sURL){this._title('MAIN_MENU::SHARE');this._size(680,170,true);this._resizable(false);this._dockable(false);var sURL=sURL||Item.getPublicUrl([aIds[0],aIds[1],aIds[2][0]]);var send_as_email=!~['C','E','N','T'].indexOf(WMFolders.getType(aIds))&&(!TeamChatAPI||!TeamChatAPI.teamChatOnly())&&!sPrimaryAccountGUEST;if(send_as_email){var label1=document.createElement('div');label1.textContent=getLang('popup_items::send_as_email');label1.classList.add('label');this._create('search','obj_suggest_mail','main','obj_input_100');this.search._single=true;var input1_cell=document.createElement('div');input1_cell.classList.add('cell');input1_cell.classList.add('stretch');input1_cell.appendChild(this.search._main);var button1=document.createElement('button');button1.classList.add('email_address_send');button1.textContent=getLang('compose::send');button1.addEventListener('click',function(){this.__sendAsEmail(this.search.__eIN.value,aIds);}.bind(this));var button1_cell=document.createElement('div');button1_cell.classList.add('cell');button1_cell.appendChild(button1);var inner_table1=document.createElement('div');inner_table1.classList.add('table');inner_table1.appendChild(input1_cell);inner_table1.appendChild(button1_cell);var column1=document.createElement('div');column1.classList.add('cell');column1.classList.add('stretch_half');column1.appendChild(label1);column1.appendChild(inner_table1);var label2=document.createElement('div');label2.classList.add('or');label2.textContent=getLang('common::or');var column2=document.createElement('div');column2.classList.add('cell');column2.classList.add('separator');column2.appendChild(label2);}
var label3=document.createElement('div');label3.textContent=getLang('item::share');label3.classList.add('label');var input2=document.createElement('input');input2.value=sURL;input2.setAttribute('readonly','readonly');input2.classList.add('link');input2.classList.add('stretch');input2.addEventListener('click',function(){input2.select();});var input2_cell=document.createElement('div');input2_cell.classList.add('cell');input2_cell.classList.add('stretch');input2_cell.appendChild(input2);var button2=document.createElement('button');button2.classList.add('link_copy');button2.textContent=getLang('popup_items::copy');button2.addEventListener('click',function(){input2.select();try{if(!document.queryCommandSupported('copy')){throw new Error('Unsupported command "copy"');}
if(!document.queryCommandEnabled('copy')){throw new Error('Command "copy" disabled');}
if(!document.execCommand('copy')){throw new Error('Unable to copy mail to clipboard. Press CTRL + C to copy');}}catch(err){console.log(err);}
gui.notifier&&gui.notifier._value({type:'clipboard_link'});this._destruct();}.bind(this));var button2_cell=document.createElement('div');button2_cell.classList.add('cell');button2_cell.appendChild(button2);var inner_table2=document.createElement('div');inner_table2.classList.add('table');inner_table2.appendChild(input2_cell);inner_table2.appendChild(button2_cell);var column3=document.createElement('div');column3.classList.add('cell');column3.classList.add('stretch_half');column3.appendChild(label3);column3.appendChild(inner_table2);var table=document.createElement('div');table.classList.add('table');if(send_as_email){table.appendChild(column1);table.appendChild(column2);}
table.appendChild(column3);this.__eMain.appendChild(table);};

/* client/inc/frm_reactions.js */
_me=frm_reactions.prototype;function frm_reactions(){}
_me.__constructor=function(aData,sInitTab){this._size(450,400,true);this._modal(true);this._dockable(false);this._resizable(false);this._title('CHAT::REACTIONS');this.__reactions={};this.__start=sInitTab;this._create('tabs','obj_tabs','main','ico small nobuttons transparent');if(aData.REACTIONS)
this._fill(aData.REACTIONS);else{this._create('loading','obj_loader');var iid=aData.iid;if(aData.EVNLINKTYPE=='10')
iid=aData.EVNLINKID?WMItems.__clientID(aData.EVNLINKID):aData.iid;var aItemsInfo={aid:aData.aid,fid:aData.fid,iid:iid,values:['REACTIONS']};WMItems.list(aItemsInfo,'','','',[function(aResponse){if(aResponse&&(aResponse=aResponse[aData.aid])&&(aResponse=aResponse[aData.fid])&&(aResponse=aResponse[iid])){aData.REACTIONS=aResponse.REACTIONS;this._fill(aData.REACTIONS);}
else
this._destruct();}.bind(this)]);}
this._create('x_btn_ok','obj_button','footer','noborder ok');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){this._destruct();}.bind(this);this.x_btn_ok._focus();};_me._fill=function(aData){if(this.loading)
this.loading._destruct();var ar={'*':{}};for(var id in aData)
if(aData[id]&&aData[id].values){if(!ar[aData[id].values.REAVALUE])
ar[aData[id].values.REAVALUE]={};ar[aData[id].values.REAVALUE][id]=aData[id].values;ar['*'][id]=aData[id].values;}
this.__reactions=ar;for(var sName in ar){tab=this.tabs._create('tab','obj_tab','main',(sName=='*'?'all':'ico ico_'+sName.replace(/\s+/g,'_')));tab.__reaction=sName;if(sName=='*'){tab._value(getLang('COMMON::ALL')+' '+count(aData),true);this._fill_list(tab);}
else
tab._value(count(ar[sName]),true);tab._onactive=function(bFirstTime){if(bFirstTime){this._parent._parent._fill_list(this);}};if(this.__start==sName)
tab._active();}};_me._fill_list=function(tab){if(tab){if(!tab.list)
tab._create('list','obj_list');var arr=this.__reactions[tab.__reaction||'*']||{},aData=[],elm=mkElement('div');for(var id in arr){elm.appendChild(mkElement('span',{className:'avatar',style:{backgroundImage:'url("'+getAvatarURL(arr[id].REAOWNEMAIL)+'")'}}));elm.appendChild(mkElement('span',{className:'label',innerHTML:arr[id].REAOWNNAME}));aData.push({html:elm.innerHTML});elm.innerHTML='';}
tab.list._fill(aData);}};

/* client/inc/frm_reauth.js */
_me=frm_reauth.prototype;function frm_reauth(){};_me.__constructor=function(){this._title('CONFIRMATION::AUTHENTICATION');this._resizable(false);this._dockable(false);this._closable(false);this._modal(true);this._size(450,350,true);this._draw('frm_reauth','main');this._create('x_btn_ok','obj_button','footer','noborder color1 ok');this.x_btn_ok._value('FORM_BUTTONS::SIGN_IN');this.x_btn_ok._onclick=function(){var p=this._parent,v=p.x_password._value();if(p.x_password._checkError.length===0){p._create('loader','obj_loader');auth.reconnect(dataSet.get('main',['user']),v,[function(bOk){if(bOk)
p._destruct();else{p.loader&&p.loader._destruct();gui.notifier._value({type:'alert',args:{header:'CONFIRMATION::AUTHENTICATION',text:'ALERTS::PASSWORD_INCORRECT'}});p.x_password._setRange(0,v.length);}}]);}};this.x_password._onsubmit=function(){this._parent.x_btn_ok._onclick();};this.x_password._onerror=function(b){this._parent.x_btn_ok._disabled(b);};this.x_password._restrict(/.+/);this._create('x_btn_cancel','obj_button','footer','noborder cancel color2 x_btn_right simple');this.x_btn_cancel._value('MAIN_MENU::LOGOUT');this.x_btn_cancel._onclick=function(){dataSet.add('main',['sid'],'');gui.frm_main.__logout();};this._size(450,Math.max((this.__eMain.scrollHeight||this.__eMain.clientHeight)+90,350),true);};

/* client/inc/frm_reminder.js */
_me=frm_reminder.prototype;function frm_reminder(){};_me.__constructor=function(){var me=this;this._size(500,350,true);this._closable(false);this._title('REMINDER::REMINDER');this._draw('frm_reminder','footer',{conference:sPrimaryAccountCONFERENCE});this._create('grid','obj_datagrid','','noborder');this.grid._select_single=true;this.grid._addColumns({'CHECK':{width:30,type:'static',css:'check'},'TYPE':{width:20,type:'static',css:'ico type'},'EVNTITLE':{title:'DATAGRID_ITEMS_VIEW::EVNTITLE','width':100,mode:'%','arg':{'sort':'asc'},encode:true},'EVENT_STARTDATE':{title:'DATAGRID_ITEMS_VIEW::EVENT_STARTDATE','width':120,'arg':{'sort':'desc'}},'BUTTON':{width:34,type:'static',css:'ico button'}});this.grid._onclick=function(e,elm,arg,id,col,aClickType){switch(col){case'CHECK':if(this._aData[id])
this._aData[id].arg.checked=!arg.checked;me._fill();break;case'BUTTON':if(sPrimaryAccountCONFERENCE&&arg.conferenceid){storage.library('wm_conference');wm_conference.get(arg.conferenceid).join();if(arg.rid)
WMItems.reminders({rid:[arg.rid]},[me,'__handler']);}
break;}};this.grid._ondblclick=function(e,elm,arg,id,col,aClickType){if(col!='CHECK'&&arg&&arg.iid)
Item.openwindow([arg.aid,arg.fid,arg.iid]);};this.btn_snooze._onclick=function(){var aID=me.__getIds();if(aID.length){me.snooze._disabled(true);me.btn_snooze._disabled(true);me.btn_dismiss._disabled(true);WMItems.reminders({rid:aID,snooze:me.snooze._value()},[me,'__handler']);}};this.btn_dismiss._onclick=function(){var aID=me.__getIds();if(aID.length){me.snooze._disabled(true);me.btn_snooze._disabled(true);me.btn_dismiss._disabled(true);WMItems.reminders({rid:aID},[me,'__handler']);}};this.btn_dismiss._focus();};_me.__getIds=function(bAll){var aID=[];if(this.grid._aData)
for(var i in this.grid._aData)
if(this.grid._aData[i].arg&&(this.grid._aData[i].arg.checked||bAll))
aID.push(this.grid._aData[i].arg.rid);return aID;};_me._fill=function(aData){if(Is.Defined(aData))
this._aData=aData;else
aData=this._aData;var out={};for(var i in aData){aData[i].checked=!this.grid._aData||!this.grid._aData[i]||this.grid._aData[i].arg.checked;out[i]={data:{EVNTITLE:(aData[i].title||getLang('EVENT_VIEW::NOTITLE')),BUTTON:(sPrimaryAccountCONFERENCE&&aData[i]['conferenceid']?['','',getLang(typeof aData[i].organizer!='string'||aData[i].organizer.indexOf('@')==-1||MailAddress.splitEmailsAndNames(aData[i].organizer)[0].email==sPrimaryAccount?'CONFERENCE::START':'CONFERENCE::JOIN')]:'')},css:'reminder_'+aData[i]['class']+(sPrimaryAccountCONFERENCE&&aData[i]['conferenceid']?' conference':'')+(aData[i].checked?' checked':''),arg:aData[i]}
out[i].data.EVENT_STARTDATE=CalendarFormatting.formatStartDate(aData[i]);if(gui.frm_main&&gui.frm_main.title&&(!this.grid._aData||!this.grid._aData[i]))
gui.frm_main.title._add(getLang('TITLE::NEW_REMINDER',[aData[i].title||getLang('EVENT_VIEW::NOTITLE')]),5);}
if(Is.Empty(out))
this._destruct();else
this.grid._fill(out);};_me.__handler=function(){dataSet.remove('reminders',null,true);this._destruct();gui.frm_main.__RMN_get();};

/* client/inc/frm_revision.js */
_me=frm_revision.prototype;function frm_revision(){};_me.__constructor=function(aItemInfo,bFrm){var me=this;this._title('ITEM::NEW_REVISION');this._defaultSize(-1,-1,400,200);this._modal(true);if(bFrm){me.x_btn_ok._value('FORM_BUTTONS::REVISION');me.x_btn_cancel._value('FORM_BUTTONS::SKIP');}
this._create('text','obj_text','main','obj_text100 noborder');this.text._placeholder(getLang('COMMON::COMMENT'));this.text._onsubmit=function(){me.x_btn_ok._onclick();};this.text._tabIndex();this.x_btn_ok._tabIndex();this.x_btn_cancel._tabIndex();this.x_btn_ok._onclick=function(){me.__hide();WMItems.add([aItemInfo.aid,aItemInfo.fid,aItemInfo.iid],{revisions:[{values:{revcomment:me.text._value()}}]},'','','',[function(bOK){if(bOK==false)
gui.notifier._value({type:'alert',args:{header:'',text:'ALERTS::CREATE_REVISION'}});else
if(gui.notifier)
gui.notifier._value({type:'new_revision'});if(gui.frm_main.main&&gui.frm_main.main.itemview&&dataSet.get('preview',[aItemInfo.aid,aItemInfo.fid,aItemInfo.iid])){dataSet.remove('preview','',true);Item.open([aItemInfo.aid,aItemInfo.fid,aItemInfo.iid]);}
me._destruct();}]);};this.text._focus();};

/* client/inc/frm_rule.js */
_me=frm_rule.prototype;function frm_rule(){};_me.__constructor=function(aValues,aResponse)
{var me=this;this._size(860,470,true);this._modal(true);this._title('FILTERS::RULE');this.__sSelectedLine;this.__orderOfLines=[];this._draw('frm_rule','main',{disable_fw:GWOthers.getItem('RESTRICTIONS','disable_forwarder')>0});msiebox(this._getAnchor('msiebox'));msiebox(this.maintab.filters._getAnchor('msiebox'));this.maintab.filters.x_add._onclick=function(){me.__addLine(true);};this.__unselectLine();this.maintab.filters.x_delete._onclick=function(){me.__deleteLine(me.__sSelectedLine);};this.maintab.filters.x_up._onclick=function(){me.__moveUpLine(me.__sSelectedLine);};this.maintab.filters.x_down._onclick=function(){me.__moveDownLine(me.__sSelectedLine);};this.x_btn_ok._onclick=function(){var aConditions=[];for(var i in me.__orderOfLines)
aConditions.push(me.maintab.filters[me.__orderOfLines[i]]._value());if(!count(aValues))
aValues['ACTIVE']=[{'VALUE':1}];aValues['CONDITION']=aConditions;if(me.title._value().trim())
aValues['TITLE']=[{'VALUE':me.title._value().trim()}];else
delete aValues['TITLE'];if(me.maintab&&me.maintab.actions&&me.maintab.actions._wasActivated)
arrConcat(aValues,me.maintab.actions.actions._value());if(Is.Defined(aResponse))executeCallbackFunction(aResponse,aValues);me._destruct();};if(Is.Defined(aValues['TITLE']))
this.title._value(aValues['TITLE'][0]['VALUE']);for(var i in aValues['CONDITION']){var oNewLine=this.__addLine();if(oNewLine)
oNewLine._value(aValues['CONDITION'][i]);}
this.maintab.actions._onactive=function(bFirstTime){if(bFirstTime)
this.actions._value(aValues);};};_me.__unselectLine=function(){this.__sSelectedLine=undefined;this.maintab.filters.x_delete._disabled(true);this.maintab.filters.x_up._disabled(true);this.maintab.filters.x_down._disabled(true);};_me.__selectLine=function(sName){if(this.__sSelectedLine)
removecss(this.maintab.filters[this.__sSelectedLine]._main,'active');addcss(this.maintab.filters[sName]._main,'active');this.__sSelectedLine=sName;this.maintab.filters.x_delete._disabled(false);this.maintab.filters.x_up._disabled(false);this.maintab.filters.x_down._disabled(false);};_me.__addLine=function(bUserDefined){if(this.__orderOfLines.length>9)
return;var me=this;this.maintab.filters._anchors['filters']=this.maintab.filters._pathName+'#filters';var aLine=this.maintab.filters._create('filter','obj_filter_line','filters','',(bUserDefined)?'from':false);aLine._main.onclick=function(){me.__selectLine(aLine._name);}
if(this.__orderOfLines.length==0)
aLine._hideLogicalOperators();this.__orderOfLines.push(aLine._name);return aLine;};_me.__deleteLine=function(sName){var index;if((index=this.__findLine(sName))<0)return;for(var i=index;i<this.__orderOfLines.length-1;i++){this.__orderOfLines[i]=this.__orderOfLines[i+1];}
this.__orderOfLines.pop();this.__unselectLine();this.maintab.filters[sName]._destruct();if(index==0&&this.__orderOfLines.length>0)
this.maintab.filters[this.__orderOfLines[0]]._hideLogicalOperators();};_me.__moveUpLine=function(sName){var index;if((index=this.__findLine(sName))<=0)return;this.__swapLines(index-1,index);if(index==1){this.maintab.filters[this.__orderOfLines[0]]._hideLogicalOperators();this.maintab.filters[this.__orderOfLines[1]]._showLogicalOperators();}};_me.__moveDownLine=function(sName){var index;if((index=this.__findLine(sName))<0||index>=this.__orderOfLines.length-1)return;this.__swapLines(index,index+1);if(index==0){this.maintab.filters[this.__orderOfLines[0]]._hideLogicalOperators();this.maintab.filters[this.__orderOfLines[1]]._showLogicalOperators();}};_me.__swapLines=function(i1,i2){var elm1=this.maintab.filters[this.__orderOfLines[i1]]._main;var elm2=this.maintab.filters[this.__orderOfLines[i2]]._main;var elm3=elm2.nextSibling;var parn=elm1.parentNode;parn.removeChild(elm2);parn.insertBefore(elm2,elm1);parn.removeChild(elm1);if(elm3)
parn.insertBefore(elm1,elm3);else
parn.appendChild(elm1);elm1=elm2=elm3=parn=null;var tmp=this.__orderOfLines[i1];this.__orderOfLines[i1]=this.__orderOfLines[i2];this.__orderOfLines[i2]=tmp;};_me.__findLine=function(sName){for(var i in this.__orderOfLines){if(this.__orderOfLines[i]==sName)
return parseInt(i);}
return-1;};

/* client/inc/frm_select_account.js */
_me=frm_select_account.prototype;function frm_select_account(){};_me.__constructor=function(aResponse){this._modal(true);var me=this;this._title('SETTINGS::ACCOUNTS');this._size(300,500,true);this._create('tree_folder','obj_tree','main','folder_icons');var aFolders=dataSet.get('folders',[sPrimaryAccount]),aData={};for(var fid in aFolders){if(aFolders[fid].SUBSCRIPTION_TYPE=='account'&&fid.indexOf(sPrimaryAccountSPREFIX)===0&&!aFolders[fid].PUBLIC&&(aFolders[fid].TYPE=='VA'||aFolders[fid].TYPE=='X')&&aFolders[fid+'/INBOX']){var sMail=fid.substr(sPrimaryAccountSPREFIX.length);aData[sMail]={arg:{aid:sPrimaryAccount,fid:fid},text:aFolders[fid].NAME||sMail,ico:'ico_inbox'};}}
this.tree_folder._fill(aData);this.tree_folder._onactivate=function(){me.x_btn_ok._disabled(false);};this.x_btn_ok._disabled(true);this.x_btn_ok._onclick=function()
{var aSelected=me.tree_folder._getActive();executeCallbackFunction(aResponse,aSelected[0]);me._destruct();};};

/* client/inc/frm_select_folder.js */
_me=frm_select_folder.prototype;function frm_select_folder(){};_me.__constructor=function(sMainLabel,sAccountID,sFolderID,aResponse,bDisableAccounts,bOneAccount,sFilterType,sFilterRights,bDisableNewButton,sFilterRightsOr,bFilterPublic,bForceShowFolderIcons){this._modal(true);var me=this,sFullFolderPath='',aFilterType=Array.isArray(sFilterType)?sFilterType:(sFilterType||'').split(',').filter(Boolean),bAlfresco=~aFilterType.indexOf('K');if(sMainLabel)
this._title(sMainLabel);if(bDisableNewButton||bAlfresco)
this._size(300,500,true);else
this._size(350,500,true);if(bAlfresco){this._create('tree_folder','obj_tree_folder','main','alfresco_folder noroot','@@alfresco@@');this.tree_folder._listen_data('alfresco');this.tree_folder._onclick=function(e,elm,id){var aPath=Path.split(id,true);Alfresco.getFolderInfo(aPath.fid,[function(bOK,aFolder){if(bOK)
Alfresco.setLastFolder(aFolder.fid);}]);};}
else{this._create('tree_folder','obj_tree_folder2',void 0,bForceShowFolderIcons?'icons':'',sAccountID&&bOneAccount?sAccountID:void 0);}
if(sAccountID)
{if(sAccountID==sPrimaryAccount&&sFolderID=='__@@VIRTUAL@@__/__@@EVENTS@@__')
sFolderID=Mapping.getDefaultFolderForGWType('E');if(bOneAccount)
this.tree_folder.sFilterAccountId=sAccountID;}
if(bFilterPublic)
this.tree_folder._filter_public(true);if(sFilterRights)
this.tree_folder._filter_rights(sFilterRights);if(sFilterRightsOr)
this.tree_folder._filter_rights_or(sFilterRightsOr);if(sFolderID)
sFullFolderPath=sAccountID+'/'+sFolderID;else
if(bAlfresco)
sFullFolderPath=Alfresco.getLastFolder(true);else{sFullFolderPath=aFilterType.map(function(ft){return Cookie.get(['last_used_folder',ft]);}).filter(function(fp){return!!fp;})||sAccountID;}
if(bAlfresco){Alfresco.getFolderInfo();if(sFullFolderPath){var aPath=Path.split(sFullFolderPath,true);if(aPath.fid){Alfresco.getFolderInfo(aPath.fid,[function(bOK,aFolder){if(bOK&&aFolder.fid.length){this.tree_folder._setActive(Path.build(aFolder));}}.bind(this)]);}}}
else{if(aFilterType.length)
this.tree_folder._filter_folder(aFilterType);this.tree_folder._setActive(sFullFolderPath);this.tree_folder._listen_cookie('select_folder_tree');}
if((sAccountID&&bOneAccount)||aFilterType.length){this.tree_folder._fill();}
if(sFullFolderPath){this.tree_folder._open(sFullFolderPath,'minus');}
else{var ds=dataSet.get('folders');for(var sFullFolderPath in ds)
this.tree_folder._open(sFullFolderPath,'minus');}
if(bDisableAccounts)
{if(this.tree_folder._getActive()[1])
this.x_btn_ok._disabled(false);else
this.x_btn_ok._disabled(true);this.tree_folder._obeyEvent('activate',[function(e){var path=me.tree_folder._getActive(true);if(path.fid.length)
me.x_btn_ok._disabled(false);else
me.x_btn_ok._disabled(true);}]);}
this.x_btn_ok._onclick=function()
{var aSelected=me.tree_folder._getActive();if(aFilterType.length){var folderType=WMFolders.getType({aid:aSelected[0],fid:aSelected[1]});Cookie.set(['last_used_folder',folderType],aSelected[0]+'/'+aSelected[1]);}else{Cookie.set(['last_used_folder',''],aSelected[0]+'/'+aSelected[1]);}
executeCallbackFunction(aResponse,aSelected[0],aSelected[1]);me._destruct();};if(!bDisableNewButton&&!bAlfresco){this._create('x_btn_new_folder','obj_button','footer','simple noborder x_btn_right');this.x_btn_new_folder._value('FORM_BUTTONS::NEW_FOLDER');this.x_btn_new_folder._onclick=function(){var aSelected=me.tree_folder._getActive();gui._create('frm_add_folder','frm_add_folder','','',aSelected[0]||sPrimaryAccount,aSelected[1],void 0,bOneAccount);};}
this.tree_folder.inp_search._placeholder(getLang('POPUP_FOLDERS::FILTER_FOLDERS'));this.tree_folder.inp_search._focus(true);};

/* client/inc/frm_send_by_email.js */
function frm_send_by_email(){};frm_send_by_email.prototype.__constructor=function(aHandler,sEmails,bIsModal){var me=this;this.__sEmails=sEmails;this._modal(bIsModal);this._resizable(false);this._title(getLang('COLLABORATION::SEND_BY_EMAIL'),true);this._draw('frm_send_by_email','main');this._size(700,'auto',true);this._fill();this.send._onclick=function(){executeCallbackFunction(aHandler,me.to._value().split(',').filter(Boolean));me._destruct();};this.address_book._onclick=function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],void 0,void 0,void 0,void 0,true,me._isModal());};};frm_send_by_email.prototype._fill=function(){this.to._value(this.__sEmails||'');};frm_send_by_email.prototype.__onAddNewFromAddressbook=function(bOK,aAddresses){if(bOK&&aAddresses&&aAddresses[0]){var emails=this.to._value().split(',');for(var i in aAddresses[0]){emails.push(aAddresses[0][i]);}
this.__sEmails=emails.filter(function(v,i,s){return s.indexOf(v)===i;}).join(',');this._fill();}};

/* client/inc/frm_send_message.js */
_me=frm_send_message.prototype;function frm_send_message(){};_me.__constructor=function(aValues){var me=this;this._size(400,330,true);this._modal(true);this._title('FILTERS::MESSAGE');this._draw('frm_send_message','main');var aTransformedValues={};for(var i in aValues)
aTransformedValues[i]=aValues[i][0]['VALUE'];loadDataIntoForm(this,aTransformedValues);this.x_btn_ok._onclick=function(){var aTransformedValues={};storeDataFromForm(me,aTransformedValues);if(aTransformedValues['SENDTYPE']=='0')aTransformedValues['SENDTYPE']='';for(var i in aTransformedValues)
if(aTransformedValues[i]!='')
aValues[i]=[{'VALUE':aTransformedValues[i]}];else
delete aValues[i];me._destruct();};this.FROM._focus();};

/* client/inc/frm_settings.js */
_me=frm_settings.prototype;function frm_settings(){};_me.__constructor=function(sTab1,sTab2)
{var me=this;sTab1=sTab1||'general_settings';if(sPrimaryAccountGUEST)
this._defaultSize(-1,-1,400,430);else
this._defaultSize(-1,-1,780,620);this._title('MAIN_MENU::OPTIONS');storage.library('night_mode');storage.library('wm_storage');storage.library('gw_others');storage.library('wm_import');storage.library('frm_settings_helper');this._others=new gw_others;this.resources=['skins','global_settings','autoresponder','forwarder','certificate','antispam','languages','spellchecker_languages','restrictions','signature','aliases','read_confirmation','documents','gw_mygroup','sip','call_forwarding','default_folders','weather','licenses','teamchat_notify','layout_settings'];if(sPrimaryAccountGW>0)
this.resources.push('holidays');if(sPrimaryAccountIM>0)
this.resources.push('im');WMStorage.get({'resources':this.resources},'storage','',[this,'__loadItems',[sTab1,sTab2]],true);this._curLanguage=GWOthers.getItem('LAYOUT_SETTINGS','language');this.x_btn_ok._onclick=function(){if(GWOthers.getItem('LAYOUT_SETTINGS','language')!=me._curLanguage)
gui.notifier._value({type:'alert',args:{header:'',text:'LANGUAGES::ONCHANGE_INFO'}});if(me.maintab&&me.maintab.account_settings){var oAccountTab=me.maintab.account_settings;if(oAccountTab&&oAccountTab._wasActivated&&oAccountTab.maintab){me.__saveAccounts();return;}}
if(me.__value){return gui._create('confirm','frm_confirm','','',[function(){me.__saveItems();}],'BACKUP::IMPORT_IN_PROGRESS','BACKUP::IMPORT_IN_PROGRESS_HELPER');}
me.__saveItems();};this.__helper=new FrmSettingsHelper(false,false);};_me.__loadItems=function(aData,sTab1,sTab2)
{var me=this;this.__oldData=dataSet.get('storage','',true);this.__state={};this.__otherAccounts={};var aAccounts=dataSet.get('accounts');for(var i in aAccounts){var acc=clone(aAccounts[i]);this.__state[i]='old';if(acc['PRIMARY'])
this.__primaryAccount=acc;else
if(acc.TYPE!='rss')
this.__otherAccounts[i]=acc;}
var drw_arr={'settings':true,'chat_access':sPrimaryAccountCHAT>0,'im_access':sPrimaryAccountIM>0&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1,'sip_access':sPrimaryAccountSIP>0&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1,'allow_call_forwarding':sPrimaryAccountSIP>0&&(GWOthers.getItem('RESTRICTIONS','disable_call_forwarding')||0)<1,'esip_access':sPrimaryAccountSIP>0&&(GWOthers.getItem('RESTRICTIONS','disable_esip')||0)<1,'gw_access':sPrimaryAccountGW>0,'rules':sPrimaryAccountRULES>0&&(GWOthers.getItem('RESTRICTIONS','disable_rules')||0)<1,'disable_personalities':GWOthers.getItem('RESTRICTIONS','disable_personalities')>0,'disable_forwarder':GWOthers.getItem('RESTRICTIONS','disable_forwarder')>0,'disable_new_aliases':(GWOthers.getItem('RESTRICTIONS','disable_new_aliases')||0)<1,'disable_keep_emails':GWOthers.getItem('RESTRICTIONS','disable_keep_emails')>0,'disable_autoresponder':GWOthers.getItem('RESTRICTIONS','disable_autoresponder')>0,'disable_antispam':GWOthers.getItem('RESTRICTIONS','disable_antispam')>0,'allow_delay_send':sPrimaryAccountSMTP==1,'disable_licenses':GWOthers.getItem('RESTRICTIONS','disable_licenses')>0,'disable_doc_editing':GWOthers.getItem('RESTRICTIONS','disable_doc_editing')>0,'disable_smart':GWOthers.getItem('RESTRICTIONS','disable_smart')>0,'disable_autorevision':GWOthers.getItem('RESTRICTIONS','disable_autorevision')>0,'disable_languages':(GWOthers.getItem('RESTRICTIONS','disable_languages')||0)<1,'disable_export':GWOthers.getItem('RESTRICTIONS','disable_export')>0,'disable_accountedit':GWOthers.getItem('RESTRICTIONS','disable_accountedit')>0,'account':sPrimaryAccount,'enable_quota':this.__primaryAccount.MBOX_QUOTA>0,'enable_smsquota':this.__primaryAccount.SMS_LIMIT>0,'disable_troubleshooting':dataSet.get('main',['sid']).indexOf('wmtr')===0,'disable_otheraccounts':GWOthers.getItem('RESTRICTIONS','disable_otheraccounts')==1,'disable_private_certs':GWOthers.getItem('RESTRICTIONS','DISABLE_PRIVATE_CERTIFICATES')==1,'disable_weather':GWOthers.getItem('RESTRICTIONS','DISABLE_WEATHER_SETTING')==1,'disable_changepass':GWOthers.getItem('RESTRICTIONS','disable_changepass')==1,'enable_2f':sPrimaryAccount2F,'replyto':GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','reply_to_address'),'altmail':(GWOthers.getItem('RESTRICTIONS','hide_altmail')||0)<1};var gw_types=GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'',regex=/[cejntf]{6}/g;if(sPrimaryAccountGW>0&&gw_types&&regex.test(gw_types))
drw_arr.gw_access=false;drw_arr.digest_allowed=(GWOthers.getItem('GLOBAL_SETTINGS','teamchat_notify')||0)>0;if(drw_arr.gw_access){drw_arr.gw_c=(gw_types.indexOf('c')<0);drw_arr.gw_e=(gw_types.indexOf('e')<0);drw_arr.gw_j=(gw_types.indexOf('j')<0);drw_arr.gw_n=(gw_types.indexOf('n')<0);drw_arr.gw_t=(gw_types.indexOf('t')<0);drw_arr.gw_f=(gw_types.indexOf('f')<0);}
if(sPrimaryAccountGUEST){drw_arr.guest=true;this._draw('frm_settings_guest','main',drw_arr);var aData=me._others.get('CHAT','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);var aData=me._others.get('TEAMCHAT_NOTIFY','storage');if(typeof aData==='object')
loadDataIntoFormOnAccess(this,aData);if(this.x_password)
this.x_password._onclick=function(){gui._create('changepass','frm_changepass');};return;}
this._draw('frm_settings','main',drw_arr);if(!this.maintab){return;}
this.maintab.mail_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.general._active(false);return;}
oTab.general._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('MAIL_SETTINGS_GENERAL','storage');this.show_inline_images._onchange=function(){if(aData&&aData.ACCESS.show_images!='view')
oTab.general.show_images._disabled(!this._checked());};this.default_flag._fillLang({'1':["COLOR_LABELS::RED_FLAG",'','ico bg_red'],'2':["COLOR_LABELS::BLUE_FLAG",'','ico bg_blue'],'3':["COLOR_LABELS::GREEN_FLAG",'','ico bg_green'],'5':["COLOR_LABELS::ORANGE_FLAG",'','ico bg_orange'],'8':["COLOR_LABELS::PURPLE_FLAG",'','ico bg_purple'],'A':["COLOR_LABELS::YELLOW_FLAG",'','ico bg_yellow']});if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);this.autoclear_trash_days._range(0,255);this.autoclear_spam_days._range(0,255);}};oTab.mail_default._onactive=function(bFirstTime){if(this.from){var aData={},aAlias=dataSet.get('storage',['ALIASES','ITEMS']);aData['']=getPrimaryAccountFromAddress(true);for(var i in aAlias)
if(aAlias[i].VALUES.EMAIL&&aAlias[i].VALUES.EMAIL.VALUE&&aAlias[i].VALUES.EMAIL.VALUE.toLowerCase()!=sPrimaryAccount&&aAlias[i].VALUES.ENABLED&&aAlias[i].VALUES.ENABLED.VALUE=='1'){aData[MailAddress.createEmail(aAlias[i].VALUES.NAME?aAlias[i].VALUES.NAME.VALUE:'',aAlias[i].VALUES.EMAIL.VALUE)]=MailAddress.createEmail(aAlias[i].VALUES.NAME?aAlias[i].VALUES.NAME.VALUE:'',aAlias[i].VALUES.EMAIL.VALUE,true);}
this.from._fill(aData);}
if(Cookie.get(['suggest_address']))
this.x_btn_rcptcache._disabled(false);if(bFirstTime){this.html_message._onchange=function(){me.__helper.htmlMessageFormatChange(this._parent,'0'===this._value());};this.x_btn_rcptcache._onclick=function(){var me=this;gui._create('cache','frm_confirm','','frm_alert',[function(){Cookie.set(['suggest_address']);me._disabled(true);}],'SETTINGS::RCPT_CACHE','CONFIRMATION::CLEAR_AUTOSUGGEST');};var aLang=dataSet.get('storage',['SPELLCHECKER_LANGUAGES','ITEMS']),aTmp=[],aData={};for(var i in aLang)
if(aLang[i].VALUES&&aLang[i].VALUES.PATH&&aLang[i].VALUES.NAME)
aTmp.push([aLang[i].VALUES.PATH.VALUE,aLang[i].VALUES.NAME.VALUE]);if(aTmp.length){var aTmp=aTmp.sort(function(a,b){if(a[1]<b[1])
return 1;else
if(a[1]>b[1])
return-1;else
return 0;});for(var i=aTmp.length-1;i>=0;i--)
aData[aTmp[i][0]]=aTmp[i][1];aTmp=null;}
this.spellchecker._fill(aData);aLang=dataSet.get('storage',['FONTS','ITEMS']);aData={'0':getLang('SETTINGS::DEFAULT')};for(var i in aLang)
if(aLang[i].VALUES.FAMILY.VALUE)
aData[aLang[i].VALUES.FAMILY.VALUE]=aLang[i].VALUES.NAME.VALUE;this.font_family._fill(aData);var aData=me._others.get('MAIL_SETTINGS_DEFAULT','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);if(!this.font_family._value())
this.font_family._value('0');if(this.from&&!this.from._value())
this.from._value('');}};if(oTab.autoresponder)
oTab.autoresponder._onactive=function(bFirstTime){if(bFirstTime){var aResponder=me._others.get('AUTORESPONDER','storage');var from=aResponder['VALUES']['u_respondbetweenfrom'].split('/');aResponder['VALUES']['u_respondbetweenfrom']=new IcewarpDate([from[0],from[1]-1,from[2]]).format(IcewarpDate.JULIAN);var to=aResponder['VALUES']['u_respondbetweento'].split('/');aResponder['VALUES']['u_respondbetweento']=new IcewarpDate([to[0],to[1]-1,to[2]]).format(IcewarpDate.JULIAN);this.autoresponder._value(aResponder);}};if(oTab.forwarder)
oTab.forwarder._onactive=function(bFirstTime){if(bFirstTime){var oForwarder=this;this.u_forwardolder._onchange=function(){oForwarder.u_forwardolderdays._disabled(!this._value());oForwarder.u_forwardolderto._disabled(!this._value());};if(oForwarder.u_null)
this.u_forwardto._onkeyup=function(){if(this._value()==''){oForwarder.u_null._disabled(1);oForwarder.u_null._value(0);}
else
oForwarder.u_null._disabled(0);};var aForwarder=me._others.get('FORWARDER','storage');if(typeof aForwarder=='object')
loadDataIntoFormOnAccess(this,aForwarder);if(oForwarder.u_null)
this.u_forwardto._onkeyup();this.u_forwardolder._onchange();}};if(oTab.rules)
oTab.rules._onactive=function(bFirstTime){if(bFirstTime){var rules=this;storage.library('obj_filter_line');this.__aFilterLine=new obj_filter_line;msiebox(this._getAnchor('msiebox'));this.__valuesOfLines=[];this.__labelsOfLines=[];this.__getLabel=function(aValues){if(Is.Defined(aValues['TITLE'])&&aValues['TITLE'][0]['VALUE'])
return aValues['TITLE'][0]['VALUE'];else
return this.__aFilterLine._getText(aValues);};this.__addLine=function(aValues){var sLabel=this.__getLabel(aValues);if(sLabel){var a={title:sLabel};a.checked=(aValues.ACTIVE&&aValues.ACTIVE[0].VALUE>0);if(aValues.ACCEPT&&aValues.ACCEPT[0].VALUE>0)
a.css='accept';else
if(aValues.DELETE&&aValues.DELETE[0].VALUE>0)
a.css='delete';else
if(aValues.MARKSPAM&&aValues.MARKSPAM[0].VALUE>0)
a.css='spam';else
if(aValues.REJECT&&aValues.REJECT[0].VALUE>0)
a.css='reject';this.__labelsOfLines.push(a);this.__valuesOfLines.push(aValues);}};this.__refreshLines=function(){this.rules._fill(this.__labelsOfLines);};this.__unselectLine=function(){this.rules._value([]);this.x_delete._disabled(true);this.x_edit._disabled(true);this.x_up._disabled(true);this.x_down._disabled(true);};this.__selectLine=function(){if(this.rules._value().length){this.x_delete._disabled(false);this.x_edit._disabled(false);this.x_up._disabled(false);this.x_down._disabled(false);}};this.__addLineWithFill=function(aValues){this.__addLine(aValues);this.__refreshLines();this.rules._value(this.__valuesOfLines.length-1);};this.__editLine=function(index){gui._create('edit_rule','frm_rule','','',this.__valuesOfLines[index],[this,'__editLineCallback']);};this.__editLineCallback=function(aValues){var index;if((index=this.__findLine(aValues))<0)return;var sLabel=this.__getLabel(aValues);if(sLabel){var a={title:sLabel};a.checked=(aValues.ACTIVE&&aValues.ACTIVE[0].VALUE>0);if(aValues.ACCEPT&&aValues.ACCEPT[0].VALUE>0)
a.css='accept';else
if(aValues.DELETE&&aValues.DELETE[0].VALUE>0)
a.css='delete';else
if(aValues.MARKSPAM&&aValues.MARKSPAM[0].VALUE>0)
a.css='spam';else
if(aValues.REJECT&&aValues.REJECT[0].VALUE>0)
a.css='reject';this.__labelsOfLines[index]=a;this.__refreshLines();}
else
this.__deleteLine(index);};this.__deleteLine=function(index){for(var i=index;i<this.__valuesOfLines.length-1;i++){this.__labelsOfLines[i]=this.__labelsOfLines[i+1];this.__valuesOfLines[i]=this.__valuesOfLines[i+1];}
this.__labelsOfLines.pop();this.__valuesOfLines.pop();this.__refreshLines();this.__unselectLine();};this.__moveUpLine=function(index){if(index<=0)return;this.__swapLines(index,index-1);this.rules._value([index-1]);};this.__moveDownLine=function(index){if(index<this.__valuesOfLines.length-1){this.__swapLines(index,index+1);this.rules._value([index+1]);}};this.__swapLines=function(i1,i2){var tmpValue=this.__valuesOfLines[i1];this.__valuesOfLines[i1]=this.__valuesOfLines[i2];this.__valuesOfLines[i2]=tmpValue;var tmpLabel=this.__labelsOfLines[i1];this.__labelsOfLines[i1]=this.__labelsOfLines[i2];this.__labelsOfLines[i2]=tmpLabel;this.__refreshLines();};this.__findLine=function(aValues){for(var i in this.__valuesOfLines){if(this.__valuesOfLines[i]==aValues)
return parseInt(i);}
return-1;};this.__unselectLine();var rules=this;this.rules._onclick=function(){if(count(this._value())==1)
rules.__selectLine();else
rules.__unselectLine();};this.rules._ondblclick=function(){var index=parseInt((this._value()[0]));if(index!=NaN)rules.__editLine(index);};this.rules._oncheck=function(id,data){rules.__valuesOfLines[id].ACTIVE=[{VALUE:data.checked?'1':'0'}];};this.x_add._onclick=function(){gui._create('edit_rule','frm_rule','','',{},[rules,'__addLineWithFill']);};this.x_edit._onclick=function(){var index=parseInt((rules.rules._value()[0]));if(index!=NaN)rules.__editLine(index);};this.x_delete._onclick=function(){var index=parseInt((rules.rules._value()[0]));if(index!=NaN)rules.__deleteLine(index);};this.x_up._onclick=function(){var index=parseInt((rules.rules._value()[0]));if(index!=NaN)rules.__moveUpLine(index);};this.x_down._onclick=function(){var index=parseInt((rules.rules._value()[0]));if(index!=NaN)rules.__moveDownLine(index);};storage.library('wm_storage');storage.library('gw_others');this._aStorageFilters=GWOthers.get('FILTER_RULES','storage','',true);if(this._aStorageFilters){this._aXmlFilter=XMLTools.Str2Arr(this._aStorageFilters['VALUES']['u_rulescontentxml']);if(this._aXmlFilter['CONTENTFILTER']&&this._aXmlFilter['CONTENTFILTER'][0]&&this._aXmlFilter['CONTENTFILTER'][0]['FILTER']){for(var i in this._aXmlFilter['CONTENTFILTER'][0]['FILTER']){var aFilter=this._aXmlFilter['CONTENTFILTER'][0]['FILTER'][i];this.__addLine(aFilter);}
this.__refreshLines();}}}};oTab.readconfirmation._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));var aData=me._others.get('READ_CONFIRMATION','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);}};var aAlias=dataSet.get('storage',['ALIASES','ITEMS']),aData=dataSet.get('storage',['SIGNATURE','ITEMS']);var aTmpGroups=dataSet.get('storage',['GROUPS','ITEMS']),aGroups={};for(var i in aTmpGroups)
if(aTmpGroups[i].VALUES.SENTFOLDER&&aTmpGroups[i].VALUES.SENTFOLDER.VALUE)
aGroups[aTmpGroups[i].VALUES.GROUP.VALUE]=sPrimaryAccount+'/'+aTmpGroups[i].VALUES.SENTFOLDER.VALUE;oTab.signature._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));if(this.x_ali_add)
this.x_ali_add._onclick=function(){var frm=gui._create('personality','frm_ok_cancel');frm._size(350,300,true);frm._modal(true);frm._title('FORM_BUTTONS::ADD');frm._draw('frm_personality','main');frm.x_btn_ok._disabled(true);frm.x_btn_ok._onclick=function(){storage.library('wm_tools');var tools=new wm_tools();tools.personality({'name':frm.name._value(),'email':frm.email._value()},[{},function(){if(gui.notifier)
gui.notifier._value(getLang('SIGNATURE::NOTIFY'));}]);frm._destruct();};frm.email._onerror=function(b){frm.x_btn_ok._disabled(b);};};if(Is.Array(aData)&&aData.length){this.__signatures={};for(var i=0;aData.length>i;i++){this.__signatures[aData[i].VALUES.ID?aData[i].VALUES.ID.VALUE:0]={'name':aData[i].VALUES.NAME?aData[i].VALUES.NAME.VALUE:getLang('SETTINGS::DEFAULT'),'text':aData[i].VALUES.TEXT?aData[i].VALUES.TEXT.VALUE:'','access':aData[i].VALUES.TEXT?aData[i].VALUES.TEXT.ATTRIBUTES.ACCESS:'full'};}}
else
this.__signatures={'0':{name:getLang('SETTINGS::DEFAULT'),text:''}};this.list.__multi=false;this.list._generate=function(){var aEditableList={},aCompleteList={};for(var i in this._parent.__signatures){aCompleteList[i]=this._parent.__signatures[i].name;if(this._parent.__signatures[i].access=='full')
aEditableList[i]=this._parent.__signatures[i].name;}
this._fill(aCompleteList);for(var i in aEditableList)
return i;return false;};this.list._onclick=function(){var v=this._value(),aSign,p=this._parent;this.__save_text.call(p);if(v&&(v=v[0])&&(aSign=p.__signatures[v])){this.__lastID=v;for(var i in aSign)
if(p[i])
p[i]._value(aSign[i]);p.text._readonly(aSign.access=='view');p.x_rename._disabled(v=='0'||aSign.access=='view');p.x_remove._disabled(v=='0'||aSign.access=='view');}
else{p.text._value('');p.text._readonly(true);p.x_rename._disabled(true);p.x_remove._disabled(true);}};this.list.__save_text=function(){var id=this.list.__lastID;if(Is.Defined(id)&&this.__signatures[id]&&this.__signatures[id].access!='view'){var s=this.text._value();this.__signatures[id].text=s.toLowerCase().indexOf('<img ')>-1||s.removeTags().trim()?s:'';}};var firstLegalValue=this.list._generate();if(firstLegalValue){this.list._value(firstLegalValue);this.list._onclick();}
this.x_remove._onclick=function(){var v=this._parent.list._value();if(v&&(v=v[0])&&this._parent.__signatures[v]){delete this._parent.__signatures[v];this._parent.list._generate();this._parent.list._value(0);this._parent.list._onclick();}};this.x_add._onclick=function(){var frm=gui._create('add','frm_ok_cancel');frm._modal(true);frm._resizable(false);frm._dockable(false);frm._size(350,153,true);frm._title('FORM_BUTTONS::ADD');frm._draw('frm_label_input','main',{LABEL:getLang('ATTENDEES::NAME')});frm.x_btn_ok._value('FORM_BUTTONS::ADD');frm.x_btn_ok._onclick=function(){var v=frm.input._value();if(v){for(var i in oTab.signature.__signatures)
if(oTab.signature.__signatures[i].name==v){frm.input._setRange(0,v.length);return;}
var id=getFreeKey(oTab.signature.__signatures);oTab.signature.__signatures[id]={name:v,text:'',access:'full'};oTab.signature.list._generate();oTab.signature.list._value(id);oTab.signature.list._onclick();frm._destruct();}
else
frm.input._focus();};frm.input._onsubmit=function(){frm.x_btn_ok._onclick()};frm.input._focus();};this.x_rename._onclick=function(){var v=this._parent.list._value();if(v&&(v=v[0])&&oTab.signature.__signatures[v]){var frm=gui._create('add','frm_ok_cancel');frm._modal(true);frm._resizable(false);frm._dockable(false);frm._size(350,152,true);frm._title('FORM_BUTTONS::RENAME');frm._draw('frm_label_input','main',{LABEL:getLang('ATTENDEES::NAME')});frm.x_btn_ok._value('FORM_BUTTONS::RENAME');frm.x_btn_ok._onclick=function(){var s=frm.input._value();if(s){for(var i in oTab.signature.__signatures)
if(oTab.signature.__signatures[i].name==s){frm.input._setRange(0,s.length);return;}
oTab.signature.__signatures[v].name=s;oTab.signature.list._generate();frm._destruct();}
else
frm.input._focus();};frm.input._value(oTab.signature.__signatures[v].name);frm.input._onsubmit=function(){frm.x_btn_ok._onclick()};frm.input._focus();}};}};oTab.alias._onactive=function(bFirstTime){if(oTab.signature.__signatures)
this.__signatures=oTab.signature.__signatures;else
if(Is.Array(aData)&&aData.length){this.__signatures={};for(var i=0;aData.length>i;i++){this.__signatures[aData[i].VALUES.ID?aData[i].VALUES.ID.VALUE:0]={'name':aData[i].VALUES.NAME?aData[i].VALUES.NAME.VALUE:getLang('SETTINGS::DEFAULT'),'text':aData[i].VALUES.TEXT?aData[i].VALUES.TEXT.VALUE:'','access':aData[i].VALUES.TEXT?aData[i].VALUES.TEXT.ATTRIBUTES.ACCESS:'full'};}}
else
this.__signatures={'0':{name:getLang('SETTINGS::DEFAULT'),text:''}};var aCompleteList={'*':getLang('SIGNATURE::NONE')};for(var i in this.__signatures)
aCompleteList[i]=this.__signatures[i].name;this.sign1._fill(aCompleteList);this.sign2._fill(aCompleteList);if(bFirstTime){msiebox(this._getAnchor('msiebox'));this.sent._redraw=function(sFolder){var sentData={'*':getLang('COMMON::NO'),'#':getLang('SETTINGS::DEFAULT'),'+':getLang('SELECT_FOLDER::SELECT_FOLDER')};if(Is.String(sFolder)&&!sentData[sFolder])
sentData[sFolder]=Path.basename(sFolder);this._fill(sentData);this._value(Is.String(sFolder)?sFolder:'#');};this.sent._redraw();this.sent._onbeforechange=function(sOld,sNew){if(sNew==='+'){if(this.frm_select_folder&&!this.frm_select_folder._destructed)
this.frm_select_folder._focus();else{var aPath=Path.split(GWOthers.getItem('DEFAULT_FOLDERS','sent'));this.frm_select_folder=gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',aPath[0],aPath[1],[function(aid,fid){fid&&this._redraw(aid+'/'+fid)}.bind(this)],false,true,'M','i',false);this.frm_select_folder._onclose=function(b){b&&this._value(sOld!=='+'?sOld:'#');return true;}.bind(this);}}};if(GWOthers.getItem('RESTRICTIONS','disable_new_aliases')<1){this.x_ali_add._disabled(GWOthers.getItem('RESTRICTIONS','disable_personalities')>0);this.x_ali_add._onclick=function(){var frm=gui._create('personality','frm_ok_cancel');frm._size(350,300,true);frm._modal(true);frm._title('ALIAS::ADD');frm._draw('frm_personality','main');frm.x_btn_ok._value('COMPOSE::SEND');frm.x_btn_ok._disabled(true);frm.x_btn_ok._onclick=function(){storage.library('wm_tools');var tools=new wm_tools();tools.personality({'name':frm.name._value(),'email':frm.email._value()},[function(){if(gui.notifier)
gui.notifier._value({type:'confirmation_sent'});}]);frm._destruct();};frm.email._onerror=function(b){frm.x_btn_ok._disabled(b);};};this.x_ali_delegated._disabled(GWOthers.getItem('RESTRICTIONS','disable_personalities')>0);this.x_ali_delegated._onclick=function(){gui._create('deligated','frm_select_account','main','',[function(sEmail){storage.library('wm_tools');var tools=new wm_tools();tools.personality({'isdelegate':1,'email':sEmail},[function(aData){if(!this||this._destructed||aData===false){if(aData===false&&gui.notifier)
gui.notifier._value({type:'alert',args:{header:'',text:'ALIAS::DELEGATED_ERROR'}});return;}
for(var a,i=aAlias.length;i--;){a=aAlias[i];if(a.VALUES&&a.VALUES.EMAIL.VALUE===sEmail){if(a.ATTRIBUTES.ACCESS){a.ATTRIBUTES.DONT_SEND=false;a.VALUE='';delete a.VALUES;}
else
aAlias.splice(i,1);}}
aAlias.push({ATTRIBUTES:{},VALUES:{EMAIL:{ATTRIBUTES:{},VALUE:aData.EMAIL},NAME:{ATTRIBUTES:{},VALUE:aData.NAME||''},ENABLED:{ATTRIBUTES:{},VALUE:'1'},ISDELEGATE:{ATTRIBUTES:{},VALUE:'1'},DELETEABLE:{ATTRIBUTES:{},VALUE:'1'}}});var cnt=this.list._fillAlias();this.list._value(cnt-1);}.bind(this)]);}.bind(this)]);}.bind(this);}
this.list.__multi=false;(this.list._fillAlias=function(){var aList=[];for(var i in aAlias)
if(aAlias[i].VALUES&&aAlias[i].VALUES.EMAIL){if(aAlias[i].VALUES.EMAIL.VALUE.toLowerCase()==sPrimaryAccount)
aList.unshift({title:aAlias[i].VALUES.EMAIL.VALUE,checked:true,disabled:true,arg:i});else
aList.push({title:aAlias[i].VALUES.EMAIL.VALUE,checked:aAlias[i].VALUES.ENABLED.VALUE=='1',arg:i});}
this._fill(aList);return aList.length;}.bind(this.list))();this.list._oncheck=function(id,data){if(data&&!data.disabled){var a=aAlias[data.arg];if(a){a.ATTRIBUTES.DONT_SEND=false;a.VALUES.ENABLED={VALUE:this._checked(id)?1:0,ATTRIBUTES:{ACCESS:'full'}};}
this._parent.x_enable._disabled(data.checked);this._parent.x_disable._disabled(!data.checked);}};this.list._onchange=function(){var v=this._value();if(v.length){var data=this.__idTable[v[0]];this._parent.x_enable._disabled(data.checked);this._parent.x_disable._disabled(!data.checked);if(this.__lastID!=data.arg&&aAlias[data.arg]){var a=aAlias[data.arg].VALUES,p=this._parent,tmp,sEmail=a.EMAIL.VALUE.toLowerCase();p.fullname._disabled(sEmail==sPrimaryAccount||a.ISDELEGATE);p.fullname._value(a.NAME?a.NAME.VALUE:'',true);p.remove._disabled(sEmail==sPrimaryAccount||(!a.DELETEABLE||a.DELETEABLE.VALUE!='1'));tmp=a.SIGN1?a.SIGN1.VALUE:'0';p.sign1._value(p.sign1.__idTable[tmp]?tmp:'*',true);tmp=a.SIGN2?a.SIGN2.VALUE:'0';p.sign2._value(p.sign2.__idTable[tmp]?tmp:'*',true);if(sEmail==sPrimaryAccount||aGroups[sEmail]){p.sent._disabled(true);p.sent._redraw();}
else{p.sent._disabled(false);p.sent._redraw(a.SENTFOLDER&&a.SENTFOLDER.VALUE);}
this.__lastID=data.arg;}}};this.remove._onclick=function(){var v=this._parent.list._value();if(v.length){var a,idt=this._parent.list.__idTable;if(idt[v[0]]&&idt[v[0]].arg&&(a=aAlias[idt[v[0]].arg])){if(a.ATTRIBUTES.ACCESS){a.ATTRIBUTES.DONT_SEND=false;a.VALUE='';delete a.VALUES;}
else
aAlias.splice(idt[v[0]].arg,1);var cnt=this._parent.list._fillAlias();if(Is.Empty(this._parent.list._value()))
this._parent.list._value(cnt-1);}}};this.fullname._onblur=this.sign1._onchange=this.sign2._onchange=function(){var v=this._parent.list._value();if(v.length){var a,data=this._parent.list.__idTable[v[0]];if(data&&data.arg&&(a=aAlias[data.arg])){a.ATTRIBUTES.DONT_SEND=false;a.VALUES.NAME={VALUE:oTab.alias.fullname._value(),ATTRIBUTES:{ACCESS:'full'}};if(oTab.alias.sign1._value()=='0')
delete a.VALUES.SIGN1;else
a.VALUES.SIGN1={VALUE:oTab.alias.sign1._value(),ATTRIBUTES:{ACCESS:'full'}};if(oTab.alias.sign2._value()=='0')
delete a.VALUES.SIGN2;else
a.VALUES.SIGN2={VALUE:oTab.alias.sign2._value(),ATTRIBUTES:{ACCESS:'full'}};if(~['+','#'].indexOf(oTab.alias.sent._value()))
delete a.VALUES.SENTFOLDER;else
a.VALUES.SENTFOLDER={VALUE:oTab.alias.sent._value(),ATTRIBUTES:{ACCESS:'full'}};}}};this.sent._onchange=function(){if(this._value()!=='#')
this._parent.sign1._onchange();};this.x_disable._onclick=this.x_enable._onclick=function(){var v=this._parent.list._value();if(v&&Is.Defined(v=v[0]))
this._parent.list._checked(v,this._name=='x_enable');};this.list._value(0);}};oTab.general._active(true);};if(this.maintab.im_settings)
this.maintab.im_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(bFirstTime){if(oTab.general)
oTab.general._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('IM','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);}};if(oTab.chat)
oTab.chat._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('IM','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);}};oTab.general._active(true);}};if(this.maintab.teamchat_settings)
this.maintab.teamchat_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(bFirstTime){oTab.general._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('CHAT','storage');if(typeof aData==='object')
loadDataIntoFormOnAccess(this,aData);}};oTab.digest&&(oTab.digest._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('TEAMCHAT_NOTIFY','storage');if(typeof aData==='object')
loadDataIntoFormOnAccess(this,aData);}});oTab.general._active(true);}};if(this.maintab.sip_settings)
this.maintab.sip_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.general._active(false);return;}
oTab.general._onactive=function(bFirstTime){if(bFirstTime){this.user._restrict([Is.Email]);this.x_java._fill({x:'SETTINGS::SIP_INTERNAL'});this.x_java._onchange=function(e){var elm=e.target||e.srcElement;if(elm.checked){var a=['x_java','x_dial','x_dial_ext'];for(var i in a)
if(a[i]!=this._name&&this._parent[a[i]])
this._parent[a[i]]._main.elements[0].checked=false;this._parent.dial._disabled(this._name!='x_dial_ext');this._parent.external._disabled(this._name!='x_java');this._parent['start']._disabled(this._name!='x_java');if(this._name=='x_java')
this._parent.external._onchange();else{this._parent.user._disabled(true);this._parent.pass._disabled(true);this._parent.ext._disabled(true);this._parent.server._disabled(true);}}};this.x_dial._fill({x:'SETTINGS::SIP_DIAL_INTERNAL'});this.x_dial._onchange=this.x_java._onchange;if(this.external){this.x_dial_ext._fill({x:'SETTINGS::SIP_DIAL'});this.x_dial_ext._onchange=this.x_java._onchange;this.external._onchange=function(){var b=!this._value();this._parent.user._disabled(b);this._parent.pass._disabled(b);this._parent.ext._disabled(b);this._parent.server._disabled(b);};}
var aData=me._others.get('SIP','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);switch(aData.VALUES.mode){case'integrate':this.x_java._value('x');break;case'external':if(this.x_dial_ext){this.x_dial_ext._value('x');break;}
default:this.x_dial._value('x');}}};if(oTab.forward)
oTab.forward._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('CALL_FORWARDING','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);var fdelay=this.u_sip_calltransfertime,ftarget=this.u_sip_calltransfertarget,factive=this.u_sip_calltransferactive;factive._onchange=function(){var b=!this._value();ftarget._disabled(b);fdelay._disabled(b);};fdelay._restrict([this,function(){var v=parseInt(fdelay._value().trim());return fdelay._disabled()||!isNaN(v);}]);fdelay._onblur=function(){var v=this._value();if(v!="")
this._value(parseInt(v.trim())||0);};if(factive._value()==1){ftarget._disabled(false);fdelay._disabled(false);}}};oTab.general._active(true);};this.maintab.general_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.layout._active(false);return;}
oTab.layout._onactive=function(bFirstTime){if(bFirstTime){this.notifications._disabled(!gui.notifier||gui.notifier._getPermissions()=='unsupported'||gui.notifier._getPermissions()=='denied');if(this.language){var aLang=me._others.get('LANGUAGES','storage');var aData={};for(var i in aLang['VALUES'])
aData[i]=aLang['VALUES'][i];this.language._fill(aData);if(!aData[me._others.getItem('LAYOUT_SETTINGS','language')])
me._others.setItem('LAYOUT_SETTINGS','language',me._others.getDefaultValues('LAYOUT_SETTINGS').LANGUAGE);}
var aSkin=me._others.get('SKINS','storage'),aData={};for(var i in aSkin['VALUES'])
if(i!='value')
aData[i]=aSkin['VALUES'][i];this.skin._fill(aData);this.date_format._fill(CalendarFormatting.getFormats());if(!aData[me._others.getItem('LAYOUT_SETTINGS','skin')])
me._others.setItem('LAYOUT_SETTINGS','skin',me._others.getDefaultValues('LAYOUT_SETTINGS').SKIN);aData=me._others.get('LAYOUT_SETTINGS','storage');if(this.skin_style&&storage.aStorage.language.SKIN_STYLE){var tmp={},ls=storage.aStorage.language.SKIN_STYLE;for(var i in ls)
tmp[i.toLowerCase()]=[ls[i],i.toLowerCase()];this.skin_style._fill(tmp);if(aData&&aData.VALUES&&!tmp[aData.VALUES.skin_style]){aData.VALUES.skin_style='default';}}
if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);oTab.layout.preview_delay._range(50,1500);}};oTab.folders._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('DEFAULT_FOLDERS','storage');if(!dataSet.get('storage',['DEFAULT_FOLDERS','ITEMS','0','VALUES','SMART'])||dataSet.get('storage',['DEFAULT_FOLDERS','ITEMS','0','VALUES','SMART','ATTRIBUTES','DEFAULT'])){aData.VALUES.smart=aData.VALUES.files;aData.ACCESS.smart=aData.ACCESS.files;}
var afill={'__@@ADDRESSBOOK@@__':getLang('SETTINGS::DEFAULT')};if(aData.VALUES.ab!='__@@ADDRESSBOOK@@__')
afill[aData.VALUES.ab]=Path.split(aData.VALUES.ab)[1];afill['*']=getLang('ATTENDEES::FOLDER');this.ab._fill(afill);this.ab._value(aData.VALUES.ab);this.ab._onchange=function(){if(this._value()=='*'){this._value('__@@ADDRESSBOOK@@__');var aPath=Path.split(oTab.folders.contacts._value()),me=this;gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',aPath[0],aPath[1],[function(sAccount,sFolder){var v,afill={'__@@ADDRESSBOOK@@__':getLang('SETTINGS::DEFAULT')};if(sAccount+'/'+sFolder==oTab.folders.contacts._value())
v='__@@ADDRESSBOOK@@__';else{afill[sAccount+'/'+sFolder]=sFolder;v=sAccount+'/'+sFolder;}
afill['*']=getLang('ATTENDEES::FOLDER');me._fill(afill);me._value(v);}],true,true,'C','',true);}};if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);this.trash._onchange=function(){var tmp=dataSet.get('folders',Path.split(this._value()));if(tmp.SPAM||tmp.PUBLIC||this._value()==sPrimaryAccount+'/INBOX'||this._value().indexOf(sPrimaryAccount+'/'+sPrimaryAccountSPREFIX)===0||this._parent.sent._value()==this._value()||this._parent.drafts._value()==this._value()){gui._create('alert','frm_alert','','',[this.path._onclick],'','ALERTS::RESERVED_FOLDER',[Path.basename(this._value())]);this._value(aData.VALUES.trash);}};this.sent._onchange=function(){var tmp=dataSet.get('folders',Path.split(this._value()));if(tmp.SPAM||tmp.PUBLIC||this._value()==sPrimaryAccount+'/INBOX'||this._value().indexOf(sPrimaryAccount+'/'+sPrimaryAccountSPREFIX)===0||this._parent.trash._value()==this._value()||this._parent.drafts._value()==this._value()){gui._create('alert','frm_alert','','',[this.path._onclick],'','ALERTS::RESERVED_FOLDER',[Path.basename(this._value())]);this._value(aData.VALUES.sent);}};this.drafts._onchange=function(){var tmp=dataSet.get('folders',Path.split(this._value()));if(tmp.SPAM||tmp.PUBLIC||this._value()==sPrimaryAccount+'/INBOX'||this._value().indexOf(sPrimaryAccount+'/'+sPrimaryAccountSPREFIX)===0||this._parent.sent._value()==this._value()||this._parent.trash._value()==this._value()){gui._create('alert','frm_alert','','',[this.path._onclick],'','ALERTS::RESERVED_FOLDER',[Path.basename(this._value())]);this._value(aData.VALUES.drafts);}};this.files._onbeforechange=function(sOld,sNew){if(this._parent.smart)
if(this._parent.smart._value()==sOld)
this._parent.smart._value(sNew);};this.contacts._onbeforechange=function(sOld,sNew){if(this._parent.ab)
if(this._parent.ab._value()==sNew)
this._parent.ab._value('__@@ADDRESSBOOK@@__');};}};oTab.documents._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('GW_MYGROUP','storage');if(this.x_ownautorevisionmode){this.x_ownautorevisionmode._value(aData.VALUES.ownautorevisionmode<1?0:1);this.x_ownautorevisionmode._disabled(aData.ACCESS.ownautorevisionmode=='full'?0:1);}
var aData=me._others.get('DOCUMENTS','storage');this.autosave._onclick=function(){this._parent.autosave_minutes._disabled(this._checked());};this.disable_office._onclick=function(){this._parent.office_app._disabled(this._checked());};this.office_app._fill({webdoc:getLang('OFFICELAUNCHER::WEBDOC'),webdoc_read:getLang('OFFICELAUNCHER::WEBDOC_READ'),suite:getLang('OFFICELAUNCHER::SUITE')});if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);this.autosave_minutes._disabled(!this.autosave._checked()||this.autosave_minutes._disabled());this.office_app._disabled(!this.disable_office._checked()||this.disable_office._disabled());}};if(oTab.antispam)
oTab.antispam._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('ANTISPAM','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);}};oTab.layout._active(true);};if(this.maintab.calendar_settings)
this.maintab.calendar_settings._onactive=function(bFirstTime){var oTab=this.maintab,forcedWeekBeginsOn=false;if(!bFirstTime){oTab.main._active(false);return;}
oTab.main.week_begins._disabled(oTab.main.begin_on_today._value());oTab.main.begin_on_today._onchange=function(){oTab.main.week_begins._disabled(forcedWeekBeginsOn||oTab.main.begin_on_today._value());};oTab.main._onactive=function(bFirstTime){if(bFirstTime){this.week_begins._fillLang({'sunday':"DAYS::SUNDAY",'monday':"DAYS::MONDAY",'tuesday':"DAYS::TUESDAY",'wednesday':"DAYS::WEDNESDAY",'thursday':"DAYS::THURSDAY",'friday':"DAYS::FRIDAY",'saturday':"DAYS::SATURDAY"});this.week_begins._value('sunday');var aHours={};for(var i=0;i<24;i++){aHours[i]=i.toString()+':00';aHours[i+.5]=i.toString()+':30';}
this.day_begins._fill(aHours);this.day_begins._setNatSort(true);this.day_ends._fill(aHours);this.day_ends._setNatSort(true);this.day_begins._onchange=function(){if(parseInt(this._value())>parseInt(oTab.main.day_ends._value()))
oTab.main.day_ends._value(this._value());};this.day_ends._onchange=function(){if(parseInt(oTab.main.day_begins._value())>parseInt(this._value()))
oTab.main.day_begins._value(this._value());};this.workweek_begins._fillLang({'1':"DAYS::MONDAY",'2':"DAYS::TUESDAY",'3':"DAYS::WEDNESDAY",'4':"DAYS::THURSDAY",'5':"DAYS::FRIDAY",'6':"DAYS::SATURDAY",'7':"DAYS::SUNDAY"});this.workweek_begins._onchange=function(){var begin=parseInt(this._value());var end=oTab.main.workweek_ends;if(end._value()==undefined)
end._value(begin<0?-1:((begin+=4)>7?begin-7:begin));else if(begin==end._value())
end._value(begin==7?1:begin+1);};this.workweek_ends._fillLang({'1':"DAYS::MONDAY",'2':"DAYS::TUESDAY",'3':"DAYS::WEDNESDAY",'4':"DAYS::THURSDAY",'5':"DAYS::FRIDAY",'6':"DAYS::SATURDAY",'7':"DAYS::SUNDAY"});this.workweek_ends._onchange=function(){var begin=oTab.main.workweek_begins;var end=this._value();if(begin._value()==undefined)
begin._value('1');if(begin._value()==end)
begin._value(end==1?7:end-1);};var aData=me._others.get('CALENDAR_SETTINGS','storage');if(typeof aData=='object'){loadDataIntoFormOnAccess(this,aData);if(!this.begin_on_today._disabled()&&this.week_begins._disabled()){forcedWeekBeginsOn=true;}}}};if(oTab.default_settings)
oTab.default_settings._onactive=function(bFirstTime){if(bFirstTime){var aData=me._others.get('DEFAULT_CALENDAR_SETTINGS','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);}};if(oTab.reminder)
oTab.reminder._onactive=function(bFirstTime){if(bFirstTime){this.event&&(this.event._wasActivated=true);var aData=me._others.get('EVENT_SETTINGS','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this.event,aData);this.gw&&(this.gw._wasActivated=true);var aData=me._others.get('GW_MYGROUP','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this.gw,aData);}};if(oTab.hollidays)
oTab.hollidays._onactive=function(bFirstTime){if(bFirstTime){if(currentBrowser()=='MSIE9')
this._getAnchor('msiebox').onresize=function(e){if(this.offsetHeight!=this.firstChild.offsetHeight)
this.firstChild.style.height=this.offsetHeight+'px';};storage.library('gw_holidays');if(!me._holidays){me._holidays=new gw_holidays;me._holidaysUId=[];}
var aHolidays=me._holidays.get('storage');if(typeof aHolidays=='object')
{me._holidaysUId=[];var aHolidayTitles=[];var aHolidayValues=[];for(var n in aHolidays)
{me._holidaysUId.push(aHolidays[n]['UID']);aHolidayTitles.push(aHolidays[n]['NAME']);if(aHolidays[n]['SUBSCRIBED']=='true')
aHolidayValues.push(n);}
this.holidays_list._fill(aHolidayTitles);this.holidays_list._value(aHolidayValues);}}};if(oTab.weather)
oTab.weather._onactive=function(bFirstTime){if(bFirstTime){if(currentBrowser()=='MSIE9')
this._getAnchor('msiebox').onresize=function(e){if(this.offsetHeight!=this.firstChild.offsetHeight)
this.firstChild.style.height=this.offsetHeight+'px';};var aData=me._others.get('CALENDAR_SETTINGS','storage');if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData);oTab.main&&(oTab.main._wasActivated=true);if(!me._holidays){storage.library('gw_holidays');me._holidays=new gw_holidays;}
var aCities=me._holidays.get('storage','WEATHER'),aTmp={},found={};for(var i in aCities)
if(aCities[i].SUBSCRIBED=='true')
aTmp[aCities[i].UID]=aCities[i].NAME||aCities[i].UID;this.x_cities._fill(aTmp);this.__showCities=function(aData){var city=oTab.weather.x_city,n=0;found={};if(aData)
for(var i in aData){found[i]=aData[i].city;n++;}
city._disabled(false);city._fill(found);if(n){city._value('');city._show();}
oTab.weather.x_find._disabled(false);};this.x_city._onclick=function(){if(this._value())
this._select();};this.x_city._onchange=function(e){var v=this._value();if(v){for(var i in found)
if(v==found[i]){aTmp[i]=found[i];break;}
this._parent.x_cities._fill(aTmp);}};this.x_find._onclick=function(e){this._disabled(true);this._parent.x_city._disabled(true);if(!me._tools){storage.library('wm_tools');me._tools=new wm_tools;}
this._parent.x_city._clean();me._tools.weather([this._parent.x_city._value()],[this._parent,'__showCities']);};this.x_city._onsubmit=function(){this._parent.x_find._onclick();};this.x_remove._onclick=function(){delete aTmp[this._parent.x_cities._value()];this._parent.x_cities._fill(aTmp);};}};oTab.main._active(true);};this.maintab.account_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(bFirstTime){var quotaupdate=function(aData){if(aData&&aData[sPrimaryAccount])
me.__primaryAccount=aData[sPrimaryAccount];if(me.__primaryAccount.MBOX_QUOTA>0&&me.__primaryAccount.MBOX_USAGE){oTab.primary.progress._range(me.__primaryAccount.MBOX_QUOTA);oTab.primary.progress._value(me.__primaryAccount.MBOX_USAGE);var v=0;if(me.__primaryAccount.MBOX_QUOTA>0)
v=roundTo(me.__primaryAccount.MBOX_USAGE/me.__primaryAccount.MBOX_QUOTA*100,1);oTab.primary.progress._title(v+'% ('+roundTo(me.__primaryAccount.MBOX_USAGE/1024,1)+' '+getLang('UNITS::MB')+' / '+roundTo(me.__primaryAccount.MBOX_QUOTA/1024,1)+' '+getLang('UNITS::MB')+')');}
if(me.__primaryAccount.SMS_LIMIT>0&&me.__primaryAccount.SMS_SENT){oTab.primary.progress2._range(me.__primaryAccount.SMS_LIMIT);oTab.primary.progress2._value(me.__primaryAccount.SMS_SENT);var v=0;if(me.__primaryAccount.SMS_LIMIT>0)
v=Math.ceil(me.__primaryAccount.SMS_SENT/(me.__primaryAccount.SMS_LIMIT/100));oTab.primary.progress2._title(v+'% ('+me.__primaryAccount.SMS_SENT+' / '+me.__primaryAccount.SMS_LIMIT+')');}};oTab.primary._onactive=function(bFirstTime){if(bFirstTime){this.fullname._value(me.__primaryAccount['FULLNAME']);if(this.alternative)
this.alternative._value(me.__primaryAccount['ALTERNATIVE']);if(me.__primaryAccount['LAST_TIME'])
this.x_last_time._value(IcewarpDate.unix(me.__primaryAccount['LAST_TIME']).format('L LT'));this.x_last_ip._value(me.__primaryAccount['LAST_IP']);if(this.progress||this.progress2)
WMAccounts.list({aid:sPrimaryAccount},'','','',[quotaupdate]);this.x_password&&(this.x_password._onclick=function(){gui._create('changepass','frm_changepass');});if(sPrimaryAccount2F>0){this.x_2f._onclick=function(){gui._create('verify','frm_verify');};if(sPrimaryAccount2FE){this.x_2fl._value(getLang('COMMON::ACTIVATED'));addcss(this.x_2fl._main,'active');}
else
this.x_2fl._value(getLang('COMMON::DEACTIVATED'));}}};if(oTab.other)
oTab.other._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));var out={},dg=this.groups;dg.__sortColumn='GROUP';dg.__sortType=0;dg._addColumns({'ACCOUNT':{title:'SETTINGS::ACCOUNT','width':100,mode:'%','arg':{'sort':'asc'},encode:true},'PROTOCOL':{title:'FORM_ACCOUNTS::PROTOCOL','width':80},'FOLDER':{title:'SETTINGS::SENT_FOLDER','width':110,'arg':{'sort':'asc'},encode:true},'TRASH':{title:'SETTINGS::TRASH_FOLDER','width':110,'arg':{'sort':'asc'},encode:true}});dg.__data_handler=function(){for(var i in me.__otherAccounts)
out[i]={data:{ACCOUNT:i,PROTOCOL:me.__otherAccounts[i].PROTOCOL,FOLDER:me.__otherAccounts[i].SENTFOLDER?Path.split(me.__otherAccounts[i].SENTFOLDER)[1]:getLang('SETTINGS::DEFAULT'),TRASH:me.__otherAccounts[i].TRASHFOLDER?Path.split(me.__otherAccounts[i].TRASHFOLDER)[1]:getLang('SETTINGS::DEFAULT')},arg:{account:i,folder:me.__otherAccounts[i].SENTFOLDER||'',trash:me.__otherAccounts[i].TRASHFOLDER||''}};dg._fill(out);};dg.__data_handler();dg._ondblclick=function(e,elm,arg,id,col,aClickType){if(arg)
oTab.other.x_edit._onclick();};this.x_add._onclick=function(e){gui._create('edit_dialog','frm_account','','',[me,function(aValues){var sAccountID=aValues['EMAIL'];if(!sAccountID)
return;if(aValues.SENTFOLDER==GWOthers.getItem('DEFAULT_FOLDERS','sent'))
delete aValues.SENTFOLDER;if(aValues.TRASHFOLDER==GWOthers.getItem('DEFAULT_FOLDERS','trash'))
delete aValues.TRASHFOLDER;me.__otherAccounts[sAccountID]=aValues;if(me.__state[sAccountID]&&me.__state[sAccountID]!='new')
me.__state[sAccountID]='edited';else
me.__state[sAccountID]='new';dg.__data_handler();}]);};this.x_edit._onclick=function(){var v=dg._value();for(var i in v)
if(dg._aData[v[i]]){gui._create('edit_dialog','frm_account','','',[me,function(aValues,sAccountID){if(sAccountID){for(var i in aValues){if(i=='PASSWORD'&&aValues[i]=='')
continue;if(aValues[i].SENTFOLDER==GWOthers.getItem('DEFAULT_FOLDERS','sent'))
delete aValues[i].SENTFOLDER;if(aValues[i].TRASHFOLDER==GWOthers.getItem('DEFAULT_FOLDERS','trash'))
delete aValues[i].TRASHFOLDER;me.__otherAccounts[sAccountID][i]=aValues[i];}
if(me.__state[sAccountID]!='new')
me.__state[sAccountID]='edited';dg.__data_handler();}}],v[i],me.__otherAccounts[v[i]]);break;}};this.x_remove._onclick=function(){var v=dg._value();for(var i=v.length-1;i>=0;i--){me.__state[v[i]]='deleted';delete dg._aData[v[i]];}
dg._fill();};}};oTab.certificate&&(oTab.certificate._onactive=function(bFirstTime){if(bFirstTime){var aData=dataSet.get('storage',['CERTIFICATE','ITEMS']),tmp,aCerts=[];for(var i in aData)
if(aData[i].VALUES&&aData[i].VALUES.INFO&&aData[i].VALUES.INFO.VALUE){tmp=XMLTools.Str2Arr(aData[i].VALUES.INFO.VALUE).INFO[0];aCerts.push({'id':aData[i].ATTRIBUTES.UID,'name':tmp.SUBJECT[0].CN?tmp.SUBJECT[0].CN[0].VALUE:'','class':'attachment','email':tmp.SUBJECT[0].EMAILADDRESS?tmp.SUBJECT[0].EMAILADDRESS[0].VALUE:'','expires':tmp.VALIDTO[0].VALUE,'data':tmp});}
this.X_CERT._value({'values':aCerts});this.X_CERT.file._dropzone(this._main);}});oTab.primary._active(true);}};if(this.maintab.licenses)
this.maintab.licenses._onactive=function(bFirstTime){if(bFirstTime){var stmp=GWOthers.getItem('LICENSES','desktop');this.maintab.desktop.X_KEY._value(stmp||getLang('LICENSE::NOKEY'));if(stmp)
this.maintab.desktop.X_KEY._onclick=function(){this._setRange(0,this._value().length);};else
this.maintab.desktop.X_KEY._disabled(true);stmp=GWOthers.getItem('LICENSES','outlook');this.maintab.outlook.X_KEY._value(stmp||getLang('LICENSE::NOKEY'));if(stmp)
this.maintab.outlook.X_KEY._onclick=function(){this._setRange(0,this._value().length);};else
this.maintab.outlook.X_KEY._disabled(true);}};this.maintab.backup._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.contact._active(false);return;}
var oImport=new wm_import();var progressCount=0;function monitorProgress(){oImport.import_progress([me,function(result){if(result.complete){if(oTab.contact.progress2&&!oTab.contact.progress2._destructed)
oTab.contact.progress2._destruct();return;}
if(oTab.contact.progress2&&result.progress&&result.total){var percent=parseInt(100*result.progress/result.total);oTab.contact.progress2._value(getLang('BACKUP::PROCESSING')+' - '+percent+' %');oTab.contact.progress2.bar._value(percent);}
me.__import_progress_timeout=setTimeout(monitorProgress,progressCount++>10?(progressCount>20?(progressCount>38?(progressCount>50?30000:15000):5000):2000):1000);}]);}
oTab.contact.folders._value(sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType('C'));oImport.import_progress([me,function(result){if(!result.complete){oTab.contact._create('progress2','obj_loader','main');oTab.contact.progress2._value(getLang('BACKUP::PROCESSING'));oTab.contact.progress2._create('bar','obj_progress','main','neutral center');me.__import_progress_timeout=setTimeout(monitorProgress,1000);}}]);me._add_destructor('__import_destruct');oTab.contact.step3._onuploadstart=function(){me._create('progress','obj_loader','main');me.progress._value(getLang('BACKUP::PROCESSING'));};oTab.contact.step3._onuploadend=function(arg){me.progress._destruct();if((arg=arg[arg.length-1])&&arg.folder&&arg.id){me.__value=arg;switch(arg.name.substr(arg.name.lastIndexOf('.')+1).toLowerCase()){case'txt':case'csv':me.__value.action='csv';break;case'ldif':me.__value.action='ldif';break;case'vcf':me.__value.action='vcard';break;case'vcs':case'ics':me.__value.action='vcalendar';break;default:gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::UNKNOWN_EXT'}});return;}
if(me.__value.action=='vcalendar'){oTab.contact.folders._setType(['E','T','N','J']);oTab.contact.folders._value(sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType('E'));}
else{oTab.contact.folders._setType('C');oTab.contact.folders._value(sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType('C'));}
oTab.contact['import']._onclick=function(){this._disabled(true);var aFolder=Path.split(oTab.contact.folders._value()),elm=document.getElementById(this._parent._pathName+'#csv');var result=oImport.import_data({'action':me.__value.action,'account':sPrimaryAccount,'folder':aFolder[1],'lines':(me.__value.action=='csv'?5:0),'path':(me.__value.folder+'/'+me.__value.id)});if(me.__value.action=='csv'&&Is.Array(result)){removecss(elm,'hidden');this._parent.step4._fill(result);this._parent.step5._disabled(false);var parent=this._parent;oTab.contact.step4z._onchange=function(){result=oImport.import_data({'action':me.__value.action,'account':sPrimaryAccount,'folder':aFolder[1],'lines':(me.__value.action=='csv'?5:0),'charset':oTab.contact.step4z._value()=='*'?'':oTab.contact.step4z._value(),'path':(me.__value.folder+'/'+me.__value.id)}),parent.step4._refill(result);};}else{if(result){gui.notifier._value({type:'success',args:{header:'BACKUP::IMPORT_SUCCESSFUL'}});}else{gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::IMPORT_UNSUCCESSFUL'}});}
addcss(elm,'hidden');oTab.contact.folders._disabled(true);me.__value=null;}};oTab.contact.folders._disabled(false);oTab.contact['import']._disabled(false);}
return true;};oTab.contact.step5._onclick=function(){if(me.__value.folder&&me.__value.id){var aFolder=Path.split(oTab.contact.folders._value()),aData=this._parent.step4._value();if(!count(aData)){gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::SELECT_COL'}});return;}
else
if(!aData.LOCATIONS){gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::SELECT_EMAIL'}});return;}
oTab.contact._create('progress2','obj_loader','main');oTab.contact.progress2._value(getLang('BACKUP::PROCESSING'));oTab.contact.progress2._create('bar','obj_progress','main','neutral center');var oImport=new wm_import();var that=this;oImport.import_data({'action':'csv','values':aData,'folder':aFolder[1],'account':sPrimaryAccount,'skipfirst':!!that._parent.step4x._value(),'share':that._parent.step4y._value()=='*'?'':that._parent.step4y._value(),'format':that._parent.step4format._value()=='*'?'':that._parent.step4format._value(),'charset':that._parent.step4z._value()=='*'?'':that._parent.step4z._value(),'path':me.__value.folder+'/'+me.__value.id},[me,function(result){oTab.contact.progress2._destruct();if(me.__import_progress_timeout)
clearTimeout(me.__import_progress_timeout);if(result){that._parent.step4._fill();me.__value=null;var elm=document.getElementById(that._parent._pathName+'#csv');addcss(elm,'hidden');if(result===true)
gui.notifier._value({type:'success',args:{header:'',text:'BACKUP::IMPORT_SUCCESSFUL'}});else
gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::IMPORT_FINISHED',args:[result]}});if(dataSet.get('active_folder')==sPrimaryAccount+'/'+aFolder[1]&&gui.frm_main)
gui.frm_main._refreshItems(sPrimaryAccount);}
else
gui.notifier._value({type:'alert',args:{header:'',text:'BACKUP::IMPORT_UNSUCCESSFUL'}});}]);me.__import_progress_timeout=setTimeout(monitorProgress,1000);}};if(oTab.csv){oTab.csv.folders._value(sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType('C'));oTab.csv.separator._onchange=function(){oTab.csv.date_format._disabled(this._value()=='vcard');};oTab.csv['export']._onclick=function(){if(this._parent.separator._value()=='vcard')
downloadItem(buildURL({'sid':dataSet.get('main',['sid']),'class':'exportvcard','fullpath':oTab.csv.folders._value()}));else{var tmp={'sid':dataSet.get('main',['sid']),'class':'exportcsv','fullpath':oTab.csv.folders._value()+'/'+this._parent.separator._value()};if(oTab.csv.date_format._value()!='*')
tmp.format=oTab.csv.date_format._value();downloadItem(buildURL(tmp));}};}
if(oTab.gw.export_gw)
oTab.gw.export_gw._onclick=function(){downloadItem('sid='+dataSet.get('main',['sid'])+'&class=groupware&fullpath='+sPrimaryAccount);};oTab.gw.import_gw._onuploadend=function(arg){arg=arg[arg.length-1];if(arg.folder&&arg.id){var oImport=new wm_import(),str='';if(oImport.import_data({'action':'groupware','account':sPrimaryAccount,'path':(arg.folder+'/'+arg.id)}))
str='BACKUP::IMPORT_SUCCESSFUL';else
str='BACKUP::IMPORT_UNSUCCESSFUL';gui.notifier._value({type:'alert',args:{header:'',text:str}});}};oTab.contact._active(true);};if(sTab1){this.maintab._getChildObjects('','obj_tab').forEach(function(tab){tab._wasActivated=false;});this.maintab[sTab1]._active(true);if(sTab2){this.maintab[sTab1]._getChildObjects('','obj_tab').forEach(function(tab){tab._wasActivated=false;});this.maintab[sTab1].maintab[sTab2]._active(true);}}};_me.__import_destruct=function(){if(this.__import_progress_timeout)
clearTimeout(this.__import_progress_timeout);};_me.__saveAccounts=function(){var update=false,accounts=new wm_accounts,primary={},oAccountTab=this.maintab.account_settings.maintab;if(oAccountTab.other&&(GWOthers.getItem('RESTRICTIONS','disable_otheraccounts')||0)<1)
for(var sEmail in this.__state){var aValues=this.__otherAccounts[sEmail];switch(this.__state[sEmail]){case'edited':aValues['aid']=sEmail;case'new':update=true;accounts.add(aValues,'folders','',[gui.frm_main,'_refreshItems',[sEmail]]);dataSet.add('accounts',[sEmail],aValues);var value=gui.frm_main.bar.tree.folders._value();value.push(sEmail);gui.frm_main.bar.tree.folders._value(value);break;case'deleted':accounts.remove({'aid':sEmail},'accounts','','folders');dataSet.remove('accounts',[sEmail]);update=true;break;default:continue;}}
if(oAccountTab.primary){var fname=oAccountTab.primary.fullname._value();if(fname!=(this.__primaryAccount['FULLNAME']||''))
primary['FULLNAME']=fname;if(oAccountTab.primary.alternative){var alternative=oAccountTab.primary.alternative._value();if(alternative!=(this.__primaryAccount['ALTERNATIVE']||''))
primary['ALTERNATIVE']=alternative;}}
if(count(primary)>0){for(var i in primary)
dataSet.add('accounts',[sPrimaryAccount,i],primary[i]);update=true;primary['aid']=sPrimaryAccount;accounts.add(primary,'folders','',[this,'__saveAccountsHandler']);this.x_btn_ok._disabled(true);return false;}else
this.__saveItems();if(update)
gui.frm_main.bar.tree.folders._fill();return true;};_me.__saveAccountsHandler=function(aData,sErrorValue){if(typeof aData=='string'){var me=this;switch(aData){case'account_password_policy':var s,str='<ul>',aResource=dataSet.get('storage',['PASSWORD_POLICY','ITEMS',0,'VALUES']);for(var i in aResource){if(aResource[i].VALUE>0&&(s=getLang('POLICY::'+i,[aResource[i].VALUE],2)))
str+='<li>'+s+'</li>';}
str+='<li>'+getLang('POLICY::LATIN')+'</li>';str+='<li>'+getLang('POLICY::DIACRITICS')+'</li>';str+='</ul>';gui._create('alert','frm_alert','','',[function(){try{me.maintab.account_settings._active(true);me.maintab.account_settings.maintab.primary.x_new_password._focus();}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}}],'ALERTS::PASSWORD_POLICY','',getLang('ALERTS::PASSWORD_REQUIREMENTS')+str);break;default:gui._create('alert','frm_alert','','',[function(){try{me.maintab.account_settings._active(true);me.maintab.account_settings.maintab.primary.x_old_password._focus();}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}}],'','ALERTS::INVALID_PASSWORD');}
this.x_btn_ok._disabled(false);}
else{gui.frm_main.bar.tree.folders._fill();this.__saveItems();}};_me.__saveItems=function()
{if(!this.maintab){return;}
var me=this,aValues={};dataSet.add('tmp_storage','',dataSet.get('storage','',true));function storeNonWellKnown(oForm,sResource){var aValues={};if(oForm&&oForm._wasActivated){storeDataFromForm(oForm,aValues);me._others.set(sResource,aValues,'storage');}}
if(sPrimaryAccountGUEST){var aValues={};var teamchatValues={};storeDataFromForm(this,aValues);for(var i in aValues){if(~i.indexOf('u_gw_teamchat')){teamchatValues[i]=aValues[i];delete aValues[i];}}
me._others.set('CHAT',aValues,'storage');me._others.set('TEAMCHAT_NOTIFY',teamchatValues,'storage');}
else{if(this.maintab.mail_settings&&this.maintab.mail_settings._wasActivated){var oTab=this.maintab.mail_settings.maintab;storeNonWellKnown(oTab.general,'MAIL_SETTINGS_GENERAL');storeNonWellKnown(oTab.mail_default,'MAIL_SETTINGS_DEFAULT');storeNonWellKnown(oTab.readconfirmation,'READ_CONFIRMATION');if(oTab.signature&&oTab.signature._wasActivated){oTab.signature.list.__save_text.call(oTab.signature);var out=[],tmp,aSigns=oTab.signature.__signatures;for(var i in aSigns){tmp={ATTRIBUTES:{ACCESS:'full',DONT_SEND:false},VALUES:{TEXT:{ATTRIBUTES:{ACCESS:'full'},VALUE:aSigns[i].text}}};if(i>0){tmp.VALUES.ID={ATTRIBUTES:{ACCESS:'full'},VALUE:i};tmp.VALUES.NAME={ATTRIBUTES:{ACCESS:'full'},VALUE:aSigns[i].name};}
out.push(tmp);}
dataSet.add('storage',['SIGNATURE','ITEMS'],out,1);dataSet.add('storage',['SIGNATURE','ATTRIBUTES','DONT_SEND'],false,1);}
if(oTab.alias&&oTab.alias._wasActivated){dataSet.add('storage',['ALIASES','ATTRIBUTES','DONT_SEND'],false,1);}
if(oTab.autoresponder&&oTab.autoresponder._wasActivated){aValues=oTab.autoresponder.autoresponder._value();if(aValues['u_respondbetweenfrom']){var from=IcewarpDate.julian(aValues['u_respondbetweenfrom']).getMoment().toObject();from['months']=from['months']+1;aValues['u_respondbetweenfrom']=from['years']+'/'+(from['months']<10?'0'+from['months']:from['months'])+'/'+(from['date']<10?'0'+from['date']:from['date']);}
if(aValues['u_respondbetweento']){var to=IcewarpDate.julian(aValues['u_respondbetweento']).getMoment().toObject();to['months']=to['months']+1;aValues['u_respondbetweento']=to['years']+'/'+(to['months']<10?'0'+to['months']:to['months'])+'/'+(to['date']<10?'0'+to['date']:to['date']);}
this._others.set('AUTORESPONDER',aValues,'storage');}
if(oTab.forwarder&&oTab.forwarder._wasActivated){aValues={};storeDataFromForm(oTab.forwarder,aValues);if(!oTab.forwarder.u_forwardolder._value()){delete aValues['u_forwardolderdays'];delete aValues['u_forwardolderto'];}
this._others.set('FORWARDER',aValues,'storage');}
if(oTab.rules&&oTab.rules._wasActivated){var aValues,aFilters=[];for(var i in oTab.rules.__valuesOfLines){aValues=oTab.rules.__valuesOfLines[i];if(!Is.Empty(aValues['CONDITION'])){aFilters.push(aValues);}}
if(Is.Empty(aFilters))
delete oTab.rules._aXmlFilter['CONTENTFILTER'][0]['FILTER'];else
oTab.rules._aXmlFilter['CONTENTFILTER'][0]['FILTER']=aFilters;oTab.rules._aStorageFilters['VALUES']['u_rulescontentxml']=(XMLTools.Arr2Str(oTab.rules._aXmlFilter,true)).replace(/></g,'>\n<');GWOthers.set('FILTER_RULES',oTab.rules._aStorageFilters['VALUES'],'storage');WMStorage.set({'resources':dataSet.get('storage')},'storage');}}
if(this.maintab.im_settings&&this.maintab.im_settings._wasActivated){var oTab=this.maintab.im_settings.maintab;oTab.general&&storeNonWellKnown(oTab.general,'IM');oTab.chat&&storeNonWellKnown(oTab.chat,'IM');}
if(this.maintab.teamchat_settings&&this.maintab.teamchat_settings._wasActivated){var oTab=this.maintab.teamchat_settings.maintab;oTab.general&&storeNonWellKnown(oTab.general,'CHAT');if(oTab.digest&&oTab.digest._wasActivated){var aValues={};var bValues={};storeDataFromForm(oTab.digest,aValues);for(var i in aValues){if(i==='teamchat_notify'){bValues[i]=aValues[i];delete(aValues[i]);}}
me._others.set('TEAMCHAT_NOTIFY',aValues,'storage');me._others.set('GLOBAL_SETTINGS',bValues,'storage');}}
if(this.maintab.sip_settings&&this.maintab.sip_settings._wasActivated){var oTab=this.maintab.sip_settings.maintab;if(oTab.general&&oTab.general._wasActivated){storeNonWellKnown(oTab.general,'SIP');if(oTab.general.x_java._value()=='x'){me._others.setItem('SIP','mode','integrate');if(gui.dial){gui.frm_main.sip&&gui.frm_main.sip._destruct();gui._create('dial','frm_dial');}
else
if(GWOthers.getItem('SIP','start')>0){try{gui.frm_main._create('sip','obj_sip');}
catch(err){gui._create('alert','frm_alert','','',null,'SIP::ERROR',null,err.message||getLang('SIP::ONLINE_FAILED'));this.maintab.sip_settings._active(true);oTab.general._active(true);return false;}}}
else{if(oTab.general.x_dial_ext&&oTab.general.x_dial_ext._value()=='x')
me._others.setItem('SIP','mode','external');else
me._others.setItem('SIP','mode','phone');gui.frm_main.sip&&gui.frm_main.sip._logout();}}
if(oTab.forward&&oTab.forward._wasActivated)
storeNonWellKnown(oTab.forward,'CALL_FORWARDING');}
if(this.maintab.general_settings&&this.maintab.general_settings._wasActivated){var oTab=this.maintab.general_settings.maintab;storeNonWellKnown(oTab.layout,'LAYOUT_SETTINGS');storeNonWellKnown(oTab.folders,'DEFAULT_FOLDERS');if(oTab.layout&&oTab.layout._wasActivated&&oTab.layout.notifications._value()!=2&&gui.notifier&&gui.notifier._getPermissions()!='unsupported'&&gui.notifier._getPermissions()!='granted'){if(gui.notifier._getPermissions()=='denied')
gui.notifier._setPermissions();else
window.Notification.requestPermission(function(perm){window.Notification.permission=perm;});}
if(oTab.antispam&&oTab.antispam._wasActivated)
storeNonWellKnown(oTab.antispam,'ANTISPAM');if(oTab.documents)
storeNonWellKnown(oTab.documents,'DOCUMENTS');if(oTab.documents.x_ownautorevisionmode)
me._others.setItem('GW_MYGROUP','ownautorevisionmode',oTab.documents.x_ownautorevisionmode._value());IcewarpDate.setCalendar(+GWOthers.getItem('LAYOUT_SETTINGS','alternative_calendar'),true);dataSet.update('folders');}
if(this.maintab.calendar_settings&&this.maintab.calendar_settings._wasActivated){var oTab=this.maintab.calendar_settings.maintab;storeNonWellKnown(oTab.main,'CALENDAR_SETTINGS');storeNonWellKnown(oTab.default_settings,'DEFAULT_CALENDAR_SETTINGS');if(oTab.reminder&&oTab.reminder._wasActivated){storeNonWellKnown(oTab.reminder.event,'EVENT_SETTINGS');storeNonWellKnown(oTab.reminder.gw,'GW_MYGROUP');dataSet.add('storage',['GW_MYGROUP','ITEMS',0,'VALUES','GRPDAILYEVENTSEMAIL'],{'VALUE':dataSet.get('storage',['GW_MYGROUP','ITEMS',0,'VALUES','GRPREMINDEREMAIL','VALUE']),'ATTRIBUTES':[]},1);}
if(oTab.hollidays&&oTab.hollidays._wasActivated){aValues={};storeDataFromForm(oTab.hollidays,aValues);aValues=aValues['holidays_list'];var aHolidays={};for(var n in this._holidaysUId)
aHolidays[this._holidaysUId[n]]='false';for(var n in aValues)
aHolidays[this._holidaysUId[aValues[n]]]='true';this._holidays.set(aHolidays,'storage');}
if(oTab.weather&&oTab.weather._wasActivated){var aCities=me._holidays.get('storage','WEATHER'),aValues=oTab.weather.x_cities.__idTable,aWeather={};for(var i in aCities)
if(!aValues[aCities[i].UID]&&aCities[i].SUBSCRIBED=='true')
aWeather[aCities[i].UID]='false';for(var i in aValues)
if(!aWeather[i])
aWeather[i]='true';if(count(aWeather)>0)
this._holidays.set(aWeather,'storage','WEATHER');storeNonWellKnown(oTab.weather,'CALENDAR_SETTINGS');}
IcewarpDate.Locale.changeLocalizedFormat('L',CalendarFormatting.getFormat(+GWOthers.getItem('LAYOUT_SETTINGS','date_format')));IcewarpDate.Locale.changeLocalizedFormat('LT',+GWOthers.getItem('LAYOUT_SETTINGS','time_format')?'hh:mm a':'HH:mm');if(GWOthers.getItem('CALENDAR_SETTINGS','begin_on_today')!='0'){IcewarpDate.Locale.setCustomWeekStart((new IcewarpDate()).day());}else{IcewarpDate.Locale.setCustomWeekStart({monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6,sunday:0}[GWOthers.getItem('CALENDAR_SETTINGS','week_begins')]);}
IcewarpDate.Locale.chooseLocale(GWOthers.getItem('LAYOUT_SETTINGS','language'));}
if(this.maintab.account_settings&&this.maintab.account_settings._wasActivated){var oTab=this.maintab.account_settings.maintab;if(oTab.certificate&&oTab.certificate._wasActivated){var v=oTab.certificate.X_CERT._value();if(count(v)>0){var out=[],tmp;for(var i in v)
if(v[i].uid)
out.push({ATTRIBUTES:{ACCESS:'full',DONT_SEND:false,UID:v[i].uid}});else
if(v[i].fullpath){tmp={ATTRIBUTES:{ACCESS:'full',DONT_SEND:false},VALUES:{FILE:{ATTRIBUTES:{ACCESS:'full'},VALUE:v[i].fullpath}}};if(v[i].passphrase)
tmp.VALUES.PASSPHRASE={ATTRIBUTES:{ACCESS:'full'},VALUE:v[i].passphrase};out.push(tmp);}
dataSet.add('storage',['CERTIFICATE','ITEMS'],out,1);dataSet.add('storage',['CERTIFICATE','ATTRIBUTES','DONT_SEND'],false,1);}}}}
var nOK=WMStorage.set({'resources':dataSet.get('storage')},'storage','',[this,'__saveItemsHandler']);if(nOK==2)
{dataSet.remove('tmp_storage');GWOthers.load(this.resources,false,false,true);this._destruct();}
else
this._main.style.display="none";};_me.__saveItemsHandler=function(bOK)
{if(bOK){dataSet.remove('tmp_storage');GWOthers.load(this.resources,false,false,true);var aRes=[];if(this.maintab&&this.maintab.account_settings&&this.maintab.account_settings._wasActivated&&this.maintab.account_settings.maintab.certificate&&this.maintab.account_settings.maintab.certificate._wasActivated)
aRes.push('certificate');if(this.maintab&&this.maintab.mail_settings&&this.maintab.mail_settings._wasActivated&&this.maintab.mail_settings.maintab.signature&&this.maintab.mail_settings.maintab.signature._wasActivated)
aRes.push('signature');if(aRes.length)
WMStorage.get({'resources':aRes},'storage','','',true);if(GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0){if(!gui.frm_main.bar.fav&&WMFolders.getType(Path.split(dataSet.get('active_folder')||''))!='I')
gui.frm_main.bar._create('fav','obj_barmenu_favorites',{target:'top',first:true},'',0,'FAVORITES::FAVORITES');}
else
if(gui.frm_main.bar.fav)
gui.frm_main.bar.fav._destruct();try{var font=GWOthers.getItem('LAYOUT_SETTINGS','font_weight');if(font=='auto')
font=gui.__BROWSER.retina?'light':'normal';if(font=='light')
addcss(document.body,'light');else
removecss(document.body,'light');var night_mode_enabled=this.maintab.general_settings.maintab.layout.night_mode._value()==1;if((this.__oldData.LAYOUT_SETTINGS.ITEMS[0].VALUES.SKIN||{}).VALUE!=GWOthers.getItem('LAYOUT_SETTINGS','skin')||(this.__oldData.LAYOUT_SETTINGS.ITEMS[0].VALUES.SKIN_STYLE||{}).VALUE!=GWOthers.getItem('LAYOUT_SETTINGS','skin_style')){NightMode().reset();storage.css('style',true,function(){if(night_mode_enabled){NightMode().activate();}}.bind(this));}else if(night_mode_enabled){NightMode().activate();}else{NightMode().reset();}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
this._destruct();gui.frm_main._getNew();}
else{dataSet.add('storage','',dataSet.get('tmp_storage'));dataSet.remove('tmp_storage');this._main.style.display="block";}};

/* client/inc/frm_settings_admin.js */
_me=frm_settings_admin.prototype;function frm_settings_admin(){};_me.__constructor=function(bDomainadmin,sDomainName)
{var me=this;this._defaultSize(-1,-1,850,620);if((this._bDomainadmin=bDomainadmin?true:false))
this._title(getLang('MAIN_MENU::DOMAIN_OPTIONS')+(sDomainName?' ('+sDomainName+')':''),true);else
this._title('MAIN_MENU::ADMIN_OPTIONS');this._xmlns='public';if(this._bDomainadmin){this._draw('frm_settings_domainadmin','main',{domain_settings:true,'gw_access':sPrimaryAccountGW>0,'im_access':sPrimaryAccountIM>0,'chat_access':sPrimaryAccountCHAT>0});this._storage='domainadmin_storage';if(sDomainName){this._domain=sDomainName.trim();this._storage+='_'+this._domain;}
else
this._domain=dataSet.get('main',['domain']);}
else{storage.library('wm_domains');this._domains=new wm_domains;this._draw('frm_settings_admin','main',{admin_settings:true,'gw_access':sPrimaryAccountGW>0,'im_access':sPrimaryAccountIM>0,'chat_access':sPrimaryAccountCHAT>0});this._storage='admin_storage';}
var aRsc=['skins','mail_settings_general','mail_settings_default','layout_settings','languages','reset_settings','calendar_settings','default_calendar_settings','event_settings','global_settings','spellchecker_languages','restrictions','homepage_settings','external_settings','groups','signature','teamchat_notify','documents'];if(sPrimaryAccountIM>0){aRsc.push('im');aRsc.push('chat');}
if(!this._bDomainadmin)
aRsc.push('domains_settings');storage.library('wm_storage');storage.library('frm_settings_helper');if(this._bDomainadmin&&this._domain)
dataSet.add(this._storage,'',WMStorage.get({'xmlns':this._xmlns,'domain':this._domain,'resources':aRsc}));else
dataSet.add(this._storage,'',WMStorage.get({'xmlns':this._xmlns,'resources':aRsc}));this.__loadItems();this.x_btn_ok._onclick=function(){me.__saveItems();};this.__helper=new FrmSettingsHelper(this._bDomainadmin,true);};_me.__loadItems=function()
{if(!this.maintab){return;}
var me=this;this.maintab.mail_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.general._active(false);return;}
oTab.general._onactive=function(bFirstTime){if(bFirstTime){this.show_inline_images._onchange=function(){oTab.general.show_images._disabled(!this._checked());};this.default_flag._fillLang({'1':["COLOR_LABELS::RED_FLAG",'bg_red'],'2':["COLOR_LABELS::BLUE_FLAG",'bg_blue'],'3':["COLOR_LABELS::GREEN_FLAG",'bg_green'],'5':["COLOR_LABELS::ORANGE_FLAG",'bg_orange'],'8':["COLOR_LABELS::PURPLE_FLAG",'bg_purple'],'a':["COLOR_LABELS::YELLOW_FLAG",'bg_yellow']});var aData=GWOthers.get('MAIL_SETTINGS_GENERAL',me._storage,true);if(aData)
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}}
oTab.mail_default._onactive=function(bFirstTime){if(bFirstTime){this.html_message._onchange=function(){me.__helper.htmlMessageFormatChange(this._parent,'0'===this._value());};var aLang=dataSet.get(me._storage,['SPELLCHECKER_LANGUAGES','ITEMS']);var aData={};for(var i in aLang)
if(aLang[i].VALUES&&aLang[i].VALUES.PATH&&aLang[i].VALUES.NAME)
aData[aLang[i].VALUES.PATH.VALUE]=aLang[i].VALUES.NAME.VALUE;this.spellchecker._fill(aData);aLang=dataSet.get('storage',['FONTS','ITEMS']);aData={'0':getLang('SETTINGS::DEFAULT')};for(var i in aLang)
if(aLang[i].VALUES.FAMILY.VALUE)
aData[aLang[i].VALUES.FAMILY.VALUE]=aLang[i].VALUES.NAME.VALUE;this.font_family._fill(aData);var aData=GWOthers.get('MAIL_SETTINGS_DEFAULT',me._storage,true);if(aData)
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);if(!this.font_family._value())
this.font_family._value('0');}};oTab.groups._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));var ds=dataSet.get(me._storage,['GROUPS','ITEMS']),dg=this.groups;dg.__sortColumn='GROUP';dg.__sortType=0;dg._addColumns({'GROUP':{title:'SETTINGS::GROUP','width':50,mode:'%','arg':{'sort':'asc'},encode:true},'FOLDER':{title:'SETTINGS::SENT_FOLDER','width':50,mode:'%','arg':{'sort':'asc'},encode:true}});if(Is.Array(ds))
for(var out={},i=0;i<ds.length;i++)
if(ds[i].VALUES&&ds[i].VALUES.GROUP)
out[ds[i].VALUES.GROUP.VALUE]={data:{GROUP:ds[i].VALUES.GROUP.VALUE,FOLDER:ds[i].VALUES.SENTFOLDER&&ds[i].VALUES.SENTFOLDER.VALUE?ds[i].VALUES.SENTFOLDER.VALUE:getLang('SETTINGS::DEFAULT')},arg:{group:ds[i].VALUES.GROUP.VALUE,folder:ds[i].VALUES.SENTFOLDER&&ds[i].VALUES.SENTFOLDER.VALUE?sPrimaryAccount+'/'+ds[i].VALUES.SENTFOLDER.VALUE:''}};dg._fill(out);dg.__grouphandler=function(a,b){if(a&&dg._aData[a.group])
delete dg._aData[a.group];dg._aData[b.group]={data:{GROUP:b.group,FOLDER:b.folder?Path.split(b.folder)[1]:getLang('SETTINGS::DEFAULT')},arg:b};dg._fill();};dg._ondblclick=function(e,elm,arg,id,col,aClickType){if(arg)
oTab.groups.x_edit._onclick();};function dialog(arg,aHandler){var frm=gui._create('add_group','frm_ok_cancel','','frm_group');frm._modal(true);frm._resizable(false);frm._title('SETTINGS::GROUP');frm._size(380,183,true);frm._draw('frm_group','main');frm.folder._value(arg&&arg.folder?arg.folder:GWOthers.getItem('DEFAULT_FOLDERS','sent'));if(arg&&arg.group)
frm.group._value(arg.group);frm.group._onerror=function(b){frm.x_btn_ok._disabled(b);};frm.group._restrict([function(v){if(v){var tmp=MailAddress.splitEmailsAndNames(v);if(tmp[0]&&tmp[0].email&&Is.Email(tmp[0].email))
return true;}
return false;}]);frm.group._onsubmit=function(){frm.x_btn_ok._onclick();};frm.x_btn_ok._onclick=function(){if(aHandler){var tmp=MailAddress.splitEmailsAndNames(frm.group._value());if(tmp[0]&&tmp[0].email&&Is.Email(tmp[0].email))
executeCallbackFunction(aHandler,arg,{group:tmp[0].email,folder:frm.folder._value()==GWOthers.getItem('DEFAULT_FOLDERS','sent')?'':frm.folder._value()})}
this._parent._destruct();};};this.x_add._onclick=function(e){dialog('',[dg,'__grouphandler']);};this.x_edit._onclick=function(){var v=dg._value();for(var i in v)
if(dg._aData[v[i]]){dialog(dg._aData[v[i]].arg,[dg,'__grouphandler']);break;}};this.x_remove._onclick=function(){var v=dg._value();for(var i=v.length-1;i>=0;i--)
delete dg._aData[v[i]];dg._fill();};}};oTab.signature._onactive=function(bFirstTime){if(bFirstTime){msiebox(this._getAnchor('msiebox'));this.text._create('vars','obj_select','additional');this.text.vars._fill({'*':getLang('SIGNATURE::VARIABLE'),'%displayname%':getLang('CONTACT::DISPLAYNAME'),'%firstname%':getLang('CONTACT::FIRST_NAME'),'%middlename%':getLang('CONTACT::MIDDLE_NAME'),'%surname%':getLang('CONTACT::LAST_NAME'),'%fullname%':getLang('CONTACT::FULL_NAME'),'%nickname%':getLang('CONTACT::NICK_NAME'),'%title%':getLang('CONTACT::TITLE'),'%suffix%':getLang('CONTACT::SUFFIX'),'%email1%':getLang('CONTACT::EMAIL1'),'%email2%':getLang('CONTACT::EMAIL2'),'%email3%':getLang('CONTACT::EMAIL3'),'%im%':getLang('CONTACT::IM'),'%freebusy%':getLang('CONTACT::CALENDAR_URL'),'%company%':getLang('CONTACT::COMPANY'),'%job%':getLang('CONTACT::JOB'),'%profession%':getLang('CONTACT::PROFESSION'),'%department%':getLang('CONTACT::DEPARTMENT'),'%assistant%':getLang('CONTACT::ASSISTANT'),'%manager%':getLang('CONTACT::MANAGER'),'%homepage%':getLang('CONTACT::HOMEPAGE'),'%street%':getLang('CONTACT::STREET'),'%city%':getLang('CONTACT::CITY'),'%state%':getLang('CONTACT::STATE'),'%zip%':getLang('CONTACT::ZIP'),'%country%':getLang('CONTACT::COUNTRY'),'%phonehome%':getLang('CONTACT::PHONE')+' '+getLang('PHONE::LCTPHNHOME1'),'%phonehome2%':getLang('CONTACT::PHONE')+' '+getLang('PHONE::LCTPHNHOME2'),'%phonemobile%':getLang('PHONE::LCTPHNMOBILE'),'%phoneassistant%':getLang('CONTACT::PHONE')+' '+getLang('PHONE::LCTPHNASSISTANT'),'%phonework%':getLang('CONTACT::PHONE')+' '+getLang('PHONE::LCTPHNWORK1'),'%phonework2%':getLang('CONTACT::PHONE')+' '+getLang('PHONE::LCTPHNWORK2'),'%faxhome%':getLang('PHONE::LCTPHNFAXHOME'),'%faxwork%':getLang('PHONE::LCTPHNFAXWORK'),'%faxother%':getLang('PHONE::LCTPHNOTHERFAX'),'%phonecallback%':getLang('PHONE::LCTPHNCALLBACK'),'%phonecompany%':getLang('PHONE::LCTPHNCOMPANY'),'%phonecar%':getLang('PHONE::LCTPHNCAR'),'%phoneisdn%':getLang('PHONE::LCTPHNISDN'),'%phoneother%':getLang('PHONE::LCTPHNOTHER'),'%phonepager%':getLang('PHONE::LCTPHNPAGER'),'%phoneprimary%':getLang('PHONE::LCTPHNPRIMARY'),'%phoneradio%':getLang('PHONE::LCTPHNRADIO'),'%phonetelex%':getLang('PHONE::LCTPHNTELEX'),'%phonehearing%':getLang('PHONE::LCTPHNHEARING'),'%phonesip%':getLang('PHONE::SIP'),'%businesshomepage%':getLang('CONTACT::HOMEPAGE')+' ('+getLang('CONTACT::BUSINESS')+')','%businessstreet%':getLang('CONTACT::STREET')+' ('+getLang('CONTACT::BUSINESS')+')','%businesscity%':getLang('CONTACT::CITY')+' ('+getLang('CONTACT::BUSINESS')+')','%businessstate%':getLang('CONTACT::STATE')+' ('+getLang('CONTACT::BUSINESS')+')','%businesszip%':getLang('CONTACT::ZIP')+' ('+getLang('CONTACT::BUSINESS')+')','%businesscountry%':getLang('CONTACT::COUNTRY')+' ('+getLang('CONTACT::BUSINESS')+')'});this.x_preview._onclick=function(e){storage.library('wm_tools');var aValues={};storeDataFromFormWithAccess(me.maintab.mail_settings.maintab.signature,aValues,{});if(!aValues.text.length)
gui._create('signature_preview','frm_signature_preview','','signature_preview','');else{var tools=new wm_tools();tools.signature_preview(aValues.text,[function(sData){if(Is.String(sData))
gui._create('signature_preview','frm_signature_preview','','signature_preview',sData);}]);}};this.text.vars._value('*');this.text.vars._onchange=function(){if(this._value()!='*')
this._parent.__exec('html.insert',[this._value(),true]);};var aSign=dataSet.get(me._storage,['SIGNATURE','ITEMS','0','VALUES','TEXT']);if(aSign){var aData={};if(aSign.ATTRIBUTES){aData.USERACCESS={'text':aSign.ATTRIBUTES.USERACCESS};aData.ACCESS={'text':aSign.ATTRIBUTES.ACCESS};aData.DOMAINADMINACCESS={'text':aSign.ATTRIBUTES.DOMAINADMINACCESS};}
aData.VALUES={'text':aSign.VALUE};loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}}};oTab.general._active(true);}
if(this.maintab.im_settings)
this.maintab.im_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(bFirstTime){if(oTab.general)
oTab.general._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('IM',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};if(oTab.chat)
oTab.chat._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('IM',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};oTab.general._active(true);}};if(this.maintab.teamchat_settings)
this.maintab.teamchat_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(bFirstTime){oTab.general._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('CHAT',me._storage,true);if(typeof aData==='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};oTab.digest._onactive=function(bFirstTime){if(bFirstTime){this.teamchat_notify._onchange=function(){var b=!this._value();this._parent.u_gw_teamchat_dailynotify&&this._parent.u_gw_teamchat_dailynotify._disabled(b);this._parent.u_gw_teamchat_pinnotify&&this._parent.u_gw_teamchat_pinnotify._disabled(b);this._parent.u_gw_teamchat_uploadnotify&&this._parent.u_gw_teamchat_uploadnotify._disabled(b);this._parent.u_gw_teamchat_mentionnotify&&this._parent.u_gw_teamchat_mentionnotify._disabled(b);};var aData=GWOthers.get('CHAT',me._storage,true)||{};var bData=GWOthers.get('GLOBAL_SETTINGS',me._storage,true)||{VALUES:{},ACCESS:{},USERACCESS:{},DOMAINADMINACCESS:{}};for(var i in bData.VALUES){aData.VALUES[i]=bData.VALUES[i];}
for(var i in bData.ACCESS){aData.ACCESS[i]=bData.ACCESS[i];}
for(var i in bData.USERACCESS){aData.USERACCESS[i]=bData.USERACCESS[i];}
for(var i in bData.DOMAINADMINACCESS){aData.DOMAINADMINACCESS[i]=bData.DOMAINADMINACCESS[i];}
if(typeof aData==='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);this.teamchat_notify._onchange();}};oTab.general._active(true);}};this.maintab.general_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.layout._active(false);return;}
oTab.layout._onactive=function(bFirstTime){if(bFirstTime){this.date_format._fill(CalendarFormatting.getFormats());var aLang=GWOthers.get('LANGUAGES',me._storage,true),aData={};for(var lang in aLang['VALUES'])
aData[lang]=aLang['VALUES'][lang];this.language._fill(aData);if(!aData[GWOthers.getItem('LAYOUT_SETTINGS','language')])
GWOthers.setItem('LAYOUT_SETTINGS','language',GWOthers.getDefaultValues('LAYOUT_SETTINGS').LANGUAGE);var aSkin=GWOthers.get('SKINS',me._storage,true);var aData={};for(var i in aSkin['VALUES'])
if(i!='value')
aData[i]=aSkin['VALUES'][i];this.skin._fill(aData);if(!aData[GWOthers.getItem('LAYOUT_SETTINGS','skin')])
GWOthers.setItem('LAYOUT_SETTINGS','skin',GWOthers.getDefaultValues('LAYOUT_SETTINGS').SKIN);var aData=GWOthers.get('LAYOUT_SETTINGS',me._storage,true);if(this.skin_style&&storage.aStorage.language.SKIN_STYLE){var tmp={},ls=storage.aStorage.language.SKIN_STYLE;for(var i in ls)
tmp[i.toLowerCase()]=[ls[i],i.toLowerCase()];this.skin_style._fill(tmp);if(aData&&aData.VALUES&&!tmp[aData.VALUES.skin_style]){aData.VALUES.skin_style='default';}}
if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};oTab.documents._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('DOCUMENTS',me._storage,true);this.autosave._onclick=function(){this._parent.autosave_minutes._disabled(this._checked());};this.disable_office._value(0);this.disable_office._onclick=function(){this._parent.office_app._disabled(!this._value());};this.office_app._fill({webdoc:getLang('OFFICELAUNCHER::WEBDOC'),webdoc_read:getLang('OFFICELAUNCHER::WEBDOC_READ'),suite:getLang('OFFICELAUNCHER::SUITE')});if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);this.autosave_minutes._disabled(!this.autosave._checked());this.office_app._disabled(this.disable_office._value());}};oTab.login._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('LAYOUT_SETTINGS',me._storage,true);this.x_login_logo._setFolder('logo'+(me._domain?'/'+me._domain:''));if(oTab.login.x_login_logo_set.domadmin)
oTab.login.x_login_logo_set.domadmin._value(aData.DOMAINADMINACCESS.login_logo=='view');var file=GWOthers.getItem('LAYOUT_SETTINGS','login_background_name',me._storage);var tmp={'0':getLang('SETTINGS::USE_UPLOADED'),'background--adrspach1.jpg':'Adrspach 1','background--adrspach2.jpg':'Adrspach 2','background--czech.jpg':'Czech','background--czech1.jpg':'Czech 1','background--czechcity.jpg':'Czech City','background--default.jpg':'Default','background--krivan.jpg':'Krivan','background--pleso.jpg':'Pleso','background--prague1.jpg':'Prague 1','background--prague2.jpg':'Prague 2','background--pragueboats.jpg':'Pragueboats','background--slovakia.jpg':'Slovakia','background--tatras.jpg':'Tatras','background--vine.jpg':'Vine'};this.x_login_background_name._fill(tmp);if(file&&!tmp[file])
file='0';this.x_login_background_name._value(file||'background--default.jpg');if(oTab.login.x_login_background_name_set.domadmin)
oTab.login.x_login_background_name_set.domadmin._value(aData.DOMAINADMINACCESS.login_background_name=='view');this.x_login_background._setFolder('background'+(me._domain?'/'+me._domain:''));this.x_login_background._onuploadend=function(aData){if(aData&&(aData=aData[aData.length-1])){this._parent.x_login_background_name._value('0');}};if(oTab.login.x_login_background_set.domadmin)
oTab.login.x_login_background_set.domadmin._value(aData.DOMAINADMINACCESS.login_background=='view');if(this.x_login_color){var tmp={'default':getLang('colors::blue'),'green-day':getLang('colors::green'),'code-orange':getLang('colors::orange'),'peaches':getLang('colors::peach'),'yellow-submarine':getLang('colors::yellow'),'deep-purple':getLang('colors::purple')};this.x_login_color._fill(tmp);}
this.x_login_color._value(aData.VALUES.login_color);if(oTab.login.x_login_color_set.domadmin)
oTab.login.x_login_color_set.domadmin._value(aData.DOMAINADMINACCESS.login_color=='view');this.x_facebook_link._value(aData.VALUES.facebook_link);if(oTab.login.x_facebook_link_set.domadmin)
oTab.login.x_facebook_link_set.domadmin._value(aData.DOMAINADMINACCESS.facebook_link=='view');this.x_twitter_link._value(aData.VALUES.twitter_link);if(oTab.login.x_twitter_link_set.domadmin)
oTab.login.x_twitter_link_set.domadmin._value(aData.DOMAINADMINACCESS.twitter_link=='view');this.x_linkedin_link._value(aData.VALUES.linkedin_link);if(oTab.login.x_linkedin_link_set.domadmin)
oTab.login.x_linkedin_link_set.domadmin._value(aData.DOMAINADMINACCESS.linkedin_link=='view');if(me._bDomainadmin){this.x_login_logo._disabled(aData.ACCESS.login_logo=='view');this.x_login_background._disabled(aData.ACCESS.login_background=='view');this.x_login_background_name._disabled(aData.ACCESS.login_background_name=='view');this.x_login_color._disabled(aData.ACCESS.login_color=='view');this.x_facebook_link._disabled(aData.ACCESS.facebook_link=='view');this.x_twitter_link._disabled(aData.ACCESS.twitter_link=='view');this.x_linkedin_link._disabled(aData.ACCESS.linkedin_link=='view');}
var aData=GWOthers.get('RESTRICTIONS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};if(oTab.homepage)
oTab.homepage._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('HOMEPAGE_SETTINGS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};if(oTab.reset)
oTab.reset._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('RESET_SETTINGS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};if(oTab.server)
oTab.server._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('GLOBAL_SETTINGS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}};if(oTab.restrictions)
oTab.restrictions._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('RESTRICTIONS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);if(aData.VALUES.disable_gw_types){if(aData.VALUES.disable_gw_types.indexOf('c')>-1)
oTab.restrictions.x_c._value(1);if(aData.VALUES.disable_gw_types.indexOf('e')>-1)
oTab.restrictions.x_e._value(1);if(aData.VALUES.disable_gw_types.indexOf('j')>-1)
oTab.restrictions.x_j._value(1);if(aData.VALUES.disable_gw_types.indexOf('n')>-1)
oTab.restrictions.x_n._value(1);if(aData.VALUES.disable_gw_types.indexOf('t')>-1)
oTab.restrictions.x_t._value(1);if(aData.VALUES.disable_gw_types.indexOf('f')>-1)
oTab.restrictions.x_f._value(1);if(aData.VALUES.disable_gw_types.indexOf('r')>-1)
oTab.restrictions.x_r._value(1);if(aData.VALUES.disable_gw_types.indexOf('q')>-1)
oTab.restrictions.x_q._value(1);}
if(oTab.restrictions.x_disable_gw_types_set.domadmin)
oTab.restrictions.x_disable_gw_types_set.domadmin._value(aData.DOMAINADMINACCESS.disable_gw_types=='view');if(oTab.restrictions.disable_login_help)
oTab.restrictions.disable_login_help._onchange=function(e){if(this._checked())
oTab.restrictions.disable_login_banners._checked(true);}}};if(oTab.dropbox)
oTab.dropbox._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('EXTERNAL_SETTINGS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}}
oTab.layout._active(true);};this.maintab.calendar_settings._onactive=function(bFirstTime){var oTab=this.maintab;if(!bFirstTime){oTab.main._active(false);return;}
oTab.main._onactive=function(bFirstTime){if(bFirstTime){this.week_begins._fillLang({'sunday':"DAYS::SUNDAY",'monday':"DAYS::MONDAY",'tuesday':"DAYS::TUESDAY",'wednesday':"DAYS::WEDNESDAY",'thursday':"DAYS::THURSDAY",'friday':"DAYS::FRIDAY",'saturday':"DAYS::SATURDAY"});this.week_begins._value('sunday');if(this.day_begins&&this.day_ends){var aHours={};for(var i=0;i<24;i++){aHours[i]=i.toString()+':00';aHours[i+.5]=i.toString()+':30';}
this.day_begins._fill(aHours);this.day_begins._setNatSort(true);this.day_ends._fill(aHours);this.day_ends._setNatSort(true);this.day_begins._onchange=function(){if(parseInt(this._value())>parseInt(this._parent.day_ends._value()))
this._parent.day_ends._value(this._value());}
this.day_ends._onchange=function(){if(parseInt(this._parent.day_begins._value())>parseInt(this._value()))
this._parent.day_begins._value(this._value());}}
this.workweek_begins._fillLang({'1':"DAYS::MONDAY",'2':"DAYS::TUESDAY",'3':"DAYS::WEDNESDAY",'4':"DAYS::THURSDAY",'5':"DAYS::FRIDAY",'6':"DAYS::SATURDAY",'7':"DAYS::SUNDAY"});this.workweek_begins._onchange=function(){var begin=parseInt(this._value());var end=oTab.main.workweek_ends;if(end._value()==undefined)
end._value((begin+=4)>7?begin-7:begin);else if(begin==end._value())
end._value(begin==7?1:begin+1);}
this.workweek_ends._fillLang({'1':"DAYS::MONDAY",'2':"DAYS::TUESDAY",'3':"DAYS::WEDNESDAY",'4':"DAYS::THURSDAY",'5':"DAYS::FRIDAY",'6':"DAYS::SATURDAY",'7':"DAYS::SUNDAY"});this.workweek_ends._onchange=function(){var begin=oTab.main.workweek_begins;var end=this._value();if(begin._value()==undefined)
begin._value('1');if(begin._value()==end)
begin._value(end==1?7:end-1);}
var aData=GWOthers.get('CALENDAR_SETTINGS',me._storage,true);if(aData)
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}}
oTab.default_settings._onactive=function(bFirstTime){if(bFirstTime){var aData=GWOthers.get('DEFAULT_CALENDAR_SETTINGS',me._storage,true);if(aData)
loadDataIntoFormOnAccess(this,aData,me._bDomainadmin);}}
if(oTab.reminder)
oTab.reminder._onactive=function(bFirstTime){if(bFirstTime){this.event&&(this.event._wasActivated=true);var aData=GWOthers.get('EVENT_SETTINGS',me._storage,true);if(typeof aData=='object')
loadDataIntoFormOnAccess(this.event,aData,me._bDomainadmin);}}
oTab.main._active(true);};if(this.maintab.domains_settings)
this.maintab.domains_settings._onactive=function(bFirstTime){if(!bFirstTime)
return;this.x_adddomain._onclick=function(){var sDomain=(this._parent.x_domain._value()||'').trim();if(sDomain!=''){var old=this._parent.domains._value();for(var i in old)
if(old[i].domain==sDomain)return;this._parent.domains._add([{'domain':sDomain}]);}};this.x_remove._onclick=function(){this._parent.domains._removeSelected();};this.domains._ondblclick=function(){var aDomain=this._getSelectedValue();if(aDomain&&aDomain.domain)
gui._create('settings','frm_settings_admin','','',true,aDomain.domain);};this.x_editdomain._onclick=function(){var aDomain=this._parent.domains._getSelectedValue();if(aDomain&&aDomain.domain)
gui._create('settings','frm_settings_admin','','',true,aDomain.domain);};var aDomains=me._domains.get(me._storage,true);if(aDomains)
this.domains._add(aDomains);var aDomains=me._domains.get(me._storage);if(aDomains){var arr=[],arr2={};for(var i in aDomains)
if(aDomains[i].domain)
arr.push(aDomains[i].domain.toString().trim());arr.sort();for(var i in arr)
arr2[arr[i]]=arr[i];this.x_domain._fill(arr2);}};this.maintab.mail_settings._active(true);};_me.__saveItems=function()
{if(!this.maintab){return;}
var me=this;var aValues={};function storeNonWellKnown(oForm,sResource){var aValues={},aAccess={};if(oForm&&oForm._wasActivated){storeDataFromFormWithAccess(oForm,aValues,aAccess);GWOthers.set(sResource,aValues,me._storage,aAccess);}};if(this.maintab.mail_settings&&this.maintab.mail_settings._wasActivated){var oTab=this.maintab.mail_settings.maintab;storeNonWellKnown(oTab.mail_default,'MAIL_SETTINGS_DEFAULT');if(oTab.general&&oTab.general._wasActivated){var aValues={},aAccess={};storeDataFromFormWithAccess(oTab.general,aValues,aAccess);if(aAccess.DOMAINADMINACCESS){aAccess.DOMAINADMINACCESS.autoupdate_minutes=aAccess.DOMAINADMINACCESS.autoupdate;aAccess.DOMAINADMINACCESS.autosave_minutes=aAccess.DOMAINADMINACCESS.autosave;aAccess.DOMAINADMINACCESS.autoclear_trash_days=aAccess.DOMAINADMINACCESS.autoclear_trash;}
if(aAccess.USERACCESS){aAccess.USERACCESS.autoupdate_minutes=aAccess.USERACCESS.autoupdate;aAccess.USERACCESS.autosave_minutes=aAccess.USERACCESS.autosave;aAccess.USERACCESS.autoclear_trash_days=aAccess.USERACCESS.autoclear_trash;}
GWOthers.set('MAIL_SETTINGS_GENERAL',aValues,this._storage,aAccess);}
if(oTab.groups&&oTab.groups._wasActivated){var out=[],v=oTab.groups.groups._aData;if(count(v)>0)
for(var i in v)
if(v[i].arg)
out.push({ATTRIBUTES:{ACCESS:'full',DONT_SEND:false},VALUES:{GROUP:{ATTRIBUTES:{USERACCESS:'view'},VALUE:v[i].arg.group},SENTFOLDER:{ATTRIBUTES:{USERACCESS:'view'},VALUE:Path.split(v[i].arg.folder)[1]||''}}});dataSet.add(me._storage,['GROUPS','ITEMS'],out,1);dataSet.add(me._storage,['GROUPS','ATTRIBUTES','DONT_SEND'],false,1);}
if(oTab.signature&&oTab.signature._wasActivated){var aValues={},aAccess={};storeDataFromFormWithAccess(oTab.signature,aValues,aAccess);var out=[{ATTRIBUTES:{DONT_SEND:false},VALUES:{TEXT:{ATTRIBUTES:{USERACCESS:aAccess.USERACCESS.text},VALUE:aValues.text}}}];if(aAccess.DOMAINADMINACCESS)
out[0].VALUES.TEXT.ATTRIBUTES.DOMAINADMINACCESS=aAccess.DOMAINADMINACCESS.text;dataSet.add(me._storage,['SIGNATURE','ITEMS'],out,1);dataSet.add(me._storage,['SIGNATURE','ATTRIBUTES','DONT_SEND'],false,1);}}
if(this.maintab.im_settings&&this.maintab.im_settings._wasActivated){var oTab=this.maintab.im_settings.maintab;storeNonWellKnown(oTab.general,'IM');storeNonWellKnown(oTab.chat,'IM');}
if(this.maintab.teamchat_settings&&this.maintab.teamchat_settings._wasActivated){var oTab=this.maintab.teamchat_settings.maintab;storeNonWellKnown(oTab.general,'CHAT');if(oTab.digest&&oTab.digest._wasActivated){var aValues={};var bValues={};var aAccess={};var bAccess={};storeDataFromFormWithAccess(oTab.digest,aValues,aAccess);for(var i in aValues){if(i==='teamchat_notify'){bValues[i]=aValues[i];delete(aValues[i]);}}
for(var i in aAccess.DOMAINADMINACCESS||{}){if(i==='teamchat_notify'){bAccess.DOMAINADMINACCESS=bAccess.DOMAINADMINACCESS||{};bAccess.DOMAINADMINACCESS[i]=aAccess.DOMAINADMINACCESS[i];delete(aAccess[i]);}}
for(var i in aAccess.USERACCESS||{}){if(i==='teamchat_notify'){bAccess.USERACCESS=bAccess.USERACCESS||{};bAccess.USERACCESS[i]=aAccess.USERACCESS[i];delete(aAccess[i]);}}
GWOthers.set('CHAT',aValues,me._storage,aAccess);GWOthers.set('GLOBAL_SETTINGS',bValues,me._storage,bAccess);}}
if(this.maintab.general_settings&&this.maintab.general_settings._wasActivated){var oTab=this.maintab.general_settings.maintab;if(oTab.layout&&oTab.layout._wasActivated){storeNonWellKnown(oTab.layout,'LAYOUT_SETTINGS');}
if(oTab.documents&&oTab.documents._wasActivated){storeNonWellKnown(oTab.documents,'DOCUMENTS');}
if(oTab.login&&oTab.login._wasActivated){var aValues={},aAccess={USERACCESS:{}};if(!this._bDomainadmin)
aAccess.DOMAINADMINACCESS={}
var file=oTab.login.x_login_logo._value();if(file.values&&file.values[0]&&file.values[0].name){aValues.login_logo='login_logo.'+Path.extension(file.values[0].name);aValues.logo_uploaded=Date.now();}
aAccess.USERACCESS.login_logo=oTab.login.x_login_logo_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.login_logo=oTab.login.x_login_logo_set.domadmin._value()?'view':'full';var upl=oTab.login.x_login_background._value();if(upl.values&&upl.values[0]&&upl.values[0].name){aValues.login_background='login_background.'+Path.extension(upl.values[0].name);aValues.background_uploaded=Date.now();}
aAccess.USERACCESS.login_background=oTab.login.x_login_background_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.login_background=oTab.login.x_login_background_set.domadmin._value()?'view':'full';var std=oTab.login.x_login_background_name._value();aValues.login_background_name=std=='0'?aValues.login_background:std;aAccess.USERACCESS.login_background_name=oTab.login.x_login_background_name_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.login_background_name=oTab.login.x_login_background_name_set.domadmin._value()?'view':'full';aValues.login_color=oTab.login.x_login_color._value();aAccess.USERACCESS.login_color=oTab.login.x_login_color_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.login_color=oTab.login.x_login_color_set.domadmin._value()?'view':'full';aValues.facebook_link=oTab.login.x_facebook_link._value();aAccess.USERACCESS.facebook_link=oTab.login.x_facebook_link_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.facebook_link=oTab.login.x_facebook_link_set.domadmin._value()?'view':'full';aValues.twitter_link=oTab.login.x_twitter_link._value();aAccess.USERACCESS.twitter_link=oTab.login.x_twitter_link_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.twitter_link=oTab.login.x_twitter_link_set.domadmin._value()?'view':'full';aValues.linkedin_link=oTab.login.x_linkedin_link._value();aAccess.USERACCESS.linkedin_link=oTab.login.x_linkedin_link_set.user._value()?'view':'full';if(!this._bDomainadmin)aAccess.DOMAINADMINACCESS.linkedin_link=oTab.login.x_linkedin_link_set.domadmin._value()?'view':'full';GWOthers.set('LAYOUT_SETTINGS',aValues,this._storage,aAccess);storeNonWellKnown(oTab.login,'RESTRICTIONS');}
if(oTab.reset&&oTab.reset._wasActivated)
storeNonWellKnown(oTab.reset,'RESET_SETTINGS');if(oTab.homepage&&oTab.homepage._wasActivated)
storeNonWellKnown(oTab.homepage,'HOMEPAGE_SETTINGS');if(oTab.server&&oTab.server._wasActivated)
storeNonWellKnown(oTab.server,'GLOBAL_SETTINGS');if(oTab.restrictions&&oTab.restrictions._wasActivated){var aValues={},aAccess={};storeDataFromFormWithAccess(oTab.restrictions,aValues,aAccess);if(aAccess.DOMAINADMINACCESS)
aAccess.DOMAINADMINACCESS.disable_gw_types=oTab.restrictions.x_disable_gw_types_set.domadmin._value()?'view':'full';aAccess.USERACCESS.disable_gw_types=oTab.restrictions.x_disable_gw_types_set.user._value()?'view':'full';aValues.disable_gw_types=(oTab.restrictions.x_c._value()?'c':'')+
(oTab.restrictions.x_e._value()?'e':'')+
(oTab.restrictions.x_j._value()?'j':'')+
(oTab.restrictions.x_n._value()?'n':'')+
(oTab.restrictions.x_t._value()?'t':'')+
(oTab.restrictions.x_r._value()?'r':'')+
(oTab.restrictions.x_f._value()?'f':'')+
(oTab.restrictions.x_q._value()?'q':'');GWOthers.set('RESTRICTIONS',aValues,this._storage,aAccess);}
if(oTab.dropbox&&oTab.dropbox._wasActivated)
storeNonWellKnown(oTab.dropbox,'EXTERNAL_SETTINGS');}
if(this.maintab.calendar_settings&&this.maintab.calendar_settings._wasActivated){var oTab=this.maintab.calendar_settings.maintab;var aValues={},aAccess={};storeDataFromFormWithAccess(oTab.main,aValues,aAccess);if(aAccess.DOMAINADMINACCESS){aAccess.DOMAINADMINACCESS.autoclear_trash_days=aAccess.DOMAINADMINACCESS.autoclear_trash;}
if(aAccess.USERACCESS){aAccess.USERACCESS.autoclear_trash_days=aAccess.USERACCESS.autoclear_trash;}
GWOthers.set('CALENDAR_SETTINGS',aValues,this._storage,aAccess);storeNonWellKnown(oTab.default_settings,'DEFAULT_CALENDAR_SETTINGS');if(oTab.reminder&&oTab.reminder._wasActivated)
storeNonWellKnown(oTab.reminder.event,'EVENT_SETTINGS');}
if(this.maintab.domains_settings&&this.maintab.domains_settings._wasActivated){var oTab=this.maintab.domains_settings;var aValues={};storeDataFromForm(oTab,aValues);me._domains.set(aValues.domains,this._storage);}
dataSet.add('tmp_storage','',dataSet.get(this._storage));if(this._bDomainadmin&&this._domain)
var nOK=WMStorage.set({'xmlns':this._xmlns,'domain':this._domain,'resources':dataSet.get(this._storage)},this._storage,'',[this,'__saveItemsHandler']);else
var nOK=WMStorage.set({'xmlns':this._xmlns,'resources':dataSet.get(this._storage)},this._storage,'',[this,'__saveItemsHandler']);if(nOK==2){dataSet.remove('tmp_storage');this._destruct();}
else
this._main.style.display="none";};_me.__saveItemsHandler=function(bOK)
{if(bOK){dataSet.remove('tmp_storage');this._destruct();}
else{dataSet.add(this._storage,'',dataSet.get('tmp_storage'));dataSet.remove('tmp_storage');this._main.style.display="block";}};

/* client/inc/frm_settings_helper.js */
function FrmSettingsHelper(bIsDomainForm,bIsAdminForm){this.__bIsDomainForm=bIsDomainForm;this.__bIsAdminForm=bIsAdminForm;}
FrmSettingsHelper.prototype.htmlMessageFormatChange=function(oForm,bDisable){var aFields=['font_family','text_direction','font_size'],i,sFieldName,oCheckboxes;for(i=0;i<aFields.length;i++){sFieldName=aFields[i];oCheckboxes=oForm['x_'+sFieldName+'_set'];oForm[sFieldName]._disabled(bDisable);if(this.__bIsAdminForm){oCheckboxes.user._disabled(bDisable);if(!this.__bIsDomainForm){oCheckboxes.domadmin._disabled(bDisable);}}}};

/* client/inc/frm_sharing.js */
_me=frm_sharing.prototype;function frm_sharing(){};frm_sharing.RIGHTS_GROUP={};frm_sharing.RIGHTS_GROUP.Y={FULL:'abcdeiklrtwx',WRITE:'beiklr',OWNER:'bcdeiklrx',ALL:'bcdeiklrtwx',READ:'lr',NONE:'-'};frm_sharing.RIGHTS_GROUP.I=frm_sharing.RIGHTS_GROUP.Y;frm_sharing.RIGHTS_GROUP.DEFAULT={FULL:'aiklrtwx',WRITE:'iklrw',AUTHOR:'ilr',OWNER:'iklrwx',ALL:'iklrtwx',READ:'lr',NONE:'-'};_me.__getRightsGroup=function(folder_info,group){return(frm_sharing.RIGHTS_GROUP[WMFolders.getType(folder_info)]||frm_sharing.RIGHTS_GROUP.DEFAULT)[group];};_me.__constructor=function(aHandler,aFolderInfo){this.__aFolderInfo=aFolderInfo;var me=this;this.__bFormEnabled=false;this.inp_add._disabled(!this.__bFormEnabled);if(aFolderInfo.fid){var folder=dataSet.get('folders',[aFolderInfo.aid,aFolderInfo.fid])||{};this._title(getLang('POPUP_FOLDERS::SHARING')+' ('+(folder.NAME||(folder.RELATIVE_PATH||aFolderInfo.fid).replace(/^\~/g,''))+')',true);}else{this._title(getLang('POPUP_FOLDERS::SHARING_ACCOUNT')+' - '+aFolderInfo.aid,true);}
if(aFolderInfo.fid){this._create('x_btn_inherit','obj_button','footer','noborder ok');this.x_btn_inherit._disabled(true);this.x_btn_inherit._value('FORM_BUTTONS::INHERIT');this.x_btn_inherit._onclick=function(){me.__aData={};me.x_btn_ok._onclick();};this.x_btn_inherit._main.parentNode.insertBefore(this.x_btn_inherit._main,this.x_btn_inherit._main.previousSibling);}
this.users._addColumns({user:{title:"SHARING::PEOPLE_YOU_INVITED",width:100,mode:'%',type:'static'},perm:{title:"SHARING::PERMISSIONS",width:140,css:'ico more',type:'static'},x:{width:30,mode:'px',css:'remove',type:'static'}});var bEnable=true;try{var tmp;if(this.__aFolderInfo.fid)
tmp=WMFolders.list(this.__aFolderInfo)[this.__aFolderInfo.aid][this.__aFolderInfo.fid];else
tmp=WMAccounts.list(this.__aFolderInfo)[this.__aFolderInfo.aid];if(tmp){if(tmp.INHERITED_ACL=='1')
this._title(getLang('POPUP_FOLDERS::SHARING')+' - '+(aFolderInfo.fid?aFolderInfo.fid.replace(/^\~/g,''):aFolderInfo.aid)+' ('+getLang('SHARING::INHERITED')+')',true);if(tmp.RIGHTS&&tmp.RIGHTS.indexOf('a')<0)
bEnable=false;tmp=tmp.ACL;}
for(var i in tmp)
this.__aData[i]=tmp[i];tmp=null;}
catch(r){bEnable=true;}
var bPublic=dataSet.get('folders',[aFolderInfo.aid,aFolderInfo.fid,'PUBLIC']);if(this.__aFolderInfo&&this.__aFolderInfo.fid&&(this.__aFolderInfo.fid.indexOf(sPrimaryAccountSPREFIX)===0||bPublic)){if(bPublic||this.__aFolderInfo.fid.indexOf('@')>0){var a=this.__aData[sPrimaryAccount]||this.__aData['['+aFolderInfo.fid+']']||this.__aData.anyone;if(Is.Array(a)&&inArray(a,'a')>-1){this.__bFormEnabled=true;this.x_btn_ok._disabled(false);this.inp_add._disabled(false);if(this.x_btn_inherit)
this.x_btn_inherit._disabled(false);}}}
else
if(bEnable){this.__bFormEnabled=true;this.x_btn_ok._disabled(false);this.inp_add._disabled(false);if(this.x_btn_inherit)
this.x_btn_inherit._disabled(false);}
this.__aData2=clone(this.__aData,true);this._fill();this.users._obeyEvent('onclick',[function(e,args){var elm=args.elm,arg=args.arg,cell=args.cell;if(me.__bFormEnabled&&arg&&arg.user&&Is.Array(me.__aData[arg.user])){switch(cell){case'perm':if(arg&&me.__aData[arg.user]){var r=me.__aData[arg.user].sort().join(''),pos=getSize(elm),custom=!~[me.__getRightsGroup(aFolderInfo,'READ'),me.__getRightsGroup(aFolderInfo,'AUTHOR'),me.__getRightsGroup(aFolderInfo,'WRITE'),me.__getRightsGroup(aFolderInfo,'OWNER'),me.__getRightsGroup(aFolderInfo,'ALL'),me.__getRightsGroup(aFolderInfo,'FULL'),'-'].indexOf(r);me.cmenu=gui._create('cmenu','obj_context');me.cmenu._fill([{title:'SETTINGS::READ',arg:me.__getRightsGroup(aFolderInfo,'READ').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'READ')?' check':'')},(WMFolders.getType(aFolderInfo)==='Y'||WMFolders.getType(aFolderInfo)==='I')?false:{title:'SETTINGS::AUTHOR',arg:me.__getRightsGroup(aFolderInfo,'AUTHOR').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'AUTHOR')?' check':'')},{title:'SETTINGS::WRITE',arg:me.__getRightsGroup(aFolderInfo,'WRITE').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'WRITE')?' check':'')},(WMFolders.getType(aFolderInfo)==='Y'||WMFolders.getType(aFolderInfo)==='I')?{title:'SETTINGS::OWNER',arg:me.__getRightsGroup(aFolderInfo,'OWNER').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'OWNER')?' check':'')}:false,{title:'SETTINGS::ALL',arg:me.__getRightsGroup(aFolderInfo,'ALL').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'ALL')?' check':'')},{title:'SETTINGS::FULL',arg:me.__getRightsGroup(aFolderInfo,'FULL').split(''),css:'ico2'+(r==me.__getRightsGroup(aFolderInfo,'FULL')?' check':'')},{title:'-'},{title:'SHARING::CUSTOM',arg:'custom',css:'ico2'+(custom?' check':'')},{title:'-'},{title:'SHARING::NONE',arg:[],css:'ico2'+(r=='-'?' check':'')}].filter(Boolean));me.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,null,1);me.cmenu._onclick=function(e,elm,id,arg2){if(arg&&arg.user){if(arg2==='custom'){gui._create('frm_permissions','frm_permissions','','',{permissions:me.__aData[arg.user],teamchat:~'IY'.indexOf(WMFolders.getType(aFolderInfo)),callback:function(perms){me.__aData[arg.user]=perms;me._fill();}});}else if(Is.Array(arg2)){me.__aData[arg.user]=arg2;me._fill();}}};e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}}}}]);};_me._fill=function(){var aData=[],arr={};arr[this.__getRightsGroup(this.__aFolderInfo,'FULL')]=getLang('SETTINGS::FULL');arr[this.__getRightsGroup(this.__aFolderInfo,'ALL')]=getLang('SETTINGS::ALL');arr[this.__getRightsGroup(this.__aFolderInfo,'READ')]=getLang('SETTINGS::READ');arr[this.__getRightsGroup(this.__aFolderInfo,'OWNER')]=getLang('SETTINGS::OWNER');arr[this.__getRightsGroup(this.__aFolderInfo,'WRITE')]=getLang('SETTINGS::WRITE');arr[this.__getRightsGroup(this.__aFolderInfo,'AUTHOR')]=getLang('SETTINGS::AUTHOR');arr[this.__getRightsGroup(this.__aFolderInfo,'NONE')]=getLang('SETTINGS::NONE');arr['*']=getLang('SETTINGS::CUSTOM');for(var i in this.__aData)
if(this.__aData[i][0]!='~'){var r=this.__aData[i].sort().join('')||'-';aData.push({data:{user:'<img class="avatar" src="'+getAvatarURL(i)+'" /> '+(i=='anyone'?getLang('SHARING::ANONYMOUS'):i.escapeHTML()),perm:'<span>'+(arr[r]||arr['*']).escapeHTML()+'</span>',x:''},arg:{user:i,rights:this.__aData[i]},css:Is.Array(this.__aData[i])?this.__aData[i].join(' '):''});}
this.users._fill(aData);};_me.__save=function(){this.x_btn_ok._disabled(true);if(this.x_btn_inherit)
this.x_btn_inherit._disabled(true);var d1=clone(this.__aData,true),d2=clone(this.__aData2,true);if(!Is.Empty(this.__aData)){for(var i in d2)
if(d1[i]&&arrayCompare(d2[i],d1[i]))
delete d1[i];if(Is.Empty(d1)){this.__success_handler();return;}}
this.__aFolderInfo.acl=d1;if(this.__aFolderInfo.fid)
WMFolders.add(this.__aFolderInfo,'null','',[this,'__success_handler'],[this,'__error_handler']);else
WMAccounts.add(this.__aFolderInfo,'null','',[function(id,str){if(id)
this.__error_handler(null,id,str);else
this.__success_handler();}.bind(this)]);};

/* client/inc/frm_signature_preview.js */
_me=frm_signature_preview.prototype;function frm_signature_preview(){};_me.__constructor=function(sSignature){var signatureContainer,me=this;this._size(450,300,true);this._modal(true);this._dockable(false);this._resizable(true);this._title('SIGNATURE::PREVIEW');signatureContainer=mkElement('div',{className:'signature_container'});signatureContainer.innerHTML=sSignature;this.__eMain.appendChild(signatureContainer);this._create('x_btn_ok','obj_button','footer','noborder ok');this.x_btn_ok._value('FORM_BUTTONS::CLOSE');this.x_btn_ok._onclick=function(){me._destruct();};this.x_btn_ok._focus();};

/* client/inc/frm_smilebox.js */
_me=frm_smilebox.prototype;function frm_smilebox(){}
_me.__constructor=function(aResponse,x,y){if(Is.Defined(x)&&Is.Defined(y)){x=gui._rtl?x-34:x-406;if(y>255){y-=255;}else{y+=40;this._main.classList.add('arrow_top');}
this._place(x,y,410,252);}
this._create('emoji','obj_smilebox','main','',aResponse);};

/* client/inc/frm_storage.js */
_me=frm_storage.prototype;function frm_storage(){}
_me.__constructor=function(id,quota,usage){var me=this;this._dataSet='tmp_'+this._name;this._size(600,400,true);this._resizable(false);this._title(id.fid+(usage?' - '+(quota?getLang('USAGE::LABEL',[this._format(usage),this._format(quota)]):getLang('USAGE::LABEL2',[this._format(usage)])):''),true);this._draw('frm_storage','main',null,true);this.x_btn_ok._value('FORM_BUTTONS::CLOSE');this.x_btn_ok._main.classList.remove('ico');this.x_btn_cancel._destruct();this.datagrid._row_height=40;this.datagrid._default_columns=function(sFolType){return{DISPLAY:{title:'FORM_FOLDERS::NAME',width:450,type:'static',encode:true},SIZE:{title:'DATAGRID_ITEMS_VIEW::SIZE',width:60,type:'static',encode:true},OPTIONS:{title:'COMPOSE::OPTIONS',width:80,type:'static'}};};this.datagrid._prepareBody=function(aItems){var aResult={};for(var sItId in aItems){var aRow={};var data=aItems[sItId];for(var sTitle in this._aCols){switch(sTitle){case'DISPLAY':aRow[sTitle]=data.DISPLAY||data.FOLDER.split('\\').pop();break;case'SIZE':aRow[sTitle]=parseFileSize(data.SIZE*1024);break;case'OPTIONS':aRow[sTitle]='<span class="menu" data-id="'+sItId+'"></span>';break;}}
aResult[sItId]={id:sItId,css:'',data:aRow,arg:{aid:id.aid,fid:id.fid,iid:sItId}};}
return aResult;};this.datagrid._default_values=function(){return[];};this.datagrid._select_single=true;this.datagrid._listen_data(this._dataSet,'',true);this.datagrid._serverSort({aid:id.aid,fid:'__@@SIZE@@__/'+id.owner_id},'','',[function(){[].forEach.call(me.datagrid._main.querySelectorAll('.menu'),function(menu){menu.addEventListener('click',function(e){e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();me.cmenu=gui._create("cmenu","obj_context",'','storageMenu',me);gui.cmenu._fill([{title:'POPUP_ITEMS::CONTACT_ADMIN',arg:{method:'contact'},css:'ico icocontact'},{title:'-'},{html:getLang('USAGE::CONTACT_ADMIN_HELPER'),css:'helper'}]);gui.cmenu._place(e.clientX,e.clientY);gui.cmenu._onclick=function(ev,elm,id,arg){switch(arg.method){case'contact':var popup=gui._create('contact_admin_quota','obj_popup');popup._title('POPUP_ITEMS::CONTACT_ADMIN');popup._modal(true);popup._size(350,200,true);var text=popup._create('text','obj_text','','obj_text100 noborder');text._placeholder(getLang('USAGE::CONTACT_ADMIN_PLACEHOLDER'));var ok=popup._create('x_btn_ok','obj_button','footer','color1');ok._value('COMPOSE::SEND');ok._onclick=function(){WMFolders.action({aid:sPrimaryAccount,fid:e.target.getAttribute('data-id').replace('*','').replace(/\\/g,'/'),xmlarray:{comment:[{VALUE:text._value()}]}},'','','notify_limit','',[function(){if(popup&&!popup.__destructed){popup._destruct();}}]);};var cancel=popup._create('x_btn_cancel','obj_button','footer');cancel._value('FORM_BUTTONS::CLOSE');cancel._onclick=function(){if(popup&&!popup.__destructed){popup._destruct();}};break;}};});});}]);this._onclose=function(){dataSet.remove(me._dataSet);return true;};};_me._onmove=function(){if(this.cmenu&&!this.cmenu._destructed){this.cmenu._destruct();}};_me._format=function(bytes,decimals){if(!bytes){return'0 B';}
var i=Math.floor(Math.log(bytes)/Math.log(1024));return parseFloat((bytes/Math.pow(1024,i)).toFixed(decimals||1))+' '+['B','KB','MB','GB','TB','PB','EB','ZB','YB'][i];};

/* client/inc/frm_suppress_check.js */
function frm_suppress_check(sLabel2){};frm_suppress_check.prototype.__constructor=function(aResponse,sLabel1,sLabel2,aSubstitution){return false;if(typeof sLabel2=="string"&&sLabel2.indexOf('::')){var aPath=sLabel2.toLowerCase().split('::');if(Cookie.get(['suppressed',aPath[0],aPath[1]])){executeCallbackFunction(aResponse);return false;}}};

/* client/inc/frm_task.js */
_me=frm_task.prototype;function frm_task(){};_me.__constructor=function(){var me=this;this._defaultSize(-1,-1,800,640);storage.library('purify.wrapper','purify');var aData={disable_html:!GWOthers.getItemAccess('MAIL_SETTINGS_DEFAULT','html_message')&&'0'===GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')};var tmpf=Path.split(this._sFolderID)[0];if(dataSet.get('folders',[this._sAccountID,tmpf,'TYPE'])=='A')
aData.owner=tmpf;else
aData.owner=this._sAccountID;if(this._aValues.EVNFLAGS&&this._aValues.EVNFLAGS&2)
aData.attendees=true;this._draw('frm_task','main',aData);var tab1=this.maintab.tab1;msiebox(tab1._getAnchor('msiebox'));tab1.EVNNOTE.select._fillLang({'enabled':"COMPOSE::HTML",'disabled':"COMPOSE::TEXT",'code':'RICH::CODE'});tab1.EVNNOTE._onesc=function(){me._close(true);};tab1.EVNSTATUS._fillLang({'B':["TASK::NOT_STARTED",'','ico not_started'],'I':["TASK::IN_PROGRESS",'','ico in_progress'],'M':["TASK::COMPLETED",'','ico completed'],'Q':["TASK::DEFERRED",'','ico deferred'],'N':["TASK::WAITING",'','ico waiting']});setTimeout(function(){this.__initForm('TASK::TASK');}.bind(this),5);tab1.EVNSTARTDATE._ondateselect=function(){var tmp0=this._getObjectDate(),tmp1=this._parent.EVNENDDATE._getObjectDate();if(tmp0){if(tmp1&&tmp0<tmp1)
this._parent.EVNENDDATE._value(this._value(),true);}
else
this._parent.EVNENDDATE._value('empty',true);me._aValues['EVNSTARTDATE']=this._value();};tab1.EVNENDDATE._ondateselect=function(){var tmp0=this._getObjectDate(),tmp1=this._parent.EVNSTARTDATE._getObjectDate();if(tmp0&&(!tmp1||tmp0>tmp1))
this._parent.EVNSTARTDATE._value(this._value(),true);me._aValues['EVNENDDATE']=this._value();};tab1.EVNSTATUS._onchange=function(){me.__setEvncomplete();}
tab1.X_EVNCOMPLETE._onchange=function(){me.__setEvnstatus();}
this.maintab.tab4.X_ATTACHMENTS.file._dropzone(this.__eContainer);this.maintab.tab4.X_ATTACHMENTS._onuploadstart=function(){me.x_btn_ok._disabled(true);this._parent._active();};this.maintab.tab4.X_ATTACHMENTS._onuploadend=function(){me.x_btn_ok._disabled(false);};tab1.EVNTYPE.input._onChange=function(){this.__refreshView=true;}.bind(this);};_me.__print=function(aValues){aValues=aValues.values;aValues.COUNT_DATE='';if('text/html'===aValues.EVNDESCFORMAT){aValues.EVNNOTE=DOMPurify.sanitize(aValues.EVNNOTE);}
if(aValues.EVNENDDATE>0){aValues.COUNT_DATE=IcewarpDate.julian(aValues.EVNENDDATE).format('L');}
if(aValues.EVNSTARTDATE>0){aValues.COUNT_DATE+=' - '+IcewarpDate.julian(aValues.EVNSTARTDATE).format('L');}
if(!gui.print)
gui._create('print','frm_print');gui.print._add('T',aValues);};_me.__setEvncomplete=function(sValue){var tab1=this.maintab.tab1;switch(tab1.EVNSTATUS._value()[0]){case'B':tab1.X_EVNCOMPLETE._value(0);tab1.X_EVNCOMPLETE._disabled(true);break;case'M':tab1.X_EVNCOMPLETE._value(100);tab1.X_EVNCOMPLETE._disabled(true);break;default:if(Is.Defined(sValue))tab1.X_EVNCOMPLETE._value(sValue);tab1.X_EVNCOMPLETE._disabled(false);break;}};_me.__setEvnstatus=function(){var tab1=this.maintab.tab1,curval=parseInt(tab1.X_EVNCOMPLETE._value());if(curval>=100)
tab1.EVNSTATUS._value('M');};_me.__loadItems=function(){var me=this,tab1=this.maintab.tab1;if(gui._rtl||!this._aValues||!this._aValues.EVNDESCFORMAT||this._aValues.EVNDESCFORMAT.toLowerCase()!='text/plain')
tab1.EVNNOTE.select._value('enabled');else
tab1.EVNNOTE.select._value('enabled');loadDataIntoForm(tab1,this._aValues);tab1.EVNTITLE._onkeyup=function(){var sTitle=this._value();if(sTitle){if(sTitle.length>32)
sTitle=sTitle.substr(0,32)+'...';me._title(sTitle+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);}
else
me._title(getLang('TASK::TASK')+(me._aValues.EVNFOLDER?' - '+me._aValues.EVNFOLDER:''),true);};tab1.EVNTITLE._onkeyup();if(!this._aValues['EVNSTARTDATE']||this._aValues['EVNSTARTDATE']=='undefined')
tab1.EVNSTARTDATE._value('empty');if(!this._aValues['EVNENDDATE']||this._aValues['EVNENDDATE']=='undefined')
tab1.EVNENDDATE._value('empty');if(inArray(['B','I','M','Q','N'],this._aValues['EVNSTATUS'])==-1)
tab1.EVNSTATUS._value('B');this.__setEvncomplete(this._aValues['EVNCOMPLETE']);if(typeof this._aValues['EVNPRIORITY']=='undefined')tab1.EVNPRIORITY._value('0');if(Is.Defined(this._aValues['REMINDERS']))
tab1.X_REMINDERS._value(this._aValues['REMINDERS']);this.maintab.tab2._onactive=function(bFirstTime){if(bFirstTime){this.X_REPEATING._onerror=function(has_error){me.x_btn_ok._disabled(has_error);};var recurrence=shiftObject(me._aValues['RECURRENCES']);if(recurrence!=null)
this.X_REPEATING._value(recurrence);}
if(Is.Defined(me._aValues['EVNENDDATE']||me._aValues['EVNSTARTDATE'])){this.X_REPEATING._setDate(IcewarpDate.julian(me._aValues['EVNENDDATE']||me._aValues['EVNSTARTDATE']));}};if(this.maintab.tab5)
this.maintab.tab5._onactive=function(bFirstTime){if(bFirstTime)
if(Is.Defined(me._aValues['CONTACTS']))
this.X_ATTENDEES._value(me._aValues['CONTACTS']);};if(this.maintab.tab4)
this.maintab.tab4._onactive=function(bFirstTime){if(bFirstTime){if(me._aValues['ATTACHMENTS']){var out=[];for(var i in me._aValues['ATTACHMENTS'])
out.push({'name':me._aValues['ATTACHMENTS'][i]['values']['ATTDESC'],'class':me._aValues['ATTACHMENTS'][i]['values']['ATTTYPE'],'id':i,'ticket':me._aValues['ATTACHMENTS'][i]['values']['TICKET'],'fullpath':me._aValues.fullpath,'size':me._aValues['ATTACHMENTS'][i]['values']['ATTSIZE']});if(me._aValues.fullpath)
this.X_ATTACHMENTS._value({'values':out});else
this.X_ATTACHMENTS._value({'path':me._sAccountID+'/'+me._sFolderID+'/'+WMItems.__serverID(me._sItemID),'values':out});}
else
if(me._aValues['PUSH_ATTACHMENTS']){var out=[];for(var i in me._aValues['PUSH_ATTACHMENTS'])
out.push({'name':me._aValues['PUSH_ATTACHMENTS'][i]['title'],'id':me._aValues['PUSH_ATTACHMENTS'][i]['id'],'size':me._aValues['PUSH_ATTACHMENTS'][i]['size'],'class':me._aValues['PUSH_ATTACHMENTS'][i]['embedded']?'item':'itemlink','fullpath':me._aValues['PUSH_ATTACHMENTS'][i]['fullpath']});this.X_ATTACHMENTS._value({path:me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].substr(0,me._aValues['PUSH_ATTACHMENTS'][0]['fullpath'].lastIndexOf('/')),values:out});}}}
if(me._aValues['PUSH_ATTACHMENTS']&&this.maintab.tab4)
this.maintab.tab4._active();};_me.__onBeforeSave=function(){!this.maintab.tab1.EVNTITLE._value()&&this.maintab.tab1.EVNTITLE._value(getLang('TASK::NEW'));};_me.__saveItems=function(aValues){var tab1=this.maintab.tab1;aValues['values']['EVNDESCFORMAT']=tab1.EVNNOTE.select._value()=='disabled'?'text/plain':'text/html';tab1.EVNNOTE.__output_format=aValues.values.EVNDESCFORMAT!=='text/plain';aValues.values.EVNNOTE=tab1.EVNNOTE._value();aValues['values']['EVNSTARTDATE']=aValues['values']['EVNSTARTDATE']||0;aValues['values']['EVNENDDATE']=aValues['values']['EVNENDDATE']||0;aValues['values']['EVNSTARTTIME']=-1;aValues['values']['EVNENDTIME']=-1;aValues['values']['EVNCOMPLETE']=tab1.X_EVNCOMPLETE._value();var addon;if(!Is.Empty(addon=tab1.X_REMINDERS._value()))
aValues['REMINDERS']=addon;if(this.maintab.tab2.X_REPEATING&&!Is.Empty(addon=this.maintab.tab2.X_REPEATING._value())){if(!aValues.values.EVNSTARTDATE){aValues.values.EVNSTARTDATE=(new IcewarpDate()).format(IcewarpDate.JULIAN);}
aValues['RECURRENCES']=[addon];}
else
if(!aValues.values.EVNSTARTDATE&&this._aValues&&this._aValues.EVNRCR_ID)
aValues['RECURRENCES']=[{uid:this._aValues.EVNRCR_ID}];if(this.maintab.tab4&&this.maintab.tab4.X_ATTACHMENTS&&!Is.Empty(addon=this.maintab.tab4.X_ATTACHMENTS._value()))
aValues['ATTACHMENTS']=addon;if(this.maintab.tab5&&this.maintab.tab5.X_ATTENDEES){if(!Is.Empty(addon=this.maintab.tab5.X_ATTENDEES._value())){aValues['CONTACTS']=[];addon.forEach(function(item){if(!item.values){return aValues['CONTACTS'].push(item);}
item.values.CNTROLE=item.values.CNTROLE||'Q';item.values.CNTSTATUS=item.values.CNTSTATUS||'B';aValues['CONTACTS'].push(item);});}
aValues['values'].EVNFLAGS=this._aValues.EVNFLAGS||0;if(aValues['values'].EVNFLAGS&2)
aValues['values'].EVNFLAGS=aValues['values'].EVNFLAGS&~1;else
aValues['values'].EVNFLAGS=aValues['values'].EVNFLAGS|1;}};

/* client/inc/frm_telemetry.js */
_me=frm_telemetry.prototype;function frm_telemetry(){};_me.__constructor=function(aResponse,sLabel1,sLabel2){var me=this;this._size(400,400,true);this._closable(false);this._title('Telemetry',true);this.__idTable={};this._create('text','obj_text','main','obj_text100 noborder');this.text._onsubmit=function(){if(this._value())
me.x_btn_show._onclick();else
me._hide();};this.text._placeholder('Paste Telemetry XML here...');this._create('x_btn_show','obj_button','footer','noborder simple ok');this.x_btn_show._value('COMMON::SHOW');this.x_btn_show._title('Ctrl+Z');this.x_btn_show._onclick=function(){if(me._prepare()){me._show_all();me._start_observer();this._disabled(true);me.x_btn_hide._disabled(false);}};this._create('x_btn_hide','obj_button','footer','noborder simple cancel');this.x_btn_hide._value('COMMON::HIDE');this.x_btn_hide._disabled(true);this.x_btn_hide._onclick=function(){me._hide();};gui._obeyEvent('keydown',[function(e){if(e.keyCode==90&&e.ctrlKey)
me.x_btn_show._onclick();}]);};_me._start_observer=function(){this._stop_observer();var me=this;this.__DOM=function(e){if(e.target&&e.target.nodeType==1){if(e.target.id)
me._show(e.target.id);var elms=e.target.querySelectorAll('*[id]');for(var j=elms.length-1;j>=0;j--)
me._show(elms[j].id);}};document.addEventListener("DOMNodeInserted",this.__DOM,false);};_me._stop_observer=function(){if(this.__DOM)
document.removeEventListener("DOMNodeInserted",this.__DOM);};_me._prepare=function(){this._hide();this.__idTable={};try{aData=XMLTools.Str2Arr(this.text._value());}
catch(r){alert('Invalid XML');return;}
if(!aData||!aData.TELEMETRY){alert('No telemetry data');return;}
if((aData=aData.TELEMETRY[0].CLICK))
for(var id,a,tag,i=aData.length-1;i>=0;i--)
if(aData[i].ELEMENT&&aData[i].COUNT&&(id=aData[i].ELEMENT[0].VALUE)){if(!this.__idTable[id])
this.__idTable[id]=[];a={};for(tag in aData[i])
if(tag!='ELEMENT')
a[tag]=aData[i][tag][0].VALUE;this.__idTable[id].push(a);}
return true;};_me._show_all=function(){var id;for(id in this.__idTable)
this._show(id);};_me._show=function(id){var data=clone(this.__idTable[id]);if(data&&(elm=document.getElementById(id))){var obj=this.__getObj(id),click=0,aDetail=[];for(i in data){if(data[i]['TYPE']&&(!obj||obj._type!=data[i]['TYPE'])){continue;}
else
if(obj&&obj.__telemetry&&obj.__telemetry(id,elm,data[i])===false){continue;}
click+=parseInt(data[i].COUNT,10);aDetail.push('<td class="space" colspan="2"></td>');for(var j in data[i])
if(j!='TYPE')
aDetail.push('<tr><th>'+j+'</th><td>'+data[i][j]+'</td></tr>');}
if(!aDetail.length)
return;aDetail.unshift('<table>','<tr><th colspan="2">'+data[0]['TYPE']+'</th></tr>');aDetail.push('</table>');elm.setAttribute('telemetry',click);var eInfo;if(elm.firstChild&&hascss(elm.firstChild,'telemetry_info')){eInfo=elm.firstChild;}
else{eInfo=mkElement('aside',{className:'telemetry_info',rel:id});try{if(elm.firstChild)
elm.insertBefore(eInfo,elm.firstChild);else
elm.appendChild(eInfo);}
catch(r){return;}}
eInfo.innerHTML=click;if(aDetail.length){eInfo.onmousemove=function(e){var e=e||window.event;e.cancelBubble=true;e.stopPropagation(true);return false;};gui.tooltip._add(eInfo,aDetail.join("\n"),{hide:false,html:true,x:"+30",css:'telemetry'});}}};_me._hide=function(){this._stop_observer();var elms=gui._main.querySelectorAll('aside.telemetry_info');for(var i=elms.length-1;i>=0;i--)
elms[i].parentNode.removeChild(elms[i]);elms=gui._main.querySelectorAll('[telemetry]');for(var i=elms.length-1;i>=0;i--)
elms[i].removeAttribute('telemetry');this.x_btn_show._disabled(false);this.x_btn_hide._disabled(true);};_me.__getObj=function(id){var obj=window,objid=id.split('#').shift().split('/').shift();try{objid.split('.').forEach(function(part){obj=obj[part];});return obj;}
catch(r){return false;}};

/* client/inc/frm_text.js */
_me=frm_text.prototype;function frm_text(){};_me.__constructor=function(aResponse,sLabel1,sLabel2){var me=this;this._size(400,300,true);this._resizable(false);this._dockable(false);this._modal(true);this._draw('frm_input','main');this._create('obj_input','obj_text','input','obj_text100');this.obj_input._onsubmit=function(){me.x_btn_ok._onclick();};this.obj_input._onclose=function(){me.x_btn_cancel._onclick();};if(sLabel1)this._title(sLabel1);if(sLabel2)this.obj_input._value(sLabel2);this.x_btn_ok._onclick=function(){if(aResponse)
executeCallbackFunction(aResponse,me.obj_input._value());me._destruct();};this.obj_input._focus();};

/* client/inc/frm_time_criteria.js */
_me=frm_time_criteria.prototype;function frm_time_criteria(){}
_me.__constructor=function(aValue,aResponse){var me=this;this._size(450,300,true);this._modal(true);this._dockable(false);this._resizable(false);this._draw('frm_time_criteria','main');var days=['su','mo','tu','we','th','fr','sa'];this.weekdays_enabled._onchange=function(){days.forEach(function(day){me['weekdays_'+day]._disabled(!this._checked());},this);};this.weekdays_enabled._checked(aValue?aValue.WEEKDAYS[0].ENABLED[0].VALUE:false);this.weekdays_enabled._onchange.call(this.weekdays_enabled);days.forEach(function(day){this['weekdays_'+day]._checked(aValue?aValue.WEEKDAYS[0][day.toUpperCase()][0].VALUE:false);},this);this.times_from._value(aValue?aValue.TIMES[0].FROM[0].VALUE:'00:00');this.times_to._value(aValue?aValue.TIMES[0].TO[0].VALUE:'00:00');this.times_from._restrict([this,'_timecheck']);this.times_to._restrict([this,'_timecheck']);this.times_enabled._onchange=function(){me.times_from._disabled(!this._checked());me.times_to._disabled(!this._checked());};this.times_enabled._checked(aValue?aValue.TIMES[0].ENABLED[0].VALUE:false);this.times_enabled._onchange.call(this.times_enabled);this.dates_enabled._onchange=function(){me.dates_from._disabled(!this._checked());me.dates_to._disabled(!this._checked());};this.dates_enabled._checked(aValue?aValue.DATES[0].ENABLED[0].VALUE:false);this.dates_enabled._onchange.call(this.dates_enabled);if(aValue){this.dates_from._value(new IcewarpDate(aValue.DATES[0].FROM[0].VALUE,{format:'YYYY/MM/DD'}));this.dates_to._value(new IcewarpDate(aValue.DATES[0].TO[0].VALUE,{format:'YYYY/MM/DD'}));}
this._title('FILTERS::TIME_CRITERIA');this._create('x_btn_ok','obj_button','footer','noborder ok color1');this.x_btn_ok._value('FORM_BUTTONS::OK');this.x_btn_ok._onclick=function(){executeCallbackFunction(aResponse,[{WEEKDAYS:[{ENABLED:[{VALUE:+me.weekdays_enabled._checked()}],SU:[{VALUE:+me.weekdays_su._checked()}],MO:[{VALUE:+me.weekdays_mo._checked()}],TU:[{VALUE:+me.weekdays_tu._checked()}],WE:[{VALUE:+me.weekdays_we._checked()}],TH:[{VALUE:+me.weekdays_th._checked()}],FR:[{VALUE:+me.weekdays_fr._checked()}],SA:[{VALUE:+me.weekdays_sa._checked()}]}],TIMES:[{ENABLED:[{VALUE:+me.times_enabled._checked()}],FROM:[{VALUE:me.times_from._value()}],TO:[{VALUE:me.times_to._value()}]}],DATES:[{ENABLED:[{VALUE:+me.dates_enabled._checked()}],FROM:[{VALUE:me.dates_from.__value.format('YYYY/MM/DD')}],TO:[{VALUE:me.dates_to.__value.format('YYYY/MM/DD')}]}]}]);me._destruct();};this._create('x_btn_cancel','obj_button','footer','cancel noborder');this.x_btn_cancel._tabIndex();this.x_btn_cancel._value('FORM_BUTTONS::CANCEL');this.x_btn_cancel._onclick=function(){me._destruct();};this.x_btn_ok._focus();};_me._timecheck=function(value){var match=!!value.match(/^[012]?\d:\d{2}$/);this.x_btn_ok&&this.x_btn_ok._disabled(!match);return match;};

/* client/inc/frm_timezone.js */
_me=frm_timezone.prototype;function frm_timezone(){};_me.__constructor=function(aHandler){var me=this;this._dockable(false);this._resizable(false);this._closable(false);this._size(430,290,true);this._title('SETTINGS::TIMEZONE');this._draw('frm_timezone','main');this.tz._value(GWOthers.getItem('CALENDAR_SETTINGS','timezone'));this.x_btn_ok._onclick=function(){Cookie.set(['tzoffset'],(new IcewarpDate()).utcOffset()-(60*new IcewarpDate().getMoment().isDST()));dataSet.add('tmp_storage','',dataSet.get('storage','',true));GWOthers.set('CALENDAR_SETTINGS',{timezone:me.tz._value()},'storage');if(WMStorage.set({'resources':dataSet.get('storage')},'storage','',[me,'__saveItemsHandler'])==2){dataSet.remove('tmp_storage');me.x_btn_cancel._onclick();}};this.x_btn_cancel._onclick=function(){me._destruct();executeCallbackFunction(aHandler);};};_me.__saveItemsHandler=function(bOK)
{if(!bOK)
dataSet.add('storage','',dataSet.get('tmp_storage'));dataSet.remove('tmp_storage');this.x_btn_cancel._onclick();};

/* client/inc/frm_verify.js */
function frm_verify(){};frm_verify.__app_links={ios:'https://itunes.apple.com/app/icewarp-authenticator/id1335635061',android:'https://play.google.com/store/apps/details?id=com.icewarp.authenticator'};frm_verify.prototype={__constructor:function(){this._title('VERIFICATION::TWOSTEP');this.__2FE=sPrimaryAccount2FE;this.__views={'main':'frm_verify_main','app':'frm_verify_app','auth':'frm_verify_app_auth','manual':'frm_verify_app_manual','auth_inp':'frm_verify_app_auth_inp','success':'frm_verify_success','sms':'frm_verify_sms','sms_code':'frm_verify_sms_code','code':'frm_verify_code'};if(sPrimaryAccount2FE)
this._view('code');else
this._view('main');},_rsa:function(pass){var tmp=auth.hashid({"username":dataSet.get('accounts',[sPrimaryAccount,'USERNAME'])}),rsa=new RSAKey();rsa.setPublic(tmp.hash,'10001');return rsa.encrypt(buildURL({p:pass,t:tmp.time}));},_code:function(aHandler){mkElement('img',{src:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'two_factor_qr','fullpath':'','rand':unique_id()})});var frm=gui._create('code','frm_input','','frm_verify_code',[function(code){if(executeCallbackFunction(aHandler,code)!==false)
frm._destruct();}],'VERIFICATION::CODE','',getLang('VERIFICATION::APP_AUTH_CODE_PH'));frm.x_btn_ok._value('VERIFICATION::VERIFY');},_enable2FE:function(b){window.sPrimaryAccount2FE=b?1:0;},_onclose:function(){if(this.__2FE!=sPrimaryAccount2FE){WMAccounts.refresh({aid:sPrimaryAccount},'','',[function(){if(gui.settings)
gui._create('settings','frm_settings','','','account_settings','primary');}]);}
return true;}};

/* client/inc/frm_verify_app.js */
function frm_verify_app(){};frm_verify_app.prototype={__constructor:function(view){var next='ios',me=this;view.title('VERIFICATION::APP');view.buttons({'btn_next':{value:'COMMON::NEXT',css:'color1',onclick:function(){view.view('auth',next);}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});function toggle(e){next=this.getAttribute('rel');[].forEach.call(me._main.querySelectorAll('.radio'),function(elm){if(elm.getAttribute('rel')==next)
addcss(elm,'active');else
removecss(elm,'active');});}
[].forEach.call(this._main.querySelectorAll('.radio'),function(elm){elm.onclick=toggle;});}};

/* client/inc/frm_verify_app_auth.js */
function frm_verify_app_auth(){};frm_verify_app_auth.prototype={__constructor:function(view,arg){this.__view=view;view.buttons({'btn_next':{value:'COMMON::NEXT',css:'color1',onclick:function(){view.view('auth_inp',arg);}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});var aData={h:getLang(arg=='ios'?'VERIFICATION::APP_AUTH_HIOS':'VERIFICATION::APP_AUTH_HANDROID'),l1:getLang('VERIFICATION::APP_AUTH_1',['<span class="link">'+getLang(arg=='ios'?'VERIFICATION::APP_AUTH_1IOS':'VERIFICATION::APP_AUTH_1ANDROID')+'</span>']),l2:getLang('VERIFICATION::APP_AUTH_2',['<b>&quot;'+getLang('VERIFICATION::APP_AUTH_2ext')+'&quot;</b>']),l3:getLang('VERIFICATION::APP_AUTH_3',['<b>&quot;'+getLang('VERIFICATION::APP_AUTH_3ext')+'&quot;</b>']),reset:!!view.data.code};this._draw('frm_verify_app_auth','main',aData);this._main.querySelector('span.link').onclick=function(){var link=frm_verify.__app_links[arg];if(link)
openItem(link,true,'app');};if(view.data.code){view.parent._size(400,700,true);this.btn_reset._onclick=function(){this._reset(view.data.code);}.bind(this);}
var qr=mkElement('img',{src:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'two_factor_qr','fullpath':view.data.code||'','rand':unique_id()})});qr.onerror=function(){if(view.data.code){gui._create('alert','frm_alert','','',false,'VERIFICATION::TWOSTEP','LOGIN_SCREEN::ANTISPAM_CODE_ERROR');view.view('code',arg);}
else{gui._create('alert','frm_alert','','',false,'VERIFICATION::TWOSTEP','VERIFICATION::ERROR');view.view('main');}};qr.onload=function(){var link=this._getAnchor('manual');addcss(link,'link');link.onclick=function(){view.view('manual',arg);};}.bind(this);this._getAnchor('qr').appendChild(qr);},_reset:function(code){WMAccounts.action({'TWO_FACTOR_CODE':code},'reset_two_factor',[this,'_response']);},_response:function(bOK){if(bOK){this.__view.parent._enable2FE(false);this.__view.parent._close();}
else{this.__view.parent._code([this,'_reset']);}}};

/* client/inc/frm_verify_app_auth_inp.js */
function frm_verify_app_auth_inp(){};frm_verify_app_auth_inp.prototype={__constructor:function(view,arg){var me=this;view.buttons({'btn_verify':{value:'verification::verify',css:'color1',disabled:true,onclick:function(){this._disabled(true);me._create('loader','obj_loader')._value(getLang('VERIFICATION::VERIFYING'));var pass=view.parent._rsa(view.data.app_pass);WMAccounts.action({two_factor_code:view.data.app_code,password:pass},'confirm_two_factor',[response]);}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});var aData={h:getLang(arg=='ios'?'VERIFICATION::APP_AUTH_HIOS':'VERIFICATION::APP_AUTH_HANDROID'),pwd_lbl:getLang('VERIFICATION::APP_AUTH_PASS',['<span class="account">'+sPrimaryAccount+'</span>'])};this._draw('frm_verify_app_auth_inp','main',aData);function check(){view.parent.btn_verify._disabled(!(view.data.app_pass&&view.data.app_code&&view.data.app_code.length==6));};this.code._maxlength(6);this.code._restrict(/^\d{6}$/g);this.code._onerror=function(b){view.data.app_code=b?'':this._value();check();};this.pass._onchange=function(){view.data.app_pass=this._value();check();};this.pass._onsubmit=this.code._onsubmit=function(){check();if(!view.parent.btn_verify._disabled())
view.parent.btn_verify._onclick();};function response(bOK,aData){if(bOK){view.view('success');}
else{me.loader._destruct();view.parent.btn_verify._disabled(false);me.code._select();gui.notifier._value({type:'alert',args:{text:'VERIFICATION::ERROR'}});}};}};

/* client/inc/frm_verify_app_manual.js */
function frm_verify_app_manual(){};frm_verify_app_manual.prototype={__constructor:function(view,arg){this._create('loader','obj_loader');this.__view=view;storage.library('blowfish','crypto');var aData={h:getLang('VERIFICATION::APP_AUTH_LBL',[getLang(arg=='ios'?'VERIFICATION::APP_BTN_IOS':'VERIFICATION::APP_BTN_ANDROID')])};this._draw('frm_verify_app_manual','main',aData);this.service._value(dataSet.get('main',['domain']));this.service._onclick=function(){this._select()};this.key._onclick=function(){this._select()};this.account._value(sPrimaryAccount);this.account._onclick=function(){this._select()};this._init(view.data.code);},_init:function(code){var tmp=auth.hashid({"username":dataSet.get('accounts',[sPrimaryAccount,'USERNAME'])}),pass=SHA1(unique_id()),secure=buildURL({code:code||'',key:pass,t:tmp.time}),rsa=new RSAKey();rsa.setPublic(tmp.hash,'10001');WMAccounts.action({'TWO_FACTOR_KEY':rsa.encrypt(secure)},'manual_two_factor',[function(bOK,aData){var ciphertext;if(bOK&&aData.TOTP_SECRET&&(ciphertext=aData.TOTP_SECRET[0].VALUE)){var bf=new Blowfish(pass);this.key._value(bf.decrypt(bf.base64Decode(ciphertext)));this.loader&&this.loader._destruct();}
else{this.__view.parent._code([this,'_init']);}}.bind(this)]);}};

/* client/inc/frm_verify_code.js */
function frm_verify_code(){};frm_verify_code.prototype={__constructor:function(view,arg){view.title('VERIFICATION::TWOSTEP');view.buttons({'btn_next':{value:'COMMON::NEXT',css:'color1',onclick:function(){view.view('auth');}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});this.code._maxlength(6);this.code._restrict(/^\d{6}$/g);this.code._onerror=function(b){view.data.code=b?'':this._value();view.parent.btn_next._disabled(b);};this.code._onsubmit=function(){if(!view.parent.btn_next._disabled())
view.parent.btn_next._onclick();};view.parent.btn_next._disabled(true);var img=new Image();img.src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'two_factor_qr','fullpath':'','rand':unique_id()});}};

/* client/inc/frm_verify_main.js */
function frm_verify_main(){};frm_verify_main.prototype={__constructor:function(view){view.data={};view.title('VERIFICATION::TWOSTEP');view.buttons({'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});this._getAnchor('app').onclick=function(){WMAccounts.action({TWO_FACTOR_TYPE:0},'setup_two_factor',[response,['app']]);}.bind(this);if(sPrimaryAccount2F<2){addcss(this._getAnchor('sms'),'disabled');var elm=this._getAnchor('sms').querySelector('span.info');gui.tooltip._add(elm,getLang('VERIFICATION::SMS_DISABLED'),{hide:false,css:'dark pad'});}
else{this._getAnchor('sms').onclick=function(){view.view('sms');}.bind(this);}
function response(bOK,aData,sType){if(bOK){view.view(sType);}
else{console.warn('Unable to activate two-factor'+sType);}}}};

/* client/inc/frm_verify_sms.js */
function frm_verify_sms(){};frm_verify_sms.prototype={__constructor:function(view){this.__eCode=null;this.__aData=view.data;this.__aData.country='';this.__aData.phone='';view.title('VERIFICATION::SMS');view.buttons({'btn_next':{value:'COMMON::NEXT',css:'color1',disabled:true,onclick:function(){WMAccounts.action({TWO_FACTOR_TYPE:1,TWO_FACTOR_PHONE:view.data.country.toString()+view.data.phone.toString()},'setup_two_factor',[function(bOK){bOK&&view.view('sms_code');}]);}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});storage.library('codes','codes');var aData=[[getLang('VERIFICATION::COUNTRY_PH'),0]];for(var i=0,j=country_calling_codes.length;i<j;i++){aData.push([country_calling_codes[i].name,country_calling_codes[i].callingCode]);}
this.country._fill(aData);this.country._value(0);this.country._onchange=function(){this._showCode(this.country._getDataValue());}.bind(this);this.phone._onchange=function(){view.data.phone=this.phone._value();view.parent.btn_next._disabled(!view.data.phone);}.bind(this);},_showCode:function(code){if(code){addcss(this.phone._main,'show_code');if(!this.__eCode){this.__eCode=mkElement('div',{class:'code'});this.__eCode.onclick=function(){this.country._value(0);}.bind(this);this.phone._main.insertBefore(this.__eCode,this.phone._main.firstChild);}
this.__eCode.innerHTML='+'+code;this.__aData.country=code;}
else{removecss(this.phone._main,'show_code');this.__aData.country='';}}};

/* client/inc/frm_verify_sms_code.js */
function frm_verify_sms_code(){};frm_verify_sms_code.prototype={__constructor:function(view){var me=this;view.title('VERIFICATION::SMS');view.buttons({'btn_verify':{value:'VERIFICATION::VERIFY',css:'color1',disabled:true,onclick:function(){this._disabled(true);me._create('loader','obj_loader')._value(getLang('VERIFICATION::VERIFYING'));var pass=view.parent._rsa(view.data.pass);WMAccounts.action({two_factor_code:view.data.code,password:pass},'confirm_two_factor',[response]);}},'btn_cancel':{value:'FORM_BUTTONS::CANCEL'}});var aData={label:getLang('VERIFICATION::SMS_CODE_LBL',['<b>'+(view.data.country?'+'+view.data.country+' ':'')+view.data.phone+'</b>']),pwd_lbl:getLang('VERIFICATION::APP_AUTH_PASS',['<span class="account">'+sPrimaryAccount+'</span>'])};this._draw('frm_verify_sms_code','main',aData);function check(){view.parent.btn_verify._disabled(!(view.data.pass&&view.data.code&&view.data.code.length==6));};this.code._maxlength(6);this.code._restrict(/^\d{6}$/g);this.code._onerror=function(b){view.data.code=b?'':this._value();check();};this.pass._onchange=function(){view.data.pass=this._value();check();};this.pass._onsubmit=this.code._onsubmit=function(){check();if(!view.parent.btn_verify._disabled())
view.parent.btn_verify._onclick();};function response(bOK,aData){if(bOK){view.view('success');}
else{me.loader._destruct();view.parent.btn_verify._disabled(false);me.code._select();gui.notifier._value({type:'alert',args:{text:'VERIFICATION::ERROR'}});}};}};

/* client/inc/frm_verify_success.js */
function frm_verify_success(){};frm_verify_success.prototype={__constructor:function(view,arg){view.parent._enable2FE(true);view.buttons({'btn_next':{value:'COMMON::DONE',css:'color1',onclick:function(){view.parent._destruct();}}});var aData={lbl:getLang('VERIFICATION::SUCCESS',['<span class="bold">'+sPrimaryAccount+'</span>'])};this._draw('frm_verify_success','main',aData);}};

/* client/inc/frm_video.js */
_me=frm_video.prototype;function frm_video(){};_me.__constructor=function(remoteStream,localStream){if(!remoteStream)
if(localStream){this._title("DIAL::LOCALCAM");remoteStream=localStream;localStream=null;}
else{this._destruct();return;}
else
this._title("DIAL::REMOTECAM");var me=this;this._defaultSize(-1,-1,450,300);this._draw('frm_video','main');this._create('loader','obj_loader');this.__video=remoteStream;this.__video.className='remote';if(this.__video.nodeName=='OBJECT'){if(this.loader)
this.loader._destruct();this._getAnchor('video').appendChild(this.__video);if(localStream){localStream.className='local';me._getAnchor('video').appendChild(localStream);}
this.__video.width=640;this.__video.height=480;}else{this.__video.onplaying=function(e){this.onplaying=null;if(me.loader)
me.loader._destruct();try{me._getAnchor('video').appendChild(me.__video);me.__video.play();if(localStream){localStream.className='local';me._getAnchor('video').appendChild(localStream);localStream.play();}
me._onresize();}
catch(r){me._destruct();}};if(navigator.browser&&navigator.browser.application=='Firefox'){this.__video.ontimeupdate=function(e){if(this.videoWidth){me._onresize();this.ontimeupdate=null;}}}
me._getAnchor('video').appendChild(me.__video);me.__video.play();if(localStream){localStream.className='local';me._getAnchor('video').appendChild(localStream);localStream.play();}}
this.mute._onclick=function(){if(gui.frm_main.sip)
gui.frm_main.sip._mute(!gui.frm_main.sip._mute());};this.__video.onclick=function(){me._fullscreen(me.__video);}
this._listen('sip');};_me._onresize=function(e,sType){if(!this.__position.max){var elm=this.__video;if(elm&&elm.parentNode&&elm.parentNode.clientHeight!=elm.offsetHeight)
switch(sType){case't':case'rt':case'b':this._place(this.__position.x,this.__position.y,this.__position.w-(elm.parentNode.offsetWidth-((elm.offsetWidth/elm.offsetHeight)*elm.parentNode.offsetHeight)),this.__position.h);break;case'lt':this._place(this.__position.x,this.__position.y+elm.parentNode.clientHeight-elm.clientHeight,this.__position.w,this.__position.h-elm.parentNode.clientHeight+elm.clientHeight);break;default:this._place(this.__position.x,this.__position.y,this.__position.w,this.__position.h-elm.parentNode.clientHeight+elm.clientHeight);}}};_me._onclose=function(b){var sip=gui.frm_main.sip,act=dataSet.get('sip',['activity']);if(b&&sip&&act){if(act=='Phoning')
sip._hangup();else
if(act=='Conference')
sip._leave();}else return true;};_me.__update=function(){var ds=dataSet.get('sip');if(ds.muted)
addcss(this.mute._main,'active');else
removecss(this.mute._main,'active');switch(ds.type){case'CallFinished':case'CallCanceled':this._destruct();break;}};

/* client/inc/frm_virtual.js */
_me=frm_virtual.prototype;function frm_virtual(){};_me.__constructor=function(sFolderID,sSearch,aHandler){this._title('VIRTUAL::VIRTUAL');this._size(700,450,true);this.__aHandler=aHandler;this.__fid=sFolderID;this.__aData={};this.x_btn_ok._disabled(true);if(sFolderID&&sFolderID.indexOf('__@@VIRTUAL@@__/')==0){this.__edit=true;WMFolders.list({aid:sPrimaryAccount,fid:sFolderID},'','',[this,'__prepareData']);}else{var out={};out.TYPE=this.__fid?WMFolders.getType({aid:sPrimaryAccount,fid:this.__fid}):'M';if(this.__fid){out.VIRTUAL={FOLDERS:{}};out.VIRTUAL.FOLDERS[this.__fid]=true;out.VIRTUAL.SEARCH=sSearch;}
this.__loadItems(out);}};_me.__prepareData=function(aData){this.__loadItems(aData[sPrimaryAccount][this.__fid]);};_me.__loadItems=function(aData){var me=this;if(this.__fid&&aData.VIRTUAL&&aData.VIRTUAL.FOLDERS)
this.__aData=aData.VIRTUAL.FOLDERS;var aFill={M:getLang('FOLDER_TYPES::MAIL')};if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');if(!dgw||dgw.indexOf('c')<0)
aFill.C=getLang('FOLDER_TYPES::CONTACT');if(!dgw||dgw.indexOf('e')<0)
aFill.E=getLang('FOLDER_TYPES::EVENT');if(!dgw||dgw.indexOf('j')<0)
aFill.J=getLang('FOLDER_TYPES::JOURNAL');if(!dgw||dgw.indexOf('n')<0)
aFill.N=getLang('FOLDER_TYPES::NOTE');if(!dgw||dgw.indexOf('t')<0)
aFill.T=getLang('FOLDER_TYPES::TASK');if(!dgw||dgw.indexOf('f')<0)
aFill.F=getLang('FOLDER_TYPES::FILE');}
this._draw('frm_virtual','main',{aid:sPrimaryAccount,type:aData.TYPE});var sFullFolderPath=sPrimaryAccount;if(this.__edit){for(var i in this.__aData){sFullFolderPath=sPrimaryAccount+'/'+i;break;}}else
if(this.__fid){sFullFolderPath=sPrimaryAccount+'/'+this.__fid;}
this.tree._setActive(sFullFolderPath);this.tree._ondblclick=function(e,elm,id,idt){if(idt.aid&&idt.fid&&idt.ftype){if(!me.__aData[idt.fid])
me.__aData[idt.fid]=count(me.__aData)?false:true;me._fill();return true;}};this.add._onclick=function(){var tmp=this._parent.tree._getActive();if(tmp&&tmp[1]&&!me.__aData[tmp[1]]){me.__aData[tmp[1]]=count(me.__aData)?false:true;me._fill();}};this.share._setType=function(sType){if(sType=='M'){if(me.share._value()=='private')
me.share._value('selected');me.share._fill({"all":getLang('FORM_FOLDERS::ALL'),"selected":getLang('FORM_FOLDERS::SELECTED')});}else
me.share._fill({"all":getLang('FORM_FOLDERS::ALL'),"selected":getLang('FORM_FOLDERS::SELECTED'),"private":getLang('FORM_FOLDERS::PRIVATE')});};this.share._setType(aData.TYPE);this.share._onchange=function(){var b=this._value()!='selected';me.tree._disabled(b);me.list._disabled(b);me.add._disabled(b);me.btn_remove._disabled(b);};this.share._value(aData.VIRTUAL&&aData.VIRTUAL.SHARETYPE?aData.VIRTUAL.SHARETYPE.toLowerCase():'selected');if(this.__edit)this.select_type._disabled(true);this.select_type._fill(aFill);this.select_type._value(aData.TYPE);this.select_type._onchange=function(){var sType=this._value();me.tree._filter_folder(sType);me.tree._fill();me.search._setType(sType);me.share._setType(sType);me.__aData={};me._fill();};this.search._disabled(false);this.search._setType(aData.TYPE);if(aData.VIRTUAL&&aData.VIRTUAL.SEARCH)
this.search._value(aData.VIRTUAL.SEARCH);this.btn_remove._onclick=function(){var id=this._parent.list._value(),bMain=false,folder;for(var i in id)
if(this._parent.list._aData[id[i]]&&this._parent.list._aData[id[i]].arg.folder){folder=this._parent.list._aData[id[i]].arg.folder;if(me.__aData[folder])
bMain=true;delete me.__aData[folder];}
if(bMain)
for(var i in me.__aData){me.__aData[i]=true;break;}
me._fill();};this.list._addColumns({main:{width:20,css:'ico main',type:'static'},folder:{title:"COMMON::FOLDER",width:100,mode:'%',type:'static'}});this.list._ondblclick=function(e,elm,arg,id0,id1){if(id0&&id1){var id=this._value();id=id[0];if(id&&this._aData[id]&&this._aData[id].arg.folder)
var folder=this._aData[id].arg.folder;else
return;for(var i in me.__aData)
me.__aData[i]=false;me.__aData[folder]=true;me._fill();}};if(this.__fid){var sFolder=dataSet.get('folders',[sPrimaryAccount,this.__fid,'NAME'])||Path.basename(this.__fid);this.name._value(sFolder);}
this._fill();this.x_btn_ok._onclick=function(){me.__save();me._destruct();};this.name._onerror=function(){me._checkOk();};};_me._fill=function(){var aData=[],sw;for(var i in this.__aData)
if(this.__aData[i])
aData.push({data:{main:['','',getLang('VIRTUAL::PRIMARY')],folder:[Path.basename(i),i,i]},arg:{folder:i},css:'main'});else
aData.push({data:{folder:[Path.basename(i),i,i]},arg:{folder:i}});if((sw=aData.length?false:true))
aData.push({data:{folder:getLang('VIRTUAL::ALL')}});this.btn_remove._disabled(sw);this.list._fill(aData);this._checkOk();};_me._checkOk=function(){this.x_btn_ok._disabled(this.name.__check()?false:true);};_me.__save=function(){var sFolderName='__@@VIRTUAL@@__/'+this.name._value();var out={'aid':sPrimaryAccount,'name':sFolderName,'type':this.select_type._value(),'search':this.search._value(),'virtual':{}};if(this.share._value()=='selected')
out.virtual.folders=this.__aData;else
out.virtual.sharetype=this.share._value();if(this.__edit)
out.fid=this.__fid;else
if(dataSet.get('folders',[sPrimaryAccount,sFolderName])){alert(getLang('FORM_FOLDERS::CREATE_ERROR'));return;}
WMFolders.add(out,'folders','',this.__aHandler);};

/* client/inc/frm_whatsnew.js */
_me=frm_whatsnew.prototype;function frm_whatsnew(){};_me.__constructor=function(){storage.library('gw_others');var me=this;this.__lastTab='';this._size(620,715,true);this._modal(true);this._dockable(false);this._resizable(false);this._create('loader','obj_loader');this._draw('frm_whatsnew','main');this.__checkPosition();this._create('btn_next','obj_button','footer','color1 simple');this.btn_next._value('COMMON::NEXT');this.btn_next._onclick=function(){var tabs=this._parent.maintab;if(tabs._value()==me.__lastTab)
this._parent._close();else
tabs._next();};function mkVideo(name){var HiDPI=window.devicePixelRatio>1;var play=mkElement('div',{className:'play',textContent:getLang('WHATSNEW::PLAY')});var video=mkElement('video',{loop:false,controls:false,autoplay:true,playbackRate:0.8},false,[mkElement('source',{src:'client/skins/default/videos/whatsnew_'+name+(HiDPI?'-2x':'-1x')+'.mp4',type:'video/mp4'})]);video.addEventListener('ended',function(){play.classList.remove('hidden');play.textContent=getLang('WHATSNEW::REPLAY');});video.addEventListener('play',function(){play.classList.add('hidden');});play.addEventListener('click',function(){video.currentTime=0;video.play();play.classList.add('hidden');});return mkElement('div',{className:'video_container'},false,[video,play]);}
this.__video={'COLLABORATION':mkVideo('collaboration'),'SEARCH':mkVideo('search')};this.__opt={};if(sPrimaryAccountGUEST){this.__opt.show=['all','guest'];}
var sURL='client/languages/'+GWOthers.getItem('LAYOUT_SETTINGS','language')+'/whatsnew.xml';request.get(sURL,[function(aXML){aXML=aXML.Array.XML[0];for(var i in aXML){if(me.__opt.show&&(aXML[i][0].ATTRIBUTES||{}).SHOW&&inArray(me.__opt.show,aXML[i][0].ATTRIBUTES.SHOW||'')<0)
continue;if(aXML[i][0].TITLE){if(me._tabCreationHandler(i)===false)
continue;me.__lastTab=i;var tab=me.maintab._create(i,'obj_tab','','nopadding '+((aXML[i][0].ATTRIBUTES||{}).CSS||''));tab._value(aXML[i][0].TITLE[0].VALUE,true);tab._onactive=function(bFirstTime){if(bFirstTime){var x=aXML[this._name][0];if(x.URL){this._create("frame","obj_frame","main");;this.frame._src(x.URL);}
else{var aData={block:{},data:{},css:this._name.toLowerCase()},tmp;for(var n in x){if(n!=='ATTRIBUTES'){if(me.__opt.show&&(x[n][0].ATTRIBUTES||{}).SHOW&&inArray(me.__opt.show,x[n][0].ATTRIBUTES.SHOW||'')<0)
continue;if(n.indexOf('LI_')===0){tmp=n.split('_');aData.block[tmp[1]]=aData.block[tmp[1]]||{css:tmp[0]+'_'+tmp[1]};aData.block[tmp[1]][tmp[2]?tmp[2]:'BODY']=x[n][0].VALUE.replace(/\\n/g,'<br>');}
else
if(x[n][0].VALUE)
aData.data[n]=x[n][0].VALUE;}}
this._draw(x.ATTRIBUTES&&x.ATTRIBUTES.TEMPLATE?'frm_whatsnew_'+x.ATTRIBUTES.TEMPLATE:'frm_whatsnew_body','main',aData);var main=this._getAnchor('main');if(main.scrollHeight>main.clientHeight+20)
addcss(main,'show');main.appendChild(mkElement('div',{className:'scroller unselectable'},document,[mkElement('div',{innerHTML:getLang('COMMON::SCROLL_DN')})]));main.appendChild(mkElement('div',{className:'mask unselectable'}));main.onscroll=function(){if(this.clientHeight+20<this.scrollHeight){if(this.scrollTop<20){addcss(this,'show');return true;}}
removecss(this,'show');};me._obeyEvent('onresize',[function(){main.onscroll()}]);}}
if(me.__lastTab===this._name){me.btn_next._value('WHATSNEW::START');removecss(me.btn_next._main,'ico2');}
else{me.btn_next._value('COMMON::NEXT');addcss(me.btn_next._main,'ico2');}
me._tabActivationHandler(this._name,this,bFirstTime);};tab._onclick=function(e,elm){if(hascss(elm,'link'))
me._tabClickHandler(this._name,[].slice.apply(elm.classList));};}}
me.maintab[me.maintab._value()]._onactive(true);var tabs=me.maintab._getChildObjects('main','obj_tab');if(tabs.length==1){addcss(me.maintab._main,'notabs');}
me.loader._destruct();}],[function(){me._destruct();}]);};_me._onclose=function(){window.removeEventListener('message',this._messageHandler);var tmp=GWOthers.getItem('LOGIN_SETTINGS','version').split('.');Cookie.set(['whatsnew'],tmp[0]+'.'+tmp[1]+'.'+tmp[2]);return true;};_me._tabCreationHandler=function(sTab){};_me._tabActivationHandler=function(sTab,oTab,bFirstTime){var video;for(var i in this.__video){video=this.__video[i].querySelector('video');video.pause();try{video.currentTime=0;}catch(e){console.log(e);}}
switch(sTab){case'COLLABORATION':case'SEARCH':if(bFirstTime){oTab._main.querySelector('.block').insertAdjacentElement('afterbegin',this.__video[sTab]);}
try{this.__video[sTab].querySelector('video').play();}catch(e){}
break;}};_me._tabClickHandler=function(sTab,aProps){};

/* client/inc/frm_wizard.js */
function frm_wizard(){};frm_wizard.prototype={__constructor:function(){this._size(400,680,true);this._create('label','obj_label','header','ico');this.__views={};this.__data={};this.__view=null;this._create('scrollbar','obj_scrollbar')._scrollbar(this._getAnchor('main'));},_view:function(sView,arg){if(this.__views[sView]){this._main.setAttribute('slide',sView);this._create('main',this.__views[sView],'','',{title:function(v){this.label._value(getLang(v))}.bind(this),buttons:function(v){this._buttons(v)}.bind(this),view:function(v,arg){this._view(v,arg)}.bind(this),data:this.__data,parent:this},arg);}
else
console.warn(this._pathName,'undefined view');},_buttons:function(arr){this._clean('footer');for(var name in arr){var btn=this._create(name,arr[name].type||'obj_button','footer',arr[name].css);if(arr[name].disabled)
btn._disabled(true);if(arr[name].value)
btn._value(arr[name].value);if(arr[name].onclick){btn._onclick=arr[name].onclick;}
else
if(name=='btn_cancel'){btn._onclick=function(){this._destruct();}.bind(this);}}},};

/* client/inc/giphy.js */
(function(){var url='//api.giphy.com/';var API_KEY='dc6zaTOxFJmzC';function xhr(url,data,callback,options){var request=new XMLHttpRequest();request.open("GET",url+'?'+Object.keys(data).map(function(key){return key+'='+data[key];}).join('&'));if(callback){request.onload=function(){callback.success&&callback.success.call(callback.context,this.response);};callback.abort&&(request.onabort=callback.abort.bind(callback.context));callback.error&&(request.onerror=callback.error.bind(callback.context));callback.progress&&(request.onprogress=callback.progress.bind(callback.context));}
for(var key in options){request[key]=options[key];}
request.send(data);}
function giphyCommand(command,data,callback){data.api_key=API_KEY;xhr(url+command,data,{success:function(response){response=JSON.parse(response);if(response.meta.status===200){callback.success&&callback.success.call(callback.context,response);}else{callback.error&&callback.error.call(callback.context,response);}},context:this});}
var Giphy={};Giphy.ratings=['Y','G','PG','PG-13','R'];Giphy.enable_keyboard=false;Giphy.sendToTC=function(url,name,ctx){xhr(url,{},{success:function(response){ctx.upload.file.__ondropfile([new File([response],name.trim()+'.gif')]);}},{responseType:"blob"});};Giphy.trending=function(rating,callback,context){giphyCommand('/v1/gifs/trending',{rating:rating},{success:function(response){if(response.meta.status===200){callback.call(context,null,response.data);}else{callback.call(context,true,[]);}},context:this});};Giphy.search=function(query,lang,rating,callback,context){giphyCommand('/v1/gifs/search',{rating:rating,q:query,lang:lang},{success:function(response){if(response.meta.status===200){callback.call(context,null,response.data);}else{callback.call(context,true,[]);}},context:this});};Giphy.translate=function(query,rating){giphyCommand('v1/gifs/translate',{s:query,rating:rating||'pg-13'},{success:function(response){if(response&&response.data&&response.data.images&&response.data.images.downsized){xhr(response.data.images.downsized.url,{},{success:function(response){gui.frm_main.main.upload.file.__ondropfile([new File([response],query.trim()+'.gif')]);}},{responseType:"blob"});}},context:this});};Giphy.translateFromInput=function(value){this.translate(value.toLowerCase().replace('/giphy',''),'r');};window.Giphy=Giphy;}());

/* client/inc/gw_holidays.js */
function gw_holidays(){};var _me=gw_holidays.prototype;_me.get=function(sDataSet,sType)
{if(!sDataSet)return false;var aHolidays=dataSet.get(sDataSet,[sType||'HOLIDAYS']);if(typeof aHolidays!='object')return false;var aHolidayFrame;var aResult=[];var aHolidayResult;for(var n in aHolidays['ITEMS']){aHolidayFrame=aHolidays['ITEMS'][n];aHolidayResult={};aHolidayResult['UID']=aHolidayFrame['ATTRIBUTES']['UID'];for(var sValue in aHolidayFrame['VALUES'])
aHolidayResult[sValue]=aHolidayFrame['VALUES'][sValue]['VALUE'];aResult.push(aHolidayResult);}
function sortit(a,b){if(a['NAME']>b['NAME'])
return 1;else
if(a['NAME']<b['NAME'])
return-1;else
return 0;};return aResult.sort(sortit);};_me.set=function(aSubscribe,sDataSet,sType)
{var aHolidays=dataSet.get(sDataSet,[sType||'HOLIDAYS','ITEMS']);if(typeof aHolidays!='object')return false;var sub,bChange,bFound;for(var sHolId in aSubscribe){bFound=false;for(var n in aHolidays)
if(sHolId==aHolidays[n]['ATTRIBUTES']['UID']){bFound=true;sub=aHolidays[n]['VALUES']['SUBSCRIBED']&&aHolidays[n]['VALUES']['SUBSCRIBED']['VALUE']?aHolidays[n]['VALUES']['SUBSCRIBED']['VALUE']:'false';if(aSubscribe[sHolId]!=sub){aHolidays[n]['VALUES']['SUBSCRIBED']={ATTRIBUTES:{ACCESS:'full'}};aHolidays[n]['VALUES']['SUBSCRIBED']['VALUE']=aSubscribe[sHolId];aHolidays[n]['ATTRIBUTES']['DONT_SEND']=false;bChange=true;}
break;}
if(!bFound&&aSubscribe[sHolId]=='true'){aHolidays.push({'ATTRIBUTES':{'UID':sHolId,'ACCESS':'full','DONT_SEND':false},'VALUES':{'NAME':{'ATTRIBUTES':{'ACCESS':'full'},'VALUE':sHolId},'SUBSCRIBED':{'ATTRIBUTES':{'ACCESS':'full'},'VALUE':'true'}}});bChange=true;}}
if(bChange){dataSet.add(sDataSet,[sType||'HOLIDAYS','ITEMS'],aHolidays);dataSet.add(sDataSet,[sType||'HOLIDAYS','ATTRIBUTES','DONT_SEND'],false);}
return true;};

/* client/inc/hash.js */
function hash(){}
hash.prototype={__constructor:function(){var me=this;window.addEventListener("hashchange",function(e){if(me.__timer)
window.clearTimeout(me.__timer);me.__timer=setTimeout(function(){if(me.__url!=e.newURL){me.__url=e.newURL;me.__exeEvent('hashchange',{url:e.newURL,hash:me._getHash(e.newURL)});}},100);},false);},__url:window.location.href.toString(),_setHash:function(v,bNoUpdate){if(this.__timer){window.clearTimeout(this.__timer);delete this.__timer;}
var url=window.location.href.replace(/#.*/,'')+'#'+v;if(bNoUpdate)
this.__url=url;window.location.href=url;},_getHash:function(url){return(url||window.location.href).replace(/^[^#]*#?(.*)$/,'$1');}};

/* client/inc/imip_recurrence.js */
function iMipRecurrence(sRecurence,bgn,bTime,end){var rules=sRecurence.split(';');for(var r in rules){var rule=rules[r].split('=');if(rule[0]&&rule[1])this[rule[0].toLowerCase()]=rule[1];}
if(this.freq&&!this.interval)this.interval=1;if(bgn)this.start=bgn;if(end)this.end=end;this.withtime=bTime?true:false;}
iMipRecurrence.prototype.toString=function(date_format){var str='';if(this.start&&this.end){if(!this.withtime){this.start.add(1,'day');}
var same_date=this.start.format('L')===this.end.format('L');str=getLang('RECURRENCE::TIME'+(same_date?'_SAMEDATE':''),[this.start.format(date_format||'L'),this.timeToString(),same_date?'':this.end.format(date_format||'L'),this.withtime?this.end.format('LT'):getLang('TIME_INTERVAL::ALL_DAY_EVENT')]);}
if(!this.freq){return str;}
if(str){str+='<br>';}
switch(this.freq.toLowerCase()){case'secondly':case'minutely':case'hourly':str+=getLang('DATES::'+this.freq+(this.interval>1?'_N':''),[this.interval]);break;case'daily':if(this.byday==='MO,TU,WE,TH,FR'){str+=getLang('RECURRENCE::DAILY_WORKDAYS');}else if(this.byday==='SU,SA'){str+=getLang('RECURRENCE::DAILY_WEEKENDS');}else{str+=getLang('RECURRENCE::DAILY'+(this.interval>1?'_N':''),[this.interval]);}
break;case'weekly':str+=getLang('RECURRENCE::WEEKLY'+(this.interval>1?'_N':''),[this.interval,this.localizedByDay()]);break;case'monthly':str+=getLang('RECURRENCE::MONTHLY'+(this.interval>1?'_N':''),[this.interval,this.localizedByDay(),this.localizedByMonthDay()]);break;case'yearly':str+=getLang('RECURRENCE::YEARLY'+(this.interval>1?'_N':''),[this.interval,this.localizedByDay(),this.localizedByMonth(),this.localizedByWeekNo(),this.localizedByYearDay()]);}
if(this.until){str+=' '+getLang('RECURRENCE::UNTIL',[new IcewarpDate(this.until).format('L')]);}else if(this.count){str+=', '+getLang('RECURRENCE::TIMES'+(this.count>1?'_N':''),[this.count]);}
return str;};iMipRecurrence.prototype.timeToString=function(){if(!this.withtime&&!this.byhour&&!this.byminute){return'';}
var hour=this.start.hour(),minute=this.start.minute(),ms=new IcewarpDate(+this.start),at=[],tmp=[];if(this.byhour){var hours=this.byhour.split(',');for(var h in hours){tmp.push(ms.clone().hour(hours[h]));}}else{tmp.push(ms.clone().hour(hour));}
if(this.byminute){var minutes=this.byminute.split(',');for(var t in tmp){for(var m in minutes){at.push(tmp[t].clone().minute(minutes[m]));}}}else{for(var t in tmp){at.push(tmp[t].clone().minute(minute));}}
for(var a in at){at[a]=at[a].format('LT');}
var tmp=at.pop();return(at.length?at.join(', ')+' '+getLang('DATES::AND'):'')+' '+tmp;};iMipRecurrence.prototype.localizedByDay=function(){if(!this.byday){return'';}
var byday=this.byday;var numbers=byday.match(/[+-]?\d+/g);if(numbers&&!numbers.some(function(number){return number!==numbers[0];})){byday=numbers[0]+byday.replace(new RegExp(numbers[0],'g'),'');}
var re=/([+-]?)(\d?)(\w+)/;var on=[];var days=this.sortWeekDays(byday);for(var d in days){var m=days[d].match(re);m&&on.push(getLang('RECURRENCE::'+(iMipRecurrence.week[m[3]]||m[3])+(m[2]?'_'+(m[1]==='-'?'-':'')+(m[2]<5&&m[2]>-2?m[2]:'N'):'')));}
var tmp=on.pop();return(on.length?on.join(', ')+' '+getLang('DATES::AND')+' ':'')+tmp;};iMipRecurrence.prototype.sortWeekDays=function(weekdays){weekdays=(weekdays||this.byday).replace(/([+-]?\d*)S[AU],(.*)[+-]?\d*S[AU]/,'$1WEEKEND,$2').replace(/([+-]?\d*)MO,[+-]?\d*TU,[+-]?\d*WE,[+-]?\d*TH,[+-]?\d*FR/,'$1WORKWEEK').replace(/([+-]?\d*)WEEKEND,WORKWEEK/,'$1DAY');if(!weekdays){return[];}
weekdays=weekdays.split(',').filter(Boolean);weekdays_clean=weekdays.map(function(weekday){return weekday.replace(/[+-]?\d*/,'');});var week_begins={sunday:0,monday:2,tuesday:3,wednesday:4,thursday:5,friday:6,saturday:8}[GWOthers.getItem('CALENDAR_SETTINGS','week_begins')];var a=['SU','WEEKEND','MO','TU','WE','TH','FR','WORKWEEK','SA','DAY'];var ret=[];for(var i=0;i<a.length;i++){var key=((week_begins+i)%a.length);var index=weekdays_clean.indexOf(a[key]);if(~index){ret.push(weekdays[index]);}}
return ret;};iMipRecurrence.prototype.localizedByWeekNo=function(){if(!this.byweekno){return'';}
var weeks=this.byweekno.split(',');var tmp=weeks.pop();return getLang('RECURRENCE::ONWEEKNO'+(weeks.length?'_N':''),[(weeks.length?weeks.join(', ')+' '+getLang('DATES::AND')+' ':'')+tmp]);};iMipRecurrence.prototype.localizedByMonth=function(){if(!this.bymonth){return'';}
var months=this.bymonth.split(',');var on=[];for(var m in months){on.push(getLang('RECURRENCE::'+iMipRecurrence.month[months[m]-1]));}
var tmp=on.pop();return(on.length?on.join(', ')+' '+getLang('DATES::AND')+' ':'')+tmp;};iMipRecurrence.prototype.localizedByMonthDay=function(){if(!this.bymonthday){return'';}
var days=this.bymonthday.split(',');var tmp=days.pop();return getLang('RECURRENCE::ONMONTHDAY'+(days.length?'_N':''),[(days.length?days.join(', ')+' '+getLang('DATES::AND')+' ':'')+tmp]);};iMipRecurrence.prototype.localizedByYearDay=function(){if(!this.byyearday){return'';}
var days=this.byyearday.split(',');var tmp=days.pop();return getLang('RECURRENCE::ONYEARDAY'+(days.length?'_N':''),(days.length?days.join(', ')+' '+getLang('DATES::AND')+' ':'')+tmp);};iMipRecurrence.week={MO:'MONDAY',TU:'TUESDAY',WE:'WEDNESDAY',TH:'THURSDAY',FR:'FRIDAY',SA:'SATURDAY',SU:'SUNDAY'};iMipRecurrence.month=['JANUARY','FEBRUARY','MARCH','APRIL','MAY','JUNE','JULY','AUGUST','SEPTEMBER','OCTOBER','NOVEMBER','DECEMBER'];iMipRecurrence.prototype.toDates=function(){};

/* client/inc/night_mode.js */
function NightMode(target_window){function hexToRgbA(hex){var c;if(/^#([A-Fa-f0-9]{3}){1,2}$/.test(hex)){c=hex.substring(1).split('');if(c.length===3){c=[c[0],c[0],c[1],c[1],c[2],c[2]];}
c='0x'+c.join('');return'rgba('+[(c>>16)&255,(c>>8)&255,c&255].join(', ')+', 1)';}
throw new Error('Bad Hex');};function rgbToHsl(input){var r=input[0];var g=input[1];var b=input[2];var a=input[3];r/=255,g/=255,b/=255;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var h,s,l=(max+min)/2;if(max===min){h=s=0;}else{var d=max-min;s=l>0.5?d/(2-max-min):d/(max+min);switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}
h/=6;}
return a?[h,s,l,a]:[h,s,l];};function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p;};function hslToRgb(h,s,l){var r,g,b;if(s==0){r=g=b=l;}else{var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3);}
return[Math.round(r*255),Math.round(g*255),Math.round(b*255)];};function _NightMode(target_document){this.colors={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgreen:"#006400",darkgrey:"#a9a9a9",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",green:"#008000",greenyellow:"#adff2f",grey:"#808080",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgreen:"#90ee90",lightgrey:"#d3d3d3",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};this.lightness=0.12;this.target_document=target_document||document;this.selector_whitelist=['.obj_colorpicker > .light::before'];this.rgba_regexp=/(rgba?)\((.*?)\)/g;this.rgba_match_regexp=/\d+\.?\d*/g;this.colors_regexp=new RegExp('\\b'+Object.keys(this.colors).join('\\b|\\b')+'\\b','gi');this.original_rules={};this.original_dom_rules={};this.original_dom_rules_counter=0;function walkThruRules(stylesheets,callback,revert){[].forEach.call(stylesheets,function(style){if(revert){style.ownerNode.classList.remove('parsed');}
if(style.ownerNode.classList.contains('parsed')){return;}
try{[].forEach.call(style.cssRules||[],function(rule){try{[].forEach.call(rule.style||[],function(prop){callback(rule,prop);});}catch(e){}});}catch(e){}
if(!revert){style.ownerNode.classList.add('parsed');}});};function inverseDOMStyleProperties(revert){var currentNode;var ni=this.target_document.createNodeIterator(this.target_document.documentElement,NodeFilter.SHOW_ELEMENT,function(){return NodeFilter.FILTER_ACCEPT;},false);var rgba_match_regexp=this.rgba_match_regexp;while(currentNode=ni.nextNode()){[].forEach.call(currentNode.style,function(prop){if(revert){if(this.original_dom_rules[currentNode.id]&&this.original_dom_rules[currentNode.id][prop]){currentNode.style[prop]=this.original_dom_rules[currentNode.id][prop];}}else{var prop_value=currentNode.style.getPropertyValue(prop);prop_value=prop_value.replace(/#[A-Fa-f0-9]{3,6}/g,function(hex){return hexToRgbA(hex);}.bind(this));prop_value=prop_value.replace(this.colors_regexp,function(color){return hexToRgbA(this.colors[color]);}.bind(this));if(~prop_value.indexOf('rgb')){if(!currentNode.id){currentNode.id='night_mode_'+this.original_dom_rules_counter++;}
this.original_dom_rules[currentNode.id]=this.original_dom_rules[currentNode.id]||{};this.original_dom_rules[currentNode.id][prop]=prop_value;var value=prop_value.replace(this.rgba_regexp,function(match,g1,g2){var hsl=rgbToHsl(g2.match(rgba_match_regexp));hsl[2]=(1-hsl[2])-(1-2*hsl[2])*this.lightness;rgb=hslToRgb(hsl[0],hsl[1],hsl[2]);return g1+'('+rgb[0]+', '+rgb[1]+', '+rgb[2]+(hsl[3]?', '+hsl[3]:'')+')';}.bind(this));currentNode.style[prop]=value;}}}.bind(this));}};function inverseProperty(rule,prop){var prop_value=rule.style.getPropertyValue(prop);var rgba_match_regexp=this.rgba_match_regexp;prop_value=prop_value.replace(/#[A-Fa-f0-9]{3,6}/g,function(hex){return hexToRgbA(hex);}.bind(this));prop_value=prop_value.replace(this.colors_regexp,function(color){return hexToRgbA(this.colors[color]);}.bind(this));if(~prop_value.indexOf('rgb')){if(~this.selector_whitelist.indexOf(rule.selectorText)){return;}
this.original_rules[rule.selectorText]=this.original_rules[rule.selectorText]||{};this.original_rules[rule.selectorText][prop]=prop_value;var value=prop_value.replace(this.rgba_regexp,function(match,g1,g2){var rgb=g2.match(rgba_match_regexp);var hsl=rgbToHsl(rgb);hsl[2]=(1-hsl[2])-(1-2*hsl[2])*this.lightness;rgb=hslToRgb(hsl[0],hsl[1],hsl[2]);return g1+'('+rgb[0]+', '+rgb[1]+', '+rgb[2]+(hsl[3]?', '+hsl[3]:'')+')';}.bind(this));rule.style.setProperty(prop,value,rule.style.getPropertyPriority(prop));}};this.activate=function(lightness,callback){if(this.init&&this.target_document.head.contains(this.init)){callback&&callback();return this;}
var link=this.target_document.body.getElementsByTagName('a')[0];var link_color=link&&this.target_document.defaultView.getComputedStyle(link).color;this.lightness=lightness||this.lightness;var retries=200;this.retry_interval=setInterval(function(){walkThruRules(this.target_document.styleSheets,function(rule,prop){inverseProperty.call(this,rule,prop);}.bind(this));if(!retries--){clearInterval(this.retry_interval);}}.bind(this),5);this.target_document.body.classList.add('night_mode');inverseDOMStyleProperties.call(this);[].forEach.call(this.target_document.querySelectorAll('iframe'),function(iframe){setTimeout(function(){try{NightMode(iframe.contentWindow).activate();}catch(e){}},5);});this.init=this.target_document.createElement('style');this.init.classList.add('parsed');this.init.textContent='input, textarea { background-color: #000; color: #fff; }'+(link_color?('a:visited { color: '+link_color+'; } a { color:'+link_color+'; }'):'');this.target_document.head.appendChild(this.init);callback&&callback();return this;};this.reset=function(callback){if(!this.init){callback&&callback();return this;}
clearInterval(this.retry_interval);walkThruRules(this.target_document.styleSheets,function(rule,prop){if(~rule.style.getPropertyValue(prop).indexOf('rgb')){this.original_rules[rule.selectorText]&&rule.style.setProperty(prop,this.original_rules[rule.selectorText][prop],rule.style.getPropertyPriority(prop));}}.bind(this),true);inverseDOMStyleProperties.call(this,true);this.init.parentNode.removeChild(this.init);this.original_rules={};this.original_dom_rules={};this.target_document.body.classList.remove('night_mode');[].forEach.call(this.target_document.querySelectorAll('iframe'),function(iframe){setTimeout(function(){try{NightMode(iframe.contentWindow).reset();}catch(e){}},5);});callback&&callback();this.init=null;return this;};return this;};target_window=target_window||window;target_window.NM=target_window.NM||new _NightMode(target_window.document);return target_window.NM;};

/* client/inc/obj_actions.js */
_me=obj_actions.prototype;function obj_actions(){};_me.__constructor=function(){var me=this;this._draw('obj_actions','main',{disable_fw:GWOthers.getItem('RESTRICTIONS','disable_forwarder')>0,disable_ab:sPrimaryAccountGW<1||(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1});this.check_accept_delete._onchange=function(){me.__enableControl('accept_delete',this._value());};this.check_forward_to._onchange=function(){me.__enableControl('forward_to',this._value());me.check_forward_as_attachment._disabled(!this._value());};this.check_move_to._onchange=function(){me.__enableControl('move_to',this._value());};this.check_copy_to._onchange=function(){me.__enableControl('copy_to',this._value());};this.check_send_message._onchange=function(){me.__enableControl('send_message',this._value());};this.check_edit_header._onchange=function(){me.__enableControl('edit_header',this._value());};this.check_message_priority._onchange=function(){me.__enableControl('message_priority',this._value());};this.check_message_flags._onchange=function(){me.message_flag1._disabled(!this._value());me.message_flag2._disabled(!this._value());me.message_flag3._disabled(!this._value());if(this._value()){if(![].concat(me.message_flag1._value(),me.message_flag2._value(),me.message_flag3._value()).length){me.message_flag1._value([0]);}}
me.message_flag_custom._disabled(!this._value());};this.btn_forward._onclick=function(e){if(me.x_add_address&&!me.x_add_address.__destructed)
me.x_add_address._destruct();var aTabsNames={'forward':"FILTERS::FORWARD_TO"},aTabsValues={'forward':me.forward_to._value()};me.x_add_address=gui._create('add_address','frm_addaddress','','',[function(bOK,aValues){if(bOK)
me.forward_to._value(aValues.forward.join(';'));}],aTabsNames,aTabsValues,'forward',true,false,true);me.x_add_address._modal(true);};this.check_message_flags._onchange();this.message_flag1._fill(['Flagged','Seen','NonJunk','Junk']);this.message_flag2._fill(['Label1','Label2','Label3']);this.message_flag3._fill(['Label4','Label5','Label6']);};_me.__load=function(aValues){var sAcceptDelete;if(this.__getTagValue(aValues,'ACCEPT')=='1')
sAcceptDelete='ACCEPT';else
if(this.__getTagValue(aValues,'REJECT')=='1')
sAcceptDelete='REJECT';else
if(this.__getTagValue(aValues,'DELETE')=='1')
sAcceptDelete='DELETE';else
switch((this.__getTagValue(aValues,'MARKSPAM')||0).toString()){case'1':sAcceptDelete='MARKSPAM';break;case'2':sAcceptDelete='QUARANTINE';break;default:sAcceptDelete=undefined;break;}
var sTag;this.__enableControlAndSet('accept_delete',sAcceptDelete);this.__enableControl('stop_processing',this.__getTagValue(aValues,'STOP')=='1');this.__enableControlAndSet('forward_to',this.__getTagValue(aValues,'FORWARD'));this.check_forward_as_attachment._disabled(!this.__getTagValue(aValues,'FORWARD'));this.__enableControl('forward_as_attachment',this.__getTagValue(aValues,'FORWARDASATTACHMENT')=='1');sTag=this.__getTagValue(aValues,'MOVETOFOLDER');if(sTag)sTag=sPrimaryAccount+'/'+((sTag=='Inbox')?'INBOX':sTag);this.__enableControlAndSet('move_to',sTag);sTag=this.__getTagValue(aValues,'COPYTOFOLDER');if(sTag)sTag=sPrimaryAccount+'/'+((sTag=='Inbox')?'INBOX':sTag);this.__enableControlAndSet('copy_to',sTag);this.__enableControl('encrypt',this.__getTagValue(aValues,'ENCRYPT')=='1');this.__enableControlAndSet('message_priority',(this.__getTagValue(aValues,'PRIORITY')!='0')?this.__getTagValue(aValues,'PRIORITY'):undefined);if((this.__getTagValue(aValues,'FLAGS')||'0')!='0'){var flag=this.__getTagValue(aValues,'FLAGS');var arr=[];if(flag&1)arr.push(0);if(flag&2)arr.push(1);if(flag&8)arr.push(2);if(flag&4)arr.push(3);this.message_flag1._value(arr);var arr=[];if(flag&16)arr.push(0);if(flag&32)arr.push(1);if(flag&64)arr.push(2);this.message_flag2._value(arr);var arr=[];if(flag&128)arr.push(0);if(flag&256)arr.push(1);if(flag&512)arr.push(2);this.message_flag3._value(arr);this.message_flag_custom._value(this.__getTagValue(aValues,'CUSTOMFLAGS'));this.check_message_flags._value(1);}
else{this.message_flag1._disabled(true);this.message_flag2._disabled(true);this.message_flag3._disabled(true);this.message_flag_custom._disabled(true);this.message_flag3._value(0);}
this.__enableControlAndSet('send_message',Is.Defined(aValues['SENDMESSAGE'])?aValues['SENDMESSAGE'][0]:undefined);this.__enableControlAndSet('edit_header',Is.Defined(aValues['HEADER'])?aValues['HEADER'][0]['VAL'][0]['VALUE']:undefined);};_me.__save=function(aValues){this.__setTagValue(aValues,'ACCEPT','0');this.__setTagValue(aValues,'REJECT','0');this.__setTagValue(aValues,'DELETE','0');this.__setTagValue(aValues,'MARKSPAM','0');if(this.check_accept_delete._value()){switch(this.accept_delete._value()){case'MARKSPAM':this.__setTagValue(aValues,'MARKSPAM','1');break;case'QUARANTINE':this.__setTagValue(aValues,'MARKSPAM','2');break;default:this.__setTagValue(aValues,this.accept_delete._value(),'1');break;}}
this.__setTagValue(aValues,'STOP',(this.check_stop_processing._value())?'1':'0');if(this.check_forward_to._value()&&this.forward_to._value()){this.__setTagValue(aValues,'FORWARD',MailAddress.splitEmails(this.forward_to._value()).join(';'));this.__setTagValue(aValues,'FORWARDASATTACHMENT',this.check_forward_as_attachment._checked());}else{delete aValues['FORWARD'];delete aValues['FORWARDASATTACHMENT'];}
if(this.check_move_to._value()){sTag=Path.split(this.move_to._value())[1];this.__setTagValue(aValues,'MOVETOFOLDER',(sTag!='INBOX')?sTag:'Inbox');}else{delete aValues['MOVETOFOLDER'];}
if(this.check_copy_to._value()){sTag=Path.split(this.copy_to._value())[1];this.__setTagValue(aValues,'COPYTOFOLDER',(sTag!='INBOX')?sTag:'Inbox');}else{delete aValues['COPYTOFOLDER'];}
this.__setTagValue(aValues,'ENCRYPT',(this.check_encrypt._value())?'1':'0');if(this.check_send_message._value())
aValues['SENDMESSAGE']=[this.send_message._value()];else
delete aValues['SENDMESSAGE'];if(this.check_edit_header._value())
aValues['HEADER']=[{'VAL':[{'VALUE':this.edit_header._value()}]}];else
delete aValues['HEADER'];this.__setTagValue(aValues,'PRIORITY',(this.check_message_priority._value())?this.message_priority._value():'0');var arr,iFlags=0;if(this.check_message_flags._value()){this.__setTagValue(aValues,'CUSTOMFLAGS',this.message_flag_custom._value());arr=this.message_flag1._value();for(var i in arr){switch(arr[i].toString()){case'0':iFlags|=1;break;case'1':iFlags|=2;break;case'2':iFlags|=8;break;case'3':iFlags|=4;break;}}
arr=this.message_flag2._value();for(var i in arr){switch(arr[i].toString()){case'0':iFlags|=16;break;case'1':iFlags|=32;break;case'2':iFlags|=64;break;}}
arr=this.message_flag3._value();for(var i in arr){switch(arr[i].toString()){case'0':iFlags|=128;break;case'1':iFlags|=256;break;case'2':iFlags|=512;break;}}}else{delete aValues['CUSTOMFLAGS'];}
this.__setTagValue(aValues,'FLAGS',iFlags);};_me.__enableControl=function(sName,b){this['check_'+sName]._value(b);if(Is.Defined(this[sName])){this[sName]._disabled(!b);if(sName=='forward_to')
this.btn_forward._disabled(!b);}};_me.__enableControlAndSet=function(sName,sValue){var b=(sValue!=undefined&&sValue)?true:false;this.__enableControl(sName,b);if(b)this[sName]._value(sValue);};_me.__getTagValue=function(aValues,sName){if(Is.Defined(aValues[sName])){return aValues[sName][0]['VALUE'];}else{return undefined;}};_me.__setTagValue=function(aValues,sName,sValue){if(Is.Defined(aValues[sName])){aValues[sName][0]['VALUE']=sValue;}else{aValues[sName]=[{'VALUE':sValue}];}};_me._value=function(aValues){if(Is.Defined(aValues)){this.__aValues=aValues;this.__load(aValues);}else{this.__save(this.__aValues);return this.__aValues;}};

/* client/inc/obj_address.js */
_me=obj_address.prototype;function obj_address(){};_me.__constructor=function(){var me=this;if(GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')&&((GWOthers.getItem('RESTRICTIONS','disable_gmaps')||0)<1))
this.X_MAP._onclick=function(){var v=me._value().values;if(v&&v.LCTCITY&&v.LCTSTREET){var str=[];if(v.LCTSTREET)
str.push(v.LCTSTREET);if(v.LCTCITY)
str.push((v.LCTZIP?v.LCTZIP+' ':'')+v.LCTCITY);if(v.LCTSTATE)
str.push(v.LCTSTATE);if(v.LCTCOUNTRY)
str.push(v.LCTCOUNTRY);str=str.join(', ');gui._create('map','frm_gmap','','',str);}
else{if(!v.LCTCITY)
addcss(me.LCTCITY._main,'error');if(!v.LCTSTREET)
addcss(me.LCTSTREET._main,'error');setTimeout(function(){try{removecss(me.LCTCITY._main,'error');removecss(me.LCTSTREET._main,'error');}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}},1000);}};else
this.X_MAP._disabled(1);};_me._value=function(aValues){if(aValues){loadDataIntoForm(this,aValues['values']);this._id=aValues['values']['LCT_ID'];}else{var aResult={'values':[]};storeDataFromForm(this,aResult['values']);if(Is.Defined(this._id))aResult['uid']=this._id;return aResult;}};_me._title=function(sTitle){this._getAnchor('title').innerHTML=sTitle;};_me._readonly=function(b){this.LCTSTREET._readonly(b);this.LCTCITY._readonly(b);this.LCTSTATE._readonly(b);this.LCTZIP._readonly(b);this.LCTCOUNTRY._readonly(b);};_me._disabled=function(b){this.LCTSTREET._disabled(b);this.LCTCITY._disabled(b);this.LCTSTATE._disabled(b);this.LCTZIP._disabled(b);this.LCTCOUNTRY._disabled(b);};_me._tabIndex=function(sContainer,i,oDock){this.LCTSTREET._tabIndex(sContainer,i,oDock);this.LCTCITY._tabIndex(sContainer,i?++i:i,oDock);this.LCTSTATE._tabIndex(sContainer,i?++i:i,oDock);this.LCTZIP._tabIndex(sContainer,i?++i:i,oDock);this.LCTCOUNTRY._tabIndex(sContainer,i?++i:i,oDock);};_me._focus=function(b){return this.LCTSTREET._focus(b);};

/* client/inc/obj_allow_settings.js */
_me=obj_allow_settings.prototype;function obj_allow_settings(){};_me.__constructor=function(bUser){var me=this;if(this.domadmin)
this.domadmin._onchange=function(){if(this._checked())
me.user._value(1);};if(!bUser){this.user._onchange=function(){if(me.domadmin){if(!this._checked()&&me.domadmin._checked())
this._value(1);}};}
else{this.user._value(1,true);this.user._disabled(true);this.user._onchange=function(){this._value(1,true);};}};

/* client/inc/obj_attach_mailview.js */
_me=obj_attach_mailview.prototype;function obj_attach_mailview(){};_me.__constructor=function(){this.__idtable=[];this.__eAttach=this._getAnchor('attach');if(this.__eAttach){var me=this;this.__eAttach.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='B'){e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();}
if(elm.tagName!='A'&&!(elm=Is.Child(elm,'A',this)))
return false;var id=me.__getId(elm.id);if(me._onclick)me._onclick(e,elm,id,me.__idtable[id]);me.__exeEvent('onclick',e,{"arg":me.__idtable[id],"elm":elm,"id":id,"owner":me});return false;};this.__eAttach.oncontextmenu=this.__eAttach.onclick;this.__eAttach.ondblclick=this.__eAttach.onclick;}};_me._value=function(v){if(v&&Is.Array(v['attachments'])){if(v['attachments'].length>1){var bAll=false;for(var i in v['attachments']){if(v['attachments'][i].allurl){bAll=true;this._add({name:getLang('ATTACHMENT::ALL'),type:'allsa',url:v['attachments'][i].allurl});break;}}
if(!bAll)
for(var i in v['attachments'])
if(v['attachments'][i].size&&!v['attachments'][i].url){this._add({name:getLang('ATTACHMENT::ALL'),type:'all'});break;}}
for(var i in v['attachments'])
this._add(v['attachments'][i]);}};_me._add=function(aArg){this.__idtable.push(aArg);this._addGuiElement(aArg,this.__idtable.length-1);};_me._addGuiElement=function(aArg,id){if(!this.__eAttach||!Is.String(aArg.name))return;var att=mkElement('a',{"href":'',"id":this.__getElmId(id),className:(aArg.css?aArg.css:'')+(aArg.size?' ico_'+Path.extension(aArg.name):'')});att.onmousedown=function(){if(event.preventDefault)
event.preventDefault();};att.innerHTML='<span'+(aArg.name.length>36?' title="'+aArg.name.escapeXML(true)+'"':'')+'>'+(aArg.name.length>36?aArg.name.substr(0,30).escapeXML()+'...'+Path.extension(aArg.name):aArg.name.escapeXML())+(aArg.size?' <i>('+parseFileSize(aArg.size)+')</i>':'')+'</span><b></b>';this.__eAttach.appendChild(att);if(this._onchange)
this._onchange();};_me.__getElmId=function(id){return this._pathName+'/'+id;};_me.__getId=function(eid){return eid.substr(this._pathName.length+1);};_me._onclick=function(e,elm,id,arg){var srcElm=e.target||e.srcElement;var me=this;if(e.type=='contextmenu'||srcElm.tagName=='B'){var cmenu=gui._create("cmenu","obj_context",'','',this),aMenu=[];if(arg.type=='all'){aMenu.push({"title":'ATTACHMENT::SAVE','arg':[this,'_saveAll',[this._fullpath()]]});if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');var att=[];for(var i in this.__idtable)
if(this.__idtable[i].id)
att.push({'name':this.__idtable[i]['name'],'size':this.__idtable[i].size,'fullpath':this._fullpath(this.__idtable[i].id)});if(att.length>0){if(!dgw||dgw.indexOf('f')<0){aMenu.push({"title":'ATTACHMENT::SAVE_TO_FOLDER','arg':[this,'_saveFolder',[att]]});}
if(Alfresco.enabled()){aMenu.push({"title":'ATTACHMENT::SAVE_TO_ALFRESCO','arg':[this,'_saveFolderToAlfresco',[att]]});}}}}
else
if(arg.type=='certificate'){aMenu.push({"title":'ATTACHMENT::SAVE','arg':[this,'_save_cert',[this._fullpath()]]},{"title":'ATTACHMENT::SHOW_CERT','arg':[this,'_open_cert',[arg]]},{"title":'ATTACHMENT::APPEND_CERT','arg':[Item.addCert,[[this._aid,this._fid,this._iid]]]});}
else{if(arg.url){aMenu.push({"title":'ATTACHMENT::SAVE','arg':[downloadItem,[arg['url'],true]]});if(arg['allurl'])
aMenu.push({"title":'ATTACHMENT::SAVE_ALL','arg':[downloadItem,[arg['allurl'],true]]});}
else{switch(Path.extension(arg.name)){case'eml':arg.type='message/rfc822';break;case'vcf':arg.type='text/x-vcard';break;case'ics':arg.type='text/x-vcalendar';break;}
if(arg.type)
switch(arg.type.toLowerCase()){case'message/rfc822':var pos,sID;if((pos=this._iid.lastIndexOf('|'))>-1&&(WMFolders.getType([this._aid,this._fid])=='M'||(this._iid.match(/\|/g)||[]).length>1))
sID=this._iid.substr(0,pos+1)+arg.id;else
sID=this._iid+'|'+arg.id;aMenu.push({"title":'ATTACHMENT::OPEN_WINDOW','arg':[this,'_open',[this._aid,this._fid,sID]]});break;case'text/x-vcalendar':case'text/x-vcard':aMenu.push({"title":'ATTACHMENT::IMPORT','arg':[this,'_import',[this._aid,this._fid,this._iid+'|'+arg.id]]});}
aMenu.push({"title":'ATTACHMENT::SAVE','arg':[this,'_save',[this._fullpath(arg['id'])]]});}
if(arg.type!='allsa'){if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');if(!dgw||dgw.indexOf('f')<0)
aMenu.push({"title":'ATTACHMENT::SAVE_TO_FOLDER','arg':[this,'_saveFolder',[[{'name':arg['name'],'size':arg.size,'fullpath':this._fullpath(arg['id'])}]]]});if(Alfresco.enabled()){aMenu.push({"title":'ATTACHMENT::SAVE_TO_ALFRESCO','arg':[this,'_saveFolderToAlfresco',[[{'name':arg['name'],'size':arg.size,'fullpath':this._fullpath(arg['id'])}]]]});}}
switch(Path.extension(arg.name)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":var sFullPath=this._fullpath(arg['id']);aMenu.push({"title":'-'},{"title":'ATTACHMENT::SHOW_IMAGE',arg:[function(){var img=gui._create('imgview','frm_imgview');img._fill([{title:arg.name,url:(arg['url']?arg['url']:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath}))}]);img._value(0);}]});break;case"pdf":var sURL=arg['url']?arg['url']:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':this._fullpath(arg['id'])});if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')!=1||currentBrowser().match(/^MSIE([6-9]|10)$/)){aMenu.push({"title":'-'},{"title":'POPUP_ITEMS::OPEN',arg:[function(){gui._create('pdf','frm_pdf')._load(sURL,arg.name);}]});}else{downloadItem(sURL,true);}
break;case"mp3":if(gui.audio){var sURL=arg['url']?arg['url']:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':this._fullpath(arg['id'])});aMenu.push({"title":'-'},{"title":'ATTACHMENT::PLAY_SOUND',arg:[function(){gui.audio._value(sURL,arg.name);}]});}
break;}}
sPrimaryAccountCHAT&&aMenu.push({title:'ATTACHMENT::SAVE_TO_TEAMCHAT',arg:[function(arg){function __uploadhandler(aTo,aBuffer,sName,sDesc,aArg){if(aBuffer&&aBuffer.length){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNCLASS='F';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();if(aBuffer.length==1){aItemInfo['values']['EVNRID']=aItemInfo['values']['EVNLOCATION']=aItemInfo['values']['EVNTITLE']=sName||aBuffer[0].name;aItemInfo['values']['EVNCOMPLETE']=aBuffer[0].size;if(Is.String(sDesc)&&sDesc.length){aItemInfo['values']['EVNNOTE']=sDesc;aItemInfo['values']['EVNDESCFORMAT']='text/plain';}}
for(var i=0,j=aBuffer.length;i<j;i++){aItemInfo['ATTACHMENTS'].push({values:aBuffer[i]});}
WMItems.add(aTo,aItemInfo,'','','',[function(bOK,aData){if(bOK){gui.notifier._value({type:'message_sent_tch',args:[dataSet.get('folders',aTo).NAME||dataSet.get('folders',aTo).RELATIVE_PATH||'']});}else{if(aData==='item_create'){aData='ALERTS::FOLDER_INSUFFICIENT_RIGHTS';}else{aData='ERROR::'+aData;}
gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text:aData}});}}]);}};var sFolder;var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE==='I'){sFolder=id;break;}}
if(sFolder){gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){var __upload_buffer=[{'class':'attachment','description':(arg.name||'').replace(/[<>:\/\\|?*""\[\]]/g,''),'size':arg.size,'fullpath':me._fullpath(arg['id'])}];gui._create('chat_upload','frm_chat_upload','','',__upload_buffer[0].description,'',{aid:aid,fid:fid},[function(sName,sDesc,aArg){__uploadhandler([aid,fid],__upload_buffer,sName,sDesc,aArg);}]);}],true,true,['Y','I'],'',true);}},[arg]]});}
cmenu._fill(aMenu);if(srcElm.tagName!='A')
srcElm=Is.Child(srcElm,'A');var pos=getSize(srcElm);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);}
else
if(arg.type&&arg.type.toLowerCase().indexOf('message/rfc822')===0){var pos,sID;if((pos=this._iid.lastIndexOf('|'))>-1&&(WMFolders.getType([this._aid,this._fid])=='M'||(this._iid.match(/\|/g)||[]).length>1))
sID=this._iid.substr(0,pos+1)+arg.id;else
sID=this._iid+'|'+arg.id;this._open(this._aid,this._fid,sID);}
else
if(arg.type=='all')
this._saveAll(this._fullpath());else
if(arg.type=='certificate')
this._open_cert(arg);else
if(dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])==="true"&&(GWOthers.getItem('DOCUMENTS','disable_office')||0)!=1&&Item.officeSupport(arg.url||arg.name)&&(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('f')==-1){this._openOffice(arg);}
else
if(Path.extension(arg.name)=='pdf'&&GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')!=1&&!currentBrowser().match(/^MSIE([6-9]|10)$/)){var sURL=arg['url']?arg['url']:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':this._fullpath(arg['id'])});gui._create('pdf','frm_pdf')._load(sURL,arg.name);}
else
if(arg['url']){downloadItem(arg['url'],true);}
else{this._save(this._fullpath(arg['id']));}};_me._fullpath=function(attId){return this._aid+'/'+this._fid+'/'+WMItems.__serverID(this._iid)+(Is.Defined(attId)?'/'+attId:'');};_me._open_cert=function(arg){if(arg&&arg.cert&&arg.cert.INFO)
gui._create('certificate','frm_certificate','','',arg.cert.INFO[0]);};_me._open=function(aid,fid,iid){OldMessage.openwindow([aid,fid,iid]);};_me._import=function(aid,fid,iid){WMItems.action({aid:aid,fid:fid,iid:iid},'importattachment',[this,'_openImport']);};_me._openImport=function(bOK,xResponse){if(bOK){var aValues=WMItems.parse(xResponse);for(var aid in aValues)
for(var fid in aValues[aid]){delete aValues[aid][fid]['/'];delete aValues[aid][fid]['#'];delete aValues[aid][fid]['$'];delete aValues[aid][fid]['@'];for(var iid in aValues[aid][fid]){aValues=aValues[aid][fid][iid];var frm=Item.openwindow([aid,fid,iid],aValues);frm._userEdited=function(){return true;};frm.__removeItem=function(ids){if(!frm.__stored)
Item.remove([aid,fid,[iid]],true);};frm._add_destructor('__removeItem');}}}
else{try{if(xResponse.IQ[0].ERROR[0].ATTRIBUTES.UID=='item_invalid_type'){gui.notifier._value({type:'alert',args:{header:'ATTACHMENT::IMPORT',text:'ATTACHMENT::IMPORT_ERROR'}});return;}}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
gui.notifier._value({type:'alert',args:{header:'ATTACHMENT::IMPORT',text:'ATTACHMENT::IMPORT_ERROR'}});}};_me._save_cert=function(sFullPath){var aUrl={'sid':dataSet.get('main',['sid']),'class':'email_certificate','fullpath':sFullPath};downloadItem(buildURL(aUrl));};_me._save=function(sFullPath){var aUrl={'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath};downloadItem(buildURL(aUrl));};_me._saveAll=function(sFullPath){var aUrl={'sid':dataSet.get('main',['sid']),'class':'allattachments','fullpath':sFullPath};downloadItem(buildURL(aUrl));};_me._openOffice=function(arg){WMItems.list({aid:sPrimaryAccount,fid:Mapping.getDefaultFolderForGWType('F'),filter:{search:'partid:"'+WMItems.__serverID(this._iid)+'/'+arg.id+'"'}},'','','',[function(aData){if((aData=aData[sPrimaryAccount])&&(aData=aData[Mapping.getDefaultFolderForGWType('F')])&&aData['@'].COUNT=='1'){for(var iid in aData){if(iid.length>1){this.__openOffice(WMItems.__serverID(iid),arg);return;}}}
this.__saveFolder(sPrimaryAccount,Mapping.getDefaultFolderForGWType('F'),[{'name':arg.name,'size':arg.size,'fullpath':this._fullpath(arg.id),}],{success:function(result){this.__openOffice(result.id,objConcat(arg,{name:result.name}));},context:this});}.bind(this)]);};_me.__openOffice=function(file_id,arg){var iid=[sPrimaryAccount,Mapping.getDefaultFolderForGWType('F'),file_id];Item.officeOpen({aid:iid[0],fid:iid[1],iid:iid[2],'EVNTITLE':arg.name},[downloadItem,iid],Path.extension(arg.name),~['I','Y'].indexOf(dataSet.get('folders',[this._aid,this._fid,'TYPE']))&&'view',{success:function(final_cb){var frm=gui._create('send_back','frm_confirm','','',[function(){var messages=OldMessage.reply([this._aid,this._fid,this._iid],false,false,true),newMessage=messages[0];newMessage.aAttachments=newMessage.aAttachments||{};newMessage.aAttachments.attachments=newMessage.aAttachments.attachments||[];newMessage.aAttachments.attachments.push({values:{'class':'item',fullpath:iid[0]+'/'+iid[1]+'/'+iid[2],name:arg.name,size:arg.size}});gui._create('frm_compose','frm_compose','','',newMessage,messages[1]);frm._destruct();}.bind(this)],'COMPOSE::MODIFIED_FILE_TITLE','COMPOSE::MODIFIED_FILE_HELPER');frm.x_btn_ok._disabled(true);removecss(frm.x_btn_ok._main,'ok');addcss(frm.x_btn_ok._main,'ico loading');final_cb.success=function(){clearTimeout(timeout);if(frm&&frm.x_btn_ok){frm.x_btn_ok._disabled(false);removecss(frm.x_btn_ok._main,'ico');}};final_cb.error=function(){clearTimeout(timeout);if(frm&&frm.x_btn_ok){frm.x_btn_ok._disabled(true);addcss(frm.x_btn_ok._main,'ico');}};var timeout=setTimeout(function(){final_cb.success();},60000);frm._obeyEvent('ondestruct',[function(){final_cb=null;}]);},context:this});};_me._saveFolder=function(arg){gui._create('select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',sPrimaryAccount,Mapping.getDefaultFolderForGWType('F'),[this,'__saveFolder',[arg]],true,false,'F','i',true);};_me._saveFolderToAlfresco=function(arg){gui._create('select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER','@@alfresco@@',Alfresco.getLastFolder(),[this,'__saveFolder',[arg]],true,true,'K',false,true);};_me.__saveFolder=function(aid,fid,arg,callback){var now=new IcewarpDate(),att=[];for(var i in arg)
att.push({values:{'class':'attachment','description':arg[i].name,'size':arg[i].size,'fullpath':arg[i].fullpath}});WMItems.add([aid,fid],{values:{'EVNSHARETYPE':GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','file_sharing'),'EVNSTARTDATE':now.format(IcewarpDate.JULIAN),'EVNSTARTTIME':now.format(IcewarpDate.JULIAN_TIME)},duplicity:'rename',ATTACHMENTS:att},'','','',[function(bOK,result){if(bOK&&result&&result.id){callback&&callback.success&&callback.success.call(callback.context||this,result);if(gui.notifier)
gui.notifier._value({type:'item_saved',args:[aid,fid]});var aItems=dataSet.get('items');for(var sAccId in aItems)
for(var sFolId in aItems[sAccId])
break;if(aid==sAccId&&fid==sFolId)
try{gui.frm_main.main.list._serverSort({aid:aid,fid:fid});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}}]);};

/* client/inc/obj_attach_multiple.js */
_me=obj_attach_multiple.prototype;function obj_attach_multiple(){};_me.__constructor=function(sButtonValue){var me=this;this.__settings={post_params:{sid:dataSet.get('main',['sid']),swf:1},queue_limit:0};this.__drop_files=[];this.__eIN=this._getAnchor('file');this.__init();this.__eButton=this._getAnchor('button');if(sButtonValue)
this.__eButton.value=getLang(sButtonValue);else
this.__eButton.title=getLang('ATTACHMENT::UPLOAD');this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(!me.__disabled&&elm!=me.__eIN)
me.__eIN.click();};};_me.__init=function(bRedraw){if(bRedraw){var elm=mkElement('input',{'type':'file','id':this.__eIN.id,'className':this.__eIN.className,'accept':this.__eIN.accept});if(Is.Defined(this.__eIN.getAttribute('multiple')))
elm.setAttribute('multiple','');elm.disabled=this.__disabled;this.__eIN.parentNode.replaceChild(elm,this.__eIN);this.__eIN=elm;}
var me=this;this.__eIN.addEventListener("change",function(e){if(e.target.files.length&&me.__ondropfile)
me.__ondropfile(e.target.files);},false);};_me.__initFile=function(bDisabled){this.__eButton.disabled=bDisabled?true:false;};_me._setPostParam=function(sName,sVal){if(this.__settings&&Is.Defined(sName)){if(Is.Defined(sVal))
this.__settings.post_params[sName]=sVal;else
delete this.__settings.post_params[sName];}};_me._setFolder=function(sFolder){this._setPostParam('folder',sFolder);};_me._getFolder=function(){return this.__settings.post_params['folder'];};_me._setFileQueueLimit=function(i){this.__settings.queue_limit=Is.Number(i)?i:0;};_me._setMultipleSelection=function(b){if(b)
this.__eIN.setAttribute('multiple','');else
this.__eIN.removeAttribute('multiple','');};_me._setFileTypes=function(sTypes){if(sTypes)
this.__eIN.setAttribute('accept',sTypes);else
this.__eIN.removeAttribute('accept');};_me.__ondropfile=function(files,aHandler){if(files.length&&files[0]){var f,q=files.length;if((f=this.__drop_files.length)){if(this.__settings.queue_limit>0&&q+f>this.__settings.queue_limit)
q+=f-this.__settings.queue_limit;}
else
if(this.__settings.queue_limit>0&&q>this.__settings.queue_limit)
q=this.__settings.queue_limit;for(var i=0;i<q;i++)
if(files[i].size>0)
this.__drop_files.push(files[i]);else
gui.notifier._value({type:'alert',args:{text:'NOTIFICATION::EMPTY_FILE'}});if(!f&&this.__drop_files.length){if(this._onuploadstart)
this._onuploadstart();this.__exeEvent('onuploadstart',null,{"owner":this});this.__handleFile(aHandler);}}};_me.__handleFile=function(aHandler){if(sPrimaryAccountULIMIT&&this.__drop_files.length){var maxsize=sPrimaryAccountULIMIT*1048576;for(var i=this.__drop_files.length;i--;)
if(maxsize<this.__drop_files[i].size){gui.notifier._value({type:'alert',args:{header:'ATTACHMENT::UPLOAD',text:'UPLOAD::ERROR1',args:[sPrimaryAccountULIMIT]}});this.__drop_files.splice(i,1);}}
var file=this.__drop_files[0];if(!file){this.__init(true);if(this._onuploadend)
this._onuploadend();this.__exeEvent('onuploadend',null,{"owner":this});return;}
var xhr=new XMLHttpRequest();xhr.open("POST","server/upload.php",true);if(window.FormData){var fd=new FormData();if(this._getFolder())
fd.append("folder",this._getFolder());for(var sParam in this.__settings.post_params)
fd.append(sParam,this.__settings.post_params[sParam]);fd.append("file",file);}
var me=this;xhr.upload.addEventListener("progress",function(evn){if(me._onuploadprogress&&evn.lengthComputable)
me._onuploadprogress(file,evn.loaded,file.size,xhr);me.__exeEvent('onuploadprogress',null,{"owner":me});},false);xhr.upload.addEventListener("abort",function(evn){var file=me.__drop_files.shift();if(me._onuploadaborted)
me._onuploadaborted(file);me.__exeEvent('onuploadaborted',null,{"owner":me});me.__handleFile(aHandler);},false);xhr.upload.addEventListener("error",function(evn){me.__drop_files=[];me.__handleFile(aHandler);},false);xhr.onreadystatechange=function(){if(this.readyState==4){if((this.status>=200&&this.status<=200)||this.status==304){if(this.responseText!=""){if(this.getResponseHeader("Content-Type").split(';')[0]=='text/json'){var aResponse=JSON.parse(this.responseText);me._setFolder(aResponse.folder);var out={folder:aResponse.folder,id:aResponse.id,name:file.name.replace(/[\/\\:?"<>|~*]/g,'_'),size:file.size};if(aHandler)
executeCallbackFunction(aHandler,aResponse,me.__drop_files.shift(),out);else
me.__drop_files.shift();if(me._onuploadsuccess)
me._onuploadsuccess(out);me.__exeEvent('onuploadsuccess',null,{"owner":me});me.__handleFile(aHandler);}
else{me.__drop_files=[];me.__handleFile(aHandler);var s,pos=this.responseText.indexOf(':');if(pos>-1){var i=parseInt(this.responseText.substr(pos+2),10);if(!Is.Number(i)||!(s=getLang('UPLOAD::ERROR'+i,'',true)))
s=this.responseText;}
else
s=this.responseText;gui.notifier._value({type:'alert',args:{header:'',text_plain:s}});}}}}};xhr.send(fd);};_me._disabled=function(b){if(Is.Defined(b)){this.__disabled=b?true:false;this.__eButton.disabled=this.__disabled;window[b?'addcss':'removecss'](this._main,'disabled');if(this.__eIN)
this.__eIN.disabled=this.__disabled;}
return this.__disabled;};

/* client/inc/obj_attach_old.js */
_me=obj_attach_old.prototype;function obj_attach_old(){};_me.__constructor=function(sButtonValue){this._main.setAttribute('enctype',"multipart/form-data");this._main.setAttribute('method',"post");this._main.setAttribute('action',"server/upload.php");this._main.setAttribute('target',this._pathName+'#frame');this.__idtable=[];this.__settings={post_params:{sid:dataSet.get('main',['sid']),obj:this._pathName}};this.__eFrame=this._getAnchor('frame');if(this.__eFrame.contentWindow.stop)
this.__eFrame.contentWindow.stop();else{var doc=this.__eFrame.contentDocument;if(typeof doc=='undefined'||doc==null)
doc=this.__eFrame.contentWindow.document;doc.execCommand('Stop');doc=null;}
this._setPostParam();this.__initFile();if(sButtonValue)
this._getAnchor('button').value=getLang(sButtonValue);else
this.__eIN.title=getLang('ATTACHMENT::UPLOAD');};_me._disabled=function(b){if(Is.Defined(b)){this.__disabled=b?true:false;if(this.__eIN)
this.__eIN.disabled=b;}
else
return this.__disabled;};_me.__initFile=function(bDisabled){var me=this;if(this.__eIN){this.__eIN.parentNode.removeChild(me.__eIN);this.__eIN=null;}
this.__eIN=mkElement('input',{type:'file',name:'file',className:'file',size:1,tabindex:1000,disabled:bDisabled?true:false});this.__eIN.disabled=this.__disabled;this.__eIN.onchange=function(){if(this.value){this.form.submit();if(me._onuploadstart)
me._onuploadstart(this.value);me.__initFile(1);}};this._getAnchor('file').appendChild(me.__eIN);};_me._setPostParam=function(name,value){if(name){if(typeof value=='undefined')
delete this.__settings.post_params[name];else
this.__settings.post_params[name]=value;}
var ePost=this._getAnchor('post');ePost.innerHTML='';for(var i in this.__settings.post_params)
ePost.appendChild(mkElement('input',{type:'hidden',name:i,value:this.__settings.post_params[i]}));};_me._add=function(aArg){aArg.folder=this.__settings.post_params.folder;this.__idtable.push(aArg);if(this.__eIN&&this.__eIN.disabled==true){this.__eIN.disabled=false;}
if(this._onuploadsuccess)
this._onuploadsuccess(aArg);if(this._onuploadend)
this._onuploadend();}
_me._setFolder=function(sFolder){if(sFolder)
this._setPostParam('folder',WMItems.__serverID(String(sFolder)));else
this._setPostParam('folder',Math.rand());};_me._getFolder=function(){return this.__settings.post_params['folder'];};

/* client/inc/obj_attendees.js */
_me=obj_attendees.prototype;function obj_attendees(){};_me.__constructor=function(sType,owner){var me=this,dialog_name,title_prefix;this.__owner=owner||sPrimaryAccount;this.__atts={};this.__new_count=0;this.__aDatagridRows=[];this.sType=sType;switch(this.sType){case'DISTRIB_LIST':this.grid.__sortType=0;this.grid._addColumns({'LCTDESCRIPTION':{"title":'DISTRIB_LIST::NAME',"width":'200',encode:true,'arg':{'sort':'asc'}},'LCTEMAIL1':{"title":'DISTRIB_LIST::EMAIL',"width":'200',encode:true,'arg':{'sort':'asc'}}});this.items=['LCTDESCRIPTION','LCTEMAIL1'];dialog_name='frm_edit_dl_member';title_prefix='DISTRIB_LIST';break;case'ATTENDEES':this.grid._addColumns({'CNTSTATUS':{'width':18,'arg':{'sort':'desc'},'css':'status',"type":'static',"text":'&nbsp;'},'CNTROLE':{'width':18,'arg':{'sort':'desc'},'css':'role',"type":'static',"text":'&nbsp;'},'CNTCONTACTNAME':{"title":'DISTRIB_LIST::NAME',"width":200,encode:true},'CNTEMAIL':{"title":'DISTRIB_LIST::EMAIL',"width":200,encode:true}});this.items=['CNTCONTACTNAME','CNTEMAIL','CNTROLE','CNTSTATUS'];dialog_name='frm_edit_attendee';title_prefix='ATTENDEES';this.grid._oncontext=function(e,elm,arg,id,cell){if(id&&(cell=='CNTROLE'||cell=='CNTSTATUS'||cell=='CNTCONTACTNAME')){var pos=getSize(elm);me.cmenu=gui._create('cmenu','obj_context','','obj_attendees_context');me.cmenu._place(pos.x+(cell=='CNTCONTACTNAME'?-20:0),pos.y+pos.h);var aMenu;if(cell=='CNTSTATUS')
aMenu=[{'title':'ATTENDEES::STATUS_P',css:'bg_status_P','arg':{'id':id,'key':'CNTSTATUS',value:''}},{'title':'ATTENDEES::STATUS_A',css:'bg_status_A','arg':{'id':id,'key':'CNTSTATUS',value:'A'}},{'title':'ATTENDEES::STATUS_D',css:'bg_status_D','arg':{'id':id,'key':'CNTSTATUS',value:'D'}}];else
aMenu=[{'title':'ATTENDEES::ROLE_Q',css:'bg_role_Q','arg':{'id':id,'key':'CNTROLE',value:'Q'}},{'title':'ATTENDEES::ROLE_S',css:'bg_role_S','arg':{'id':id,'key':'CNTROLE',value:'S'}},{'title':'ATTENDEES::ROLE_T',css:'bg_role_T','arg':{'id':id,'key':'CNTROLE',value:'T'}}];me.cmenu._fill(aMenu);me.cmenu._onclick=function(e,elm,id,arg){if(arg.id&&arg.key){var aValue=me.__getItemDetails(arg.id);if(aValue){aValue[arg.key]=arg.value;me.__onEdit(aValue,arg.id);}}};}
return false;};break;default:throw new Error('Not implemented');}
this.grid._ondblclick=function(){me.edit_button._onclick();};this.add_button._onclick=function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],undefined,undefined,undefined,undefined,true);};this.edit_button._onclick=function(){var items=me.grid._value();if(items&&Is.Defined(items[0]))
items=me.grid._aData[items[0]].id;else
return;me.grid._value([]);gui._create('edit_dialog','frm_edit_attendee','','',dialog_name,title_prefix+'::EDIT_TITLE',[me,'__onEdit'],me.__getItemDetails(items,true),items);};this.remove_button._onclick=function(){var out=[],items=me.grid._value();for(var i in items){out.push(me.grid._aData[items[i]].id);}
me.__removeItems(out);};};_me._value=function(aValues){if(this._destructed)return;if(Is.Defined(aValues)){this.__aDatagridRows=[];this.__atts={};var aData,css;for(var i in aValues){aData={},css='';for(var j in this.items){if(this.items[j]=='CNTSTATUS'&&aValues[i]['values'][this.items[j]])
css+=(css?' ':'')+"status_"+aValues[i]['values'][this.items[j]];else
if(this.items[j]=='CNTROLE'&&aValues[i]['values'][this.items[j]])
css+=(css?' ':'')+"role_"+aValues[i]['values'][this.items[j]];aData[this.items[j]]=aValues[i]['values'][this.items[j]];}
this.__aDatagridRows.push({"id":i,"data":aData,'css':css});this.__atts[i]={'action':'ignore','id':i};}
this.grid._fill(this.__aDatagridRows);}
else{var aResult=[];for(var i in this.__atts){switch(this.__atts[i]['action']){case'remove':aResult.push({'uid':this.__atts[i]['id']});break;case'edit':aResult.push({'uid':this.__atts[i]['id'],'values':this.__getItemDetails(i)});break;case'new':aResult.push({'values':this.__getItemDetails(i)});default:break;}}
return aResult;}};_me.__getItemDetails=function(nInd,bDatagridOnly)
{var aValues;for(var n in this.__aDatagridRows)
if(this.__aDatagridRows[n]['id']==nInd){aValues=this.__aDatagridRows[n]['data'];break;}
if(bDatagridOnly||this.sType!='DISTRIB_LIST')
return aValues;aValues['LCTTYPE']='O';return aValues;};_me.__removeItems=function(aIDs)
{for(var i in aIDs)
for(var n in this.__aDatagridRows)
if(this.__aDatagridRows[n]['id']==aIDs[i])
{this.__aDatagridRows.splice(n,1);this.__atts[aIDs[i]]['action']=this.__atts[aIDs[i]]['action']=='new'?'ignore':'remove';break;}
for(var i in this.grid._aData){if(-1!==aIDs.indexOf(this.grid._aData[i].id)){delete this.grid._aData[i];}}
this.grid._fill();};_me.__onEdit=function(aValues,sID)
{if(this._destructed)return;var itmId,aData={},css='';if(Is.Defined(sID)){itmId=sID;this.__atts[itmId]['action']=this.__atts[itmId]['action']=='new'?'new':'edit';}else{if(aValues.LCTEMAIL1)
for(var j in this.__aDatagridRows)
if(this.__aDatagridRows[j].data&&this.__aDatagridRows[j].data.LCTEMAIL1==aValues.LCTEMAIL1)
return;if(aValues.CNTEMAIL)
for(var j in this.__aDatagridRows)
if(this.__aDatagridRows[j].data&&this.__aDatagridRows[j].data.CNTEMAIL==aValues.CNTEMAIL)
return;itmId=this.__new_count++;this.__aDatagridRows.push({'id':itmId,'data':aValues});this.__atts[itmId]={'action':'new'};}
for(var i in this.items){if(this.items[i]=='CNTSTATUS'&&aValues[this.items[i]])
css+=(css?' ':'')+"status_"+aValues[this.items[i]];else
if(this.items[i]=='CNTROLE'&&aValues[this.items[i]])
css+=(css?' ':'')+"role_"+aValues[this.items[i]];aData[this.items[i]]=aValues[this.items[i]];}
for(var n in this.__aDatagridRows)
if(this.__aDatagridRows[n]['id']==itmId){this.__aDatagridRows[n]['data']=aData;this.__aDatagridRows[n]['css']=css;break;}
this.grid._fill(this.__aDatagridRows);};_me.__onAddNewFromAddressbook=function(bOK,aAddresses)
{if(bOK){var aEmail,itmId,count,aData;for(var i in aAddresses[0]){aEmail=MailAddress.splitEmailsAndNames(aAddresses[0][i]);var f=false;for(var j in this.__aDatagridRows)
if(this.__aDatagridRows[j].data&&(this.__aDatagridRows[j].data.LCTEMAIL1==aEmail[0].email||this.__aDatagridRows[j].data.CNTEMAIL==aEmail[0].email)){f=true;break;}
if(f)
continue;aData={};count=0;for(var j in this.items){if(count==0)
aData[this.items[j]]=aEmail[0]['name'];else
aData[this.items[j]]=aEmail[0]['email'];count++;if(count>1)
break;}
itmId=this.__new_count++;this.__aDatagridRows.push({'id':itmId,'data':aData});this.__atts[itmId]={'action':'new'};}
this.grid._fill(this.__aDatagridRows);}};

/* client/inc/obj_audio.js */
_me=obj_audio.prototype;function obj_audio(){};_me.__constructor=function(){this.__dockable=true;this.__closable=true;var me=this;this.__audio=mkElement('audio')||null;try{if(this.__audio&&this.__audio.canPlayType&&this.__audio.canPlayType('audio/mpeg;').replace(/no/,'')){this.__audio.loadedPercent=100;this.__audio.duration=0;this.__audio.skipTo=function(percent){if(percent>this.loadedPercent)return;this.currentTime=this.duration*(percent/100);};this.__audio.setVolume=function(percent){this.volume=percent;};}
else
this.__audio=null;}
catch(r){this.__audio=null;return;}
if(this.__audio){this.__audio.onplay=function(){this.__skip_playing=false;this.__skip_docking=false;me._dock();me._exe('play',{duration:this.duration,currentTime:this.currentTime});};this.__audio.onpause=function(){if(me._docked)
me._dock();me._exe('pause',{duration:this.duration,currentTime:this.currentTime});};this.__audio.oncanplay=function(){me._dock();me._exe('canplay');};this.__audio.oncanplaythrough=function(){if(this.__skip_playing||!this.src)
return;if(me._docked)
me._dock();this.loadedPercent=100;me._exe('canplaythrough');setTimeout(function(){me._play()},0);};this.__audio.ontimeupdate=function(){me._docktimer();me._exe('timerupdate',{duration:this.duration,currentTime:this.currentTime});};this.__audio.ondurationchange=function(){me._docktimer();me._exe('durationchange',{duration:this.duration,currentTime:this.currentTime});};this.__audio.onended=function(){if(me.__dockable){me._docked=false;var dock=me._mydock||gui._dock;if(dock)
dock._remove(me,true);}
me._exe('ended');this.removeAttribute('src');};this.__audio.onvolumechange=function(){};this.__audio.onseeked=function(){me._exe('seeked',{duration:this.duration,currentTime:this.currentTime});};}
else
console.log('No <audio> support');this._add_destructor('__destructor');};_me._value=function(src,sTitle,aHandler){if(this.__audio)
if(Is.Defined(src)){if(this.__audio.src){this._pause();this.__audio.onended();}
if(aHandler)
this._obeyEvent('player',aHandler,src);this.__audio.title=sTitle;if(src){this.__audio.setAttribute('autoplay',true);this.__audio.setAttribute('src',src);this.__audio.load();}}
else
return this.__audio.getAttribute('src')||'';return'';};_me._seek=function(i){if(this.__audio&&this.__audio.src)
this.__audio.skipTo(i||0);};_me._play=function(){if(this.__audio&&this.__audio.src)
this.__audio.play();};_me._pause=function(){if(this.__audio)
this.__audio.pause();};_me._playing=function(){return this.__audio&&this.__audio.paused==false;};_me._playpause=function(){if(this.__audio){if(this.__audio.paused)
this._play();else
this._pause();}};_me._exe=function(action,value){var src=this._value();if(this._events&&this._events['player'])
for(var j in this._events['player'])
if(!src||!this._events['player'][j][1]||this._events['player'][j][1]==src)
if(!this._events['player'][j]||!Is.Object(this._events['player'][j][0])||executeCallbackFunction(this._events['player'][j][0],{src:src,action:action,value:value})===false)
this._events['player'].splice(j,1);};_me._dock=function(){var dock=this._mydock||gui._dock;if(this.__audio&&!this.__audio.__skip_docking&&this.__dockable&&dock){var sTitle=this.__audio.title||getLang('AUDIO::PLAYER'),aCSS=[this._playing()?'pause':'play'];this._docked=true;this.__docktimer=dock._add(this,sTitle,aCSS.join(' '));this._docktimer();return true;}};_me._undock=function(){if(this.__dockable){if(this.__skipundock){this.__skipundock=false;this._docked=false;return true;}
if(this.__audio){this._playpause();this._dock();return false;}}};_me._docktimer=function(){if(this.__docktimer)
if(this.__docktimer.parentNode){var elm=this.__docktimer.getElementsByTagName('EM'),tim=this.__docktimer.getElementsByTagName('TIME');if(!elm||!(elm=elm[0])){elm=mkElement('EM');this.__docktimer.appendChild(elm);}
if(!tim||!(tim=tim[0])){tim=mkElement('TIME');this.__docktimer.appendChild(tim);}
elm.style.width=(this.__audio.duration>this.__audio.currentTime?Math.ceil(this.__audio.currentTime/(this.__audio.duration/100)):100)+'%';tim.innerHTML=IcewarpDate.unix(Math.ceil(this.__audio.currentTime)).format('mm:ss');}
else
this.__docktimer=null;};_me._close=function(){this.__skipundock=true;this.__audio.__skip_docking=true;this.__audio.__skip_playing=true;this._seek();this._pause();};_me.__destructor=function(){if(this.__audio){this._pause();this.__audio=null;}
return true;};

/* client/inc/obj_avatar.js */
_me=obj_avatar.prototype;function obj_avatar(){};_me.__constructor=function(v){this._imonly=false;this.__value={};this.__elm=mkElement('div');this._main.appendChild(this.__elm);var me=this;this.__elm.onclick=function(e){var e=e||window.event;me._menu();if(e.preventDefault)e.preventDefault();e.cancelBubble=true;return false;};this._listen('xmpp');if(v)
this._value(v);};_me._menu=function(){if(this.__value.email||this.__value.distributionList){var name=this.__value.name;var email=this.__value.email;if(!this.__value.name&&!~this.__value.email.indexOf('@')){name=this.__value.email;email='';}
var pos=getSize(this.__elm),cmenu=gui._create('cmenu','obj_context_link','','',name,email,'',{nomail:this._imonly,noadd:true,distibutionList:this.__value.distributionList},false,this._specificIds);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);}};_me.__specifyIds=function(v){this._specificIds=v;};_me._value=function(v){var contactId=false;if(Array.isArray(v)){contactId=v.pop();v=v[0];}
if(Is.Defined(v)){this.__value=MailAddress.splitEmailsAndNames(v)[0];if(contactId){if(gui.frm_main&&gui.frm_main.im&&gui.frm_main.im._is_active()){var stat=gui.frm_main.im._inRoster(this.__value.email)||'';if(stat)
this.__elm.className='status im_'+stat.escapeXML(true);}
return this.__elm.style.backgroundImage='url("'+getContactAvatarURL(contactId)+'")';}
if(this.__value.email){this.__elm.style.backgroundImage='url("'+getAvatarURL(this.__value.email)+'")';if(gui.frm_main&&gui.frm_main.im&&gui.frm_main.im._is_active()){var stat=gui.frm_main.im._inRoster(this.__value.email)||'';if(stat)
this.__elm.className='status im_'+stat.escapeXML(true);}}
else{this.__elm.style.backgroundImage='';this.__elm.className='';}
if(v.indexOf('@')===-1){this.__value.email=v;this.__value.distributionList=true;this.__value.name=v;}}};_me.__update=function(sName,aPath){if(sName=='xmpp'&&this.__value.email&&gui.frm_main.im){if(aPath&&aPath[0]=='roster'&&aPath[1]&&aPath[1]==this.__value.email&&aPath[2]=='show')
this.__elm.className='status im_'+gui.frm_main.im._inRoster(this.__value.email).escapeXML(true);else
if(!gui.frm_main.im._is_active())
this.__elm.className='';}};

/* client/inc/obj_barmenu.js */
_me=obj_barmenu.prototype;function obj_barmenu(){};_me.__constructor=function(){var me=this;this._main.onclick=this._main.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;var args=arguments;if(gui.frm_main.main&&gui.frm_main.main._uploading){gui._create('stop_upload','frm_confirm','','',[function(){gui.frm_main.main._uploading=false;me._main.onclick.apply(me,args);}],'ALERTS::ALERT','CONFIRMATION::STOPUPLOAD');return false;}
if(me._onclick)
me._onclick(e,elm);me.__exeEvent('click',e,{"elm":elm,owner:me});};};_me.__onDestroyChild=function(){this._checkSize();};_me._checkSize=function(){this._main.style.paddingTop=this._getAnchor('top').offsetHeight+'px';this._main.style.paddingBottom=this._getAnchor('bottom').offsetHeight+'px';};_me._value=function(v){if(v){for(var i in v){if(this[i]&&this[i]._open)
this[i]._open();}}else{var v={},aCH=this._getChildObjects();for(var i in aCH){if(aCH[i]._anchor=='middle')
continue;if(!aCH[i]._collapsed)
v[aCH[i]._name]=[1];}
return v;}};_me.__update=function(sName,aDPath){if(sName==this._listener&&aDPath==this._listenerPath)
this._value(dataSet.get(this._listener,this._listenerPath));};

/* client/inc/obj_barmenu_block.js */
_me=obj_barmenu_block.prototype;function obj_barmenu_block(){}
_me.__constructor=function(iSize){this.__size=0;this._collapsed=true;this._parent._getAnchor(this._anchor).style.display='block';if(this._anchor!='middle'){if(iSize)
this._size(iSize);else
this._parent._checkSize();}};_me._size=function(iSize){if(this._anchor!='middle'){this.__size=parseInt(iSize);if(this.__size=='0'){this._main.style.display='none';}
else{this._main.style.display='block';this._getAnchor('main').style.height=this.__size+'px';}
this._parent._checkSize();}};

/* client/inc/obj_barmenu_cell.js */
_me=obj_barmenu_cell.prototype;function obj_barmenu_cell(){}
_me.__constructor=function(iSize,sTitle,sText){var me=this;if(sTitle)
this._title(sTitle);else
this._text(sText);this._getAnchor('title').onclick=function(e){me._open(me._collapsed);};if(this._anchor!='middle'){if(this._parent._listener){var tmp=dataSet.get(this._parent._listener,this._parent._listenerPath);if(tmp&&tmp[this._name])
this._open(true);}}};_me._open=function(b){if(this._anchor=='middle')
return;this._collapsed=b?false:true;if(this._collapsed){removecss(this._main,'obj_barmenu_cell_open');if(this._parent._listener)
dataSet.remove(this._parent._listener,this._parent._listenerPath?[].concat(this._parent._listenerPath,[this._name]):[this._name],false,this._parent._pathName);}
else{addcss(this._main,'obj_barmenu_cell_open');if(this._parent._listener)
dataSet.add(this._parent._listener,this._parent._listenerPath?[].concat(this._parent._listenerPath,[this._name]):[this._name],[1],false,this._parent._pathName);}
this._parent._checkSize();};_me._title=function(sTitle){this._text(getLang(sTitle));};_me._text=function(sTitle){if(sTitle){this._getAnchor('title').innerHTML=sTitle;addcss(this._main,'obj_barmenu_cell_title');}
else
removecss(this._main,'obj_barmenu_cell_title');};

/* client/inc/obj_barmenu_favorites.js */
_me=obj_barmenu_favorites.prototype;function obj_barmenu_favorites(){};_me.__constructor=function(){var me=this;this.__maxcount=10;this.__aData=[];this.__body=this._getAnchor('main');this.__norefresh=0;this.__body.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='SPAN')
elm=elm.parentNode;if(elm.tagName=='DIV'&&elm.id){if(hascss(elm,'active')){var pos=getSize(elm),show_context_menu=false,clientX=pos.x;if(gui._rtl){show_context_menu=e.clientX-pos.x<30;}else{show_context_menu=pos.x+pos.w-e.clientX<30;clientX+=pos.w;}
if(show_context_menu){this.oncontextmenu({target:elm,clientX:clientX,clientY:pos.y+(pos.h/2)});e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;}}
var arg,id=elm.id.substr(me._pathName.length+1);if(!me.__aData[id]||!(arg=me.__aData[id].arg))return;var aFolder=dataSet.get('active_folder');gui.__exeEvent('folderSelected',Object.assign({ftype:WMFolders.getType(arg)},arg));if(aFolder!=arg['aid']+'/'+arg['fid']&&dataSet.get('folders',[arg.aid,arg.fid])){if(gui.frm_main.bar.tree.slide&&gui.frm_main.bar.tree.slide[1]&&gui.frm_main.bar.tree.slide[1].folders){gui.frm_main._selectView(arg,'',false,'',false,'',true);gui.frm_main.bar.tree.slide[1].folders._setActive(arg['aid']+'/'+arg['fid'],true);me._fill();}
else
gui.frm_main._selectView(arg);}}};this.__body.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='SPAN')
elm=elm.parentNode;if(elm.tagName=='DIV'&&elm.id){var id=elm.id.substr(me._pathName.length+1),arg=me.__aData[id].arg,sFolType=WMFolders.getType(arg),aRights=WMFolders.getRights(arg);var aMenu=[{'title':'FAVORITES::RENAME','arg':{aid:arg.aid,fid:arg.fid},'handler':[me,'__rename'],css:'ico2 edit_folder'},{'title':'FAVORITES::REMOVE','arg':{aid:arg.aid,fid:arg.fid},'handler':[me,'__remove'],css:'ico2 remove_folder'}];if(sFolType=='M'){var ds=dataSet.get('folders',[arg['aid'],arg['fid']]);aMenu.push({'title':'-'});if(ds.RSS){aMenu.push({'title':'POPUP_FOLDERS::CHANGE_CHANNEL','arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':'R','method':'change_channel'},'disabled':!aRights.modify,css:'ico2 manage_rss'},{'title':'-'});}
aMenu.push({'title':'MAIN_MENU::EMPTY_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'empty_folder'},'disabled':!WMFolders.getAccess(arg,'remove'),'css':'color2 ico2 empty_folder'});}
var cmenu=gui._create("cmenu","obj_context_folder",'','',me);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);}
return false;};this._add_destructor('__disobey_ds');this._listen('cookies',['favorites']);if(typeof dataSet.get('cookies',['favorites'])=='undefined'){var s,aData=[{title:getLang('COMMON_FOLDERS::INBOX'),arg:{aid:sPrimaryAccount,fid:'INBOX'}}],dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'';if(dgw.indexOf('c')<0&&(s=GWOthers.getItem('DEFAULT_FOLDERS','CONTACTS')))
aData.push({title:s.substring(s.lastIndexOf('/')+1),arg:{aid:sPrimaryAccount,fid:s.substring(sPrimaryAccount.length+1)}})
if(dgw.indexOf('e')<0&&(s=GWOthers.getItem('DEFAULT_FOLDERS','EVENTS')))
aData.push({title:s.substring(s.lastIndexOf('/')+1),arg:{aid:sPrimaryAccount,fid:s.substring(sPrimaryAccount.length+1)}})
if(dgw.indexOf('t')<0&&(s=GWOthers.getItem('DEFAULT_FOLDERS','TASKS')))
aData.push({title:s.substring(s.lastIndexOf('/')+1),arg:{aid:sPrimaryAccount,fid:s.substring(sPrimaryAccount.length+1)}})
dataSet.add('cookies',['favorites'],aData);this._open(true);}
dataSet.obey(this,'_listener1','folders',true);dataSet.obey(this,'_listener2','active_folder',true);this.__dndtimer='';this.___lastdragover;this.__body.onmousedown=function(e){if(me.__dndtimer)
window.clearTimeout(me.__dndtimer);var e=e||window.event;if(e.button>1)return;var elm=e.target||e.srcElement;if(elm.tagName=='SPAN')
elm=elm.parentNode;if(elm==this||elm.tagName!='DIV'||!elm.id)return;var id=elm.id.substring(me._pathName.length+1),x=e.clientX,y=e.clientY;me.__dndtimer=setTimeout(function(){me.__initdrag(id,x,y);},500);};this.__body.onmouseup=function(e){if(me.__dndtimer)
window.clearTimeout(me.__dndtimer);};if(gui.frm_main&&gui.frm_main.dnd)
gui.frm_main.dnd.registr_drop(this,['folder','favorite','virtual_folder','item']);};_me.__remove=function(x0,x1,x2,arg){var aData=dataSet.get(this._listener,this._listenerPath);for(var i=0;i<aData.length;i++)
if(aData[i].arg&&aData[i].arg.aid==arg.aid&&aData[i].arg.fid==arg.fid){aData.splice(i,1);dataSet.add(this._listener,this._listenerPath,aData,true);dataSet.update(this._listener,this._listenerPath);break;}};_me.__rename=function(x0,x1,x2,arg){var id;for(var i in this.__aData)
if(arg.aid==this.__aData[i].arg.aid&&arg.fid==this.__aData[i].arg.fid){id=i;break;}
if(typeof id!='undefined'){var me=this,elm;this._anchors.edit=this._pathName+"/"+id;if((elm=this._getAnchor('edit'))){elm.innerHTML='';addcss(elm,'edit');}
else
return;this.__norefresh=1;this._create('edit','obj_input','edit','obj_input_100');this.edit._value(this.__aData[id].title);this.edit._onsubmit=function(){me.__aData=dataSet.get(me._listener,me._listenerPath);var id=null;for(var i in me.__aData)
if(arg.aid==me.__aData[i].arg.aid&&arg.fid==me.__aData[i].arg.fid){id=i;break;}
if(id!==null){me.__aData[i].title=this._value();dataSet.add(me._listener,me._listenerPath,me.__aData,true);}
this._destruct();me._anchors.edit='';me.__norefresh=0;dataSet.update(me._listener,me._listenerPath);};this.edit._onblur=function(){this._destruct();me._anchors.edit='';me.__norefresh=0;me.__update(me._listener,me._listenerPath);};this.edit._onclose=this.edit._onblur;this.edit._focus(true);}};_me.__disobey_ds=function(){dataSet.disobey(this,'_listener1','folders');dataSet.disobey(this,'_listener2','active_folder');};_me._fill=function(aData){if(aData)this.__aData=aData;if(!Is.Array(this.__aData))return;var tmp1=dataSet.get('folders'),tmp2=dataSet.get('active_folder'),str='',sType,bOk=true,aDFolders=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES'],sSpamFolder=dataSet.get('main',['spam_path']),sArchivePath=dataSet.get('main',['archive_path']),sFid;for(var i=0;i<this.__aData.length;i++){if(!this.__aData[i]||!this.__aData[i].arg||!tmp1[this.__aData[i].arg.aid]||!tmp1[this.__aData[i].arg.aid][this.__aData[i].arg.fid]){this.__aData.splice(i,1);i--;bOk=false;}
else{sType=WMFolders.getType(this.__aData[i].arg);if(sType=='M'){if(sArchivePath&&(this.__aData[i].arg.aid+'/'+this.__aData[i].arg.fid).indexOf(sArchivePath+'/')==0)
sFid=(this.__aData[i].arg.aid+'/'+this.__aData[i].arg.fid).replace(sArchivePath+'/','');else
sFid=this.__aData[i].arg.fid;switch(this.__aData[i].arg.aid+'/'+sFid){case(sPrimaryAccount+'/INBOX'):sType='inbox';break;case aDFolders.trash:sType='trash';break;case aDFolders.sent:sType='sent';break;case aDFolders.drafts:sType='drafts';break;case sSpamFolder:sType='spam';break;default:if(sPrimaryAccount==this.__aData[i].arg.aid&&dataSet.get('folders',[this.__aData[i].arg.aid,this.__aData[i].arg.fid,'RSS']))
sType='R';}}
else
if(sType=='QL'&&this.__aData[i].arg.aid==sPrimaryAccount){if(this.__aData[i].arg.fid=='SPAM_QUEUE/Blacklist')
sType='black';else
if(this.__aData[i].arg.fid=='SPAM_QUEUE/Whitelist')
sType='white';}
str+='<div id="'+this._pathName+'/'+i+'" title="'+(this.__aData[i].arg.aid+'/'+this.__aData[i].arg.fid).escapeHTML().replace(/"/g,'&quot;')+'" class="folder_'+sType+(tmp2==this.__aData[i].arg.aid+'/'+this.__aData[i].arg.fid?' active':'')+(tmp1[this.__aData[i].arg.aid][this.__aData[i].arg.fid].RECENT>0?' recent':'')+'">'+this.__aData[i].title+' '+(tmp1[this.__aData[i].arg.aid][this.__aData[i].arg.fid].RECENT>0?'<span>'+tmp1[this.__aData[i].arg.aid][this.__aData[i].arg.fid].RECENT+'</span>':'')+'</div>';}}
this.__body.innerHTML=str;if(str)
this._size((this.__aData.length*this._item_height)+10);else
this._size(0);if(!bOk)
dataSet.add(this._listener,this._listenerPath,this.__aData,'',this._pathName);};_me.__update=function(sName,sDPath){if(this.__norefresh){this.__norefresh++;return;}
if(this._listener==sName)
this._fill(dataSet.get(this._listener,this._listenerPath));else
this._fill();};_me.__initdrag=function(id,x,y){if(this.__aData[id])
gui.frm_main.dnd.create_drag('<div class="drag_folder drag_folder_'+WMFolders.getType(this.__aData[id].arg)+'">'+this.__aData[id].title+'</div>',{type:'favorite',value:[this.__aData[id].arg]},x,y);};_me._active_dropzone=function(v){if(v)
this.__norefresh=1;else{this._ondragout();if(this.__norefresh>1){this.__norefresh=0;this.__update(this._listener,this._listenerPath);}
else
this.__norefresh=0;}};_me._ondragover=function(v){if((v.type=='folder'||v.type=='virtual_folder')&&this.__aData.length>=this.__maxcount)return false;var iScroll=this.__body.scrollTop,aElm=this.__body.getElementsByTagName('DIV'),size,tmp='';for(var i=0;i<aElm.length;i++){size=getSize(aElm[i]);if(v.y>=size.y-iScroll&&v.y<=size.y+this._item_height-iScroll){tmp=(v.y-size.y)>(this._item_height/2)?'b':'t';if(this.___lastdragover&&(this.___lastdragover!=aElm[i]||this.___lastdragpos!=tmp)){removecss(this.___lastdragover,v.type=='item'?'dragover_active':'dragover_'+this.___lastdragpos);this.___lastdragpos=this.___lastdragover=null;}
if(v.type=='item'){var id=aElm[i].id.substring(this._pathName.length+1),fav_type=WMFolders.getType(this.__aData[id].arg);if(!this.__aData[id]||(this.__aData[id].arg.aid==v.value[0].aid&&this.__aData[id].arg.fid==v.value[0].fid)||((fav_type=='M'||fav_type=='QL')&&WMFolders.getType(v.value[0])!='M'))
return false;}
if(!this.___lastdragpos){if(tmp=='b'&&aElm.length-1>i){this.___lastdragover=aElm[i+1];this.___lastdragpos='t';}
else{this.___lastdragover=aElm[i];this.___lastdragpos=tmp;}
addcss(this.___lastdragover,v.type=='item'?'dragover_active':'dragover_'+this.___lastdragpos);}
return true;}}
if(v.type!='item'){if(tmp===''&&aElm[0]){size=getSize(aElm[0]);if(v.y<size.y+iScroll){if(this.___lastdragover){if(this.___lastdragover!=aElm[0]||this.___lastdragpos!='t'){removecss(this.___lastdragover,'dragover_'+this.___lastdragpos);this.___lastdragover=aElm[0];this.___lastdragpos='t';addcss(aElm[0],'dragover_t');}}
else{this.___lastdragover=aElm[0];this.___lastdragpos='t';addcss(aElm[0],'dragover_t');}}}
return true;}
else
if(this.___lastdragover){removecss(this.___lastdragover,'dragover_active');this.___lastdragover='';this.___lastdragpos='';}
return false;};_me._ondragout=function(){if(this.___lastdragover)
removecss(this.___lastdragover,'dragover_'+this.___lastdragpos,'dragover_active');this.___lastdragover=null;this.___lastdragpos=null;};_me._ondrop=function(v){if(v.type=='item'){if(this.___lastdragover){var id=this.___lastdragover.id.substr(this._pathName.length+1);if(this.__aData[id]){Item.__convertToFolder(this.__aData[id].arg.aid,this.__aData[id].arg.fid,v);return;}}}
else
if(v.type=='favorite'||((v.type=='folder'||v.type=='virtual_folder')&&this.__aData.length<this.__maxcount)){var tmp,src_id;for(var i=0;i<this.__aData.length;i++)
if(this.__aData[i].arg.aid==v.value[0].aid&&this.__aData[i].arg.fid==v.value[0].fid)
if(v.type=='folder'||v.type=='virtual_folder')
return
else{src_id=i;break;}
var aData=clone(this.__aData,1);tmp={title:dataSet.get('folders',[v.value[0].aid,v.value[0].fid,'NAME'])||Path.basename(v.value[0].fid),arg:v.value[0]};if(this.___lastdragover){var id=this.___lastdragover.id.substr(this._pathName.length+1);if(this.___lastdragpos=='b')
id++;if(v.type=='favorite'){tmp=aData.splice(src_id,1)[0];if(id>src_id)
id--;else
if(id==src_id)
return;}
aData.splice(id,0,tmp);}
else
if(typeof src_id=='undefined')
aData.push(tmp);this.__norefresh=0;dataSet.add(this._listener,this._listenerPath,aData);}};

/* client/inc/obj_barmenu_list.js */
_me=obj_barmenu_list.prototype;function obj_barmenu_list(){};_me.__constructor=function(){var me=this;this.__body=this._getAnchor('main');this.__aData=[];this.__norefresh=0;this._dragType='obj_barmenu_list';this.__body.onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName=='DIV'&&elm.id){var id=elm.id.substr(me._pathName.length+1);if(!me.__aData[id])return;if(me._onclick)
me._onclick(me.__aData[id]);}};this.__body.oncontextmenu=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName=='DIV'&&elm.id){var id=elm.id.substr(me._pathName.length+1);if(me._oncontext)
me._oncontext(me.__aData[id]);}
return false;};this.__dndtimer='';this.___lastdragover;this.__body.onmousedown=function(e){if(me.__dndtimer)
window.clearTimeout(me.__dndtimer);var e=e||window.event;if(e.button>1)return;var elm=e.target||e.srcElement;if(elm==this||elm.tagName!='DIV'||!elm.id)return;var id=elm.id.substring(me._pathName.length+1),x=e.clientX,y=e.clientY;me.__dndtimer=setTimeout(function(){me.__initdrag(id,x,y);},500);};this.__body.onmouseup=function(e){if(me.__dndtimer)
window.clearTimeout(me.__dndtimer);};};_me._fill=function(aData){if(aData)this.__aData=aData;if(!Is.Array(this.__aData))return;var str='';for(var i=0;i<this.__aData.length;i++)
str+='<div id="'+this._pathName+'/'+i+'" title="'+this.__aData[i].title.escapeHTML().replace(/"/g,'&quot;')+(this.__aData[i].css?'" class="'+this.__aData[i].css+'"':'')+'>'+this.__aData[i].title+'</div>';this.__body.innerHTML=str;if(str)
this._size(this.__aData.length*this._item_height);else
this._size(0);};_me.__update=function(sName,sDPath){if(this.__norefresh){this.__norefresh++;return;}
if(this._listener==sName)
this._fill(dataSet.get(this._listener,this._listenerPath));else
this._fill();};_me.__initdrag=function(id,x,y){if(this.__aData[id])
gui.frm_main.dnd.create_drag('<div class="drag_barcell'+(this.__aData[id].css?' '+this.__aData[id].css:'')+'">'+this.__aData[id].title+'</div>',{type:this._dragType,value:[this.__aData[id].arg]},x,y);};_me._active_dropzone=function(v){if(v)
this.__norefresh=1;else{this._ondragout();if(this.__norefresh>1){if(this._listener){this.__norefresh=0;this.__update(this._listener,this._listenerPath);}}
else
this.__norefresh=0;}};_me._ondragover=function(v){if(this.__aData.length>=this.__maxcount)return false;var iScroll=this.__body.scrollTop,aElm=this.__body.getElementsByTagName('DIV'),size,tmp='';for(var i=0;i<aElm.length;i++){size=getSize(aElm[i]);if(v.y>=size.y-iScroll&&v.y<=size.y+this._item_height-iScroll){tmp=(size.y-v.y)>(this._item_height/2)?'b':'t';if(this.___lastdragover&&(this.___lastdragover!=aElm[i]||this.___lastdragpos!=tmp)){removecss(this.___lastdragover,'dragover_'+this.___lastdragpos);this.___lastdragpos=this.___lastdragover=null;}
if(!this.___lastdragpos){this.___lastdragover=aElm[i];this.___lastdragpos=tmp;addcss(aElm[i],'dragover_'+this.___lastdragpos);}}}
if(tmp===''&&aElm[0]){size=getSize(aElm[0]);if(v.y<size.y+iScroll){if(this.___lastdragover){if(this.___lastdragover!=aElm[0]||this.___lastdragpos!='t'){removecss(this.___lastdragover,'dragover_'+this.___lastdragpos);this.___lastdragover=aElm[0];this.___lastdragpos='t';addcss(aElm[0],'dragover_t');}}
else{this.___lastdragover=aElm[0];this.___lastdragpos='t';addcss(aElm[0],'dragover_t');}}}
return true;};_me._ondragout=function(){if(this.___lastdragover)
removecss(this.___lastdragover,'dragover_'+this.___lastdragpos);this.___lastdragover=null;this.___lastdragpos=null;};_me._ondrop=function(v){if(this.__maxcount&&this.__aData.length>=this.__maxcount)return false;for(var i=0;i<this.__aData.length;i++){}};

/* client/inc/obj_barmenu_recent.js */
_me=obj_barmenu_recent.prototype;function obj_barmenu_recent(){};_me.__constructor=function(){this.__maxcount=10;this.__aData=[];this.__body=this._getAnchor('main');this._add_destructor('__disobey_ds');dataSet.obey(this,'_listener','teamchat');dataSet.obey(this,'_listener2','active_folder');this.__body.onclick=this.__onClickHandler.bind(this);};_me.__onClickHandler=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName==='SPAN')
elm=elm.parentNode;if(elm.tagName==='DIV'&&elm.id){if(hascss(elm,'active')){var pos=getSize(elm);if(pos.x+pos.w-e.clientX<30){this.oncontextmenu({target:elm,clientX:pos.x+pos.w,clientY:pos.y+(pos.h/2)});e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;}}
var id=elm.id.substr(this._pathName.length+1);if(!this.__aData[id]){return;}
var arg={aid:sPrimaryAccount,fid:id};var aFolder=dataSet.get('active_folder');if(aFolder!==sPrimaryAccount+'/'+id&&dataSet.get('folders',[sPrimaryAccount,id])){gui.frm_main._selectView(arg);}}};_me.__disobey_ds=function(){dataSet.disobey(this,'_listener','teamchat');};_me._fill=function(aData){if(aData){this.__aData=aData;}
if(!Is.Object(this.__aData)){return;}
var items=[];for(var key in aData){if(!aData[key]){continue;}
items.push('<div id="'+this._pathName+'/'+key+'" title="'+(sPrimaryAccount+'/'+key).escapeHTML().replace(/"/g,'&quot;')+'" class="folder_'+'I'+(dataSet.get('active_folder')===sPrimaryAccount+'/'+key?' active':'')+(aData[key]>0?' recent':'')+'">'+key.split('/').pop()+' '+(aData[key]>0?'<span>'+aData[key]+'</span>':'')+'</div>');}
this.__body.innerHTML=items.join('\r\n');if(items.length){this._size((items.length*this._item_height)+15);}else{this._size(0);}};_me.__toggleHide=function(){if(WMFolders.getType(Path.split(dataSet.get('active_folder')))==='I'){this._main.style.display='block';}else{this._main.style.display='none';}};_me.__update=function(name,path){if(name===this._listener2){this.__toggleHide();return;}
if(this._listener===name){this._fill(dataSet.get(this._listener,this._listenerPath));}else{this._fill();}};

/* client/inc/obj_block.js */
_me=obj_block.prototype;function obj_block(){};_me._position=function(s){this._main.style.position=s;};_me._place=function(x,y,w,h){var css=this._main.style;if(x){css.left='auto';css.right='auto';x=x<0?10:x;if(x.toString().indexOf('%')>-1)
css.left=x;else if(x<0)
css.right=(x*-1)+'px';else
css.left=(x<0?10:x)+'px';}
setTimeout(function(){var max_x=(window.innerWidth-10-this._main.clientWidth);css.left=(x>max_x?max_x:x)+'px';;}.bind(this),5);if(y)
css.top=(y.toString().indexOf('%')>-1?y:y+'px');if(w)
css.width=(w.toString().indexOf('%')>-1?w:w+'px');if(h)
css.height=(h.toString().indexOf('%')>-1?h:h+'px');};_me._zIndex=function(i){this._add_destructor('__destructor');if(typeof i=='undefined')
i=maxZIndex.get();this._main.style.zIndex=i;this.__zindex=i;};_me._focus=function(){if(typeof this.__zindex!='undefined')
maxZIndex.remove(this.__zindex);this._zIndex();};_me.__destructor=function(){if(typeof this.__zindex!='undefined'){maxZIndex.remove(this.__zindex);this.__zindex=undefined;}};

/* client/inc/obj_block_ext.js */
_me=obj_block_ext.prototype;function obj_block_ext(){};_me.__constructor=function(eSkipClose){this._position('absolute');this._closeOnContext=true;this._zIndex();this._add_destructor('__destructClickEvn');this.__eSkipClose=eSkipClose||this._main;var me=this;this._main.onclick=function(e){var e=e||window.event;e.__source={obj:me,type:me._type,path:me._pathName};};gui._obeyEvent('click',[this,'__destruction']);};_me._arrow=function(sArrowType){if(sArrowType){if(!this.__eArrow){this.__eArrow=mkElement('div',{className:'arrow'});this._main.appendChild(this.__eArrow);}
this._main.setAttribute('iw-arrow',sArrowType);}
else
if(this.__eArrow){this.__eArrow.parentNode.removeChild(this.__eArrow);this.__eArrow=null;this._main.removeAttribute('iw-arrow');}};_me._place=function(x,y,w,h,sArrow){obj_block.prototype._place.call(this,x,y,w,h);this._arrow(sArrow);};_me.__destruction=function(e){if(e.button>1&&!this._closeOnContext)
return;if(e.__source&&(e.__source.skip||e.__source.path===this._pathName))
return;var elm=e.target||e.srcElement,aPaths=[],aChilds=this._getChildObjects();for(var i=0;i<aChilds.length;i++){if(aChilds[i]._pathName){if(e.__source&&e.__source.path){if(e.__source.path===aChilds[i]._pathName||e.__source.path.indexOf(aChilds[i]._pathName+'.')===0)
return;}
else
if(aChilds[i]._main&&elm&&Is.Child(elm,aChilds[i]._main))
return;aPaths.push(aChilds[i]._pathName);if(aChilds[i]._getChildObjects)
aChilds=aChilds.concat(aChilds[i]._getChildObjects());}}
if(!this.__eSkipClose||(this.__eSkipClose&&!Is.Child(e.target||e.srcElement,this.__eSkipClose)))
this._destruct();};_me.__destructClickEvn=function(){gui._disobeyEvent('click',[this,'__destruction']);};

/* client/inc/obj_block_tab.js */
_me=obj_block_tab.prototype;function obj_block_tab(){};_me.__constructor=function(){this.__tabIndexes={};this.__lastFocus='';};_me.__addTabIndex=function(obj,sContainer,i){sContainer=sContainer||'main';if(!this.__tabIndexes[sContainer])
this.__tabIndexes[sContainer]=[];if(typeof i!='undefined'&&this.__tabIndexes[sContainer].length)
this.__tabIndexes[sContainer].splice(i,0,obj._pathName);else
this.__tabIndexes[sContainer].push(obj._pathName);return true;};_me.__removeTabIndex=function(obj){var i,j;for(i in this.__tabIndexes)
if((j=inArray(this.__tabIndexes[i],obj._pathName))>-1)
this.__tabIndexes[i].splice(j,1);};_me._tabIndexPrev=function(obj,bReturn){var i,j=-1;for(i in this.__tabIndexes)
if((j=inArray(this.__tabIndexes[i],obj._pathName))>-1)
break;if(j>-1){j--;if(j<0)
j=this.__tabIndexes[i].length-1;if(j>-1)
try{var tmp=window;this.__tabIndexes[i][j].split('.').forEach(function(part){tmp=tmp[part];});if(tmp._focus)
if(tmp._disabled&&tmp._disabled())
this._tabIndexPrev(tmp,bReturn);else
if(bReturn)
return tmp;else{if(tmp._focus(true)===false)
return this._tabIndexPrev(tmp,bReturn);else
if(tmp._setRange&&tmp._value){var v=tmp._value();if(Is.String(v))
tmp._setRange(0,tmp._value().length);}}
return true;}
catch(e){this.__tabIndexes[i].splice(j,1);if(this.__tabIndexes[i].length)
return this._tabIndexPrev(obj,bReturn);}}};_me._tabIndexNext=function(obj,bReturn){var i,j=-1;for(i in this.__tabIndexes)
if((j=inArray(this.__tabIndexes[i],obj._pathName))>-1)
break;if(j>-1){j++;if(j>this.__tabIndexes[i].length-1)
j=0;try{var tmp=window;this.__tabIndexes[i][j].split('.').forEach(function(part){tmp=tmp[part];});if(tmp._focus)
if(tmp._disabled&&tmp._disabled())
this._tabIndexNext(tmp,bReturn);else
if(bReturn)
return tmp;else{if(tmp._focus(true)===false)
return this._tabIndexNext(tmp,bReturn);else
if(tmp._setRange&&tmp._value){var v=tmp._value();if(Is.String(v))
tmp._setRange(0,tmp._value().length);}}
return true;}
catch(r){console.warn(r);this.__tabIndexes[i].splice(j,1);if(this.__tabIndexes[i].length)
return this._tabIndexNext(obj,bReturn);}}};

/* client/inc/obj_bubble.js */
_me=obj_bubble.prototype;function obj_bubble(){};_me.__constructor=function(){this.__timer=null;this.__state='hidden';this.__aPos={};this.__modal=false;this._add_destructor('_destructor');this._main.onmouseover=function(e){if(!this._onshow||this._onshow(e)!==false)
this._show();}.bind(this);this._main.onmouseout=function(e){if(!this.__modal)
if(!Is.Child(e.relatedTarget,this))
if(!this._onhide||this._onhide(e)!==false)
this._hide();}.bind(this);this._main.style.zIndex=this.__zindex=maxZIndex.get()+1000;};_me._modal=function(b){if(b&&!this.__modaldiv){maxZIndex.remove(this.__zindex);this._main.style.zIndex=this.__zindex=maxZIndex.get()+1000;this.__modal=true;this.__modaldiv=mkElement("div",{className:'obj_bubble_modaldiv'});this.__modaldiv.style.zIndex=parseInt(this.__zindex)-1;this.__modaldiv.onclick=function(e){if(this._onclose)
this._onclose(e);}.bind(this);this._main.parentNode.insertBefore(this.__modaldiv,this._main);}
else
if(!b&&this.__modaldiv){if(this.__modaldiv.parentNode)
this.__modaldiv.parentNode.removeChild(this.__modaldiv);this.__modaldiv=null;}};_me._place=function(aPos){this.__aPos=aPos;if(this.__state=='visible'){this._main.style.left=aPos.left||'';this._main.style.right=aPos.right||'';this._main.style.top=aPos.top||'';this._main.style.bottom=aPos.bottom||'';}};_me._hide=function(bForce){if(this.__timer)
clearTimeout(this.__timer);if(bForce){this._main.style.left='';this._main.style.right='';this._main.style.top='';this._main.style.bottom='';removecss(this._main,'show');this.__state='hidden';this.__modal&&this._modal(false);if(this._onstate)
this._onstate(this.__state);}
else
this.__timer=setTimeout(function(){if(this&&!this._destructed)
this._hide(true);}.bind(this),400);};_me._show=function(){if(this.__timer)
clearTimeout(this.__timer);this._main.style.left=this.__aPos.left||'';this._main.style.right=this.__aPos.right||'';this._main.style.top=this.__aPos.top||'';this._main.style.bottom=this.__aPos.bottom||'';addcss(this._main,'show');this.__state='visible';this.__modal&&this._modal(true);if(this._onstate)
this._onstate(this.__state);};_me._destructor=function(){if(this.__timer)
clearTimeout(this.__timer);if(this.__modaldiv)
this._modal(false);};

/* client/inc/obj_button_check.js */
_me=obj_button_check.prototype;function obj_button_check(){};_me.__constructor=function(){var me=this;this.__checked=false;this.__eIN.onclick=this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(this==elm){if(!me._disabled()){if(elm==me._main)
me._focus();me._checked(!me._checked());if(me._onclick)
me._onclick(e);}
return false;}};AttachEvent(this.__eIN,'onkeydown',function(e){var e=e||window.event,elm=e.target||e.srcElement;if(this==elm&&!me._disabled()){if(me._onkeypress)
me._onkeypress(e);}});};_me._checked=function(v){if(Is.Defined(v)){if((this.__checked=v?true:false))
addcss(this._main,'active');else
removecss(this._main,'active');}
else
return this.__checked;};

/* client/inc/obj_button_map.js */
_me=obj_button_map.prototype;function obj_button_map(){};_me.__constructor=function(){this._title(getLang('FORM_BUTTONS::MAP_IT'));};_me._onclick=function(){var v=this._value();if(v)
this._showmap(v);};_me._value=function(data){if(typeof data=='undefined'){if(Is.String(this.__address))
return this.__address;else
if(Is.Object(this.__address))
return executeCallbackFunction(this.__address);return'';}
else
this.__address=data;};_me._showmap=function(v){gui._create('map','frm_gmap','','',v,this._callback_function);};

/* client/inc/obj_button_map_loc.js */
_me=obj_button_map_loc.prototype;function obj_button_map_loc(){};_me._onclick=function(){this._disabled(true);var tmp,v=this._value();if(v&&(tmp=MailAddress.splitEmailsAndNames(v))&&(tmp=tmp[0])&&(tmp=tmp.email)&&tmp.indexOf('@')>-1){var resources_path=dataSet.get('main',['resources_path']);if(resources_path){var aItemsInfo={aid:sPrimaryAccount,fid:resources_path,filter:{sort:'ITMCLASSIFYAS',search:'category:Room AND email:"'+tmp.replace(/\"/g,"\\\"")+'"'},values:['ITMCLASSIFYAS','LCTEMAIL1']};WMItems.list(aItemsInfo,'','','',[this,'__step1']);return;}}
else
if(v){if(Is.URL(v)||(v.toLowerCase().indexOf('www.')===0&&(v='http://'+v))){var win=window.open(v,'_blank');win.focus();}
else{var match=v.replace(//g,'').match(/([NEWS])\s+(\d)+(?:\s+(\d)+(?:\.(\d)+)?)?/g);if(match&&!(match.length%2)){var lat=this.__DMToDMS(match[0].split(' '));var lon=this.__DMToDMS(match[1].split(' '));if(lat&&lon){v=lat+', '+lon;}}
this._showmap(v);}}
this._disabled(false);};_me.__DMToDMS=function(coord){var gps=0,dir;try{coord.filter(function(p){if(p.match(/\d+/)){return true;}
if(dir){throw'Unsupported format';}
dir=~['S','W'].indexOf(p)?'-':'';}).forEach(function(p,k){p=p*1;switch(k){case 0:return gps+=p;case 1:return gps+=p/60;case 2:gps+=p/60/60;default:throw'Unsupported format';}});return dir+gps;}catch(e){return null;}};_me.__step1=function(aData){if(aData)
for(var i in aData)
for(var j in aData[i]){delete aData[i][j]['/'];delete aData[i][j]['#'];delete aData[i][j]['$'];delete aData[i][j]['@'];for(var k in aData[i][j]){var aItemsInfo={aid:sPrimaryAccount,fid:dataSet.get('main',['resources_path']),iid:k};WMItems.list(aItemsInfo,'','','',[this,'__step2']);return;}}
this._disabled(false);};_me.__step2=function(aData){if(aData){var loc;for(var aid in aData)
for(var fid in aData[aid])
for(var iid in aData[aid][fid])
if((loc=aData[aid][fid][iid].LOCATIONS))
for(var lid in loc)
if(loc[lid].values&&loc[lid].values.LCTSTREET){var v=loc[lid].values,address=[v.LCTSTREET];if(v.LCTZIP||v.LCTCITY)
address.push((v.LCTZIP||'')+' '+(v.LCTCITY||'').trim());if(v.LCTSTATE)
address.push(v.LCTSTATE);if(v.LCTCOUNTRY)
address.push(v.LCTCOUNTRY);this._showmap(address.join(', '));break;}}
this._disabled(false);};

/* client/inc/obj_button_menu.js */
function obj_button_menu(){};obj_button_menu.prototype.__constructor=function(){this.__aMenu=[];this.__eArrow=mkElement('div',{className:'arrow'});this.__eArrow.onmousedown=function(e){if(this.cmenu&&!this.cmenu._destructed){if(e.stopPropagation)e.stopPropagation();return false;}}.bind(this);this.__eArrow.onclick=function(e){if(this._disabled())return;var e=e||window.event;if(!Is.Empty(this.__aMenu)&&(!this.cmenu||this.cmenu._destructed)){addcss(this._main,'active');this.cmenu=gui._create('cmenu','obj_context','',this.__sMenuCss||'obj_button_menu_external');this.cmenu._fill(Is.Function(this.__aMenu)?this.__aMenu():this.__aMenu);this.cmenu._obeyEvent('ondestruct',[function(){removecss(this._main,'active');}.bind(this)]);var pos=getSize(this.__eArrow);this.cmenu._place(pos.x+pos.w/2,pos.y+pos.h/2+5,null,2);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}}.bind(this);this._main.appendChild(this.__eArrow);};obj_button_menu.prototype._menu=function(aMenu,sCss){if(Is.Object(aMenu)){this.__aMenu=aMenu;this.__sMenuCss=sCss;if(this.cmenu&&!this.cmenu._destructed){this.cmenu._destruct();this.__eArrow.onclick({});}}
else
return this.__aMenu;};

/* client/inc/obj_button_play.js */
_me=obj_button_play.prototype;function obj_button_play(){};_me.__constructor=function(){this.__media=[];this._disabled(true);this._add_destructor('__destructor');};_me._src=function(sSrc,sTitle){if(Is.String(sSrc)){this.__media=sSrc;if(sTitle)
this._title(sTitle);this._disabled(false);gui.audio._obeyEvent('player',[this,'__update'],this.__media);}};_me._seek=function(iPercent){if(this.__check())
gui.audio._seek(iPercent);};_me._pause=function(){if(this.__check())
gui.audio._pause();};_me._play=function(){if(this.__check())
gui.audio._play();};_me._onclick=function(){if(this.__media){if(this.__check())
gui.audio._playpause();else
gui.audio._value(this.__media,(this._title()||getLang('AUDIO::PLAYER')));}};_me.__check=function(){return gui.audio._value()==this.__media;};_me.__update=function(aData){if(aData){if(aData.src!=this.__media)
aData.action='ended';switch(aData.action){case'play':addcss(this._main,'pause');break;case'ended':case'pause':removecss(this._main,'pause');break;}
if(this._onupdate)
this._onupdate(aData);}};_me.__destructor=function(){if(this.__media)
gui.audio._disobeyEvent('player',[this,'__update']);};

/* client/inc/obj_button_recent.js */
function obj_button_recent(){}
obj_button_recent.prototype.__constructor=function(){var unread=this._getRoomsWithUnreadCount();var aFill=['CHAT::ALL','CHAT::RECENT','CHAT::UNSUBSCRIBED'];this._fill(aFill);this._obeyEvent('onchange',[this,'__onChange']);this._main.querySelector('.button[iw-id="2"]').appendChild(mkElement('div',{class:"badge "+(!unread?'empty':''),text:unread}));this._listen('folders');dataSet.on('cookies',['recent'],this.__onUpdate,this);this._add_destructor('__removeListeners');};obj_button_recent.prototype.__removeListeners=function(){dataSet.off('cookies',['recent'],this.__onUpdate);};obj_button_recent.prototype.__onChange=function(e,arg){var value=arg.value;Cookie.set(['active_groupchat_view'],value);if((gui.frm_main.bar.tree.add_container||{}).btn_add)
gui.frm_main.bar.tree.add_container.btn_add._disabled(value==3);gui.frm_main.bar.tree.slide._value(value);};obj_button_recent.prototype._getRoomsWithUnreadCount=function(){return(Object.keys(rooms=dataSet.get('folders',[sPrimaryAccount]))).filter(function(room_name){return rooms[room_name].TYPE==='I'&&~(dataSet.get('cookies',['recent'])||[]).indexOf(sPrimaryAccount+'/'+room_name)&&rooms[room_name].RECENT&&rooms[room_name].RECENT!=='0';}).length||0;};obj_button_recent.prototype.__onUpdate=function(aData,sName,aDPath){this.__update(sName,aDPath);};obj_button_recent.prototype.__update=function(sName,aDPath){if(sName==='cookies'||(aDPath&&Array.isArray(aDPath))){var unread=this._getRoomsWithUnreadCount(),badge=this._main.querySelector('.badge');if(badge){badge.firstChild.textContent=unread;badge.classList[unread?'remove':'add']('empty');}}};obj_button_recent.prototype.__unsubscribeRoom=function(row,arg,handler){if(arg.method==='unsubscribe'){var btn=this._getAnchor('buttons').querySelector('.button[iw-id="3"]');if(btn)
removecss(btn,'bounce');}
if(row){removecss(row,'active');row.style.transition='all 0.3s cubic-bezier(1, 0.01, 1, 0.01)';row.style.opacity=0;row.style.transform='translateY(-800px)';if(browserEvent('transitionend')){row.addEventListener(browserEvent('transitionend'),function(){if(arg.method==='unsubscribe')
this.__bounce();row.parentNode&&row.parentNode.removeChild(row);if(handler)
executeCallbackFunction(handler);}.bind(this));}else{setTimeout(function(){if(arg.method==='unsubscribe')
this.__bounce();row.parentNode&&row.parentNode.removeChild(row);if(handler)
executeCallbackFunction(handler);},0);}}
else
if(arg.method==='unsubscribe'){this.__bounce();}};obj_button_recent.prototype.__bounce=function(){var btn=this._getAnchor('buttons').querySelector('.button[iw-id="3"]');if(btn)
addcss(btn,'bounce');};

/* client/inc/obj_button_switch.js */
_me=obj_button_switch.prototype;function obj_button_switch(){}
_me.__constructor=function(){this.__value=0;this.__width=100;this._main.onclick=function(e){var e=e||window.event,elm=(e.target||e.srcElement).parentNode;if(hascss(elm,'button'))
this._value(elm.getAttribute('iw-id'));}.bind(this);};_me._value=function(v,bNoUpdate){if(Is.Defined(v)){v=+v;if(this.__value!=v&&!bNoUpdate){var btn=this._getAnchor('buttons').querySelectorAll('.button');if(this.__value>0&&btn[this.__value-1]){removecss(btn[this.__value-1],'active');}
this.__value=v||0;if(btn[v-1]){addcss(btn[v-1],'active');}
this.__updSlider();this._onchange&&this._onchange();this.__exeEvent('onchange',null,{"owner":this,value:this.__value});}}else{return this.__value;}};_me.__updSlider=function(){var sli=this._getAnchor('slider');sli.style[gui._rtl?'right':'left']=(this.__width*(this.__value-1))+'%';sli.style.width=this.__width+'%';};_me._fill=function(aButtons){if(Is.Array(aButtons)){var btn=this._getAnchor('buttons');btn.innerHTML='';var len=aButtons.length;this.__width=Math.round(10000/len)/100;var rest=100-(this.__width*(len-1));for(var i=0;i<len;i++){btn.appendChild(mkElement('div',{className:'button'+(this._value()===i+1?' active':''),'iw-id':i+1,style:{width:(i+1===len?rest:this.__width)+'%'}},null,[mkElement('div',{text:getLang(aButtons[i]),className:'label',})]));}
this.__updSlider();}};

/* client/inc/obj_calendar.js */
_me=obj_calendar.prototype;function obj_calendar(){};_me.__constructor=function(opt){var me=this;this.__timeout;this.__opt=opt||{};var aTemplateData={month_names:IcewarpDate.months().map(function(month,i){return{index:i,month:month};},this)};if(this.__opt.week){addcss(this._main,'week');aTemplateData.week=true;}
this._draw('obj_calendar','',aTemplateData);this.__eMain=this._getAnchor('main');this.__eMain.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.__opt.week&&elm.tagName=='SPAN'&&hascss(elm,'week')){var dDate=new IcewarpDate();dDate.week(parseInt(elm.textContent));}
else
if(elm.tagName!=='A'){return;}
else{var rel=hascss(elm,'last')?-1:(hascss(elm,'next')?1:0),id=me.__getId(elm.id),dDate=me.__getDate(id,rel);}
me._value(dDate);if(me._onclick){me._onclick(e,elm);}
me.__exeEvent('onclick',e,{"owner":me,"elm":elm,"date":dDate});};if(this.week){this.week._fillWeek=function(dDate){for(var aFill={},i=0,j=dDate.weeksInYear();i<=j;i++)
aFill[i]=i;this._fill(aFill);};this.week._onchange=function(){me._dDate.week(this._value());me.__draw();};}
this.month._onchange=function(){me._setDate('',this._value());return true;};this.year._onchange=function(){var date=new IcewarpDate();if(date.calendar_type===IcewarpDate.Calendars.HIJRI&&(this._value()<1356||this._value()>1500)){return true;}
this._value()&&(me._dDate.year()!==this._value())&&me._setDate(this._value());return true;};this.year._fillYear=function(v){for(var aFill={},i=v-25,j=v+25;i<=j;i++)
aFill[i]=i;this._fill(aFill);};this.year._onkeydown=function(e){if((e.keyCode>47&&e.keyCode<58)||(e.keyCode>95&&e.keyCode<106)){var v=me.year._value();if(!v&&!(e.keyCode===49||e.keyCode===50||e.keyCode===97||e.keyCode===98)){return false;}
if(e.keyCode!==37&&e.keyCode!==39){if(me.__timeout){window.clearTimeout(me.__timeout);}
me.__timeout=window.setTimeout(function(){try{me.__setYear();}catch(e){gui._REQUEST_VARS.debug&&console.log(me._name||false,e);}},300);}
if(v&&v.length===4&&(e.target.selectionStart===e.target.selectionEnd)){return false;}
return true;}
else
return e.keyCode===8||e.keyCode===46||e.keyCode===37||e.keyCode===39;};this.left1._onclick=function(){if(me._dDate.year()>1||me._dDate.month()>0){me._dDate.subtract(1,'month');me.__draw();}};this.right1._onclick=function(){me._dDate.add(1,'month');me.__draw();};this.today._onclick=function(){me._value(new IcewarpDate());};this.close._onclick=function(e){me._parent._destruct();};this._value(new IcewarpDate(),true);this._add_destructor('__destruct');};_me.__destruct=function(){if(this.__timeout)
window.clearTimeout(this.__timeout);};_me.__setYear=function(){var date=new IcewarpDate();this.year.__restrictions=[].slice.call(this.year.__restrictions);if(date.calendar_type===IcewarpDate.Calendars.HIJRI&&~!this.year.__restrictions.indexOf('<1500i')){this.year.__restrictions.push('<1500i');this.year.__restrictions.push('2');}
try{var year=parseInt(this.year._value());if(date.calendar_type!==IcewarpDate.Calendars.HIJRI||(year>1355&&year<1501)){this._setDate(year);}}catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}};_me._setDate=function(year,month){this._dDate.year(+(year||this._dDate.year())).month(+(month||this._dDate.month()));this.__draw();};_me._value=function(date,no_update){if(date){if(date instanceof IcewarpDate){this._dDate=date.clone();}else if(Is.Number(date)||(Is.String(date)&&!isNaN(parseInt(date)))){this._dDate=new IcewarpDate(date,{format:IcewarpDate.JULIAN});}else{this._dDate=new IcewarpDate(date);}
this._active=this._dDate.clone();this.__draw();if(!no_update){if(this._onchange)
this._onchange(this._dDate);this.__exeEvent('onchange',null,{"owner":this,"date":this._dDate});}}else{return this._active;}};_me.__update=function(sDataSet){if(this._listener_data==sDataSet)
this.__draw();if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')
this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me._fill=function(aData){return aData;};_me.__draw=function(){var data={"weeks":[],"days":[''].concat(IcewarpDate.weekdaysShort())};var today=new IcewarpDate();if(this._listener_data)
this._fill(dataSet.get(this._listener_data,this._listenerPath_data));if(this.week){this.week._fillWeek(this._dDate);this.week._value(this._dDate.week(),true);}
this.month._value(this._dDate.month(),true);this.year._fillYear(this._dDate.year());this.year._value(this._dDate.year(),true);var next_month=this._dDate.clone().add(1,'month').month();var end_day=this._dDate.clone().endOf('month').endOf('week').add(1,'day');if(end_day.month()!==next_month){end_day=this._dDate.clone().month(next_month).startOf('month').subtract(1,'day').endOf('week').add(1,'day');}
var start_day=this._dDate.clone().startOf('month').startOf('week');var week=[{week:start_day.isoWeekday()===1?start_day.week():start_day.clone().isoWeekday(8).week()}];while(!start_day.isSame(end_day,'day')){week.push({value:start_day.date(),label:new IcewarpNumber(start_day.date()).localize(),"class":(start_day.isAfter(this._dDate,'month')?'next ':(start_day.isBefore(this._dDate,'month')?'last ':''))+(start_day.isSame(today,'day')?'today ':'')+(start_day.isSame(this._active,'day')?'active':'')});start_day.add(1,'day');if(start_day.day()===IcewarpDate.firstDayOfWeek()){data.weeks.push(week.slice(0));week=[{week:start_day.isoWeekday()===1?start_day.week():start_day.clone().isoWeekday(8).week()}];}}
this._draw('obj_calendar_main','main',data);if(this.__opt.week){[].forEach.call(this.__eMain.querySelectorAll('span.week'),function(eWeek){eWeek.onmouseover=function(e){addcss(this.parentElement.parentElement,'week');};eWeek.onmouseout=function(e){removecss(this.parentElement.parentElement,'week');};});}};_me.__getId=function(eid){return eid.substr(this._pathName.length+1);};_me.__getDate=function(id,rel){rel=rel||0;var month=this._dDate.month();return this._dDate.clone().month(rel>0?(month+1):(rel<0?month-1:month)).date(+id);};

/* client/inc/obj_call.js */
_me=obj_call.prototype;function obj_call(){};_me.__constructor=function(){this._zindex.zindex=[9000];this._listen('sip');dataSet.obey(this,'_listener_data','xmpp',true);this._add_destructor('__destructor');this.__placeElement=null;};_me._placeElement=function(elm){if(elm){this.__placeElement=elm;}
if(this.__placeElement){var pos=getSize(this.__placeElement);this._place(pos.x+pos.w,pos.y+(pos.h/2));}
else
if(this.__position){this.__onGuiResize();}};_me.__avatar=function(sEmail){if(!sPrimaryAccountGW)return;var me=this,sURL=getAvatarURL(sEmail),img=new Image(),anchor=me._getAnchor('avatar');if(anchor){img.onload=function(){if(!anchor||!anchor.parentNode)
return;try{var tmp,elm;if(!(tmp=anchor.getElementsByTagName('b'))||!(elm=tmp[0])){elm=mkElement('b');anchor.appendChild(elm);}}
catch(r){return;}
if(elm){if(this.height>10&&this.width>10){if(currentBrowser()=='MSIE7'){var img=mkElement('img',{src:sURL});if(this.width>this.height){var r=this.height/elm.clientHeight;img.style.height='100%';if((this.width/r)>elm.clientWidth)
img.style.right=(((this.width/r)-elm.clientWidth)/2)+'px';}
else{var r=this.width/elm.clientWidth;img.style.width='100%';if((this.height/r)>elm.clientHeight)
this.style.bottom=(((this.height/r)-elm.clientHeight)/2)+'px';}
elm.appendChild(img);elm.style.backgroundImage='none';}
else
elm.style.backgroundImage='url("'+sURL+'")';elm.style.backgroundColor='#FFFFFF';}
else{elm.style.backgroundImage='';elm.style.backgroundColor='';}}};img.src=sURL;}};_me.__update=function(sDName){var ds=dataSet.get('sip'),im=false,sInfo='';if(!ds)return;if(ds.p1){switch(dataSet.get('xmpp',['roster',ds.p1,'show'])){case'online':case'away':case'xa':case'dnd':im=true;break;}}
if(sDName&&this.__lastActivity&&this.__lastActivity==ds.activity+'/'+ds.muted+'/'+(im?'im':''))
return;switch(ds.activity){case'Calling':this._fill([{anchor:'avatar',css:'avatar',keep:true},{title:'DIAL::HANG_UP',css:'big ico hangup color2',arg:'hangup'}]);sInfo=getLang('DIAL::CALLING');break;case'Phoning':var time=this.clock&&this.clock._value()||'0:00',tmp=[{anchor:'avatar',css:'avatar',keep:true}];if(this.__dtmf)
tmp.push({anchor:'keypad',css:'keypad',keep:true});else
tmp.push({title:'DIAL::KEYPAD',css:'big ico dial',arg:'dial',keep:true});if(im)
tmp.push({title:'IM::IM',css:'big ico chat',arg:'im'});tmp.push({title:'DIAL::MUTE',css:'big ico mute'+(ds.muted?' active':''),arg:'mute',keep:true});if(!ds.video)
tmp.push({title:this.__holding?'DIAL::UNHOLD':'DIAL::HOLD',css:'big ico hold'+(ds.onhold?' active':''),arg:'hold',keep:true});tmp.push({title:'DIAL::HANG_UP',css:'big ico hangup color2',arg:'hangup'});this._fill(tmp);if(this.__dtmf)
this._create('dtmf','obj_dtmf','keypad');this._create('clock','obj_label','avatar','lbl_clock')._value(time);this._startTimer();sInfo=getLang('DIAL::CALLESTABLISHED');break;case'Ringing':var tmp=[{anchor:'avatar',css:'avatar',keep:true}];tmp.push({title:'DIAL::DECLINE',css:'big ico decline color2',arg:'decline'});tmp.push({title:'DIAL::ANSWER',css:'big ico '+(dataSet.get('sip',['remote','video'])?'video':'answer')+' color3x',arg:'answer',keep:true});this._fill(tmp);sInfo=getLang('DIAL::INCOMINGCALL');break;default:this._destruct();if(gui.video)
gui.video._destruct();return;}
var name=dataSet.get('sip',['remote','name'])||dataSet.get('sip',['remote','id']);if(name&&sInfo&&ds.type!='Info'){this.__avatar(dataSet.get('sip',['remote','id']));this._create('label','obj_label','avatar','lbl_action')._value(sInfo);this._create('user','obj_label','avatar','lbl_user')._value(name.indexOf('@')>0?name.substr(0,name.indexOf('@')):name);}
this.__lastActivity=ds.activity+'/'+ds.muted+'/'+(im?'im':'');this._placeElement();};_me._startTimer=function(){if(this.__interval)
window.clearInterval(this.__interval);var me=this;this.__interval=window.setInterval(function(){var t=new IcewarpDate(dataSet.get('sip',['timer']));if(me.clock&&t&&(t=new IcewarpDate().unix()-t.unix())){var h=Math.floor(t/3600),m=Math.floor(t%3600/60),s=Math.floor(t%60),pad=function(v){return v<10?'0'+v:v;};me.clock._value((h?h+':'+pad(m):m)+':'+pad(s));}},1000);};_me._onclose=function(){switch(dataSet.get('sip',['activity'])){case'Calling':case'Ringing':case'Phoning':return false;}};_me._onclick=function(e,elm,id,arg){var sip=gui.frm_main.sip;if(sip)
switch(arg){case'im':var usr=dataSet.get('sip',['p1']);if(usr&&gui.frm_main.im)
gui.frm_main.im._chat(usr);break;case'dial':this.__dtmf=true;this.__update();break;case'mute':sip._mute(!sip._mute());break;case'hold':var hold=!sip._hold();sip._hold(hold);this.__holding=hold;this.__update();break;case'answer':sip._answerCall();break;case'answer_video':sip._answerCall(true);break;case'decline':sip._declineCall();break;case'hangup':sip._hangup();break;}};_me.__destructor=function(){if(this.__interval)
window.clearInterval(this.__interval);};

/* client/inc/obj_callhistory.js */
_me=obj_callhistory.prototype;function obj_callhistory(){};_me.__constructor=function(){setSelectNone(this._main);this.__value=-1;this.__idTable={};var me=this;this._main.onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm!==this){if(elm.tagName!='A')
elm=Is.Child(elm,'A');var id=elm.id.substr(me._pathName.length+1);if(me.__value>-1){var telm=document.getElementById(me._pathName+'/'+me.__value);if(telm){if(me.__idTable[me.__value][1]=='FAILED')
removecss(telm,'active_f');else
removecss(telm,'active_a');}}
me.__value=id;if(me.__idTable[me.__value][1]=='FAILED')
addcss(elm,'active_f');else
addcss(elm,'active_a');if(me._onclick)
me._onclick(me.__idTable[me.__value][0]);}};this._main.ondblclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm!==this&&me.__value){if(me._ondblclick)
me._ondblclick(me.__idTable[me.__value][0]);}};this._scrollbar(this._getAnchor('body'),this._main);};_me._value=function(){if(this.__value>-1)
return this.__idTable[this.__value][0];};_me._searchin=function(s){for(var i in this.__idTable){if(this.__idTable[i][0]==s)
return i;}
return-1;};_me._fill=function(aData){var out='';this.__idTable={};if(aData){var sLang=getLang('DIAL::DURATION');for(var i in aData){this.__idTable[i]=[aData[i].INOUT=='IN'?aData[i].FROM:aData[i].TO,aData[i].STATUS];if(this.__aFilter&&((this.__aFilter.IN&&aData[i].INOUT!='IN')||(this.__aFilter.OUT&&aData[i].INOUT!='OUT')||(this.__aFilter.FAILED&&!(aData[i].STATUS=='FAILED'||aData[i].STATUS=='CANCELLED'))))
continue;out+='<a id="'+this._pathName+'/'+i+'" class="'+(aData[i].STATUS||'')+'"><div class="'+(aData[i].INOUT||'')+'"><h3>'+(this.__idTable[i][0].toString().escapeHTML())+"</h3><p>"+IcewarpDate.unix(aData[i].UNIXSTAMP).format('L LT')+(aData[i].DURATION?" "+sLang+" "+parseJulianTime(aData[i].DURATION):'')+"</p></div></a>\n";}}
this._getAnchor('body').innerHTML=out;};_me._filter=function(aFilter){this.__aFilter={};for(var i in aFilter)
this.__aFilter[aFilter[i]]=true;this.__update(this.__lastDS,this.__lastDP);};_me.__update=function(sDataSet,sDataPath){if(!sDataSet)return;this.__lastDS=sDataSet;this.__lastDP=sDataPath;var aData=dataSet.get(sDataSet,['SIP_CALLS','ITEMS']);var out=[],tmp;for(var i in aData){tmp={};for(var j in aData[i].VALUES)
if(aData[i].VALUES[j].VALUE)
tmp[j]=aData[i].VALUES[j].VALUE;out.push(tmp);}
this._fill(out);};

/* client/inc/obj_categories.js */
_me=obj_categories.prototype;function obj_categories(){};_me.__constructor=function(){this.button._onclick=function(){gui._create('categories','frm_categories','','',this.input._value(),[this,'__callback']);}.bind(this);};_me.__callback=function(sText){this.input._value(sText);};_me._value=function(v){if(v)
this.input._value(v);else
return this.input._value(v);};_me._getFocusElement=function(){return this.input._getFocusElement();};_me._focus=function(b){return this.input._focus(b);};_me._readonly=function(b){this.button._disabled(b);this.input._readonly(b);};

/* client/inc/obj_charset.js */
_me=obj_charset.prototype;function obj_charset(){};_me.__constructor=function(){this._fill({"UTF-8":'Auto Unicode (UTF8)',"ISO-8859-1":'Western European (ISO-8859-1)',"WINDOWS-1252":'Western European (Windows-1252)',"ISO-88595":'Cyrillic Alphabet (ISO-8859-5)',"WINDOWS-1251":'Cyrillic Alphabet (Windows-1251)',"GBK":'Chinese Simplified (GBK)',"BIG5":'Chinese Traditional (Big5)',"EUC-JP":'Japanese (EUC)',"SHIFT_JIS":'Japanese (SHIFT_JIS)',"ISO-2022-jp":'Japanese (ISO-2022)',"euc-kr":'Korean (EUC)',"KS_C_5601-1987":'Korean (ks_c_5601-1987)',"ISO-8088-kr":'Korean (ISO-2022)',"ISO-8859-9":'Turkish (ISO-8859-9)',"WINDOWS-1254":'Turkish (Windows-1254)',"ISO-8859-8":'Hebrew (ISO-8859-8)',"WINDOWS-1255":'Hebrew (Windows-1255)',"ISO-8859-2":'Central European (ISO-8859-2)',"WINDOWS-1250":'Central European (Windows-1250)',"ISO-8859-4":'Baltic (ISO-8859-4)',"WINDOWS-1257":'Baltic (Windows-1257)',"ISO-8859-6":'Arabic (ISO-8859-6)',"WINDOWS-1256":'Arabic (Windows-1256)',"ISO-8859-7":'Greek (ISO-8859-7)',"WINDOWS-1253":'Greek (Windows-1253)',"WINDOWS-874":'Thai (Windows-874)',"TIS-620":'Thai (tis-620)'});this._value('UTF-8');};

/* client/inc/obj_chat.js */
_me=obj_chat.prototype;function obj_chat(){};_me.__constructor=function(){var me=this;this.__lastRcp=[];this._container=mkElement('div',{className:'maxbox'});this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(e.target.classList.contains('image-wrapper')||e.target.parentElement.classList.contains('image-wrapper')){var image=gui._create('imgview','frm_imgview');var current=false;var target=e.target.nodeName==='IMG'?e.target:e.target.firstChild;var images=[].map.call(me._main.querySelectorAll('img.preview'),function(img){if(target===img){return current={url:img.getAttribute('src')};}
return{url:img.getAttribute('src')};});image._fill(images);image._value(images.indexOf(current));return;}
if(elm.tagName=='A'){if(elm.rel){if(me._onclickdate)
me._onclickdate(elm.rel);}else
if(elm.href.toLowerCase().indexOf('mailto:')==0){NewMessage.compose({to:elm.href.substr(7)});return false;}}else
if(me._onclickuser&&elm.tagName=='SPAN'&&elm.getAttribute('rel'))
me._onclickuser(elm.getAttribute('rel'));};this._main.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A')
if(elm.href.toLowerCase().indexOf('mailto:')==0){me._context_link(e,elm.href.substr(7),elm.innerHTML);return false;}};this._main.appendChild(this._container);this._scrollbar(this._container,this._main);AttachEvent(this._container,'onscroll',function(){me._history_scroll();});};_me._msgHeader=function(sBody){if(typeof sBody==='object'){switch(sBody.type){case"image":return getLang('IM::SHARED_IMAGE');case"geoloc":return getLang('IM::SHARED_LOCATION');}}
return'';};_me._add=function(sFrom,sTo,sBody,bReply,date,bGroup){var toDay,out='',sTo=sTo||'';if(!date){toDay=date=new IcewarpDate();}else{toDay=new IcewarpDate();toDay.hour(0).minute(0).second(0);}
if(this.__lastRcp[0]!=sFrom+'/'+sTo||this.__lastRcp[0]==sFrom+'/'+sTo&&this.__lastRcp[0]!=bGroup||(this.__lastRcp[1]&&date.unix()-this.__lastRcp[1].unix()>300))
out+='<div><span class="obj_chat_date">'+(date<toDay?date.format('L LT'):date.format('isoTime'))+'</span> <span class="obj_chat_from '+this._styleuser(sFrom)+'" rel="'+sFrom.entityify()+'">'+this._translateUser(sFrom).escapeHTML()+'</span> '+this._msgHeader(sBody)+(sTo?' <span class="obj_chat_to '+this._styleuser(sTo)+'" rel="'+sTo.entityify()+'">'+this._translateUser(sTo).escapeHTML()+'</span>':'')+'</div>';var m;if(typeof sBody==='object'){switch(sBody.type){case"image":out+='<div class="obj_chat_body"><div class="image-wrapper"><img class="preview" src="'+sBody.url+'"></div><a href="'+sBody.url+'" target="_blank">Download</a></div>';break;case"geoloc":out+='<div class="obj_chat_body"><iframe frameborder="0" style="border:0"src="./client/gmaps.html?obj=gui.map&scale_controll=0&lat='+sBody.geoloc.LAT[0].VALUE+'&lon='+sBody.geoloc.LON[0].VALUE+'&key='+(GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')||'')+'"></iframe></div>';break;}}else if(~sBody.indexOf('/conference/')&&(m=sBody.match(wm_conference.linkRegExp)))
out+='<div class="obj_chat_body">'+this._smiles(sBody).replace(wm_conference.linkRegExp,'<span onclick="wm_conference.get(\''+m[2]+'_'+m[1]+'\').join()">'+m[0]+'</span>')+'</div>';else
out+='<div class="obj_chat_body">'+this._smiles_links(sBody)+'</div>';var elm=mkElement('div',{className:'obj_chat_row'+(GWOthers.getItem('IM','block_chat')>0?'':' obj_chat_row_inline')+(bReply?' obj_chat_reply':''),innerHTML:out});this._container.appendChild(elm);this.__lastRcp=[sFrom+'/'+sTo,date,bGroup];this._scroll();};_me._history=function(b){if(b){this.__history=true;if(this.__helm&&this.__helm.parentNode)
this.__helm.parentNode.removeChild(this.__helm);this.__helm=mkElement('div',{className:'history'});this.__helm.innerHTML=getLang('IM::LOAD_HISTORY');var me=this;this.__helm.onclick=function(){if(me._onhistory&&me.__history){me._onhistory(me);me.__history=false;}};this._container.insertBefore(this.__helm,this._container.firstChild||null);addcss(this._main,'history');}else{this.__history=false;removecss(this._main,'history');}};_me._history_scroll=function(b){if(this._onhistory&&this.__history){if(this.__helm&&this._container.scrollTop<50){this.__helm.style.opacity=0.8*(1-(this._container.scrollTop/50));this.__helm.style.marginTop=(25-(this._container.scrollTop/2))+'px';}
if(this._container.scrollTop==0){this._onhistory(this);this.__history=false;}}};_me._smiles=function(sBody){return Smiles.replaceSmiles(sBody.entityify());};_me._smiles_links=function(sBody){if(sBody){var hla=sBody.highlight_links_array(),sBody=Smiles.replaceSmiles(hla.string.entityify());return sBody.replace(new RegExp(hla.replace,'g'),function(s,id){return hla.array[id];});}};_me._context_link=function(e,sMail,sName){var c=gui._create('context','obj_context_link','','',sName,sMail);c._place(e.clientX,e.clientY);c=null;};_me._system=function(sStatus){var date=new IcewarpDate(),elm=mkElement('div',{className:'obj_chat_system'});elm.innerHTML='<span class="obj_chat_date" title="'+date.toString()+'">'+date.format('isoTime')+'</span> <span class="obj_chat_info">'+sStatus+' </span>';this._container.appendChild(elm);this.__lastRcp=[];this._scroll();};_me._notice=function(sFrom,sStatus){var date=new IcewarpDate(),elm=mkElement('div',{className:'obj_chat_status'});elm.innerHTML='<span class="obj_chat_date" title="'+date.toString()+'">'+date.format('isoTime')+'</span> <span class="obj_chat_from">'+this._translateUser(sFrom)+'</span> - <span class="obj_chat_info">'+sStatus.escapeHTML()+' </span>';this._container.appendChild(elm);this.__lastRcp=[];this._scroll();};_me._clear=function(){this._container.innerHTML='';};_me._scroll=function(){var n;if((n=this._container.scrollHeight-this._container.clientHeight)>0)
this._container.scrollTop=n;};_me._fill=function(aData,bSkipTodayLabel,bTop){if(!bTop){this._clear();}
var str='',sName,bBloc=GWOthers.getItem('IM','block_chat')>0,toDay=new IcewarpDate();toDay.hour(0).minute(0).second(0);var prev,sdate;for(var i in aData){sName=this._translateUser(aData[i]['from']);sdate=aData[i]['date'].year()+''+aData[i]['date'].month()+''+aData[i]['date'].date();if(prev!=sdate){str+='<div class="obj_chat_split">'+aData[i]['date'].format("L")+'</div>';this.__lastRcp=[];}
str+='<div class="obj_chat_row'+(bBloc?'':' obj_chat_row_inline')+(aData[i]['reply']?' obj_chat_reply':'')+'">';if(this.__lastRcp[0]!=sName||(this.__lastRcp[1]&&aData[i]['date'].unix()-this.__lastRcp[1].unix()>600)){this.__lastRcp=[sName,aData[i]['date']];str+='<div><span class="obj_chat_date" title="'+aData[i]['date'].format("L LT")+'">'+
(this._onclickdate?'<a rel="'+aData[i]['sec']+'" title="'+getLang('IM::SHOW_AFTER',[aData[i]['date'].format("L LT")])+'">'+(aData[i]['date']<toDay?aData[i]['date'].format('L LT'):aData[i]['date'].format('isoTime'))+'</a>':(aData[i]['date']<toDay?aData[i]['date'].format('L LT'):aData[i]['date'].format('isoTime')))+'</span> <span class="obj_chat_from">'+sName.escapeHTML()+' </span>'+this._msgHeader(aData[i]['body'])+'</div>';}
var m;if(typeof aData[i]['body']==='object'){switch(aData[i]['body'].type){case"image":str+='<div class="obj_chat_body"><div class="image-wrapper"><img class="preview" src="'+aData[i]['body'].url+'"></div></div><a href="'+aData[i]['body'].url+'" target="_blank">Download</a></div>';break;case"geoloc":str+='<div class="obj_chat_body"><iframe frameborder="0" style="border:0"src="./client/gmaps.html?obj=gui.map&scale_controll=0&lat='+aData[i]['body'].geoloc.LAT[0].VALUE+'&lon='+aData[i]['body'].geoloc.LON[0].VALUE+'&key='+(GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')||'')+'"></iframe></div></div>';break;}}else if(~aData[i]['body'].indexOf('/conference/')&&(m=aData[i]['body'].match(wm_conference.linkRegExp)))
str+='<div class="obj_chat_body">'+this._smiles(aData[i]['body']).replace(wm_conference.linkRegExp,'<span onclick="wm_conference.get(\''+m[2]+'_'+m[1]+'\').join()">'+m[0]+'</span>')+'</div></div>';else{str+='<div class="obj_chat_body">'+(aData[i]['body']?this._smiles_links(aData[i]['body']):'')+'</div></div>';}
prev=sdate;}
if(!bSkipTodayLabel&&sdate<toDay.year()+''+toDay.month()+''+toDay.date()){str+='<div class="obj_chat_split">'+toDay.format('L')+'</div>';}
var elm=mkElement('div',{innerHTML:str});if(bTop){this._container.insertBefore(elm,this._container.firstChild||null);}else{this._container.appendChild(elm);this._scroll();}};_me._translateUser=function(sUser){return dataSet.get('xmpp',['roster',sUser,'name'])||sUser;};_me._styleuser=function(sUser){return'';};

/* client/inc/obj_chat_input.js */
_me=obj_chat_input.prototype;function obj_chat_input(){};_me.__constructor=function(arg){var me=this;storage.library('purify.wrapper','purify');this.__options=arg||{};this.__options.giphy_enabled=Giphy.enable_keyboard;if(this.__options.handlers)
addcss(this._main,'add');this._draw("obj_chat_input",'main',arg);this.input.__maxHeight=this.__options.height||300;this.input._onpaste=function(e){var items=(e.clipboardData||(e.originalEvent||{}).clipboardData||{}).items||(window.clipboardData||{}).files||[];for(var i=0;i<items.length;i++){if(items[i].getAsFile&&items[i].type.indexOf('image')===0){var file=items[i].getAsFile();try{file=new File([file],'clipboard-'+new IcewarpDate()+'.png',{type:items[i].type});}catch(e){}
if(me._onpasteimage)
me._onpasteimage([file]);me.__exeEvent('pasteimage',null,{"files":[file],"owner":this});e.preventDefault&&e.preventDefault();}}};this.input._onkeydown=function(e){if(!this.suggest)
if(e.keyCode==13&&((GWOthers.getItem('IM','enter_send')>0&&!e.shiftKey)||e.ctrlKey)){e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();if(e.stopPropagation)
e.stopPropagation();var v=this._value().trim();if(me.__submit)
me.__submit(v);return false;}
else
if(e.keyCode==8&&me.__private&&this._getCartPos()==0){me._private();}
else
if(e.keyCode==27){if(me.preview)
me.preview._destruct();else
if(me._onclose)
me._onclose(e);return false;}
if(me._onkeydown)
me._onkeydown(e);};var etmp=mkElement('div');this.input._onkeyup=function(){if(me.__options.parseurl&&me.__smartcheck)
window.clearTimeout(me.__smartcheck);if(me._destructed)
return;if(me.__options.memory&&me.__options.memory.set){executeCallbackFunction(me.__options.memory.set,this._value());}
if(me.__options.parseurl){me.__smartcheck=window.setTimeout(function(){if(me&&!me._destructed&&me.input){var s=me.input._value(),elm;etmp.innerHTML=DOMPurify.sanitize(s.highlight_links());if((elm=etmp.getElementsByTagName('A'))&&(elm=elm[0])&&elm.href&&!~elm.href.indexOf('mailto:')){var sHref=elm.href.split('#').shift();if(me.__lastURL!=sHref&&(me.__lastURL=sHref)){gui.socket.api._linkpreview(sHref,[function(aData){if(aData.ATTRIBUTES.ID){me.__lastURLID=aData.ATTRIBUTES.ID;me.__lastURL=sHref;me.__urlloading(true);}}]);}
else{me.__urlloading(false);return;}}
else{me.__urlloading(false);return;}
delete me.__lastURL;delete me.__lastURLID;me.__urlloading(false);if(me.preview)
me.preview._destruct();}},1500);}};this.label._onclick=function(){me._private();};if(this.__options.handlers)
this.add._onclick=function(e){if(!this.cmenu||this.cmenu._destructed){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();var aMenu=[];if(me.__options.handlers){if(me.__options.handlers['word']||me.__options.handlers['excel']||me.__options.handlers['ppoint']||me.__options.handlers['note']){aMenu.push({'title':'CHAT::CREATE_NEW_DOCUMENT',css:'ico2 file',nodes:[me.__options.handlers['word']?{'title':'main_menu::new_word','arg':{'method':'word'},css:'ico2 word'}:false,me.__options.handlers['excel']?{'title':'main_menu::new_excel','arg':{'method':'excel'},css:'ico2 excel'}:false,me.__options.handlers['ppoint']?{'title':'main_menu::new_ppoint','arg':{'method':'ppoint'},css:'ico2 ppoint'}:false,me.__options.handlers['note']?{'title':'main_menu::new_note','arg':{'method':'note'},css:'ico2 note'}:false].filter(Boolean)});}
if(me.__options.handlers['attach']){aMenu.push({'title':'CHAT::SHARE_FILE_OR_DOCUMENT','arg':{'method':'attach'},css:'ico2 attach'});}
if(me.__options.handlers['code']){aMenu.push({'title':'INSERT_CODE::TITLE','arg':{'method':'code'},css:'ico2 code'});}
if(me.__options.handlers['conference']){aMenu.push({'title':'CHAT::NEW_CONFERENCE','arg':{'method':'conference'},css:'ico2 conference',disabled:!sPrimaryAccountCONFERENCE});}
if(me.__options.handlers['event'])
aMenu.push({'title':'IM::NEW_EVENT','arg':{'method':'event'},css:'ico2 event'});if(me.__options.handlers['email'])
aMenu.push({'title':'CHAT::NEW_EMAIL','arg':{'method':'email'},css:'ico2 email'});if(me.__options.handlers['geo'])
aMenu.push({'title':'IM::GEO','arg':{'method':'geo'},css:'ico2 geo',disabled:!("geolocation"in navigator)||!GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')});}
else
return;addcss(this._main,'color1');var pos=getSize(this._main);this.cmenu=gui._create("cmenu","obj_context",'','obj_chat_input_add',this);this.cmenu._fill(aMenu);this.cmenu._place(pos.x+pos.w/2,pos.y,null,3);var btn=this;this.cmenu._obeyEvent('destructed',[function(){removecss(btn._main,'color1');}]);this.cmenu._onclick=function(e,elm,id,arg){if(arg.method&&me.__options.handlers&&me.__options.handlers[arg.method])
executeCallbackFunction(me.__options.handlers[arg.method]);else
executeCallbackFunction(arg);};}};if(this.__options.smiles_enabled){this.smile._onclick=function(e){if(!gui.smile||gui.smile._destructed){var oText=this._parent.input,aPos=getSize(this._main);this.smilebox=gui._create('smile','frm_smilebox','','',[function(smile){var iPos=oText._getCartPos();var text=(iPos>0?(oText._value().charAt(iPos-1)===' '?'':' '):'')+smile.name+(oText._value().charAt(iPos)===' '?'':' ');oText._value(oText._value().substr(0,iPos)+text+oText._value().substr(iPos));oText._setRange(iPos+text.length);if(me.__options.memory&&me.__options.memory.set){executeCallbackFunction(me.__options.memory.set,oText._value());}}],aPos.x+aPos.w,aPos.y);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;}
else
gui.smile._destruct();};}
if(this.__options.giphy_enabled){this.giphy._onclick=function(e){if(!gui.giphy||gui.giphy._destructed){Giphy.trending('R',function(error,data){var aPos=getSize(this._main),giphy=gui._create('giphy','obj_block_ext_uni','','giphy_keyboard');giphy._place(aPos.x+aPos.w-342,aPos.y-403,350,400);giphy._main.innerHTML='<div><input type="text" placeholder="Search query" id="giphy-keyboard-search"></div>\
    <div id="giphy-search-result"></div>';var timer=false;document.getElementById('giphy-keyboard-search').addEventListener('keyup',function(){if(timer){clearTimeout(timer);}
setTimeout(function(){Giphy.search(this.value,'en','R',function(err,data){var response=document.getElementById('giphy-search-result');while(response.firstChild){response.removeChild(response.firstChild);}
data.forEach(function(item){var gif=document.createElement('span');gif.style.backgroundImage='url("'+item.images.fixed_width_small_still.url+'")';gif.style.display='inline-block';gif.classList.add('gif-item');gif.addEventListener('mouseenter',function(){this.style.backgroundImage='url("'+item.images.fixed_width_small.url+'")';});gif.addEventListener('mouseleave',function(){this.style.backgroundImage='url("'+item.images.fixed_width_small_still.url+'")';});gif.addEventListener('click',function(){Giphy.sendToTC(item.images.downsized.url,item.id,me._parent);});document.getElementById('giphy-search-result').appendChild(gif);});},this);}.bind(this),300);});data.forEach(function(item){var gif=document.createElement('span');gif.style.backgroundImage='url("'+item.images.fixed_width_small_still.url+'")';gif.style.display='inline-block';gif.classList.add('gif-item');gif.addEventListener('mouseenter',function(){this.style.backgroundImage='url("'+item.images.fixed_width_small.url+'")';});gif.addEventListener('mouseleave',function(){this.style.backgroundImage='url("'+item.images.fixed_width_small_still.url+'")';});gif.addEventListener('click',function(){Giphy.sendToTC(item.images.downsized.url,item.id,me._parent);});document.getElementById('giphy-search-result').appendChild(gif);});},this);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;}
else
gui.giphy._destruct();};}
if(this.__options.parseurl)
gui.socket.api._obeyEvent('onurlinfo',[function(aData){if(this._destructed)
return false;if(this.__lastURL&&Is.Object(aData)&&aData.URL&&this.__lastURL==aData.URL[0].VALUE)
this.__urlpreview(aData);else
this.__urlloading(false);}.bind(this)]);};_me._disabled=function(b){if(Is.Defined(b)){b?addcss(this._main,'disabled'):removecss(this._main,'disabled');this.input._disabled(b);this.smile&&this.smile._disabled(b);this.add._disabled(b);}
else
return this.input._disabled();};_me.__submit=function(v){if(this._onsubmit){var arg={},aM=this.input._mention();if(this.preview&&!this.preview._destructed)
arg=this.preview._value();if(!Is.Empty(aM))
arg.mentions=aM;if(this._onsubmit(v,arg,this.__private)==false)
return;if(this.input){this.input._value('');this.input._mention('');}
delete this.__lastURL;delete this.__lastURLID;this.__urlloading(false);if(this.preview)
this.preview._destruct();}};_me._private=function(name,email){var tmp_escape=this.label._escape;if(email&&email!=sPrimaryAccount){this.__private={name:name,email:email};this.label._escape=true;this.label._value(name||email);this.label._escape=tmp_escape;this.label._disabled(false);}else{delete this.__private;this.label._disabled(true);this.label._value('');}
this._focus();};_me._folder=function(aFolder){if(aFolder){this.input.__folder=aFolder;this.__lastURL=false;window.clearTimeout(this.__smartcheck);this.preview&&this.preview._destruct();if(this.__options.memory&&this.__options.memory.get){this.input._value(executeCallbackFunction(this.__options.memory.get));var placeholder=this.input.__eIN.getAttribute('placeholder');this.input.__eIN.setAttribute('placeholder','');this.input.__eIN.setAttribute('placeholder',placeholder);}
this.input._onkeyup();}
else
return this.input.__folder||{};};_me._value=function(v){return this.input._value(v);};_me._focus=function(){return this.input._focus();};_me._hasFocus=function(){return this.input._hasFocus();};_me.__onDestroyChild=function(sName){if(sName=='preview')
removecss(this._main,'preview','loading');};_me.__urlloading=function(b){b?addcss(this._main,'loading'):removecss(this._main,'loading');};_me.__urlpreview=function(aData){this._create('preview','obj_urlpreview','preview','',aData);this.preview._onclose=function(){this._focus();}.bind(this);removecss(this._main,'loading');addcss(this._main,'preview');};

/* client/inc/obj_chat_toolbar.js */
function obj_chat_toolbar(){};obj_chat_toolbar.prototype={__constructor:function(){this.__aFolder={};if(GWOthers.getItem('CHAT','visual_notify')>'0'||GWOthers.getItem('CHAT','sound_notify')>'0'){this._create('notify','obj_checkbox','notify','switch right')._title('CHAT::NOTIFY_SW');}
this._create('label','obj_label','room')._escape=true;this.label._onchange=function(){if(this._value().length){if(this.__eIN.scrollWidth){this._main.style.minWidth=Math.min(150,this.__eIN.scrollWidth+1)+'px';return;}
setTimeout(function(){if(this&&!this._destruced)
this._onchange();}.bind(this),500);}
else{this._main.style.minWidth=0;}};this._create('status','obj_room_status','room');this._create('menu','obj_hmenu','menu');this.menu._fillMe=function(id){var tab,tabs=[{title:'CHAT::ROOM',arg:'room'},{title:'CHAT::FILES',arg:'files'},{title:'CHAT::EVENTS',arg:'events'},{title:'CHAT::MEMBERS',arg:'members'}];tabs.map(function(v){if(v.arg==id){tab=v;v.css="active";}
return v;});this._fill([].concat(tabs,[{title:tab.title,arg:tab.arg,css:'obj_context short',nodes:tabs.map(function(v){var o=clone(v);o.css="ico2";if(o.arg==id){o.css+=" check";}
return o;})}]),'static');};this.menu._fillMe('room');this.menu._onclick=function(e,elm,id,arg){this.tabs._value(arg);}.bind(this._parent);this._parent.tabs._obeyEvent('onchange',[function(e,arg){if(this&&!this._destruced&&arg.value)
this._fillMe(arg.value);else
return false;}.bind(this.menu)]);this._create('buttons','obj_hmenu','buttons','buttons');this.buttons._fillMe=function(){var id=Cookie.get(['folders',this.__aFolder.aid,this.__aFolder.fid,'tab']);if(Is.Empty(this.buttons.__aData)){var aFill=[{text:'',tooltip:'CHAT::PINS',arg:'pins',css:'ico2 img pins local'},{text:'',tooltip:'CHAT::MY_MENTIONS',arg:'mentions',css:'ico2 img mentions'}];if(id){aFill[id=='mentions'?1:0].css+=' active';}
this.buttons._fill(aFill,'static');}
else
{[].forEach.call(this.buttons._main.querySelectorAll('li.ico2'),function(eli){if(id&&hascss(eli,id))
addcss(eli,'active');else
removecss(eli,'active');});}}.bind(this);this.buttons._onclick=function(e,elm,id,arg){var v=this.panel._value();if(v==arg||(arg=='pins'&&v=='local'))
this.panel[arg].__deactive();else
this.panel._value(arg);}.bind(this._parent);this._add_destructor('__destructor');},_setFolder:function(aFolder){if(this.__aFolder.fid&&this.__aFolder.fid!=aFolder.fid){this.__destructor();}
this.__aFolder=aFolder;var sTitle=dataSet.get('folders',[aFolder.aid,aFolder.fid,'NAME'])||Path.basename(aFolder.fid);gui.frm_main._title(sTitle);this.label._value(sTitle);if(this.notify){this.notify._onchange=function(){dataSet.add('folders',[aFolder.aid,aFolder.fid,'NOTIFY'],this._value()?1:0,true);WMFolders.action({aid:aFolder.aid,fid:aFolder.fid,xmlarray:{NOTIFY:[{VALUE:this._value()?1:0}]}},'folders','','edit');};var value=+dataSet.get('folders',[aFolder.aid,aFolder.fid,'NOTIFY'])>0;this.notify._value(value,true);}
this.status._setFolder(aFolder);dataSet.on('cookies',['folders',aFolder.aid,aFolder.fid,'tab'],this.__onTabUpdate,this,true);},__onTabUpdate:function(){if(this&&this.buttons&&!this.buttons._destruced)
this.buttons._fillMe();},__destructor:function(){if(this.__aFolder.fid)
dataSet.off('cookies',['folders',this.__aFolder.aid,this.__aFolder.fid,'tab'],this.__onTabUpdate);}};

/* client/inc/obj_chat_voip.js */
_me=obj_chat_voip.prototype;function obj_chat_voip(){};_me.__constructor=function(){addcss(this._main.parentNode,'sip');this._add_destructor('__destructor');var me=this;this.btn._onclick=function(){switch(dataSet.get('sip',['activity'])){case'Ringing':me.__getSIP()._declineCall();return;case'Calling':case'Phoning':me.__getSIP()._hangup();return;}};this.mute._onclick=function(){if(dataSet.get('sip',['activity'])=="Phoning")
me.__getSIP()._mute(!me.__getSIP()._mute());};this._getAnchor('info').onclick=function(e){switch(dataSet.get('sip',['activity'])){case'Ringing':me.__getSIP()._answerCall();break;}};this._listen('sip');};_me.__update=function(){if(gui.frm_main.sip){var ds=dataSet.get('sip');if(ds&&ds.state=='online'){if(ds.muted)
addcss(this.mute._main,'active');else
removecss(this.mute._main,'active');switch(ds.activity){case'Calling':this._info(getLang('IM::SIP_CALLING'));this.btn._value('DIAL::HANG_UP');this.mute._disabled(true);return;case'Phoning':this._info(getLang('IM::SIP_INPROGRESS'));this.btn._value('DIAL::HANG_UP');this.mute._disabled(false);return;case'Ringing':this._info(getLang('IM::SIP_INCOMMING'));this.btn._value('DIAL::DECLINE');this.mute._disabled(true);return;}}
this._destruct();}};_me._info=function(s){this._getAnchor('info').innerHTML=s?s.escapeHTML():'';};_me.__destructor=function(){if(this._main.parentNode)
removecss(this._main.parentNode,'sip');};_me.__getSIP=function(){return gui.frm_main.sip;};

/* client/inc/obj_checkbox.js */
_me=obj_checkbox.prototype;function obj_checkbox(){};_me.__constructor=function(sTitle){var me=this;this._main.appendChild(mkElement('span'));this.__eIN=mkElement('input',{"type":'checkbox',"name":this._pathName+'#main',"id":this._pathName+'#main'});this._main.appendChild(this.__eIN);this.__eIN.value=true;if(Is.Defined(sTitle))this._title(sTitle);this.__eIN.onclick=function(e){var b=true,e=e||window.event;if(me._onclick)b=me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});if(b===false)
return false;window[this.checked?'addcss':'removecss'](me._main,'checked');if(me._onchange)me._onchange(e);me.__exeEvent('onchange',e,{"owner":me});return true;};this.__eIN.onfocus=function(e){addcss(me._main,'focus');};this.__eIN.onblur=function(e){removecss(me._main,'focus');};this._main.onclick=function(e){if(me.__eIN.disabled)
return false;var b=true,e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='SPAN'||elm.tagName=='LABEL'){if(me._onclick)b=me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});if(b!==false){me._checked(!me._checked());me._focus(true);if(me._onchange)me._onchange(e,me._checked());me.__exeEvent('onchange',e,{"owner":me});}}};};_me._value=function(b,bNoUpdate){var old=this._checked(),b=this._checked(b);if(!bNoUpdate&&old!=b){if(this._onchange)this._onchange(void 0,this._checked());this.__exeEvent('onchange',null,{"owner":this});}
return b?1:0;};_me._checked=function(b){if(Is.Defined(b)){if(Is.String(b))b=parseInt(b,10);this.__eIN.checked=b?1:0;window[this.__eIN.checked?'addcss':'removecss'](this._main,'checked');}
return this.__eIN.checked?true:false;};_me._title=function(sTitle){var eLbl=this._main.getElementsByTagName('label');eLbl=eLbl[0]||false;if(sTitle){if(!eLbl){eLbl=mkElement('label',{className:'unselectable'});this._main.appendChild(eLbl);}
this.__title=sTitle;eLbl.innerHTML=getLang(sTitle);}
else
if(typeof sTitle!='undefined'){if(eLbl)eLbl.parentNode.removeChild(eLbl);this.__title='';}
eLbl=null;return this.__title;};

/* client/inc/obj_checkbox_inverse.js */
_me=obj_checkbox_inverse.prototype;function obj_checkbox_inverse(){};_me.__constructor=function(){this.__eIN.checked=true;};_me._value=function(b){if(Is.Defined(b)){if(Is.String(b))b=parseInt(b,10);this._checked(b?false:true);}
else
return this._checked()?0:1;};

/* client/inc/obj_checkbox_list.js */
_me=obj_checkbox_list.prototype;function obj_checkbox_list(){};_me.__constructor=function(){this._useslang=false;this.__disabled=false;var me=this;this._main.onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(me.__disabled||(elm.tagName!='INPUT'&&elm.tagName!='LABEL'))return;if(me._onclick)me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});};};_me._fill=function(aData){var elm0,elm1,elm2;for(var i=0;i<aData.length;i++){elm0=mkElement('div');elm1=mkElement('input',{"type":'checkbox',"name":this._pathName+'/'+i,"id":this._pathName+'/'+i});elm0.appendChild(elm1);if(aData[i]){elm2=mkElement('label',{"for":this._pathName+'/'+i});elm2.innerHTML=this._useslang?getLang(aData[i]):aData[i];elm0.appendChild(elm2);}
this._main.appendChild(elm0);elm1.className=this._type;elm0=elm1=elm2=null;}};_me._value=function(v)
{if(typeof v=='object')
{var bChecked;for(var i=0;i<this._main.elements.length;i++)
{bChecked=false;for(var n in v)
if(v[n]==i)
{bChecked=true;break;}
if(bChecked)
this._main.elements[i].checked=true;else
this._main.elements[i].checked=false;}}
else
{v=[];for(var i=0;i<this._main.elements.length;i++)
if(this._main.elements[i].checked)
v.push(i);return v;}};_me._disabled=function(b){this.__disabled=b=(b==true);for(var i=0;i<this._main.elements.length;i++)
this._main.elements[i].disabled=b;};_me.__update=function(sDataSet){if(!sDataSet)return;if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));else
if(this._listener_data==sDataSet)
this._fill(dataSet.get(this._listener_data,this._listenerPath_data));};

/* client/inc/obj_checkbox_value.js */
_me=obj_checkbox_value.prototype;function obj_checkbox_value(){};_me._value=function(b){if(Is.Defined(b))
this.__eIN.value=b;else
return this.__eIN.value;};_me._checked=function(b){if(Is.Defined(b)){if(this.__eIN.checked!=b){if(this._onchange)this._onchange();this.__exeEvent('onchange',null,{"owner":this});}
this.__eIN.checked=b?1:0;}
return this.__eIN.checked?true:false;};

/* client/inc/obj_color.js */
_me=obj_color.prototype;function obj_color(){};_me.__constructor=function(sColor){var me=this;this.__value='';var colors=[['FFEEEE','FFCCCC','FFAAAA','FF8888','FF6666','FF4444','FF2222','FF0000','EE0000','CC0000','AA0000','880000','770000','660000','550000','440000','330000'],['FFEEFF','FFCCFF','FFAAFF','FF88FF','FF66FF','FF44FF','FF22FF','FF00FF','EE00EE','CC00CC','AA00AA','880088','770077','660066','550055','440044','330033'],['EEEEFF','CCCCFF','AAAAFF','8888FF','6666FF','4444FF','2222FF','0000FF','0000EE','0000CC','0000AA','000088','000077','000066','000055','000044','000033'],['EEFFFF','CCFFFF','AAFFFF','88FFFF','66FFFF','44FFFF','22FFFF','00FFFF','00EEEE','00CCCC','00AAAA','008888','007777','006666','005555','004444','003333'],['EEFFEE','CCFFCC','AAFFAA','88FF88','66FF66','44FF44','22FF22','00FF00','00EE00','00CC00','00AA00','008800','007700','006600','005500','004400','003300'],['FFFFEE','FFFFCC','FFFFAA','FFFF88','FFFF66','FFFF44','FFFF22','FFFF00','EEEE00','CCCC00','AAAA00','888800','777700','666600','555500','444400','333300'],['FFF0D0','FFEECC','FFEEBB','FFDDAA','FFCC99','FFC090','EEBB88','DDAA77','CC9966','BB8855','AA7744','886633','775522','664411','553300','442200','331100'],['FFFFFF','EEEEEE','DDDDDD','CCCCCC','BBBBBB','AAAAAA','A0A0A0','999999','888888','777777','666666','555555','444444','333333','222222','111111','000000']];var str='<table class="obj_colortable1">';for(var i in colors){str+='<tr>';for(var j in colors[i])
str+='<td bgcolor="#'+colors[i][j]+'" id="'+this._pathName+'#'+colors[i][j]+'"></td>';str+='</tr>';}
str+='</table>';var tbl=this._getAnchor('main');tbl.innerHTML=str;tbl.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='TD'&&elm.id)
me._value(elm.id.substring(elm.id.lastIndexOf('#')));};};_me._value=function(v,bNoChange){if(v){v=v.replace('#','');if(this.__value==v||!v.match(/^[0-9a-f]{6}$/gi))return false;var elm;if(this.__value&&(elm=document.getElementById(this._pathName+'#'+this.__value.toUpperCase())))
removecss(elm,'active');if((elm=document.getElementById(this._pathName+'#'+v.toUpperCase())))
addcss(elm,'active');this.__value=v;if(!bNoChange&&this._onchange)
this._onchange(v);}
else
return this.__value;};

/* client/inc/obj_colorpicker.js */
_me=obj_colorpicker.prototype;function obj_colorpicker(){};_me.__constructor=function(){var me=this;this.__value=[0,0,0.5];this.__eCross=this._getAnchor('cross');this.__ePallete=this._getAnchor('palette');this.__eLight=this._getAnchor('light');this.__eArrow=this._getAnchor('arrow');this.__ePallete.onmousedown=function(e){var e=e||window.event;this.__size=getSize(this);gui._obeyEvent('mouseup',[me,'_disobey_movecolor']);gui._obeyEvent('mousemove',[me,'_movecolor']);me._movecolor(e);};this.__eLight.onmousedown=function(e){var e=e||window.event;this.__size=getSize(this);gui._obeyEvent('mouseup',[me,'_disobey_movelight']);gui._obeyEvent('mousemove',[me,'_movelight']);me._movelight(e);};this.r._range(0,255);this.g._range(0,255);this.b._range(0,255);this._value('#888888');this.r._onchange=function(){me._rgb_value([me.r._value(),me.g._value(),me.b._value()]);};this.g._onchange=function(){me._rgb_value([me.r._value(),me.g._value(),me.b._value()]);};this.b._onchange=function(){me._rgb_value([me.r._value(),me.g._value(),me.b._value()]);};this._getAnchor('standard').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.getAttribute('rel'))
me._value(elm.getAttribute('rel'))};this.rgb._restrict('^#[0-9a-f]{6}$',true);this.rgb._onchange=function(e){if(this._checkError.length==0)
me._value(this._value());};};_me._movecolor=function(){var x=gui.__X-this.__ePallete.__size.x,y=gui.__Y-this.__ePallete.__size.y;x=x>0?(x<this.__ePallete.__size.w?x:this.__ePallete.__size.w):0;y=y>0?(y<this.__ePallete.__size.h?y:this.__ePallete.__size.h):0;this._hsl_value([x/this.__ePallete.clientWidth,(this.__ePallete.clientHeight-y)/this.__ePallete.clientHeight]);};_me._disobey_movecolor=function(){gui._disobeyEvent('mousemove',[this,'_movecolor']);return false;};_me._movelight=function(){var y=gui.__Y-this.__eLight.__size.y;y=y>0?(y<this.__eLight.__size.h?y:this.__eLight.__size.h):0;var l=(this.__eLight.__size.h-y)/this.__eLight.__size.h;this._hsl_value(['','',l]);};_me._disobey_movelight=function(){gui._disobeyEvent('mousemove',[this,'_movelight']);return false;};_me._rgb_value=function(v){if(Is.Array(v)){var hsl=colors.rgb2hsl(v[0],v[1],v[2]);this._hsl_value([hsl[0],hsl[1],hsl[2]]);}
else
return colors.hsl2rgb(this.__value[0],this.__value[1],this.__value[2]);};_me._hsl_value=function(v){if(Is.Array(v)){var old=this._value();if(Is.Number(v[0]))
this.__value[0]=v[0];if(Is.Number(v[1]))
this.__value[1]=v[1];if(Is.Number(v[2]))
this.__value[2]=v[2];this.__eCross.style.left=(this.__value[0]*this.__ePallete.clientWidth-this.__eCross.offsetWidth/2)+'px';this.__eCross.style.bottom=(this.__value[1]*this.__ePallete.clientHeight-this.__eCross.offsetHeight/2)+'px';var c=colors.hsl2rgb(this.__value[0],this.__value[1],0.5),regEx=/^(\d{1})$/g;this.__eLight.style.background='#'+c[0].toString(16).replace(regEx,'0$1')+c[1].toString(16).replace(regEx,'0$1')+c[2].toString(16).replace(regEx,'0$1');this.__eArrow.style.bottom=(this.__value[2]*this.__eLight.clientHeight-this.__eArrow.offsetHeight/2)+'px';c=this._value();if(old==c)return;var rgb=this._rgb_value();this.r._value(rgb[0],true);this.g._value(rgb[1],true);this.b._value(rgb[2],true);this.rgb._value(c,true);this._getAnchor('color').style.background=c;}
else
this.__value;};_me._value=function(v){if(Is.String(v)){if(v.indexOf('#')===0)
v=v.substr(1);this._rgb_value([parseInt(v.substring(0,2),16),parseInt(v.substring(2,4),16),parseInt(v.substring(4,6),16)]);}
else{var rgb=this._rgb_value(),regEx=/^(\d{1})$/g;return'#'+rgb[0].toString(16).replace(regEx,'0$1')+rgb[1].toString(16).replace(regEx,'0$1')+rgb[2].toString(16).replace(regEx,'0$1');}};

/* client/inc/obj_comment.js */
function obj_comment(){};_me=obj_comment.prototype;_me.__constructor=function(aData){this.__aData=aData;this.__aid=aData.aid;this.__fid=aData.fid;this.__iid=aData.EVNCOMEVNID||aData.EVN_ID;this._create('list','obj_groupchat','','noborder');this.list.__options.comments=false;this.list._onerror=function(){this.text&&this.text._disabled(true);}.bind(this);this.list._serverSort({aid:this.__aid,fid:this.__fid},true,{sys_search:'comments:'+(WMItems.__serverID(this.__iid))});this.tabs={room:{list:this.list}};if(WMFolders.getRights([this.__aid,this.__fid]).write){this._create("text","obj_chat_input","","",{parseurl:true,block:true,remember:true,remember_path:[this.__fid,this.__iid],smiles_enabled:GWOthers.getItem('CHAT','smiles')=='1',handlers:{file:[this.upload,'_click'],attach:[this,'_attachFile'],event:[this,'_addEvent',[WMItems.__serverID(this.__iid)]],code:[this,'_code']},memory:{set:[function(val){dataSet.add('teamchat',[this.__fid,this.__iid,'input'],val,true);}.bind(this)],get:[function(){return dataSet.get('teamchat',[this.__fid,this.__iid,'input'])||'';}.bind(this)]}});this.text._folder({aid:this.__aid,fid:this.__fid});this.text.input._placeholder(getLang('IM::COMMENT_PH'));this.text._onsubmit=function(v,arg){if(v.length||(arg&&arg.url)){arg=arg||{};arg.comevnid=WMItems.__serverID(this.__iid);this._message(v,arg,this.text.__private);}else
return false;}.bind(this);this._create('upload','obj_upload');this.upload._onuploadstart=function(){this.text._create('info','obj_upload_info','block');addcss(this.text._main,'block');this.__upload_buffer=[];}.bind(this);this.upload._onuploadend=function(){removecss(this.text._main,'block');this.text.info&&this.text.info._destruct();if(!this._destructed&&this.__upload_buffer.length){if(this.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',this.__upload_buffer[0].description,'',{aid:this.__aid,fid:this.__fid},[function(sName,sDesc,aArgs){if(!this._destructed)
this.__uploadhandler(this.__upload_buffer,sName,sDesc,aArgs,WMItems.__serverID(this.__iid));}.bind(this)]);}
else
this.__uploadhandler(this.__upload_buffer,'','','',WMItems.__serverID(this.__iid));}}.bind(this);this.upload._onuploadsuccess=function(file){this.text.info&&this.text.info._handler(null);this.__upload_buffer.push({'class':'file','description':file.name,'size':file.size,'fullpath':file.folder+'/'+file.id});}.bind(this);this.upload._onuploadprogress=function(file,a,b,xhr){this.text.info&&this.text.info._value(file.name,a,b,[function(){xhr.abort()}]);}.bind(this);}};_me._code=function(){gui._create('insert_code','frm_insert_code','','',[function(sBody){this._message(sBody,{comevnid:WMItems.__serverID(this.__iid)});}.bind(this)]);};_me._attachFile=function(){if(this.__aid&&this.__fid){var sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[this.__aid,sFolder]))
sFolder='';gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[this,'__addItems'],this.__aid,sFolder,'','r',false,['F','X']);}};_me.__addItems=function(files){this.__upload_buffer=[];files.forEach(function(file){this.__upload_buffer.push({'class':'item','description':file.title,'size':file.size,'fullpath':file.fullpath});},this);if(this.__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',this.__upload_buffer[0].description,'',{aid:this.__aid,fid:this.__fid},[function(sName,sDesc,aArgs){this.__uploadhandler(this.__upload_buffer,sName,sDesc,aArgs,WMItems.__serverID(this.__iid));}.bind(this)]);}else
this.__uploadhandler(this.__upload_buffer);};_me._message=function(){storage.library('frm_comment');frm_comment.prototype._message.apply(this,arguments);};_me._response=function(){storage.library('frm_comment');frm_comment.prototype._response.apply(this,arguments);};_me.__uploadhandler=function(){storage.library('frm_main_chat');frm_main_chat.prototype.__uploadhandler.apply(this,arguments);};_me._addEvent=function(){storage.library('frm_main_chat');frm_main_chat.prototype._addEvent.apply(this,arguments);};

/* client/inc/obj_conference_home.js */
_me=obj_conference_home.prototype;function obj_conference_home(){};_me.__constructor=function(){this.__opt={schedule:dataSet.get('accounts',[sPrimaryAccount,'MEETING_PROVIDER'])==='jitsi'};this._draw('obj_conference_home','cell',{schedule:this.__opt.schedule});this.btn_start._onclick=function(){storage.library('wm_conference');if(dataSet.get('main',['conference'])){wm_conference.get(dataSet.get('main',['conference'])).join();this._view('progress');}else{this._view('name');}}.bind(this._parent);if(this.btn_schedule)
this.btn_schedule._onclick=function(){this._view('schedule');}.bind(this._parent);};

/* client/inc/obj_conference_name.js */
_me=obj_conference_name.prototype;function obj_conference_name(){};_me.__constructor=function(){this.__opt={back_button:getLang('FORM_BUTTONS::BACK')};this._draw('obj_conference_name','cell');gui._obeyEvent('conference_window_closed',[function(){me._parent._view('home');}]);var password=this.password,name=this.name,label=this.label,btn_continue=this.btn_continue,aPassword=this._getAnchor('password'),me=this;btn_continue._onclick=function(){if(!name._checkError.length){btn_continue._disabled(true);me._create('loader','obj_loader','');storage.library('wm_conference');wm_conference.create(function(conference){me._parent._view('home',false,true);conference.join();},{subject:name._value(),password:password._value()});}};name._restrict("\\S+");name._onerror=function(b){btn_continue._disabled(b);};name._onsubmit=btn_continue._onclick;label._onclick=function(){if(hascss(aPassword,'hidden')){storage.library('wordGen','wordGen');password._value(password._value()||(wordGen()+(Math.random()*899999999+100000000)).slice(0,10));label._value(getLang('CONFERENCE::REMOVE_PASSWORD'));removecss(aPassword,'hidden');password.__eIN.select();}else{password._value('');label._value(getLang('CONFERENCE::SET_PASSWORD'));addcss(aPassword,'hidden');name._focus();}};};

/* client/inc/obj_conference_progress.js */
_me=obj_conference_progress.prototype;function obj_conference_progress(){};_me.__constructor=function(){this.__opt={participant_delay:1000,show_all:false,back_button:getLang('CONFERENCE::BACK_TO_MAIN')};this.__init();this.__getParticipants(this.__opt.participant_delay,[this,'__updateParticipants']);this._add_destructor('__destructor');};_me.__destructor=function(){clearTimeout(this.__initTimeout);gui._disobeyEvent('conference_event',[this,'__updateEvent']);};_me.__getParticipants=function(iDelay,aHandler){clearTimeout(this.__initTimeout);this.__initTimeout=setTimeout(function(){var conference=wm_conference.get(dataSet.get('main',['conference']));if(!conference.data.server){return this.__getParticipants(iDelay,aHandler);}
getRemoteFileContent(conference.data.server+'/room?'+buildURL({token:conference.data.jwt,room:conference.data.roomname}),function(str){if(str){try{this.__participants=JSON.parse(str)||[];}
catch(r){console.error('obj_conference_progress','unable to load participants list');this.__participants=[];}
if(!this.__participants.length){return this.__getParticipants(iDelay,aHandler);}
executeCallbackFunction(aHandler);}
else if(!this._destructed){this.__getParticipants(iDelay,aHandler);}}.bind(this));}.bind(this),iDelay||0);};_me.__init=function(){var conference=wm_conference.get(dataSet.get('main',['conference']));this._draw('obj_conference_progress','cell');this._create('loader','obj_loader','list');this._create('scrollbar','obj_scrollbar')._scrollbar(this._main.querySelector('div.scroll'),this._main);this._getAnchor('title').textContent=conference.data.subject||getLang('CONFERENCE::UNSCHEDULED');if(conference.data.password){this.MEETING_PASSWORD._value(conference.data.password);this.MEETING_PASSWORD.__setMask({'toggle':['',getLang('COMMON::SHOW'),2]},[function(){if(this.MEETING_PASSWORD.__eIN.getAttribute('type')==='text'){this.MEETING_PASSWORD.__eIN.setAttribute('type','password');}else{this.MEETING_PASSWORD.__eIN.setAttribute('type','text');}}.bind(this)]);}else{this._getAnchor('password_wrapper').parentNode.removeChild(this._getAnchor('password_wrapper'));}
if(conference.data.startdate!=0){var sd=conference.data.startdate,st=conference.data.starttime,ed=conference.data.enddate,et=conference.data.endtime,start=IcewarpDate.julian(sd,st),end=IcewarpDate.julian(ed,et);if(st<0){if(sd==ed){this._getAnchor('date').textContent=CalendarFormatting.normal(start);}
else{this._getAnchor('date').textContent=start.format('L')+' - '+end.format('L');}}
else{this._getAnchor('date').textContent=CalendarFormatting.normalWithTime(start);if(sd<ed){this._getAnchor('date').textContent+=' - '+CalendarFormatting.normalWithTime(end);}else{this._getAnchor('date').textContent+=' - '+end.format('LT');}}}
else
if(!conference.data.subject){this._getAnchor('date').textContent=conference.id;}
this.avatar._value(conference.data.organizer);if(conference.data.organizer===sPrimaryAccount){this._getAnchor('organiser').innerHTML=getLang('CONFERENCE::YOU_ORGANISER');}
else{WMItems.list({"aid":sPrimaryAccount,"fid":'__@@ADDRESSBOOK@@__',filter:{search:'email:"'+conference.data.organizer+'"'},values:['ITMCLASSIFYAS']},'','','',[function(aData){if(aData&&(aData=aData[sPrimaryAccount])&&(aData=aData['__@@ADDRESSBOOK@@__'])){var name,i;for(i in aData){if(aData[i].LCTTYPE==='H'){name=aData[i].ITMCLASSIFYAS;break;}}}
this._getAnchor('organiser').innerHTML=getLang('CONFERENCE::IS_ORGANISER',['<span class="progress-link">'+(name||conference.data.organizer).escapeHTML()+'</span>']);this._getAnchor('organiser').querySelector(".progress-link").onclick=function(e){var e=e||window.event;this.avatar._menu();if(e.preventDefault)e.preventDefault();e.cancelBubble=true;return false;}.bind(this);}.bind(this)]);}
gui._obeyEvent('conference_event',[this,'__updateEvent']);this._getAnchor('show').onclick=function(){if(!this.__opt.show_all){this.__opt.show_all=true;removecss(this._main,'show_all');}}.bind(this);this.btn_link._onclick=function(){toClipboard(conference.getLink());}.bind(this);this.btn_share._onclick=function(){var sFolder,f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}
if(sFolder){var frm=gui._create('frm_select_folder','frm_select_folder','','frm_select_folder-conference','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,sFolder){var sBody=getLang('CONFERENCE::CHATINVITE',[conference.getLink()]);if(frm.pass&&frm.pass._checked()){sBody+="\r\n"+getLang('CONFERENCE::CONFERENCE_PASSWORD',[conference.data.password]);}
Item.message_tch(sFolder,sBody);}],true,true,['Y','I'],'',true);if(conference.data.password)
frm._create('pass','obj_checkbox',{target:'footer',first:true},'pass-conference','CONFERENCE::INCLUDE_PASSWORD');}}.bind(this);this.btn_send._onclick=function(){var sBody=conference.getLink();if(conference.data.password){sBody+='<br>'+getLang('CONFERENCE::CONFERENCE_PASSWORD',[conference.data.password]);}
NewMessage.compose({mailBody:sBody});}.bind(this);};_me.__updateParticipants=function(){if(this.__participants.length>5){!this.__opt.show_all&&addcss(this._main,'show_all');}
else{removecss(this._main,'show_all');}
var eList=this._getAnchor('list');while(eList.firstChild){eList.removeChild(eList.lastChild);}
this.__participants.sort(function(a,b){return(a.display_name||a.email).localeCompare(b.display_name||b.email,undefined,{numeric:true,sensitivity:'base'});}).forEach(function(user){var elm=mkElement('div','',null,[mkElement('span',{class:'avatar',style:'background-image: url("'+getAvatarURL(user.email)+'")'}),mkElement('span',{class:'name',text:user.display_name||user.email})]);eList.appendChild(elm);}.bind(this));};_me.__updateEvent=function(data){switch(data.event){case'participantJoined':case'participantLeft':this.__getParticipants(0,[this,'__updateParticipants']);break;}};

/* client/inc/obj_conference_schedule.js */
_me=obj_conference_schedule.prototype;function obj_conference_schedule(){};_me.__constructor=function(){this.__opt={back_button:getLang('FORM_BUTTONS::BACK')};this.__aValues={values:{_TZID:GWOthers.getItem('CALENDAR_SETTINGS','timezone')}};this._draw('obj_conference_schedule','cell');this.__init_date();this.title._onerror=function(b){this.btn_save._disabled(b);}.bind(this);this.title._restrict(".+");this.btn_save._onclick=function(){this.__save();}.bind(this);this._getAnchor('link_more').onclick=function(){var val=this.__value(),aOut=val.values;Object.keys(val).forEach(function(k){if(k!='values')
aOut[k]=val[k];});if(Is.Array(aOut.ATTACHMENTS)){aOut.ATTACHMENTS=aOut.ATTACHMENTS.map(function(att){return{values:{ATTDESC:att.values.description,ATTTYPE:att.values.class,FULLPATH:att.values.fullpath,ATTSIZE:att.values.size}};});}
var frm=Item.openwindow([sPrimaryAccount,Mapping.getDefaultFolderForGWType('E')],aOut,null,null,[function(){}]);frm._modal(true);frm.MEETING_ACTION._disabled(true);frm.X_PATH._disabled(true);frm.x_btn_cancel._destruct();frm.x_btn_ok._value('FORM_BUTTONS::OK');frm.x_btn_ok._onclick=function(){frm._closeNote()
this.__value(frm.__readItems(true));frm._destruct();}.bind(this);}.bind(this);this.label._onclick=function(){var aPassword=this._getAnchor('password');if(hascss(aPassword,'hidden')){storage.library('wordGen','wordGen');this.password._value(this.password._value()||(wordGen()+(Math.random()*899999999+100000000)).slice(0,10));this.label._value(getLang('CONFERENCE::REMOVE_PASSWORD'));removecss(aPassword,'hidden');this.password.__eIN.select();}else{this.label._value(getLang('CONFERENCE::SET_PASSWORD'));addcss(aPassword,'hidden');this.title._focus();}}.bind(this);this._create('scrollbar','obj_scrollbar')._scrollbar(this._main.querySelector('div.scroll'),this._main);this.note.__maxHeight=350;};_me.__init_date=function(){var d=new IcewarpDate();this.__start(d);this.__end(d.add(30,'minutes'));this.starttime._onchange=this.startdate._ondateselect=function(){var ds=this.__start();if(!this.starttime._disabled()){ds.add(15,'minutes');}
if(!ds.isBefore(this.__end())){this.__end(ds);}}.bind(this);this.endtime._onchange=this.enddate._ondateselect=function(){var de=this.__end();if(!this.endtime._disabled()){de.subtract(15,'minutes');}
if(!de.isAfter(this.__start())){this.__start(de);}}.bind(this);};_me.__start=function(d){var startDate;if(d){startDate=IcewarpDate.unix(Math.ceil((+d/1000)/(15*60))*15*60);this.startdate._value(startDate,true);this.starttime._value(startDate.format(IcewarpDate.JULIAN_TIME)*60000,true);}
else
if(this.starttime._disabled())
return IcewarpDate.julian(this.startdate._value());else
return IcewarpDate.julian(this.startdate._value(),this.starttime._value()/60000);};_me.__end=function(d){if(d){var endDate=IcewarpDate.unix(Math.ceil((+d/1000)/(15*60))*15*60);this.enddate._value(endDate,true);this.endtime._value(endDate.format(IcewarpDate.JULIAN_TIME)*60000,true);}
else
if(this.endtime._disabled())
return IcewarpDate.julian(this.enddate._value());else
return IcewarpDate.julian(this.enddate._value(),this.endtime._value()/60000);};_me.__value=function(aValue){if(aValue){this.__aValues=aValue;this.title._value(aValue.values.EVNTITLE);if(aValue.values.MEETING_PASSWORD){this.password._value(aValue.values.MEETING_PASSWORD);this.label._value(getLang('CONFERENCE::REMOVE_PASSWORD'));removecss(this._getAnchor('password'),'hidden');}
this.startdate._value(aValue.values._TZEVNSTARTDATE,true);if(aValue.values.EVNSTARTTIME==-1){this.starttime._disabled(true);this.starttime._value(0,true);}
else{this.starttime._disabled(false);this.starttime._value(aValue.values._TZEVNSTARTTIME*60000,true);}
this.enddate._value(aValue.values._TZEVNENDDATE,true);if(aValue.values.EVNENDTIME==-1){this.endtime._disabled(true);this.endtime._value(0,true);}
else{this.endtime._disabled(false);this.endtime._value(aValue.values._TZEVNENDTIME*60000,true);}
this.note._value(aValue.values.EVNNOTE);if(aValue.CONTACTS){this.attendees._value(aValue.CONTACTS.map(function(cnt){return MailAddress.createEmail(cnt.values.CNTCONTACTNAME,cnt.values.CNTEMAIL);}).join(';'));}
else
this.attendees._value('');}
else{var cnt=[];MailAddress.splitEmailsAndNames(this.attendees._value()).forEach(function(user){cnt.push({'values':{CNTCONTACTNAME:user.name,CNTEMAIL:user.email,CNTROLE:'Q'}});});var aDate;if(this.startdate._disabled()){aDate={EVNSTARTDATE:this.startdate._value(),EVNSTARTTIME:-1,EVNENDDATE:this.enddate._value(),EVNENDTIME:-1};}
else{aDate={_TZEVNSTARTDATE:this.startdate._value(),_TZEVNSTARTTIME:this.starttime._value()/60000,_TZEVNENDDATE:this.enddate._value(),_TZEVNENDTIME:this.endtime._value()/60000,};}
var aOut=this.__aValues;aOut.values=Object.assign(this.__aValues.values,{conference:true,EVNSHARETYPE:'U',EVNTIMEFORMAT:'Z',EVNFLAGS:1,MEETING_ACTION:1,MEETING_PASSWORD:hascss(this._getAnchor('password'),'hidden')?'':this.password._value(),EVNTITLE:this.title._value(),EVNNOTE:this.note._value(),EVNDESCFORMAT:'text/html'},aDate);if(cnt.length)
aOut.CONTACTS=cnt;if(this.starttime._disabled()){Object.keys(aOut.values).forEach(function(k){if(k.indexOf('_TZ')===0)
delete aOut.values[k];});}
return aOut;}};_me.__save=function(){this.btn_save._disabled(true);this._create('loader','obj_loader','');WMItems.add([sPrimaryAccount,Mapping.getDefaultFolderForGWType('E')],this.__value(),'','','',[function(bOK,aData){this.btn_save._disabled(false);this.loader._destruct();gui.notifier._value({type:'item_saved',args:[sPrimaryAccount,Mapping.getDefaultFolderForGWType('E')]});this.__updateList(bOK,aData);}.bind(this)]);};_me.__updateList=function(bOk,aData){if(bOk){if(gui.socket){var f=dataSet.get('folders',[sPrimaryAccount,Mapping.getDefaultFolderForGWType('E')]);if(f){var aOut={'ACTION':'add','TYPE':'item','ITEM':aData.id,'FOLDER':f.RELATIVE_PATH,'FOLDER-TYPE':f.TYPE,'EMAIL':sPrimaryAccount,'ITEM-TYPE':'E','owner':this._pathName};gui.socket.api._notify(aOut);}}
this._parent._view('home',null,true);}};

/* client/inc/obj_contact.js */
_me=obj_contact.prototype;function obj_contact(){};_me.__constructor=function(v){this._fullname=false;this._imonly=false;var me=this;this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'){var rel=elm.getAttribute('rel');if(rel){var aMail=MailAddress.splitEmailsAndNames(rel);if(aMail&&aMail.length){var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',aMail[0].name,aMail[0].email,'',{nomail:me._imonly,noadd:true});cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);}
if(e.preventDefault)e.preventDefault();e.cancelBubble=true;return false;}}};this._listen('xmpp');if(v)
this._value(v);};_me._fill=function(emails){var out='',stat,bIM=gui.frm_main&&gui.frm_main.im&&gui.frm_main.im._is_active();for(var i in emails)
out+='<a class="'+(emails[i].email?'address':'')+(bIM&&(stat=gui.frm_main.im._inRoster(emails[i].email))?' im_'+stat.escapeXML(true):'')+(emails[i].email==sPrimaryAccount?' primary':'')+'"'+(emails[i].email?' rel="'+MailAddress.createEmail(emails[i].name,emails[i].email).escapeXML(true)+'" title="'+getLang('ITEMVIEW::MESSAGE_TO',[emails[i].email.escapeXML(true)])+'"':'')+'>'+(this._full?MailAddress.createEmail(emails[i].name,emails[i].email,true):(emails[i].name||emails[i].email)).escapeXML()+'</a>';this._main.innerHTML=out;};_me._value=function(v){if(Is.String(v))
v=MailAddress.splitEmailsAndNames(v.unescapeXML());if(Is.Array(v))
this._fill(v);};_me.__update=function(sName,aPath){if(sName=='xmpp'){var tmp,links=this._main.getElementsByTagName('A');if(aPath&&aPath[0]=='roster'&&aPath[1]&&aPath[2]=='show'){for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&(tmp=MailAddress.splitEmailsAndNames(links[i].rel))&&(tmp=tmp[0]))
if(tmp.email.toLowerCase()==aPath[1])
links[i].className='address im_'+gui.frm_main.im._inRoster(aPath[1]);}
else
if(!gui.frm_main.im._is_active())
for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&hascss(links[i],'address'))
links[i].className='address';}};

/* client/inc/obj_container.js */
_me=obj_container.prototype;function obj_container(){};_me.__constructor=function(){var me=this;this._scrollbar(this._getAnchor('core'),this._getAnchor('core').parentNode);var eHeader=this.__eHeader=this._getAnchor('header');var eExpander=this.__eExpander=this._getAnchor('core').parentNode
var eFooter=this.__eFooter=this._getAnchor('footer');if(/MSIE [89]/.test(navigator.userAgent)){function iebox(e){var dh=eHeader.offsetHeight+eFooter.offsetHeight;eExpander.style.height=(me._main.offsetHeight-dh)+'px';}
eHeader.onresize=iebox;this._main.onresize=iebox;eFooter.onresize=iebox;iebox();}
if(/^Opera/i.test(navigator.userAgent)&&window.getComputedStyle&&window.getComputedStyle(gui.test.content._main,null).display!='flex'){this._tablerize();}};_me._tablerize=function(){var tr1=this._main.appendChild(document.createElement('div'));tr1.appendChild(this.__eHeader);var tr2=this._main.appendChild(document.createElement('div'));tr2.appendChild(this.__eExpander);var tr3=this._main.appendChild(document.createElement('div'));tr3.appendChild(this.__eFooter);this._main.style.display='table';tr1.style.display=tr2.style.display=tr3.style.display='table-row';this.__eHeader.style.display=this.__eExpander.style.display=this.__eFooter.style.display='table-cell';this.__eExpander.style.height='100%';}

/* client/inc/obj_context.js */
_me=obj_context.prototype;function obj_context(){};_me.__constructor=function(owner){var me=this;this._owner=owner;this._zindex=new cMaxZIndex();AttachEvent(this._main,'onclick',function(e){var e=(e||window.event);e.__source={obj:me,skip:true,type:'obj_context'};});gui._obeyEvent('click',[this,'__destructCmenu']);this._add_destructor('__destructClickEvn');};_me.__destructCmenu=function(e){var elm;if(Is.Child(e.target||e.srcElement,this._main)&&(elm=Is.Child(e.target||e.srcElement,'LI',this._main))&&(elm=elm.firstChild)&&elm.tagName=='DIV'&&Is.Defined(elm.id)){var id=elm.id.substr(this._pathName.length+1);if(this.__idtable[id]&&this.__idtable[id].keep){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return true;}}
if(!this._onclose||this._onclose(true)!==false)
this._destruct();};_me.__destructClickEvn=function(){gui._disobeyEvent('click',[this,'__destructCmenu']);if(this._onclose)
this._onclose();if(this.__zindex)
this._zindex.remove(this.__zindex);};_me._onclick=function(e,elm,id,arg){if(arg)
executeCallbackFunction(arg);};_me._place=function(x,y,ws,vertical,right){if(!this.__eArrow)
this.__eArrow=this._main.appendChild(mkElement('div'));if(Is.Number(ws)){var ul=this._main.getElementsByTagName('UL');if(ul&&(ul=ul[0]))ul.style.width=ws+'px';}
var pos=getSize(this._main),h=window.innerHeight||window.document.body.clientHeight,w=window.innerWidth||window.document.body.offsetWidth,bottom=false;if(pos.w>300)pos.w=220;if(vertical){ex=x;x-=pos.w/2;x=x<0?0:x;if(x+pos.w>w)
x=w-pos.w;}
else{if(h&&y+pos.h>h){this.__eArrow.style.top=(y-h+pos.h+9)+'px';y=h-pos.h;}
y-=16;if((w&&x+pos.w+7>w)){x-=pos.w+9;addcss(this._main,'left');}
else
x+=7;}
if((!right&&gui._rtl)||(right&&!gui._rtl)){addcss(this._main,'right');this._main.style.left='auto';this._main.style.right=(document.body.clientWidth-x-pos.w)+'px';if(vertical){this.__eArrow.style.left='auto';this.__eArrow.style.right=(document.body.clientWidth-(document.body.clientWidth-x-pos.w)-ex)+'px';}}
else{removecss(this._main,'right');this._main.style.left=x+'px';if(vertical){this.__eArrow.style.left=(ex-x)+'px';this.__eArrow.style.right='auto';}}
if(pos.h>h){addcss(this._main,'scrollable');}
else
if(vertical==3||(vertical==2&&y+pos.h>h)){if(pos.h>y){addcss(this._main,'scrollable');}else{addcss(this._main,'bottom');this._main.style.bottom=(h-y)+'px';bottom=true;}}
else{if(vertical)
addcss(this._main,'top');this._main.style.top=y+'px';}
if(this.__zindex)
this._zindex.remove(this.__zindex);this._main.style.zIndex=this.__zindex=this._zindex.get();this.__position={x:x,y:y,bottom:bottom,right:right};if(!this.__position.bottom&&!this.__position.right){gui._obeyEvent('resize',[this,'__onGuiResize']);this._add_destructor('__destructResizeEvn');}};_me.__onGuiResize=function(){var pos=getSize(this._main),h=window.innerHeight||window.document.body.clientHeight,w=window.innerWidth||window.document.body.offsetWidth;if(!this.__position.bottom){if(pos.y+pos.h+7>h||pos.y!=this.__position.y){this._main.style.top=Math.min(h-pos.h-7,this.__position.y)+'px';}}
if(!this.__position.right){if(pos.x+pos.w+7>w||pos.x!=this.__position.x){this._main.style.left=Math.min(w-pos.w-7,this.__position.x)+'px';}}};_me.__destructResizeEvn=function(){gui._disobeyEvent('resize',[this,'__onGuiResize']);};

/* client/inc/obj_context_folder.js */
_me=obj_context_folder.prototype;function obj_context_folder(){};_me._onclick=function(e,elm,id,arg){var me=this;if(!arg)return true;var ftype=dataSet.get('folders',[arg.aid,arg.fid,'TYPE']);switch(arg['method'])
{case'upload':gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[gui.frm_main,'__copyItem',[[arg.aid,arg.fid]]],arg.aid,arg.fid,'','r',false,['F','I','X'],'X');break;case'tree_mode':Cookie.set(['hide_tree'],arg.v||'');gui.frm_main._resize_handler();break;case'view':gui.frm_main.bar.tree.folders._setActive(arg.aid+'/'+arg.fid,true);gui.frm_main._selectView({'aid':arg.aid,'fid':arg.fid},'',false,'',arg.search?true:false,arg.search);break;case'default':WMFolders.add({'aid':arg.aid,'fid':arg.fid,'default':arg['default']},'folders','');break;case'filter':addcss(this._owner._main,'obj_tree_search');this._owner.inp_search._focus();break;case'share':gui._create('frm_sharing','frm_sharing','',~['I','Y'].indexOf(WMFolders.getType(arg))?'teamchat_folder':'',void 0,{aid:arg.aid,fid:arg.fid});break;case'add_favorite':if(gui.frm_main.bar&&gui.frm_main.bar.fav)
gui.frm_main.bar.fav._ondrop({value:[{aid:arg.aid,fid:arg.fid}],type:'folder'});break;case'new_template':NewMessage.compose({template:true});break;case'subscribe':case'unsubscribe':if(gui.frm_main.bar&&gui.frm_main.bar.top&&gui.frm_main.bar.top.switch){if(this._owner._getTreeId){elm=document.getElementById(this._owner._getElmId(this._owner._getTreeId(arg.aid+'/'+arg.fid)));gui.frm_main.bar.top.switch.__unsubscribeRoom(elm,arg,[function(){WMFolders.subscribe(arg,'folders','',arg['method']=='subscribe'?1:0);}]);}
else{WMFolders.subscribe(arg,'folders','',arg['method']=='subscribe'?1:0,[function(){gui.frm_main.bar.top.switch.__unsubscribeRoom(null,arg);}]);}}
else
WMFolders.subscribe(arg,'folders','',arg['method']=='subscribe'?1:0);break;case'add_account':gui._create('add_account','frm_addaddress','','',[this,'__addSharedFolder'],['ADDRESS_BOOK::SELECTED_ADDRESSES'],[''],'','',3);break;case'unsubscribe_folder':var sSType=dataSet.get('folders',[arg.aid,arg.fid,'SUBSCRIPTION_TYPE']);if(sSType=='folder')
WMAccounts.unsubscribe({aid:arg.aid,subscription:[arg.fid]},[function(bOK){if(bOK){if(dataSet.get('active_folder')==arg.aid+'/'+arg.fid)
gui.frm_main._selectView();}}]);break;case'cal_color':if(arg.fid&&arg.color){getCalendarColor(arg.fid.str_replace('\\','/'),arg.color);me._owner.__update('folders');gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@EVENTS@@__'},'',true);}
break;case'add_virtual':gui._create('frm_virtual','frm_virtual','','',arg.fid,'',[obj_context_folder.__openFolder]);break;case'add_folder':Folder.addFolder(arg,[obj_context_folder.__openFolder]);break;case'add_room':gui._create('frm_addroom','frm_addroom','','',arg.aid,arg.fid,[obj_context_folder.__openFolder]);break;case'clone':var org=dataSet.get('folders',[arg.aid,arg.fid]);if(org.TYPE=='I'&&(org.NAME||org.RELATIVE_PATH)){var sFolderName=[org.NAME||Path.basename(org.RELATIVE_PATH),getLang('CHAT::CLONE')].join(' '),aData={'type':org.TYPE,'aid':sPrimaryAccount,'clone':arg.aid+'/'+arg.fid};if(org.OWNER&&~org.OWNER.indexOf('##internalservicedomain.icewarp.com##')){aData.name=org.OWNER+'/TeamChat/'+sFolderName;aData.private=true;}
else
aData.name=Path.basedir(arg.fid)+'/'+sFolderName;WMFolders.add(aData,'folders','',[function(aFolderInfo){if(aFolderInfo){var aData={aid:aFolderInfo.aid,fid:aFolderInfo.name};gui.frm_main._selectView(aData);obj_context_folder.__openFolder(aData);}}]);}
break;case'delete_folder':Folder.delete(arg);break;case'sendEmailToAllMembers':if(!arg.aid||!arg.fid){return;}
var newMessage=new NewMessage();newMessage.addSignature();var name=dataSet.get('folders',[arg.aid,arg.fid,'NAME'])||dataSet.get('folders',[arg.aid,arg.fid,'RELATIVE_PATH']);newMessage.sTo='['+arg.fid+'::'+name+']';newMessage.sSubject='';gui._create('frm_compose','frm_compose','','',newMessage);break;case'move_folder':if(ftype!='X'&&WMFolders.getRights(arg,'modify')){var frm=gui._create('frm_select_folder','frm_select_folder','','','POPUP_FOLDERS::MOVE_FOLDER',arg['aid'],arg['fid'],[function(aid,fid,f){obj_context_folder.__moveFolder(aid,f,(fid?fid+'/':'')+Path.basename(f));},[arg['fid']]],false,true);frm.tree_folder._isSelectable=function(idt){return idt.ftype!="X"||!!idt['public'];};}
else
gui.notifier._value({type:'alert',args:{header:'',text:'CONTEXT_FOLDER::CANTMOVE'}});break;case'save_folder':WMFolders.save_folder(arg);break;case'empty_folder':var sFullPath=arg['aid']+'/'+arg['fid'],sTrashFolder=GWOthers.getItem('DEFAULT_FOLDERS','trash'),sFolderType=WMFolders.getType(arg),frm;if(sFullPath==sTrashFolder||sFolderType=='R'||sFolderType=='G'||parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','delete_emptyfolder'))>0)
frm=gui._create('frm_confirm','frm_confirm','','',[function(){WMFolders.__emptyFolder(arg['aid'],arg['fid'],false,gui.frm_main.main.list._SQLsearch);}],'CONFIRMATION::EMPTY_FOLDER_CONFIRMATION','CONFIRMATION::EMPTY_FOLDER');else
frm=gui._create('frm_confirm','frm_confirm','','',[function(){WMFolders.__emptyFolder(arg['aid'],arg['fid'],true,gui.frm_main.main.list._SQLsearch);}],'CONFIRMATION::EMPTY_FOLDER_CONFIRMATION','CONFIRMATION::EMPTY_TO_TRASH');addcss(frm.x_btn_ok._main,'color2');break;case'mark_all_as_read':case'mark_all_as_unread':var bRead=arg['method']=='mark_all_as_read'?true:false;if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){OldMessage.markWithFlag([arg.aid,arg.fid,Object.getOwnPropertyNames(gui.frm_main.main.list._aData)],{'SEEN':bRead},true);}else{WMFolders.markItemsRead({'aid':arg.aid,'fid':arg.fid},'folders','',bRead);}
break;case'copyall':case'moveall':gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::'+(arg['method']=='copyall'?'COPY_MAIL_TO':'MOVE_MAIL_TO'),arg['aid'],arg['fid'],[this,'__copyOrMoveAll',[arg]],false,false,dataSet.get("folders",[arg['aid'],arg['fid'],'TYPE']),'w');break;case'change_channel':gui._create('frm_change_channel','frm_change_channel','','',arg.aid,arg.fid);break;case'rename_folder':if((ftype!='X'&&WMFolders.getRights(arg,'modify'))||(ftype=='I'&&WMFolders.getRights(arg,'write'))&&this._owner._rename)
this._owner._rename(arg);else
gui.notifier._value({type:'alert',args:{header:'',text:'CONTEXT_FOLDER::CANTRENAME'}});break;default:return true;}};_me.__copyOrMoveAll=function(sDestAccount,sDestFolder,arg){if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){var ids=[arg.aid,arg.fid,Object.getOwnPropertyNames(gui.frm_main.main.list._aData)],sAction='moveall'===arg.method?'move':'copy';Item.__copyOrMoveItems(sDestAccount,sDestFolder,sAction,ids);}else{if(sDestAccount!=arg.aid||sDestFolder!=arg.fid)
WMFolders.action(arg,'folders','',arg.method,{aid:sDestAccount,fid:sDestFolder});}};_me.__addSharedFolder=function(bOK,aAddresses){if(bOK&&aAddresses[0].length){var tmp,aAccountInfo={aid:sPrimaryAccount,subscription:[]};for(var i=0;i<aAddresses[0].length;i++){tmp=MailAddress.splitEmailsAndNames(aAddresses[0][i]);if(tmp&&tmp[0]&&tmp[0].email){if(tmp[0].email.indexOf('@')<0)
tmp[0].email+='@'+dataSet.get('main',['domain']);aAccountInfo.subscription.push(tmp[0].email);}}
WMAccounts.subscribe(aAccountInfo,[this,'__addSharedFolderResult']);}};_me.__addSharedFolderResult=function(aData){try{if(aData.IQ[0].ERROR)
gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::SUBSCRIBE_ERROR',args:[aData.IQ[0].ERROR[0].VALUE]}});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};obj_context_folder.__deleteFolder=function(sAccountID,sFolderID){var aFolders=dataSet.get('folders',[sAccountID]),bPerfm=false,bRefresh=false,sActive=dataSet.get('active_folder');for(var i in aFolders)
if(i==sFolderID||i.indexOf(sFolderID+'/')===0){bPerfm=true;if(sActive&&!bRefresh&&(sActive==sAccountID+'/'+i||sActive.indexOf(sAccountID+'/'+i+'/')==0))
bRefresh=true;delete aFolders[i];}
if(bPerfm){dataSet.add('folders',[sAccountID],aFolders,true);dataSet.update('folders',[sAccountID]);}
if(bRefresh)
gui.frm_main._selectView();WMFolders.remove({'aid':sAccountID,'fid':sFolderID},'folders');};obj_context_folder.__moveFolder=function(sAccount,sOldFolder,sNewFolder,bDeactivate){var sActive=dataSet.get('active_folder');if(sActive==sAccount+'/'+sOldFolder||sActive.indexOf(sAccount+'/'+sOldFolder+'/')==0){gui.frm_main.bar.tree.folders._invalidateActive();if(bDeactivate||sActive!=sAccount+'/'+sOldFolder)
gui.frm_main._selectView();else{WMFolders.add({'aid':sAccount,'fid':sOldFolder,'name':sNewFolder},'folders','',[function(aData){if(gui.frm_main&&gui.frm_main.bar&&gui.frm_main.bar.tree&&gui.frm_main.bar.tree.folders&&gui.frm_main.bar.tree.folders.recent){gui.frm_main.bar.tree.folders.recent.recent=[];gui.frm_main.bar.tree.folders.recent.__search('');}
if(aData.aid&&aData.name){aData={aid:aData.aid,fid:aData.fid};gui.frm_main._selectView(aData);obj_context_folder.__openFolder(aData);}
else
gui.frm_main._selectView();}]);return;}}
WMFolders.add({'aid':sAccount,'fid':sOldFolder,'name':sNewFolder},'folders','',[function(){if(gui.frm_main&&gui.frm_main.bar&&gui.frm_main.bar.tree&&gui.frm_main.bar.tree.folders&&gui.frm_main.bar.tree.folders.recent){gui.frm_main.bar.tree.folders.recent.recent=[];gui.frm_main.bar.tree.folders.recent.__search('');}}]);};obj_context_folder.__openFolder=function(aFolderInfo){if(aFolderInfo.name)
aFolderInfo.fid=aFolderInfo.name;try{var p;if((p=aFolderInfo.fid.lastIndexOf('/'))>-1)
gui.frm_main.bar.tree.folders._open(aFolderInfo.aid+'/'+aFolderInfo.fid.substr(0,p),'minus');else
gui.frm_main.bar.tree.folders._open(aFolderInfo.aid,'minus');}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};

/* client/inc/obj_context_item.js */
_me=obj_context_item.prototype;function obj_context_item(){};obj_context_item.createColorMailMenu=function(id){return[{"title":'COLOR_LABELS::RED_FLAG',"css":'ico2 bg_red','arg':[OldMessage.setColor,[id,Item.COLORS.RED]]},{"title":'COLOR_LABELS::BLUE_FLAG',"css":'ico2 bg_blue','arg':[OldMessage.setColor,[id,Item.COLORS.BLUE]]},{"title":'COLOR_LABELS::GREEN_FLAG',"css":'ico2 bg_green','arg':[OldMessage.setColor,[id,Item.COLORS.GREEN]]},{"title":'COLOR_LABELS::ORANGE_FLAG',"css":'ico2 bg_orange','arg':[OldMessage.setColor,[id,Item.COLORS.ORANGE]]},{"title":'COLOR_LABELS::PURPLE_FLAG',"css":'ico2 bg_purple','arg':[OldMessage.setColor,[id,Item.COLORS.PURPLE]]},{"title":'COLOR_LABELS::YELLOW_FLAG',"css":'ico2 bg_yellow','arg':[OldMessage.setColor,[id,Item.COLORS.YELLOW]]},{"title":'-'},{"title":'COLOR_LABELS::FLAG_COMPLETE',"css":'ico2 bg_complete','arg':[OldMessage.setColor,[id,Item.COLORS.COMPLETE]]},{"title":'COLOR_LABELS::CLEAR_FLAG',"css":'ico2 bg_none','arg':[OldMessage.setColor,[id,Item.COLORS.CLEAR]]}];};_me.__createMailMenu=function(id,ids,bMultiple,sFrom,aRights,bLimit,aOpt){var folders=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES'],sFolderID=id[0]+'/'+id[1],aOpt=aOpt||{};var bDraft=(sFolderID==folders['drafts']),bTemplate=(sFolderID==folders['templates']),bSent=(sFolderID==folders['sent']),bRSS=dataSet.get('folders',[id[0],id[1],'RSS'])?true:false,bTeamChat=WMFolders.getType(id)==='I',bArchive=false;if(dataSet.get('main',['archive_path'])&&sFolderID.indexOf(dataSet.get('main',['archive_path'])+'/')===0){bArchive=true;if(sFolderID.indexOf(dataSet.get('main',['archive_path'])+'/Sent/')===0)
bSent=true;}
var aMenu=[];if(bDraft){aMenu.push({"title":'POPUP_ITEMS::EDIT',css:'ico2 edit','disabled':bMultiple,'arg':[OldMessage.edit,[id]]});}else if(bTemplate&&!bLimit){aMenu.push({"title":'MAIN_MENU::NEW_FROM_TEMPLATE',css:'ico2 from_template','disabled':bMultiple,'arg':[NewMessage.compose,[new OldMessage(id)]]});aMenu.push({"title":'POPUP_ITEMS::EDIT',css:'ico2 edit','disabled':bMultiple,'arg':[OldMessage.edit,[id,{template:true}]]});}
if(!bLimit){aMenu.push({"title":'POPUP_ITEMS::OPEN_WINDOW',css:'ico2 open','disabled':bMultiple,'arg':[OldMessage.openwindow,[id]]});}
if(!aOpt.noactions){if(!bRSS&&!bDraft&&!bTemplate){aMenu.push({"title":bSent?'POPUP_ITEMS::REPLY_TO_ALL':'POPUP_ITEMS::REPLY_TO_SENDER',css:'ico2 '+(bSent?'reply_all':'reply'),'disabled':bMultiple,'arg':[OldMessage.reply,[id,bSent]],nodes:[{"title":'POPUP_ITEMS::REPLY_TO_SENDER',css:'ico2 reply','disabled':bMultiple||bSent,'arg':[OldMessage.reply,[id,false]]},{"title":'POPUP_ITEMS::REPLY_TO_ALL',css:'ico2 reply_all','disabled':bMultiple,'arg':[OldMessage.reply,[id,true]]},{"title":'MAIN_MENU::REPLY_TO_ALL_ATT',css:'ico2 reply_all_att','disabled':bMultiple,'arg':[OldMessage.reply,[id,true,null,false,void 0,true]]},{"title":'-'},{"title":'MAIN_MENU::REPLY_TO_SENDER_T',css:'ico2 reply_template','disabled':bMultiple||bSent,'arg':[OldMessage.replyTemplate,[id,false]]},{"title":'MAIN_MENU::REPLY_TO_ALL_T',css:'ico2 reply_all_template','disabled':bMultiple,'arg':[OldMessage.replyTemplate,[id,true]]}]});}
if(bTemplate)
aMenu.push({"title":'POPUP_ITEMS::FORWARD_AS_MESSAGE',css:'ico2 forward','arg':[OldMessage.forward,[ids,true,false]]});else{var tmp=[{"title":'POPUP_ITEMS::FORWARD',css:'ico2 forward','disabled':bMultiple,'arg':[OldMessage.forward,[id,false,false]]},{"title":'POPUP_ITEMS::FORWARD_RESEND',css:'ico2 forward','disabled':bMultiple,'arg':[OldMessage.forward,[id,false,true]]},{"title":'POPUP_ITEMS::FORWARD_AS_MESSAGE',css:'ico2 reply_all_att','arg':[OldMessage.forward,[ids,true,false]]}];if((GWOthers.getItem('RESTRICTIONS','disable_redirect')||0)<1)
tmp.push({"title":'POPUP_ITEMS::REDIRECT',css:'ico2 redirect','disabled':bMultiple,'arg':[OldMessage.redirect,[id]]});aMenu.push({"title":'POPUP_ITEMS::FORWARD',css:'ico2 forward','disabled':false,'arg':[OldMessage.forward,[id,false,false]],nodes:tmp});}}else{aMenu.push({"title":'POPUP_ITEMS::FORWARD_AS_MESSAGE',css:'ico2 reply_all_att','arg':[OldMessage.forward,[ids,true,false]]});}
if(bSent&&sPrimaryAccountDELIVERY&&!bLimit)
aMenu.push({"title":'POPUP_ITEMS::DELIVERY_REPORT',css:'ico2 delivery','disabled':bMultiple,'arg':[OldMessage.delivery_report,[id]]});if(!bTeamChat){aMenu.push({"title":'POPUP_ITEMS::MARK_AS_READ',css:'ico2 markread','arg':[OldMessage.markAsRead,[ids]],'disabled':!aRights.modify},{"title":'POPUP_ITEMS::MARK_AS_UNREAD',css:'ico2 markunread','arg':[OldMessage.markAsUnread,[ids]],'disabled':!aRights.modify},{"title":'-'});if(aRights.remove){aMenu.push({"title":'POPUP_ITEMS::MOVE_MAIL_TO',css:'ico2 move_folder','arg':[Item.move,[ids]],nodes:[{"title":'POPUP_ITEMS::MOVE_MAIL_TO',css:'ico2 move_folder','arg':[Item.move,[ids]]},{"title":'POPUP_ITEMS::COPY_MAIL_TO',css:'ico2 copy_folder','arg':[Item.copy,[ids]]},Alfresco.enabled()&&{"title":'POPUP_ITEMS::COPY_MAIL_TO_ALFRESCO',css:'ico2 alfresco','arg':[Item.copyToAlfresco,[ids]]}].filter(Boolean)});}
else{aMenu.push({"title":'POPUP_ITEMS::COPY_MAIL_TO',css:'ico2 move_folder','arg':[Item.copy,[ids]]});}
if(!bRSS&&!bDraft&&!bSent&&(dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Blacklist'])||dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Whitelist']))){var blist=dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Blacklist']),wlist=dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Whitelist']);aMenu.push({"title":'-'},{"title":'POPUP_ITEMS::WHITELIST_SENDER',css:'ico2 whitelist','arg':[OldMessage.whitelistSender,[ids]],'disabled':!wlist,nodes:[{"title":'POPUP_ITEMS::WHITELIST_SENDER','arg':[OldMessage.whitelistSender,[ids]]},{"title":'POPUP_ITEMS::WHITELIST_DOMAIN','arg':[OldMessage.whitelistDomain,[ids]]}]},{"title":'POPUP_ITEMS::BLACKLIST_SENDER',css:'ico2 blacklist','arg':[OldMessage.blacklistSender,[ids]],'disabled':!blist,nodes:[{"title":'POPUP_ITEMS::BLACKLIST_SENDER','arg':[OldMessage.blacklistSender,[ids]]},{"title":'POPUP_ITEMS::BLACKLIST_DOMAIN','arg':[OldMessage.blacklistDomain,[ids]]}]});}
aMenu.push({"title":'-'},{"title":'TAGS::TAGS',css:'ico2 tag','disabled':bArchive,'arg':[Item.edit_tags,[ids]],'disabled':!aRights.modify});var tmp_cert,tmp_amenu=[{"title":'POPUP_ITEMS::SAVE_AS',css:'ico2 save','arg':[Item.downloadSource,[id,'text']],"nodes":[{"title":'POPUP_ITEMS::TEXT',css:'ico2 text','disabled':bMultiple,'arg':[Item.downloadSource,[id,'text']]},{"title":'POPUP_ITEMS::EML',css:'ico2 eml','arg':[bMultiple?Item.downloadMultiple:Item.downloadSource,[bMultiple?ids:id]]},{"title":'POPUP_ITEMS::HTML',css:'ico2 html','disabled':bMultiple,'arg':[Item.downloadSource,[id,'html']]}]},{"title":'POPUP_ITEMS::SOURCE',css:'ico2 source','arg':[OldMessage.source,[id]]}];var aFrom=MailAddress.splitEmailsAndNames(sFrom)[0];if(aFrom&&!bDraft){if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'';if(dgw.indexOf('e')<0&&aFrom.email!==sPrimaryAccount)
tmp_amenu.push({"title":'POPUP_ITEMS::INVITE_APPOINTMENT',css:'ico2 add_calendar',disabled:false,arg:[Item.createInFolder,[id[0],"__@@VIRTUAL@@__/__@@EVENTS@@__",{CONTACTS:[{values:{CNTEMAIL:aFrom.email,CNTCONTACTNAME:aFrom.name,CNTROLE:'Q',NEW:true}}]},'E']]});if(dgw.indexOf('c')<0){var aLCTval={};if(aFrom&&aFrom.name)
aLCTval=parseNameToLocation(aFrom.name,aLCTval);if(aFrom.email)
aLCTval.LOCATIONS=[{'values':{'LCTEMAIL1':aFrom.email,'LCTTYPE':'H'}}];if(dataSet.get('items',[id[0],id[1],id[2],'SMIME_STATUS'])>3)
aLCTval.CERTIFICATES=[{values:{'class':'item','fullpath':id[0]+'/'+id[1]+'/'+WMItems.__serverID(id[2])}}];tmp_amenu.push({"title":'POPUP_ITEMS::ADD_CONTACT',css:'ico2 add_contact',disabled:bMultiple,'arg':[gui,'_create',['frm_contact','frm_contact','','',sPrimaryAccount,Mapping.getDefaultFolderForGWType('C'),'',aLCTval]]});tmp_cert={"title":'POPUP_ITEMS::CERT_TO_CONTACT',css:'ico2 add_cert',disabled:bMultiple||dataSet.get('items',[id[0],id[1],id[2],'SMIME_STATUS'])<4,'arg':[Item.addCert,[id]]};}}
if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1&&gui.frm_main&&gui.frm_main.im)
tmp_amenu.push({"title":'POPUP_ITEMS::ADD_IM',css:'ico2 add_im',disabled:!gui.frm_main.im._is_active()||bMultiple,'arg':[gui.frm_main.im,'_add_item',['',aFrom.email,aFrom.name]]});}
if(tmp_cert)
tmp_amenu.push(tmp_cert);aMenu.push({"title":'COMMON::MORE_OPTIONS',css:'ico2 more',nodes:tmp_amenu});if(sPrimaryAccountCHAT){aMenu.push({"title":'POPUP_ITEMS::COPY_ITEM_TO_TEAMCHAT',css:'ico2 color1 share_folder teamchat','arg':[Item.copy_tch,[ids]]});}
else{aMenu.push({"title":'-'});}}
if(!bLimit){aMenu.push({"title":'POPUP_ITEMS::DELETE','arg':[this,'__deleteFromDG',[ids]],css:'color2 ico2 delete','disabled':!aRights.remove});}
return aMenu;};_me.__createGWMenu=function(id,ids,sFolType,bMultiple,oRepeating,aAccess,sColumn,oObj,bLimit,aData){var me=this;var oObj=oObj||this._owner,aMenu=[],iFlags=0;if(sFolType=='G'){aMenu.push({"title":'POPUP_ITEMS::RECOVER',css:'ico2 recover','arg':[Item.recover,[ids]]});if(!dataSet.get('main',['keep_deleted_items_force_expiration'])){aMenu.push({'title':"-"},{"title":'POPUP_ITEMS::DELETE',css:'ico2 color2 delete','arg':[this,'__deleteFromDG',[ids,oRepeating,oObj]],'disabled':!aAccess.remove});}
return aMenu;}
if(sFolType=='F'){if(!bMultiple&&sPrimaryAccountWebDAV){var sName=(aData||dataSet.get('items',[id[0],id[1],id[2]])).EVNTITLE;if(sName){switch(Path.extension(sName)){case'txt':case'htm':case'html':aMenu.push({"title":'POPUP_ITEMS::OPEN',css:'ico2 open','arg':[Item.editFile,[id]]});break;case'pdf':aMenu.push({"title":'POPUP_ITEMS::OPEN',css:'ico2 open','arg':[Item.openPDF,[id]]});break;case'mp3':if(gui.audio)
aMenu.push({"title":'ATTACHMENT::PLAY_SOUND',css:'ico2 sound','arg':[Item.playFile,[id]]});break;default:if(Item.officeSupport(sName)){var aArgAuto=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName)]];var aArgWeb=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName)]];var aArgWebView=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName),'view']];var aArgExt=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName),'external']];var bIWD=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';aMenu.push({title:'POPUP_ITEMS::OPEN',css:'ico2 open',arg:aArgAuto,'nodes':[{"title":'DOCUMENT::OPENDOCUMENT',css:'ico2 open_edit','arg':aArgWeb,disabled:!bIWD},{"title":'DOCUMENT::OPENDOCUMENTVIEW','arg':aArgWebView,disabled:!bIWD},{"title":'OFFICELAUNCHER::OFFICESUITE',css:'ico2 open_suite','arg':aArgExt}]});}}}}
if(!bLimit){aMenu.push({"title":'POPUP_ITEMS::DOWNLOAD_FILE',css:'ico2 download','arg':[(bMultiple?Item.downloadMultiple:Item.downloadFile),[bMultiple?ids:id]]});}
var sLockID;if(!(sLockID=dataSet.get('items',[id[0],id[1],Is.Array(id[2])?id[2][id[2].length-1]:id[2],'EVNLOCKOWN_ID'])))
sLockID=dataSet.get('items',[id[0],id[1],Is.Array(id[2])?id[2][id[2].length-1]:id[2],'EVNLOCKOWN_ID']);var bLocked=sLockID&&sLockID!=sPrimaryAccountGWID,aRights=WMFolders.getRights({aid:id[0],fid:id[1]});if(oObj){aMenu.push({"title":'FORM_BUTTONS::RENAME',css:'ico2 rename','arg':[function(){if(oObj._editColumn){oObj._editColumn(id[2],'EVNFILENAME',{restrictions:[[function(name){return!!(name||'').trim()&&name.match(/^[^\/\\:?"<>|~*]+$/);}]]},[Item.edit_value,[id,'EVNFILENAME']]);if(oObj.edit){var v=(oObj||me._owner).edit._value(),p=v.lastIndexOf('.');oObj.edit._setRange(0,p>-1?p:v.length);}}}],disabled:bMultiple||!aAccess.modify||!id[2]||bLocked});var aData=dataSet.get('items',id);if(Item.officeSupport(aData.EVNTITLE)&&(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==0||!currentBrowser().match(/^MSIE([6-9]|10)$/))){aMenu.push({title:'MAIN_MENU::PRINT',arg:[function(){Item.openPDF(id);}],css:'ico2 print'});}}
aMenu.push({"title":'-'});}
else
if(sFolType=='E'){if(!bMultiple){iFlags=dataSet.get('items',id.concat('EVNFLAGS'))||0;if(iFlags&32||iFlags&8)
aMenu.push({title:'FILTERS::ACCEPT',css:'ico2 accept',arg:[WMItems,'imip',[{aid:id[0],fid:id[1],iid:id[2]},'accept',[function(){Item.__refreshView(ids)}]]]});if(!(iFlags&8)){aMenu.push({title:'EVENT::TENTATIVE',css:'ico2 tentative',arg:[WMItems,'imip',[{aid:id[0],fid:id[1],iid:id[2]},'tentative',[function(){Item.__refreshView(ids);}]]]});}
if(iFlags&2)
aMenu.push({"title":'MAIL_VIEW::DECLINE',css:'color2 ico2 decline','arg':[this,'__deleteFromDG',[ids,oRepeating,oObj]],'disabled':!aAccess.remove||bLocked});if(aMenu.length)
aMenu.push({"title":'-'});}
aMenu.push({title:'POPUP_ITEMS::EDIT',css:'ico2 edit',arg:[Item.open,[[id[0],id[1],id[2].split('|')[0]],dataSet.get('items',id)]],disabled:!aAccess.write||dataSet.get('items',id.concat('EVNCLASS'))=='O'},{title:'POPUP_ITEMS::CLONE',css:'ico2 clone_room',arg:[Item.cloneEvent,[id]],disabled:!aAccess.write||dataSet.get('items',id.concat('EVNCLASS'))=='O'});}
else
if(sFolType=='T')
aMenu.push({"title":'MAIN_MENU::PRINT',css:'ico2 print','arg':[Item.print,[ids]]});else
if(sFolType=='C'){var aContact=aData||dataSet.get('items',[id[0],id[1],id[2]]);if(!aContact)return aMenu;if(aContact.LCTEMAIL1||aContact.LCTEMAIL2||aContact.LCTEMAIL3){var sName=aContact.ITMCLASSIFYAS||((aContact.ITMSURNAME||'')+(aContact.ITMFIRSTNAME?' '+aContact.ITMFIRSTNAME:''))||'';aMenu.push({"title":'POPUP_ITEMS::SEND_EMAIL_TO',"caption":true});['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'].forEach(function(key){if(aContact[key])
aMenu.push({"text":aContact[key].entityify(),'arg':[NewMessage.compose,[{to:MailAddress.createEmail(sName,aContact[key])}]]});});aMenu.push({title:'-'});}
if(!bLimit){if(window.sPrimaryAccountSIP)
aMenu.push({"title":'MAIN_MENU::DIAL',css:'ico2 dial',"arg":[obj_context_item.__call,[id]]});if(window.sPrimaryAccountCONFERENCE)
aMenu.push({"title":'MAIN_MENU::CONFERENCE',css:'ico2 conference',"arg":[obj_context_item.__conference,[id]]});if(window.sPrimaryAccountSMS)
aMenu.push({"title":'MAIN_MENU::SMS',css:'ico2 sms',"arg":[obj_context_item.__sms,[ids]]});}
if(gui.frm_main&&gui.frm_main.im){var sJID='';if(gui.frm_main.im._is_active()){['LCTIM','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'].some(function(key){if(aContact[key]&&gui.frm_main.im._inRoster(aContact[key])){sJID=aContact[key].toLowerCase();return true;}});}
aMenu.push({"title":'IM::CHAT',css:'ico2 chat',disabled:!sJID,'arg':[gui.frm_main.im,'_chat',[sJID]]});}
aMenu.push({"title":'-'},{"title":'MAIN_MENU::PRINT',css:'ico2 print','arg':[Item.print,[ids]]});}
else
if(sFolType=='L'){var aContact=aData||dataSet.get('items',[id[0],id[1],id[2]]);aMenu.push({"title":'POPUP_ITEMS::SEND_EMAIL_TO',css:'ico2 send','arg':[NewMessage.compose,[{to:'['+aContact.fid+'::'+(aContact.ITMCLASSIFYAS||aContact.ITMTITLE)+']'}]]});}
if(aAccess.remove&&!bLocked){aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO',css:'ico2 move_folder','arg':[Item.move,[ids]],nodes:[{"title":'POPUP_ITEMS::MOVE_ITEM_TO',css:'ico2 move_folder','arg':[Item.move,[ids]],'disabled':!aAccess.remove||bLocked},{"title":'POPUP_ITEMS::COPY_ITEM_TO',css:'ico2 copy_folder','arg':[Item.copy,[ids]]},Alfresco.enabled()&&{"title":'POPUP_ITEMS::COPY_ITEM_TO_ALFRESCO',css:'ico2 alfresco','arg':[Item.copyToAlfresco,[ids]]},{"title":'POPUP_ITEMS::CLONE_ITEM_TO',css:'ico2 copy_folder','arg':[Item.clone,[ids]]}].filter(Boolean)});}
else
aMenu.push({"title":'POPUP_ITEMS::COPY_ITEM_TO',css:'ico2 copy_folder','arg':[Item.copy,[ids]]});var tmp_amenu=[];if(sFolType=='F'){tmp_amenu.push({"title":'ITEM::UPLOAD_NEW_VERSION',css:'ico2 upload','arg':[function(){var aData=WMItems.list({"aid":ids[0],"fid":ids[1],"iid":ids[2][0],"values":['ATTACHMENTS']},'','','');if(!gui.frm_main.main.X_ATTACHMENTS){gui.frm_main.main._create('X_ATTACHMENTS','obj_upload_edit_single','','big noborder hidden absolute');}
gui.frm_main.main.X_ATTACHMENTS._onuploadend=function(){var aOut={values:{}};var addon;if(!Is.Empty(addon=gui.frm_main.main.X_ATTACHMENTS.list._value())){var now=new IcewarpDate();aOut.values.EVNSTARTDATE=now.format(IcewarpDate.JULIAN);aOut.values.EVNSTARTTIME=now.format(IcewarpDate.JULIAN_TIME);var att=addon[addon.length-1];att.uid=addon[0].uid;aOut.values.EVNCOMPLETE=gui.frm_main.main.X_ATTACHMENTS.list._getSize();aOut.values.EVNTITLE=aOut.values.EVNLOCATION=aOut.values.EVNRID=att.values.description;aOut.values.EVNCLASS='F';aOut['ATTACHMENTS']=[att];}
WMItems.add(ids,aOut,'','','',[function(bOK){if(!bOK){return;}
if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.list){gui.frm_main.main.X_ATTACHMENTS._destruct();gui.frm_main.main.list._serverSort();Item.__refreshView(ids,true);}}]);};var attachement={};var data=aData[ids[0]][ids[1]][ids[2][0]];for(var i in data.ATTACHMENTS){if(data.ATTACHMENTS[i].values.ATTTYPE==='attachment'){attachement=data.ATTACHMENTS[i].values;}}
gui.frm_main.main.X_ATTACHMENTS.list._value({'path':ids[0]+'/'+ids[1]+'/'+WMItems.__serverID(ids[2][0]),'values':[{'name':attachement['ATTDESC'],'class':attachement['ATTTYPE'],'id':attachement['ATTNAME'],'size':attachement['ATTSIZE']}]});gui.frm_main.main.X_ATTACHMENTS.file._click();}],'disabled':!aAccess.modify||bMultiple},{"title":'ITEM::NEW_REVISION',css:'ico2 new_revision','arg':[function(){gui._create('revision','frm_revision','','',{aid:ids[0],fid:ids[1],iid:ids[2][0]});}],'disabled':!aAccess.modify||bMultiple},{"title":'POPUP_ITEMS::SEND_NOTIFY',css:'ico2 notify','arg':[function(){gui._create('notify','frm_notify','','',ids);}],'disabled':!aAccess.modify},{"title":(sLockID?'FILE::UNLOCK':'FILE::LOCK'),css:'ico2 '+(sLockID?'unlock':'lock'),'arg':[Item.set_lock,[ids,sLockID?false:true,true]],'disabled':!aAccess.modify||(!aRights.owner&&bLocked)});}
else{var sDownload,sDownloadIco='download';switch(sFolType){case'C':case'L':sDownload='DOWNLOAD_VCARD';sDownloadIco='download_vcard';break;case'E':case'J':case'T':if(!bMultiple){tmp_amenu.push({title:'EVENT::EMAIL_ATTENDEES',css:'ico2 eml',arg:[Item.emailAttendees,[id]]});}
sDownload='DOWNLOAD_VCALENDAR';sDownloadIco='download_vcal';break;case'N':sDownload='DOWNLOAD_VNOTE';sDownloadIco='download_vnote';break;default:sDownload='DOWNLOAD_SOURCE';break;}
tmp_amenu.push({"title":'POPUP_ITEMS::'+sDownload,css:'ico2 '+sDownloadIco,'arg':[bMultiple?Item.downloadMultiple:Item.downloadSource,[bMultiple?ids:id]]});tmp_amenu.push({"title":'POPUP_ITEMS::ATTACH_TO_EMAIL',css:'ico2 reply_all_att','arg':[Item.sendAsEmail,[ids]]});if(sFolType=='C'){if(sPrimaryAccountCHAT&&!bMultiple)
tmp_amenu.push({"title":'POPUP_ITEMS::COPY_ITEM_TO_TEAMCHAT',css:'ico2 teamchat','arg':[Item.copy_tch,[ids]]});if(gui.frm_main&&gui.frm_main.im){var sName=aContact.ITMCLASSIFYAS||((aContact.ITMSURNAME||'')+(aContact.ITMFIRSTNAME?' '+aContact.ITMFIRSTNAME:''))||'';tmp_amenu.push({"title":'POPUP_ITEMS::ADD_TO_IM',css:'ico2 add_im',disabled:!aContact.LCTIM||!gui.frm_main.im._is_active()||gui.frm_main.im._inRoster(aContact.LCTIM),'arg':[gui.frm_main.im,'_add_item',['',aContact.LCTIM,sName]]});}}}
if(sFolType=='F'){aMenu.push({"title":'POPUP_ITEMS::PROPERTIES',css:'ico2 doc_properties','disabled':bMultiple||!aAccess.modify,'arg':[Item.openwindow,[id,null,oRepeating]]});}
aMenu.push({"title":'TAGS::TAGS',css:'ico2 tag','arg':[Item.edit_tags,[ids]],'disabled':!aAccess.modify});if(tmp_amenu.length)
aMenu.push({"title":'COMMON::MORE_OPTIONS',css:'ico2 more',nodes:tmp_amenu});if(sFolType=='C'){var sLct='',bDisabled=!aContact||!['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'].some(function(key){if(aContact[key]){sLct=aContact[key];return true;}});if(sPrimaryAccountCHAT&&!bLimit)
aMenu.push({"title":'POPUP_ITEMS::INVITE_TEAMCHAT',css:'ico2 color1 share_folder teamchat','arg':[Item.invite_tch,[sLct]],disabled:bDisabled});}
else
if(sFolType=='F'){var tmp_nodes=[((aData||dataSet.get('items',[id[0],id[1],id[2]])).EVNOWN_ID===sPrimaryAccountGWID||aAccess.modify)&&{title:'COLLABORATION::REALTIME_COLLABORATION',css:'ico2 share_folder','arg':[Item.collaborate,[ids]]},sPrimaryAccountCHAT&&{"title":'POPUP_ITEMS::COPY_ITEM_TO_TEAMCHAT',css:'ico2 teamchat','arg':[Item.copy_tch,[ids]]},{"title":'POPUP_ITEMS::ATTACH_TO_EMAIL',css:'ico2 reply_all_att','arg':[Item.sendAsEmail,[ids]]}].filter(Boolean);aMenu.push({"title":'POPUP_ITEMS::SHARE',css:'ico2 color1 share_folder',nodes:tmp_nodes,arg:tmp_nodes[0].arg});}
else
if(sPrimaryAccountCHAT&&!bMultiple){aMenu.push({"title":'POPUP_ITEMS::COPY_ITEM_TO_TEAMCHAT',css:'ico2 color1 share_folder teamchat','arg':[Item.copy_tch,[ids]]});}
if(!bLimit&&(!iFlags||!(iFlags&2)))
aMenu.push({"title":'POPUP_ITEMS::DELETE',css:'color2 ico2 delete','arg':[this,'__deleteFromDG',[ids,oRepeating,oObj]],'disabled':!aAccess.remove||bLocked});return aMenu;};obj_context_item.createQuarantineMenu=function(ids){return[{"title":'POPUP_ITEMS::DELIVER',css:'ico2 deliver','arg':[OldMessage.deliver,[ids]]},{"title":'-'},{"title":'POPUP_ITEMS::WHITE_LIST',css:'ico2 whitelist','arg':[OldMessage.whitelist,[ids]]},{"title":'POPUP_ITEMS::BLACK_LIST',css:'ico2 blacklist','arg':[OldMessage.blacklist,[ids]]},{"title":'-'},{"title":'POPUP_ITEMS::DELETE',css:'color2 ico2 delete','arg':[Item.remove,[ids]]}];};obj_context_item.createBlacklistMenu=function(ids,arg){return[{"title":'POPUP_ITEMS::WHITE_LIST',css:'ico2 whitelist','arg':[OldMessage.whitelist,[ids]]},{"title":'-'},{"title":'POPUP_ITEMS::SEND_EMAIL_TO',css:'ico2 send','arg':[NewMessage.compose,[{to:arg.data.SNDEMAIL}]]},{"title":'-'},{"title":'POPUP_ITEMS::DELETE','css':'color2 ico2 delete','arg':[Item.remove,[ids]]}];};obj_context_item.createWhitelistMenu=function(ids,arg){return[{"title":'POPUP_ITEMS::BLACK_LIST',css:'ico2 blacklist','arg':[OldMessage.blacklist,[ids]]},{"title":'-'},{"title":'POPUP_ITEMS::SEND_EMAIL_TO',css:'ico2 send','arg':[NewMessage.compose,[{to:arg.data.SNDEMAIL}]]},{"title":'-'},{"title":'POPUP_ITEMS::DELETE',css:'ico2 color2 delete','arg':[Item.remove,[ids]]}];};_me._fillMenu=function(sType,arg,iid_list,bDisableOpen,aInitMenu,sColumn,oObj)
{var id=[arg['aid'],arg['fid'],arg['iid']],ids=[arg['aid'],arg['fid'],iid_list],bMultiple=iid_list.length>1,aRights=WMFolders.getAccess(arg),aMenu=[];if(!bMultiple&&arg.data&&arg.data.EVNOWN_ID==sPrimaryAccountGWID)
aRights={'read':true,'write':true,'modify':true,'remove':true,'owner':true};if(sColumn=='COLOR'&&aRights.modify){addcss(this._main,"obj_context_itemflags");aMenu=obj_context_item.createColorMailMenu(ids);}
else
switch(sType){case'E':case'J':case'T':case'N':case'F':case'C':case'G':case'L':aMenu=this.__createGWMenu(id,ids,sType,bMultiple,'',aRights,sColumn,oObj);break;case'M':var sFrom=dataSet.get('items',id.concat(['FROM']));aMenu=this.__createMailMenu(id,ids,bMultiple,sFrom,aRights);break;case'Q':aMenu=obj_context_item.createQuarantineMenu(ids);break;case'QL':if(arg['fid'].indexOf('White')>=0)
aMenu=obj_context_item.createWhitelistMenu(ids,arg);else
aMenu=obj_context_item.createBlacklistMenu(ids,arg);break;}
if(aInitMenu){aInitMenu=reverse(aInitMenu);for(var i in aInitMenu)
aMenu.unshift(aInitMenu[i]);}
this._fill(aMenu);};obj_context_item.__call=function(id){if(id)
gui.frm_main.__showDialDialog(id[0],id[1],id[2]);};obj_context_item.__sms=function(id){if(id)
gui.frm_main.__showSMSDialog(id[0],id[1],id[2]);};obj_context_item.__conference=function(id){if(id)
gui.frm_main.__showConferenceDialog(id[0],id[1],id[2]);};_me.__deleteFromDG=function(ids,oRepeating,oObj){if(ids){var oObj=oObj||this._owner;if(oObj&&oObj._type=='obj_datagrid2_ext'&&oObj.__deleteItems){var ov=oObj._value();if(ids[2].length>1||ov[0]==ids[2][0]){oObj.__deleteItems({aid:ids[0],fid:ids[1]},ids[2],false,oRepeating);return;}}
Item.remove(ids,false,oRepeating);}};_me._fillGeneralMenu=function(sType,oFolder){var aMenu;if(oFolder){var aid=oFolder['aid'];var fid=oFolder['fid'];var aRights=WMFolders.getAccess(oFolder);}
switch(sType){case'M':var aOpt=[];if(oFolder){aOpt={alias:Item.getAliasFromPath(aid+'/'+fid)};if(aid+'/'+fid==GWOthers.getItem('DEFAULT_FOLDERS','templates'))
aOpt.template=true;}
aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 send','arg':[NewMessage.compose,[aOpt]],'disabled':!aRights.write}];if(!aOpt.template)
aMenu.push({"title":'MAIN_MENU::NEW_FROM_TEMPLATE',css:'ico2 from_template','arg':[NewMessage.composeTemplate,[aOpt]],'disabled':!aRights.write});break;case'QL':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[gui,'_create',['frm_blackwhite','frm_blackwhite','','',aid,fid]]}];break;case'E':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write},{"title":'-'},{"title":'MAIN_MENU::DAY_VIEW','arg':[gui.frm_main,'_selectView',[oFolder,'day_view',true]]},{"title":'MAIN_MENU::WEEK_VIEW','arg':[gui.frm_main,'_selectView',[oFolder,'week_view',true]]},{"title":'MAIN_MENU::MONTH_VIEW','arg':[gui.frm_main,'_selectView',[oFolder,'month_view',true]]},{"title":'MAIN_MENU::EVENTS_LIST','arg':[gui.frm_main,'_selectView',[oFolder,'list_view',true]]}];break;case'C':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write},{"title":'POPUP_ITEMS::NEW_DISTRIBLIST',css:'ico2 new_dl','arg':[Item.create,['L',aid,fid]],'disabled':!aRights.write}];break;case'T':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write}];break;case'J':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write}];break;case'N':aMenu=[{"title":'MAIN_MENU::NEW',css:'ico2 new','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write}];break;case'F':aMenu=[{"title":'MAIN_MENU::NEW_UPLOAD',css:'ico2 upload','arg':[Item.createInFolder,[aid,fid]],'disabled':!aRights.write},{"title":'-'},{"title":'MAIN_MENU::NEW_WORD',css:'ico2 word','arg':[Item.createInFolder,[aid,fid,{'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':'.docx'}}]}]],'disabled':!aRights.write},{"title":'MAIN_MENU::NEW_EXCEL',css:'ico2 xls','arg':[Item.createInFolder,[aid,fid,{'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':'.xlsx'}}]}]],'disabled':!aRights.write},{"title":'MAIN_MENU::NEW_PPOINT',css:'ico2 ppt','arg':[Item.createInFolder,[aid,fid,{'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':'.pptx'}}]}]],'disabled':!aRights.write},{"title":'MAIN_MENU::NEW_TEXT',css:'ico2 text','arg':[Item.createInFolder,[aid,fid,{'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':'.txt'}}]}]],'disabled':!aRights.write},{"title":'MAIN_MENU::NEW_HTML',css:'ico2 html','arg':[Item.createInFolder,[aid,fid,{'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':'.html'}}]}]],'disabled':!aRights.write}];break;}
this._fill(aMenu);};

/* client/inc/obj_context_link.js */
_me=obj_context_link.prototype;function obj_context_link(){};_me.__constructor=function(sName,sMail,aCert,aConfig,aRecipients,ids){ids=ids||[];var me=this,aConfig=aConfig||{};if(!sMail&&!aConfig.distibutionList)return;aConfig.guest=sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly());var aLCTval={LOCATIONS:[{'values':{'LCTEMAIL1':sMail,'LCTTYPE':'H'}}]};if(aCert)
aLCTval.CERTIFICATES=aCert;if(sName&&sName!==sMail){sName=sName.unescapeHTML();if(sName.indexOf('<')>-1){var aFrom=MailAddress.splitEmailsAndNames(sName)[0];aName=aFrom.name;}
aLCTval=parseNameToLocation(sName,aLCTval);}else{sName='';}
var aMenu=[{anchor:'address'},{title:'-'},{"title":'POPUP_ITEMS::COPY_EMAIL',keep:true,'arg':[this,'__copyEmailToClipboard',[sMail]],css:'ico ico2 copy_email'}];if(!aConfig.guest){if(sPrimaryAccountGW>0&&!aConfig.nomail&&!aConfig.noadd){if(!~(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')){aMenu.push({"title":'POPUP_ITEMS::LOOKUP_CONTACTS',css:'ico ico2 lookup_contacts','arg':[this,'__lookup',[sMail,aLCTval]]},{"title":'POPUP_ITEMS::ADD_TO_CONTACTS',css:'ico ico2 add_to_contacts','arg':[gui,'_create',['frm_contact','frm_contact','','',sPrimaryAccount,Mapping.getDefaultFolderForGWType('C'),'',aLCTval]]},{"title":'POPUP_ITEMS::ADD_TO_EXIST_CONTACTS',css:'ico ico2 add_to_existing_contact','arg':[gui,'_create',['insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[me,'__addEmail',[sMail]],sPrimaryAccount,Mapping.getDefaultFolderForGWType('C'),'C','',false,['C'],'C']]},{"title":'-'});}}
if(!aConfig.nomail&&sPrimaryAccountGW>0){aMenu.push({title:'POPUP_ITEMS::INVITE_APPOINTMENT',css:'ico ico2 invite_to_appointment',arg:[Item.createInFolder,[sPrimaryAccount,"__@@VIRTUAL@@__/__@@EVENTS@@__",{CONTACTS:[{values:{CNTEMAIL:sMail,CNTCONTACTNAME:sName,CNTROLE:'Q',NEW:true}}]},'E']],disabled:false});if(aRecipients){var contacts=[];for(var i=0;i<aRecipients.length;i++){if(aRecipients[i].email&&aRecipients[i].email!==sPrimaryAccount){contacts.push({values:{CNTEMAIL:aRecipients[i].email,CNTCONTACTNAME:aRecipients[i].name,CNTROLE:'Q',NEW:true}});}}
contacts.length>1&&aMenu.push({title:'POPUP_ITEMS::INVITE_ALL_APPOINTMENT',css:'ico ico2 invite_all_to_appointment',arg:[Item.createInFolder,[sPrimaryAccount,"__@@VIRTUAL@@__/__@@EVENTS@@__",{CONTACTS:contacts},'E']],disabled:false});}}
var b=false;if(sPrimaryAccountCHAT){var f=dataSet.get('folders',[sPrimaryAccount]),r=0,b=false;for(var n in f){if(b&&r>0){break;}
if(f[n].TYPE==='I'&&f[n].RECENT>0){r+=parseInt(f[n].RECENT);b=true;}else if(f[n].TYPE==='Y'&&WMFolders.getAccess({aid:sPrimaryAccount,fid:n},'write')){b=true;}}}
b&&aMenu.push({"title":'-'},{"title":'POPUP_ITEMS::TEAMCHAT_INVITE',css:'ico ico2 teamchat_invite','arg':[this,'__teamchat_invite',[sMail]]});}
this._fill(aMenu);var li=document.querySelector('.copy_email');var div=document.createElement('div');div.id=li.firstChild.id;li.insertBefore(div,li.firstChild);var anchor=document.getElementById(this._anchors.address);var wrapper=document.createElement('div');wrapper.classList.add('wrapper');var img=document.createElement('div');img.classList.add('avatar');wrapper.appendChild(img);var name=document.createElement('div');name.classList.add('name');name.textContent=sName||sMail;wrapper.appendChild(name);if(sName){var email=document.createElement('div');email.classList.add('email');email.textContent=sMail;email.onclick=function(){Item.sendEmailTo(MailAddress.createEmail(sName,sMail));};wrapper.appendChild(email);}
var buttons=document.createElement('div');buttons.classList.add('buttons');wrapper.appendChild(buttons);var button_call=document.createElement('div');button_call.classList.add('call');var icon_call=document.createElement('div');icon_call.classList.add('icon');button_call.appendChild(icon_call);var label_call=document.createElement('div');label_call.classList.add('label');label_call.textContent=getLang('CONTACT::CALL');button_call.appendChild(label_call);var button_mail=document.createElement('div');button_mail.classList.add('mail');var icon_mail=document.createElement('div');icon_mail.classList.add('icon');button_mail.appendChild(icon_mail);var label_mail=document.createElement('div');label_mail.classList.add('label');label_mail.textContent=getLang('CONTACT::MAIL');button_mail.appendChild(label_mail);button_mail.onclick=function(){Item.sendEmailTo(sName?MailAddress.createEmail(sName,sMail):sMail);};buttons.appendChild(button_mail);var button_chat=document.createElement('div');button_chat.classList.add('chat');var icon_chat=document.createElement('div');icon_chat.classList.add('icon');button_chat.appendChild(icon_chat);var label_chat=document.createElement('div');label_chat.classList.add('label');label_chat.textContent=getLang('CONTACT::CHAT');button_chat.appendChild(label_chat);button_chat.onclick=function(){gui.frm_main.im._chat(sMail);};anchor.appendChild(wrapper);anchor.parentNode.replaceChild(wrapper,anchor);if(sMail&&Is.Email(sMail)){WMItems.list({"aid":ids[0]||sPrimaryAccount,"fid":ids[1]||'__@@ADDRESSBOOK@@__',filter:{search:'email:"'+sMail.replace(/"/g,'\\"')+'"'},values:['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTPHNWORK1','LCTPHNFAXWORK','LCTPHNHOME1','LCTPHNMOBILE']},'','','',[function(aData){if(aData&&(aData=(aData[sPrimaryAccount]||aData[ids[0]]))&&(aData=(aData['__@@ADDRESSBOOK@@__']||aData[ids[1]]))){var aPath,bPhone=false;for(var id in aData){if(id.charAt(0)==='*'){var aPath=[sPrimaryAccount,aData[id].ITMFOLDER?aData[id].ITMFOLDER.replace(/\\/g,'/'):'__@@ADDRESSBOOK@@__',id];if(aData[id]&&(aData[id].LCTPHNFAXWORK||aData[id].LCTPHNHOME1||aData[id].LCTPHNMOBILE||aData[id].LCTPHNWORK1)){bPhone=aPath;}
if(dataSet.get('folders',[aPath[0],aPath[1],'DEFAULT']))
break;}}
if(aPath){img.style.backgroundImage="url("+getAvatarURL(sMail)+")";gui.tooltip._add(img,'<img class="avatar_preview" style="background-image: url('+getAvatarURL(sMail)+')">',{x:'-60',y:'+36',html:true,css:'borderless'});if(sPrimaryAccount!==sMail){if(bPhone){button_call.onclick=function(){gui.frm_main.__showDialDialog(bPhone[0],bPhone[1],bPhone[2]);};buttons.insertBefore(button_call,button_mail);}
if(gui.frm_main.im&&gui.frm_main.im._is_active()){buttons.appendChild(button_chat);}}}}else if(gui.frm_main.im&&gui.frm_main.im._is_active()&&gui.frm_main.im._inRoster(sMail)){buttons.appendChild(button_chat);}}.bind(this)]);}};_me.__teamchat_invite=function(sMail){gui._create('frm_select_folder','frm_select_folder','','','POPUP_ITEMS::TEAMCHAT_INVITE',false,false,[function(aid,fid){gui._create('invite','frm_groupchat_invite','','',{aid:aid,fid:fid},[function(){gui.notifier&&gui.notifier._value({type:'invitation_sent',args:[sMail]});}],sMail);}],true,false,['Y','I'],false,true,'ab');};_me.__copyEmailToClipboard=function(sMail){var textArea=document.createElement("textarea");textArea.innerHTML=sMail;textArea.style.position='absolute';textArea.style.zIndex='-10000';textArea.style.top='0';textArea.style.left='0';document.body.appendChild(textArea);textArea.select();var holder=document.querySelector('.copy_email');try{if(!document.queryCommandSupported('copy')){throw new Error('Unsupported command "copy"');}
if(!document.queryCommandEnabled('copy')){throw new Error('Command "copy" disabled');}
if(document.execCommand('copy')){gui.notifier&&gui.notifier._value({type:'clipboard_email'});holder.classList.add('copied');holder.querySelector('span').textContent=getLang('POPUP_ITEMS::EMAIL_COPIED');var self=this;setTimeout(function(){holder&&self._destruct();},220);}else{throw new Error('Unable to copy mail to clipboard. Press CTRL + C to copy');}}catch(err){console.log(err);holder.classList.add('copy_error');var span=holder.querySelector('span');span.textContent=sMail;if(document.selection){var div=document.body.createTextRange();div.moveToElementText(span);div.select();}else if(window.getSelection){var div=document.createRange();div.selectNodeContents(span);window.getSelection().removeAllRanges();window.getSelection().addRange(div);}}
textArea.parentNode.removeChild(textArea);};_me.__lookup=function(sMail,aLCTval){if(sMail&&Is.Email(sMail))
WMItems.list({"aid":sPrimaryAccount,"fid":'__@@ADDRESSBOOK@@__',filter:{search:'isemail:"'+sMail.replace(/"/g,'\\"')+'"'}},'','','',[function(aData){if(aData&&(aData=aData[sPrimaryAccount])&&(aData=aData['__@@ADDRESSBOOK@@__'])){var aPath;for(var id in aData){if(id.charAt(0)=='*'){var aPath=[sPrimaryAccount,aData[id].ITMFOLDER?aData[id].ITMFOLDER.replace(/\\/g,'/'):'__@@ADDRESSBOOK@@__',id];if(dataSet.get('folders',[aPath[1],'DEFAULT']))
break;}}
if(aPath){Item.openwindow(aPath,'','','C');return;}}
var frm=gui._create('not_found','frm_confirm','','frm_alert',[gui,'_create',['frm_contact','frm_contact','','',sPrimaryAccount,Mapping.getDefaultFolderForGWType('C'),'',aLCTval]],'ALERTS::NOT_FOUND','CONFIRMATION::CONTACT_NOT_FOUND');addcss(frm.x_btn_ok._main,'add');frm.x_btn_ok._value('POPUP_ITEMS::ADD_TO_CONTACTS');}]);};_me.__addEmail=function(aData,sMail){WMItems.list({"aid":aData[0].aid,"fid":aData[0].fid,"iid":aData[0].id},'','','',[this,'__saveEmail',aData,sMail]);};_me.__saveEmail=function(sMail,aData,aResponse){var aValues;if(!Is.String(sMail)||!Is.Object(aData)||!aResponse||!(aValues=aResponse[aData.aid][aData.fid][aData.id])){gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::NO_DATA'}});return;}
sMail=sMail.toLowerCase();var aLocations=aValues['LOCATIONS'],aLocData={};if(Is.Defined(aLocations)){for(var i in aLocations)
if(aLocations[i]['values'].LCTTYPE=='H'){aLocData=aLocations[i]['values'];break;}
if(!Is.Empty(aLocData)){var checkEmailBox=['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'],bFull=true;for(var i in checkEmailBox)
if(!aLocData[checkEmailBox[i]]){aLocData[checkEmailBox[i]]=sMail;bFull=false;break;}
else
if(aLocData[checkEmailBox[i]].toLowerCase()==sMail){if(gui.notifier)
gui.notifier._value({type:'email_exists'});return true;}
if(bFull){gui.notifier._value({type:'alert',args:{header:'',text:'NOTIFIER::CONTACT_EMAIL_LIST_FULL'}});return false;}}}
if(Is.Empty(aLocData))
aLocData={LCTEMAIL1:sMail,LCTEMAIL2:"",LCTEMAIL3:"",LCTTYPE:"H"};var aOut={values:aLocData};if(aLocData.LCT_ID)
aOut.uid=aLocData.LCT_ID;WMItems.add([sPrimaryAccount,aData.fid,aData.id],{LOCATIONS:[aOut]},'','','',[function(bOK){if(bOK===true&&gui.notifier)
gui.notifier._value({type:'email_added'});}]);};

/* client/inc/obj_datagrid.js */
_me=obj_datagrid.prototype;function obj_datagrid(){};_me.__constructor=function(bDontListen){this.__offset=0;this.__reizeInterval=1;};_me._serverSort=function(aData,sColumn,sType){if(aData)
this._aData=aData;if(!sColumn){if(!this.__sortColumn)
return;else
sColumn=this.__sortColumn;}
else
this.__sortColumn=sColumn;if(!sType&&this.__sortType)
sType=(this.__sortType==1?'desc':'asc');else
this.__sortType=(sType=='desc'?1:0);if(Is.Array(this._aData))
this._value([]);function mySort(a,b){if(a[1]>b[1])
return 1;else
if(a[1]<b[1])
return-1;else
return 0;};var aTmp=[],tmp;for(var i in this._aData){tmp=this._aData[i].data[sColumn];aTmp.push([i,typeof tmp=='object'?tmp[1]:tmp]);}
aTmp.sort(mySort);if(sType=='desc')
aTmp.reverse();var aSortedData={};for(var i in aTmp)
aSortedData[aTmp[i][0]]=this._aData[aTmp[i][0]];this._fill(aSortedData);};

/* client/inc/obj_datagrid2.js */
_me=obj_datagrid2.prototype;function obj_datagrid2(){};_me.__constructor=function(bDontListen){var me=this;this._cookiesEnabled=true;this._aFolder=null;this._aFolderLast=null;this.__total=0;this.__offset=0;this.__preload=20;this.__limit=[0,0];this.__row_count=0;this.__row_offset=0;if(!bDontListen)
this._listen_data('items','',true);this.__iScroll_left=0;this.__iScroll_top=-1;this.__eContainer2.onscroll=function(e){if(me.__iScroll_left!=this.scrollLeft){me.__iScroll_left=this.scrollLeft;if(gui._rtl&&this.scrollRight)
me.__eHeader.style.marginRight=-this.scrollRight+'px';else
me.__eHeader.style.marginLeft=-me.__iScroll_left+'px';}
var pre1=me.__preload,pre2=me.__preload,r=me.__getRange();if(me.__limit[1]<=me.__limit[0]||(r[0]+r[1]>me.__limit[1]-10&&me.__limit[1]<me.__total)||(r[0]<me.__limit[0]+10&&me.__limit[0]>0)){if(me.__iScroll_top>-1){if(me.__iScroll_top>this.scrollTop)
pre1+=10;else
pre2+=10;}
me.__limit[0]=r[0]>pre1?r[0]-pre1:0;me.__limit[1]=r[0]+r[1]+pre2;me.__offset=me.__limit[0];if(me.__scrolltime)
clearTimeout(me.__scrolltime);me.__scrolltime=setTimeout(me._pathName+'._serverSort()',300);}
else
if(me.__scrolltime&&me.__iScroll_top>-1&&(me.__iScroll_top!=this.scrollTop)){clearTimeout(me.__scrolltime);me.__scrolltime=setTimeout(me._pathName+'._serverSort()',300);}
else
if(me.__selectByPosition)
me._selectPosition();if(me.__iScroll_top!=this.scrollTop)
me.__iScroll_top=this.scrollTop;};};_me.__check_size=function(){var h=this.__eContainer2.offsetHeight;if(this.__lastHaight&&this.__lastHaight!=h)
this.__eContainer2.onscroll();this.__lastHaight=h;};_me._default_values=function(sFolType){return WMItems.default_values(sFolType);};_me._default_columns=function(sFolType){var aDefaultColumns;var CV=+GWOthers.getItem('LAYOUT_SETTINGS','compact_view');var rows=2.8;switch(CV){case 1:rows=2;break;case 2:rows=1;break;}
var aFolder=this._getFolder();var view=Cookie.get(['views',aFolder.aid,aFolder.fid,'view'])||'wide';var size=~view.indexOf('wide')?2500:500;switch(sFolType){case'C':aDefaultColumns={'AVATAR':{'width':18,'css':'avatar',"type":'static','display':'small'},'ITMCLASS':{'width':20,'arg':{'sort':'asc'},'css':'ico contact',"type":'static',"text":'&nbsp;',encode:true},'ITMCLASSIFYAS':{'width':40,mode:'%','arg':{'sort':'asc'},'display':'all'},'ITMCOMPANY':{'width':30,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all',hideColumnFor:['small']},'CONTACT_EMAIL':{'width':30,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all'},'ITMSURNAME':{'arg':{'sort':'asc'},'display':'all',hideColumnFor:['small','all']},'PHONE':{'width':190,'arg':{'sort':'asc'},encode:true,'display':'all'},'ITMCATEGORY':{'width':200,css:'tags','arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true});break;case'G':aDefaultColumns={'ITMCLASS':{'width':20,'arg':{'sort':'asc'},'css':'ico gw',"type":'static',"text":'&nbsp;'},'ITMTITLE':{'width':100,mode:'%',css:'title','arg':{'sort':'asc'},encode:true},'ITMORIGINALFOLDER':{'width':300,'arg':{'sort':'asc'},encode:true},'ITM_DELETED':{'width':100,'arg':{'sort':'desc'}}};if(this._small)this._small({size:size});break;case'E':if(this._aFolder.aid==sPrimaryAccount&&this._aFolder.fid=='__@@VIRTUAL@@__/__@@EVENTS@@__')
aDefaultColumns={'EVNFOLDER':{'width':4,'arg':{'sort':'asc'},'css':'evnfolder',"type":'static',"text":'&nbsp;',encode:true,'display':'all'},'EVNTITLE':{'width':75,mode:'%',css:'indent title','arg':{'sort':'asc'},'display':'all'},'REMINDER':{'width':20,'css':'ico reminder','arg':{'sort':'desc'},"text":'&nbsp;',display:'all'},'EVNLOCATION':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'RECCURENCE':{'width':20,'css':'ico recurrence','arg':{'sort':'desc'},"text":'&nbsp;'},'CONFERENCE':{'width':20,'css':'ico conference','arg':{'sort':'desc'},"text":'&nbsp;'},'EVENT_STARTDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVENT_ENDDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'DELETE':{'width':18,'css':'ico delete',"type":'static','display':'small'}};else
aDefaultColumns={'EVNTITLE':{'width':75,mode:'%',css:'title','arg':{'sort':'asc'},'display':'all'},'EVNLOCATION':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all'},'REMINDER':{'width':20,'css':'ico reminder','arg':{'sort':'desc'},"text":'&nbsp;'},'RECCURENCE':{'width':20,'css':'ico recurrence','arg':{'sort':'desc'},"text":'&nbsp;'},'EVENT_STARTDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVENT_ENDDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true});break;case'J':aDefaultColumns={'EVNTITLE':{'width':100,mode:'%',css:'title','arg':{'sort':'asc'},'display':'all'},'EVENT_STARTDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVENT_ENDDATE':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true});break;case'F':case'K':case'I':aDefaultColumns={'ico':{width:20,type:'static',title:'',css:'file_type','display':'all'},'EVNFILENAME':{'width':60,mode:'%','arg':{'sort':'asc'},'display':'all',bidi:false},'LOCK':{width:20,type:'static',title:'',css:'ico lock','display':'all'},'EVNNOTE':{'width':40,mode:'%','arg':{'sort':'asc'},encode:true},'EVN_MODIFIED':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVNFILESIZE':{'width':70,'arg':{'sort':'asc'},'css':'right','display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true,css:'task'});break;case'M':var aFolder=dataSet.get('folders',[this._aFolder.aid,this._aFolder.fid])||{};var bSentArchive=(this._aFolder.aid+"/"+this._aFolder.fid).indexOf(dataSet.get('main',['archive_path'])+"/Sent/")===0;if(aFolder.RSS)
aDefaultColumns={'FLAGS':{'width':21,'arg':{'sort':'asc'},'css':'ico msg',"type":'static',"text":'&nbsp;','display':'all'},'SUBJECT':{'width':75,mode:'%','arg':{'sort':'asc'},'display':'all',css:'subject'},'FROM':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all',css:'from'},'DATE':{'width':120,'arg':{'sort':'desc'},'css':'right light','display':'all'},'COLOR':{'width':18,'arg':{'sort':'asc'},'css':'ico flags',"type":'static',"text":'&nbsp;','display':'all'},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};else
if(aFolder.DEFAULT=='H')
aDefaultColumns={'PRIORITY':{'width':4,'arg':{'sort':'desc'},'css':'priority',"type":'static',"text":'&nbsp;','title':'SETTINGS::PRIORITY','display':'all',hideColumnFor:['small']},'HAS_ATTACHMENT':{'width':18,'arg':{'sort':'desc'},'css':'ico attachment',"type":'static',"text":'&nbsp;','display':'all'},'FLAGS':{'width':21,'arg':{'sort':'asc'},'css':'ico msg',"type":'static',"text":'&nbsp;','display':'all'},'FROM':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all',css:'from'},'SUBJECT':{'width':50,mode:'%','arg':{'sort':'asc'},'display':'all',css:'subject'},'TO':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true},'DATE':{'width':100,'arg':{'sort':'desc'},'css':'right light','display':'all'},'ITEM_MOVED':{'width':100,'arg':{'sort':'desc'},'css':'right light'},'SIZE':{'width':60,'arg':{'sort':'desc'},'css':'right light','display':'all',hideColumnFor:['small']},'COLOR':{'width':18,'arg':{'sort':'asc'},'css':'ico flags',"type":'static',"text":'&nbsp;','display':'all'},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};else
if(aFolder.DEFAULT==='S'||aFolder.DEFAULT==='D'||aFolder.DEFAULT==='P'||bSentArchive||this.__isInSentFolder())
aDefaultColumns={'PRIORITY':{'width':4,'arg':{'sort':'desc'},'css':'priority',"type":'static',"text":'&nbsp;','title':'SETTINGS::PRIORITY','display':'all',hideColumnFor:['small']},'HAS_ATTACHMENT':{'width':18,'arg':{'sort':'desc'},'css':'ico attachment',"type":'static',"text":'&nbsp;','display':'all'},'FLAGS':{'width':21,'arg':{'sort':'asc'},'css':'ico msg',"type":'static',"text":'&nbsp;','display':'all'},'FROM':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,css:'from'},'SUBJECT':{'width':50,mode:'%','arg':{'sort':'asc'},'display':'all',css:'subject'},'TO':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all'},'DATE':{'width':100,'arg':{'sort':'desc'},'css':'right light','display':'all'},'SIZE':{'width':60,'arg':{'sort':'desc'},'css':'right light','display':'all',hideColumnFor:['small']},'COLOR':{'width':18,'arg':{'sort':'asc'},'css':'ico flags',"type":'static',"text":'&nbsp;','display':'all'},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};else
aDefaultColumns={'PRIORITY':{'width':4,'arg':{'sort':'desc'},'css':'priority',"type":'static',"text":'&nbsp;','title':'SETTINGS::PRIORITY','display':'all',hideColumnFor:['small']},'HAS_ATTACHMENT':{'width':18,'arg':{'sort':'desc'},'css':'ico attachment',"type":'static',"text":'&nbsp;','display':'all'},'FLAGS':{'width':21,'arg':{'sort':'asc'},'css':'ico msg',"type":'static',"text":'&nbsp;','display':'all'},'FROM':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true,'display':'all',css:'from'},'SUBJECT':{'width':50,mode:'%','arg':{'sort':'asc'},'display':'all',css:'subject'},'TO':{'width':25,mode:'%','arg':{'sort':'asc'},encode:true},'DATE':{'width':100,'arg':{'sort':'desc'},'css':'right light','display':'all'},'SIZE':{'width':60,'arg':{'sort':'desc'},'css':'right light','display':'all',hideColumnFor:['small']},'COLOR':{'width':18,'arg':{'sort':'asc'},'css':'ico flags',"type":'static',"text":'&nbsp;','display':'all'},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true,filters:[{search:'',text:'COMMON::ALL'},{search:'is:unread',text:'MESSAGE::UNREAD'}]});break;case'T':aDefaultColumns={'EVNPRIORITY':{'width':4,"type":'static',"text":'&nbsp;','css':'priority','display':'all'},'CHECK':{'width':26,"type":'static',"text":'&nbsp;','css':'check','display':'all'},'EVNSTATUS':{'width':50,'arg':{'sort':'asc'},"type":'static',"text":'&nbsp;','css':'ico status','display':'all'},'EVNCOMPLETE':{'width':50,"type":'static',"text":'&nbsp;','display':'small'},'EVNTITLE':{'width':100,mode:'%','arg':{'sort':'asc'},'css':'title','display':'all'},'REMINDER':{'width':20,'css':'ico reminder','arg':{'sort':'desc'},"text":'&nbsp;'},'RECCURENCE':{'width':20,'css':'ico recurrence','arg':{'sort':'desc'},"type":'static',"text":'&nbsp;'},'TASK_ENDDATE':{'width':100,'arg':{'sort':'desc'},'display':'all'},'TASK_STARTDATE':{'width':100,'arg':{'sort':'desc'},'display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true});break;case'N':aDefaultColumns={'EVNTITLE':{'width':100,mode:'%',css:'indent title','arg':{'sort':'asc'},'display':'all'},'EVN_MODIFIED':{'width':120,'arg':{'sort':'desc'},'display':'all'},'EVNTYPE':{'width':200,'css':'tags','html':true,'arg':{'sort':'asc'}},'DELETE':{'width':18,'css':'ico delete',"type":'static',"text":'&nbsp;','display':'small'}};if(this._small)
this._small({size:size,rows:rows,sorting:true});break;case'Q':aDefaultColumns={'SNDEMAIL':{'width':25,mode:'%','arg':{'sort':'asc'},'display':'all',css:'from',encode:true},'SNDSUBJECT':{'width':75,mode:'%','arg':{'sort':'asc'},'display':'all',css:'subject',encode:true},'QDATE':{'width':110,'arg':{'sort':'desc'},'display':'all',css:'right light'},'SNDOWNER':{'width':100,'arg':{'sort':'asc'},encode:true},'SNDDOMAIN':{'width':80,'arg':{'sort':'asc'},encode:true}};this.__dragtype='';if(this._small)this._small({size:size,rows:rows,sorting:true});break;case'QL':aDefaultColumns={'SNDEMAIL':{'width':160,'arg':{'sort':'asc'},'display':'all',encode:true},'SNDOWNER':{'width':160,'arg':{'sort':'asc'},encode:true},'SNDDOMAIN':{'width':160,'arg':{'sort':'asc'},'display':'all',encode:true},'QDATE':{'width':110,'arg':{'sort':'desc'},'display':'all',css:'right light'}};this.__dragtype='';if(this._small)this._small({size:size,rows:rows,sorting:true});break;}
return aDefaultColumns;};_me.__isInSentFolder=function(sFolder,sAccount){sFolder=(sFolder||this._aFolder.fid).split('/');sAccount=sAccount||this._aFolder.aid;for(var i=0;i<sFolder.length;i++){if(dataSet.get('folders',[sAccount,sFolder.slice(0,i),'DEFAULT'])==='S'){return true;}}};_me._serverSort=function(aFolder,sColumn,sSortType,aHandler,aFilter){if(this.__scrolltime){clearTimeout(this.__scrolltime);this.__scrolltime='';}
if(aFolder&&this._aFolder!=null&&(this._aFolder.aid!=aFolder.aid||this._aFolder.fid!=aFolder.fid)){if(this.__eContainer2.scrollTop>0){this.__iScroll_top=0;this.__eContainer2.scrollTop=0;}
this.__total=0;this.__limit=[0,0];this._value([]);}
else
if(!(aFolder=aFolder||this._aFolder))
return false;this._aFolder=aFolder;var r=this.__getRange();if(this.__limit[1]<=this.__limit[0]){if((r[0]+r[1]>this.__limit[1]-10&&(this.__limit[1]<this.__total||this.__total==0))||(r[0]<this.__limit[0]+10&&this.__limit[0]>0)){this.__limit[0]=r[0]>this.__preload?r[0]-this.__preload:0;this.__limit[1]=r[0]+r[1]+this.__preload;this.__offset=this.__limit[0];}}
else
if(this.__limit[1]<r[0]+r[1]+this.__preload)
this.__limit[1]=r[0]+r[1]+this.__preload;aFilter=aFilter||{};aFilter.limit=this.__limit[1]-this.__limit[0];aFilter.offset=this.__limit[0];var sFolType=WMFolders.getType(aFolder),aValues=this._default_values(sFolType),aDefaultColumns=this._default_columns(sFolType);if(sSortType)
sSortType=sSortType=='desc'?1:0;if(this._cookiesEnabled){var bSave=true;if(!sColumn){var aSort=Cookie.get(['views',aFolder.aid,aFolder.fid,'sort']);if(aSort){sColumn=aSort.column;sSortType=aSort['type']=='desc'?1:0;}
aSort=null;}
if(sColumn&&aDefaultColumns){if(!aDefaultColumns[sColumn]||(this.__small&&(!aDefaultColumns[sColumn]['display']||aDefaultColumns[sColumn]['text']===''))){if(this.__small&&this.__smallOptions.sort){sColumn=this.__smallOptions.sort;sSortType=this.__smallOptions.sorttype||'desc';bSave=false;}
else{var srt=(Cookie.__defaultViews[sFolType]||{}).sort||{};sColumn=srt.column;sSortType=srt.type;}}
if(bSave)
Cookie.set(['views',aFolder['aid'],aFolder['fid'],'sort'],{column:sColumn,type:sSortType?'desc':'asc'});}
if(this.__small){var f=Cookie.get(['views',aFolder['aid'],aFolder['fid'],'filter'])||'';if(this.__smallOptions&&this.__smallOptions.filters)
for(var i=this.__smallOptions.filters.length-1;i>=0;i--)
if(this.__smallOptions.filters[i].search==f){this._smallfilter=f;break;}}}
else{sColumn=typeof sColumn=='undefined'?this.__sortColumn:sColumn;sSortType=typeof sSortType=='undefined'?this.__sortType:sSortType;if(aDefaultColumns&&!aDefaultColumns[sColumn]){sColumn='';sSortType='';}}
this.__sortColumn=sColumn;this.__sortType=sSortType;var sOrder=this._serverOrder(sColumn,sSortType);if(sOrder)
aFilter.sort=sOrder;if(this._SQLsearch_last!=this._SQLsearch){this._value([]);this._SQLsearch_last=this._SQLsearch;}
if(this._defaultfilter||this._SQLsearch||(this.__small&&this._smallfilter)){aFilter['search']=this.__small&&this._smallfilter?this._smallfilter:'';if(this._defaultfilter)
aFilter['search']+=aFilter['search']?' AND ('+this._defaultfilter+')':this._defaultfilter;if(this._SQLsearch)
aFilter['search']+=aFilter['search']?' AND ('+this._SQLsearch+')':this._SQLsearch;}
if(this._SQLfulltext_last!=this._SQLfulltext){this._value([]);this._SQLfulltext_last=this._SQLfulltext;}
if(this._SQLfulltext)
aFilter['fulltext']=this._SQLfulltext;this.__filter=aFilter;this._getAnchor('noitems').style.display='none';WMItems.list({'aid':aFolder['aid'],'fid':aFolder['fid'],'spam':aFolder['spam'],'values':aValues,'filter':aFilter},this._listener_data,this._listenerPath_data,'',aHandler);};_me._serverOrder=function(sColumn,iType){var sOrderBy='',sSortType=iType?'desc':'asc';switch(sColumn)
{case'ITMCLASSIFYAS':if(GWOthers.getItem('RESTRICTIONS','sortstring')=='1')
sOrderBy='ITMSORTSTRING '+sSortType+','+sColumn+' '+sSortType;else
sOrderBy=sColumn+' '+sSortType;case'CONTACT_EMAIL':var aContactEmailParts=['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'];for(var n in aContactEmailParts){if(sOrderBy)
sOrderBy+=',';sOrderBy+=aContactEmailParts[n]+' '+sSortType;}
break;case'PHONE':sOrderBy='LCTPHONE '+sSortType;break;case'EVENT_ENDDATE':sOrderBy='EVNENDDATE '+sSortType+',EVNENDTIME '+sSortType;break;case'EVENT_STARTDATE':sOrderBy='EVNSTARTDATE '+sSortType+',EVNSTARTTIME '+sSortType;break;case'EVNFILESIZE':sOrderBy='EVNCOMPLETE '+sSortType;break;case'EVNFILENAME':sOrderBy='EVNLOCATION '+sSortType;break;case'FROM':sOrderBy='HEADER_FROM '+sSortType;break;case'TO':sOrderBy='HEADER_TO '+sSortType;break;case'TASK_STARTDATE':sOrderBy='EVNENDDATE '+sSortType;break;case'TASK_ENDDATE':sOrderBy='EVNSTARTDATE '+sSortType;break;case'RECCURENCE':sOrderBy='EVNRCR_ID '+sSortType;break;case'ITMCOMPANY':sOrderBy='ITMCOMPANY '+sSortType+', ITMDEPARTMENT '+sSortType;break;case'REMINDER':sOrderBy='RMNTIME '+sSortType;break;default:if(sColumn)
sOrderBy=sColumn+' '+sSortType;}
var f=this._getFolder();if(dataSet.get('folders',[f.aid,f.fid,'TYPE'])=='M')
sOrderBy+=(sOrderBy?', ':'')+'item_id '+sSortType;return sOrderBy;};_me.__getRange=function(){var a=Math.floor(this.__eContainer2.scrollTop/this._row_height)||0,view=Math.max(document.documentElement.clientHeight,window.innerHeight||0);if(this.__eContainer2.clientHeight==0)
h=view;else
h=Math.min(this.__eContainer2.offsetHeight,view);h=Math.max(h,300);return[a,Math.floor(h/this._row_height)];};_me._listen_data=function(sDataSet,aDataPath,bNoUpdate){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet,bNoUpdate);};_me.__update=function(sName,aDPath){if(sName&&sName==this._listener){this._addColumns(dataSet.get(this._listener,this._listenerPath));return;}
else
if(sName!=this._listener_data)
return;var aItems=dataSet.get(this._listener_data,this._listenerPath_data);if(!aItems||!this._aFolder){return;}
for(var sAccId in aItems){for(var sFolId in aItems[sAccId])
break;break;}
if(sAccId!=this._aFolder.aid||sFolId!=this._aFolder.fid)
return;var bNewFolder=true;if(this._aFolderLast&&this._aFolderLast.aid==this._aFolder.aid&&this._aFolderLast.fid==this._aFolder.fid&&!Is.Empty(this._aCols))
bNewFolder=false;var sFolType=WMFolders.getType(this._aFolder);if(aDPath&&aDPath[2]&&aItems[aDPath[0]][aDPath[1]][aDPath[2]]&&(!aDPath[3]||(aDPath[3]&&this.__sortColumn!=aDPath[3]))){var tmp,rowOffset=-1;if(this.__small){if((tmp=this.__getElement([aDPath[2],'*']))){if((rowOffset=parseInt(tmp.style.top))<0)
return;tmp.parentNode.removeChild(tmp);tmp=null;}}
else
for(var sCol in this._aCols){if((tmp=this.__getElement([aDPath[2],sCol]))){if(rowOffset<0&&(rowOffset=parseInt(tmp.style.top))<0)
return;tmp.parentNode.removeChild(tmp);tmp=null;}}
if(rowOffset<0)
return;try{var aTmp={};aTmp[aDPath[2]]=clone(aItems[aDPath[0]][aDPath[1]][aDPath[2]],true);aItems=aTmp;}
catch(e){return;}}
else{aItems=clone(aItems[sAccId][sFolId],true);delete aItems['@'];if(typeof aItems['/']!='undefined'&&aItems['/']>=0){if(!(this.__total=aItems['/']*1))
this._value([]);}
else
this.__total=count(aItems);delete aItems['/'];if(typeof aItems['#']!='undefined'&&aItems['#']>=0){this.__subtotal=aItems['#']*1;this.__limit[1]=Math.min(this.__limit[1],this.__total);}
delete aItems['#'];if(typeof aItems['$']!='undefined'&&aItems['$']>=0){if(this.__offset!=aItems['$']*1)
return;else
this.__offset=aItems['$']*1;}
delete aItems['$'];if(count(aItems)!=this.__subtotal){this._serverSort();return;}
if(bNewFolder){this.__dragtype='item';var aDefaultColumns=this._default_columns(sFolType),aColumns={};if(this._cookiesEnabled)
{var aCookieColumns=Cookie.get(['views',sAccId,sFolId,'columns',screen.width+'x'+screen.height]),aSort=Cookie.get(['views',sAccId,sFolId,'sort']),bRepair=false;if(aCookieColumns)
{for(var sColumn in aDefaultColumns)
if(typeof aCookieColumns[sColumn]=='undefined'){bRepair=true;break;}
if(!bRepair)
for(var sColumn in aCookieColumns)
if(typeof aDefaultColumns[sColumn]=='undefined'){bRepair=true;break;}
if(bRepair){aColumns=aDefaultColumns;Cookie.set(['views',sAccId,sFolId,'columns',screen.width+'x'+screen.height]);}
else
for(var sColumn in aCookieColumns)
{aColumns[sColumn]=aDefaultColumns[sColumn];if(aColumns[sColumn].type!='static')
aColumns[sColumn]['width']=aCookieColumns[sColumn];}}
else
aColumns=aDefaultColumns;if(aSort&&aSort.column&&aColumns[aSort.column]){this.__sortColumn=aSort.column;this.__sortType=aSort.type=='desc'?1:0;}}
else
aColumns=aDefaultColumns;var aHeaders={};for(var sTitle in aColumns){aHeaders[sTitle]={};if(typeof aColumns[sTitle].text=='undefined')
aHeaders[sTitle]['title']='DATAGRID_ITEMS_VIEW::'+sTitle;for(var sProperty in aColumns[sTitle])
aHeaders[sTitle][sProperty]=aColumns[sTitle][sProperty];}
this._addColumns(aHeaders);this._select_all=false;}}
if(this.info){if(this.__value.length>this.__total)
this._value([]);this.info._value(this.__value.length,this.__total);}
this._fill(this._prepareBody(aItems,sFolType),rowOffset);this._aFolderLast=this._aFolder;};_me._prepareBody=function(aItems,sFolType){var me=this,aResult={},aRow,scss,aColors={'1':'red','2':'blue','3':'green','4':'gray','5':'orange','6':'cyan','7':'brown','8':'purple','9':'light_blue','A':'yellow','Y':'complete'},aCFolder=false,contactName,companyName;aTags=dataSet.get('tags')||{};var aRights=WMFolders.getRights(this._aFolder),aAccess=WMFolders.getAccess(this._aFolder),sFolderType=WMFolders.getType(this._aFolder);if(aAccess.modify)
addcss(this._main,'modify');else
removecss(this._main,'modify');if(this._aFolder.aid==sPrimaryAccount&&this._aFolder.fid=='__@@VIRTUAL@@__/__@@EVENTS@@__'){aCFolder={};var aColors=getCalendarColor();for(var c in aColors)
if(aColors[c])
aCFolder[aColors[c].str_replace('/','\\')]=c;}
function tags(sData,bRight){if(sData){var out='<p class="tag'+(bRight?' right':'')+'">',arr=sData.split(',');for(var sTag in arr)
if((arr[sTag]=arr[sTag].trim()))
out+='<span'+(aTags&&aTags[arr[sTag]]&&aTags[arr[sTag]].TAGCOLOR?' style="background-color: '+aTags[arr[sTag]].TAGCOLOR+'; color: '+aTags[arr[sTag]].TEXTCOLOR+'"':'')+(me.__small?' title="'+arr[sTag].escapeHTML().replace(/"/g,'&quot;')+'"':'')+'>'+(me.__small?'':arr[sTag].escapeHTML())+'</span>';return out+'</p>';}
return'';};var tmp,tags_html;for(var sItId in aItems)
{aRow={};scss=['CLASS_'+(aItems[sItId]['ITMCLASS']||aItems[sItId]['EVNCLASS']||sFolderType)];for(var sTitle in this._aCols)
{tags_html='';switch(sTitle)
{case'AVATAR':if(this.__small&&aItems[sItId]['ITMCLASS']=='C'){aRow[sTitle]='<div style="background-image: url(\''+getContactAvatarURL(sItId)+'\')"></div>';}
break;case'CONTACT_EMAIL':var sContactEmail='';if(aItems[sItId]['ITMCLASS']=='C'){var aContactEmailParts=['LCTEMAIL1','LCTEMAIL2','LCTEMAIL3'];for(var n in aContactEmailParts)
if(aItems[sItId][aContactEmailParts[n]]){if(sContactEmail)
sContactEmail+=', ';sContactEmail+=aItems[sItId][aContactEmailParts[n]];}}
aRow[sTitle]=sContactEmail;break;case'ITMCOMPANY':tmp=aItems[sItId][sTitle]||'';if(aItems[sItId].ITMDEPARTMENT)
tmp+=(tmp?' - ':'')+aItems[sItId].ITMDEPARTMENT;aRow[sTitle]=[tmp,tmp];break;case'PHONE':tmp=[];if(aItems[sItId]['LCTPHNMOBILE'])
tmp.push(aItems[sItId]['LCTPHNMOBILE']);if(aItems[sItId]['LCTPHNWORK1'])
tmp.push(aItems[sItId]['LCTPHNWORK1']);if(aItems[sItId]['LCTPHNFAXWORK'])
tmp.push(aItems[sItId]['LCTPHNFAXWORK']);if(aItems[sItId]['LCTPHNHOME1'])
tmp.push(aItems[sItId]['LCTPHNHOME1']);aRow[sTitle]=tmp.join(', ');break;case'ITMCLASS':if(sFolType=='G')
scss.push('ico_type_'+aItems[sItId].ITMCLASS);else
if(aItems[sItId].ITMCLASS=='L')
scss.push('distrib');break;case'ITMCLASSIFYAS':contactName=aItems[sItId][sTitle];companyName='';if(this.__small&&aItems[sItId].ITMCOMPANY){companyName='<span class="contactCompany">, '+aItems[sItId].ITMCOMPANY.escapeHTML()+'</span>';}
if(contactName){if(this.__small){tags_html=tags(aItems[sItId].ITMCATEGORY,true);if(tags_html)
scss.push('tags');}
if(Is.String(contactName)){if(aItems[sItId].ITMCLASS=='L')
aRow[sTitle]=['['+contactName.escapeHTML()+']'+tags_html,contactName];else
aRow[sTitle]=[contactName.escapeHTML()+companyName+tags_html,contactName];}
else{aRow[sTitle]=contactName.escapeHTML()+tags_html;}}
break;case'EVNFOLDER':if(aCFolder){aRow[sTitle]=['','',aItems[sItId].EVNFOLDER];scss.push(aCFolder[aItems[sItId].EVNFOLDER]);}
break;case'ITMCATEGORY':case'EVNTYPE':if(aItems[sItId][sTitle]){aRow[sTitle]=[tags(aItems[sItId][sTitle]),'',aItems[sItId][sTitle]];scss.push('tags');}
break;case'EVENT_ENDDATE':aRow[sTitle]=[(this.__small?tags(aItems[sItId]['EVNTYPE']):'')+this.__parseGwTime(aItems[sItId]['EVNENDDATE'],aItems[sItId]['EVNENDTIME'],true),parseInt(aItems[sItId]['EVNENDDATE'])*10000+parseInt(aItems[sItId]['EVNENDTIME'])];break;case'EVN_MODIFIED':if(this.__small){tags_html=tags(aItems[sItId].EVNTYPE,true);if(tags_html)
scss.push('tags');}
aRow[sTitle]=CalendarFormatting.normalWithTime(new IcewarpDate(aItems[sItId]['EVN_MODIFIED'],{format:'X'}))+tags_html;break;case'EVENT_STARTDATE':aRow[sTitle]=[this.__parseGwTime(aItems[sItId]['EVNSTARTDATE'],aItems[sItId]['EVNSTARTTIME']),parseInt(aItems[sItId]['EVNSTARTDATE'])*10000+parseInt(aItems[sItId]['EVNSTARTTIME'])];break;case'RECCURENCE':if(aItems[sItId]['EVNRCR_ID']&&(aItems[sItId]['EVNSTATUS']!='M'||!aItems[sItId]['EVNSTATUS'])){scss.push('recurrence');aRow[sTitle]=['',1];}else
aRow[sTitle]=['',0];break;case'CONFERENCE':if(aItems[sItId]['EVNMEETINGID']){scss.push('conference');aRow[sTitle]=['',1];}else
aRow[sTitle]=['',0];break;case'REMINDER':if(aItems[sItId]['RMNEVN_ID']){scss.push('reminder');aRow[sTitle]=['',1];}else
aRow[sTitle]=['',0];break;case'EVNFILENAME':aRow[sTitle]=Is.String(aItems[sItId]['EVNLOCATION'])?aItems[sItId]['EVNLOCATION'].escapeHTML():'';if(aRow[sTitle]&&aRow[sTitle].indexOf('.')>-1)
aRow['ico']=['','','','ico_'+(Path.extension(aRow[sTitle]))];break;case'EVNSTATUS':var txt='';switch(aItems[sItId][sTitle]){case'B':scss.push('not_started');txt=getLang('TASK::NOT_STARTED');break;case'I':scss.push('in_progress');txt=getLang('TASK::IN_PROGRESS');break;case'M':scss.push('completed');txt=getLang('TASK::COMPLETED');break;case'Q':scss.push('deferred');txt=getLang('TASK::DEFERRED');break;case'N':scss.push('waiting');txt=getLang('TASK::WAITING');break;}
aRow[sTitle]=['',aItems[sItId][sTitle],txt];break;case'EVNCOMPLETE':if(aItems[sItId][sTitle]>0)
switch(aItems[sItId].EVNSTATUS){case'I':case'Q':case'N':if(this.__small)
aRow[sTitle]=aItems[sItId][sTitle]+'%';else
aRow.EVNSTATUS=aItems[sItId][sTitle]+'%';}
break;case'EVNPRIORITY':switch(aItems[sItId]['EVNPRIORITY']){case'1':scss.push('priority_high');break;case'9':scss.push('priority_low');break;}
break;case'TASK_STARTDATE':aRow[sTitle]=[this.__parseGwTime(aItems[sItId]['EVNENDDATE']),parseInt(aItems[sItId]['EVNENDDATE'])];break;case'TASK_ENDDATE':if(this.__small){tags_html=tags(aItems[sItId].EVNTYPE);if(tags_html){scss.push('tags');}}
aRow[sTitle]=[tags_html+this.__parseGwTime(aItems[sItId]['EVNSTARTDATE']),parseInt(aItems[sItId]['EVNSTARTDATE'])];break;case'EVNTITLE':if(!this.__small||sFolType==='N'){tags_html=tags(aItems[sItId].EVNTYPE);if(tags_html){scss.push('tags');}}
aRow[sTitle]=[(aItems[sItId][sTitle]||'').escapeHTML()+tags_html,'',aItems[sItId][sTitle]];break;case'SUBJECT':var tmp=aItems[sItId][sTitle]?aItems[sItId][sTitle].escapeHTML():'&nbsp;';var tags_html=tags(aItems[sItId]['TAGS'],true);if(tags_html){tmp+=tags_html;scss.push('tags');}
aRow[sTitle]=[tmp,'',aItems[sItId][sTitle]];break;case'ITEM_MOVED':case'ITM_DELETED':case'DATE':case'QDATE':aRow[sTitle]=this.__parseTime(aItems[sItId][sTitle]),parseInt(aItems[sItId][sTitle]);break;case'PRIORITY':if(Is.Defined(aItems[sItId]['PRIORITY'])){switch(aItems[sItId]['PRIORITY'].toString()){case'1':case'2':scss.push('priority_high');aRow[sTitle]=['',2];break;case'4':case'5':scss.push('priority_low');aRow[sTitle]=['',0];break;default:aRow[sTitle]=['',1];}}
break;case'COLOR':if(aItems[sItId].COLOR&&Is.Defined(aColors[aItems[sItId].COLOR]))
scss.push('bg_'+aColors[aItems[sItId].COLOR]);aRow[sTitle]=['',aItems[sItId].COLOR];break;case'LOCK':if(aItems[sItId].EVNLOCKOWN_ID){scss.push((aRights.owner||aItems[sItId].EVNLOCKOWN_ID==sPrimaryAccountGWID)&&aAccess.modify?' lock':' lock2');aRow[sTitle]=['','',aItems[sItId].EVNLOCKOWN_ID==sPrimaryAccountGWID?getLang('FILE::LOCKED_BY_ME'):(aItems[sItId].EVNLOCKOWN_EMAIL?getLang('FILE::LOCKED_BY',[aItems[sItId].EVNLOCKOWN_EMAIL]):getLang('FILE::LOCKED'))];}
break;case'FLAGS':var nFlags=aItems[sItId]['FLAGS'],aFlag=[];if(!WMItems.hasFlag(nFlags,'SEEN'))
aFlag.push('unread');if(WMItems.hasFlag(nFlags,'ANSWERED')){if(WMItems.hasFlag(nFlags,'FORWARDED'))
aFlag.push('replied_and_forwarded');else
aFlag.push('replied');}
else
if(WMItems.hasFlag(nFlags,'FORWARDED'))
aFlag.push('forwarded');aRow[sTitle]=['',nFlags];switch(parseInt(aItems[sItId]['SMIME_STATUS'])){case 2:aFlag.push('serror');break;case 3:aFlag.push('smime');break;case 4:aFlag.push('sign');break;case 5:aFlag.push('ssmime');break;}
if(aFlag.length)
scss.push(aFlag.join(' '));break;case'HAS_ATTACHMENT':if(aItems[sItId]['HAS_ATTACHMENT']=='true'){scss.push('attachment');aRow[sTitle]=['',1];}
else
aRow[sTitle]=['',0];break;case'FROM':case'TO':aRow[sTitle]=MailAddress.splitNames(aItems[sItId][sTitle]);if(sTitle=='TO'&&aItems[sItId]['SMS'])
aRow[sTitle]+=(aRow[sTitle]?', ':'')+MailAddress.splitNames(aItems[sItId]['SMS']);break;case'SMS':break;case'SIZE':aRow[sTitle]=[parseFileSize(aItems[sItId][sTitle]),parseInt(aItems[sItId][sTitle])];break;case'EVNFILESIZE':var sSize=aItems[sItId]['EVNCOMPLETE'];if(!Is.Defined(sSize))
sSize=0;if(this.__small){tags_html=tags(aItems[sItId].EVNTYPE);if(tags_html){scss.push('tags');}}
aRow[sTitle]=[tags_html+parseFileSize(sSize),parseInt(sSize)];break;case'EVNNOTE':if(aItems[sItId]['EVNDESCFORMAT']=='text/html'&&aItems[sItId][sTitle]){aRow[sTitle]=[aItems[sItId][sTitle].removeTags(),aItems[sItId][sTitle]];break;}
case'ITMTITLE':if('G'===sFolType&&'I'===aItems[sItId]['ITMCLASS']){aItems[sItId][sTitle]=aItems[sItId]['ITMDESCRIPTION'];}
default:if(Is.String(aItems[sItId][sTitle]))
aRow[sTitle]=[aItems[sItId][sTitle],aItems[sItId][sTitle]];else
aRow[sTitle]=aItems[sItId][sTitle];break;}}
aResult[sItId]={"id":sItId,"css":scss.join(' '),"data":aRow,"arg":{'aid':this._aFolder.aid,'fid':this._aFolder.fid,'iid':sItId}};}
return aResult;};_me.__parseTime=function(nUTime)
{if(!nUTime){return'';}
var oDate=new IcewarpDate(nUTime*1000);return[CalendarFormatting.simplified(oDate),'',oDate.format("L LT")];};_me.__parseGwTime=function(sDate,sTime,bEnd){if(typeof sTime=='undefined'){if(typeof sDate=='undefined'||sDate==0){return'';}}
var oDate=new IcewarpDate(sDate,{format:IcewarpDate.JULIAN});oDate.setTime(sTime>0?sTime:0,true);if(bEnd&&sTime<0){oDate.date(oDate.date()-1);}
return CalendarFormatting.normalWithTime(oDate);};_me._onresizeend=function(aColumns)
{if(this._cookiesEnabled&&this._getFolder)
{var oFolder=this._getFolder();if(!oFolder)
return;var aNewColumns={};for(var sColumn in aColumns)
aNewColumns[sColumn]=aColumns[sColumn]['width'];Cookie.set(['views',oFolder['aid'],oFolder['fid'],'columns',screen.width+'x'+screen.height],aNewColumns,true);}};_me._getFolder=function(){return this._aFolder;};

/* client/inc/obj_datagrid2_ext.js */
_me=obj_datagrid2_ext.prototype;function obj_datagrid2_ext(){};_me.__initdrag=function(id,x,y){if(inArray(this.__value,id)<0){this._value([id]);}
var
out=[],aHtml=[],f=this._getFolder(),sType=WMFolders.getType(f),aRights=WMFolders.getAccess(f),data,rowData,i,j,ds;for(i in this.__valueData){data=this.__valueData[i];if(!data){continue;}
rowData=data.data;ds=dataSet.get('items',[f.aid,f.fid,i]);for(j in ds){rowData[j]=ds[j];}
out.push(typeof data=='object'&&data.arg?data.arg:{id:id});if(aHtml.length<5){switch(sType){case'Q':case'M':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.SUBJECT)+'</th><td>'+(rowData.DATE?IcewarpDate.unix(rowData.DATE).format('L LT'):'')+'</td><td>&nbsp;'+(rowData.SIZE?parseFileSize(rowData.SIZE):'')+'</td></tr>');break;case'J':case'E':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.EVNTITLE)+'</th><td>'+this.__getEscapedArrayString(rowData.EVENT_STARTDATE)+'</td><td>-</td><td>'+this.__getEscapedArrayString(rowData.EVENT_ENDDATE)+'</td></tr>');break;case'N':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.EVNTITLE)+'</th>');break;case'T':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.EVNTITLE)+'</th><td>'+this.__getEscapedArrayString(rowData.TASK_ENDDATE)+'</td></tr>');break;case'C':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.ITMCLASSIFYAS)+'</th><td>'+this.__getEscapedString(rowData.CONTACT_EMAIL)+'</td></tr>');break;case'F':aHtml.push('<tr><th>'+this.__getEscapedString(rowData.EVNTITLE)+'</th><td>'+this.__getEscapedArrayString([rowData.EVNFILESIZE[0].replace(/<p.*p>/,'')])+'</td></tr>');break;default:break;}}
else if(aHtml.length===5){aHtml.push('<tr><td colspan="10" style="text-align: left"></td></tr>');}}
if(aHtml.length>0){gui.frm_main.dnd.create_drag('<table class="tbl_datagrid_'+sType+'">'+aHtml.join('')+'</table>',{type:this.__dragtype,value:out,select_all:this._select_all&&!this._SQLsearch},x,y,!aRights.remove);}};_me.__getEscapedString=function(value){value=value&&typeof value==='string'?value:'';return value.escapeHTML();};_me.__getEscapedArrayString=function(array){var value=array&&typeof array==='object'&&typeof array[0]==='string'?array[0]:'';return value.escapeHTML();};_me._onchange=function(ids){if(gui.frm_main.hmenu3)
gui.frm_main.hmenu3._contextRefill(ids);var aFolder=this._getFolder();gui.__exeEvent('itemSelected',[aFolder.aid,aFolder.fid].concat(ids.length?[ids]:[]));if(this.__cursortimer){window.clearTimeout(this.__cursortimer);delete this.__cursortimer;}
var v=this._value();if(v.length==1){this.__cursortimer=window.setTimeout(function(){try{if(this.__value[0]){var data=this._aData[this.__value[0]];if(data){var arg=data.arg||{};if(this._onclick)
this._onclick({type:'click',button:1},null,arg,this.__value[this.__value.length-1],null,[]);this.__exeEvent('onclick',null,{"arg":arg,"id":data.id,"owner":this});}}}catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er)}}.bind(this),GWOthers.getItem('LAYOUT_SETTINGS','PREVIEW_DELAY'));}};_me._ondblclick=function(e,elm,arg){if(!elm){if(arg&&arg['aid']&&arg['fid']){var aValues;switch(dataSet.get('folders',[arg['aid'],arg['fid'],'TYPE'])){case'E':aValues=getActualEventTime();case'C':case'L':case'T':case'J':case'F':case'N':if(WMFolders.getAccess(arg,'write'))
Item.createInFolder(arg['aid'],arg['fid'],aValues);break;case'M':var aOpt={alias:Item.getAliasFromPath(arg['aid']+'/'+arg['fid'])};if(arg['aid']+'/'+arg['fid']==GWOthers.getItem('DEFAULT_FOLDERS','templates'))
aOpt.template=true;NewMessage.compose(aOpt);break;case'QL':gui._create('frm_blackwhite','frm_blackwhite','','',arg['aid'],arg['fid']);}}
return;}
var sType=dataSet.get('folders',[arg['aid'],arg['fid'],'TYPE']);if(sType=='C'&&dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'ITMCLASS'])=='L')
sType='L';if(sType=='G')
Item.recover([arg['aid'],arg['fid'],[arg['iid']]],true);else
if(sType=='M'||sType=='Q'){if(GWOthers.getItem('DEFAULT_FOLDERS','drafts')==arg['aid']+'/'+arg['fid'])
OldMessage.edit([arg['aid'],arg['fid'],arg['iid']]);else if(GWOthers.getItem('DEFAULT_FOLDERS','templates')==arg['aid']+'/'+arg['fid'])
NewMessage.compose(new OldMessage([arg['aid'],arg['fid'],arg['iid']]));else{var aSortInfo=clone(this.__filter);aSortInfo.offset=this.__limit[0];aSortInfo.limit=this.__limit[1];if(this.__small)
aSortInfo.row=Math.ceil(parseInt(elm.parentNode.style.top||elm.style.top,10)/this._row_height)-this.__offset;else
aSortInfo.row=Math.ceil(parseInt(elm.style.top,10)/this._row_height)-this.__offset;OldMessage.openwindow([arg['aid'],arg['fid'],arg['iid']],aSortInfo);}}
else
if(sType=='F'){var sName=dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'EVNTITLE']);var ext=Path.extension(sName).toLowerCase();switch(ext){case'txt':case'htm':case'html':Item.editFile([arg['aid'],arg['fid'],arg['iid']]);break;case'pdf':if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/))
Item.downloadFile([arg['aid'],arg['fid'],arg['iid']]);else
Item.openPDF([arg['aid'],arg['fid'],arg['iid']]);break;case'mp3':Item.playFile([arg['aid'],arg['fid'],arg['iid']]);break;default:if(sName&&Item.officeSupport(sName)){var folder=dataSet.get('folders',[arg.aid,arg.fid.split('/')[0]]);Item.officeOpen(arg,[Item.downloadFile,[[arg['aid'],arg['fid'],arg['iid']]]],ext);}
else
Item.downloadFile([arg['aid'],arg['fid'],arg['iid']]);}}
else
if(sType!='QL')
Item.openwindow([arg['aid'],arg['fid'],arg['iid']],'','',sType);};_me._oncontext=function(e,elm,arg,sLineId,sColumn){var sType;if(!arg||!arg['iid']){var aItems=dataSet.get('items');for(var sAccId in aItems)
for(var sFolId in aItems[sAccId])
break;var arg={'aid':sAccId,'fid':sFolId};if((sType=dataSet.get('folders',[arg['aid'],arg['fid'],'TYPE']))){gui._create("cmenu","obj_context_item",'','',this);gui.cmenu._fillGeneralMenu(sType,arg);}
else
return;}
else
if((sType=dataSet.get('folders',[arg['aid'],arg['fid'],'TYPE']))){var aSelected=this._value(),bDisableOpen=false;if(sType=='C'&&dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'ITMCLASS'])=='L')
sType='L';if(inArray(aSelected,arg['iid'])>=0&&aSelected.length>1)
bDisableOpen=true;if(inArray(aSelected,arg['iid'])<0){aSelected=[arg['iid']];this._value(aSelected);}
arg.data=dataSet.get('items',[arg['aid'],arg['fid'],arg['iid']]);gui._create("cmenu","obj_context_item",'','',this)._fillMenu(sType,arg,aSelected,bDisableOpen,false,sColumn);}
else
return;gui.cmenu._place(e.clientX,e.clientY);};_me._onclick=function(e,elm,arg,line,column,aClickType)
{if(inArray(aClickType,'SHIFT')>-1||inArray(aClickType,'CTRL')>-1)
return;var sType=dataSet.get('folders',[arg['aid'],arg['fid'],'TYPE']);if(sType=='C'&&dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'ITMCLASS'])=='L')
sType='L';var aAccess=WMFolders.getAccess(arg);if(column=='DELETE'&&aAccess.modify){this.__deleteItems(arg,[arg['iid']]);return false;}
switch(sType){case'T':if(column=='CHECK'){if(aAccess.modify){var stat='M';if(dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'EVNSTATUS'])=='M')
stat='B';var me=this;dataSet.add('items',[arg['aid'],arg['fid'],arg['iid'],'EVNSTATUS'],stat);WMItems.add([arg['aid'],arg['fid'],arg['iid']],{'values':{'EVNSTATUS':stat}},'','','',[function(){if(me&&!me.__destructed)me._serverSort();}]);}
break;}
case'F':if(column=='LOCK'&&aAccess.modify){var aRights=WMFolders.getRights(arg),lockID=dataSet.get('items',[arg['aid'],arg['fid'],arg['iid'],'EVNLOCKOWN_ID']);if(!lockID||lockID==sPrimaryAccountGWID||aRights.owner){dataSet.add('items',[arg['aid'],arg['fid'],arg['iid'],'EVNLOCKOWN_ID'],(lockID?'':sPrimaryAccountGWID));Item.set_lock([arg['aid'],arg['fid'],arg['iid']],(lockID?false:true),true);}
break;}
case'C':case'L':case'E':case'J':case'N':case'G':if((gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.itemview)||(e.type=='keydown'&&e.keyCode==13))
Item.open([arg['aid'],arg['fid'],arg['iid']]);break;case'Q':case'M':if(column=='COLOR'&&aAccess.modify){var id=[arg['aid'],arg['fid'],arg['iid']];var sColor=OldMessage.getColor(id);if(!sColor||sColor==Item.COLORS.COMPLETE||sColor==Item.COLORS.CLEAR){storage.library('gw_others');var sDefaultColor=GWOthers.getItem('MAIL_SETTINGS_GENERAL','default_flag');OldMessage.setColor(id,sDefaultColor);}
else
OldMessage.setColor(id,Item.COLORS.COMPLETE);return false;}
if(column===null&&e.ctrlKey)
OldMessage.openwindow([arg['aid'],arg['fid'],arg['iid']]);else{dataSet.add('active_items',[arg['aid'],arg['fid']],arg['iid']);if(gui.frm_main.main.mailview){OldMessage.open([arg['aid'],arg['fid'],arg['iid']],false,e instanceof Event);}
else
if(e.type=='keydown'&&e.keyCode==13){var aSortInfo,elm,column=column||this.__sortColumn;if(Is.Defined(column)&&(elm=this.__getElement([line,column]))){aSortInfo=clone(this.__filter);aSortInfo.row=Math.ceil(parseInt(elm.style.top,10)/this._row_height)-this.__offset;}
OldMessage.openwindow([arg['aid'],arg['fid'],arg['iid']],aSortInfo);}}
break;}};_me._onkeydown=function(e){var value=this._value();if(Is.Empty(value))return;var aFolder=this._getFolder(),sAccId=aFolder.aid,sFolId=aFolder.fid,sType=dataSet.get('folders',[sAccId,sFolId,'TYPE']);if((e.keyCode>95&&e.keyCode<106)||(e.keyCode==107||e.keyCode==109)){var color;if(e.keyCode==107)
color='COMPLETE';else
if(e.keyCode==109)
color='CLEAR';else{if(sType=='M')
var colors=['RED','BLUE','GREEN','ORANGE','PURPLE','YELLOW'];else
if(sType=='N')
var colors=['BLUE','GREEN','RED','','GREY','YELLOW'];else
var colors=['RED','BLUE','GREEN','GREY','ORANGE','CYAN','BROWN','PURPLE','LIGHT_BLUE','YELLOW'];if(!(color=colors[e.keyCode-96]))return;}
for(var i in value)
if(sType=='M')
OldMessage.setColor([sAccId,sFolId,value[i]],Item.COLORS[color]);else
if(WMFolders.getAccess({aid:sAccId,fid:sFolId},'modify'))
Item.setColor([sAccId,sFolId,value[i]],Item.COLORS[color]);}
else
if(!e.ctrlKey)
switch(e.keyCode){case 82:if(sType=='M'){OldMessage.reply([sAccId,sFolId,value[0]],e.shiftKey);e.preventDefault();}
break;case 70:if(sType=='M')
OldMessage.forward([sAccId,sFolId,value[0]],e.shiftKey);break;case 78:if(sType=='M'){var aOpt={alias:Item.getAliasFromPath(sAccId+'/'+sFolId)};if(sAccId+'/'+sFolId==GWOthers.getItem('DEFAULT_FOLDERS','templates'))
aOpt.template=true;NewMessage.compose(aOpt);}
break;case 67:Item.copy([sAccId,sFolId,value]);break;case 77:if(sType!='M'&&!WMFolders.getAccess({aid:sAccId,fid:sFolId},'remove'))break;Item.move([sAccId,sFolId,value]);break;case 69:if(sType=='M')
for(var i in value)
OldMessage.markAsRead([sAccId,sFolId,value]);break;case 85:if(sType=='M')
for(var i in value)
OldMessage.markAsUnread([sAccId,sFolId,value]);break;case 46:this.__deleteItems(aFolder,value,e.shiftKey);}};_me.__deleteItems=function(aFolder,value,shiftKey,oRepeating){var sType=WMFolders.getType(aFolder);if(sType!='Q'&&sType!='QL'&&!WMFolders.getAccess(aFolder,'remove')){gui.notifier._value({type:'alert',args:{header:'',text:'ALERTS::DELETE_ITEM'}});return;}
if(sType==='G'&&dataSet.get('main',['keep_deleted_items_force_expiration'])){return;}
var pos=0,v=clone(value),act=v.pop(),tmp=[],b;for(var i in this._aData){b=false;for(j in v){if(v[j]==i){b=true;break;}}
if(!b){if(act==i)
pos=tmp.length;tmp.push(i);}}
tmp.splice(pos,1);var iNext;if(typeof tmp[pos]=='undefined'){if(pos>0)
iNext=tmp[--pos];else
if(typeof tmp[pos+1]=='undefined')
iNext=tmp[pos];else
iNext=tmp[++pos];}
else
iNext=tmp[pos];Item.remove([aFolder.aid,aFolder.fid,value],shiftKey,oRepeating,this,iNext);};

/* client/inc/obj_datagrid2_notify.js */
_me=obj_datagrid2_notify.prototype;function obj_datagrid2_notify(){};_me.__constructor=function(){if(gui.socket){this._add_destructor('__notify_off');this._notification(true);}};_me._notification=function(b){if(gui.socket)
if(b)
gui.socket.api._obeyEvent('onnotify',[this,'__notify']);else
this.__socket_off();};_me.__notify=function(aData){if(this._destructed||!this._aFolder)
return false;if(aData.owner&&aData.owner==this._pathName)
return;if(this._aFolder.aid==sPrimaryAccount&&this._aFolder.fid==Path.slash(aData.FOLDER)&&aData['TYPE']=='item'){if(this._onnotify)
this._onnotify(aData);this.__exeEvent('onnotify',null,{"data":aData,"owner":this});}};_me.__notify_off=function(){if(gui.socket)
gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);};

/* client/inc/obj_datagrid_core.js */
_me=obj_datagrid_core.prototype;function obj_datagrid_core(){};_me.__constructor=function(){var me=this;this._telemetry='off';this._main.parentNode.style.overflow='hidden';this.__sortColumn;this.__sortType;this._aData;this._aCols;this._cookiesEnabled=false;this._SQLfilter='';this._SQLfilter_last='';this._SQLfulltext='';this._SQLfulltext_last='';this.__value=[];this.__valueData={};this.__cursor;this.__dragtype='';this.__dndtimer='';this.__eHeader=this._getAnchor('header');this.__eBody=this._getAnchor('body');this.__eContainer1=this._getAnchor('container1');this.__eContainer2=this._getAnchor('container2');this._scrollbar(this.__eContainer2);this.__move_timeout;this.__eHeader.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(e.button==2||elm==this)return true;if(elm.tagName=='DIV'||elm.tagName=='P'){var id=me.__getId(elm.id||elm.parentNode.id,'#');if(!id||!(id=id[0]))
return;if(elm.tagName=='DIV'){if(me.__move_timeout)
window.clearTimeout(me.__move_timeout);me.__move_timeout=window.setTimeout('try{'+me._pathName+'.__move("'+id+'",'+e.clientX+');}catch(err){gui._REQUEST_VARS.debug && console.log(this._name||false,err);}',400);}
else{elm=elm.parentNode;if(me._onresize)me._onresize(e,elm,id,me._aCols[id].arg);me.__exeEvent('onresize',e,{"arg":me._aCols[id].arg,"id":id,"elm":elm,"owner":me});}}};this.__eHeader.onmouseup=function(e){if(me.__move_timeout){window.clearTimeout(me.__move_timeout);me.__move_timeout=null;}};this.__eHeader.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='P'||elm==this)
return false;if(me.__move_timeout)window.clearTimeout(me.__move_timeout);elm=elm.id?elm:elm.parentNode;var id=elm.id;if(elm.tagName!='DIV'||!id||!(id=me.__getId(id,'#'))||!(id=id[0]))return;var arg=me._aCols[id].arg;if(!arg||!arg.sort)return;if(me.__sortColumn==null)
me.__sortType=arg.sort=='desc'?1:0;else
if(me.__sortColumn!=id){var tmp;if((tmp=me.__getElement([me.__sortColumn],'#')))
removecss(tmp,'desc','asc');tmp=null;me.__sortType=arg.sort=='desc'?1:0;}
else{removecss(elm,'desc','asc');me.__sortType=me.__sortType?0:1;}
addcss(elm,me.__sortType?'desc':'asc');me._serverSort('',id,me.__sortType?'desc':'asc');if(me._onsort)me._onsort(e,elm,id,arg,(me.__sortType?'desc':'asc'));me.__exeEvent('onsort',e,{"arg":arg,"id":id,"type":(me.__sortType?'desc':'asc'),"elm":elm,"owner":me});if(gui.telemetry)
gui.telemetry._add({id:elm.id,type:me._type});};this.__eContainer2.onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(me.__dndtimer)
window.clearTimeout(me.__dndtimer);var id,arg={};if(me._getFolder)
arg=me._getFolder();if(elm.tagName=='DIV'&&!elm.id&&elm.parentNode.id)
elm=elm.parentNode;if(elm.tagName!='DIV'&&elm!=this)
elm=Is.Child(elm,'DIV');if(elm&&elm.tagName=='DIV'&&elm.id&&(id=me.__getId(elm.id))){if(id[0]){me._select_all=false;if(id[1]&&me._aData[id[0]]&&me._aData[id[0]].arg)
arg=objConcat(arg,me._aData[id[0]].arg);if(e.type=='contextmenu'){if(me._oncontext)me._oncontext(e,elm,arg,me._aData[id[0]].id,id[1]);me.__exeEvent('oncontext',e,{"arg":arg,"id":me._aData[id[0]].id,"cell":id[1],"elm":elm,"owner":me});return false;}
if(id[1]){if(e.type=='dblclick'){if(me._ondblclick)
me._ondblclick(e,elm,arg,id[0],id[1]);me.__exeEvent('ondblclick',e,{"arg":arg,"id":id[0],"cell":id[1],"elm":elm,"owner":me});return true;}
if(!me._select_single&&(e.ctrlKey||e.metaKey)){var p,v=clone(me.__value);if((p=inArray(v,id[0]))>-1)
v.splice(p,1);else
v.push(id[0]);me._value(v);}
else
if(!me._select_single&&e.shiftKey)
me.__blockselection(id[0],true);else
me._value([id[0]]);var aClickType=[];if(e.ctrlKey||e.metaKey)
aClickType.push('CTRL');if(e.shiftKey)
aClickType.push('SHIFT');if(me._onclick)me._onclick(e,elm,arg,id[0],id[1],aClickType);me.__exeEvent('onclick',e,{"arg":arg,"id":id[0],"cell":id[1],"elm":elm,"owner":me});}}}
else
delete arg.iid;if(e.type=='dblclick'){if(me._ondblclick)
me._ondblclick(e,null,arg);me.__exeEvent('ondblclick',e,{"owner":me,"arg":arg});}
else
if(e.type=='contextmenu'){if(me._oncontext)
me._oncontext(e,null,arg);me.__exeEvent('oncontext',e,{"owner":me,"arg":arg});return false;}
return true;};this.__iScroll_left=0;this.__eContainer2.onscroll=function(e){if(me.__iScroll_left!=this.scrollLeft){me.__iScroll_left=this.scrollLeft;if(gui._rtl&&this.scrollRight)
me.__eHeader.style.marginRight=-this.scrollRight+'px';else
me.__eHeader.style.marginLeft=-me.__iScroll_left+'px';}
if(me.__selectByPosition)
me._selectPosition();};this._getAnchor('noitems').oncontextmenu=this._getAnchor('noitems').ondblclick=function(e){var e=e||window.event,arg={};if(me._getFolder)
arg=me._getFolder();if(e.type=='dblclick'){if(me._ondblclick)
me._ondblclick(e,null,arg);me.__exeEvent('ondblclick',e,{"owner":me,"arg":arg});return true;}
else
if(e.type=='contextmenu'){if(me._oncontext)
me._oncontext(e,null,arg);me.__exeEvent('oncontext',e,{"owner":me,"arg":arg});return false;}};this._main.oncontextmenu=this.__eContainer2.onclick;this.__eContainer2.ondblclick=this.__eContainer2.onclick;this.__eContainer2.onmousedown=function(e){if(me.__dndtimer){window.clearTimeout(me.__dndtimer);delete me.__dndtimer;}
else{var e=e||window.event;if(!me.__dragtype||e.button>1||!me.__initdrag)return true;var elm=e.target||e.srcElement,id,x=e.clientX,y=e.clientY;if(elm.tagName=='DIV'&&elm.id&&(id=me.__getId(elm.id))&&id[0]&&id[1]){if(navigator&&navigator.browser&&navigator.browser.application=='Safari')
me._disable_scrolbar(me.__eContainer2,true,true);gui._obeyEvent('mouseup',[me,'__dndDispatch']);me.__dndtimer=window.setTimeout(function(){try{me.__initdrag(id[0],x,y);}catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}},500);}}};this._main.setAttribute('tabindex',-1);if(~currentBrowser().indexOf('MSIE')){AttachEvent(this._main,'onclick',function(){me._focus();});}
AttachEvent(this._main,'onfocus',function(e){if(this.__blurTimeout)clearTimeout(this.__blurTimeout);addcss(me._main,'focused');});AttachEvent(this._main,'onblur',function(e){this.__blurTimeout=setTimeout(function(){try{removecss(me._main,'focused');}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}},200);});AttachEvent(this._main,'onkeydown',function(e){var e=e||window.event,src=e.target||e.srcElement,preventDefault=false;if(Is.Defined(src.value))
return;switch(e.keyCode){case 13:if(me.__value.length&&me.__value[0]){var data=me._aData[me.__value[0]];if(data){var arg=data.arg||{};if(me._onclick)
me._onclick(e,null,arg,me.__value[me.__value.length-1],null,[]);me.__exeEvent('onclick',null,{"arg":arg,"id":data.id,"owner":me});}}
return;case 33:preventDefault=e.shiftKey;if(me.__eContainer2.scrollTop==0)
me._selectPosition('top');else{var sCol,elm,v=me._value();if(v&&(v=v[v.length-1])){if(me.__small)
sCol='*';else
for(sCol in me._aCols)
break;if(sCol&&(elm=document.getElementById(me._pathName+'/'+v+'/'+sCol))){var box=getSize(me.__eContainer2),pos=getSize(elm);if(pos.y>box.y&&pos.y-pos.h>box.y){me._selectPosition('top');return;}}}
me._value([]);me.__selectByPosition='top';me.__eContainer2.scrollTop-=me.__eContainer2.offsetHeight;}
return;case 34:preventDefault=e.shiftKey;if(me.__eContainer2.scrollTop+me.__eContainer2.offsetHeight==me.__eContainer2.scrollHeight)
me._selectPosition('bottom');else{var sCol,elm,v=me._value();if(v&&(v=v[v.length-1])){if(me.__small)
sCol='*';else
for(sCol in me._aCols)
break;if(sCol&&(elm=document.getElementById(me._pathName+'/'+v+'/'+sCol))){var box=getSize(me.__eContainer2),pos=getSize(elm);if(pos.y+pos.h<box.y+box.h&&pos.y+(2*pos.h)<box.y+box.h){me._selectPosition('bottom');return;}}}
me._value([]);me.__selectByPosition='bottom';me.__eContainer2.scrollTop+=me.__eContainer2.offsetHeight;}
return;case 35:preventDefault=e.shiftKey;if(me.__eContainer2.scrollTop+me.__eContainer2.offsetHeight==me.__eContainer2.scrollHeight)
me._selectPosition('bottom');else{me._value([]);me.__selectByPosition='bottom';me.__eContainer2.scrollTop=me.__eContainer2.scrollHeight;}
return;case 36:preventDefault=e.shiftKey;if(me.__eContainer2.scrollTop==0)
me._selectPosition('top');else{me._value([]);me.__selectByPosition='top';me.__eContainer2.scrollTop=0;}
return;case 37:preventDefault=e.shiftKey;var s=0;if((s=me.__eContainer2.scrollLeft)>0){s-=20;me.__eContainer2.scrollLeft=s<0?0:s;}
return;case 39:preventDefault=e.shiftKey;me.__eContainer2.scrollLeft+=20;return;case 38:preventDefault=e.shiftKey;if(me.__value.length){var act=me.__value[me.__value.length-1],iPos;for(var i in me._aData){if(i==act)break;iPos=i;}
if((!e.shiftKey||me._select_single)&&typeof iPos!='undefined')
me._value([iPos]);}
break;case 40:preventDefault=e.shiftKey;if(me.__value.length){var act=me.__value[me.__value.length-1],found=false;for(var iPos in me._aData){if(found)
break;if(iPos==act)
found=true;}
if(!e.shiftKey||me._select_single)
me._value([iPos]);}
break;default:if(!me._select_single&&e.ctrlKey&&!e.altKey&&e.keyCode==65){me._select_all=true;var tmp=[];for(var i in me._aData)
tmp.push(i);me._value(tmp);e.preventDefault();}
if(me._onkeydown){setTimeout(function(){me._onkeydown(e);},0);}
return;}
if(preventDefault){e.preventDefault();}
if(!me._select_single&&e.shiftKey&&(e.keyCode==38||e.keyCode==40))
me.__blockselection(iPos);if(me._onkeypress)
me._onkeypress(e);});var eFrame=mkElement('iframe',{frameborder:0,name:this._pathName+"#frame",marginheight:0,marginwidth:0,src:"",id:this._pathName+'#frame'});this._main.appendChild(eFrame);eFrame.contentWindow.onresize=function(e){if(this.__width!=eFrame.offsetWidth){this.__width=eFrame.offsetWidth;me.__exeEvent('onsize',e,{"width":this.__width,"owner":me});}};};_me._placeholder=function(sValue,bHTML){this._getAnchor('noitems')[bHTML?'innerHTML':'innerText']=sValue||getLang('DATAGRID::NOITEMS');};_me.__dndDispatch=function(){if(navigator&&navigator.browser&&navigator.browser.application=='Safari')
this._disable_scrolbar(this.__eContainer2,false,false);if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
return false;};_me._disabled=function(b){if(Is.Defined(b))
window[b?'addcss':'removecss'](this._main,'disabled');else
return hascss(this._main,'disabled');};_me._getFocusElement=function(){return this._main;};_me._focus=function(){this._getFocusElement().focus();};_me._selectFirst=function(){if(this.__eContainer2.scrollTop==0)
for(var id in this._aData){this._value([id]);return true;}
return false;};_me.__blockselection=function(id,bClick){if(typeof id=='undefined')
return;var j,v=clone(this.__value);if(this.__small)
j='*';else
for(j in this._aCols)
break;if(!this.__getElement([v[v.length-1],j])){this._value([id]);return;}
var elm,id_pos,aBlock=[];for(var i=v.length-1;i>=0;i--){if((elm=this.__getElement([v[i],j]))){aBlock.push([v[i],elm.offsetTop/this._row_height]);if(v[i]==id)
id_pos=aBlock[aBlock.length-1][1];elm=null;}
else
v.splice(i,1);}
if(typeof id_pos=='undefined')
if((elm=this.__getElement([id,j])))
id_pos=elm.offsetTop/this._row_height;else
return;if(aBlock.length)
var act=aBlock[0];else{this._value([id]);return;}
function sortblock(a,b){return a[1]-b[1];};aBlock.sort(sortblock);for(var act_pos=-1,i=aBlock.length-1;i>=0;i--)
if(act===aBlock[i])
act_pos=i;var tmp=act[1];if(act_pos)
for(var i=act_pos-1;i>=0;i--){if(tmp==aBlock[i][1]+1)
tmp=aBlock[i][1];else{aBlock=aBlock.slice(i+1);act_pos-=i+1;break;}}
var tmp=act[1];for(var i=act_pos+1,j=aBlock.length-1;i<=j;i++){if(tmp==aBlock[i][1]-1)
tmp=aBlock[i][1];else{aBlock=aBlock.slice(0,i);break;}}
if(act[1]<id_pos){if(bClick){aBlock=[];var bFound=false;for(var i in this._aData){if(i==act[0])
bFound=true;if(bFound){aBlock.push([i]);if(i==id)
break;}}
aBlock.reverse();}
else
if(act_pos==0&&aBlock.length>1&&id_pos-act[1]==1){aBlock.shift();aBlock.reverse();}
else
if(act_pos==aBlock.length-1)
aBlock.push([id]);else{aBlock=aBlock.slice(act_pos+1);aBlock.reverse();}}
else{if(bClick){var tmp=[],bFound=false;for(var i in this._aData){if(i==id)
bFound=true;if(bFound)
tmp.push([i]);if(i==act[0])
break;}
aBlock=tmp;}
else
if(act_pos>0&&act_pos==aBlock.length-1)
aBlock.pop();else
if(act_pos==0)
aBlock.push([id]);else
aBlock=aBlock.slice(0,act_pos);}
var out=[];for(var i in aBlock)
out.push(aBlock[i][0]);this._value(out,!bClick);};_me._value=function(v,bScroll,bTimer,bNoUpdate){if(typeof v=='undefined')
return clone(this.__value);else
if(Is.Array(v)){var elm,tmpData={};this.__selectByPosition='';for(var i in this.__value)
if(inArray(v,this.__value[i])<0){if(this.__small){if((elm=this.__getElement([this.__value[i],'*']))){removecss(elm,'active');elm=null;}}
else
for(var j in this._aCols)
if((elm=this.__getElement([this.__value[i],j]))){removecss(elm,'active');elm=null;}}
this.__value=v;for(var i in v){if(this._aData[v[i]])
tmpData[v[i]]=this._aData[v[i]];else
if(this.__valueData[v[i]])
tmpData[v[i]]=this.__valueData[v[i]];else
tmpData[v[i]]={id:v[i]};if(this.__small){if((elm=this.__getElement([v[i],'*']))){addcss(elm,'active');}}
else
for(var j in this._aCols){if((elm=this.__getElement([v[i],j])||elm)){if(addcss(elm,'active')<1)
break;}}}
this.__valueData=tmpData;if((v.length==1||bScroll)&&elm){var a1=this.__eContainer2.scrollTop;if(elm.offsetTop<a1)
this.__eContainer2.scrollTop=elm.offsetTop;else{var a2=this.__eContainer2.offsetHeight,row=elm.offsetTop+elm.offsetHeight;if(a1+a2<row)
this.__eContainer2.scrollTop=row-a2;}}
elm=null;if(!bNoUpdate){if(this._onchange)
this._onchange(this.__value);this.__exeEvent('onchange',null,{"value":this.__value,"owner":this});}
if(this.info)
this.info._value(this.__value.length,this.__total);}};_me._onresize=function(e,elm,id,arg){var me=this,bDynamic=false;gui._disobeyEvent('mousemove',[this,'__mmove_resize']);gui._disobeyEvent('mouseup',[this,'__mup_resize']);for(var i in this._aCols)
if(this._aCols[i].mode=='%'&&this._aCols[i].display!='small'){bDynamic=true;break;}
var aCols=[],tmp=elm,sID,oCol=null,maxPos=0;do{if(tmp.id&&(sID=this.__getId(tmp.id,'#')[0])&&this._aCols[sID]){aCols.push({id:sID,headerElm:tmp,columnElm:this.__getElement([sID]),position:gui._rtl?parseInt(tmp.style.right):tmp.offsetLeft,width:tmp.offsetWidth,mode:this._aCols[sID].mode,type:this._aCols[sID].type});}}
while((tmp=tmp.nextSibling)&&tmp.id);if(!aCols.length)
return;if(bDynamic){for(var i=1,j=aCols.length;i<j;i++){if(aCols[i]&&aCols[i].type!='static'){oCol=aCols[i];break;}}
if(oCol)
maxPos=oCol.width;else
return;}
var difX=e.clientX,difS=this.__eContainer2.scrollLeft;this.__mmove_resize=function(e){var move=e.clientX-difX,pos=gui._rtl?-move:move+(me.__eContainer2.scrollLeft-difS);for(var i=0,j=aCols.length;i<j;i++){if(i==0){var w=gui._rtl?aCols[0].width-move:aCols[0].width+move;if(w<me._col_width){w=me._col_width;pos=w-aCols[0].width;}
else
if(bDynamic&&(maxPos-me._col_width<pos)){pos=maxPos-me._col_width;w=pos+aCols[0].width;}
aCols[0].newWidth=w;aCols[0].headerElm.style.width=w+'px';if(aCols[0].columnElm)
aCols[0].columnElm.style.width=w+'px';if(!bDynamic&&gui._rtl)
me.__eHeader.style.marginRight=(me.__eContainer2.clientWidth-me.__eContainer2.scrollWidth+me.__eContainer2.scrollLeft)+'px';}
else{var s=aCols[i].position+pos;aCols[i].headerElm.style[gui._rtl?'right':'left']=s+'px';if(aCols[i].columnElm)
aCols[i].columnElm.style[gui._rtl?'right':'left']=s+'px';if(bDynamic&&oCol.headerElm===aCols[i].headerElm){oCol.newWidth=maxPos-pos;oCol.headerElm.style.width=oCol.newWidth+'px';if(aCols[i].columnElm)
oCol.columnElm.style.width=oCol.newWidth+'px';break;}}}};this.__mup_resize=function(){gui._disobeyEvent('mousemove',[me,'__mmove_resize']);var iDynWidth=0;if(bDynamic){for(var i in me._aCols)
if(me._aCols[i].mode=='%'&&(elm=this.__getElement([i],'#'))){iDynWidth+=elm.offsetWidth;}}
for(var i=0,j=aCols.length;i<j;i++){if(me._aCols[aCols[i].id]&&Is.Defined(aCols[i].newWidth)){if(aCols[i].mode=='%')
me._aCols[aCols[i].id].width=Math.round(aCols[i].newWidth/(iDynWidth/100),2);else
me._aCols[aCols[i].id].width=aCols[i].newWidth;}}
if(me._onresizeend)me._onresizeend(me._aCols);me.__exeEvent('onresizeend',null,{"cols":me._aCols,"owner":me});return false;};gui._obeyEvent('mouseup',[this,'__mup_resize']);gui._obeyEvent('mousemove',[this,'__mmove_resize']);};_me.__move=function(id,difX){var me=this;var elm=this.__getElement([id],'#').cloneNode(true);addcss(elm,'coldrag');this.__eHeader.appendChild(elm);var pos=getSize(elm);pos.l=elm.offsetLeft;if(gui._rtl)
pos.r=parseInt(elm.style.right);var col=this._aCols[id];var aelm=mkElement('div',{className:'arrow_div'});this.__eHeader.appendChild(aelm);var offX=0,aCols=[],tmpX=0,targetId=id,tmp;for(var i in this._aCols){if(this._aCols[i].display!='small'&&(tmp=this.__getElement([i],'#'))){aCols.push([tmpX,i]);tmpX+=tmp.offsetWidth;}}
if(tmpX)
aCols.push([tmpX]);function mouseup(e){gui._disobeyEvent('mousemove',[mousemove]);gui._disobeyEvent('mouseup',[mouseup]);if(elm)
elm.parentNode.removeChild(elm);if(aelm)
aelm.parentNode.removeChild(aelm);if(targetId==id)
me._addColumns(me._aCols);else{var tmp={};for(var i in me._aCols){if(i==id)
continue;if(i==targetId)
tmp[id]=col;tmp[i]=me._aCols[i];}
if(targetId==null)
tmp[id]=col;me._addColumns(tmp);}
if(me._onresizeend)me._onresizeend(me._aCols);me.__exeEvent('onresizeend',null,{"cols":me._aCols,"owner":me});};gui._obeyEvent('mouseup',[mouseup]);var difS=me.__eContainer2.scrollLeft;var scrollRight=me.__eContainer2.scrollRight||0;var offX=difX-pos.x;function mousemove(e){var e=e||window.event,left=gui._rtl?pos.r-(e.clientX-difX):pos.l+(e.clientX-difX),prev,p=gui._rtl?left+me.__eContainer2.scrollRight-scrollRight:left+me.__eContainer2.scrollLeft-difS;for(var i in aCols){if(aCols[i][0]>=p+offX){next=i;break;}
else
prev=i;}
if(!gui._rtl)left=p;if(left<0)left=0;elm.style[gui._rtl?'right':'left']=left+'px';if(aCols[prev])
if(typeof prev!='undefined'&&aCols[prev]&&aCols[prev][1]!=id&&(!aCols[prev-1]||aCols[prev-1][1]!=id)){aelm.style[gui._rtl?'right':'left']=aCols[prev][0]+'px';targetId=aCols[prev][1];}
else
{if(aCols[prev][1]==id)
targetId=id;else
targetId=null;aelm.style[gui._rtl?'right':'left']='';}};gui._obeyEvent('mousemove',[mousemove]);};_me.__getId=function(id,separator){if(id.indexOf(this._pathName+(separator||'/'))!==0)
return;else{var ids=id.substr(this._pathName.length+1).split(separator||'/');for(var i=ids.length-1;i>=0;i--)
ids[i]=decodeURIComponent(ids[i]);return ids;}};_me.__getElement=function(id,separator){var tmp=[this._pathName];for(var i=0;i<id.length;i++)
tmp.push(encodeURIComponent(id[i]));return document.getElementById(tmp.join(separator||'/'));};_me._addColumns=function(aData){if(aData){if(Is.Empty(aData)){if(this.info)
this.info._stop();this._aCols={};}
else
this._aCols=aData;}
else
if(!this._aCols)return;this.__prevSort=this.__sortColumn;this.__prevSortType=this.__sortType;this.__eHeader.innerHTML='';var sCSS='',eCol,bDynamic=false;for(var i in this._aCols){if(this._aCols[i]['display']=='small'||(this._aCols[i].hasOwnProperty('hideColumnFor')&&-1!==this._aCols[i].hideColumnFor.indexOf('all'))){continue;}
if(this._aCols[i].mode=='%')
bDynamic=true;sCSS=this._aCols[i].css||'';if(this.__sortColumn==i)
sCSS+=(sCSS?' ':'')+(this.__sortType?'desc':'asc');eCol=mkElement('div',{id:this._pathName+'#'+i,className:'col '+sCSS});if(this._aCols[i].type!='static')
eCol.appendChild(mkElement('p'));eCol.appendChild(mkElement('div',{unselectable:"on",innerHTML:this._aCols[i].text||(this._aCols[i].title?getLang(this._aCols[i].title,'',2):'')||'&nbsp;'}));this.__eHeader.appendChild(eCol);}
this.__fitwidth();if(bDynamic){this._obeyEvent('onsize',[this,'__fitwidth']);addcss(this._main,'dynamic');}
else{this._disobeyEvent('onsize',[this,'__fitwidth']);removecss(this._main,'dynamic');}};_me.__fitwidth=function(){if(this.__small)
return;var iWidth=0,aDyn=[],w;for(var i in this._aCols){if(this._aCols[i]['display']=='small'||(this._aCols[i].hasOwnProperty('hideColumnFor')&&-1!==this._aCols[i].hideColumnFor.indexOf('all'))){continue;}
w=parseInt(this._aCols[i].width||this._col_width,10);aDyn.push({elm:this.__getElement([i],"#"),elm2:this.__getElement([i]),width:w,mode:this._aCols[i].mode});if(this._aCols[i].mode!='%')
iWidth+=w;}
if(aDyn.length){var iOffset=0,iDynOffset=0,iDynWidth=Math.max(this.__eContainer2.offsetWidth-iWidth,0),iControl=0;for(var i=0,j=aDyn.length;i<j;i++){aDyn[i].elm.style[gui._rtl?'right':'left']=iOffset+'px';if(aDyn[i].elm2)
aDyn[i].elm2.style[gui._rtl?'right':'left']=iOffset+'px';if(aDyn[i].mode=='%'){if(iDynWidth>0){var v=aDyn[i].width;if(v+iControl>100)
v=100-iControl;var w=Math.ceil(iDynWidth/100*v);if(iDynOffset+w>iDynWidth)
w=iDynWidth-iDynOffset;aDyn[i].elm.style.width=w+'px';if(aDyn[i].elm2)
aDyn[i].elm2.style.width=w+'px';iControl+=v;iOffset+=w;iDynOffset+=w;}
else{aDyn[i].elm.style.width=this._col_width+'px';if(aDyn[i].elm2)
aDyn[i].elm2.style.width=this._col_width+'px';iOffset+=parseInt(this._col_width,10);}}
else{aDyn[i].elm.style.width=aDyn[i].width+'px';if(aDyn[i].elm2)
aDyn[i].elm2.style.width=aDyn[i].width+'px';iOffset+=aDyn[i].width;}}}};_me._editColumn=function(id,sColumn,aInpControl,aHandler){if(this._aData[id]){this._anchors['#edit']=this._pathName+'/'+id+'/'+sColumn;var elm=this._getAnchor('#edit');if(elm){this._disable_scrolbar(this.__eContainer2,true);if(this.edit)
this.edit._destruct();addcss(elm,'edit');var edit=this._create('edit',aInpControl['type']||'obj_input','#edit','edit_column');edit.__returnScrollbar=function(){try{removecss(elm,'edit')}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{this._parent._disable_scrolbar(this._parent.__eContainer2,false);}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}};edit._add_destructor('__returnScrollbar');edit._onblur=function(){this._onsubmit();};edit._onclose=function(e){this._destruct();};edit._onclick=function(e){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();};edit._onsubmit=function(){if(!this._destructed){if(aInpControl['restrictions']&&!edit._validate())
return false;if(aHandler&&edit.__oldValue!=edit._value()){var sOut=executeCallbackFunction(aHandler,this._value());if(sOut!==false){this._destruct();if(Is.String(sOut))
elm.innerHTML=sOut;}}
else
this._destruct();}};if(aInpControl['restrictions']){if(aInpControl['restrictions']instanceof Array)
edit._restrict.apply(edit,aInpControl['restrictions']);else
edit._restrict(aInpControl['restrictions']);}
if(aInpControl['fill'])
edit._fill(aInpControl['fill']);if(aInpControl['value'])
edit.__oldValue=aInpControl['value'];else
if(Is.Array(this._aData[id].data[sColumn]))
edit.__oldValue=this._aData[id].data[sColumn][1]||this._aData[id].data[sColumn][0];else
edit.__oldValue=this._aData[id].data[sColumn];edit._value(edit.__oldValue);edit._focus(true);}}};_me._fill=function(aData,rowOffset){if(this.edit)
return;if(aData){if(typeof rowOffset=='undefined')
this._aData=aData;else
for(var i in aData)
this._aData[i]=aData[i];}
else
var aData=this._aData;var bNewFolder=true;if(this._aFolderLast&&this._aFolderLast.aid==this._aFolder.aid&&this._aFolderLast.fid==this._aFolder.fid)
bNewFolder=false;if(typeof this.__total!='undefined')
this.__eBody.style.height=(this.__total*this._row_height)+'px';var aCols={},tmp,css,css2;if(this.__small){if(!bNewFolder&&(tmp=this.__eBody.firstChild)&&tmp.id==this._pathName+'/*'){aCols['*']=tmp;if(typeof rowOffset=='undefined')
aCols['*'].innerHTML='';}
else{var child;while(child=this.__eBody.lastChild)
this.__eBody.removeChild(child);var s={width:'100%'};s[gui._rtl?'right':'left']=0;aCols['*']=mkElement('div',{id:this._pathName+'/*',style:s,className:'col unicolumn'});if(this.__smallOptions&&this.__smallOptions.css)
addcss(aCols['*'],this.__smallOptions.css);this.__eBody.appendChild(aCols['*']);}
this.__fillSort&&this.__fillSort();this.__fillFilter&&this.__fillFilter();}
else{if((tmp=this.__eBody.firstChild)&&tmp.id==this._pathName+'/*')
bNewFolder=true;if(!bNewFolder&&this.__eBody.hasChildNodes()){for(var i in this._aCols)
if((tmp=this.__getElement([i]))){aCols[i]=tmp;if(typeof rowOffset=='undefined')
aCols[i].innerHTML='';}}
else{if(bNewFolder){var child;while(child=this.__eBody.lastChild)
this.__eBody.removeChild(child);}
for(var i in this._aCols){if(!this.__small&&(this._aCols[i].display=='small'||(this._aCols[i].hasOwnProperty('hideColumnFor')&&-1!==this._aCols[i].hideColumnFor.indexOf('all')))){continue;}
aCols[i]=mkElement('div',{id:this._pathName+'/'+encodeURIComponent(i)});this.__eBody.appendChild(aCols[i]);aCols[i].className='col '+(this._aCols[i].css||'')+(this.__sortColumn==i?' sort':'');}
this.__fitwidth();}}
var val={},bChange=false;for(var i=this.__value.length;i--;){if(!this.__limit&&!aData[this.__value[i]]){this.__value.splice(i,1);bChange=true;}
else
val[this.__value[i]]=1;}
var tmp,str,offset,sTitle,cell,row;if(typeof rowOffset=='undefined')
offset=this.__offset*this._row_height;else
offset=rowOffset;tmp='';for(var i in aData){tmp=aData[i];css=[];tmp.css&&css.push(tmp.css);if(val[i]){css.push('active');}
if(this.__small){row=mkElement('div',{id:this._pathName+'/'+encodeURIComponent(i)+'/*',style:{top:offset+'px',height:this._row_height+'px'},className:css.join(' ')});aCols['*'].appendChild(row);}
for(var j in this._aCols){sTitle='';css2=[];str='';if(this.__small){if(this._aCols[j]['display']!='all'&&this._aCols[j]['display']!='small')
continue;if(this._aCols[j].hasOwnProperty('hideColumnFor')&&-1!==this._aCols[j].hideColumnFor.indexOf('small')){continue;}
css=['col_'+j];this._aCols[j].css&&css.push(this._aCols[j].css);}
else{if(this._aCols[j].hasOwnProperty('hideColumnFor')&&-1!==this._aCols[j].hideColumnFor.indexOf('all')){continue;}
if(this._aCols[j]['display']=='small')
continue;}
if(typeof tmp.data[j]=='object'){if(tmp.data[j][0])
str=tmp.data[j][0];if(tmp.data[j][2]&&!window.navigator.msPointerEnabled&&!('-ms-scroll-limit'in document.documentElement.style&&'-ms-ime-align'in document.documentElement.style))
sTitle=tmp.data[j][2];if(tmp.data[j][3])
css2.push(tmp.data[j][3]);}
else
if(tmp.data[j])
str=tmp.data[j];var attrs={id:this._pathName+'/'+encodeURIComponent(i)+'/'+encodeURIComponent(j),className:[].concat(css,css2).join(' '),unselectable:'on'};if(sTitle){attrs.title=sTitle;}
cell=mkElement('div',attrs);if(!this.__small){cell.style.top=offset+'px';cell.style.height=this._row_height+'px';}
if(str){if(gui._rtl&&this._aCols[j].bidi){var bdi=document.createElement('bdi');bdi.appendChild(document.createTextNode(str));cell.appendChild(bdi);}else
if(this._aCols[j].encode)
cell.appendChild(document.createTextNode(str));else
cell.innerHTML=str;}
if(this.__small)
row.appendChild(cell);else
if(aCols[j])
aCols[j].appendChild(cell);}
offset+=this._row_height;}
this._getAnchor('noitems').style.display=tmp?'none':'block';aCols=null;this.__sbar_init(this.__eContainer2,true);if(!this.__reizeInterval&&this.__check_size){var me=this;this._add_destructor('__clearInterval');this.__reizeInterval=setInterval(function(){try{if(me.__check_size)me.__check_size();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}},2000);}
if(bChange){if(this._onchange)
this._onchange(this.__value);this.__exeEvent('onchange',null,{"value":this.__value,"owner":this});}
if(this.__selectByPosition)
this._selectPosition();if(this._select_all){var tmp=this._value();this._value(tmp.concat(Object.getOwnPropertyNames(aData)));}};_me._selectPosition=function(sbp,bReturn){var sbp=sbp||this.__selectByPosition;if(sbp){this.__selectByPosition='';if(this.__small)
var sCol='*';else
for(var sCol in this._aCols)
break;if(sCol){var elm,pos,pid,box=getSize(this.__eContainer2);for(var id in this._aData){if((elm=document.getElementById(this._pathName+'/'+id+'/'+sCol))){pos=getSize(elm);switch(sbp){case'top':if(pos.y>=box.y){this._value([id]);return;}
break;case'bottom':if(pos.y+pos.h<=box.y+box.h)
pid=id;else
if(pid){this._value([pid]);return;}
break;default:return;}}}
if(pid)
this._value([pid]);}}};_me.__clearInterval=function(){if(typeof this.__reizeInterval!='undefined')
clearInterval(this.__reizeInterval);};_me._listen_data=function(sDataSet,aDataPath,bNoUpdate){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet,bNoUpdate);};_me.__refreshHeaders=function(){var i,headers,header;headers=this.__eHeader.childNodes;for(i=0;i<headers.length;i++){header=headers[i];removecss(header,'desc','asc');if(-1!==this.__getId(header.id,'#').indexOf(this.__sortColumn)){addcss(header,this.__sortType?'desc':'asc');}}};_me.__update=function(sName,aDPath){};

/* client/inc/obj_datagrid_small.js */
_me=obj_datagrid_small.prototype;function obj_datagrid_small(){};_me.__constructor=function(){this.__small=false;this.__oldSmall=false;this.__smallOptions=null;};_me._small=function(aParams){if(!aParams){if(this.__smallOptions!=null){this._disobeyEvent('onsize',[this,'_onsize']);}
this.__smallOptions=null;this._smallfilter='';if(this.sort)
this.sort._destruct();if(this.filter)
this.filter._destruct();}
else{var me=this;if(this.__smallOptions==null){this._obeyEvent('onsize',[this,'_onsize']);}
if(aParams.filters){this.filter||this._create('filter','obj_hmenu','filter','filter');this._getAnchor('small_header').classList.remove('no-filter');}else{this.filter&&this.filter._destruct();this._getAnchor('small_header').classList.add('no-filter');}
if(aParams.sorting&&!this.sort){this._create('label','obj_label','sort','label');this.label._value(getLang('SORT::SORT_BY')+':');this._create('sort','obj_hmenu','sort','sort');this.sort._onclick=function(a,b,c,arg){switch(arg){case'asc':case'desc':this.__dir=arg;break;default:this.__sort=arg;}
me._serverSort&&me._serverSort('',this.__sort,this.__dir);};}
this.__smallOptions=aParams;this.__smallOptions.size=this.__smallOptions.size||500;}
this._onsize();};_me.__fillSort=function(){if(!this._aCols||!this.sort){return;}
var sortLabel;this.sort.__sort=this.__sortColumn;this.sort.__dir=this.__sortType?'desc':'asc';var sorts=[];for(var i in this._aCols){if(this._aCols[i].arg&&this._aCols[i].arg.sort&&this._aCols[i]['display']&&this._aCols[i].title){var title=this._aCols[i].title==='DATAGRID_ITEMS_VIEW::ITMCLASSIFYAS'?'DATAGRID_ITEMS_VIEW::NAME':this._aCols[i].title;sorts.push({title:title,arg:i,css:'ico2'+(this.sort.__sort===i?' check':'')});if(this.sort.__sort===i){sortLabel=title;}}}
var asc='SORT::'+this.sort.__sort+'_ASC';var desc='SORT::'+this.sort.__sort+'_DESC';if('{'+asc+'}'===getLang(asc)||!getLang(asc)){asc='SORT::ASC';}
if('{'+desc+'}'===getLang(desc)||!getLang(desc)){desc='SORT::DESC';}
sorts.push({title:'-'},{arg:'asc',title:asc,css:'ico2'+(this.sort.__dir==='asc'?' check':'')},{arg:'desc',title:desc,css:'ico2'+(this.sort.__dir==='desc'?' check':'')});this.sort._fill([{title:sortLabel,nodetype:'click',callback:[function(){return sorts;}]}],'static');};_me.__fillFilter=function(){if(!(this.__smallOptions||{}).filters||!this.filter){return;}
this.filter._fill([{title:this.__smallOptions.filters.filter(function(filter){return filter.search===(this._smallfilter||'');},this)[0].text,nodetype:'click',callback:[function(){return this.__smallOptions.filters.map(function(filter){return{title:filter.text,arg:[filter.search],css:'ico2'+(filter.search===(this._smallfilter||'')?' check':'')};}.bind(this));}.bind(this)]}],'static');this.filter._onclick=function(e,elm,id,args){this._onfilterchange(args[0]);this.__fillFilter();}.bind(this);};_me._onfilterchange=function(sValue){this._smallfilter=sValue;if(this._cookiesEnabled){var aFolder=this._getFolder();Cookie.set(['views',aFolder['aid'],aFolder['fid'],'filter'],this._smallfilter);}
this._serverSort();};_me._onsize=function(e,arg){if(this.__smallOptions==null)
return;var bRefresh=!!e;if(bRefresh&&!this.__small)
this.__refreshHeaders();var cb=false;var me=this;if(this.__smallOptions==null){if(this.__small==true){this.__small=false;cb=function(){me._main&&removecss(me._main,'small');};this._row_height=this._original_height;}
else
return;}
else{var width=this._main.offsetWidth;if(width<=this.__smallOptions.size&&!this.__small)
this.__small=true;else
if(width>this.__smallOptions.size&&this.__small)
this.__small=false;else
bRefresh=false;if(this.__small){cb=function(){me._main&&addcss(me._main,'small');};this._row_height=25*(this.__smallOptions.rows||1);}
else{cb=function(){me._main&&removecss(me._main,'small');};this._row_height=this._original_height;}}
if(bRefresh){this.__oldSmall=this.__small;this.__limit=[0,0];if(this._serverSort)
this._serverSort(void 0,void 0,void 0,cb?[cb]:void 0);else{this._fill();cb&&cb();}}else if(this.__oldSmall!==this.__small){this.__oldSmall=this.__small;cb&&cb();}};

/* client/inc/obj_day_of_week.js */
_me=obj_day_of_week.prototype;function obj_day_of_week(){};_me.__constructor=function(){var sOptName;this._aDays={'sunday':0,'monday':1,'tuesday':2,'wednesday':3,'thursday':4,'friday':5,'saturday':6};var aLabels={'sunday':"DAYS::SUNDAY",'monday':"DAYS::MONDAY",'tuesday':"DAYS::TUESDAY",'wednesday':"DAYS::WEDNESDAY",'thursday':"DAYS::THURSDAY",'friday':"DAYS::FRIDAY",'saturday':"DAYS::SATURDAY"};storage.library('gw_others');var which=(7-this._aDays[GWOthers.getItem('CALENDAR_SETTINGS','week_begins')])%7;for(var day in this._aDays){sOptName='day_'+which;this._create(day,'obj_checkbox',sOptName,'',aLabels[day]);which=(which+1)%7;}
this._objects=getSubobjects(this,this._objects);};_me._value=function(v){var n;if(Is.Defined(v)){for(var i in this._objects){n=Math.pow(2,this._aDays[i]);this._objects[i]._value(v&n);}}else{var nResult=0;for(var i in this._objects){if(this._objects[i]._value())nResult|=Math.pow(2,this._aDays[i]);}
return nResult;}};_me._disabled=function(b){for(var i in this._objects)this._objects[i]._disabled(b);};

/* client/inc/obj_dayview.js */
_me=obj_dayview.prototype;function obj_dayview(){};_me.__constructor=function(owner){this._closeOnContext=false;this._create('day','obj_evnview');if(owner){this.day._onchange=function(aValues){owner._onchange(aValues,true);};this.day._onadd=function(aValues){owner._onadd(aValues);};this.day._onremove=function(id){owner._onremove(id);};this.day._ondblclick=function(e,elm,arg){owner._ondblclick(e,elm,arg);};this.day._oncontext=function(e,elm,arg){owner._oncontext(e,elm,arg);};}};_me._setRange=function(r){this.day._range(r,r,GWOthers.getItem('CALENDAR_SETTINGS','day_begins'),GWOthers.getItem('CALENDAR_SETTINGS','day_ends'));};_me._listen_data=function(sDataSet,aDataPath){this.day._listen_data(sDataSet,aDataPath);};

/* client/inc/obj_dtmf.js */
_me=obj_dtmf.prototype;function obj_dtmf(){};_me.__constructor=function(){this._draw('obj_dtmf','main');this.btn_0._onclick=function(){var sip=gui.frm_main.sip,v={btn_0:0,btn_1:1,btn_2:2,btn_3:3,btn_4:4,btn_5:5,btn_6:6,btn_7:7,btn_8:8,btn_9:9,btn_star:'*',btn_sharp:'#'}[this._name];if(sip&&dataSet.get('sip',['activity'])=="Phoning")
sip._dtmf(v);removecss(this._main,'focus');};this.btn_1._onclick=this.btn_0._onclick;this.btn_2._onclick=this.btn_0._onclick;this.btn_3._onclick=this.btn_0._onclick;this.btn_4._onclick=this.btn_0._onclick;this.btn_5._onclick=this.btn_0._onclick;this.btn_6._onclick=this.btn_0._onclick;this.btn_7._onclick=this.btn_0._onclick;this.btn_8._onclick=this.btn_0._onclick;this.btn_9._onclick=this.btn_0._onclick;this.btn_star._onclick=this.btn_0._onclick;this.btn_sharp._onclick=this.btn_0._onclick;};

/* client/inc/obj_edit_header.js */
_me=obj_edit_header.prototype;function obj_edit_header(){};_me.__constructor=function(){var me=this;this.__aValues='';this._create('button','obj_button');this.button._value('FILTERS::THREE_DOTS');this.button._onclick=function(){gui._create('edit_header','frm_edit_header','','',me);};};_me._value=function(v){if(Is.Defined(v))
this.__aValues=v;else
return this.__aValues;};_me._disabled=function(b){this.button._disabled(b);};

/* client/inc/obj_evnmonth.js */
_me=obj_evnmonth.prototype;function obj_evnmonth(){};_me.__constructor=function(){var me=this;this._active=new IcewarpDate();this._dDate=new IcewarpDate();this.__range={};this.__value;this.__idTable=[];this.__activeEvent;this.__iToday;this._row_height=24;this.__rights={'read':true,'write':true,'modify':true,'remove':true};this.__holidays=false;this._selection={startdate:0,enddate:0};this.__noRefresh=false;storage.library('gw_others');var aData={"days":IcewarpDate.weekdaysShort()};this._getAnchor('header').innerHTML=template.tmp('obj_evnmonth_header',aData);this.__edit=false;this.__editEvent='';this.__eIN=this._getAnchor('input');this.__eIN.onkeyup=function(e){if(!me.__edit){var e=e||window.event,newEvn={};if(!me.__rights.modify){if(!me.__activeEvent||!(newEvn=me._useItem(me.__activeEvent))||newEvn.owner!=sPrimaryAccountGWID)
return;}
switch(e.keyCode){case 13:case 27:this.value='';return false;case 46:gui.generaltooltip&&!gui.generaltooltip._destructed&&gui.generaltooltip._destruct();if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent))&&!newEvn.disabled&&me.__rights.remove){if(me._onremove)
me._onremove(me.__activeEvent,e.shiftKey);me.__exeEvent('_onremove',null,{"owner":me,"event":me.__activeEvent});}
break;case 1000:case 113:if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent))){if(newEvn.disabled||newEvn.startdate<me.__range['start']||newEvn.startdate>me.__range['end'])
return;me.__edit=true;if(e.keyCode==113)
this.value=newEvn.title;me.__editEvent=me.__activeEvent;me.__createEdit();me.__edit=false;}
return false;default:if(this.value.length){if(!me._selection.startdate&&me._selection.startdate>=me.__range['start']&&me._selection.startdate<=me.__range['end']){newEvn=clone(me._selection);newEvn.starttime=-1;newEvn.endtime=-1;newEvn.evnclass='E';newEvn.id='edit';newEvn.title=this.value||'';me.__edit=true;me.__activeEvent=newEvn.id;me.__value.push(newEvn);me.__editEvent=me.__activeEvent;me._fill(me.__value);me.__edit=false;}else
if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent)))
this.onkeyup({keyCode:1000});}}}};this._main.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!=='INPUT'){me._focus();}};this._main.onmouseup=this._main.onmousedown;this.__eMain=this._getAnchor('main');this._scrollbar(this.__eMain,this.__eMain.parentNode);this.__eMain.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm===this){return;}
var info=me.__getInfo(e,elm),arg=null;switch(info['type']){case'TD':case'TH':var d=new Date(),e=new Date(d);var msSinceMidnight=e-d.setHours(0,0,0,0);arg={"startdate":info.pos,"starttime":msSinceMidnight/1000,"_event":'blank'};break;case'SPAN':case'B':case'INS':case'I':case'P':for(var i=0;i<me.__idTable.length;i++)
if(me.__idTable[i].id==info.id){arg=clone(me.__idTable[i]);arg._event='event';if(arg.starttime<0)
arg.enddate=parseInt(arg.enddate)+1;break;}}
if(arg&&!arg.disabled){if(me._ondblclick){me._ondblclick(e,elm,arg);}
me.__exeEvent('ondblclick',e,{"elm":elm,"owner":me,"arg":arg});}};this.__eMain.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm===this){return;}
var info=me.__getInfo(e,elm),arg=null;switch(info['type']){case'TD':case'TH':if(info.pos<me._selection.startdate||info.pos>me._selection.enddate){me.__draw_selection(info.pos);}
arg={"startdate":me._selection.startdate,"enddate":me._selection.enddate,"_event":'selection'};arg.contains=[];for(var i in me.__value){if(me.__value[i].evnclass=='E'&&me.__value[i].startdate>=me._selection.startdate&&me.__value[i].enddate<=me._selection.enddate){arg.contains.push(me.__value[i].id);}}
break;case'SPAN':case'INS':case'B':case'I':case'P':for(var i=0;i<me.__idTable.length;i++){if(me.__idTable[i].id==info.id){arg=clone(me.__idTable[i]);arg._event='event';break;}}
me._activate(info);if(arg.starttime<0){arg.enddate=parseInt(arg.enddate)+1;}}
if(arg){if(me._oncontext){me._oncontext(e,elm,arg);}
me.__exeEvent('oncontext',e,{"elm":elm,"owner":me,"arg":arg});}
return false;};this.__eMain.ondrag=function(){return false;};this.__eMain.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='EM'){e.__source={obj:me,skip:true,type:me._type,name:me._pathName};var cell=getSize(elm.parentNode),view=getSize(me._main),w=cell.w>250?cell.w:250;this.preview=gui._create('preview','obj_dayview','','',me);this.preview._place(view.x+view.w<cell.x+w+20?view.x+view.w-w+20:cell.x,view.y,w,view.h);var info=me.__getInfo(e,elm);this.preview._setRange(info.pos);this.preview._listen_data(me._listener_data,me._listenerPath_data);}};this.__eMain.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='INPUT'||elm===this||e.button==2)
return;var sAction='move';var info=me.__getInfo(e,elm);switch(info['type']){case'TH':case'TD':me.__draw_selection(info.pos);gui._obeyEvent('mouseup',[me,'__mouseup']);this.onmousemove=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm==this)
return;var info2=me.__getInfo(e,elm);if(info2.pos>=info.pos)
me.__draw_selection(info.pos,info2.pos);else
me.__draw_selection(info2.pos,info.pos);};break;case'SPAN':if(elm.parentNode.tagName=='P')
sAction=(Math.abs(e.layerX||e.offsetX)<10)?'start':'end';case'INS':case'B':case'I':case'P':me._activate(info);var arg=null,itm=null;for(var i=0;i<me.__value.length;i++)
if(me.__value[i].id==info.id){itm=me.__value[i];arg=clone(itm);break;}
if(arg!=null&&!arg.disabled){if(!me.__rights.modify&&(!itm||itm.owner!=sPrimaryAccountGWID))
return false;var cursor_offset=info.pos-arg['start'];if(!Is.Number(cursor_offset))
return false;gui._obeyEvent('mouseup',[me,'__mouseup',[arg,itm]]);this.onmousemove=function(evn){var evn=evn||window.event,elm=evn.target||evn.srcElement;if(elm==this)
return;var info2=me.__getInfo(evn,elm);if(info2.pos>0){if(sAction=='move'&&itm.startdate!=info2.pos-cursor_offset){info2.pos-=cursor_offset;var tmp=parseInt(itm.enddate,10)-parseInt(itm.startdate,10);itm.startdate=parseInt(info2.pos,10);itm.enddate=parseInt(info2.pos,10)+tmp;me._fill(me.__value);}else
if(sAction=='start'&&itm.startdate!=info2.pos&&info2.pos<=itm.enddate){itm.startdate=info2.pos;me._fill(me.__value);}else
if(sAction=='end'&&info2.pos>=itm.startdate){if(itm.endtime===0)
itm.enddate=info2.pos+1;else
itm.enddate=info2.pos;me._fill(me.__value);}else
return;if(!hascss(this,'dragged'))
addcss(this,'dragged');}};}}
return false;};};_me.__mouseup=function(e,tmp,arg,itm){gui._disobeyEvent('mouseup',[this,'__mouseup']);this.__eMain.onmousemove=null;removecss(this.__eMain,'dragged');if(arg&&itm&&(arg.startdate!=itm.startdate||arg.enddate!=itm.enddate)){var out={starttime:itm.starttime,endtime:itm.endtime,startdate:itm.startdate,enddate:itm.enddate,evnclass:itm.evnclass,evntimeformat:itm.evntimeformat,id:itm.id,tmp_id:itm.tmp_id};if(this._onchange)
this._onchange(out);this.__exeEvent('onchange',null,{"owner":this,"event":out});}};_me.__getIDs=function(id){var out=[],i;for(i=0;i<this.__idTable.length;i++)
if(this.__idTable[i].id==id)
out.push(this.__idTable[i].tmp_id);return out;};_me.__getInfo=function(evn,elm){var pos,elm=elm,sType,id,tmp_id;switch(elm.tagName){case'EM':case'H3':case'DIV':while(true){elm=elm.parentNode;if(elm.tagName=='TD'||elm.tagName=='TH')
break;if(elm==this)
return;}
case'TD':case'TH':sType=elm.tagName;if(elm.id)
pos=parseInt(elm.id.substr(elm.id.lastIndexOf(elm.id.indexOf('#')>-1?'#':'/')+1),10);break;case'SPAN':case'INS':case'B':case'I':sType='SPAN';if(elm.parentNode.tagName=='SPAN')
offset=8;elm=Is.Child(elm,'P');case'P':if(elm.id&&(tmp_id=id=elm.id.substr(elm.id.lastIndexOf(elm.id.indexOf('#')>-1?'#':'/')+1))){sType=sType||'P';pos=parseInt(elm.getAttribute('rel'),10);var iDays;if((iDays=parseInt(elm.style.width,10)/100)>1){var aPos=getSize(elm);pos+=Math.floor((evn.clientX-aPos.x)/(aPos.w/iDays));}
var p;if((p=id.indexOf('-'))>-1)
id=id.substr(0,p);}}
return{pos:pos,elm:elm,'type':sType,tmp_id:tmp_id,id:id};};_me._fill=function(aDataIn){var today=new IcewarpDate();var aData={"days":IcewarpDate.weekdaysShort()};var aTags=dataSet.get('tags')||{};this._getAnchor('header').innerHTML=template.tmp('obj_evnmonth_header',aData);if(gui._rtl){this._getAnchor('header').querySelector('.table_header').setAttribute('dir','rtl');}
if(this._dDate.format(IcewarpDate.JULIAN)!==+this.__range['start']||this.__iToday!==today.format(IcewarpDate.JULIAN)){var start_day=new IcewarpDate(+this._dDate).startOf('month').startOf('week');var month=today.month();var end_day=new IcewarpDate(+this._dDate).endOf('month').endOf('week').add(1,'day');var aWeek=[];var week=[];var start=start_day.clone();this.__range['start']=start_day.format(IcewarpDate.JULIAN);while(!start_day.isSame(end_day,'day')){var current_month=start_day.month();week.push({julian:start_day.format(IcewarpDate.JULIAN),value:start_day.date(),_date:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')>=0?start_day.clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')}):false,class:(start_day.isSame(today,'day')?'today ':'')+(current_month===month?'month ':'')});start_day.add(1,'day');if(start_day.day()===IcewarpDate.firstDayOfWeek()){aWeek.push(week.slice(0));week=[];}}
var end=start_day.clone().subtract(1,'days');this.__range['end']=start_day.format(IcewarpDate.JULIAN);if(+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')>=0){start=start.clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')});end=end.clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')});gui.frm_main.main._main.querySelector('.alternative_calendar').textContent=start.format('LL')+' - '+end.format('LL');}
var str;if(gui._rtl){str=['<table border="0" class="evnmonth_calendar" dir="rtl"><tbody>'];}else{str=['<table border="0" class="evnmonth_calendar"><tbody>'];}
for(var i=0;i<aWeek.length;i++){str.push('<tr class="day_header">');for(var j=0;j<aWeek[i].length;j++)
str.push('<th id="'+this._pathName+'#'+aWeek[i][j].julian+'"'+(aWeek[i][j]['class']?' class="'+aWeek[i][j]['class']+'"':'')+'><h3 unselectable="on"><em></em>'+aWeek[i][j].value+(aWeek[i][j]._date?('<span style="font-weight: normal;"> / '+aWeek[i][j]._date.date()+'</span>'):'')+'</h3></th>');str.push('</tr><tr class="days">');for(var j=0;j<aWeek[i].length;j++){str.push('<td id="'+this._pathName+'/'+aWeek[i][j].julian+'"'+(aWeek[i][j]['class']?' class="'+aWeek[i][j]['class']+'"':'')+' unselectable="on">');str.push('</td>');}
str.push('</tr>');}
str.push('</tbody></table>');this.__eMain.innerHTML=str.join('');this.__holidays=false;this.__draw_selection();this.__autoscroll=true;}
var holidays={},bBreak=false,tmpEvn,tmpEvn2;if(typeof aDataIn=='object'){this.__value=aDataIn;this.__idTable=[];var bCelsius=GWOthers.getItem('CALENDAR_SETTINGS','temperature')=='C',aLoc;for(var i in this.__value){this.__value[i].startdate=parseInt(this.__value[i].startdate,10);this.__value[i].enddate=parseInt(this.__value[i].enddate,10);if(this.__value[i].evnclass=='H'){if(!this.__holidays)
for(var j=this.__value[i]['startdate'];j<=this.__value[i]['enddate'];j++){if(!holidays[j])
holidays[j]=[this.__value[i]];else
holidays[j].push(this.__value[i]);}}
else{this.__value[i].starttime=parseInt(this.__value[i].starttime,10);this.__value[i].endtime=parseInt(this.__value[i].endtime,10);tmpEvn=this.__value[i];tmpEvn['start']=tmpEvn.startdate<this.__range['start']?this.__range['start']:tmpEvn.startdate;tmpEvn['end']=tmpEvn.enddate>this.__range['end']?this.__range['end']:tmpEvn.enddate;tmpEvn['startt']=tmpEvn.starttime;tmpEvn['endt']=tmpEvn.endtime;tmpEvn['tmp_id']=tmpEvn.id;if(tmpEvn['startdate']<tmpEvn['enddate']&&tmpEvn['endtime']===0)
tmpEvn['end']--;tmpEvn.color='';tmpEvn.taglist='';if(tmpEvn.evntype){var arr=tmpEvn.evntype.split(','),at={},sColor;for(var t in arr)
if((arr[t]=arr[t].trim()).length){sColor=aTags[arr[t]]&&aTags[arr[t]].TAGCOLOR?aTags[arr[t]].TAGCOLOR:'#FFFFFF';if(!at[sColor])
at[sColor]=[];at[sColor].push(arr[t]);}
for(var t in at){tmpEvn.color+='<ins title="'+at[t].join(', ').escapeHTML().replace(/"/g,'&quot;')+'" style="background-color:'+t+'"></ins>';tmpEvn.taglist+='<li><ins style="background-color:'+t+'"></ins>'+at[t].join(', ').escapeHTML()+'</li>';}}
bBreak=false;if(tmpEvn['start']!=tmpEvn['end']){var no=0;for(var j=tmpEvn['start']+1;j<=tmpEvn['end'];j++){if(!((j-this.__range['start'])%7)){bBreak=true;if(j-tmpEvn['start']<8){tmpEvn2=clone(tmpEvn);tmpEvn2['end']=j-1;tmpEvn2['endt']=86400;tmpEvn2['tmp_id']=tmpEvn2.id+'-'+(no++);this.__idTable.push(tmpEvn2);}
tmpEvn2=clone(tmpEvn);tmpEvn2['start']=j;tmpEvn2['startt']=0;tmpEvn2.tmp_id=tmpEvn2.id+'-'+(no++);if(tmpEvn2['end']-j>6){tmpEvn2['end']=j+6;tmpEvn2['endt']=86400;}
this.__idTable.push(tmpEvn2);}}}
if(!bBreak)
this.__idTable.push(tmpEvn);}}
if(!this.__holidays&&!Is.Empty(holidays)){this.__holidays=true;var aLoc;for(var i in holidays)
if((elm=document.getElementById(this._pathName+'#'+i))){holidays[i].sort(this.__holSort);for(var j=0;j<holidays[i].length;j++){var div=document.createElement('div');div.unselectable="on";if(holidays[i][j].evntype=='Weather'){aLoc=parseURL(holidays[i][j]['location']);if(!Is.Empty(aLoc)&&GWOthers.getItem('RESTRICTIONS','DISABLE_WEATHER_SETTING')==0){aLoc.city=aLoc.loc.split(',')[0];aLoc.low=bCelsius?aLoc.c_lo+'C':aLoc.f_lo+'F';aLoc.high=bCelsius?aLoc.c_hi+'C':aLoc.f_hi+'F';div.appendChild(document.createTextNode(aLoc.high+' '+aLoc.city));div.className="weather ico_"+aLoc.icon;AttachEvent(div,'onmouseover',this._showTooltip({template:'obj_event_weather',values:aLoc}));}}else{div.appendChild(document.createTextNode(holidays[i][j]['title']));div.title=holidays[i][j]['title'];if(holidays[i][j]['location']&&holidays[i][j]['location'].indexOf('type=public')>-1)
div.className="holiday public";else
div.className="holiday";}
elm.appendChild(div);}}}
var aOut={},iWeek,elm;for(var i=parseInt(this.__range['start'],10);i<this.__range['end'];i+=7)
aOut[i]=[];for(var i=0;i<this.__idTable.length;i++){iWeek=Math.floor((this.__idTable[i]['start']-this.__range['start'])/7)*7+this.__range['start'];if(aOut[iWeek])
aOut[iWeek].push(this.__idTable[i]);}
var elm,sHTML,infos,skip,ymax,css,noTitle=getLang('EVENT_VIEW::NO_TITLE'),privateTitle=getLang('EVENT_VIEW::PRIVATE'),t1;for(var iWeek in aOut){aOut[iWeek].sort(this.__evnSort);sHTML='';y=0;ymax=0,infos=[];if((elm=document.getElementById(this._pathName+'/'+iWeek))){for(var i in aOut[iWeek]){infos[i]={};aOut[iWeek][i].y=0;skip={};infos[i].title=aOut[iWeek][i].title?aOut[iWeek][i].title:(aOut[iWeek][i].evnsharetype==='U'?noTitle:privateTitle);for(var j in aOut[iWeek]){if(j==i)
break;if(aOut[iWeek][j]['start']<=aOut[iWeek][i]['start']&&aOut[iWeek][j]['end']>=aOut[iWeek][i]['start']){if(aOut[iWeek][i].y==aOut[iWeek][j].y){while(true)
if(!skip[++aOut[iWeek][i].y])
break;}else
if(aOut[iWeek][i].y<aOut[iWeek][j].y)
skip[aOut[iWeek][j].y]=true;}}
ymax=ymax<aOut[iWeek][i].y?aOut[iWeek][i].y:ymax;css=[];if(aOut[iWeek][i]['start']!=aOut[iWeek][i]['startdate'])
css.push('openStart');if(aOut[iWeek][i]['end']!=aOut[iWeek][i]['enddate']&&!(aOut[iWeek][i]['endtime']===0&&aOut[iWeek][i]['end']+1===aOut[iWeek][i]['enddate']))
css.push('openEnd');if(!this.__rights.modify&&aOut[iWeek][i].owner!=sPrimaryAccountGWID)
css.push('disabled');else
if(aOut[iWeek][i].id==this.__activeEvent)
css.push('active');if(aOut[iWeek][i].conferenceid)
css.push('conference');if(aOut[iWeek][i].color)
css.push('color');if(aOut[iWeek][i].fcolor)
css.push(aOut[iWeek][i].fcolor);if(aOut[iWeek][i].evnflags&32)
css.push('unresponded');if(aOut[iWeek][i].evnflags&4)
css.push('F');if(aOut[iWeek][i].evnflags&8)
css.push('T');if(aOut[iWeek][i].evnflags&16)
css.push('O');t1=t2=false;infos[i].start=IcewarpDate.julian(aOut[iWeek][i].startdate).setTime(aOut[iWeek][i].starttime);infos[i].end=IcewarpDate.julian(aOut[iWeek][i].enddate).setTime(aOut[iWeek][i].endtime);if(aOut[iWeek][i].endtime===-1){infos[i].end.add(1,'day');infos[i].start.add(1,'day');}
if(aOut[iWeek][i].starttime>-1){infos[i].starttime=infos[i].start.format('LT');infos[i].endtime=infos[i].end.format('LT');if(iWeek<=aOut[iWeek][i].startdate)
t1=infos[i].starttime;if(parseInt(iWeek,10)+6>=aOut[iWeek][i].enddate)
t2=infos[i].endtime;}else{infos[i].starttime='';infos[i].endtime='';}
infos[i].duration=aOut[iWeek][i].enddate-aOut[iWeek][i].startdate;if(infos[i].duration){infos[i].duration=new IcewarpNumber(infos[i].duration+1).localize()+' '+getLang(infos[i].duration+1?'TIME::MOREDAYS':'TIME::ONEDAY');}else{if(infos[i].starttime&&infos[i].endtime){infos[i].duration=IcewarpDate.duration(infos[i].end.diff(infos[i].start)).humanize();}else{infos[i].duration='1 '+getLang('TIME::ONEDAY');}}
if(infos[i].start.isSame(infos[i].end,'day')){infos[i].end='';}else{infos[i].end=infos[i].end.format('L');}
infos[i].start=infos[i].start.format('L');infos[i].reminder=!!aOut[iWeek][i].rmnevn_id;infos[i].recurrent=!!aOut[iWeek][i].evnrcr_id;infos[i].location=aOut[iWeek][i].location||'';infos[i].tags=aOut[iWeek][i].taglist;infos[i].owner=aOut[iWeek][i].evnowneremail;sHTML+='<p rel="'+aOut[iWeek][i]['start']+'" id="'+this._pathName+'/'+aOut[iWeek][i].tmp_id+'" style="'+'width:'+((aOut[iWeek][i]['end']-aOut[iWeek][i]['start']+1)*100)+'%;'+
(gui._rtl?'right':'left')+':'+((aOut[iWeek][i]['start']-iWeek)*100)+'%;'+'top:'+(aOut[iWeek][i].y*this._row_height+10)+'px;'+'" '+(css.length?'class="'+css.join(' ')+'"':'')+'>'+'<span unselectable="on"><span unselectable="on">'+
aOut[iWeek][i].color+'<b unselectable="on">'+
(t1?'<i unselectable="on">'+t1+'</i>':'')+
infos[i].title.entityify()+'</b></span></span></p>';}
elm.style.height=(((ymax+1)*this._row_height)+30)+'px';elm.innerHTML='<div style="height: 100%">'+sHTML+'</div>';var p=elm.getElementsByTagName('P');for(var i=0;i<p.length;i++){AttachEvent(p[i],'onmouseover',this._showTooltip({template:'obj_event_tooltip',values:infos[i]}));}}}}
if(this.__edit)
this.__createEdit();else
if(this.__autoscroll&&Is.Defined(aDataIn)){this.__autoscroll=false;var id='gui.frm_main.main.calendar/'+(new IcewarpDate().format(IcewarpDate.JULIAN));var element=document.getElementById(id);if(element&&element.parentElement&&element.parentElement.previousElementSibling){element.parentElement.previousElementSibling.scrollIntoView();}
var go;if(this._selection.startdate&&this._selection.startdate>this.__range['start']&&this._selection.startdate<this.__range['end'])
go=this._selection.startdate;else
if(this.__iToday>this.__range['start']&&this.__iToday<this.__range['end'])
go=this.__iToday;else
return;var elm=document.getElementById(this._pathName+'/'+go);if(elm){var p1=getSize(this.__eMain),p2=getSize(elm);if(p1.y>p2.y)
this.__eMain.scrollTop-=p1.y-p2.y+50;else
if(p1.y+p1.h<p2.y+p2.h)
this.__eMain.scrollTop+=p2.y+p2.h-p1.y-p1.h+50;}}};_me.__createEdit=function(){if(this.__edit&&this.__editEvent){var me=this,elm,ids,inp,itm=this._useItem(this.__editEvent);if(!itm||(!(elm=document.getElementById(this._pathName+'/'+this.__editEvent))&&(!(ids=this.__getIDs(this.__editEvent))||!(elm=document.getElementById(this._pathName+'/'+ids[0]))))){this.__noRefresh=false;return;}
this.__noRefresh=true;elm.innerHTML='<span><input type="text" /></span>';if(ids){var tmp;for(var i=1;i<ids.length;i++)
if((tmp=document.getElementById(this._pathName+'/'+ids[i])))
tmp.innerHTML='<span><span></span></span>';tmp=null;}
if((inp=elm.getElementsByTagName('INPUT'))&&(inp=inp[0])){inp.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 27:this.value='';case 13:this.onblur();return false;}};inp.ondblclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();return false;};inp.onblur=function(e){if(this.value.length){for(var i=me.__value.length-1;i>-1;i--)
if(me.__value[i].id==me.__editEvent){if(me.__value[i].title!=this.value){me.__value[i].title=this.value.trim();me.__noRefresh=false;if(me.__editEvent=='edit'){me.__value[i].disabled=true;if(me._onadd)
me._onadd(me.__value[i]);me.__exeEvent('onadd',null,{"owner":me,"event":me.__value[i]});}else{delete me.__value[i].disabled;if(me._onchange)
me._onchange(me.__value[i]);me.__exeEvent('onchange',null,{"owner":me,"event":me.__value[i]});}}else
delete me.__value[i].disabled;break;}}else
if(me.__editEvent=='edit')
for(var i=me.__value.length-1;i>-1;i--)
if(me.__value[i].id==me.__activeEvent){me.__value.splice(i,1)[0];break;}
me.__editEvent='';if(me.__activeEvent=='edit')
me.__activeEvent='';me.__noRefresh=false;me._fill(me.__value);me._focus();};inp.focus();inp.value=this.__eIN.value||'';}}};_me.__draw_selection=function(iStart,iEnd){var bForce=false;if(typeof iStart=='undefined'){iStart=this._selection.startdate;iEnd=this._selection.enddate;bForce=true;}else{iEnd=!iEnd||iEnd<iStart?iStart:iEnd;for(var elm,i=this._selection.startdate;i<=this._selection.enddate;i++)
if((i<iStart||i>iEnd)&&(elm=this.__getCol(i))){removecss(elm[0],'selected');removecss(elm[1],'selected');}}
for(i=iStart;i<=iEnd;i++)
if((bForce||i<this._selection.startdate||i>this._selection.enddate)&&(elm=this.__getCol(i))){addcss(elm[0],'selected');addcss(elm[1],'selected');}
this._selection={startdate:iStart,enddate:iEnd};if(iStart>0)
this._activate('');};_me.__getCol=function(iJulian){var elm,out=[];if((elm=document.getElementById(this._pathName+'#'+iJulian))){out.push(elm);if((elm=document.getElementById(this._pathName+'/'+iJulian))){out.push(elm);return out;}}
return false;};_me.__holSort=function(a,b){if(a.evntype=='Weather'&&b.evntype!='Weather')
return-1;else
if(a.evntype!='Weather'&&b.evntype=='Weather')
return 1;else
if(a.evntype!='Weather'&&a.evnfolder&&b.evnfolder){if(a.evnfolder<b.evnfolder)
return-1;else
if(a.evnfolder>b.evnfolder)
return 1;}
if(a['title']&&b['title']){if(a['title']<b['title'])
return-1;else
if(a['title']==b['title'])
return 0;else
return 1;}else
if(a['id']<b['id'])
return-1;else
if(a['id']==b['id'])
return 0;else
return 1;};_me.__evnSort=function(a,b){var tmp=(a['start']+a['startt']/100000)-(b['start']+b['startt']/100000)||(b['end']+b['endt']/100000)-(a['end']+a['endt']/100000);if(tmp==0){if(a.title<b.title)
return-1;else
if(a.title>b.title)
return 1;}
return tmp;};_me._value=function(v){if(!this.__noRefresh&&Is.Object(v))
this._fill(v);else
return this.__value;};_me._range=function(aData){if(aData){this._active=new IcewarpDate();this._dDate=new IcewarpDate();if(aData instanceof IcewarpDate){this._active=aData;this._dDate.year(aData.year()).month(aData.month()).date(1);}else{this._active=new IcewarpDate(aData,{format:IcewarpDate.JULIAN});this._dDate=new IcewarpDate(aData,{format:IcewarpDate.JULIAN}).date(1);}
this._fill();}else
return this.__range;};_me._rights=function(v){if(!v)
return this.__rights;this.__rights=v;};_me.__update=function(sDataSet){if(!sDataSet||this.__noRefresh)
return;if(this._listener_data==sDataSet)
this._value(dataSet.get(this._listener_data,this._listenerPath_data));if(this._listener==sDataSet)
this._range(dataSet.get(this._listener,this._listenerPath));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')
this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me._activate=function(info){if(Is.Defined(info)&&(info.id||'')!=this.__activeEvent){var elm;if(this.__activeEvent){if((elm=document.getElementById(this._pathName+'/'+this.__activeEvent)))
removecss(elm,'active');else{var ids=this.__getIDs(this.__activeEvent);for(var i=0;i<ids.length;i++)
if((tmp=document.getElementById(this._pathName+'/'+ids[i])))
removecss(tmp,'active');}}
var itm;if(info.id&&(this.__rights.modify||((itm=this._useItem(info.id))&&itm.owner==sPrimaryAccountGWID))){this.__activeEvent=info.id;if(info.tmp_id!=info.id){ids=this.__getIDs(info.id);for(var i=0;i<ids.length;i++)
if((tmp=document.getElementById(this._pathName+'/'+ids[i])))
addcss(tmp,'active');}else{addcss(info.elm,'active');}
gui.__exeEvent('itemSelected',[this._parent.__aid,this._parent.__fid,[this.__activeEvent]]);this.__draw_selection(0);}else{this.__activeEvent='';gui.__exeEvent('folderSelected',[this._parent.__aid,this._parent.__fid]);}
if(this._onactivate)
this._onactivate([this.__activeEvent]);this.__exeEvent('onactivate',null,{"value":[this.__activeEvent],"owner":this});}else
return this.__activeEvent;};_me._useItem=function(id,aValue){for(var i=this.__value.length-1;i>-1;i--)
if(this.__value[i].id==id)
if(aValue){this.__value[i]=aValue;break;}else
return clone(this.__value[i]);};_me._focus=function(){this.__eIN.value='';this.__eIN.focus();};_me._selectedItems=function(){var ids=[];if(this.__activeEvent){if(this._useItem(this.__activeEvent))
ids.push(this.__activeEvent);}else
if(this._selection.startdate&&this._selection.startdate>=this.__range['start']&&this._selection.enddate<=this.__range['end'])
for(var i in this.__value)
if(this.__value[i].startdate>=this._selection.startdate&&this.__value[i].enddate<=this._selection.enddate)
ids.push(this.__value[i].id);return ids;};

/* client/inc/obj_evnview.js */
_me=obj_evnview.prototype;function obj_evnview(){};_me.__constructor=function(){var me=this;if(gui._rtl){this._getAnchor('htable').setAttribute('dir','rtl');this._getAnchor('htable2').setAttribute('dir','rtl');}
if(GWOthers.getItem('LAYOUT_SETTINGS','time_format')>0)
addcss(this._main,'obj_evnview12');var tline='';if(GWOthers.getItem('LAYOUT_SETTINGS','time_format')>0){for(var i=0;i<24;i++){tline+='<div>';if(i>12)
tline+=(i-12);else
tline+=(i==0?'12':i);tline+="<sup>"+(i<12?'am':'pm')+"</sup></div>\r\n";}}else{for(var i=0;i<24;i++)
tline+='<div>'+i+"<sup>00</sup></div>\r\n";}
this._getAnchor('tline').innerHTML=tline;delete tline;this.__topheight=24;this.__rowheight=26;this.__idTable;this.__value;this.__rights={'read':true,'write':true,'modify':true,'remove':true};this.__eTitle=this._getAnchor('title');this.__eAllDay=this._getAnchor('allday');this.__eHTable=this._getAnchor('htable');this.__eContainer=this._getAnchor('container');this.__eContainer2=this._getAnchor('container2');this.__eMain=this._getAnchor('main');this.__eIN=this._getAnchor('input');this._scrollbar(this.__eContainer2,this.__eContainer2.parentNode);this.__activeEvent;this.__noRefresh=false;this.__edivs=[];this._selection={};this.__allDaySelection={};this.__editMode=false;this.__editEvent='';var header=this._getAnchor('header');this._getAnchor('collapse').addEventListener('click',function(e){if(header.classList.contains('collapsed')){header.classList.remove('collapsed');Cookie.set(['collapse_allday'],false);}else{header.classList.add('collapsed');Cookie.set(['collapse_allday'],true);}
this.__eContainer.style.paddingTop=parseInt(header.offsetHeight)+'px';}.bind(this));this.__eIN.onkeyup=function(e){var newEvn={};if(!me.__rights.modify){if(!me.__activeEvent||!(newEvn=me._useItem(me.__activeEvent))||newEvn.owner!=sPrimaryAccountGWID)
return;}
var e=e||window.event;if(!me.__editMode){switch(e.keyCode){case 13:case 27:this.value='';return false;case 46:if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent))&&!newEvn.disabled&&me.__rights.remove){if(me._onremove)
me._onremove(me.__activeEvent,e.shiftKey);me.__exeEvent('_onremove',null,{"owner":me,"event":me.__activeEvent});}
break;case 1000:case 113:if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent))){if(newEvn.disabled||newEvn.startdate<me.__start||newEvn.startdate>me.__end)
return;me.__editMode=true;if(e.keyCode==113)
this.value=newEvn.title;me.__editEvent=me.__activeEvent;me.__createEdit();me.__editMode=false;}
return false;default:if(this.value.length){if(me.__allDaySelection.startdate){newEvn=clone(me.__allDaySelection);newEvn.starttime=-1;newEvn.endtime=-1;me.__allDaySelection={};}else
if(me._selection.startdate){newEvn=clone(me._selection);me._selection={};}else
if(me.__activeEvent&&(newEvn=me._useItem(me.__activeEvent))){this.onkeyup({keyCode:1000});return;}
if(!Is.Defined(newEvn.startdate)||newEvn.startdate<me.__start||newEvn.startdate>me.__end){me.__editEvent='';return;}
me.__editMode=true;newEvn.evnclass='E';newEvn.id='edit';me.__activeEvent=newEvn.id;me.__value.push(newEvn);}
me.__editEvent=me.__activeEvent;me._fill();me.__editMode=false;}}};this._main.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='INPUT'||elm.tagName=='TEXTAREA')
return;me._focus();return false;};this._main.onmouseup=this._main.onmousedown;this.__eTitle.ondblclick=function(e,bContext){var e=e||window.event,elm=e.target||e.srcElement;if(elm==this)
return;if(elm.tagName!='TD')
elm=Is.Child(elm,'TD');var id=elm.id.split('/')[1],arg={"starttime":-1,"endtime":-1,"_event":'allday'};if(me.__allDaySelection.startdate&&me.__allDaySelection.startdate<me.__allDaySelection.enddate&&me.__allDaySelection.startdate<=id&&me.__allDaySelection.enddate>=id){arg.startdate=me.__allDaySelection.startdate;arg.enddate=me.__allDaySelection.enddate;arg._event='selection';arg.contains=[];for(var i in me.__aAllDay)
if(me.__aAllDay[i].evnclass=='E'&&me.__aAllDay[i].startdate>=me.__allDaySelection.startdate&&me.__aAllDay[i].enddate<=me.__allDaySelection.enddate)
arg.contains.push(me.__aAllDay[i].id);}else{arg.startdate=id;arg.enddate=parseInt(id)+1;}
if(bContext){if(me._oncontext)
me._oncontext(e,elm,arg);me.__exeEvent('oncontext',e,{"elm":elm,"owner":me,"arg":arg});}else{if(me._ondblclick)
me._ondblclick(e,elm,arg);me.__exeEvent('ondblclick',e,{"elm":elm,"owner":me,"arg":arg});}};this.__eTitle.oncontextmenu=function(e){this.ondblclick(e,true);return false;};this.__eTitle.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;me._main.onmousedown(e);if(e.button>1||elm==this)
return true;if(elm.tagName!='TD'&&!(elm=Is.Child(elm,'TD',this)))
return;me.__selection2(elm.id.split('/')[1]);var aPos=getSize(this),iDiv=me.__eHTable.clientWidth/(me.__end-me.__start+1),iStart=Math.floor((e.clientX-aPos.x)/iDiv);gui._obeyEvent('mouseup',[me,'__mouseup']);me.__eHTable.onmousemove=function(evn){var evn=evn||window.event,iHop=Math.floor((evn.clientX-aPos.x)/iDiv)-iStart;me.__selection2(me.__start+iStart,me.__start+iStart+iHop);return false;};};this.__eAllDay.ondrag=function(){return false;};this.__eAllDay.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;var arg=null,iOff=0;switch(elm.tagName){case'DIV':if(gui._rtl?elm.style.right:elm.style.left)
iOff=parseInt(gui._rtl?elm.style.right:elm.style.left,10)/100;elm=Is.Child(elm,'TD');case'TD':var jul=parseInt(elm.id.split('/')[2],10)+iOff;arg={"startdate":jul,"enddate":jul+1,"starttime":-1,"endtime":-1,"_event":'allday'};break;case'INS':case'B':case'I':case'SPAN':elm=Is.Child(elm,'P');case'P':var id=elm.id.substr(me._pathName.length+1);for(var i in me.__value)
if(me.__value[i].id==id){var arg=clone(me.__value[i]);arg._event='event';if(arg.starttime<0)
arg.enddate=parseInt(arg.enddate)+1;}}
if(arg!=null&&!arg.disabled){if(me._ondblclick)
me._ondblclick(e,elm,arg);me.__exeEvent('ondblclick',e,{"elm":elm,"owner":me,"arg":arg});}};this.__eAllDay.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement,arg=null;switch(elm.tagName){case'DIV':if(elm.className=='obj_evnviewblock'){arg={"startdate":me.__allDaySelection.startdate,"enddate":me.__allDaySelection.enddate,"starttime":-1,"endtime":-1,"_event":'selection'};arg.contains=[];for(var i in me.__aAllDay)
if(me.__aAllDay[i].evnclass=='E'&&me.__aAllDay[i].startdate>=me.__allDaySelection.startdate&&me.__aAllDay[i].enddate<=me.__allDaySelection.enddate)
arg.contains.push(me.__aAllDay[i].id);break;}
elm=Is.Child(elm,'TD');case'TD':var jul=elm.id.split('/')[2];arg={"startdate":jul,"enddate":parseInt(jul),"starttime":-1,"endtime":-1,"_event":'allday'};break;case'INS':case'B':case'I':case'SPAN':elm=Is.Child(elm,'P');case'P':id=elm.id.split('/')[1];me._activate(id);for(var i in me.__value)
if(me.__value[i].id==id){var arg=clone(me.__value[i]);arg._event='event';if(arg.starttime<0)
arg.enddate=parseInt(arg.enddate);}}
if(arg!=null&&!arg.disabled){if(me._oncontext)
me._oncontext(e,elm,arg);me.__exeEvent('oncontext',e,{"elm":elm,"owner":me,"arg":arg});}
return false;};this.__eAllDay.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;me._main.onmousedown(e);if(elm.tagName=='INPUT'||e.button>1)
return;e.__source={obj:me,type:me._type,path:me._pathName};gui.__exeEvent('click',e);var sAction='m';switch(elm.tagName){case'DIV':case'TD':var aPos=getSize(this),iDiv=me.__eHTable.clientWidth/(me.__end-me.__start+1),iStart=Math.floor((e.clientX-aPos.x)/iDiv);me.__selection2(me.__start+iStart);gui._obeyEvent('mouseup',[me,'__mouseup']);me.__eHTable.onmousemove=function(evn){var evn=evn||window.event,iHop=Math.floor((evn.clientX-aPos.x)/iDiv)-iStart;me.__selection2(me.__start+iStart,me.__start+iStart+iHop);return false;};return false;case'INS':case'B':case'I':case'SPAN':if(elm.parentNode.tagName=='P'){elm=elm.parentNode;var aPos=getSize(elm);if(e.clientX-aPos.x<10)
sAction='l';else
if(aPos.x+aPos.w-e.clientX<10)
sAction='r';}else
elm=Is.Child(elm,'P');case'P':var id=elm.id.split('/')[1],itm=me._useItem(id);if(!me.__rights.modify&&(!itm||itm.owner!=sPrimaryAccountGWID))
return false;me.__selection2();me._activate(id,true);for(var itm=null,i=0;i<me.__aAllDay.length;i++)
if(me.__aAllDay[i].id==id){itm=clone(me.__aAllDay[i]);break;}
if(itm&&!itm.disabled){break;}
default:return;}
if(me.__end-me.__start<1)
return;gui._obeyEvent('mouseup',[me,'__mouseup',[itm]]);var aPos=getSize(this),iDiv=me.__eHTable.clientWidth/(me.__end-me.__start+1),iStart=Math.floor((e.clientX-aPos.x)/iDiv);me.__eHTable.onmousemove=function(evn){var evn=evn||window.event,iHop=Math.floor((evn.clientX-aPos.x)/iDiv)-iStart;for(var i=0;i<me.__aAllDay.length;i++)
if(me.__aAllDay[i].id==itm.id){if(iHop&&!hascss(me.__eAllDay,'dragged'))
addcss(me.__eAllDay,'dragged');if(sAction=='l'||sAction=='m'){if(me.__aAllDay[i].startdate==itm.startdate+iHop||(sAction=='l'&&(itm.startdate+iHop)>itm.enddate))
return;me.__aAllDay[i].startdate=parseInt(itm.startdate)+iHop;me.__aAllDay[i].start=me.__aAllDay[i].startdate<me.__start?me.__start:me.__aAllDay[i].startdate;me.__aAllDay[i].osd=parseInt(itm.osd)+iHop;}
if(sAction=='r'||sAction=='m'){if(me.__aAllDay[i].enddate==itm.enddate+iHop||(sAction=='r'&&(itm.enddate+iHop)<itm.startdate))
return;me.__aAllDay[i].enddate=parseInt(itm.enddate)+iHop;me.__aAllDay[i].end=me.__aAllDay[i].enddate>me.__end?me.__end:me.__aAllDay[i].enddate;me.__aAllDay[i].oed=parseInt(itm.oed)+iHop;}
me._fillAllDay();break;}};return false;};this.__eMain.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='INS')
elm=elm.parentNode;if(elm.tagName=='DIV'&&!elm.id)
elm=elm.parentNode;if(elm.tagName=='DIV'&&elm.id){var id=elm.id.substr(me._pathName.length+1).split('/'),arg=me._useItem(id[1]);if(arg!=null&&!arg.disabled){arg._event='event';if(me._ondblclick)
me._ondblclick(e,elm,arg);me.__exeEvent('ondblclick',e,{"elm":elm,"owner":me,"arg":arg});return;}}
if(elm.tagName=='TD'||(elm=Is.Child(elm,'TD'))){var id=elm.id.substr(me._pathName.length+1);var mainpos=getSize(this);var iStart=e.clientY-mainpos.y;iStart=((iStart-iStart%me.__rowheight)/me.__rowheight)*1800,arg={"_event":'blank',"startdate":id,"starttime":iStart};if(me._ondblclick)
me._ondblclick(e,elm,arg);me.__exeEvent('ondblclick',e,{"elm":elm,"owner":me,"arg":arg});}};this.__eMain.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='TEXTAREA'||e.button>1)
return;var mainpos=getSize(me.__eMain);mainpos.h=48*me.__rowheight;var cols=[];for(var cln=0;cln<me.__eMain.childNodes.length;cln++)
cols.push(getSize(me.__eMain.childNodes[cln]));e.__source={obj:me,type:me._type,path:me._pathName};gui.__exeEvent('click',e);if(elm.tagName=='DIV'&&hascss(elm,'obj_evnviewblock'))
elm=elm.parentNode;if(elm.tagName=='DIV'&&!elm.id&&(hascss(elm,'space_box')||hascss(elm,'today_box')))
elm=elm.parentNode;if(elm.tagName=='TD'){var x=e.clientX-mainpos.x,y=e.clientY-mainpos.y,ediv;if(me.__edivs[0]&&me.__edivs[0].parentNode===elm&&me.__edivs[0].parentNode){ediv=me.__edivs[0];ediv.style.top='';ediv.style.height='';me.__selection2(undefined,undefined,ediv);}
else{ediv=mkElement('div',{className:'obj_evnviewblock'});me.__selection2();me.__edivs.push(ediv);elm.appendChild(ediv);}
ediv.style.height=me.__rowheight+'px';var parentpos=getSize(elm),startpos=getSize(ediv),ey=mainpos.y-startpos.y+(y-y%me.__rowheight);ediv.style.top=ey+'px';if(me.__rights['write'])
ediv.innerHTML=getLang('CALENDAR::TYPETOADD');var iScroll=me.__eContainer2.scrollTop;var pos=getSize(ediv),difY=e.clientY;function mousemove(e){var e=e||window.event;var mycol=-1,orgcol=-1;if(gui._rtl){for(var i=cols.length-1;i>-1;i--){if(orgcol<0&&cols[i].x==parentpos.x)
orgcol=i;if(mycol<0&&e.clientX<(cols[i].x+cols[i].w))
mycol=i;if(orgcol>-1&&mycol>-1)
break;}}else{for(var i=cols.length-1;i>-1;i--){if(orgcol<0&&cols[i].x==parentpos.x)
orgcol=i;if(mycol<0&&e.clientX>cols[i].x)
mycol=i;if(orgcol>-1&&mycol>-1)
break;}}
if(mycol<0)
return;me.__edivs=me.__edivs.filter(function(div){if(div!==me.__edivs[0]){div.parentNode.removeChild(div);return false;}
return true;});if(orgcol<mycol){me.__edivs[0].style.top=ey+'px';me.__edivs[0].style.height=(mainpos.h+mainpos.y-pos.y)+'px';if(me.__rights['write'])
me.__edivs[0].innerHTML=getLang('CALENDAR::TYPETOADD');var tmpdiv,tmptd,tmppos,tmpheight;for(var i=orgcol+1;i<=mycol;i++){tmptd=me.__eMain.childNodes[i];tmpdiv=mkElement('div',{className:'obj_evnviewblock'});me.__edivs.push(tmpdiv);tmptd.appendChild(tmpdiv);tmppos=getSize(tmpdiv);tmpdiv.style.top=(mainpos.y-tmppos.y-me.__eContainer2.scrollTop+iScroll)+'px';if(i<mycol)
tmpheight=mainpos.h;else
tmpheight=e.clientY-mainpos.y+(me.__eContainer2.scrollTop-iScroll);tmpheight-=tmpheight%me.__rowheight;tmpdiv.style.height=(tmpheight>0?tmpheight:0)+'px';tmpdiv=null;tmptd=null;}
return;}
else
if(orgcol>mycol){var ePosY=mainpos.y-pos.y;me.__edivs[0].style.top=(ey+ePosY)+'px';me.__edivs[0].style.height=(me.__rowheight-ePosY)+'px';me.__edivs[0].innerHTML='';var tmpdiv,tmptd,tmppos,tmpheight;for(var i=orgcol-1;i>=mycol;i--){tmptd=me.__eMain.childNodes[i];tmpdiv=mkElement('div',{className:'obj_evnviewblock'});me.__edivs.push(tmpdiv);tmptd.appendChild(tmpdiv);tmppos=getSize(tmpdiv);if(i>mycol){tmpdiv.style.top=(mainpos.y-tmppos.y)+'px';tmpdiv.style.height=mainpos.h+'px';}else{var tmptop=e.clientY-tmppos.y;tmptop-=tmptop%me.__rowheight;tmpdiv.style.top=tmptop+'px';tmpheight=mainpos.h-tmptop;tmpdiv.style.height=(tmpheight>0?tmpheight:0)+'px';if(me.__rights['write'])
tmpdiv.innerHTML=getLang('CALENDAR::TYPETOADD');}
tmpdiv=null;tmptd=null;}
return;}
else
if(me.__rights['write'])
me.__edivs[0].innerHTML=getLang('CALENDAR::TYPETOADD');var ePosY=e.clientY-difY+(me.__eContainer2.scrollTop-iScroll);ePosY=ePosY-ePosY%me.__rowheight;if(ePosY<=0){me.__edivs[0].style.top=(ey+ePosY)+'px';ePosY*=-1;}
else
me.__edivs[0].style.top=ey+'px';me.__edivs[0].style.height=(ePosY+me.__rowheight)+'px';};function mouseup(){gui._disobeyEvent('mouseup',[mouseup]);gui._disobeyEvent('mousemove',[mousemove]);me._selection={};var iDay,iTime1,iTime2,tmppos;for(var i in me.__edivs){tmppos=getSize(me.__edivs[i]);iTime1=tmppos.y-getSize(me.__eMain).y+me.__rowheight/4;iTime1-=iTime1%me.__rowheight;iTime2=me.__edivs[i].offsetHeight+iTime1;iTime2-=iTime2%me.__rowheight;if(!me.__edivs[i]||!me.__edivs[i].parentNode||!me.__edivs[i].parentNode.id){gui._disobeyEvent('mouseup',[mouseup]);gui._disobeyEvent('mousemove',[mousemove]);return;}
iDay=me.__edivs[i].parentNode.id.substr(me._pathName.length+1);if(typeof me._selection.startdate=='undefined'||me._selection.startdate>iDay){me._selection.startdate=iDay;me._selection.starttime=(iTime1/me.__rowheight)*1800;}
if(typeof me._selection.enddate=='undefined'||me._selection.enddate<iDay){me._selection.enddate=iDay;me._selection.endtime=(iTime2/me.__rowheight)*1800;}}
tmppos=null;if(me._selection.starttime>=86400){me._selection.starttime=0;me._selection.startdate++;}
if(me._selection.endtime<=0){me._selection.endtime=86400;me._selection.enddate--;}
if(me._onselect)
me._onselect();me.__exeEvent('onselect',null,{"owner":me,"selection":me._selection});return true;};gui._obeyEvent('mouseup',[mouseup]);gui._obeyEvent('mousemove',[mousemove]);return true;}
else{me.__selection2();if(elm.tagName=='INS')
elm=elm.parentNode;if(elm.tagName=='DIV'&&(elm.id||(elm.parentNode&&elm.parentNode.id&&(elm=elm.parentNode)))){var parentpos=getSize(elm),x=e.clientX-parentpos.x,y=e.clientY-parentpos.y;if(typeof x=='undefined'||typeof y=='undefoned')
return;var id=elm.id.substr(me._pathName.length+1).split('/'),mycol=id[0],value=me._useItem(id[1]);if(value.disabled||(!me.__rights.modify&&value.owner!=sPrimaryAccountGWID))
return;if(y<4||parentpos.h-y<4){me._activate(id[1]);me.__edit(id,y<4?'top':'bottom',e,cols,mycol);}else{me._activate(id[1],true);var evn={clientY:e.clientY,clientX:e.clientX};me.__movetimer=window.setTimeout(function(){me.__edit(id,'move',evn,cols,mycol);},200);gui._obeyEvent('mouseup',[function(){if(Is.Defined(me.__movetimer)){window.clearTimeout(me.__movetimer);delete me.__movetimer;}
gui._disobeyEvent('mouseup',[this]);}]);}}}
return false;};this.__eMain.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement,arg;if(elm.tagName=='DIV'&&!elm.id&&(hascss(elm,'space_box')||hascss(elm,'today_box')))
elm=elm.parentNode;if(elm.tagName=='TD'){var mainpos=getSize(me.__eMain);mainpos.h=48*me.__rowheight;var id=elm.id.substr(me._pathName.length+1);var iStart=e.clientY-mainpos.y;iStart=((iStart-iStart%me.__rowheight)/me.__rowheight)*1800;arg={"_event":'blank',"startdate":id,"starttime":iStart};}else{if(elm.tagName=='INS')
elm=elm.parentNode;if(elm.tagName=='DIV'){if(elm.className=='obj_evnviewblock'){var selection=me._selection;arg=selection;arg._event='selection';arg.contains=[];var event;for(var i in me.__idTable){for(var j in me.__idTable[i]){event=me.__idTable[i][j];if(event.startdate>=selection.startdate&&event.enddate<=selection.enddate){if((event.startdate==selection.startdate&&event.starttime<selection.starttime)||(event.enddate==selection.enddate&&event.endtime>selection.endtime))
continue;arg.contains.push(event['id']);}}}}
else{if(!elm.id)
elm=elm.parentNode;if(elm.id){var id=elm.id.substr(me._pathName.length+1).split('/');me._activate(id[1]);arg=me._useItem(id[1]);arg._event='event';}}}}
if(arg){if(me._oncontext)
me._oncontext(e,elm,arg);me.__exeEvent('oncontext',e,{"elm":elm,"owner":me,"arg":arg});}
return false;};};_me.__edit=function(id,sType,e,cols,mycol){var me=this,mycol=id[0],value=this._useItem(id[1]);var mainpos=getSize(me.__eMain);mainpos.h=48*me.__rowheight;var tmpStart=value['startdate']<this.__start?this.__start:value['startdate'],tmpEnd=value['enddate']>this.__end?this.__end:value['enddate'],eElm;for(var i=tmpStart;i<=tmpEnd;i++)
if((eElm=this.__getElm(id[1],i)))
eElm.style.visibility='hidden';var height,top;var events={};function __block(){var eTd,eElm;for(var i in events){if(i<value.startdate||i>value.enddate){if(events[i].div)
events[i].div.parentNode.removeChild(events[i].div);events[i].div=null;delete events[i];}}
for(var i=value.startdate;i<=value.enddate;i++){eElm='',eDif=0,height=0,top=0;if((eTd=document.getElementById(me._pathName+'/'+i))){if(value.startdate==value.enddate){top=Math.floor(value.starttime/1800)*me.__rowheight;height=(Math.ceil(value.endtime/1800)-Math.floor(value.starttime/1800))*me.__rowheight;}else
if(i>value.startdate&&i<value.enddate){top=0;height=mainpos.h;}else
if(i==value.startdate){top=Math.floor(value.starttime/1800)*me.__rowheight;height=mainpos.h-top;}else{top=0;height=Math.ceil(value.endtime/1800)*me.__rowheight;}
if(!events[i]||!events[i].div){eElm=mkElement('div');eElm.className='obj_evnviewevn obj_evnviewopacity'+(value.fcolor?' '+value.fcolor:'');eTd.appendChild(eElm);eDif=getSize(eElm).y-mainpos.y;}else{eElm=events[i].div;eDif=events[i].dif;}
eElm.style.top=(top-eDif)+'px';eElm.style.height=height+'px';eElm.innerHTML='<div><b>'+parseJulianTime(value.starttime)+'-'+parseJulianTime(value.endtime)+'</b>&nbsp;'+(value.title?value.title.escapeHTML():getLang("EVENT_VIEW::NO_TITLE"))+'</div>';}
events[i]={"div":eElm,"dif":eDif};}};__block();var difY=e.clientY,evn_tstart=value.starttime,evn_tend=value.endtime,evn_dstart=value.startdate,evn_dend=value.enddate;function mousemove2(e){var cur=e.clientY-difY;cur=cur-cur%me.__rowheight;var increment=((cur/me.__rowheight)*1800);for(var i=0;i<cols.length;i++)
if(e.clientX>=cols[i].x&&e.clientX<=cols[i].x+cols[i].w||e.clientX<cols[0].x||(cols.length-1==i&&e.clientX>cols[i].x)){if(me.__start+i!=mycol)
increment+=(me.__start+i-mycol)*86400;break;}
var tmp;if(sType=='move'){tmp=evn_tstart+increment;if(tmp<0){var posun=Math.ceil(tmp/-86400);value.startdate=evn_dstart-posun;tmp+=posun*86400;}else
if(tmp>=86400){var posun=Math.floor(tmp/86400);posun=posun?posun:1;value.startdate=evn_dstart+posun;tmp-=posun*86400;}else
value.startdate=evn_dstart;value.starttime=tmp;tmp=evn_tend+increment;if(tmp<=0){var posun=Math.ceil(tmp/-86400);posun=posun?posun:1;tmp+=posun*86400;if(!tmp){posun++;tmp=86400;}
value.enddate=evn_dend-posun;}else
if(tmp>86400){var posun=Math.floor(tmp/86400);posun=posun?posun:1;tmp-=posun*86400;if(tmp==0){posun--;tmp=86400;}
value.enddate=evn_dend+posun;}else
value.enddate=evn_dend;value.endtime=tmp;}else
if(sType=='top'){tmp=evn_tstart+increment;if(tmp<0){var posun=Math.ceil(tmp/-86400);posun=posun?posun:1;value.startdate=evn_dstart-posun;tmp+=posun*86400;}else
if(tmp>=86400){var posun=Math.floor(tmp/86400);posun=posun?posun:1;value.startdate=evn_dstart+posun;tmp-=posun*86400;}else
value.startdate=evn_dstart;if(value.startdate>value.enddate||(value.startdate==value.enddate&&tmp>=value.endtime)){value.startdate=value.enddate;tmp=value.endtime-1800;}
value.starttime=tmp;}else
if(sType=='bottom'){tmp=evn_tend+increment;if(tmp<me.__rowheight){var posun=Math.ceil(tmp/-86400);posun=posun?posun:1;tmp+=posun*86400;if(!tmp){posun++;tmp=86400;}
value.enddate=evn_dend-posun;}else
if(tmp>86400){var posun=Math.floor(tmp/86400);posun=posun?posun:1;tmp-=posun*86400;if(!tmp){posun--;tmp=86400;}
value.enddate=evn_dend+posun;}else
value.enddate=evn_dend;if(value.startdate>value.enddate||(value.startdate==value.enddate&&value.starttime>=tmp)){value.enddate=value.startdate;tmp=value.starttime+1800;}
value.endtime=tmp;}
__block();};gui._obeyEvent('mousemove',[mousemove2]);function mouseup2(){gui._disobeyEvent('mousemove',[mousemove2]);gui._disobeyEvent('mouseup',[mouseup2]);for(var i in events)
if(events[i].div&&events[i].div!=null)
events[i].div=null;if(compareObj(me._useItem(id[1]),value,true)){me._fill();return true;}else{if(value.evnclass=='E'&&value.evnrcr_id)
value.disabled=true;me._useItem(id[1],value);}
me._fill();var out={starttime:value.starttime,endtime:value.endtime,startdate:value.startdate,enddate:value.enddate,evnclass:value.evnclass,evntype:value.evntype,evntimeformat:value.evntimeformat,id:value.id};if(me._onchange)
me._onchange(out);me.__exeEvent('onchange',null,{"owner":me,"event":out});};gui._obeyEvent('mouseup',[mouseup2]);};_me.__mouseup=function(e,elm,itm){removecss(this.__eAllDay,'dragged');gui._disobeyEvent('mouseup',[this,'__mouseup']);this.__eHTable.onmousemove=null;if(itm)
for(var i=0;i<this.__aAllDay.length;i++)
if(this.__aAllDay[i].id==itm.id){if(this.__aAllDay[i].startdate!=itm.startdate||this.__aAllDay[i].enddate!=itm.enddate){if(this.__aAllDay[i].evnclass=='E'&&this.__aAllDay[i].evnrcr_id)
this.__aAllDay[i].disabled=true;this._useItem(this.__aAllDay[i].id,this.__aAllDay[i]);if(this._onchange)
this._onchange(this.__aAllDay[i]);this.__exeEvent('onchange',null,{"owner":this,"event":this.__aAllDay[i]});if(this.__aAllDay[i].starttime>-1)
this._fill();}
break;}};_me.__selection2=function(iStart,iEnd,eSkip){if(!this.__eTopAnchor){this.__allDaySelection={};return;}
this._activate('');this._selection={};this.__edivs=this.__edivs.filter(function(div){if(eSkip===div)
return true;div&&div.parentNode&&div.parentNode.removeChild(div);return false;});var elm=document.getElementById(this._pathName+'/allday');if(!Is.Defined(iStart)||iEnd<this.__start||iStart>this.__end){if(!Is.Defined(iStart))
this.__allDaySelection={};if(elm)
elm.parentNode.removeChild(elm);return;}
iEnd=iEnd||iStart;if(iEnd<iStart){var tmp=iStart;iStart=iEnd;iEnd=tmp;}
this.__allDaySelection={startdate:iStart,enddate:iEnd};iStart=iStart>this.__start?iStart-this.__start:0;iEnd=(iEnd<this.__end?iEnd:this.__end)-this.__start-iStart;if(!elm){elm=mkElement('div',{className:'obj_evnviewblock',id:this._pathName+'/allday'});elm.onmousedown=function(e){return false;};this.__eTopAnchor.appendChild(elm);}
if(gui._rtl){elm.style.right=(iStart*100)+'%';}else{elm.style.left=(iStart*100)+'%';}
elm.style.width=((iEnd+1)*100)+'%';};_me._rights=function(v){if(!v)
return this.__rights;this.__rights=v;};_me._range=function(iStart,iEnd,iTimeStart,iTimeEnd){if(iStart&&iEnd){if(+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')>=0){var start=IcewarpDate.julian(iStart).clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')});var end=IcewarpDate.julian(iEnd).clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')});gui.frm_main.main._main.querySelector('.alternative_calendar').textContent=start.format('LL')+(end.isSame(start,'day')?'':(' - '+end.format('LL')));}
if(this.__start!=parseInt(iStart)||this.__end!=parseInt(iEnd)){this.__start=parseInt(iStart);this.__end=parseInt(iEnd);this.__startTime=parseInt(iTimeStart)||0;this.__endTime=parseInt(iTimeEnd)||0;if(this.__value&&!Is.Empty(this.__value))
this._fill();}}else
return{"start":this.__start,"end":this.__end};};_me._value=function(v){if(!this.__noRefresh&&Is.Object(v))
this._fill(v);else
return this.__value;};_me.__update=function(sDataSet){if(!sDataSet||this.__noRefresh)
return;if(this._listener_data==sDataSet)
this._value(dataSet.get(this._listener_data,this._listenerPath_data));if(this._listener==sDataSet){var tmp=dataSet.get(this._listener,this._listenerPath);this._range(tmp['start'],tmp['end']);}};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')
this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me._fillAllDay=function(){if(!this.__eTopAnchor)
return;var sHTML='',ymax=0,infos=[];if(this.__aAllDay.length){this.__aAllDay.sort(this.__sortAllDay);var css,sNoTitle=getLang("EVENT_VIEW::NO_TITLE"),sPrivateTitle=getLang('EVENT_VIEW::PRIVATE');for(var ad in this.__aAllDay){var info={starttime:'',endtime:''};this.__aAllDay[ad].y=0;skip={};info.title=this.__aAllDay[ad].title?this.__aAllDay[ad].title.entityify():(this.__aAllDay[ad].evnsharetype==='U'?sNoTitle:sPrivateTitle);for(var j in this.__aAllDay){if(j==ad)
break;if(this.__aAllDay[j]['start']<=this.__aAllDay[ad]['start']&&this.__aAllDay[j]['end']>=this.__aAllDay[ad]['start']){if(this.__aAllDay[j]['end']==this.__aAllDay[ad]['start']&&this.__aAllDay[j].starttime>-1&&this.__aAllDay[ad].starttime>-1&&this.__aAllDay[j].endtime<=this.__aAllDay[ad].starttime)
continue;if(this.__aAllDay[ad].y<this.__aAllDay[j].y)
skip[this.__aAllDay[j].y]=true;else
if(this.__aAllDay[ad].y==this.__aAllDay[j].y)
while(true)
if(!skip[++this.__aAllDay[ad].y])
break;}}
ymax=ymax<=this.__aAllDay[ad].y?this.__aAllDay[ad].y+1:ymax;css=[];if(this.__aAllDay[ad]['start']!=this.__aAllDay[ad]['startdate'])
css.push('openStart');if(this.__aAllDay[ad]['end']!=this.__aAllDay[ad]['enddate'])
css.push('openEnd');if(this.__aAllDay[ad].fcolor)
css.push(this.__aAllDay[ad].fcolor);if(!this.__rights.modify&&this.__aAllDay[ad].owner!=sPrimaryAccountGWID)
css.push('disabled');else
if(this.__activeEvent==this.__aAllDay[ad].id)
css.push('active');if(this.__aAllDay[ad].evnflags&32)
css.push('unresponded');if(this.__aAllDay[ad].evnflags&4)
css.push('F');if(this.__aAllDay[ad].evnflags&8)
css.push('T');if(this.__aAllDay[ad].evnflags&16)
css.push('O');info.start=IcewarpDate.julian(this.__aAllDay[ad]['osd']||this.__aAllDay[ad]['startdate']);(this.__aAllDay[ad]['starttime']!==-1)&&info.start.setTime(this.__aAllDay[ad]['starttime']);info.end=IcewarpDate.julian(this.__aAllDay[ad]['oed']||this.__aAllDay[ad]['enddate']);(this.__aAllDay[ad]['endtime']!==-1)&&info.end.setTime(this.__aAllDay[ad]['endtime']);var left,width;if(this.__start<this.__end&&this.__aAllDay[ad]['starttime']!=-1){info.starttime=info.start.format('LT');info.endtime=info.end.format('LT');var begin=this.__aAllDay[ad]['startdate']<this.__aAllDay[ad]['start']?0:this.__aAllDay[ad]['starttime']/864,end=this.__aAllDay[ad]['enddate']>this.__aAllDay[ad]['end']?100:this.__aAllDay[ad]['endtime']/864;width=(this.__aAllDay[ad]['end']-this.__aAllDay[ad]['start'])*100-begin+end;left=(this.__aAllDay[ad]['start']-this.__start)*100+begin;}else{left=(this.__aAllDay[ad]['start']-this.__start)*100;width=(this.__aAllDay[ad]['end']-this.__aAllDay[ad]['start']+1)*100;}
info.start=info.start.format("L");info.duration=this.__aAllDay[ad]['enddate']-this.__aAllDay[ad]['startdate'];if(this.__aAllDay[ad]['endtime']===-1){info.end.date(info.end.date()-1);}
info.end=info.duration?info.end.format('L'):'';sHTML+='<p id="'+this._pathName+'/'+this.__aAllDay[ad].id+'" style="'+'width:'+width+'%;'+(gui._rtl?'right':'left')+':'+left+'%;'+'top:'+(10+this.__aAllDay[ad].y*this.__topheight)+'px;'+'" '+(css.length?'class="'+css.join(' ')+'"':'')+'>';info.recurrent=!!this.__aAllDay[ad].evnrcr_id;info.reminder=!!this.__aAllDay[ad].rmnevn_id;info.location=this.__aAllDay[ad].location||'';info.tags=this.__aAllDay[ad].taglist||false;if(this.__aAllDay[ad].edit&&this.__activeEvent==this.__aAllDay[ad].id)
sHTML+='<span><span></span></span>';else
sHTML+='<span><span>'+
(info.end&&this.__aAllDay[ad]['end']==this.__aAllDay[ad]['enddate']?'<i unselectable="on">'+info.endtime+'</i>':'')+
(this.__aAllDay[ad].conferenceid?'<ins class="conference"></ins>':'')+
(info.reminder?'<ins class="rmn"></ins>':'')+
this.__aAllDay[ad].color+'<b>'+(info.start&&this.__aAllDay[ad]['start']==this.__aAllDay[ad]['startdate']?'<i unselectable="on">'+info.starttime+'</i>':'')+info.title+'</b></span></span>';sHTML+='</p>';info.duration=new IcewarpNumber(info.duration+1).localize()+' '+getLang(info.duration+1?'TIME::MOREDAYS':'TIME::ONEDAY');if(this.__aAllDay[ad].evnowneremail!=sPrimaryAccount)
info.owner=this.__aAllDay[ad].evnowneremail;infos.push(info);}}
this.__eTopAnchor.innerHTML=sHTML;var height=(ymax+1)*this.__topheight;this.__eTopAnchor.style.height=height+'px';var header=this._getAnchor('header');if(height>150){header.classList.add('collapsable');if(Cookie.get(['collapse_allday'])){header.classList.add('collapsed');}}else{header.classList.remove('collapsed');header.classList.remove('collapsable');}
this.__eContainer.style.paddingTop=parseInt(header.offsetHeight)+'px';var ps=this.__eTopAnchor.getElementsByTagName('P');for(var i=0;i<ps.length;i++)
AttachEvent(ps[i],'onmouseover',this._showTooltip({template:'obj_event_tooltip',values:infos[i]},{flip:false}));};_me.__sortAllDay=function(a,b){var tmp=(a['startdate']+a['starttime']/100000)-(b['startdate']+b['starttime']/100000)||(b['enddate']+b['endtime']/100000)-(a['enddate']+a['endtime']/100000);if(tmp==0){if(a.title<b.title)
return-1;else
if(a.title>b.title)
return 1;}
return tmp;};_me._fill=function(aDataIn){this.__idTable={};var tmp=typeof aDataIn=='object'?clone(aDataIn,1):this.__value,aTmpData,aHollidays={};var aTags=dataSet.get('tags')||{};this.__aAllDay=[];for(var i in tmp){if(tmp[i]['id']=='/'||tmp[i]['id']=='#'||tmp[i]['$']||tmp[i]['@']||tmp[i].enddate<this.__start||tmp[i].startdate>this.__end)
continue;tmp[i].startdate=parseInt(tmp[i].startdate);tmp[i].starttime=parseInt(tmp[i].starttime);tmp[i].endtime=parseInt(tmp[i].endtime);tmp[i].enddate=parseInt(tmp[i].enddate);if(tmp[i]['startdate']<tmp[i]['enddate']&&tmp[i].endtime==0){tmp[i]['enddate']--;tmp[i]['endtime']=86400;}
if(tmp[i]['enddate']>this.__end+10)
tmp[i]['enddate']=this.__end+10;tmp[i].color='';tmp[i].taglist='';if(tmp[i]['evnclass']!='H'&&tmp[i].evntype){var arr=tmp[i].evntype.split(','),at={},sColor;for(var t in arr)
if((arr[t]=arr[t].trim()).length){sColor=aTags[arr[t]]&&aTags[arr[t]].TAGCOLOR?aTags[arr[t]].TAGCOLOR:'#FFFFFF';if(!at[sColor])
at[sColor]=[];at[sColor].push(arr[t]);}
for(var t in at){tmp[i].color+='<ins title="'+at[t].join(', ').escapeHTML().replace(/"/g,'&quot;')+'" style="background-color:'+t+'"></ins>';tmp[i].taglist+='<li><ins style="background-color:'+t+'"></ins>'+at[t].join(', ').escapeHTML()+'</li>';}}
if(tmp[i]['evnclass']!='H'&&(tmp[i]['starttime']<0||(this.__start!=tmp[i].enddate&&this.__end!=tmp[i].startdate&&(tmp[i]['enddate']-tmp[i]['startdate']>1||(tmp[i]['enddate']-tmp[i]['startdate']==1&&tmp[i]['endtime']>tmp[i]['starttime']))))){aTmpData=clone(tmp[i]);aTmpData['start']=aTmpData.startdate<this.__start?this.__start:aTmpData.startdate;aTmpData['end']=aTmpData.enddate>this.__end?this.__end:aTmpData.enddate;this.__aAllDay.push(aTmpData);}else{for(var j=Math.max(tmp[i]['startdate'],this.__start),k=Math.min(tmp[i]['enddate'],this.__end);j<=k;j++){if(tmp[i]['evnclass']=='H'){if(typeof aHollidays[j]=='undefined')
aHollidays[j]=[];aHollidays[j].push(tmp[i]);}else{aTmpData=clone(tmp[i]);aTmpData['tmpid']=i;if(aTmpData['starttime']>-1){if(aTmpData['enddate']>j)
aTmpData['endtime']=86400;if(aTmpData['startdate']<j)
aTmpData['starttime']=0;}
if(typeof this.__idTable[j]=='undefined')
this.__idTable[j]=[];this.__idTable[j].push(aTmpData);}}}}
if(typeof aDataIn=='object'&&compareObj(this.__value,tmp)){this.__value=tmp;if(!Is.Empty(tmp))
return;}else
this.__value=tmp;var aData=clone(this.__idTable,true);var child;while(child=this.__eTitle.lastChild)
this.__eTitle.removeChild(child);while(child=this.__eAllDay.lastChild)
this.__eAllDay.removeChild(child);for(var i in this.__edivs){this.__edivs[i].parentNode.removeChild(this.__edivs[i]);this.__edivs[i]=null;}
this.__edivs=[];this._selection={};try{while(child=this.__eMain.lastChild)
this.__eMain.removeChild(child);}catch(e){this.__eMain.innerHTML='';}
removecss(this._main,'day','week');addcss(this._main,this.__start==this.__end?'day':'week');var etd,ettd,ediv,ediv2,initPos,colsize=100/(1+this.__end-this.__start),adcount=0,oJSDate=new IcewarpDate(),iToday=oJSDate.format(IcewarpDate.JULIAN),sNoTitle=getLang("EVENT_VIEW::NO_TITLE"),sPrivateTitle=getLang("EVENT_VIEW::PRIVATE"),date_format=getLang('LANGUAGE::WEEK_DATE',false,2)||'ddd D MMMM';for(var i=this.__start;i<=this.__end;i++){oJSDate=new IcewarpDate(i,{format:IcewarpDate.JULIAN});ettd=mkElement('td',{id:this._pathName+'#title/'+i,style:{width:(this.__end==i?'auto':colsize+'%')}});if(i==iToday)
ettd.className='today';var alternative='';if(+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')>=0)
alternative=' / '+oJSDate.clone({calendar:+GWOthers.getItem('CALENDAR_SETTINGS','alternative_calendar')}).date();ettd.innerHTML='<div class="obj_evnviewday" unselectable="on">'+oJSDate.format(date_format)+alternative+'</div>';if(aHollidays[i]){var adcount2=aHollidays[i].length,adtmp,sTEXT,aLoc,bCelsius=GWOthers.getItem('CALENDAR_SETTINGS','temperature')=='C';if(adcount2>adcount)
adcount=adcount2;aHollidays[i].sort(this.__sortHolidays);for(var ad in aHollidays[i]){adtmp=mkElement('div');if(aHollidays[i][ad]['location']&&aHollidays[i][ad]['location'].indexOf('type=weather')==0){if(GWOthers.getItem('RESTRICTIONS','DISABLE_WEATHER_SETTING')==0){aLoc=parseURL(aHollidays[i][ad]['location']);adtmp.className='obj_evnviewweather ico_'+aLoc.icon;aLoc.city=aLoc.loc.split(',')[0];aLoc.low=bCelsius?aLoc.c_lo+'C':aLoc.f_lo+'F';aLoc.high=bCelsius?aLoc.c_hi+'C':aLoc.f_hi+'F';sTEXT=aLoc.high+' '+aLoc.city;AttachEvent(adtmp,'onmouseover',this._showTooltip({template:'obj_event_weather',values:aLoc}));}else{sTEXT='';}}else{adtmp.title=sTEXT=aHollidays[i][ad].title||'';if(aHollidays[i][ad]['location']&&aHollidays[i][ad]['location'].indexOf('type=public')==0)
adtmp.className='obj_evnviewholiday_p';else
adtmp.className='obj_evnviewholiday';}
if(aHollidays[i][ad]['color'])
adtmp.innerHTML='<span style="border-color: '+aHollidays[i][ad]['color']+'">'+sTEXT.escapeHTML()+'</span>';else
adtmp.innerHTML=sTEXT.escapeHTML();ettd.appendChild(adtmp);adtmp=null;}}
this.__eTitle.appendChild(ettd);ettd=mkElement('td',{id:this._pathName+'/allday/'+i});if(i==iToday)
ettd.className='today';if(i==this.__start)
ettd.appendChild((this.__eTopAnchor=mkElement('div',{className:'topAnchor'})));this.__eAllDay.appendChild(ettd);ettd=null;etd=mkElement('td',{id:this._pathName+'/'+i,style:{width:(this.__end==i?'auto':colsize+'%')}});if(i==iToday){etd.className='today';etd.appendChild(mkElement('div',{'className':'today_box'}));}
if(!aData[i]||!aData[i].length){this.__eMain.appendChild(etd);etd=null;continue;}
for(var j=aData[i].length-1;j>-1;j--){aData[i][j]['start']=Math.floor(aData[i][j]['starttime']/1800);aData[i][j]['end']=Math.ceil(aData[i][j]['endtime']/1800);if(aData[i][j]['start']>=aData[i][j]['end'])
aData[i][j]['end']=aData[i][j]['start']+1;aData[i][j]['position']=0;aData[i][j]['delimiter']=1;aData[i][j]['width']=1;}
var etd2=mkElement('div',{'className':'space_box'});aData[i].sort(this.__sortEvn);var j=0,old_j,block,iend=0,relPosition=0;while(aData[i][j]){old_j=j;block=aData[i][j];iend=iend?iend:block['end'];relPosition=0;for(var k=j+1,kk=aData[i].length;k<kk;k++){if(aData[i][k]['start']>=iend){j++;break;}
if(iend<aData[i][k]['end'])
iend=aData[i][k]['end'];if(block['end']<=aData[i][k]['start']){aData[i][k]['position']=block['position'];aData[i].splice(j+1,0,aData[i][k]);aData[i].splice(k+1,1);j++;break;}else{if(aData[i][k-1]['end']&&aData[i][k]['start']<aData[i][k-1]['end'])
relPosition++;aData[i][k]['position']=aData[i][j]['position']+relPosition;}}
if(!aData[i][j]['position']&&aData[i][j]['start']>=iend)
iend=0;if(old_j==j)
j++;}
var pos,del;for(var j=0,DataLng=aData[i].length;j<DataLng;j++){if(aData[i][j]['position']==0){var prekrejva=-1;for(var k=j;k<DataLng;k++){if(aData[i][k]['position']>aData[i][j]['position']){if(aData[i][k]['start']<aData[i][j]['end'])
prekrejva=k;break;}}
if(prekrejva<0)
continue;del=1;pos=0;for(var k=prekrejva;k<DataLng;k++){if(aData[i][k]['position']<pos)
break;if(aData[i][k]['position']==pos)
continue;pos=aData[i][k]['position'];del=pos+1;}
for(;j<k;j++){aData[i][j]['delimiter']=del;var dif=0;for(var l=j+1;l<k;l++){if(aData[i][j]['position']<aData[i][l]['position']&&aData[i][j]['start']<aData[i][l]['end']&&aData[i][j]['end']>aData[i][l]['start']){dif=aData[i][l]['position']-aData[i][j]['position'];break;}}
if(dif>1)
aData[i][j]['width']=dif;else
if(dif==0&&aData[i][j]['position']+1<aData[i][j]['delimiter'])
aData[i][j]['width']=aData[i][j]['delimiter']-aData[i][j]['position'];}
j--;}}
var value,css;initPos=0;for(var j=0,jj=aData[i].length;j<jj;j++){css=['obj_evnviewevn'];if(!this.__rights.modify&&aData[i][j].owner!=sPrimaryAccountGWID)
css.push('disabled');if(aData[i][j].id==this.__activeEvent)
css.push('active');if(aData[i][j].fcolor)
css.push(aData[i][j].fcolor);if(aData[i][j].evnflags&32)
css.push('unresponded');if(aData[i][j].evnflags&4)
css.push('F');if(aData[i][j].evnflags&8)
css.push('T');if(aData[i][j].evnflags&16)
css.push('O');aData[i][j]['init']=initPos;initPos+=aData[i][j]['end']-aData[i][j]['start'];var ediv=mkElement('div');ediv.id=this._pathName+'/'+i+'/'+aData[i][j].id;ediv.className=css.join(' ');ediv.style.top=(this.__rowheight*(aData[i][j]['start']-aData[i][j]['init']))+'px';ediv.style.height=(this.__rowheight*(aData[i][j]['end']-aData[i][j]['start']))+'px';if(this.__rights.modify||aData[i][j].owner==sPrimaryAccountGWID)
ediv.onmousemove=this.__swapCursor;ediv.style.width=((100/aData[i][j]['delimiter'])*aData[i][j]['width'])+'%';if(gui._rtl){ediv.style.right=((100/aData[i][j]['delimiter'])*aData[i][j]['position'])+'%';}else{ediv.style.left=((100/aData[i][j]['delimiter'])*aData[i][j]['position'])+'%';}
ediv2=mkElement('div');value=this.__value[aData[i][j].tmpid];ediv2.innerHTML=(aData[i][j].conferenceid?'<ins class="conference"></ins>':'')
+(aData[i][j].rmnevn_id?'<ins class="rmn"></ins>':'')
+value.color
+(value.title?value.title.escapeHTML():(value.evnsharetype==='U'?sNoTitle:sPrivateTitle))+(value['location']?' ('+value['location'].escapeHTML()+')':'');ediv.appendChild(ediv2);etd2.appendChild(ediv);var info={title:value.title||sNoTitle,location:value.location,reminder:!!aData[i][j].rmnevn_id,recurrent:!!aData[i][j].evnrcr_id,tags:value.taglist||false};if(aData[i][j]['startdate']==aData[i][j]['enddate']){info.start=parseJulianTime(value.starttime);info.end=parseJulianTime(value.endtime);info.duration=parseInt((value.endtime-value.starttime)/60);info.duration=info.duration<120?new IcewarpNumber(info.duration).localize()+' '+getLang('TIME::MINUTES'):new IcewarpNumber(Math.round(info.duration/60)).localize()+' '+getLang('TIME::HOURS');}else{info.start=IcewarpDate.julian(value.startdate,value.starttime/60);info.end=IcewarpDate.julian(value.enddate,value.endtime/60);info.starttime=info.start.format('LT');info.endtime=info.end.format('LT');info.start=info.start.format(IcewarpDate.SHORT_L);info.end=info.end.format(IcewarpDate.SHORT_L);info.duration=Math.round((86400-value.starttime+value.endtime)/3600+(value.enddate-value.startdate-1)*24);info.duration=info.duration<24?info.duration+' '+getLang('TIME::HOURS'):(value.enddate-value.startdate+1)+' '+getLang('TIME::DAYS');}
if(value.title){if(value.evnowneremail!=sPrimaryAccount)
info.owner=value.evnowneremail;AttachEvent(ediv,'onmouseover',this._showTooltip({template:'obj_event_tooltip',values:info}));}
ediv=null;}
etd.appendChild(etd2);this.__eMain.appendChild(etd);etd=null;etd2=null;}
this._fillAllDay();if(this.__startTime){this.__eContainer2.scrollTop=this.__rowheight*this.__startTime*2;var tmpt1=this._getAnchor('time1');tmpt1.style.height=(this.__rowheight*this.__startTime*2)+'px';this.__startTime=null;}
if(this.__endTime){var tmpt2=this._getAnchor('time2');tmpt2.style.top=(this.__rowheight*this.__endTime*2)+'px';tmpt2.style.height=(this.__rowheight*(24-this.__endTime)*2)+'px';this.__endTime=null;}
if(this.__editMode)
this.__createEdit();};_me.__createEdit=function(){if(this.__editMode&&this.__editEvent){var me=this,inp,itm=this._useItem(this.__editEvent);if(!itm){this.__noRefresh=false;return;}
this.__noRefresh=true;var elm=document.getElementById(this._pathName+'/'+this.__editEvent)||document.getElementById(this._pathName+'/'+itm.startdate+'/'+this.__editEvent);var duration=(itm.enddate-itm.startdate)*86400-itm.starttime+itm.endtime;if(elm&&itm.starttime>-1&&duration<86400){inp=mkElement('textarea');elm.replaceChild(inp,elm.getElementsByTagName('div')[0]);}
else if(elm){elm.innerHTML='<span><input type="text" /></span>';inp=elm.getElementsByTagName('INPUT')[0];}else{this.__noRefresh=false;return;}
if(inp){inp.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 27:this.value='';case 13:this.onblur();return false;}};inp.ondblclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();return false;};inp.onblur=function(e){var e=e||window.event;this.onblur=null;if(this.value.length){for(var i=me.__value.length-1;i>-1;i--)
if(me.__value[i].id==me.__editEvent){if(me.__value[i].title!=this.value){me.__value[i].title=this.value.trim();me.__noRefresh=false;if(me.__editEvent=='edit'){me.__value[i].disabled=true;if(me._onadd)
me._onadd(me.__value[i]);me.__exeEvent('onadd',null,{"owner":me,"event":me.__value[i]});}else{delete me.__value[i].disabled;if(me._onchange)
me._onchange(me.__value[i]);me.__exeEvent('onchange',null,{"owner":me,"event":me.__value[i]});}}else
delete me.__value[i].disabled;break;}}else
if(me.__editEvent=='edit')
for(var i=me.__value.length-1;i>-1;i--)
if(me.__value[i].id=='edit'){me.__value.splice(i,1)[0];break;}
me.__editEvent='';if(me.__activeEvent=='edit')
me.__activeEvent='';me.__noRefresh=false;me._fill();me._focus();};inp.focus();inp.value=this.__eIN.value||'';}}};_me.__sortEvn=function(a,b){var x=a['start']-b['start'];if(x==0&&a.fcolor!=b.fcolor)
x=a.fcolor>=b.fcolor?1:-1;if(x==0)
x=(b['end']-a['end']);return x;};_me.__sortHolidays=function(a,b){if(a.evntype=='Weather'&&b.evntype!='Weather')
return-1;else
if(a.evntype!='Weather'&&b.evntype=='Weather')
return 1;else
if(a.evntype!='Weather'&&a.evnfolder&&b.evnfolder){if(a.evnfolder<b.evnfolder)
return-1;else
if(a.evnfolder>b.evnfolder)
return 1;}
if(a['title']&&b['title']){if(a['title']<b['title'])
return-1;else
if(a['title']==b['title'])
return 0;else
return 1;}else
if(a['id']<b['id'])
return-1;else
if(a['id']==b['id'])
return 0;else
return 1;};_me.__swapCursor=function(e){var e=e||window.event,elm=e.target||e.srcElement,x=e.x||e.layerX,y=e.y||e.layerY;if(elm.tagName=='DIV'&&Is.Defined(x)){if(x<8&&elm==this){if(this.style.cursor!='move')
this.style.cursor='move';}else
if(y<3||elm.offsetHeight-y<3){if(this.style.cursor!='n-resize')
this.style.cursor='n-resize';}else
if(this.style.cursor!='pointer')
this.style.cursor='pointer';}else
if(this.style.cursor!='default')
this.style.cursor='default';};_me._activate=function(id,bClick){if(Is.Defined(id)){var elm,itm,aActive=[];if(Is.Defined(this.__activeEvent)){if(this.__activeEvent==id)
return;if((itm=this._useItem(this.__activeEvent))&&itm.id==this.__activeEvent){elm=this.__getItemElm(itm);for(var i in elm)
removecss(elm[i],'active');}}
if(id&&(itm=this._useItem(id))&&(this.__rights.modify||itm.owner==sPrimaryAccountGWID)){this.__activeEvent=id;elm=this.__getItemElm(itm);for(var i in elm)
addcss(elm[i],'active');gui.__exeEvent('itemSelected',[this._parent.__aid,this._parent.__fid,[id]]);aActive=[id];}else{this.__activeEvent='';gui.__exeEvent('folderSelected',[this._parent.__aid,this._parent.__fid]);}
if(this._onactivate)
this._onactivate(aActive);this.__exeEvent('onactivate',null,{"value":aActive,"owner":this});}else
return this.__activeEvent;};_me._useItem=function(id,aValue){for(var i=this.__value.length-1;i>-1;i--)
if(this.__value[i].id==id)
if(aValue){this.__value[i]=aValue;break;}else
return clone(this.__value[i]);};_me.__getElm=function(id,col){return document.getElementById(this._pathName+(col?'/'+col:'')+'/'+id);};_me.__getItemElm=function(itm){var elm;if(itm.starttime<0||(this.__start!=itm.enddate&&this.__end!=itm.startdate&&(itm['enddate']-itm['startdate']>1||(itm['enddate']-itm['startdate']==1&&itm['endtime']>itm['starttime'])))){if((elm=this.__getElm(this.__activeEvent)))
return[elm];}else{var out=[],iStart=itm['startdate']<this.__start?this.__start:itm['startdate'],iEnd=itm['enddate']>this.__end?this.__end:itm['enddate'];for(var d=iStart;d<=iEnd;d++)
if((elm=this.__getElm(this.__activeEvent,d)))
out.push(elm);return out;}};_me._focus=function(s){this.__eIN.value='';this.__eIN.focus();};_me._selectedItems=function(){var ids=[];if(this.__activeEvent){if(this._useItem(this.__activeEvent))
ids.push(this.__activeEvent);}else{if(this.__allDaySelection.startdate){if(this.__allDaySelection.startdate>=this.__start&&this.__allDaySelection.enddate<=this.__end)
for(var i in this.__aAllDay)
if(this.__aAllDay[i].startdate>=this.__allDaySelection.startdate&&this.__aAllDay[i].enddate<=this.__allDaySelection.enddate)
ids.push(this.__aAllDay[i].id);}else
if(this._selection.startdate&&this._selection.startdate>=this.__start&&this._selection.enddate<=this.__end){var tmp;for(var i in this.__idTable)
for(var j in this.__idTable[i]){tmp=this.__idTable[i][j];if(tmp.startdate>=this._selection.startdate&&tmp.enddate<=this._selection.enddate){if((tmp.startdate==this._selection.startdate&&tmp.starttime<this._selection.starttime)||(tmp.enddate==this._selection.enddate&&tmp.endtime>this._selection.endtime))
continue;ids.push(tmp['id']);}}}}
return ids;};

/* client/inc/obj_filter_line.js */
_me=obj_filter_line.prototype;function obj_filter_line(){storage.library('obj_filter_line_value');this.__aFilterLineValue=new obj_filter_line_value;}
_me.__constructor=function(sHeaderType){var me=this;this.__logicalOperators=false;this._showLogicalOperators();this.header._fillLang({"from":'FILTERS::FROM',"to":'FILTERS::TO',"subject":'FILTERS::SUBJECT',"cc":'FILTERS::CC',"reply_to":'FILTERS::REPLY_TO',"date":'FILTERS::DATE',"message":'FILTERS::MESSAGE',"message_body":'FILTERS::MESSAGE_BODY',"custom_message_header":'FILTERS::CUSTOM_MESSAGE_HEADER',"message_to_me":'FILTERS::MESSAGE_TO_ME',"any_message_header":'FILTERS::ANY_MESSAGE_HEADER',"attachment_name":'FILTERS::ATTACHMENT_NAME',"sender":'FILTERS::SENDER',"recipient":'FILTERS::RECIPIENT',"senders_ip":'FILTERS::SENDERS_IP',"rdns":'FILTERS::RDNS',"spam_score":'FILTERS::SPAM_SCORE',"smtp_auth":'FILTERS::SMTP_AUTH',"ip":'FILTERS::IP',"all_messages":'FILTERS::ALL_MESSAGES',"local_time_meets_criteria":'FILTERS::LOCAL_TIME_MEETS_CRITERIA'});this.header._onchange=function(){me.local_time_meets_criteria._main.style.display=this._value()==='local_time_meets_criteria'?'block':'none';me.value&&(me.value._main.style.display=this._value()==='local_time_meets_criteria'?'none':'block');me.func._value('');switch(this._value()){case'from':case'to':case'subject':case'cc':case'reply_to':case'date':case'message_body':case'custom_message_header':case'any_message_header':case'attachment_name':case'sender':case'recipient':case'senders_ip':case'rdns':me.func._main.style.display='block';me.func._fillLang({"starts_with":'FILTERS::STRING_STARTS_WITH',"doesnt_start_with":'FILTERS::DOESNT_START_WITH',"ends_with":'FILTERS::STRING_ENDS_WITH',"doesnt_end_with":'FILTERS::DOESNT_END_WITH',"contains_string":'FILTERS::CONTAINS_STRING',"doesnt_contain_string":'FILTERS::DOESNT_CONTAIN_STRING',"is_string":'FILTERS::IS_STRING',"isnt_string":'FILTERS::ISNT_STRING',"matches_regex":'FILTERS::MATCHES_REGEX',"doesnt_match_regex":'FILTERS::DOESNT_MATCH_REGEX'});me.func._value('contains_string');break;case'message':me.func._main.style.display='block';me.func._fillLang({"priority_is":'FILTERS::PRIORITY_IS',"priority_isnt":'FILTERS::PRIORITY_ISNT',"is_spam":'FILTERS::IS_SPAM',"isnt_spam":'FILTERS::ISNT_SPAM',"is_greater_than":'FILTERS::IS_GREATER_THAN',"is_lower_than":'FILTERS::IS_LOWER_THAN',"contains_attachment":'FILTERS::CONTAINS_ATTACHMENT',"doesnt_contain_attachment":'FILTERS::DOESNT_CONTAIN_ATTACHMENT'});me.func._value('priority_is');break;case'ip':me.func._main.style.display='block';me.func._fillLang({"matches":'FILTERS::MATCHES',"doesnt_match":'FILTERS::DOESNT_MATCH'});me.func._value('matches');break;case'spam_score':me.func._main.style.display='block';me.func._fillLang({"spam_is_greater_than":'FILTERS::SPAM_IS_GREATER_THAN',"spam_is_lower_than":'FILTERS::SPAM_IS_LOWER_THAN'});me.func._value('spam_is_greater_than');break;case'smtp_auth':me.func._main.style.display='block';me.func._fillLang({"authorized":'FILTERS::AUTHORIZED',"unauthorized":'FILTERS::UNAUTHORIZED'});me.func._value('authorized');break;case'all_messages':me.func._main.style.display='none';me.func._fillLang({'none':''});me.func._value('none');break;case'local_time_meets_criteria':me.func._main.style.display='none';break;case'message_to_me':me.func._main.style.display='none';me.func._value('contains_string');if(me.value)
me.value._destruct();me._create('value','obj_filter_line_value','value','','message_to_me');break;}};this.func._onchange=function(){if(me.value){if(me.value._isCompatibleTypeWith(this._value())==false){me.value._destruct();me._create('value','obj_filter_line_value','value','',this._value());}}
else
me._create('value','obj_filter_line_value','value','',this._value());me.value&&(me.value._main.style.display=me.header._value()==='local_time_meets_criteria'?'none':'block');};this.local_time_meets_criteria._onclick=function(e){if(me.local_time_meets_criteria_popup&&!me.local_time_meets_criteria_popup._destructed){me.local_time_meets_criteria_popup._destruct();}
me.local_time_meets_criteria_popup=gui._create('local_time_meets_criteria_popup','frm_time_criteria','','',((me._value()||{}).XML||[])[0]||false,[me,'__updateTimeCriteria']);};this.operator._value('AND');if(sHeaderType)
this.header._value(sHeaderType);};_me.__updateTimeCriteria=function(new_time_criteria){var value=this._value();value.XML=new_time_criteria;this._value(value);};_me._showLogicalOperators=function(){if(this.__logicalOperators==false){this.operator._fillLang({'AND':'FILTERS::AND','OR':'FILTERS::OR'});this.operator._value('AND');this.__logicalOperators=true;this.operator._main.style.visibility='visible';}};_me._hideLogicalOperators=function(){if(this.__logicalOperators==true){this.operator._main.style.visibility='hidden';this.operator._fillLang({'AND':'FILTERS::EMPTY_OPERATOR'});this.operator._value('AND');this.__logicalOperators=false;}};_me._getText=function(aValues){for(var i in aValues['CONDITION']){var sHeader=this.__getHeaderType(aValues['CONDITION'][i]);var sFunction=this.__getSubtype(aValues['CONDITION'][i]);var sLastPartOfText='';if(sFunction&&(sHeader!=='local_time_meets_criteria')){var sValue=this.__aFilterLineValue._getText(sFunction,aValues['CONDITION'][i]);if(aValues['CONDITION'][i].HEADERTYPE&&aValues['CONDITION'][i].HEADERTYPE[0].VALUE==31&&sValue<0)
sValue*=-1;sLastPartOfText=' '+getLang('FILTERS::'+sFunction.toUpperCase())+((Is.Defined(sValue))?' \''+sValue+'\'':'');}
return getLang('FILTERS::'+sHeader.toUpperCase())+sLastPartOfText;}
return'';};_me._value=function(aValues){if(Is.Defined(aValues)){if(this.__logicalOperators==true)
this.operator._value((aValues['AND'][0]['VALUE']=='1')?'AND':'OR');var headerType=this.__getHeaderType(aValues);if(headerType=='')return;this.header._value(headerType);var sSubtype=this.__getSubtype(aValues);if(sSubtype)this.func._value(sSubtype);this.value._value(aValues);}
else{var aValues=this.value._value();this.__setOrRemoveTag(aValues,'AND',(this.operator._value()=='AND')?'1':'0');var aNot=[];this.__setOrRemoveTag(aValues,'HEADERTYPE',this.__getRawHeaderType(this.header._value(),this.func._value(),aNot));this.__setOrRemoveTag(aValues,'CONTAINTYPE',this.__getRawContainType(aValues,this.func._value(),aNot));this.__setOrRemoveTag(aValues,'LOGICALNOT',aNot[0]?'1':'0');var expression=this.__getRawExpression(this.header._value());expression&&this.__setOrRemoveTag(aValues,'EXPRESSION',expression);return aValues;}};_me.__getHeaderType=function(aValues){var sHeaderType=(Is.Defined(aValues['HEADERTYPE']))?aValues['HEADERTYPE'][0]['VALUE']:'0';var aTable={'0':'from','1':'to','2':'subject','3':'cc','7':'reply_to','5':'date','6':'message_body','11':'custom_message_header','12':'any_message_header','8':'attachment_name','10':'sender','9':'recipient','15':'senders_ip','19':'rdns','30':'message','20':'message','27':'message','26':'message','29':'ip','23':'smtp_auth','31':'spam_score','33':'local_time_meets_criteria','25':'all_messages','35':'message_to_me','14':'message',};return sHeaderType?aTable[sHeaderType]||'':'';};_me.__getSubtype=function(aValues){var sHeaderType=Is.Defined(aValues['HEADERTYPE'])?aValues['HEADERTYPE'][0]['VALUE'].toString():'0';var bNot=(Is.Defined(aValues['LOGICALNOT'])&&aValues['LOGICALNOT'][0]['VALUE']=='1')?true:false;switch(sHeaderType){case'30':return(!bNot)?'priority_is':'priority_isnt';case'20':return(!bNot)?'is_spam':'isnt_spam';case'27':return(!bNot)?'is_greater_than':'is_lower_than';case'26':return(!bNot)?'is_lower_than':'is_greater_than';case'29':return(!bNot)?'matches':'doesnt_match';case'31':if((aValues.CONTAIN&&aValues.CONTAIN[0].VALUE<0)||(aValues.MESSAGESIZESMALLER&&aValues.MESSAGESIZESMALLER[0].VALUE==1))
return'spam_is_lower_than';else
return'spam_is_greater_than';case'23':return(!bNot)?'authorized':'unauthorized';case'25':case'35':return'';case'14':return(bNot)?'doesnt_contain_attachment':'contains_attachment';default:return this.__getContainType(aValues,bNot);}};_me.__getContainType=function(aValues,bNot){if(!Is.Defined(aValues['CONTAINTYPE']))
return(!bNot)?'is_string':'isnt_string';switch(aValues['CONTAINTYPE'][0]['VALUE'].toString()){case'1':return(!bNot)?'isnt_string':'is_string';case'2':return bNot?'doesnt_start_with':'starts_with';case'3':return bNot?'doesnt_end_with':'ends_with';case'6':return'doesnt_start_with';case'7':return'doesnt_end_with';case'8':return(!bNot)?'contains_string':'doesnt_contain_string';case'9':return(!bNot)?'doesnt_contain_string':'contains_string';case'10':return(!bNot)?'matches_regex':'doesnt_match_regex';case'11':return(!bNot)?'doesnt_match_regex':'matches_regex';}};_me.__getRawContainType=function(aValues,sFunction,aOutNot){switch(sFunction){case'starts_with':return'2';case'ends_with':return'3';case'doesnt_start_with':return'6';case'doesnt_end_with':return'7';case'contains_string':return'8';case'doesnt_contain_string':return'9';case'matches_regex':return'10';case'doesnt_match_regex':return'11';case'is_string':return'';case'isnt_string':return'';default:return'';}};_me.__getRawExpression=function(sType){switch(sType){case'local_time_meets_criteria':return'10';}
return'';};_me.__getRawHeaderType=function(sType,sFunction,aOutNot){if(sFunction==='isnt_string'){aOutNot[0]=true;}
switch(sType){case'message':switch(sFunction){case'priority_is':aOutNot[0]=false;return'30';case'priority_isnt':aOutNot[0]=true;return'30';case'is_spam':aOutNot[0]=false;return'20';case'isnt_spam':aOutNot[0]=true;return'20';case'is_greater_than':aOutNot[0]=false;return'27';case'is_lower_than':aOutNot[0]=false;return'26';case'doesnt_contain_attachment':aOutNot[0]=true;return'14';case'contains_attachment':aOutNot[0]=false;return'14';}
break;case'smtp_auth':switch(sFunction){case'authorized':aOutNot[0]=false;return'23';case'unauthorized':aOutNot[0]=true;return'23';}
break;case'all_messages':aOutNot[0]=false;return'25';default:var table={'from':'','to':'1','subject':'2','cc':'3','reply_to':'7','date':'5','message_body':'6','custom_message_header':'11','any_message_header':'12','attachment_name':'8','sender':'10','recipient':'9','senders_ip':'15','rdns':'19','ip':'29','spam_score':'31','local_time_meets_criteria':'33','message_to_me':'35'};return table[sType];}};_me.__setOrRemoveTag=function(aValues,sTagName,sValue){if(Is.Defined(aValues[sTagName])){if(sValue!=''){aValues[sTagName][0]['VALUE']=sValue;}else{delete aValues[sTagName];}}else{if(sValue!=''){aValues[sTagName]=[{'VALUE':sValue}];}}};

/* client/inc/obj_filter_line_value.js */
_me=obj_filter_line_value.prototype;function obj_filter_line_value(){};_me.__constructor=function(sType){var me=this;this.__sType=sType;this.__value={};switch(sType){case'starts_with':case'doesnt_start_with':case'ends_with':case'doesnt_end_with':case'contains_string':case'doesnt_contain_string':case'matches_regex':case'doesnt_match_regex':case'is_string':case'isnt_string':me._create('value','obj_input','td1');me._create('match_case','obj_checkbox','td2','','FILTERS::MATCH_CASE');me._create('whole_word','obj_checkbox','td3','','FILTERS::WHOLE_WORD');break;case'matches':case'doesnt_match':me._create('value','obj_input','td1');break;case'priority_is':case'priority_isnt':me._create('priority','obj_select','td1');me.priority._fillLang({'1':'FILTERS::HIGHEST','2':'FILTERS::HIGH','^3$|^$':'FILTERS::NORMAL','4':'FILTERS::LOW','5':'FILTERS::LOWEST'});me.priority._value('^3$|^$');break;case'is_spam':case'isnt_spam':break;case'is_greater_than':case'is_lower_than':me._create('value','obj_input','td1');me._create('digit_place','obj_select','td2');me.digit_place._fill({'KB':getLang('UNITS::KB'),'MB':getLang('UNITS::MB'),'GB':getLang('UNITS::GB')});me.digit_place._value('KB');break;case'spam_is_lower_than':case'spam_is_greater_than':me._create('value','obj_input','td1');break;case'message_to_me':me._create('message_to_me_only','obj_checkbox','td1','','FILTERS::MESSAGE_TO_ME_ONLY');me.message_to_me_only._onchange=function(){if(this._value()){me.message_to_me_to._value(0,true);me.message_to_me_cc._value(0,true);me.message_to_me_bcc._value(0,true);}};me._create('message_to_me_to','obj_checkbox','td2','','FILTERS::MESSAGE_TO_ME_TO');me._create('message_to_me_cc','obj_checkbox','td3','','FILTERS::MESSAGE_TO_ME_CC');me._create('message_to_me_bcc','obj_checkbox','td4','','FILTERS::MESSAGE_TO_ME_BCC');me.message_to_me_to._onchange=me.message_to_me_cc._onchange=me.message_to_me_bcc._onchange=function(){if(this._value())
me.message_to_me_only._value(0,true);};}};_me._getText=function(sType,aValues){if(!Is.Defined(aValues['CONTAIN']))return undefined;switch(sType){case'starts_with':case'doesnt_start_with':case'ends_with':case'doesnt_end_with':case'contains_string':case'doesnt_contain_string':case'matches_regex':case'doesnt_match_regex':case'is_string':case'isnt_string':case'matches':case'doesnt_match':return aValues['CONTAIN'][0]['VALUE'];case'priority_is':case'priority_isnt':switch(aValues['CONTAIN'][0]['VALUE'].toString()){case'1':return getLang('FILTERS::HIGHEST');case'2':return getLang('FILTERS::HIGH');case'^3$|^$':return getLang('FILTERS::NORMAL');case'4':return getLang('FILTERS::LOW');case'5':return getLang('FILTERS::LOWEST');}
break;case'is_greater_than':case'is_lower_than':var nBytes=parseInt(aValues['CONTAIN'][0]['VALUE']);if((nBytes/(1024*1024))<1){return(nBytes/1024).toString()+' KB';}else{if(nBytes/(1024*1024*1024)<1){return(nBytes/(1024*1024)).toString()+' MB';}else{return(nBytes/(1024*1024*1024)).toString()+' GB';}}
break;case'spam_is_lower_than':case'spam_is_greater_than':return aValues['CONTAIN'][0]['VALUE']/100;}
return undefined;}
_me._isCompatibleTypeWith=function(sType){var aGroups=[['starts_with','doesnt_start_with','ends_with','doesnt_end_with','contains_string','doesnt_contain_string','matches_regex','doesnt_match_regex','is_string','isnt_string'],['matches','doesnt_match'],['is_spam','isnt_spam'],['priority_is','priority_isnt'],['is_greater_than','is_lower_than'],['spam_is_lower_than','spam_is_greater_than'],['none'],['message_to_me']];for(var group1 in aGroups){for(var i in aGroups[group1]){if(aGroups[group1][i]==sType){for(var group2 in aGroups){for(var i in aGroups[group2]){if(aGroups[group2][i]==this.__sType){return(group1==group2);}}}}}}
return false;}
_me._value=function(aValues){if(Is.Defined(aValues)){this.__value=aValues;switch(this.__sType){case'starts_with':case'doesnt_start_with':case'ends_with':case'doesnt_end_with':case'contains_string':case'doesnt_contain_string':case'matches_regex':case'doesnt_match_regex':case'is_string':case'isnt_string':this.__setTextFilter(aValues);break;case'matches':case'doesnt_match':this.__setIPFilter(aValues);break;case'priority_is':case'priority_isnt':this.__setPriority(aValues);break;case'is_spam':case'isnt_spam':break;case'is_greater_than':case'is_lower_than':this.__setSize(aValues);break;case'spam_is_lower_than':case'spam_is_greater_than':this.__setSpamScore(aValues);break;case'message_to_me':this.__setMessageMe(aValues);}}else{switch(this.__sType){case'starts_with':case'doesnt_start_with':case'ends_with':case'doesnt_end_with':case'contains_string':case'doesnt_contain_string':case'matches_regex':case'doesnt_match_regex':case'is_string':case'isnt_string':this.__getTextFilter(this.__value);break;case'matches':case'doesnt_match':this.__getIPFilter(this.__value);break;case'priority_is':case'priority_isnt':this.__getPriority(this.__value);break;case'is_greater_than':case'is_lower_than':this.__getSize(this.__value);break;case'spam_is_lower_than':case'spam_is_greater_than':this.__getSpamScore(this.__value);break;case'message_to_me':this.__getMessageMe(this.__value);}
return this.__value;}};_me.__setMessageMe=function(aValues){var sContain=(Is.Defined(aValues['CONTAIN']))?aValues['CONTAIN'][0]['VALUE']:0,aContain=base64.decode(sContain).split('').map(function(v){return v.codePointAt()});if(aContain[0]){this.message_to_me_only._value(1,true);this.message_to_me_to._value(0,true);this.message_to_me_cc._value(0,true);this.message_to_me_bcc._value(0,true);}
else{this.message_to_me_only._value(0,true);this.message_to_me_to._value(aContain[1],true);this.message_to_me_cc._value(aContain[2],true);this.message_to_me_bcc._value(aContain[3],true);}};_me.__getMessageMe=function(aValues){this.__setOrRemoveTag(aValues,'CONTAIN',base64.encode([this.message_to_me_only._value()?'\u0001':'\u0000',this.message_to_me_to._value()?'\u0001':'\u0000',this.message_to_me_cc._value()?'\u0001':'\u0000',this.message_to_me_bcc._value()?'\u0001':'\u0000'].join('')));};_me.__setTextFilter=function(aValues){var sContain=(Is.Defined(aValues['CONTAIN']))?aValues['CONTAIN'][0]['VALUE']:'';this.value._value(sContain);if(Is.Defined(aValues['CASE'])){var nCase=parseInt(aValues['CASE'][0]['VALUE']);this.match_case._value((nCase&0x01)?true:false);this.whole_word._value((nCase&0x04)?true:false);}}
_me.__getTextFilter=function(aValues){this.__setOrRemoveTag(aValues,'CONTAIN',this.value._value());var nCase=0;if(this.match_case._value())nCase|=0x01;if(this.whole_word._value())nCase|=0x04;this.__setOrRemoveTag(aValues,'CASE',(nCase!=0)?nCase.toString():'');}
_me.__setOrRemoveTag=function(aValues,sTagName,sValue){if(Is.Defined(aValues[sTagName])){if(sValue!=''){aValues[sTagName][0]['VALUE']=sValue;}else{delete aValues[sTagName];}}else{if(sValue!=''){aValues[sTagName]=[{'VALUE':sValue}];}}}
_me.__setPriority=function(aValues){this.priority._value(aValues['CONTAIN'][0]['VALUE']);}
_me.__getPriority=function(aValues){this.__setOrRemoveTag(aValues,'CONTAIN',this.priority._value());}
_me.__getSize=function(aValues){var nSize=this.value._value();switch(this.digit_place._value()){case'KB':nSize*=1024;break;case'MB':nSize*=1024*1024;break;case'GB':nSize*=1024*1024*1024;break;}
nSize=Math.round(nSize);this.__setOrRemoveTag(aValues,'CONTAIN',nSize);this.__setOrRemoveTag(aValues,'MESSAGESIZE',nSize);}
_me.__setSize=function(aValues){var nBytes=parseInt(aValues['CONTAIN'][0]['VALUE']);if((nBytes/(1024*1024))<1){this.value._value(nBytes/1024);this.digit_place._value('KB');}else{if(nBytes/(1024*1024*1024)<1){this.value._value(nBytes/(1024*1024));this.digit_place._value('MB');}else{this.value._value(nBytes/(1024*1024*1024));this.digit_place._value('GB');}}}
_me.__setSpamScore=function(aValues){var nSize=aValues['CONTAIN'][0]['VALUE']/100;this.value._value(Math.abs(nSize));};_me.__getSpamScore=function(aValues){var nSize=Math.round(this.value._value()*100);if(this._parent.func._value()=='spam_is_lower_than'){this.__setOrRemoveTag(aValues,'CONTAIN',nSize*-1);this.__setOrRemoveTag(aValues,'MESSAGESIZESMALLER',1);}
else{this.__setOrRemoveTag(aValues,'CONTAIN',nSize);this.__setOrRemoveTag(aValues,'MESSAGESIZESMALLER',0);}
this.__setOrRemoveTag(aValues,'MESSAGESIZE',Math.abs(nSize));}
_me.__setIPFilter=function(aValues){var sContain=(Is.Defined(aValues['CONTAIN']))?aValues['CONTAIN'][0]['VALUE']:'';this.value._value(sContain);}
_me.__getIPFilter=function(aValues){this.__setOrRemoveTag(aValues,'CONTAIN',this.value._value());}

/* client/inc/obj_focus.js */
_me=obj_focus.prototype;function obj_focus(){};obj_focus.buffer=[];_me.__constructor=function(){var me=this;this.__handler=function(e){var e=e||window.event,elm=e.target||e.srcElement;switch(elm.tagName){case'BUTTON':case'INPUT':case'TEXTAREA':case'SELECT':me.__add(elm);}};if(document.addEventListener)
document.addEventListener('focus',this.__handler,true);else
document.onfocusout=this.__handler;this._add_destructor('__destructor');};_me._getFocus=function(){for(var i=obj_focus.buffer.length-1;i>=0;i--){if(!obj_focus.buffer[i]||!document.body.contains(obj_focus.buffer[i]))
obj_focus.buffer.splice(i,1);else
if(obj_focus.buffer[i].disabled)
continue;else{var elm=obj_focus.buffer[i];if(document.activeElement!==elm)
elm.focus();if(document.activeElement===elm)
return elm;}}};_me.__add=function(obj){if(obj&&('focus'in obj)&&obj_focus.buffer[obj_focus.buffer.length-1]!==obj){this.__remove(obj);obj_focus.buffer.push(obj);}};_me.__remove=function(obj){for(var i=obj_focus.buffer.length-1;i>=0;i--)
if(!obj_focus.buffer[i]||!document.body.contains(obj_focus.buffer[i]))
obj_focus.buffer.splice(i,1);else
if(obj&&obj===obj_focus.buffer[i]){obj_focus.buffer.splice(i,1);return;}};_me.__destructor=function(){if(document.removeEventListener)
document.removeEventListener('focus',this.__handler,true);else
document.onfocusout=null;};

/* client/inc/obj_form_restrict.js */
_me=obj_form_restrict.prototype;function obj_form_restrict(){};_me.__constructor=function(){this._checkError=[];};_me._restrict=function(){if(!arguments.length){this.__restrictions=null;return false;}
this.__restrictions=arguments;var inp=this._getFocusElement();if(inp){AttachEvent(inp,'oninput',function(){this.__check();}.bind(this));this.__check();return true;}
else{return false;}};_me._validate=function(){return this.__check();};_me.__check=function(){if(!this.__restrictions||!this.__restrictions.length){if(this._checkError.length&&this._onerror){this._checkError=[];removecss(this._main,'error');this._onerror(false);}
return true;}
var r=this.__restrictions,v=this._getFocusElement().value,checkError=[],x,invert,ok,re;for(var i=0;i<r.length;i+=2)
if(r[i]){ok=false;invert=false;if(r[i]instanceof RegExp)
ok=r[i].test(v);else if(Is.Object(r[i]))
ok=executeCallbackFunction(r[i],v)?true:false;else{re=r[i];if(re.charAt(0)=="!"){invert=true;re=re.substr(1);}
if(re.charAt(0)==">"){var number;if(re.charAt(re.length-1)=='i'){if(v.match(/^[0-9]+$/)!=null&&(number=parseInt(v))!=NaN&&number>re.substr(1,re.length-2))
ok=true;}
else
if(v.match(/^[0-9.]+$/)!=null&&(number=parseFloat(v))!=NaN&&number>re.substr(1))
ok=true;}
else
if(re.charAt(0)=="<"){var number;if(re.charAt(re.length-1)=='i'){if(v.match(/^[0-9]+i?$/)&&(number=parseInt(v))!=NaN&&number<re.substr(1,re.length-2))
ok=true;}
else
if(v.match(/^[0-9.]+i?$/)&&(number=parseFloat(v))!=NaN&&number<re.substr(1))
ok=true;}
else{x=new RegExp(re,'gi');if(v.match(x))ok=true;}}
if((ok&&invert)||(!ok&&!invert))
checkError.push(r[i+1]||'');}
if(checkError.length){addcss(this._main,'error');if(this._onerror&&!this._checkError.length){this._checkError=checkError;this._onerror(true);}
else
this._checkError=checkError;return;}
else
if(this._checkError&&this._checkError.length){removecss(this._main,'error');this._checkError=[];if(this._onerror)this._onerror(false);}
return true;};

/* client/inc/obj_frame.js */
_me=obj_frame.prototype;function obj_frame(){};_me.__constructor=function(){this._resize=false;this.__eFrame=this._getAnchor('frame');this.__eFrame.setAttribute('allowfullscreen','true');this.__eFrame.setAttribute('mozallowfullscreen','true');this.__eFrame.setAttribute('webkitallowfullscreen','true');this.__doc=this.__eFrame.contentDocument||this.__eFrame.contentWindow.document;if(this.__eFrame.contentWindow.addEventListener)
this.__eFrame.contentWindow.addEventListener("keydown",function(e){var e=e||this.event;if(e.keyCode==27){e.cancelBubble=true;try{e.preventDefault();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
try{e.stopPropagation();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
return false;}},false);this._write();};_me._sandbox=function(arr){this.__eFrame.setAttribute('sandbox',(arr||[]).join(' '));};_me._src=function(sURL){this.__eFrame.src=sURL;};_me._write=function(html,headers){this.__doc.open('text/html','replace');var html=html?mkElement('div',{innerHTML:html}).innerHTML:'';var html="<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n"+'<html lang="'+document.documentElement.lang+'">\n<head>\n'+'<meta http-equiv="x-dns-prefetch-control" content="off">'+"\n</head>\n"+'<body'+(html?' onload="if (window.parent.'+this._pathName+'._resize) window.parent.'+this._pathName+'._onresize(true);"':'')+'><div style="height: auto!important; overflow: hidden">'+html+"</div></body>\n</html>";this.__doc.write(html);if(Is.Array(headers)){for(var i in headers){for(var node in headers[i]){this.__doc.head.appendChild(mkElement(node,headers[i][node],this.__doc));}}}
var me=this;if(html&&navigator.userAgent.indexOf('WebKit')!=-1){var img=this.__doc.getElementsByTagName('img');for(var i=img.length-1;i>=0;i--)
if(img[i].nodeName=='IMG')
img[i].addEventListener('load',function(e){if(me._onresize)me._onresize(me.__doc);},false);}
if(this.__doc.body){this.__eFrame.onload=function(){if(this.contentDocument){if(this.contentDocument.scrollingElement)
this.contentDocument.scrollingElement.scrollTop=0;this.contentDocument.addEventListener('scroll',function(e){if(me._onscroll)
me._onscroll(e,this.scrollingElement.scrollTop);me.__exeEvent('onscroll',e,{"value":this.scrollingElement.scrollTop,"owner":this});},false);}};}
this.__handlers();this.__doc.close();};_me.__handlers=function(){var me=this;this.__doc.oncontextmenu=function(e){if(gui.cmenu)
gui.cmenu._destruct();};function mouseEvn(e){var e=e||me.__eFrame.contentWindow.event,pos=getSize(me.__eFrame);if(document.createEventObject){var evt=document.createEventObject();evt.clientX=e.clientX+pos.x;evt.clientY=e.clientY+pos.y;return me.__eFrame.fireEvent('on'+e.type,evt)?true:false;}
else{var evt=document.createEvent("MouseEvents");evt.initMouseEvent(e.type,true,true,window,0,0,0,e.clientX+pos.x,e.clientY+pos.y,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,null);return me.__eFrame.dispatchEvent(evt);}};this.__doc.onmousemove=mouseEvn;this.__doc.onmousedown=mouseEvn;this.__doc.onmouseup=mouseEvn;this.__doc.onclick=mouseEvn;this.__doc.onmouseover=mouseEvn;AttachEvent(this.__doc,"onmousewheel",function(e){if(me._onmousewheel)
me._onmousewheel(e);});this.__eFrame.contentWindow.onresize=function(e){if(me._resize&&this.__width!=me.__eFrame.offsetWidth){this.__width=me.__eFrame.offsetWidth;me._onresize();}};};_me._onresize=function(){var div=this.__doc.getElementsByTagName('div');this.__eFrame.style.height=(div&&(div=div[0])?(div.offsetHeight+40):0)+'px';};_me._print=function(){this.__eFrame.contentWindow.focus();if(this.__eFrame.contentWindow.document.queryCommandSupported('print')){this.__eFrame.contentWindow.document.execCommand('print',false,null);}else{this.__eFrame.contentWindow.print();}};

/* client/inc/obj_frame_control.js */
_me=obj_frame_control.prototype;function obj_frame_control(){};_me.__constructor=function(){var me=this;this._getAnchor('header').onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName!='A'||!elm.id)return;switch(elm.id.substr(me._pathName.length+1)){case'home':if(me._homepage)
me._src(me._homepage);break;case'back':me.__eFrame.contentWindow.history.back();break;case'next':me.__eFrame.contentWindow.history.forward();break;}};};

/* client/inc/obj_freebusy.js */
function obj_freebusy(){}
obj_freebusy.__SLOTHEIGHT=17;obj_freebusy.__DAYHEIGHT=816;obj_freebusy.__PREFETCH=3;obj_freebusy.__EVNTYPE={UNKNOWN:'unknown',BUSY:'busy'};_me=obj_freebusy.prototype;_me.__constructor=function(){this.__eBody=this._getAnchor('body');this.__scrollTop=0;this.__opt={};this.__lastRange=[0,0];this.__range=[0,0];this.__aData={};this.__inCollision=false;this.__readonly=false;this.__now_int=null;this.__now_div=null;this.__title='';this.__value={};this._freeBusy=new wm_freebusy();this.__timeline={time:[]};var iwd=new IcewarpDate();for(var i=60;i<1440;i+=60){this.__timeline.time.push(iwd.setTime(i,true).format('LT'));}
this._create('scrollbar','obj_scrollbar')._scrollbar(this.__eBody,this._getAnchor('container'));this.__eBody.onscroll=function(e){if(this.__scrollTop!=this.__eBody.scrollTop){this.__scrollTop=this.__eBody.scrollTop;if(this._onscroll)
this._onscroll(this.__scrollTop);this.__exeEvent('onscroll',e,{"arg":this.__scrollTop,"owner":this});}}.bind(this);this.__eBody.ondblclick=function(elm,e){var e=e||window.event;if(this.__plan_div&&this.__plan_div.contains(e.target||e.srcElement))
return;var y=gui.__Y-getSize(elm).y+elm.scrollTop,d=this.__range[0]+Math.floor(y/obj_freebusy.__DAYHEIGHT),t=Math.floor(y%obj_freebusy.__DAYHEIGHT/obj_freebusy.__SLOTHEIGHT)*30,v=this._value();this._value(obj_freebusy.__timeShift(v,d-v.startdate,t-v.starttime),false,true);}.bind(this,this.__eBody);var me=this;this.__eBody.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(this.__readonly||elm.parentNode.classList.contains('plan')){return;}
var x=Math.floor((gui.__Y+me.__eBody.scrollTop-getSize(me.__eBody).y)/obj_freebusy.__SLOTHEIGHT)*obj_freebusy.__SLOTHEIGHT,start,end,old=me.__value,diff,duration=mkElement('span'),new_event=mkElement('div',{className:'plan new_event'},false,[mkElement('div',{},false,[duration])]);function move(){var top,diff_time,start_date,start_time,end_date,end_time;if(!new_event.parentNode){me.__eBody.appendChild(new_event);}
diff=Math.floor((gui.__Y+me.__eBody.scrollTop-getSize(me.__eBody).y-x)/obj_freebusy.__SLOTHEIGHT)*obj_freebusy.__SLOTHEIGHT;if(diff>0){top=x;diff_time=x+diff;new_event.classList.remove('top');new_event.classList.add('bottom');}else{top=x+diff;diff_time=x;new_event.classList.add('top');new_event.classList.remove('bottom');}
start_date=me.__range[0]+Math.floor(top/obj_freebusy.__DAYHEIGHT);start_time=(top-(start_date-me.__range[0])*obj_freebusy.__DAYHEIGHT)/obj_freebusy.__SLOTHEIGHT*30;start=IcewarpDate.julian(start_date,start_time);end_date=me.__range[0]+Math.floor(diff_time/obj_freebusy.__DAYHEIGHT);end_time=(diff_time-(end_date-me.__range[0])*obj_freebusy.__DAYHEIGHT)/obj_freebusy.__SLOTHEIGHT*30;end=IcewarpDate.julian(end_date,end_time);new_event.style.top=top+'px';new_event.style.height=Math.abs(diff)+'px';difference=Math.round((end-start)/360000)/10;duration.textContent=getLang('TIME_INTERVAL::DURATION')+': '+Math.floor(difference)+':'+('0'+(difference%1*60)).slice(-2)+'h';};gui._obeyEvent('mousemove',[move]);me._obeyEvent('onscroll',[move]);gui._obeyEvent('mouseup',[function(){gui._disobeyEvent('mousemove',[move]);me._disobeyEvent('onscroll',[move]);new_event.parentNode&&new_event.parentNode.removeChild(new_event);diff&&me._value({startdate:start.format('julian'),starttime:start.format('julian_time'),enddate:end.format('julian'),endtime:end.format('julian_time')},true,true,{noCollision:true});var v=me.__value;if(!compareObj(old,v)){me._collision();var val=me._value();if(me._onchange)
me._onchange(val);me.__exeEvent('onchange',null,{"arg":val,"owner":me});}
return false;}]);};var eFrame=mkElement('iframe',{frameborder:0,marginheight:0,marginwidth:0,src:"",seamless:"seamless"});this._main.appendChild(eFrame);var height=eFrame.offsetHeight;eFrame.contentWindow.onresize=function(e){if(height!=eFrame.offsetHeight){height=eFrame.offsetHeight;if(this._onsize)
this._onsize(height);}}.bind(this);this._create('plan','obj_freebusy_plan','block','',this);this._add_destructor('__destructor');};_me.__scroll=function(pos,bNoEvn){if(Is.Defined(pos)){pos=Math.max(0,pos);pos=Math.min(this.__eBody.scrollHeight-this.__eBody.clientHeight,pos);if(bNoEvn)
this.__scrollTop=pos;this.__eBody.scrollTop=pos;return pos;}
return this.__scrollTop;};_me.__position=function(iTime,bFine,bCeil){var fx=bCeil?Math.ceil:Math.floor;if(bFine)
return fx(iTime/30*obj_freebusy.__SLOTHEIGHT);else
return fx(iTime/30)*obj_freebusy.__SLOTHEIGHT;};_me._onscroll=function(v){if(v<100){this.__request([this.__range[0]-1-obj_freebusy.__PREFETCH,this.__range[0]-1]);}
else
if(v>this.__eBody.scrollHeight-this.__eBody.clientHeight-100){this.__request([this.__range[1]+1,this.__range[1]+1+obj_freebusy.__PREFETCH]);}
this._dateLabel();};_me._dateLabel=function(){var iwd=IcewarpDate.julian(this.__range[0]+Math.floor((this.__eBody.scrollTop+obj_freebusy.__SLOTHEIGHT)/obj_freebusy.__DAYHEIGHT)),elm=this._getAnchor('date');elm.innerHTML=iwd.format('MMM D');if(this.__eBody.scrollTop%obj_freebusy.__DAYHEIGHT>obj_freebusy.__DAYHEIGHT-obj_freebusy.__SLOTHEIGHT*3&&this.__eBody.scrollTop%obj_freebusy.__DAYHEIGHT<obj_freebusy.__DAYHEIGHT-obj_freebusy.__SLOTHEIGHT){elm.style.top=(obj_freebusy.__DAYHEIGHT-obj_freebusy.__SLOTHEIGHT*3-(this.__eBody.scrollTop%obj_freebusy.__DAYHEIGHT))+'px';}
else{elm.style.top=0;}};_me._value=function(aValue,bNoUpdate,bNoScroll,aOpt){aOpt=aOpt||{};if(Is.Defined(aValue)){aValue.start_d=aValue.startdate;if(aValue.starttime<0){aValue.start_t=0;aValue.end_t=1440;aValue.end_d=aValue.enddate-1;}
else{aValue.start_t=aValue.starttime;aValue.start_t2=Math.floor(aValue.starttime/30)*30;aValue.end_t=aValue.endtime;aValue.end_t2=Math.ceil(aValue.endtime/30)*30;aValue.end_d=aValue.enddate;}
var tzid=this._value().tzid;if(aValue.tzid&&tzid!=aValue.tzid){aOpt.force=true;}
else
if(this.__value.startdate==aValue.startdate&&this.__value.enddate==aValue.enddate&&this.__value.starttime==aValue.starttime&&this.__value.endtime==aValue.endtime){if(!aValue.title||aValue.title==this.__title)
return;}
if(aValue.title){this.__title=aValue.title;delete aValue.title;}
if(aOpt.force)
this.__range=[0,0];this.__value=aValue;if(this.__range[0]<aValue.startdate&&this.__range[1]>aValue.enddate){this.__replan(!aOpt.noCollision);if(!bNoScroll){this.__scroll(this.__position((aValue.startdate-this.__range[0])*1440+aValue.start_t)-Math.ceil(this.__eBody.offsetHeight/8),true);}}
else{var r1=aValue.startdate-obj_freebusy.__PREFETCH,r2=aValue.startdate+Math.ceil(Math.min(this.__eBody.offsetHeight,document.body.clientHeight)/obj_freebusy.__DAYHEIGHT)-1+obj_freebusy.__PREFETCH;aOpt.scroll=!bNoScroll;this.__request([r1,r2],null,aOpt);}
if(!bNoUpdate){var val=this._value();if(this._onchange)
this._onchange(val);this.__exeEvent('onchange',null,{"arg":val,"owner":this});}}
else{var out={startdate:this.__value.startdate,starttime:this.__value.starttime,enddate:this.__value.enddate,endtime:this.__value.endtime,tzid:this.__value.tzid||this.__opt.tzid,title:this.__title};if(out.starttime==0&&out.endtime==1440){out.starttime=-1;out.endtime=-1;out.enddate++;}
return out;}};_me._title=function(sTitle){if(Is.String(sTitle)){this.__title=sTitle;this.__replan();}
else
return this.__title;};_me._readonly=function(bReadonly){if(Is.Defined(bReadonly)){this.__readonly=!!bReadonly;this._main.classList.toggle('readonly',bReadonly);}
else
return this.__readonly;};_me._init=function(aOpt){var old=clone(this.__opt,true);this.__opt=aOpt;this.__opt.owner=this.__opt.owner||sPrimaryAccount;this.__opt.users=this.__opt.users||[];if(!compareObj(old,this.__opt)){this._value(this.__value,true,null,{force:true});}};_me._users=function(aUsers){if(!compareObj(this.__opt.users,aUsers,true)){if(!aUsers||Is.Empty(aUsers)){this.__opt.users=[];this.__aData={};this.__lastRq=null;this.__clean();this._collision();}
else{this.__opt.users.filter(function(v){if(aUsers.indexOf(v)<0){this.__removeUser(v);return false;}
return true;},this);var aReq=aUsers.filter(function(v){return this.__opt.users.indexOf(v)<0;},this);this.__opt.users=aUsers;this.__request(this.__range,aReq,{force:true});}}
else
this.__opt.users=aUsers;};_me.__removeUser=function(sUser){var sUser=sUser.toLowerCase();for(var id in this.__aData){if(this.__aData[id].ACCOUNT.toLowerCase()==sUser)
delete this.__aData[id];}};_me.__request=function(aRange,aUsers,aOpt){aOpt=aOpt||{};var tzid=this._value().tzid;if(Is.Array(aRange)){if(!aOpt.force&&this.__lastRange[0]==aRange[0]&&this.__lastRange[1]==aRange[1]&&this.__lastTzid==tzid)
return;if(aRange[0]==0)return;this.__lastRange=aRange;this.__lastRq=unique_id();var aU=aUsers||this.__opt.users||[];if(aU.length){var aData=Object.assign({},this.__opt,{from:aRange[0],to:aRange[1],users:aU});this.__lastTzid=tzid;if(this.__lastTzid)
aData.tzid=this.__lastTzid;this._freeBusy.get(aData,'null','',[this,'__response',[aRange,aUsers,this.__lastRq,aOpt]]);}
else{this.__lastRq=unique_id();this.__response(true,{},aRange,[],this.__lastRq,aOpt);}}};_me.__clean=function(){var tmp=this.__eBody.querySelectorAll('div.event');for(i=tmp.length;i--;){tmp[i].parentNode&&tmp[i].parentNode.removeChild(tmp[i]);}};_me.__response=function(bOK,aData,aRange,aUsers,rqid,aOpt){if(!bOK||this._destructed||this.__lastRq!=rqid){return;}
var scrollTop=null,days={};if(aRange[0]<1){return;}
else
if(this.__range[0]<=aRange[0]&&this.__range[1]>=aRange[1]){if(Is.Array(aUsers)){Object.assign(this.__aData,aData);}
else{if(aOpt.force)
this.__replan();return;}}
else
if(this.__range[0]>aRange[1]+1||this.__range[1]<aRange[0]-1){this.__aData=aData;this.__range=aRange;if(!aOpt.scroll)
scrollTop=this.__position((this.__value.start_d-this.__range[0])*1440+this.__value.start_t)-Math.ceil(this.__eBody.offsetHeight/8);days={clean:true,append:this.__range};}
else{if(aRange[0]<this.__range[0]){if(!aOpt.scroll)
scrollTop=this.__position((this.__range[0]-aRange[0])*1440)+this.__scroll();days.prepend=[aRange[0],this.__range[0]-1];this.__range[0]=aRange[0];}
if(aRange[1]>this.__range[1]){days.append=[this.__range[1]+1,aRange[1]];this.__range[1]=aRange[1];}
Object.assign(this.__aData,aData);}
var aEvents=this.__prepare(this.__aData);this.__days(days);if(aOpt.scroll){this.__scroll(this.__position((this.__value.startdate-this.__range[0])*1440+this.__value.start_t)-Math.ceil(this.__eBody.offsetHeight/8),true);this.__replan(true);this._dateLabel();}
else
if(scrollTop!==null){this.__scroll(scrollTop,true);this.__replan();this._dateLabel();}
else
if(aOpt.force)
this._collision();this.__events(aEvents);if(aOpt.handler)
executeCallbackFunction(aOpt.handler);};_me.__days=function(days){var iwd,tplData=this.__timeline;if(days.prepend){tplData.day=[];for(var jul=days.prepend[0];jul<=days.prepend[1];jul++){iwd=IcewarpDate.julian(jul);tplData.day.push({date:iwd.format('MMM D'),fulldate:iwd.format('L'),id:jul});}
this._draw('obj_freebusy_day','body',tplData,2);}
if(days.append){tplData.day=[];for(var jul=days.append[0];jul<=days.append[1];jul++){iwd=IcewarpDate.julian(jul);tplData.day.push({date:iwd.format('MMM D'),fulldate:iwd.format('L'),id:jul});}
this._draw('obj_freebusy_day','body',tplData,!days.clean);}};_me.__replan=function(bCollision){if(!this.__plan_div||!this.__plan_div.parentNode){var eControls=[mkElement('div'),mkElement('span',{className:'move',draggable:false}),mkElement('span',{className:'resize-top',draggable:false}),mkElement('span',{className:'resize-bottom',draggable:false})];this.__plan_div=mkElement('div',{className:'plan unselectable',draggable:false},null,eControls);var me=this;this.__plan_div.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm===this||me.__readonly){return;}else if(elm===eControls[2]||elm===eControls[3]){me.__plan_div.classList.add('resizing');}
var x=gui.__Y+me.__eBody.scrollTop,r=me.__range[0],old=clone(me.__value);function move(e){var dif=gui.__Y-x+me.__eBody.scrollTop-(r-me.__range[0])*obj_freebusy.__DAYHEIGHT,dif_time=Math.round(dif/obj_freebusy.__SLOTHEIGHT)*30,v;if(dif<=0&&!dif_time){v=old;}
else
if(Math.abs(dif_time)>0){if(old.starttime==-1){old.starttime=0;old.endtime=1440;old.enddate=Math.max(old.startdate,old.enddate-1);}
if(elm===eControls[1]){v=obj_freebusy.__timeShift(old,0,dif_time);}
else
if(elm===eControls[2]){var iwtS=IcewarpDate.julian(old.startdate,old.starttime),iwtE=IcewarpDate.julian(old.enddate,old.endtime);iwtS.add(dif_time,'m');if(iwtS.format('julian')>=iwtE.format('julian')&&iwtS.format('julian_time')>=iwtE.format('julian_time'))
iwtS=iwtE.subtract(30,'m');v=Object.assign({},old,{startdate:iwtS.format('julian'),starttime:iwtS.format('julian_time')});}
else
if(elm===eControls[3]){var iwtS=IcewarpDate.julian(old.startdate,old.starttime),iwtE=IcewarpDate.julian(old.enddate,old.endtime);iwtE.add(dif_time,'m');if(iwtS.format('julian')>=iwtE.format('julian')&&iwtS.format('julian_time')>=iwtE.format('julian_time'))
iwtE=iwtS.add(30,'m');v=Object.assign({},old,{enddate:iwtE.format('julian'),endtime:iwtE.format('julian_time')});}}
if(v)
me._value(v,true,true,{noCollision:true});};gui._obeyEvent('mousemove',[move]);me._obeyEvent('onscroll',[move]);gui._obeyEvent('mouseup',[function(){gui._disobeyEvent('mousemove',[move]);me._disobeyEvent('onscroll',[move]);me.__plan_div.classList.remove('resizing');var v=me.__value;if(!compareObj(old,v)){me._collision();var val=me._value();if(me._onchange)
me._onchange(val);me.__exeEvent('onchange',null,{"arg":val,"owner":me});}
return false;}]);};this.__eBody.appendChild(this.__plan_div);}
this.__plan_div.firstChild.innerHTML=(Is.String(this._title())?'<span>'+this._title().escapeHTML()+'</span>':'')+(this.__value.starttime>-1?IcewarpDate.julian(this.__value.startdate,this.__value.starttime).format('LT')+' - '+IcewarpDate.julian(this.__value.enddate,this.__value.endtime).format('LT'):'');this.__plan_div.style.top=this.__position((this.__value.start_d-this.__range[0])*1440+this.__value.start_t2)+'px';var h=this.__position((this.__value.end_d-this.__value.start_d)*1440+this.__value.end_t2-this.__value.start_t2,false,true);this.__plan_div.style.height=h+'px';if(h==obj_freebusy.__SLOTHEIGHT)
addcss(this.__plan_div,'small');else
removecss(this.__plan_div,'small');if(bCollision)
this._collision();};_me.__prepare=function(aData,aRange){var aOut=[],evn,aRange=aRange||this.__range;for(var id in aData){evn=aData[id];evn.id=id;evn.startdate=Math.max(aRange[0],evn.STARTDATE);evn.starttime=evn.startdate!=evn.STARTDATE?0:Math.max(evn.STARTTIME,0);var end=evn.ENDDATE;if(evn.ENDTIME==0&&evn.STARTDATE<evn.ENDDATE)
end--;evn.enddate=Math.min(aRange[1],end);evn.endtime=evn.enddate!=end?1440:Math.max(evn.ENDTIME,0);evn.start2=Math.floor(evn.starttime/30)*30;evn.end2=Math.ceil(evn.endtime/30)*30;if(evn.start2>=evn.end2)
evn.end2=evn.start2+30;evn.start=evn.startdate*1440+evn.start2;evn.end=evn.enddate*1440+evn.end2;evn.position=0;evn.width=1;aOut.push(evn);}
aOut.sort(function(a,b){var x=a.STARTDATE-b.STARTDATE;if(x==0){x=a.STARTTIME-b.STARTTIME;if(x==0)
x=b.end-a.end;}
return x;});var old_j,j=0,block,iend=0,relPosition=0;while(aOut[j]){old_j=j;block=aOut[j];iend=iend?iend:block.end;relPosition=0;for(var k=j+1,l=aOut.length;k<l;k++){if(iend<block.end)
iend=block.end;if(block.end<=aOut[k].start){aOut[k].position=block.position;aOut.splice(j+1,0,aOut[k]);aOut.splice(k+1,1);j++;break;}else{if(aOut[k-1].end&&aOut[k].start<aOut[k-1].end)
relPosition++;aOut[k].position=block.position+relPosition;}}
if(!block.position&&block.start>=iend)
iend=0;if(old_j==j)
j++;}
var pos,del;for(var j=0,l=aOut.length;j<l;j++){if(aOut[j]['position']==0){var prekrejva=-1;for(var k=j;k<l;k++){if(aOut[k]['position']>aOut[j]['position']){if(aOut[k]['start']<aOut[j]['end'])
prekrejva=k;break;}}
if(prekrejva<0)
continue;del=1;pos=0;for(var k=prekrejva;k<l;k++){if(aOut[k]['position']<pos)
break;if(aOut[k]['position']==pos)
continue;pos=aOut[k]['position'];del=pos+1;}
for(;j<k;j++){aOut[j]['delimiter']=del;var dif=0;for(var l=j+1;l<k;l++){if(aOut[j]['position']<aOut[l]['position']&&aOut[j]['start']<aOut[l]['end']&&aOut[j]['end']>aOut[l]['start']){dif=aOut[l]['position']-aOut[j]['position'];break;}}
if(dif>1)
aOut[j]['width']=dif;else
if(dif==0&&aOut[j]['position']+1<aOut[j]['delimiter'])
aOut[j]['width']=aOut[j]['delimiter']-aOut[j]['position'];}
j--;}}
return aOut;};_me.__events=function(aData){this.__clean();var elm=this.__eBody.querySelector('div.block'),div,h;if(elm){var str,css,type;for(var i in aData){str=aData[i].ACCOUNT+(aData[i].SUMMARY?' - '+aData[i].SUMMARY:'');type=(aData[i].TYPE||'').toUpperCase();css=obj_freebusy.__EVNTYPE[type]||'';div=mkElement('div',{className:'event '+css});div.appendChild(mkElement('div',{text:str,title:str}));div.style.top=((aData[i].startdate-this.__range[0])*obj_freebusy.__DAYHEIGHT+this.__position(aData[i].start2))+'px';h=(aData[i].enddate-aData[i].startdate)*obj_freebusy.__DAYHEIGHT+this.__position(aData[i].end2-aData[i].start2,false,true);div.style.height=h+'px';if(h==obj_freebusy.__SLOTHEIGHT)
addcss(div,'small');div.style.left=(aData[i].position/aData[i].delimiter*100)+'%';div.style.width=(aData[i].width/aData[i].delimiter*100)+'%';elm.appendChild(div);}}
var today=(new IcewarpDate()).format('julian');if(this.__range[0]<=today&&this.__range[1]>=today){if(!this.__now_div){this.__now_div=mkElement('div',{className:'today unselectable'});this.__eBody.appendChild(this.__now_div);}
this.__showToday();if(!this.__now_int){this.__now_int=setInterval(function(){this.__showToday();}.bind(this),12000);}}
else{if(this.__now_int){clearInterval(this.__now_int);this.__now_int=null;}
if(this.__now_div){if(this.__now_div.parentNode){this.__now_div.parentNode.removeChild(this.__now_div);}
this.__now_div=null;}}};_me.__showToday=function(){if(this.__now_div&&this.__now_div.parentNode){var iwt=new IcewarpDate(),jul=iwt.format('julian'),tim=iwt.format('julian_time');this.__now_div.style.top=this.__position((jul-this.__range[0])*1440+tim,true)+'px';}};_me._collision=function(){var v=this.__value,evn,bOut=false;for(var id in this.__aData){evn=this.__aData[id];if(evn.TYPE=="UNKNOWN"||(this.__opt.evnid&&evn.EVNUID==this.__opt.evnid)||evn.enddate<v.start_d||(evn.enddate==v.start_d&&evn.endtime<=v.start_t)||evn.startdate>v.end_d||(evn.startdate==v.end_d&&evn.starttime>=v.end_t)){continue;}
bOut=true;break;}
if(this.__plan_div){if(bOut)
addcss(this.__plan_div,'collision');else
removecss(this.__plan_div,'collision');}
this.__inCollision=bOut;if(this._oncollision)
this._oncollision(bOut);this.__exeEvent('oncollision',null,{arg:bOut,owner:this});return bOut;};obj_freebusy.__timeShift=function(tmp,dOff,tOff){var out={};var iwt=IcewarpDate.julian(tmp.enddate,tmp.endtime);iwt.add(dOff,'d');iwt.add(tOff,'m');out.enddate=iwt.format('julian');out.endtime=iwt.format('julian_time');iwt=IcewarpDate.julian(tmp.startdate,tmp.starttime);iwt.add(dOff,'d');iwt.add(tOff,'m');out.startdate=iwt.format('julian');out.starttime=iwt.format('julian_time');return out;};_me._find=function(aHandler){var iwt=new IcewarpDate(),jul=iwt.format('julian'),v=this.__value,out=[];var tmp={startdate:v.start_d,starttime:v.start_t,enddate:v.end_d,endtime:v.end_t};if(tmp.startdate<jul)
tmp=obj_freebusy.__timeShift(tmp,jul-tmp.startdate);var range=clone(this.__range),start=Math.max(tmp.startdate-2,jul);if(range[0]<=start&&range[1]>start){range=[start,range[1]];out=this.__finder(this.__aData,tmp,range);range=[range[1]+1,range[1]+5];}
else{range=[start,start+obj_freebusy.__PREFETCH];}
if(out.length<100&&range[1]<Math.max(v.start_d,jul)+15){this.__find_request(out,tmp,range,aHandler);}
else{executeCallbackFunction(aHandler,out);}};_me.__find_request=function(out,tmp,range,aHandler){var aReq=Object.assign({},this.__opt,{from:range[0],to:range[1],users:this.__opt.users});this._freeBusy.get(aReq,'null','',[function(bOK,aData){if(bOK){this.__prepare(aData,range);out=out.concat(this.__finder(aData,tmp,range,out.length));if(out.length<100&&range[1]<Math.max(this.__value.start_d,(new IcewarpDate()).format('julian'))+15){range=[range[1]+1,range[1]+5];this.__find_request(out,tmp,range,aHandler);return;}}
else{console.warn('freebusy','get data error');out=[];}
if(out.length===0){addcss(this.plan._main,'notfound');setTimeout(function(){try{removecss(this.plan._main,'notfound');}
catch(r){}}.bind(this),3600);}
executeCallbackFunction(aHandler,out);}.bind(this)]);};_me.__finder=function(aData,tmp,range,index){index=index||0;var workstart=GWOthers.getItem('CALENDAR_SETTINGS','day_begins')*60,workend=GWOthers.getItem('CALENDAR_SETTINGS','day_ends')*60,bgn=GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins')*1,end=GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends')*1;if(bgn<1||bgn>7)bgn=1;if(end<1||end>7)bgn=5;var iwt=(new IcewarpDate()),jul=iwt.format('julian');if(range[0]==jul){var t=iwt.format('julian_time');tmp=obj_freebusy.__timeShift(tmp,range[0]-tmp.startdate,(Math.ceil(t/15)*15)-tmp.starttime);}
else{tmp=obj_freebusy.__timeShift(tmp,range[0]-tmp.startdate,-tmp.starttime);}
var events=[];for(var id in aData){if(aData[id].TYPE!="UNKNOWN"&&aData[id].enddate>=range[0]){events.push({startdate:aData[id].startdate,enddate:aData[id].enddate,starttime:aData[id].starttime,endtime:aData[id].endtime,type:'EVENTS'});}}
for(var i=range[0]-1;i<=range[1];i++){if(i==jul){var tim=iwt.format('julian_time');if(tim>0)
events.push({startdate:jul,enddate:jul,starttime:0,endtime:tim,type:'now'});}
var d=IcewarpDate.julian(i).day();if(d>=bgn&&d<=end)
events.push({startdate:i,enddate:i+1,starttime:workend,endtime:workstart,type:'workmask'});else{var inc=d<bgn?(bgn-d):(d-5+bgn);events.push({startdate:i-1,enddate:i+inc,starttime:workend,endtime:workstart,type:'weekmask'});i+=inc-1;}}
events.push({startdate:range[1],starttime:1440,final:true});events.sort(function(a,b){var x=a.startdate-b.startdate;if(x==0){x=a.starttime-b.starttime;if(x==0){x=b.enddate-a.enddate;if(x==0){x=b.endtime-a.endtime;}}}
return x;});for(var slot,slots=[],evn,i=0;(evn=events[i]);){while(true){if(evn.startdate>tmp.enddate||(evn.startdate==tmp.enddate&&evn.starttime>=tmp.endtime)){slot=Object.assign({},tmp);if(slot.starttime==0&&slot.endtime==1440){slot.starttime=-1;slot.endtime=-1;slot.enddate++;}
slots.push(slot);if(slots.length+index>99)
return slots;tmp=obj_freebusy.__timeShift(tmp,0,60);}
else
break;}
if(slots.length+index>99||evn.final)
break;if(evn.enddate>tmp.startdate||(evn.enddate==tmp.startdate&&evn.endtime>tmp.starttime))
tmp=obj_freebusy.__timeShift(tmp,evn.enddate-tmp.startdate,evn.endtime-tmp.starttime);if(tmp.startdate>range[1])
break;i++;}
if(gui._REQUEST_VARS.xml=='1'){console.warn('range',range);console.warn('events',events);console.warn('slots',slots);}
return slots;};_me.__destructor=function(){if(this.__now_int){clearInterval(this.__now_int);this.__now_int=null;}};

/* client/inc/obj_freebusy_plan.js */
function obj_freebusy_plan(){}
_me=obj_freebusy_plan.prototype;_me.__constructor=function(oFreeBusy){this.__freebusy=oFreeBusy;this.__found=[];this.__idTable={};this.__qstate='';this._main.querySelector('.label>span').onclick=function(){if(this.__found.length)
addcss(this.__freebusy._main,'big');else
if(!hascss(this._main,'notfound')&&this.__qstate!='loading'){this.__qstate='loading';addcss(this._main.querySelector('.label'),'loading');this.__freebusy._find([this,'__response']);}}.bind(this);this._main.querySelector('.done>span').onclick=function(){if(this.__freebusy.__inCollision)
removecss(this.__freebusy._main,'big');else
removecss(this.__freebusy._main,'footer','big');}.bind(this);this.__freebusy._obeyEvent('oncollision',[this,'__collision']);this.__eList=this._getAnchor('list');this.__eList.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;this._value(elm.getAttribute('iw-data'));}.bind(this);this._create('scrollbar','obj_scrollbar')._scrollbar(this.__eList);this.filter._onchange=function(){this.__eList.innerHTML='';var list=this.__idTable[this.filter._getDataValue()]||[];for(var i=0,j=list.length;i<j;i++){this.__eList.appendChild(mkElement('div',{text:IcewarpDate.julian(list[i].startdate,list[i].starttime).format('LT')+' - '+IcewarpDate.julian(list[i].enddate,list[i].endtime).format('LT'),'iw-data':list[i].id,className:list[i].id==this.__value?'active':''}));}}.bind(this);};_me.__collision=function(e,arg){if(arg.arg){removecss(this.__freebusy._main,'big');addcss(this.__freebusy._main,'footer');}
else{if(this.__found.length){var v=this.__freebusy._value();for(var i=0,j=this.__found.length;i<j;i++){if(this.__found[i].startdate==v.startdate&&this.__found[i].enddate==v.enddate&&this.__found[i].starttime==v.starttime&&this.__found[i].endtime==v.endtime){this._value(i,true);return;}}}
removecss(this.__freebusy._main,'footer','big');}
this.__found=[];};_me.__response=function(aData){if(this._destructed)
return;removecss(this._main.querySelector('.label'),'loading');this.__qstate='';this.__found=aData;this.__idTable={};if(Is.Empty(aData)){return;}
for(var i=0,j=aData.length;i<j;i++){if(!this.__idTable[aData[i].startdate])
this.__idTable[aData[i].startdate]=[];this.__idTable[aData[i].startdate].push(Object.assign({},aData[i],{id:i}));}
var today=(new IcewarpDate()).format('julian');var sdate=this.__freebusy._value().startdate;var aSel=Object.keys(this.__idTable).map(function(v){var out;if(today==v)
out={text:getLang('CALENDAR::TODAY')};else{var n=v-sdate;if(Math.abs(v)==1)
out={text:getLang('FREEBUSY::DAY',[n>0?'+ '+n:n])};else
out={text:getLang('FREEBUSY::DAYS',[n>0?'+ '+n:n])};}
out.html='<span>('+IcewarpDate.julian(v).format('L')+')</span>';return[out,v];});this.filter._value(-1,true);this.filter._fill(aSel);this.filter._value(0);addcss(this.__freebusy._main,'big');};_me._value=function(v,bNoUpdate){if(Is.Defined(v)){if(this.__found[v]){this.__value=v;removecss(this.__eList.querySelector('div[iw-data].active'),'active');addcss(this.__eList.querySelector('div[iw-data="'+v+'"]'),'active');if(!bNoUpdate)
this.__freebusy._value(this.__found[v]);}}
else
this.__value||null;};

/* client/inc/obj_general_tooltip.js */
_me=obj_general_tooltip.prototype;function obj_general_tooltip(){};_me.__constructor=function(){};_me._showTooltip=function(content,properties){var me=this;return function(e){var e=e||window.event;properties=properties||{};var that=this;if(that&&that.parentNode&&gui.generaltooltip&&!gui.generaltooltip._destructed&&gui.generaltooltip.__eTarget===that&&!hascss(gui.generaltooltip._main,'show')){gui.generaltooltip._show();return;}
if(me.__tooltipdelay)
clearTimeout(me.__tooltipdelay);var x=e.clientX,y=e.clientY;me.__tooltipdelay=setTimeout(function(){if(!that||!document.body.contains(that))
return;if(gui.generaltooltip&&!gui.generaltooltip._destructed&&gui.generaltooltip.__eTarget===that)
return;if(me.__tooltipinterval)
clearInterval(me.__tooltipinterval);gui._create('generaltooltip','obj_info_box','','detail');if(content.text)
gui.generaltooltip._content(content.text.escapeHTML());else if(content.html)
gui.generaltooltip._content(content.html);else if(content.template)
gui.generaltooltip._template(content.template,content.values||{});gui.generaltooltip._context({target:that,x:x,y:y},properties);AttachEvent(gui.generaltooltip._main,'onmouseout',outhandler);gui.generaltooltip._show();me.__tooltipinterval=setInterval(function(){if(!gui.generaltooltip||gui.generaltooltip.__eTarget!==that||!document.body.contains(that)){clearInterval(me.__tooltipinterval);if(gui.generaltooltip)
gui.generaltooltip._hide();}},1000);},"delay"in properties?properties.delay:700);AttachEvent(this,'onmouseout',outhandler);function outhandler(e){var e=e||window.event,elm=e.relatedTarget||e.toElement;if(gui.generaltooltip&&(Is.Child(elm,gui.generaltooltip._main)||elm===that||Is.Child(elm,that)))
return;if(me.__tooltipdelay)
clearTimeout(me.__tooltipdelay);if(me.__tooltipinterval)
clearInterval(me.__tooltipinterval);if(gui.generaltooltip)
gui.generaltooltip._hide();}};};

/* client/inc/obj_groupchat.js */
_me=obj_groupchat.prototype;function obj_groupchat(){};obj_groupchat._OFFLINE=0;obj_groupchat._ONLINE=3;obj_groupchat._TYPING=1;obj_groupchat._COMMENTING=2;obj_groupchat._BACKGROUND=4;_me.__constructor=function(){this.__options={preload:30,autoscroll:true,comments:true,notify:['I','W','R','S','Q','Z','Y','M','E','B','D','-']};this.__aRequestArray=['EVNNOTE','EVN_CREATED','EVN_MODIFIED','EVNSHARETYPE','EVNLINKEXTRAS','EVNURL','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVN_ID','EVNTHUMBNAILTICKET','EVNSIZEINFO','EVNMEETINGID'];this.__aDataLink={};this._getAnchor('loading').innerHTML=getLang('CHAT::LOADING');this._getAnchor('refresh').onclick=function(){if(this.__aRequestData.oldest||(this.__aRequestData.filter&&this.__aRequestData.filter.until)){var aFilter=this.__aRequestData.filter?clone(this.__aRequestData.filter,true):{};delete aFilter.until;delete this.__aRequestData.filter;this._serverSort(this.__aRequestData.folder,true,aFilter);}
else
this._scroll(0);}.bind(this);};_me._search=function(s){if(Is.Defined(s)){var aFilter=this.__aRequestData.filter?clone(this.__aRequestData.filter,true):{};aFilter.search=s;this._serverSort(this.__aRequestData.folder,true,aFilter);}
else
if(this.__aRequestData.filter)
return this.__aRequestData.filter.search;else
return'';};_me._serverSort=function(aFolder,bUpdate,aFilter){if(((!aFolder&&this.__aRequestData.folder)||compareObj(this.__aRequestData.folder,aFolder,true))&&(!Is.Object(aFilter)||(Is.Object(this.__aRequestData.filter)&&!this.__aRequestData.filter.until&&compareObj(this.__aRequestData.filter,aFilter,true)))){if(this.__aRequestData.fetchnew)
return;this.__aRequestData.fetchnew=true;}
else{if(!this.__pinned)
this._clear();if(currentBrowser().indexOf('MSIE')==0||(aFilter&&aFilter.until))
this.__body.style.visibility='hidden';else
this.__body.style.visibility='visible';this.__aRequestData.folder=aFolder;this.__aRequestData.filter=aFilter;this.__options.autoscroll=true;this.__loading=0;}
this._fetch(this.__aRequestData.uniq*1);};_me._request=function(uid){if(this.__aRequestData.folder){this.__loading=1;addcss(this._main,'loading');var aFilter={sort:'EVN_ID desc',limit:this.__options.preload,search:'gchat:main',reset_unread:1},bScroll=false;if(this.__aRequestData.oldest)
aFilter.search+=' and beforeid:'+this.__aRequestData.oldest;else
if(this.__aRequestData.filter&&this.__aRequestData.filter.until){aFilter.search+=' and untilid:'+WMItems.__serverID(this.__aRequestData.filter.until)+' and next:'+this.__options.preload;if(!this.__aRequestData.fetchnew)
this.__aRequestData.fetchnew=true;}
if(this.__aRequestData.filter&&this.__aRequestData.filter.sys_search)
aFilter.search+=' and ('+this.__aRequestData.filter.sys_search+')';if(this.__aRequestData.filter&&this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';if(!this.__aRequestData.oldest)
bScroll=true;var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:this.__aRequestArray,filter:aFilter};WMItems.list(aItemsInfo,'','','',[function(aData){this._response(aData,false,bScroll,false,false,uid)}.bind(this)]);}};_me._request2=function(uid){if(this.__aRequestData.folder){this.__loading=this.__loading||1;var aFilter={sort:'EVN_ID asc',limit:this.__options.preload,search:'gchat:main',reset_unread:1};if(this.__aRequestData.youngest)
aFilter.search+=' and afterid:'+this.__aRequestData.youngest;if(this.__aRequestData.filter&&this.__aRequestData.filter.sys_search)
aFilter.search+=' and ('+this.__aRequestData.filter.sys_search+')';if(this.__aRequestData.filter&&this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';var bScroll=true;if(this.__aRequestData.filter&&this.__aRequestData.filter.until){bScroll=false;}
var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:this.__aRequestArray,filter:aFilter};this.__aRequestData.fetchnew=false;WMItems.list(aItemsInfo,'','','',[function(aData){this._response(aData,true,bScroll,false,false,uid)}.bind(this)]);}};_me._response=function(aData,bUpdate,bScroll,bSkipTime,bPinned,uid){if(this._destructed||(uid&&uid!=this.__aRequestData.uniq))
return;if(this._main)
removecss(this._main,'loading');if(aData===false){if(this._onerror)
this._onerror();return;}
if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData[this.__aRequestData.folder.fid])){var bScrollDown=false,scroll=false,rowUpdate=bUpdate?obj_list_load.prototype._row.bind(this):false;if(bScroll){var elm,n=this.__body.childNodes;if(n.length&&(elm=n[n.length-1])){if(elm.offsetTop<this.__body.scrollTop+this.__body.clientHeight)
bScrollDown=true;else
if(this.__body.scrollTop+this.__body.scrollHeight==this.__body.clientHeight)
bScrollDown=true;}
else
bScrollDown=true;}
else
if(!bUpdate)
scroll=[this.__body.scrollTop,this.__body.scrollHeight];if(this._onresponse)
this._onresponse(this.__aRequestData.folder,aData['@']);delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,last,d,linkextras;var last_read_id=parseInt(Folder.lastId(this.__aRequestData.folder),16),last_message_id=0;if(this.__aRequestData.filter&&this.__aRequestData.filter.until==='*0'){this.__aRequestData.filter.until=Object.keys(aData).sort().shift();}
else{var bNext=this.__aRequestData.filter&&this.__aRequestData.filter.until&&!this.__aRequestData.filter.highlight&&parseInt(WMItems.__serverID(this.__aRequestData.filter.until),16)===last_read_id,tmp_id,evnid;for(var iid in aData){evnid=parseInt(aData[iid].EVN_ID,16);last_message_id=Math.max(last_message_id,evnid);if(bNext){if(evnid<=last_read_id){if(tmp_id)this.__aRequestData.filter.until=WMItems.__clientID(tmp_id||aData[iid].EVN_ID);bNext=false;}
tmp_id=aData[iid].EVN_ID;}}}
if(last_message_id>last_read_id){Folder.lastId(this.__aRequestData.folder,last_message_id.toString(16));}
for(var iid in aData){c++;if(this.__aData[iid]){if(this.__aData[iid].obj&&this.__aData[iid].obj._type=="obj_groupchat_message"&&!this.__aData[iid].obj.__src){if(aData[iid].EVNTHUMBNAILTICKET)
this.__aData[iid].obj._preview_image(aData[iid].EVNTHUMBNAILTICKET,aData[iid].EVNSIZEINFO);else
if(aData[iid].EVNTHUMBNAILID){var src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aData[iid].aid,aData[iid].fid,WMItems.__serverID(aData[iid].EVN_ID),aData[iid].EVNTHUMBNAILID].join('/'),'t':aData[iid].EVNTHUMBNAILTIME||0});this.__aData[iid].obj._preview_image(src,aData[iid].EVNSIZEINFO);}}
continue;}
aData[iid].EVN_CREATED=parseInt(aData[iid].EVN_CREATED);if(!aData[iid].iid)aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};linkextras=aData[iid].EVNLINKEXTRAS?parseURL(aData[iid].EVNLINKEXTRAS):{};if(linkextras.EvnLinkInvalid!='1'){d=IcewarpDate.unix(aData[iid].EVN_CREATED);var sep=CalendarFormatting.normal(d),bToday=d.isToday();if(!bUpdate&&last_read_id>0&&last_message_id>last_read_id&&last_read_id>=parseInt(aData[iid].EVN_ID,16)){this._separator('<span>'+getLang('CHAT::NEW_SEPARATOR')+'</span>','today unread'+(bPinned?' pinned':''));last_read_id=0;}
if(bUpdate){if(this.__sep2.sep!=sep){this.__sep2={sep:sep,today:bToday};obj_list_load.prototype._separator.call(this,'<span>'+this.__sep2.sep+'</span>',(this.__sep2.today?'today':'')+(bPinned?' pinned':''));}}
else
if(this.__sep1.sep!=sep){if(this.__sep1.sep)
this._separator('<span>'+this.__sep1.sep+'</span>',(this.__sep1.today?'today':'')+(bPinned?' pinned':''));this.__sep1={sep:sep,today:bToday};if(!this.__sep2.sep)
this.__sep2={sep:sep,today:bToday};}
var row=false,bGroup=false;if(!bUpdate){if(this.__sep1.row)
if(aData[iid].EVNCOMEVNID){if(aData[iid].EVNCOMEVNID==this.__sep1.row.com){addcss(this.__sep1.row.elm,'group');if(!(this.__sep1.row.group&&this.__sep1.row.email==aData[iid].EVNMODIFIEDOWNEREMAIL&&this.__sep1.row.email2==linkextras.AccountEmail&&this.__sep1.row.time<aData[iid].EVN_CREATED+300))
addcss(this.__sep1.row.elm,'nogroup');}}
else
if(this.__sep1.row.com){if(this.__sep1.row.com==aData[iid].EVN_ID)
addcss(this.__sep1.row.elm,'group','nogroup');}
else
if(this.__sep1.row.group&&this.__sep1.row.email==aData[iid].EVNMODIFIEDOWNEREMAIL&&this.__sep1.row.email2==linkextras.AccountEmail&&this.__sep1.row.time<aData[iid].EVN_CREATED+300)
addcss(this.__sep1.row.elm,'group');}
switch(aData[iid].EVNCLASS){case'I':if(aData[iid].EVNNOTE&&aData[iid].EVNNOTE.indexOf('/')===0)
continue;if(bUpdate){if(rowUpdate)
row=rowUpdate('',bToday?'today':'',iid);if(this.__sep2.row)
if(aData[iid].EVNCOMEVNID){if(this.__sep2.row.com==aData[iid].EVNCOMEVNID){addcss(row.elm,'group');if(!(this.__sep2.row.group&&this.__sep2.row.email==aData[iid].EVNMODIFIEDOWNEREMAIL&&this.__sep2.row.email2==linkextras.AccountEmail&&this.__sep2.row.time<aData[iid].EVN_CREATED+300))
addcss(row.elm,'nogroup');}
else
if(this.__sep2.row.id==aData[iid].EVNCOMEVNID)
addcss(row.elm,'group','nogroup');}
else
if(!this.__sep2.row.com&&this.__sep2.row.group&&this.__sep2.row.email==aData[iid].EVNMODIFIEDOWNEREMAIL&&this.__sep2.row.email2==linkextras.AccountEmail&&this.__sep2.row.time>aData[iid].EVN_CREATED-300)
addcss(row.elm,'group');}
else
row=this._row('',bToday?'today':'',iid);try{this.__aData[iid].obj=this._create('mssg','obj_groupchat_message',row.anchor,'',aData[iid]);}
catch(r){if(this.__aData[iid]&&(!this.__aData[iid].obj||!this.__aData[iid].obj._destructed))
throw r;return;}
bGroup=this.__aData[iid].obj._cangroup;break;case'R':case'Z':case'B':case'Q':case'S':case'W':case'D':case'Y':try{if(bUpdate){if(rowUpdate)
row=rowUpdate('',bToday?'today':'',iid);}
else
row=this._row('',bToday?'today':'',iid);if(aData[iid].EVNLINKTYPE==10){this.__aData[iid].obj=this._create('pin','obj_groupchat_pin',row.anchor,'',aData[iid]);if(aData[iid].EVNLINKEXTRAS){if(linkextras&&linkextras.evnlinkid){var cid=WMItems.__clientID(linkextras.evnlinkid);if(cid!=iid)
if(this.__aDataLink[cid]){if(inArray(this.__aDataLink[cid],iid)<0)
this.__aDataLink[cid].push(iid);}
else
this.__aDataLink[cid]=[iid];}}}
else
switch(aData[iid].EVNCLASS){case'R':case'Z':this.__aData[iid].obj=this._create('file','obj_groupchat_file',row.anchor,'',aData[iid]);break;case'Q':this.__aData[iid].obj=this._create('event','obj_groupchat_event',row.anchor,'',aData[iid]);break;case'S':this.__aData[iid].obj=this._create('conference','obj_groupchat_conference',row.anchor,'',aData[iid]);break;case'W':this.__aData[iid].obj=this._create('invite','obj_groupchat_invite',row.anchor,'',aData[iid]);break;case'Y':this.__aData[iid].obj=this._create('message','obj_groupchat_mail',row.anchor,'',aData[iid]);break;}}
catch(r){if(this.__aData[iid]&&(!this.__aData[iid].obj||!this.__aData[iid].obj._destructed))
throw r;return;}
if(aData[iid].EVNLINKID){var cid=WMItems.__clientID(aData[iid].EVNLINKID);if(cid!=iid)
if(this.__aDataLink[cid]){if(inArray(this.__aDataLink[cid],iid)<0)
this.__aDataLink[cid].push(iid);}
else
this.__aDataLink[cid]=[iid];}}
if(row){if(bPinned){this.__pinned=row.elm;addcss(this.__pinned,'pinned');}
if(this.__options.comments&&aData[iid].EVNCOMEVNID){var cid=WMItems.__clientID(aData[iid].EVNCOMEVNID);if(this.__aDataLink[cid]){if(inArray(this.__aDataLink[cid],iid)<0)
this.__aDataLink[cid].push(iid);}
else
this.__aDataLink[cid]=[iid];}
this.__aData[iid].anchor=row.anchor;if(this.__aRequestData.filter&&this.__aRequestData.filter.until==iid&&this.__aData[iid].obj)
if(this.__aRequestData.filter.highlight){var box=this._getAnchor(row.anchor),func=function(e){e.target&&removecss(e.target,'selected');};box.addEventListener('animationend',func);box.addEventListener('webkitAnimationEnd',func);addcss(box,'selected');}
if(bUpdate)
this.__sep2.row={elm:row.elm,email:aData[iid].EVNMODIFIEDOWNEREMAIL,email2:linkextras.AccountEmail,time:aData[iid].EVN_CREATED,group:bGroup,com:aData[iid].EVNCOMEVNID,id:aData[iid].EVN_ID};else{this.__sep1.row={elm:row.elm,email:aData[iid].EVNMODIFIEDOWNEREMAIL,email2:linkextras.AccountEmail,time:aData[iid].EVN_CREATED,group:bGroup,com:aData[iid].EVNCOMEVNID,id:aData[iid].EVN_ID};if(!this.__sep2.row)
this.__sep2.row=clone(this.__sep1.row);}
last=row;}
if(this.__options.autoscroll){if(bScrollDown)
this._scroll(0);else
if(scroll)
this.__body.scrollTop=scroll[0]+this.__body.scrollHeight-scroll[1];}}
if(!bSkipTime){var real_id=WMItems.__serverID(iid);if(!this.__aRequestData.oldest||this.__aRequestData.oldest>real_id)
this.__aRequestData.oldest=real_id;if(!this.__aRequestData.youngest||this.__aRequestData.youngest<real_id){if(this.__options.comments==false||(gui.frm_main.main.tabs.room&&gui.frm_main.main.tabs.room._isActive)){this.__aRequestData.youngest=real_id;}}}}
if(!bSkipTime)
this.__loading=(bUpdate||c>=this.__options.preload)?0:2;if(!bUpdate){if(this.__anim_last&&this.__anim_last.parentNode)
this.__anim_last.parentNode.removeChild(this.__anim_last);if(this.__sep1.sep){this.__anim_last=this._separator('<span>'+this.__sep1.sep+'</span>',(this.__sep1.today?'today':'')+(bPinned?' pinned':''),true).elm;addcss(this.__anim_last,'last');if(this.__anim)
this.__anim_last.style.top=this.__anim.style.top;this._main.appendChild(this.__anim_last);}}
if(this.__sep1.sep&&!this.__anim&&last&&this.__sep1.elm!==last.elm){this.__anim=this._separator('<span>'+this.__sep1.sep+'</span>',(this.__sep1.today?'today':'')+(bPinned?' pinned':''),true).elm;this._main.appendChild(this.__anim);}}
else
if(!aData){this._clear(true);return;}
if(currentBrowser().indexOf('MSIE')==0&&this.__body.style.visibility=='hidden'&&(!this.__aRequestData.filter||!this.__aRequestData.filter.until))
this.__body.style.visibility='visible';if(bUpdate){if(c>=this.__options.preload)
this.__aRequestData.fetchnew=true;if(!bScroll&&!bPinned){if(this.__aRequestData.filter&&this.__aRequestData.filter.until){var tmp=this.__aData[this.__aRequestData.filter.until];if(tmp&&tmp.anchor&&(tmp=this._getAnchor(tmp.anchor))){if(tmp.offsetHeight>this.__body.clientHeight)
this.__body.scrollTop=tmp.offsetTop+30;else
this.__body.scrollTop=tmp.offsetTop-this.__body.clientHeight/2+tmp.offsetHeight/2;}
addcss(this._main,'scrollbtn');delete this.__aRequestData.filter.until;delete this.__aRequestData.filter.highlight;if(this.__body.style.visibility=='hidden')
this.__body.style.visibility='visible';}}}
var bRemoveNew=bUpdate;if(!bPinned&&(!bUpdate||this.__aRequestData.fetchnew))
bRemoveNew=!this._fetch(uid);if(bRemoveNew&&this._scroll()<10){removecss(this._main,'newitem','scrollbtn');this._getAnchor('refresh').innerHTML=getLang('COMMON::SCROLL_DN');this.__newitems=0;}};_me._add_message=function(arg,bForce){if(arg.id){if(!bForce&&this.__aRequestData.filter){this._serverSort();return;}
var aData=mkArrayPath([this.__aRequestData.folder.aid,this.__aRequestData.folder.fid,arg.id]),tmp=aData[this.__aRequestData.folder.aid][this.__aRequestData.folder.fid][arg.id];tmp.aid=this.__aRequestData.folder.aid;tmp.fid=this.__aRequestData.folder.fid;tmp.EVNCLASS='I';tmp.EVN_ID=WMItems.__serverID(arg.id);tmp.EVN_CREATED=arg.timestamp||(new IcewarpDate()).unix();tmp.EVNOWNEREMAIL=sPrimaryAccount;tmp.EVNMODIFIEDOWNEREMAIL=sPrimaryAccount;tmp.EVNMODIFIEDOWNERNAME=dataSet.get('main',['fullname']);tmp.EVNNOTE=arg.body;if(arg.contact_email){tmp.EVNSHARETYPE=arg.share;tmp.EVNLINKEXTRAS=buildURL({AccountEmail:arg.contact_email,AccountName:arg.contact_name});}
if(arg.url)
tmp.EVNURL=arg.url;if(arg.desc)
tmp.EVNLOCATION=arg.desc;if(arg.title)
tmp.EVNTITLE=arg.title;if(arg.type==2)
tmp.CORE_LINKINFO=arg;if(arg.comevnid)
tmp.EVNCOMEVNID=arg.comevnid;if(arg.mentions){if(!tmp.MENTIONS)
tmp.MENTIONS={};for(var email in arg.mentions)
tmp.MENTIONS[unique_id()]={values:{EMAIL:email,NAME:arg.mentions[email]}};}
this._response(aData,true,true,true);if(this.__options.autoscroll)
this.__body.scrollTop=this.__body.scrollHeight;}};_me._onnotify=function(aData){console.log(this._pathName+'._onnotify',aData);var cid=WMItems.__clientID(aData.ITEM),arr=[cid];if(Is.Array(this.__aDataLink[cid]))
arr=arr.concat(this.__aDataLink[cid]);if(aData['ITEM-TYPE']=='-'){if(aData.TYPE=='gw-queue'){if(aData.ACTION=='add')
aData.ACTION='update_preview';}
else
if(aData.ACTION==='add'&&aData.TYPE==='gw-queue-failure'){}
else
switch(aData.ACTION){case'lock':case'unlock':case'comment':break;default:return;}}
for(var iid,i=0;i<arr.length;i++){iid=arr[i];switch(aData.ACTION){case'stop':if(this.__aData[iid]&&this.__aData[iid].obj)
this.__aData[iid].obj._data(cid,'','__stop');break;case'reaction':case'reaction-deleted':if(this.__aData[iid]&&this.__aData[iid].obj){if(Is.Defined(aData.BODY)){if(aData.ACTION=='reaction-deleted'&&aData.BODY=='')
return;var aOut;aOut={NOTIFY_REACTIONS:aData.BODY,ACTION:aData.ACTION};if(!(aData.SERVICE&&(aData['ORIGINATOR-EMAIL']==sPrimaryAccount||aData['ORIGINATOR-EMAIL']==dataSet.get('main',['user'])))){if(Is.Defined(aData.REAVALUE))
aOut.REAVALUE=aData.REAVALUE;this.__aData[iid].obj._data(cid,'','_init_reactions',[aOut]);break;}}}
else
break;case'update_preview':if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update){this.__aData[iid].obj._data(cid,'','__update_preview',[true]);}
break;case'lock':case'unlock':case'update':if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update){this.__aData[iid].obj._data(cid,'','__update',[true]);}
break;case'add':if(!this.__aData[iid]&&inArray(['E','M'],aData['ITEM-TYPE'])<0){var bActive=this._parent._isActive!==false;if((aData.SERVICE&&this._scroll()>0)||!bActive){this.__newitems++;this._getAnchor('refresh').innerHTML=getLang(this.__newitems>1?'CHAT::NEW_MSGS':'CHAT::NEW_MSG',[this.__newitems]);addcss(this._main,'newitem');}
if(bActive)
this._serverSort();}
break;case'delete':if(this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);break;case"add_pin":if(this.__aData[iid]&&this.__aData[iid].obj)
this.__aData[iid].obj._data(cid,{LPINWHEN:true},'_init_reactions');break;case"add_global_pin":if(!aData.SERVICE&&aData.LAST_PINNED_ITEM&&parseInt(Cookie.get(['folders',this.__aRequestData.folder.aid,this.__aRequestData.folder.fid,'gpin'])||0)<parseInt(aData.LAST_PINNED_ITEM||0)){Cookie.set(['folders',this.__aRequestData.folder.aid,this.__aRequestData.folder.fid,'gpin'],aData.LAST_PINNED_ITEM);}
if(this.__aData[iid]&&this.__aData[iid].obj){var aOut={GPINWHEN:true};if(!aData.SERVICE)
aOut.PINOWNEMAIL=sPrimaryAccount;this.__aData[iid].obj._data(cid,aOut,'_init_reactions');}
if(!aData.SERVICE)
this._serverSort();break;case"delete_pin":if(this.__aData[iid]&&this.__aData[iid].obj){this.__aData[iid].obj._data(cid,{LPINWHEN:false},'_init_reactions');}
break;case"delete_global_pin":if(this.__aData[iid]&&this.__aData[iid].obj){this.__aData[iid].obj._data(cid,{GPINWHEN:false,PINOWNEMAIL:''},'_init_reactions');}
break;case"comment":if(this.__aData[iid]&&this.__aData[iid].obj){if(Is.Defined(aData.BODY))
this.__aData[iid].obj._data(cid,{META_COMMENTS:{count:aData.BODY}},'_init_reactions');}
break;}}};_me._onremove=function(iAnchor,sData_id,bFire){if(bFire)
this._fire(sData_id,'delete');if(this.__aDataLink&&this.__aDataLink[sData_id])
delete this.__aDataLink[sData_id];if(this.__aData&&this.__aData[sData_id])
delete this.__aData[sData_id];};_me._edit=function(id){if(this.__aData[id]&&this.__aData[id].obj&&!this.__aData[id].obj._destructed&&this.__aData[id].obj._edit){return this.__aData[id].obj._edit(true);}
return false;};_me._ungroupNode=function(prev,elm){var id;if((id=elm.getAttribute('rel'))&&this.__aData[id]&&this.__aData[id].obj&&this.__aData[id].obj._ungroup){var bForce=!prev||(!hascss(prev,'group')&&this.__aData[id].obj.__aData.EVNCOMEVNID);this.__aData[id].obj._ungroup(bForce);}
else
removecss(elm,'group');};

/* client/inc/obj_groupchat_conference.js */
_me=obj_groupchat_conference.prototype;function obj_groupchat_conference(){};_me.__constructor=function(){var linkextras={};if(this.__aData.EVNLINKEXTRAS)
linkextras=parseURL(this.__aData.EVNLINKEXTRAS);this._draw('obj_groupchat_conference','addon');if(linkextras.started=='1'&&linkextras.id){this.btn_accept._onclick=function(){storage.library('wm_conference');wm_conference.get(linkextras.id).join();};this.btn_decline._onclick=function(){gui.frm_main.main._message(getLang('CHAT::CONFERENCE_DECLINE_MSSG'));};this.btn_accept._disabled(false);this.btn_decline._disabled(false);}};_me.__stop=function(){this.btn_accept._disabled(true);this.btn_decline._disabled(true);};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVN_CREATED','EVN_MODIFIED']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){this._init_reactions(aData);}}.bind(this)]);};

/* client/inc/obj_groupchat_event.js */
_me=obj_groupchat_event.prototype;function obj_groupchat_event(){};_me.__constructor=function(){this.__fill(this.__aData);};_me.__fill=function(aData){if(this.btn_accept)
this._clean(this.btn_accept._anchor);var aTmp={},linkextras={};if(aData.EVNLINKEXTRAS){linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras){if(linkextras.EvnLinkInvalid=='1'){this._parent._remove(this._anchor,this.__aData.iid);return;}
aTmp.title=linkextras.EvnTitle||'';aTmp.location=linkextras.EvnLocation;aTmp.conference=parseURL(linkextras.meeting_info||'').id;var a=new IcewarpDate(linkextras.EvnStartDate,{format:IcewarpDate.JULIAN});if(linkextras.EvnStartTime>=0){a.setTime(linkextras.EvnStartTime,true);aTmp.date=a.format('dddd, L LT');}
else{aTmp.date=a.format('dddd, L');}}}
this._draw('obj_groupchat_event','addon',aTmp);if(linkextras.EvnMyStatus=='A'){this.btn_accept._value('ATTENDEES::STATUS_A');removecss(this.btn_accept._main,'select');}
else
if(linkextras.EvnMyStatus=='D'){this.btn_accept._value('ATTENDEES::STATUS_D');removecss(this.btn_accept._main,'select');}
else{var me=this;this.btn_accept._disabled(sPrimaryAccountGUEST===1);this.btn_accept._onclick=function(e){if(!this.cmenu||this.cmenu._destructed){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();var pos=getSize(this._main);this.cmenu=gui._create('cmenu','obj_context');this.cmenu._fill([{title:'FORM_BUTTONS::ACCEPT',arg:[me,'_action',['accept']]},{title:'FORM_BUTTONS::DECLINE',arg:[me,'_action',['decline']]}]);this.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);return false;}};}
if(aTmp.conference){this.btn_join._onclick=function(){storage.library('wm_conference');wm_conference.get(aTmp.conference).join();}}
if(parseInt(linkextras.EvnAcceptedParticipantCount)>0){this.attendees._value(getLang('IM::PARTICIPANTS',[linkextras.EvnAcceptedParticipantCount]));this.attendees._disabled(false);}
this.btn_info._onclick=function(){Item.openwindow([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID)],'','','E',[this,'__update']);}.bind(this);this._getAnchor('preview').onclick=function(e){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();this.btn_info._onclick();return false;}.bind(this);};_me._action=function(name){this.btn_accept&&this.btn_accept._disabled(true);var aItem={aid:this.__aData.aid,fid:this.__aData.fid,iid:WMItems.__clientID(this.__aData.EVNLINKID)};switch(name){case'decline':var frm=gui._create('decline','frm_text','','frm_ok_cancel',[function(s){aItem.reason=s;WMItems.imip(aItem,name,[]);}.bind(this)],'EVENT::REASON');frm._onclose=function(){if(this.btn_accept)
this.btn_accept._disabled(false);}.bind(this);frm.x_btn_ok._value('FORM_BUTTONS::DECLINE');break;case'accept':WMItems.imip(aItem,name,[]);}};_me.__update=function(bOK){if(bOK==true&&!this._destructed){WMItems.list({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid},'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){this.__fill(aData);if(aData.EVN_METADATA){var meta=parseURL(aData.EVN_METADATA);aData.META_REACTIONS=meta.core_reactions_data?parseURL(meta.core_reactions_data):{};}
else
if(aData.EVNLINKEXTRAS){var linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras.Evn_MetaData){this.__aData.REAVALUE=linkextras.ReaValue||'';var meta=parseURL(linkextras.Evn_MetaData);aData.REACTIONS=meta.core_reactions_data?parseURL(meta.core_reactions_data):{};}}
this._init_reactions(aData);}
else
this._parent._remove(this._anchor,this.__aData.iid);}.bind(this)]);}};

/* client/inc/obj_groupchat_file.js */
_me=obj_groupchat_file.prototype;function obj_groupchat_file(){};_me.__constructor=function(){var me=this,aData=this.__aData,aTmp={},linkextras={};this._main.setAttribute('evnclass',aData.EVNCLASS);if(aData.EVNLINKEXTRAS){linkextras=parseURL(aData.EVNLINKEXTRAS);var ico;if(aData.EVNCLASS==='R'&&aData.EVNLINKTYPE==9){ico='conference-record';}
else{ico=Path.extension(linkextras.EvnTitle);}
if(linkextras.EvnTicket){aTmp.size=parseFileSize(linkextras.EvnComplete);aTmp.filename=linkextras.EvnTitle;aTmp.preview=linkextras.EvnThumbnailId?'':'ico ico_none ico_'+ico;linkextras.EvnLocation=encodeURIComponent(linkextras.EvnLocation).replace(/!/g,'%21').replace(/'/g,'%27').replace(/\(/g,'%28').replace(/\)/g,'%29').replace(/\*/g,'%2A');if(aData.EVNCLASS=='Z'){var ticketUrl=parseURL(linkextras.EvnTicket.split('#').pop());aTmp.url=document.location.origin+'/teamchatapi/files.download?'+buildURL({ticket:ticketUrl.ticket});aTmp.filename=aData.EVNTITLE;}
else{aTmp.menubutton=true;aTmp.url=linkextras.EvnTicket;}
if(Item.imageSupport(aTmp.filename)){this._fileinfo={title:aTmp.filename,evn_id:aData.EVN_ID};if(aData.EVNCLASS=='Z'){this._fileinfo.url=aTmp.url;}
else{var ratio=window.retina||window.devicePixelRatio||1;if(linkextras.EvnComplete>10485760)
this._fileinfo.url='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'file_attachment','fullpath':aData.aid+'/'+aData.fid+'/'+aData.EVNLINKID,'resize':1,'width':window.screen.availWidth*ratio,'height':window.screen.availHeight*ratio});else
this._fileinfo.url='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'file_attachment','fullpath':aData.aid+'/'+aData.fid+'/'+aData.EVNLINKID});}}}
this.__dimensions(linkextras);}
switch(Path.extension(aTmp.filename)){case'mp3':aTmp.play=true;break;case'wav':aTmp.play=!(window.ActiveXObject||"ActiveXObject"in window)&&!/^((?!chrome|android).)*safari/i.test(navigator.userAgent);break;}
aTmp.shareable=!sPrimaryAccountGUEST&&aData.EVNCLASS!=='Z';this._draw('obj_groupchat_file','addon',aTmp);this._getAnchor('fname').onclick=function(e){var e=e||window.event,iid=WMItems.__clientID(aData.EVNLINKID);if(Path.extension(aTmp.filename)=='pdf'&&GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')!=1&&!currentBrowser().match(/^MSIE([6-9]|10)$/))
gui._create('pdf','frm_pdf')._load(aTmp.url,aTmp.filename);else
if(Item.imageSupport(aTmp.filename)){var arr=[me._fileinfo],tmp={};(me.__list._getChildObjects('','obj_groupchat_file')||[]).forEach(function(obj){if(obj._fileinfo&&obj._fileinfo.evn_id&&obj._fileinfo.evn_id!==me.__aData.EVN_ID&&!tmp[obj._fileinfo.url]){arr.push(obj._fileinfo);tmp[obj._fileinfo.url]=true;}});arr.sort(function(a,b){if(a.evn_id<b.evn_id)
return-1;if(a.evn_id>b.evn_id)
return 1;return 0;});var value=0;for(var i=0,l=arr.length;i<l;i++)
if(arr[i].evn_id===me.__aData.EVN_ID){value=i;break;}
var img=gui._create('imgview','frm_imgview');img._fill(arr);img._value(value);}
else
if(Item.editSupport(aTmp.filename))
if(aData.EVNCLASS==='Z'){getRemoteFileContent(aTmp.url,function(content){gui._create('text','frm_editor')._loadContent(aTmp.filename,content);});}else{Item.editFile([aData.aid,aData.fid,iid]);}
else
if(Item.officeSupport(aTmp.filename)){var data=clone(aData);if(aData.EVNCLASS=='Z'){data.ticket=ticketUrl.ticket;Item.officeOpen(data,[downloadItem,[aTmp.url,true]],Path.extension(aTmp.filename));}
else{data.iid=iid;Item.officeOpen(data,[Item.downloadFile,[[aData.aid,aData.fid,iid]]],Path.extension(aTmp.filename));}}
else
if(aTmp.url){downloadItem(aTmp.url,true);}
e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;};this._getAnchor('preview').onclick=function(e){var e=e||window.event;me._getAnchor('fname').onclick();e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;};this.download._onclick=function(){if(aTmp.url)
downloadItem(aTmp.url,true);};if(aTmp.menubutton){this.download._menu(function(){var arr=[{title:'ATTACHMENT::DOWNLOAD',arg:[function(){me.download._onclick();}]}];if(!sPrimaryAccountGUEST&&!(TeamChatAPI&&TeamChatAPI.teamChatOnly()))
arr.push({title:'ATTACHMENT::SAVE_TO_FOLDER',arg:[function(){gui._create('select_folder','frm_select_folder','','','POPUP_FOLDERS::SELECT_FOLDER',sPrimaryAccount,Mapping.getDefaultFolderForGWType('F'),[me,'_saveFolder'],true,false,'F','i',true);}]});return arr;},'groupchat_file_menu');}
if(this.share){this.share._onclick=function(){me._share(aData);};}
this._getAnchor('close').onclick=function(e){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();me._share(false);return false;};this.url._readonly(true);this.url._value(aTmp.url);this.url._onclick=this.url._onfocus=function(){this._select();};this.email._single=true;this.email._onchange=function(){me.send._disabled(!this._value().trim().length);};this.email._onclose=function(){if(this._value().length==0)
me._share(false);};this.email._onsubmit=function(){me.send._onclick();};this.send._onclick=function(){var email=MailAddress.splitEmailsAndNames(me.email._value());if(!this._disabled()&&email&&(email=email[0])&&(email=email.email)){me.email._disabled(true);this._disabled(true);WMItems.action({aid:aData.aid,fid:aData.fid,iid:aData.EVNLINKID,values:{EMAIL:email}},'notify_groupchat',[function(bOK){if(bOK){me._share(false);me.email._value('');gui.notifier._value({type:'message_sent'});}
me.email._disabled(false);me.send._disabled(false);if(!bOK){me.email._select();}}]);}};if(linkextras.EvnThumbnailTicket){this.__dimensions(linkextras);this._preview_image(linkextras.EvnThumbnailTicket+'&'+buildURL({'resize':1,'width':150,'height':600}));}
else
if(linkextras.EvnThumbnailId){var src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aData.aid,aData.fid,aData.EVNLINKID,linkextras.EvnThumbnailId].join('/'),'resize':1,'width':150,'height':600,'t':linkextras.EvnThumbnailTime});this.__dimensions(linkextras);this._preview_image(src);}
else
if(linkextras.EvnProcessingQueued=='0'&&linkextras.EvnTicket&&Item.imageSupport(linkextras.EvnTitle)){this.__dimensions(linkextras);this._preview_image(linkextras.EvnTicket);}
if(!gui.socket&&linkextras.EvnProcessingQueued==1){this.__timeout=setTimeout(function(){me.__update();},5000);}
this._add_destructor('__destructor');};_me.__dimensions=function(linkextras){if(linkextras.EvnSizeInfo){var tmp=parseURL(linkextras.EvnSizeInfo);if(tmp.tw>0){this.__aData.dim={w:tmp.tw,h:tmp.th};return;}
else
if(tmp.ow>0){if(tmp.o>4)
this.__aData.dim={w:tmp.oh,h:tmp.ow};else
this.__aData.dim={w:tmp.ow,h:tmp.oh};return;}}
delete this.__aData.dim;};_me._share=function(aData){Item.collaborate([aData.aid,aData.fid,[WMItems.__clientID(aData.EVNLINKID)]]);};_me.__update_preview=function(){this.__update();};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVNNOTE','EVN_CREATED','EVN_MODIFIED','EVNLINKEXTRAS']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])&&aData.EVNLINKEXTRAS){if(this.__timeout){clearTimeout(this.__timeout);delete this.__timeout;}
var linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras){if(linkextras.EvnProcessingQueued=='0'){var src;if(linkextras.EvnThumbnailTicket)
src=linkextras.EvnThumbnailTicket+'&'+buildURL({'resize':1,'width':150,'height':600,'t':linkextras.EvnThumbnailTime});else
if(linkextras.EvnThumbnailId)
src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[this.__aData.aid,this.__aData.fid,this.__aData.EVNLINKID,linkextras.EvnThumbnailId].join('/'),'resize':1,'width':150,'height':600,'t':linkextras.EvnThumbnailTime});this.__dimensions(linkextras);this._preview_image(src);}
else{this.__timeout=setTimeout(this.__update.bind(this),5000);}
if(!aData.REACTIONS&&linkextras.Evn_MetaData){this.__aData.REAVALUE=linkextras.ReaValue||'';var meta=parseURL(linkextras.Evn_MetaData);aData.REACTIONS=meta.core_reactions_data?parseURL(meta.core_reactions_data):{};}}
this.__aData.EVNLINKEXTRAS=aData.EVNLINKEXTRAS;if(this.__aData.EVNNOTE!=aData.EVNNOTE)
this._init_body(aData);this._init_reactions(aData);}}.bind(this)]);};_me._preview_image=function(src){if(!this._destructed&&src&&this._getAnchor('preview')){var img=new Image();img.onload=function(e){try{if(!this._destructed){var ePrev=this._getAnchor('preview'),bScroll=false,bSafari=false,h=this._main.offsetHeight;if(this.__list&&this.__list._scroll){var pos1=getSize(this.__list.__body),pos2=getSize(this._main);bScroll=pos1.y+pos1.h>=pos2.y+pos2.h;if(bScroll)
bSafari=window.navigator&&window.navigator.browser&&window.navigator.browser.application&&window.navigator.browser.application.toLowerCase()=='safari';}
removecss(ePrev,'ico','convert');if(this.__aData.dim){ePrev.firstElementChild.style.height=Math.round(this.__aData.dim.h/(this.__aData.dim.w/150))+'px';if(bScroll)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-h));}
if(!this.__preview){this.__preview=mkElement('img');ePrev.firstElementChild.appendChild(this.__preview);}
if(img.naturalHeight&&img.naturalWidth){this.__preview.style.maxHeight=img.naturalHeight+'px';this.__preview.style.maxWidth=img.naturalWidth+'px';}
if(bScroll&&bSafari)
this.__preview.onload=function(){try{if(!this._destructed){ePrev.firstElementChild.style.height='auto';if(this._main.offsetHeight-h!=0)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-h));}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);this.__preview.src=img.src;if(!bSafari){ePrev.firstElementChild.style.height='auto';if(bScroll&&this._main.offsetHeight-h!=0)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-h));}}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);img.src=src;}};_me._saveFolder=function(aid,fid){var extras=parseURL(this.__aData.EVNLINKEXTRAS),now=new IcewarpDate(),att=[{values:{'class':'file_attachment','description':extras.EvnLocation,'size':extras.EvnComplete,'fullpath':this.__aData.aid+'/'+this.__aData.fid+'/'+this.__aData.EVNLINKID}}];WMItems.add([aid,fid],{values:{'EVNSHARETYPE':GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','file_sharing'),'EVNSTARTDATE':now.format(IcewarpDate.JULIAN),'EVNSTARTTIME':now.format(IcewarpDate.JULIAN_TIME)},ATTACHMENTS:att},'','','',[function(bOK,result){if(bOK&&result&&result.id){if(gui.notifier)
gui.notifier._value({type:'item_saved',args:[aid,fid]});var aItems=dataSet.get('items');for(var sAccId in aItems)
for(var sFolId in aItems[sAccId])
break;if(aid==sAccId&&fid==sFolId)
try{gui.frm_main.main.list._serverSort({aid:aid,fid:fid});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}
else
if(gui.notifier)
gui.notifier._value({type:'alert',args:{text:'DOCUMENT::SAVE_ERROR'}});}]);};_me.__destructor=function(){if(this.__timeout){window.clearTimeout(this.__timeout);delete this.__timeout;}};

/* client/inc/obj_groupchat_invite.js */
_me=obj_groupchat_invite.prototype;function obj_groupchat_invite(){};_me.__constructor=function(aData){this._cangroup=false;if(aData.EVNLINKTYPE!='7'&&aData.EVNLINKTYPE!='8'){var aTmp={title:getLang(aData.EVNLINKTYPE=='5'?'CHAT::INVITED_USER':'CHAT::INVIT_VERIFIED')};if(aData.AccountName&&aData.AccountEmail){aTmp.user_name=aData.AccountName;aTmp.user_email=aData.AccountEmail;aTmp.full_email=MailAddress.createEmail(aData.AccountName,aData.AccountEmail,true);}
this._draw('obj_groupchat_invite','addon',aTmp);}};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVNNOTE','EVN_CREATED','EVN_MODIFIED','EVNLINKEXTRAS']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){if(this.__aData.EVNNOTE!=aData.EVNNOTE)
this._init_body(aData);this._init_reactions(aData);}}.bind(this)]);};

/* client/inc/obj_groupchat_item.js */
_me=obj_groupchat_item.prototype;function obj_groupchat_item(){};obj_groupchat_item.__comTypes={I:'obj_groupchat_message',R:'obj_groupchat_file',Q:'obj_groupchat_event',S:'obj_groupchat_conference',W:'obj_groupchat_invite',F:'obj_groupchat_file',Z:'obj_groupchat_file',E:'obj_groupchat_event',Y:'obj_groupchat_mail'};_me.__constructor=function(aData,oList,aOpt){storage.library('obj_highlight');var me=this;this.__options=aOpt||{};this.__aData=clone(aData,true);this.__pendingReaction=null;if(oList)
this.__list=oList;else{this.__list=this._parent;while(!this.__list._serverSort)
if(!(this.__list=this.__list._parent))
return;}
var d=(new IcewarpDate(aData.EVN_CREATED*1000)),d2=aData.EVN_MODIFIED?(IcewarpDate.unix(aData.EVN_MODIFIED)):false,metadata=parseURL(aData.EVN_METADATA),owner=(aData.EVNOWNERNAME&&aData.EVNOWNERNAME!='0'?aData.EVNOWNERNAME:(aData.EVNMODIFIEDOWNERNAME&&aData.EVNMODIFIEDOWNERNAME!='0'?aData.EVNMODIFIEDOWNERNAME:aData.EVNOWNEREMAIL))||metadata.core_own_name||'',name=(aData.EVNMODIFIEDOWNERNAME&&aData.EVNMODIFIEDOWNERNAME!='0'?aData.EVNMODIFIEDOWNERNAME:aData.EVNMODIFIEDOWNEREMAIL)||metadata.modified_own_name||metadata.core_modifiedown_name||'',aTmp={id:aData.EVN_ID,owner:owner,name:name,time:this.__options.fulldate?d.format('L LT'):d.format('LT'),fulltime:d.format('L LT'),body:'',comment:!!aData.EVNCOMEVNID&&this.__list.__options.comments,avatar:owner&&{img:getAvatarURL(metadata.core_own_email||aData.EVNOWNEREMAIL),link:MailAddress.createEmail(name,metadata.core_own_email||aData.EVNOWNEREMAIL).urlEncode()},edited_text:d2?getLang('CHAT::EDITED_BY',['<strong>'+name.escapeHTML()+'</strong>',d2.format('LT')]):false};if(aData.EVNNOTE&&aData.EVNCLASS!=='Q'){if(!aData.MENTIONS&&aData.EVNMENTIONS_INFO)
aData.MENTIONS=parseParamLine(aData.EVNMENTIONS_INFO);aTmp.body=this.__encode_body(aData.EVNNOTE,aData.MENTIONS);}
if(aData.EVNMODIFIEDOWNEREMAIL==sPrimaryAccount||aData.EVNMODIFIEDOWNEREMAIL==dataSet.get('main',['user'])){aTmp.me=true;addcss(this._main,'me');}
if(aData.EVNCOMEVNID){addcss(this._main,'com');if(this.__list.__options.comments)
addcss(this._main,'pad');}
if(!(this._cangroup=(!aData.EVN_MODIFIED||aData.EVN_CREATED==aData.EVN_MODIFIED)))
addcss(this._main,'edited');var linkextras;if(aData.EVNLINKEXTRAS){linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras.Evn_MetaData&&!aData.EVN_METADATA)
aData.EVN_METADATA=linkextras.Evn_MetaData;if(this.__aData.EVNLINKTYPE=='10'&&Is.Defined(linkextras.ReaValue))
aData.REAVALUE=linkextras.ReaValue;if(aData.EVNCLASS=='S'&&linkextras.organizer){aTmp.me=linkextras.organizer==sPrimaryAccount||linkextras.organizer==dataSet.get('main',['user']);aTmp.avatar={img:getAvatarURL(linkextras.organizer),link:MailAddress.createEmail(linkextras.organizer_name,linkextras.organizer).urlEncode()};aTmp.name=linkextras.organizer_name||linkextras.organizer;aTmp.private_name=aData.AccountName=linkextras.organizer_name||linkextras.organizer;aTmp.private_email=aData.AccountEmail=linkextras.organizer;}
else
if(linkextras.AccountEmail){aTmp.private_name=aData.AccountName=linkextras.AccountName||linkextras.AccountEmail;aTmp.private_email=aData.AccountEmail=linkextras.AccountEmail;}}
if(aData.EVNCLASS=='W'){delete aTmp.private_email;if(aData.EVNLINKTYPE=='7'||aData.EVNLINKTYPE=='8'){if((aTmp.me=aData.AccountEmail==sPrimaryAccount||aData.AccountEmail==dataSet.get('main',['user'])))
addcss(this._main,'me');addcss(this._main,'system');aTmp.avatar={img:getAvatarURL(aData.AccountEmail),link:MailAddress.createEmail(aData.AccountName,aData.AccountEmail).urlEncode()};if(aData.EVNLINKTYPE=='7')
aTmp.body=getLang('CHAT::ROOM_CREATED',[aData.AccountName.escapeHTML()]);else
aTmp.body=getLang('CHAT::ROOM_PRIVATE_CREATED',[aData.AccountName.escapeHTML()]);}}
else
if(aData.EVNCLASS=='S'){}
else
if(aData.AccountEmail)
addcss(this._main,'private');if(aData.EVNCLASS=='R'&&aData.EVNLINKTYPE=='1')
aTmp.modify_text=getLang('CHAT::MODIFIED_BY',['<strong>'+(linkextras.EvnOwnerName||linkextras.EvnOwnerEmail||'').escapeHTML()+'</strong>']);if(!aTmp.body)
addcss(this._main,'nobody');if(this._type=='obj_groupchat_pin'){aTmp.time=getLang('CHAT::PIN_CAPTION',[aTmp.time]);this._draw('obj_groupchat_pin','main',aTmp);}
else{aTmp.body=obj_highlight._highlight(aTmp.body);if(aData.EVNCLASS==='I'){aTmp.body=aTmp.body||' ';}
this._draw('obj_groupchat_item','main',aTmp);if(this.__list.__options.comments&&aData.EVNCOMEVNID&&aData.EVNCOMLINKEXTRAS){var com={aid:aData.aid,fid:aData.fid,iid:WMItems.__clientID(aData.EVNCOMEVNID)},tmp=parseURL(aData.EVNCOMLINKEXTRAS);for(var i in tmp)
com[i.toUpperCase()]=tmp[i];if(obj_groupchat_item.__comTypes[com.EVNCLASS])
this._create('item',obj_groupchat_item.__comTypes[com.EVNCLASS],'comment','',com);else
console.warn('Unauthorized EVNCLASS',com);addcss(this._main.parentElement,'com');this._getAnchor('reply').onclick=function(){this._comment();}.bind(this);}}
if(aData.EVN_METADATA){var meta=parseURL(aData.EVN_METADATA);if(meta.core_reactions_data)
aData.META_REACTIONS=parseURL(meta.core_reactions_data);if(!aData.META_COMMENTS&&meta.core_commentsinfo)
aData.META_COMMENTS=parseURL(meta.core_commentsinfo);}
this._init_reactions(aData,true);var eBorder=this._getAnchor('border'),aAccess=WMFolders.getAccess([aData.aid,aData.fid]);if(this._parent._type=='obj_groupchat_pin'){eBorder.onclick=function(e){var e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();this.__list._serverSort({aid:this.__aData.aid,fid:this.__aData.fid},false,{until:this.__aData.iid,highlight:true});return false;}.bind(this);}
else{eBorder.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(hascss(me._main,'edit')||elm.tagName=='FORM'||Is.Child(elm,'FORM',this)||(elm.tagName=='SPAN'&&(hascss(elm,'mention')||hascss(elm,'private_msg'))))
return;if(this.__timein){clearTimeout(this.__timein);delete this.__timein;}
if(this.__timeout){clearTimeout(this.__timeout);delete this.__timeout;}
if(aAccess.write&&me._init_controls(true))
addcss(me._main.parentElement,'active');};}
eBorder.onmouseover=function(e){if(this.__timeout){clearTimeout(this.__timeout);delete this.__timeout;}
if(hascss(me._main,'edit'))
return;if(!this.__timein)
this.__timein=setTimeout(function(){if(me&&!me._destructed){if(aAccess.write&&me._init_controls(true))
addcss(me._main.parentElement,'active');}},50);};eBorder.onmouseout=function(e){if(!Is.Child(e.relatedTarget,this)){if(this.__timein){clearTimeout(this.__timein);delete this.__timein;}
if(hascss(me._main,'edit'))
return;if(!this.__timeout)
this.__timeout=setTimeout(function(){if(me&&!me._destructed){if(me._init_controls(false))
removecss(me._main.parentElement,'active');}}.bind(this),25);}};this.__initialised=true;};_me._ungroup=function(bForce){if(this._cangroup){this._cangroup=false;var eSec=Is.Child(this._main,'SECTION',this.__list._main);if(eSec)
if(!bForce&&this.__aData.EVNCOMEVNID){if(hascss(eSec,'group'))
addcss(eSec,'nogroup');}
else{if(this.__aData.EVNCOMEVNID&&this.item&&this.item.__updateMe){this.item.__update();}
removecss(eSec,'group');}}};_me._edit=function(b){var sel=Is.Child(this._main,'SECTION',this.__list._main);if(!b&&this.text){this.text._destruct();if(this.preview)
this.preview._destruct();removecss(this._main,'edit');removecss(sel,'edit');this.__list._mask(false);this.__list.__options.autoscroll=true;}
else
if(b&&!this.text){this.__list._mask(true);if(this.__aData.EVNCLASS=='I')
this._getAnchor('addon').style.height=this._getAnchor('addon').offsetHeight+'px';var eBody=this._getAnchor('body'),initHeight=Math.min(eBody.offsetHeight,450);eBody.style.height=initHeight+'px';addcss(this._main,'edit');addcss(sel,'edit');this._init_controls(false);this._create('text','obj_chat_input','body','small',{parseurl:this.__aData.EVNCLASS=='I'});this.text.input.__maxHeight=450;this.text.__lastURL=this.__aData.EVNURL;this.text._folder({aid:this.__aData.aid,fid:this.__aData.fid});if(this.__aData.EVNCLASS=='I'){if(this.__aData.EVNURL){var bVid=this.__aData.CORE_LINKINFO&&this.__aData.CORE_LINKINFO['type']==2&&this.__aData.CORE_LINKINFO.videourl,w=bVid?500:300,h=bVid?281:600;var aOut={DESC:[{VALUE:this.__aData.EVNLOCATION}],TITLE:[{VALUE:this.__aData.EVNTITLE}],URL:[{VALUE:this.__aData.EVNURL}],IMAGES:[{IMAGE:[{URL:[{VALUE:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[this.__aData.aid,this.__aData.fid,WMItems.__serverID(this.__aData.iid),this.__aData.EVNTHUMBNAILID].join('/'),'resize':1,'width':w,'height':h,'t':this.__aData.EVNTHUMBNAILTIME||0})}]}]}]};this.text.preview=this._create('preview','obj_urlpreview','addon','',aOut);this.text.preview._onclose=function(){this.text._focus();}.bind(this);this._getAnchor('addon').style.height='';}
this.text.__urlloading=function(b){}.bind(this);this.text.__urlpreview=function(aData){this.preview=this._parent._create('preview','obj_urlpreview','addon','',aData);};}
this.text._onsubmit=function(v,aArgs,aPrivate){this.text.input._disabled(true);if(this.__save(v,aArgs,aPrivate)===false)
this.text.input._disabled(false);return false;}.bind(this);this.text.input._onclose=function(){if(!this.text.input.suggest)
this._edit(false);}.bind(this);if(this.__aData.EVNLINKEXTRAS&&this.__aData.EVNCLASS=='I'){var ext=parseURL(this.__aData.EVNLINKEXTRAS);if(ext.AccountEmail)
this.text._private(ext.AccountName,ext.AccountEmail);}
if(Is.String(this.__aData.EVNNOTE)){this.text._value(this.__aData.EVNNOTE);this.text.input._setRange(this.__aData.EVNNOTE.length);}
else
this.text._focus();this._main.scrollIntoView({behavior:"smooth",block:"center"});eBody.style.height='';eBody=null;this._getAnchor('esc_msg').onclick=function(e){var e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();this._edit(false);}.bind(this);this.__list.__options.autoscroll=false;}};_me.__save=function(v,aArgs,aPrivate){var aPrivate=aPrivate||{};var url1=this.__aData.EVNURL||'',url2=aArgs&&aArgs.url?aArgs.url:'';if(this.__aData.AccountEmail==aPrivate.email&&this.__aData.EVNNOTE==v&&url1==url2)
this._edit(false);else{var v=v,aItemInfo={values:{EVNNOTE:v}};switch(this.__aData.EVNCLASS){case'I':aItemInfo.values.EVNLINKID=aPrivate.email?aPrivate.email:'';if(this.__aData.EVNURL)
this.__aData.EVNURL=aItemInfo.values.EVNURL='';if(aArgs){if(aArgs.url)
aItemInfo.values.EVNURL=aArgs.url;if(aArgs.title)
aItemInfo.values.EVNTITLE=aArgs.title;if(aArgs.desc)
aItemInfo.values.EVNLOCATION=aArgs.desc;if(aArgs.thumbnailimageid)
aItemInfo.values.THUMBNAILIMAGEID=aArgs.thumbnailimageid;var info={};if(aArgs.type)info.type=aArgs.type;if(aArgs.videourl)info.videourl=aArgs.videourl;if(aArgs.videotype)info.videotype=aArgs.videotype;if(!Is.Empty(info))
aItemInfo.values.LINKINFO=buildURL(info);}
break;}
WMItems.add([this.__aData.aid,this.__aData.fid,this.__aData.iid],aItemInfo,'','','',[function(bOK){if(bOK===true){v?removecss(this._main,'nobody'):addcss(this._main,'nobody');addcss(this._main,'edited');this._edit(false);this._ungroup();this.__list._fire(this.__aData.iid,'update');}
else
this._edit(false);}.bind(this)]);}};_me._pin=function(sVal){var sAction=sVal=='public'?'add_global_pin':'add_pin';if(this.__aData.GPINWHEN&&sVal=='public')
sAction='delete_global_pin';else
if(this.__aData.LPINWHEN&&sVal=='private')
sAction='delete_pin';WMItems.action({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid},sAction,[function(bOK,aData){if(bOK&&this.__list){var arg={};if(sAction=='add_global_pin'&&aData.IQ&&aData.IQ[0].RESULT&&aData.IQ[0].RESULT[0].LAST_PINNED_ITEM)
arg.LAST_PINNED_ITEM=aData.IQ[0].RESULT[0].LAST_PINNED_ITEM[0].VALUE;if(!this.__list._fire(this.__aData.iid,sAction,arg)&&this.__update)
this.__update(true);}}.bind(this)]);};_me._reaction=function(sVal){if(this.__aData.REAVALUE!=sVal&&this.__pendingReaction!==sVal){this.__pendingReaction=sVal;var aItemInfo={reactions:{REACTION:{values:{REACTION:sVal||''}}}};WMItems.add([this.__aData.aid,this.__aData.fid,this.__aData.iid],aItemInfo,'','','',[function(sVal,sRea,bOK,aData){if(this.react){this.react._destruct();delete this.react;}
if(bOK){var sType='reaction',sBody=sVal;if(!sVal){sType='reaction-deleted';sBody=sRea;}
if(this.__list&&!this.__list._fire(this.__aData.iid,sType,{BODY:sBody,REAVALUE:sVal})&&this._init_reactions){var meta_reactions='';if(aData.xml&&(aData=aData.xml.IQ)&&(aData=aData[0].RESULT)&&aData[0].META_REACTIONS)
meta_reactions=aData[0].META_REACTIONS[0].VALUE;this._init_reactions({META_REACTIONS:meta_reactions?parseURL(meta_reactions):'',REAVALUE:sVal});}
this.__pendingReaction=null;}
else
if(this.__list&&!this.__list._fire(this.__aData.iid,'update')&&this.__update){this.__pendingReaction=null;this.__update(true);}}.bind(this,sVal,this.__aData.REAVALUE)]);}};_me._data=function(id,aData,sCall,aArgs){var obj=this;if(Is.Defined(id)&&this.__aData.iid!=id){if(this.item&&!this.item._destructed&&this.item.__aData&&this.item.__aData.iid==id){obj=this.item;if(hascss(this._main.parentElement,'group')){obj.__updateMe=true;return;}}
else
if(parseInt(this.__aData.EVNLINKTYPE,10)!==10&&WMItems.__clientID(this.__aData.EVNLINKID)!=id){if(parseInt(this.__aData.EVNLINKTYPE,10)==10&&this.item&&!this.item._destructed&&this.item.__aData&&this.item.__aData.EVNLINKID==id)
obj=this.item;else
return;}}
if(Is.Object(aData))
for(var k in aData)
obj.__aData[k]=aData[k];if(sCall&&Is.Function(obj[sCall]))
obj[sCall].apply(obj,aArgs||[]);};_me._init_reactions=function(aData,bNoScroll){var show=false,aData=aData||this.__aData,div=mkElement('div'),r={};if(aData.REACTIONS){this.__aData.REACTIONS=aData.REACTIONS;var sRea='';for(var id in aData.REACTIONS)
if(aData.REACTIONS[id].values&&aData.REACTIONS[id].values.REAVALUE){r[aData.REACTIONS[id].values.REAVALUE]=(r[aData.REACTIONS[id].values.REAVALUE]||0)+1;if(aData.REACTIONS[id].values.REAOWNEMAIL==sPrimaryAccount||aData.REACTIONS[id].values.REAOWNEMAIL==dataSet.get('main',['user']))
sRea=aData.REACTIONS[id].values.REAVALUE;}
this.__aData.REAVALUE=sRea;}
else
if(aData.META_REACTIONS){r=this.__aData.META_REACTIONS=aData.META_REACTIONS;delete this.__aData.REACTIONS;if(Is.Defined(aData.REAVALUE))
this.__aData.REAVALUE=aData.REAVALUE;}
else
if(aData.NOTIFY_REACTIONS){if(this.__aData.REACTIONS){for(var id in this.__aData.REACTIONS)
if(this.__aData.REACTIONS[id].values&&this.__aData.REACTIONS[id].values.REAVALUE){r[this.__aData.REACTIONS[id].values.REAVALUE]=(r[this.__aData.REACTIONS[id].values.REAVALUE]||0)+1;}
delete this.__aData.REACTIONS;}
else
if(this.__aData.META_REACTIONS){r=this.__aData.META_REACTIONS;}
if(aData.ACTION=='reaction'){r[aData.NOTIFY_REACTIONS]=parseInt(r[aData.NOTIFY_REACTIONS]||0)+1;if(Is.Defined(aData.REAVALUE)&&this.__aData.REAVALUE!=aData.REAVALUE){if(this.__aData.REAVALUE){if(r[this.__aData.REAVALUE]>'1')
r[this.__aData.REAVALUE]=parseInt(r[this.__aData.REAVALUE])-1;else
delete r[this.__aData.REAVALUE];}
this.__aData.REAVALUE=aData.REAVALUE;}}
else{if(r[aData.NOTIFY_REACTIONS]>'1')
r[aData.NOTIFY_REACTIONS]=parseInt(r[aData.NOTIFY_REACTIONS])-1;else{delete r[aData.NOTIFY_REACTIONS];}
if(Is.Defined(aData.REAVALUE))
this.__aData.REAVALUE=aData.REAVALUE;}
this.__aData.META_REACTIONS=r;}
else{delete this.__aData.REACTIONS;this.__aData.REAVALUE='';}
if(this.react){this.react._destruct();delete this.react;}
var cnt=0;if(!Is.Empty(r)){show=true;for(var i in r)
if(i){div.appendChild(mkElement('span',{className:'react r_'+i+(this.__aData.REAVALUE===i?' mine':''),rel:i,innerHTML:r[i]||1}));cnt+=parseInt(r[i]);}}
if(Is.Defined(aData.GPINWHEN))
this.__aData.GPINWHEN=aData.GPINWHEN;if(this.__aData.GPINWHEN){div.appendChild(mkElement('span',{className:'pin public'+(aData.PINOWNEMAIL&&(aData.PINOWNEMAIL==sPrimaryAccount||aData.PINOWNEMAIL==dataSet.get('main',['user']))?' delete':''),innerHTML:getLang('SHARING::PUBLIC')}));show=true;}
if(Is.Defined(aData.LPINWHEN))
this.__aData.LPINWHEN=aData.LPINWHEN;if(this.__aData.LPINWHEN){div.appendChild(mkElement('span',{className:'pin private delete',innerHTML:getLang('SHARING::PRIVATE')}));show=true;}
if(!this.__aData.EVNCOMEVNID){var etmp,cnt=0;if(Is.Defined(aData.META_COMMENTS))
this.__aData.META_COMMENTS=aData.META_COMMENTS;else
if(Is.Defined(aData.EVN_METADATA)){var meta=parseURL(aData.EVN_METADATA);if(meta.core_reactions_data)
this.__aData.META_REACTIONS=parseURL(meta.core_reactions_data);if(meta.core_commentsinfo)
this.__aData.META_COMMENTS=parseURL(meta.core_commentsinfo);}
if(this.__aData.META_COMMENTS&&this.__aData.META_COMMENTS.count)
cnt=parseInt(this.__aData.META_COMMENTS.count)||0;if(cnt>0){etmp=mkElement('span',{className:'comments',innerHTML:getLang('CHAT::COMMENTS',['<b>'+cnt+'</b>'])});if(this._parent!==this.__list&&this._parent.__aData&&this._parent.__aData.EVNCOMEVNID){var pd=this._parent.__aData,metadata=parseURL(pd.EVN_METADATA),s=(pd.EVNMODIFIEDOWNEREMAIL==sPrimaryAccount||pd.EVNMODIFIEDOWNEREMAIL==dataSet.get('main',['user']))?getLang('COMMON::YOU'):(pd.EVNMODIFIEDOWNERNAME||pd.EVNMODIFIEDOWNEREMAIL||metadata.core_own_name||''),d=IcewarpDate.unix(aData.EVN_CREATED||this.__aData.EVN_CREATED||0),n2=mkElement('strong',{text:this.__aData.EVNMODIFIEDOWNERNAME||this.__aData.EVNMODIFIEDOWNEREMAIL}).outerHTML;var eUsr=mkElement('strong',{text:s});eUsr.insertBefore(mkElement('div',{style:{'background-image':'url("'+getAvatarURL(pd.EVNMODIFIEDOWNEREMAIL)+'")'}}),eUsr.childNodes[0]);var str='<span class="unselectable">'+getLang('CHAT::COMMENTED'+((pd.EVNMODIFIEDOWNEREMAIL==sPrimaryAccount||pd.EVNMODIFIEDOWNEREMAIL==dataSet.get('main',['user']))?'_YOU':''),[eUsr.outerHTML,n2,getLang('CHAT::TYPE_'+pd.EVNCLASS)])+'</span>';str+='<span class="time unselectable" title="'+d.format('L LT')+'">'+d.format(d.isSame(IcewarpDate.unix(pd.EVN_CREATED),'day')?'LT':'L LT')+'</span>';this._main.querySelector('h3.name').innerHTML=str;}
div.appendChild(etmp);etmp=null;show=true;}}
if(bNoScroll)
removecss(this._main,'anim');else
addcss(this._main,'anim');if(!show){removecss(this._main,'reactions');}
else{var elm=this._getAnchor('reactions');elm.innerHTML=div.innerHTML;if(!this.__reactions){this.__reactions=true;if(WMFolders.getAccess({aid:this.__aData.aid,fid:this.__aData.fid},'write'))
elm.onclick=function(e){var eT=e.target||e.srcElement;if(eT.tagName=='SPAN'){var skip=false;if(hascss(eT,'react')){if(this.__reactTimeOut){window.clearTimeout(this.__reactTimeOut);delete this.__reactTimeOut;}
if(this.__reactTimeIn){window.clearTimeout(this.__reactTimeIn);delete this.__reactTimeIn;}
if(this.react){this.react._destruct();delete this.react;}
var sVal=eT.getAttribute('rel');this._reaction(this.__aData.REAVALUE==sVal?'':sVal);skip=true;}
else
if(hascss(eT,'comments')&&this.__list.__options.comments){this._comment();skip=true;}
else
if(hascss(eT,'pin')&&hascss(eT,'delete')){this._pin(hascss(eT,'private')?'private':'public');skip=true;}
if(skip){e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();return false;}}}.bind(this);elm.onmouseover=function(e){var eT=e.target||e.srcElement;if(eT.tagName=='SPAN'&&hascss(eT,'react')){if(this.__reactTimeOut){window.clearTimeout(this.__reactTimeOut);delete this.__reactTimeOut;}
if(this.__reactTimeIn){window.clearTimeout(this.__reactTimeIn);delete this.__reactTimeIn;}
this.__reactTimeIn=setTimeout(function(){this._show_react(eT);}.bind(this),500);}}.bind(this);elm.onmouseout=function(e){if(this.__reactTimeOut){window.clearTimeout(this.__reactTimeOut);delete this.__reactTimeOut;}
if(this.__reactTimeIn){window.clearTimeout(this.__reactTimeIn);delete this.__reactTimeIn;}
if(this.react)
this.__reactTimeOut=setTimeout(function(){if(this.react){this.react._destruct();delete this.react;}}.bind(this),300);}.bind(this);}
if(this.__initialised&&!hascss(this._main,'reactions')){if(!bNoScroll&&!this._main.parentNode.nextSibling){if(browserEvent('transitionend')){var interval=setInterval(function(){if(this.__list&&!this.__list._destructed)
this.__list._scrollBy(this._main.offsetHeight);else
clearInterval(interval);}.bind(this),5);var reactions=this._main.querySelectorAll('.reactions');var elm=reactions[reactions.length-1];var transition_callback=function(){clearInterval(interval);elm.removeEventListener(browserEvent('transitionend'),transition_callback);};elm.addEventListener(browserEvent('transitionend'),transition_callback);}else{setTimeout(function(){if(this.__list&&!this.__list._destructed)
this.__list._scrollBy(this._main.offsetHeight);}.bind(this),300);}}}
addcss(this._main,'reactions');}};_me._init_controls=function(bShow){if(this._parent._type=='obj_groupchat_pin')
return true;if(bShow){if(!this.controls){var aOpt={draft:(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))?false:(this.__aData.EVNCLASS=='Y'&&this.__aData.EVNLINKEXTRAS&&parseURL(this.__aData.EVNLINKEXTRAS).EvnFlags&128),mail:(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))?false:(this.__aData.EVNCLASS=='Y'),nopin:this.__aData.EVNCLASS=='W'||this.__aData.EVNLINKTYPE=='10',noedit:(!this.__list.__options.comments&&!this.__aData.EVNCOMEVNID)||this.__aData.EVNCLASS=='Q'||this.__aData.EVNLINKTYPE=='10'||(this.__aData.EVNCLASS=='W'&&(this.__aData.EVNLINKTYPE=='7'||this.__aData.EVNLINKTYPE=='8'))||!((this.__aData.EVNOWNEREMAIL==sPrimaryAccount||this.__aData.EVNOWNEREMAIL==dataSet.get('main',['user']))||WMFolders.getAccess({aid:this.__aData.aid,fid:this.__aData.fid},'modify')),notrash:(!this.__list.__options.comments&&!this.__aData.EVNCOMEVNID)||!(this.__aData.EVNOWNEREMAIL==sPrimaryAccount||this.__aData.EVNOWNEREMAIL==dataSet.get('main',['user'])||WMFolders.getAccess({aid:this.__aData.aid,fid:this.__aData.fid},'remove')),nocomment:!this.__list.__options.comments||this.__aData.EVNLINKTYPE=='10'};this._create('controls','obj_tch_control','border','',aOpt,this.__aData,[function(sAction,sData){switch(sAction){case'reaction':if(this.__aData.EVNLINKTYPE=='10'){if(this.item){if(this.item.__aData.REAVALUE==sData)
this.item._reaction('');else
this.item._reaction(sData);}}
else
if(this.__aData.REAVALUE==sData)
this._reaction('');else
this._reaction(sData);break;case'comment':this._comment();break;case'pin':this._pin(sData);break;case'edit':if(this._edit)
this._edit(true);break;case'remove':if(this.__aData.EVNLINKEXTRAS){var linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};if(linkextras.evnlockown_id&&linkextras.evnlockown_id!==sPrimaryAccountGWID){var frm=gui._create('remove','frm_confirm_threestates','','noblur',[function(){TeamChatAPI.requestUnlock(this.__aData.fid,this.__aData.EVNTITLE,linkextras.evnlockown_email,'remove');}.bind(this)],'CONFIRMATION::DELETE_ITEM_CONFIRMATION','CONFIRMATION::DELETE_LOCKED_ITEM',[linkextras.evnlockown_email]);frm.x_btn_ok._value('DOCUMENT::REQUEST_UNLOCK');frm.x_btn_cancel._value('FORM_BUTTONS::REMOVE');frm.x_btn_cancel._onclick=function(){frm._destruct();this.__remove();}.bind(this);addcss(frm.x_btn_cancel._main,'color2');return;}}
this.__remove();break;case'reply':case'reply_all':var bIsHTML;if(this.__aData.EVNLINKEXTRAS){var linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};if(linkextras.EvnFlags){bIsHTML=!!(linkextras.EvnFlags&256);}}
OldMessage.reply([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID+'|@@MAIN@@')],sAction=='reply_all',void 0,void 0,bIsHTML);break;case'forward':var bIsHTML;if(this.__aData.EVNLINKEXTRAS){var linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};if(linkextras.EvnFlags){bIsHTML=!!(linkextras.EvnFlags&256);}}
OldMessage.forward([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID+'|@@MAIN@@')],void 0,void 0,bIsHTML);break;case'edit_mail':if(true){var id=[this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID)];Item.set_lock(id,true,false,[function(bOK){var bIsHTML;if(this.__aData.EVNLINKEXTRAS){var linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};if(linkextras.EvnFlags){bIsHTML=!!(linkextras.EvnFlags&256);}}
if(bOK){var sName=dataSet.get('folders',[this.__aData.aid,this.__aData.fid,'NAME'])||dataSet.get('folders',[this.__aData.aid,this.__aData.fid,'RELATIVE_PATH'])||'';var aOpt={sTeamchat:this.__aData.fid+(sName?'::'+sName:''),sComment:this.__aData.EVNNOTE,__id_chat:id,__id:null};OldMessage.edit([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID+'|@@MAIN@@')],aOpt,bIsHTML);}
else{var aLockInfo={id:WMItems.__clientID(this.__aData.EVNLINKID)};if(this.__aData.EVNLINKEXTRAS){var linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};aLockInfo.EVNLOCKOWN_EMAIL=linkextras.evnlockown_email;aLockInfo.EVNLOCKOWN_ID=linkextras.evnlockown_id;aLockInfo.EVNTITLE=linkextras.EvnTitle;aLockInfo.draft=linkextras.EvnFlags&128;}
OldMessage.openwindow([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID+'|@@MAIN@@')],null,aLockInfo,bIsHTML);}}.bind(this)]);}
break;}}.bind(this)]);}
this.controls._onhide=function(){removecss(this._main.parentElement,'active');}.bind(this);this.controls._show();}
else
if(this.controls)
return this.controls._hide();return true;};_me.__remove=function(){WMItems.remove({aid:this.__aData.aid,fid:this.__aData.fid,iid:[this.__aData.iid]},'','','',[function(bOK){bOK&&this.__list._fire(this.__aData.iid,'delete');}.bind(this)]);};_me._init_body=function(aData){if(aData.EVNNOTE){if(aData.EVNLINKEXTRAS){var linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras.AccountEmail){aData.AccountName=linkextras.AccountName||linkextras.AccountEmail;aData.AccountEmail=linkextras.AccountEmail;}}
this._draw('obj_groupchat_message','body',{body:obj_highlight._highlight(this.__encode_body(aData.EVNNOTE,aData.MENTIONS)),private_name:aData.AccountName,private_email:aData.AccountEmail});removecss(this._main,'nobody');addcss(this._main,'edited');var edit=this._main.getElementsByClassName('edit'),name=aData.EVNMODIFIEDOWNERNAME&&aData.EVNMODIFIEDOWNERNAME!='0'?aData.EVNMODIFIEDOWNERNAME:aData.EVNMODIFIEDOWNEREMAIL;edit&&edit[0]&&(edit[0].innerHTML=getLang('CHAT::EDITED_BY',['<strong>'+name.escapeHTML()+'</strong>',IcewarpDate.unix(aData.EVN_MODIFIED).format('LT')]));}
else{addcss(this._main,'nobody','edited');this._getAnchor('body').innerHTML='';}
this.__aData.EVNNOTE=aData.EVNNOTE;this.__aData.MENTIONS=aData.MENTIONS;this.__aData.AccountName=aData.AccountName;this.__aData.AccountEmail=aData.AccountEmail;};_me._show_react=function(elm){if(elm){if(this.__reactTimeIn){window.clearTimeout(this.__reactTimeIn);delete this.__reactTimeIn;}
if(this.__aData.REACTIONS)
this._fill_react(elm);else{var iid=this.__aData.iid;if(this.__aData.EVNLINKTYPE=='10')
iid=this.__aData.EVNLINKID?WMItems.__clientID(this.__aData.EVNLINKID):this.__aData.iid;var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:iid,values:[]};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[iid])){this.__aData.REACTIONS=aData.REACTIONS;this._fill_react(elm);}}.bind(this)]);}}};_me._fill_react=function(elm){if(this.__aData.REACTIONS){if(!this.react||this.react._destructed){this.react=gui._create('react','obj_block','','react','absolute');this.react._main.onmouseover=function(e){if(this.__reactTimeOut){window.clearTimeout(this.__reactTimeOut);delete this.__reactTimeOut;}
if(this.__reactTimeIn){window.clearTimeout(this.__reactTimeIn);delete this.__reactTimeIn;}}.bind(this);this.react._main.onmouseout=function(e){this.react._main.onmouseover(e);this.__reactTimeOut=setTimeout(function(){if(this.react){this.react._destruct();delete this.react;}}.bind(this),300);}.bind(this);}
var i=0,sType=elm.getAttribute('rel');this.react._main.innerHTML='';this.react._main.appendChild(mkElement('h4',{text:getLang('SMILES_NAME::'+sType)}));for(var id in this.__aData.REACTIONS){if(this.__aData.REACTIONS[id].values&&sType==this.__aData.REACTIONS[id].values.REAVALUE){this.react._main.appendChild(mkElement('div',{text:this.__aData.REACTIONS[id].values.REAOWNNAME||this.__aData.REACTIONS[id].values.REAOWNEMAIL}));if(++i>10){this.react._main.appendChild(mkElement('div',{text:getLang('CHAT::REACTIONS_BUBBLE',[count(this.__aData.REACTIONS)-10])}));break;}}}
var eAll=mkElement('div',{text:getLang('CHAT::ALL_REACTIONS'),className:'all'});eAll.onclick=function(){gui._create('reactions','frm_reactions','','',this.__aData,sType);}.bind(this);this.react._main.appendChild(eAll);var pos=getSize(elm),iTop=pos.y-(this.react._main.offsetHeight)-15;if(iTop<10){addcss(this.react._main,'bottom');this.react._place(pos.x,pos.y+pos.h+15);}
else{removecss(this.react._main,'bottom');this.react._place(pos.x,iTop);}}};_me.__encode_body=function(sBody,aMentions,bShortUrl){var aMen={};if(aMentions)
for(var id in aMentions)
aMen[aMentions[id].values.EMAIL]={name:aMentions[id].values.NAME,email:aMentions[id].values.EMAIL};var aOut=[],aBody=sBody.split('```');if(aBody.length<3)
aBody=[sBody];aBody.forEach(function(s,i){if(i%2==0){var a=s.split('`');if(a.length>2){a.forEach(function(v,j,a){var l=aOut.length;if(j&&l%2&&(a[j]==''||(j-1&&a[j-1]=='')||typeof a[j+1]=='undefined'))
aOut[l-1].value+='`'+v;else
aOut.push({value:v,wrapper:j%2&&'`'});});return;}}
aOut.push({value:s,wrapper:i%2&&'```'});});return aOut.map(function(v,i){if(i%2==0){var hla=v.value.highlight_links_array(bShortUrl),str=GWOthers.getItem('CHAT','smiles')=='1'?Smiles.replaceSmiles(hla.string.escapeHTML()):hla.string.escapeHTML();var sOut=str.replace(new RegExp(hla.replace,'g'),function(s,id){return hla.array[id];});if(sOut.indexOf('@[')>-1){sOut=sOut.replace(/(@\[([^\]]{1,128})\])/g,function(){var str=arguments[2],name=str,email=str.indexOf('@')>-1?str:str+'@'+dataSet.get('main',['domain']),full=email;title=email;if(name==='@all@'){name=getLang('CHAT::ALL_MEMBERS');}else if(aMen[email]){name=aMen[email].name||aMen[email].email;full=MailAddress.createEmail(aMen[email].name,aMen[email].email);title=MailAddress.createEmail(aMen[email].name,aMen[email].email,true);}
return mkElement('span',{className:'mention '+((email==sPrimaryAccount||email==dataSet.get('main',['user']))?' me':''),title:title,rel:full,text:(gui._rtl?'':'@')+name}).outerHTML;});}
return sOut;}
if(v.wrapper){v.value=v.wrapper+v.value+v.wrapper;}
return v.value;}).join('');};_me._finished=function(){if(this.__aData.EVNCLASS!='I')
[].forEach.call(this._main.querySelectorAll('.noclick'),function(elm){elm.onclick=function(e){var e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();return false;};});};_me._comment=function(){if(!!this.__aData.EVNCOMEVNID){if(this.__list.__options.comments&&this.item){var aData=clone(this.item.__aData,true);aData.updateMe=this.item.__updateMe;gui.frm_main.main._create('comment','frm_comment','','',aData);}}
else
if(this.__aData.EVNLINKTYPE=='10'){if(this.item){var aData=clone(this.item.__aData,true);gui.frm_main.main._create('comment','frm_comment','','',aData);}}
else
gui.frm_main.main._create('comment','frm_comment','','',this.__aData);};

/* client/inc/obj_groupchat_mail.js */
_me=obj_groupchat_mail.prototype;function obj_groupchat_mail(){};_me.__constructor=function(){this.__fill(this.__aData);};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVNNOTE','EVN_CREATED','EVN_MODIFIED','EVNSHARETYPE','EVNLINKEXTRAS','EVNURL','EVN_ID','EVNSIZEINFO','EVNMEETINGID','EVNLINKID']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])&&aData.EVNLINKEXTRAS){if(this.controls)
this.controls._destruct();if(this.__aData.EVNNOTE!=aData.EVNNOTE)
this._init_body(aData);this._init_reactions(aData);for(var k in aData)
this.__aData[k]=aData[k];this.__fill(this.__aData);}}.bind(this)]);};_me.__fill=function(aData){this.from&&this.from._destruct();this.rcp&&this.rcp._destruct();this.full_switch&&this.full_switch._destruct();this.attach&&this.attach._destruct();this.__eFrame=null;var aTmp={},linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras.EvnTicket){aTmp.size=parseFileSize(linkextras.EvnComplete);aTmp.url=linkextras.EvnTicket;aTmp.subject=linkextras.EvnTitle;aTmp.draft=linkextras.EvnFlags&128;aTmp.from=linkextras.EvnOrganizer;aTmp.frame_src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':aData.aid+'/'+aData.fid+'/'+aData.EVNLINKID+'/MAIL_PREVIEW.html',tmod:linkextras.Evn_Modified});var oDate=new IcewarpDate(linkextras.EvnStartDate,{format:IcewarpDate.JULIAN});oDate.setTime(linkextras.EvnStartTime,true);aTmp.date=CalendarFormatting.normalWithTime(oDate);if(linkextras.Evn_MetaData){var metadata=parseURL(linkextras.Evn_MetaData);if(metadata.attachments){try{var att=JSON.parse(metadata.attachments);if(Is.Array(att)){aTmp.attach=att.map(function(v){v.id=v.part_id;return v;});}}
catch(r){console.log('attachments json',r);}}}}
if(linkextras.EvnMeetingID){aTmp.rcp=true;aTmp.rcp_more=linkextras.EvnSequence-MailAddress.splitEmailsAndNames(linkextras.EvnMeetingID).length;}
this._draw('obj_groupchat_mail','addon',aTmp);this._create('from','obj_link','from','',aTmp.from);if(linkextras.EvnMeetingID){var rcp=this._create('rcp','obj_link','rcp','',linkextras.EvnMeetingID);if(aTmp.rcp_more){var elm=mkElement('span',{text:aTmp.rcp_more===1?getLang('CHAT::OTHER_RCP'):getLang('CHAT::OTHERS_RCP',[aTmp.rcp_more])});elm.onclick=function(e){this.full_switch._onclick(e);}.bind(this);rcp._main.appendChild((mkElement('div',{class:'more',text:getLang('CHAT::AND')+' '},'',elm)));}}
this.__avatar(aTmp.from?MailAddress.splitEmailsAndNames(aTmp.from)[0].email:'');this._getAnchor('avatar').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='B'||elm.tagName=='IMG'){var aMail=MailAddress.splitEmailsAndNames(aTmp.from);if(aMail&&aMail[0]){var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',aMail[0].name,aMail[0].email);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;}}};this._getAnchor('toggle').onclick=function(e){if(hascss(this._main,'full'))
removecss(this._main,'full');else{if(!this.__eFrame)
this.__initFrame(aTmp.frame_src);if(aTmp.attach&&!this.attach)
this.__initAttach(aTmp.attach);addcss(this._main,'full');}
e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();}.bind(this);this.full_switch._onclick=function(){var aLockInfo;var bIsHTML;if(linkextras){aLockInfo={EVNLOCKOWN_EMAIL:linkextras.evnlockown_email,EVNLOCKOWN_ID:linkextras.evnlockown_id,EVNTITLE:linkextras.EvnTitle+'.eml',draft:linkextras.EvnFlags&128,id:WMItems.__clientID(aData.EVNLINKID),guest:sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly())};bIsHTML=!!(linkextras.EvnFlags&256);}
OldMessage.openwindow([aData.aid,aData.fid,WMItems.__clientID(aData.EVNLINKID+'|@@MAIN@@')],null,aLockInfo,bIsHTML);};if(this._parent._type=='obj_groupchat'||hascss(this._main,'full')){this.__initFrame(aTmp.frame_src);if(aTmp.attach)
this.__initAttach(aTmp.attach);}};_me.__initFrame=function(src){if(!this.__eFrame){this.__eFrame=mkElement('iframe',{frameborder:"0",marginwidth:"0",marginheight:"0",scrolling:"no",seamless:"seamless"});this.__eFrame.onload=function(){var base=document.getElementsByTagName('base')[0].getAttribute('href'),doc=this.contentWindow.document;doc.getElementsByTagName('head')[0].appendChild(mkElement('base',{href:base},doc));doc.getElementsByTagName('head')[0].appendChild(mkElement('link',{type:"text/css",rel:"stylesheet",href:'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'font.css'}),iwstyle:'iwstyle'},doc));doc.getElementsByTagName('head')[0].appendChild(mkElement('link',{type:"text/css",rel:"stylesheet",href:'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'obj_mailview_body.css'}),iwstyle:'iwstyle'},doc));if(doc.body){doc.body.style.padding='0';var sid=dataSet.get('main',['sid']);[].forEach.call(doc.querySelectorAll('img[icewarp-src]'),function(elm){elm.src='./server/download.php'+(elm.getAttribute('icewarp-src')||'').replace('@@SESSION_ID@@',sid);});if(GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){setTimeout(function(){storage.library('night_mode');NightMode(doc.defaultView).activate();}.bind(this),5);}}};this._getAnchor('frame').appendChild(this.__eFrame);}
this.__eFrame.src=src;};_me.__initAttach=function(att){if(att){if(!this.attach){this._create('attach','obj_attach_mailview','attach','noico');this.attach._aid=this.__aData.aid;this.attach._fid=this.__aData.fid;this.attach._iid=WMItems.__clientID(this.__aData.EVNLINKID+'|@@MAIN@@');}
this.attach._value({'attachments':att});}};_me.__avatar=function(sEmail){if(sEmail&&sPrimaryAccountGW){var me=this,sURL=getAvatarURL(sEmail),img=new Image();img.onload=function(){if(!me._getAnchor('avatar')){return;}
var elm=mkElement('b');me._getAnchor('avatar').innerHTML='';me._getAnchor('avatar').appendChild(elm);if(elm){if(this.height>10&&this.width>10){if(currentBrowser()=='MSIE7'){var img=mkElement('img',{src:sURL});if(this.width>this.height){var r=this.height/elm.clientHeight;img.style.height='100%';if((this.width/r)>elm.clientWidth)
img.style.right=(((this.width/r)-elm.clientWidth)/2)+'px';}
else{var r=this.width/elm.clientWidth;img.style.width='100%';if((this.height/r)>elm.clientHeight)
this.style.bottom=(((this.height/r)-elm.clientHeight)/2)+'px';}
elm.appendChild(img);elm.style.backgroundImage='none';}
else
elm.style.backgroundImage='url("'+sURL+'")';elm.style.backgroundColor='#FFFFFF';}
else{elm.style.backgroundImage='';elm.style.backgroundColor='';}}};img.src=sURL;}
else
this._getAnchor('avatar').innerHTML='<b></b>';};

/* client/inc/obj_groupchat_message.js */
_me=obj_groupchat_message.prototype;function obj_groupchat_message(){};_me.__constructor=function(){if(this.__aData.EVNURL)
this._init_addon(this.__aData);};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVNNOTE','EVN_CREATED','EVN_MODIFIED','EVNSHARETYPE','EVNLINKEXTRAS','EVN_METADATA','EVNURL','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVN_ID']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){if(this.__aData.EVNNOTE!=aData.EVNNOTE){if(aData.EVNCLASS==='I'){aData.EVNNOTE=aData.EVNNOTE||' ';}
this._init_body(aData);}
if(aData.EVNURL){if(this.__aData.EVNURL!=aData.EVNURL){this._init_addon(aData);}
else
if(this.__aData.EVNTHUMBNAILTIME!=aData.EVNTHUMBNAILTIME)
{this.__destructor();if(aData.EVNPROCESSINGQUEUED=='0'){if(this._preview_image){if(aData.EVNTHUMBNAILTICKET)
this._preview_image(aData.EVNTHUMBNAILTICKET,this.__dimensions(aData.EVNSIZEINFO));else
if(aData.EVNTHUMBNAILID){var src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[this.__aData.aid,this.__aData.fid,WMItems.__serverID(this.__aData.iid),aData.EVNTHUMBNAILID].join('/'),'t':aData.EVNTHUMBNAILTIME||0});this._preview_image(src,this.__dimensions(aData.EVNSIZEINFO));}}}
else
if(!gui.socket&&(!Is.Defined(aData.EVNPROCESSINGQUEUED)||aData.EVNPROCESSINGQUEUED=='1'))
this.__timeout=setTimeout(function(){this.__update();}.bind(this),5000);}}
else
if(hascss(this._main,'obj_groupchat_link')){this.__destructor();this._getAnchor('addon').innerHTML='';removecss(this._main,'obj_groupchat_link');}
this._init_reactions(aData);}}.bind(this)]);};_me._init_addon=function(aData){this.__destructor();addcss(this._main,'obj_groupchat_link');if(aData.EVNNOTE==aData.EVNURL)
addcss(this._main,'nobody');var a=mkElement('A',{href:aData.EVNURL}),aTmp={title:aData.EVNTITLE,desc:aData.EVNLOCATION,url:a.hostname};if(aData.EVN_METADATA){this.__aData.EVN_METADATA=aData.EVN_METADATA=parseURL(aData.EVN_METADATA);if(aData.EVN_METADATA.core_linkinfo)
this.__aData.CORE_LINKINFO=aData.CORE_LINKINFO=parseURL(aData.EVN_METADATA.core_linkinfo);}
this.__aData.EVNURL=aData.EVNURL;this.__aData.EVNTHUMBNAILID=aData.EVNTHUMBNAILID;this.__aData.EVNTHUMBNAILTIME=aData.EVNTHUMBNAILTIME;this.__aData.EVNPROCESSINGQUEUED=aData.EVNPROCESSINGQUEUED;if(!aData.EVNTHUMBNAILID)
aTmp.preview='ico';if(aData.CORE_LINKINFO&&aData.CORE_LINKINFO['type']==2&&aData.CORE_LINKINFO.videourl&&!this.__options.novideo){this._draw('obj_groupchat_link_video','addon',aTmp);this._getAnchor('preview').onclick=function(e){var url=mkElement('A',{href:aData.CORE_LINKINFO.videourl}),search=parseURL(url.search);search.autoplay=1;search.showinfo=0;search.modestbranding=1;var attr={src:url.protocol+'//'+url.hostname+'/'+url.pathname+'?'+buildURL(search)+url.hash,width:500,height:281,frameborder:0,scrolling:'no'};this.parentNode.replaceChild(mkElement('iframe',attr),this);e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};}
else{this._draw('obj_groupchat_link','addon',aTmp);this._getAnchor('preview').onclick=function(e){window.open(aData.EVNURL);e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};}
var tmp=this._getAnchor('title');if(tmp)
tmp.onclick=function(e){window.open(aData.EVNURL);e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};if(aData.EVNTHUMBNAILTICKET){this._preview_image(aData.EVNTHUMBNAILTICKET,aData.EVNSIZEINFO);}
else
if(aData.EVNTHUMBNAILID){var src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aData.aid,aData.fid,WMItems.__serverID(aData.iid),aData.EVNTHUMBNAILID].join('/'),'t':aData.EVNTHUMBNAILTIME||0});this._preview_image(src,aData.EVNSIZEINFO);}
else
if(!gui.socket&&(!Is.Defined(aData.EVNPROCESSINGQUEUED)||aData.EVNPROCESSINGQUEUED=='1')){this.__timeout=setTimeout(function(){this.__update();}.bind(this),5000);this._add_destructor('__destructor');}};_me.__dimensions=function(sDim){var dim;if(sDim){var tmp=parseURL(sDim);if(tmp.tw>0){dim={w:tmp.tw,h:tmp.th};}
else
if(tmp.ow>0){if(tmp.o>4)
dim={w:tmp.oh,h:tmp.ow};else
dim={w:tmp.ow,h:tmp.oh};}}
return dim;};_me._preview_image=function(src,aSizeInfo){if(!this._destructed&&src&&this._getAnchor('preview')){var bVid=this.__aData.CORE_LINKINFO&&this.__aData.CORE_LINKINFO['type']==2&&this.__aData.CORE_LINKINFO.videourl&&!this.__options.novideo,w=bVid?500:150,h=bVid?281:600;src+='&'+buildURL({'resize':1,'width':w,'height':h});if(aSizeInfo){var aDim=this.__dimensions(aSizeInfo);if(aDim){var bScroll=false;if(this.__list&&this.__list.__body){var pos1=getSize(this.__list.__body),pos2=getSize(this._main),bScroll=(pos1.y+pos1.h>pos2.y+pos2.h),mh=this._main.offsetHeight;}
if(bVid){this._getAnchor('preview').style.height=h+'px';this._getAnchor('preview').style.width=w+'px';}
else
this._getAnchor('preview').firstElementChild.style.height=Math.round(aDim.h/(aDim.w/w))+'px';if(bScroll)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-mh));}}
var img=new Image();img.onload=function(){try{if(!this._destructed){if(bVid){this._getAnchor('preview').style.backgroundImage='url("'+img.src+'")';}
else{var ePrev=this._getAnchor('preview'),bScroll=false,bSafari=false,h=this._main.offsetHeight;if(this.__list&&this.__list._scroll){var pos1=getSize(this.__list.__body),pos2=getSize(this._main);if((bScroll=(pos1.y+pos1.h>=pos2.y+pos2.h)))
bSafari=window.navigator&&window.navigator.browser&&window.navigator.browser.application&&window.navigator.browser.application.toLowerCase()=='safari';}
if(!this.__preview){this.__preview=mkElement('img');ePrev.firstElementChild.appendChild(this.__preview);}
removecss(ePrev,'ico','ico');if(img.naturalHeight&&img.naturalWidth){this.__preview.style.maxHeight=img.naturalHeight+'px';this.__preview.style.maxWidth=img.naturalWidth+'px';}
if(bScroll&&bSafari){this.__preview.onload=function(){try{if(!this._destructed){ePrev.firstElementChild.style.height='auto';if(this._main.offsetHeight-h!=0)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-h));}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);}
this.__preview.src=img.src;if(!bSafari){ePrev.firstElementChild.style.height='auto';if(bScroll&&this._main.offsetHeight-h!=0)
this.__list._scrollBy(Math.abs(this._main.offsetHeight-h));}}}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);img.src=src;}};_me.__destructor=function(){if(this.__timeout){window.clearTimeout(this.__timeout);delete this.__timeout;}};

/* client/inc/obj_groupchat_pin.js */
_me=obj_groupchat_pin.prototype;function obj_groupchat_pin(){};_me.__constructor=function(aData){if(aData.EVNLINKEXTRAS){var ext=parseURL(aData.EVNLINKEXTRAS);if(aData.EVNCLASS=='B'){var aItmData=clone(aData,true);for(var k in ext)
if(ext.hasOwnProperty(k))
aItmData[k.toUpperCase()]=ext[k];aItmData.iid=WMItems.__clientID(aData.EVNLINKID);delete aItmData.EVNLINKEXTRAS;this._create('item','obj_groupchat_message','addon','',aItmData);}
else
{var aItmData={aid:aData.aid,fid:aData.fid,iid:WMItems.__clientID(aData.EVNLINKID)};for(var k in ext)
if(ext.hasOwnProperty(k))
aItmData[k.toUpperCase()]=ext[k];delete aItmData.EVNCOMLINKEXTRAS;switch(aItmData.EVNCLASS){case'Y':this._create('item','obj_groupchat_mail','addon','',aItmData);break;case'Z':case'R':this._create('item','obj_groupchat_file','addon','',aItmData);break;case'Q':this._create('item','obj_groupchat_event','addon','',aItmData);break;case'S':this._create('item','obj_groupchat_conference','addon','',aItmData);break;case'W':this._create('item','obj_groupchat_invite','addon','',aItmData);break;}}}};_me._init_reactions=function(){this.item._init_reactions.apply(this.item,arguments);};_me.__update=function(){this.item.__update.apply(this.item,arguments);};

/* client/inc/obj_groupevents.js */
_me=obj_groupevents.prototype;function obj_groupevents(){};_me.__constructor=function(){this.__options.notify=['E','Q'];this.__weekOffset=({monday:6,tuesday:5,wednesday:4,thursday:3,friday:2,saturday:1,sunday:0})[GWOthers.getItem('CALENDAR_SETTINGS','week_begins')];this._placeholder('CHAT::NOEVENTS');};_me._request=function(bUpdate){if(this.__aRequestData.folder){this.__loading=1;var d=new IcewarpDate().subtract(1,'day');var aFilter={sort:'EVNSTARTDATE asc, EVNSTARTTIME asc, EVNTITLE asc',limit:this.__options.preload,search:'gchat:events and after:'+d.format('YYYY/MM/DD')};if(this.__aRequestData.offset)
aFilter.offset=this.__aRequestData.offset;if(this.__aRequestData.filter&&this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:['EVN_ID','EVNRCR_ID','EVNTITLE','EVN_MODIFIED','EVNCLASS','EVNSTARTDATE','EVNSTARTTIME','EVNENDDATE','EVNENDTIME','OSD','EVNLOCATION'],filter:aFilter};if(bUpdate){if(!this._refresh()){var me=this;WMItems.list(aItemsInfo,'','','',[function(aData){var aData=aData[me.__aRequestData.folder.aid];if((aData=aData[me.__aRequestData.folder.fid])){if(me.__loading==1)
me.__loading=0;me.__check_count(parseInt(aData['/']));}}]);}
else
if(this.__loading==1)
this.__loading=0;}
else
WMItems.list(aItemsInfo,'','','',[this,'_response']);}};_me._response=function(aData,bUpdate,bSkipTime){if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData[this.__aRequestData.folder.fid])){if(!this.__check_count(parseInt(aData['/'])))
return;this.__aRequestData.offset=!+aData['/']?0:aData['$'];delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,row,d;for(var iid in aData){c++;if(this.__aData[iid])continue;aData[iid].EVNSTARTDATE=parseInt(aData[iid].EVNSTARTDATE);aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};d=IcewarpDate.julian(aData[iid].EVNSTARTDATE);var sep='',bToday=d.isToday();if(d.isTomorrow())sep=getLang('CALENDAR::TOMORROW');else
if(d.isToday())sep=getLang('CALENDAR::TODAY');else
if(d.isYesterday())sep=getLang('CALENDAR::YESTERDAY');else
if(d.isThisWeek(this.__weekOffset))sep=getLang('CALENDAR::THIS_WEEK');else
if(d.isNextWeek(this.__weekOffset))sep=getLang('CALENDAR::NEXT_WEEK');else
if(d.isThisMonth())sep=getLang('CALENDAR::THIS_MONTH');else
sep=d.format('MMMM YYYY');if(this.__sep1.sep!=sep){if(!bToday)
this._separator('<span>'+sep+'</span>');this.__sep1={sep:sep,today:bToday};}
row=false;switch(aData[iid].EVNCLASS){case'E':row=this._row('','',iid);this.__aData[iid].anchor=row.anchor;this.__aData[iid].obj=this._create('item','obj_groupevents_item',row.anchor,'',this.__aData[iid].data);break;}}
if(!bSkipTime){if(c==this.__options.preload)
this.__loading=0;else
this.__loading=2;}}
else
if(!aData){this._clear(true);return;}
if(!bUpdate||this.__aRequestData.fetchnew)
this._fetch();};_me._onnotify=function(aData){var iid;if(aData['ITEM-TYPE']=="Q"){if(aData.ACTION=='delete'&&aData.LINKID)
iid=WMItems.__clientID(aData.LINKID);else
return;}
else
iid=WMItems.__clientID(aData.ITEM);switch(aData.ACTION){case'add':if(!this.__aData[iid])
this.__check_count();break;case'update':if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update)
this.__aData[iid].obj.__update(true);break;case'delete':if(this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);}};_me._oncontext=function(e,elm){var id,aData;if((elm=Is.Child(elm,'SECTION',this._main))&&(id=elm.getAttribute('rel'))&&this.__aData[id]&&(aData=this.__aData[id].data)){var me=this;addcss(elm,'active');this.cmenu=gui._create("cmenu","obj_context",'','');this.cmenu._fill([{title:'FORM_BUTTONS::REMOVE',css:'color2',arg:[function(){me._removeItem(aData,elm);}],disabled:!(aData.EVNOWNEREMAIL==sPrimaryAccount||WMFolders.getAccess({aid:me.__aRequestData.folder.aid,fid:me.__aRequestData.folder.fid},'remove'))}]);this.cmenu._place(e.clientX,e.clientY);this.cmenu._onclose=function(){removecss(elm,'active');};return false;}};

/* client/inc/obj_groupevents_item.js */
_me=obj_groupevents_item.prototype;function obj_groupevents_item(){};_me.__constructor=function(aData){this.__fill(aData);};_me.__fill=function(aData){this._clean();var me=this;this.__aData=aData;this.__aData.iid=WMItems.__clientID(aData.EVN_ID);var d1=IcewarpDate.julian(aData.EVNSTARTDATE);d1.setTime(Math.max(0,aData.EVNSTARTTIME),true);var out=clone(aData,true);out.day=d1.date();out.date=d1.format('L LT');if(out.EVNACCEPTEDPARTICIPANTCOUNT>'0'){out.attendee=getLang('CHAT::PEOPLE',[out.EVNACCEPTEDPARTICIPANTCOUNT]);}
if(aData.EVNENDDATE){var d2=IcewarpDate.julian(aData.EVNENDDATE);d2.setTime(Math.max(0,aData.EVNENDTIME),true);out.duration=IcewarpDate.duration(d2.diff(d1)).humanize();out.fulltime=out.date+' - '+d2.format('L LT');}else{out.fulltime=out.date;}
this._draw('obj_groupevents_item','main',{item:out});this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(Is.Child(elm,me._getAnchor('control'),this))
return;Item.openwindow([me.__aData.aid,me.__aData.fid,me.__aData.iid],null,me.__aData,'E',[me,'__update']);};if(out.EVNMYSTATUS=='A'||out.EVNMYSTATUS=='D'){removecss(this.btn_accept._main,'color3');this.btn_accept._value(out.EVNMYSTATUS=='A'?'FORM_BUTTONS::ACCEPTED':'FORM_BUTTONS::DECLINED');}
this.btn_accept._disabled(sPrimaryAccountGUEST===1);this.btn_accept._onclick=function(e){if(!me.cmenu||me.cmenu._destructed){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();var pos=getSize(this._main);me.cmenu=gui._create('cmenu','obj_context');me.cmenu._fill([{title:'FORM_BUTTONS::ACCEPT',arg:[me,'_action',['accept']],disabled:out.EVNMYSTATUS=='A'},{title:'FORM_BUTTONS::DECLINE',arg:[me,'_action',['decline']],disabled:out.EVNMYSTATUS=='D'}]);me.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);return false;}};};_me._action=function(name){var me=this,aItem={aid:me.__aData.aid,fid:me.__aData.fid,iid:me.__aData.iid};if(!this.__aData.EVNRCR_ID)
this.btn_accept._disabled(true);switch(name){case'decline':if(me.__aData.EVNRCR_ID){gui._create('frm_confirm','frm_confirm_repeating','','',[function(iState){var frm=gui._create('decline','frm_text','','frm_ok_cancel',[function(s){aItem.reason=s;aItem.gwparams={};switch(+iState){case 2:aItem.EXPFOLLOWING='true';case 0:aItem.EXPDATE=me.__aData.EVNSTARTDATE;}
WMItems.imip(aItem,name,[function(){me.__update(true);}]);}],'EVENT::REASON');frm._onclose=function(){me.btn_accept._disabled(false);};frm.x_btn_ok._value('FORM_BUTTONS::DECLINE');}],'REPEATING_CONFIRM::TITLE_DELETE','REPEATING_CONFIRM::TEXT_DELETE');}else{var frm=gui._create('decline','frm_text','','frm_ok_cancel',[function(s){aItem.reason=s;WMItems.imip(aItem,name,[function(){me.__update(true);}]);}],'EVENT::REASON');frm._onclose=function(){me.btn_accept._disabled(false);};frm.x_btn_ok._value('FORM_BUTTONS::DECLINE');}
break;case'accept':WMItems.imip(aItem,name,[function(){me.__update(true);}]);}};_me.__update=function(bOK){if(bOK==true){var me=this;WMItems.list({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid},'','','',[function(aData){if(aData&&(aData=aData[me.__aData.aid])&&(aData=aData[me.__aData.fid])&&(aData=aData[me.__aData.iid])){if(aData.EVNSTARTDATE!=me.__aData.EVNSTARTDATE||aData.EVNSTARTTIME!=me.__aData.EVNSTARTTIME){me._parent._serverSort(me._parent.__aRequestData.folder,true);return;}
me.__fill(aData);}
else
me._parent._remove(me._anchor,me.__aData.iid);}]);if(this._parent&&!this._parent._destructed)
this._parent._serverSort();}};

/* client/inc/obj_groupfiles.js */
_me=obj_groupfiles.prototype;function obj_groupfiles(){};_me.__constructor=function(){this.__options.notify=['F','M','-'];this._placeholder('CHAT::NOFILES');};_me._onnotify=function(aData){var iid=WMItems.__clientID(aData.ITEM);switch(aData.ACTION){case'add':if(!this.__aData[iid])
this.__check_count();break;case'delete':if(this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);break;case'lock':case'unlock':case'update':case'edit':if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update)
this.__aData[iid].obj.__update(true);}};_me._request=function(bUpdate){if(this.__aRequestData.folder){this.__loading=1;var aOrder=Cookie.get(['folders',this.__aRequestData.folder.aid,this.__aRequestData.folder.fid,'files','sort'])||'EVN_MODIFIED';var aSort=Cookie.get(['folders',this.__aRequestData.folder.aid,this.__aRequestData.folder.fid,'files','sortdir'])||'desc';var aFilter={sort:aOrder+' '+aSort,limit:this.__options.preload,search:'gchat:files'};if(this.__aRequestData.offset)
aFilter.offset=this.__aRequestData.offset;if(this.__aRequestData.filter)
if(this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:['EVN_ID','EVNTITLE','EVN_MODIFIED','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVNCOMPLETE','EVNLOCKOWN_EMAIL','EVNLOCKOWN_ID','EVNFLAGS'],filter:aFilter};if(bUpdate){if(!this._refresh()){var me=this;WMItems.list(aItemsInfo,'','','',[function(aData){var aData=aData[me.__aRequestData.folder.aid];if((aData=aData[me.__aRequestData.folder.fid])){me.__check_count(parseInt(aData['/']));}}]);}}
else
WMItems.list(aItemsInfo,'','','',[this,'_response']);}};_me._response=function(aData,bUpdate,bSkipTime){if(this.__bSearch){this._placeholder('CHAT::SEARCHNOFILES');this.__bSearch=false;}else{this._placeholder('CHAT::NOFILES');}
if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData[this.__aRequestData.folder.fid])){if(!this.__check_count(parseInt(aData['/'])))
return;delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,row;for(var iid in aData){c++;if(this.__aData[iid])continue;aData[iid].EVN_MODIFIED=parseInt(aData[iid].EVN_MODIFIED);aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};row=false;switch(aData[iid].EVNCLASS){case'M':case'F':row=this._row('','',iid);this.__aData[iid].anchor=row.anchor;this.__aData[iid].obj=this._create('item','obj_groupfiles_item',row.anchor,'',this.__aData[iid].data);break;}}
if(!bSkipTime){if(c==this.__options.preload)
this.__loading=0;else
this.__loading=2;this.__aRequestData.offset+=c;}}
else
if(!aData){this._clear(true);return;}
if(!bUpdate||this.__aRequestData.fetchnew)
this._fetch();};_me._oncontext=function(e,elm){var id,aData;if((elm=Is.Child(elm,'SECTION',this._main))&&(id=elm.getAttribute('rel'))&&this.__aData[id]&&(aData=this.__aData[id].data)){addcss(elm,'active');var me=this,arr=[];switch(Path.extension(aData.EVNTITLE)){case'txt':case'htm':case'html':arr.push({"title":'POPUP_ITEMS::OPEN','arg':[Item.editFile,[aData]]});break;case'pdf':arr.push({"title":'POPUP_ITEMS::OPEN','arg':[Item.openPDF,[aData]]});break;case'mp3':if(gui.audio)
arr.push({"title":'ATTACHMENT::PLAY_SOUND','arg':[Item.playFile,[aData]]});break;default:if(Item.officeSupport(aData.EVNTITLE)){var aArgAuto=[Item.officeOpen,[aData,[Item.downloadFile,[[aData.aid,aData.fid,aData.iid]]],Path.extension(aData.EVNTITLE)]];var aArgWeb=[Item.officeOpen,[aData,[Item.downloadFile,[[aData.aid,aData.fid,aData.iid]]],Path.extension(aData.EVNTITLE)]];var aArgWebView=[Item.officeOpen,[aData,[Item.downloadFile,[[aData.aid,aData.fid,aData.iid]]],Path.extension(aData.EVNTITLE),'view']];var aArgExt=[Item.officeOpen,[aData,[Item.downloadFile,[[aData.aid,aData.fid,aData.iid]]],Path.extension(aData.EVNTITLE),'external']];var bIWD=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';arr.push({title:'POPUP_ITEMS::OPEN',arg:aArgAuto,'nodes':[{"title":'DOCUMENT::OPENDOCUMENT','arg':aArgWeb,disabled:!bIWD},{"title":'DOCUMENT::OPENDOCUMENTVIEW','arg':aArgWebView,disabled:!bIWD},{"title":'OFFICELAUNCHER::OFFICESUITE','arg':aArgExt}]});}}
if(e.target&&e.target.nodeName=='INPUT'){if(hascss(e.target,'obj_input')&&'select'in e.target)
arr.push({title:'RICH::COPY',arg:[function(){if(e&&e.target){e.target.select();try{document.execCommand('copy');gui.notifier&&gui.notifier._value({type:'clipboard_link'});}catch(err){gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::CLIPBOARD'}});}}}]});else
return false;}
else{arr.push({title:'FORM_BUTTONS::RENAME',arg:[function(){me._editItem(id);}],disabled:!(aData.EVNOWNEREMAIL==sPrimaryAccount||WMFolders.getAccess({aid:me.__aRequestData.folder.aid,fid:me.__aRequestData.folder.fid},'modify'))},{title:'-'},{title:'FORM_BUTTONS::REMOVE',css:'color2',arg:[function(){if(aData.EVNLOCKOWN_ID&&aData.EVNLOCKOWN_ID!==sPrimaryAccountGWID){var frm=gui._create('remove','frm_confirm_threestates','','noblur',[function(){TeamChatAPI.requestUnlock(aData.fid,aData.EVNTITLE,aData.EVNLOCKOWN_EMAIL,'remove');}.bind(this)],'CONFIRMATION::DELETE_ITEM_CONFIRMATION','CONFIRMATION::DELETE_LOCKED_ITEM',[aData.EVNLOCKOWN_EMAIL]);frm.x_btn_ok._value('DOCUMENT::REQUEST_UNLOCK');frm.x_btn_cancel._value('FORM_BUTTONS::REMOVE');frm.x_btn_cancel._onclick=function(){frm._destruct();me._removeItem(aData,elm);};addcss(frm.x_btn_cancel._main,'color2');return;}
me._removeItem(aData,elm);}],disabled:!(aData.EVNOWNEREMAIL==sPrimaryAccount||WMFolders.getAccess({aid:me.__aRequestData.folder.aid,fid:me.__aRequestData.folder.fid},'remove'))});}
this.cmenu=gui._create("cmenu","obj_context",'','');this.cmenu._fill(arr);this.cmenu._place(e.clientX,e.clientY);this.cmenu._onclose=function(){removecss(elm,'active');};return false;}};

/* client/inc/obj_groupfiles_item.js */
_me=obj_groupfiles_item.prototype;function obj_groupfiles_item(){};_me.__constructor=function(aData){var me=this;this.__aData=aData;var d=(new IcewarpDate(aData.EVN_MODIFIED*1000)),out=clone(aData,true);out.size=parseFileSize(out.EVNCOMPLETE);out.fulltime=d.format('L LT');out.date=getLang('CHAT::FILE_MODIFY',[CalendarFormatting.normalWithTime(d),'']);out.avatar='<span style="background-image: url(\''+getAvatarURL(aData.EVNMODIFIEDOWNEREMAIL)+'\')"></span>';out.modified_name=out.EVNMODIFIEDOWNERNAME||out.EVNMODIFIEDOWNEREMAIL;out.draft=this.__aData.EVNFLAGS&128;if(out.EVNCLASS=='M'){out.ext='eml';}
else
out.ext=Path.extension(aData.EVNTITLE);if(out.ext)
out.ext='ico_'+out.ext;out.EVNTITLE=out.EVNTITLE||getLang('EVENT_VIEW::NOTITLE');this._draw('obj_groupfiles_item','main',{item:out});var eLock=this._getAnchor('lock');if(!eLock)
return;if(this.__aData.EVNLOCKOWN_ID){switch(this.__aData.EVNLOCKOWN_ID){case sPrimaryAccountGWID:addcss(eLock,'locked');eLock.title=getLang('FILE::LOCKED_BY_ME');eLock.onclick=function(){Item.set_lock([aData.aid,aData.fid,aData.iid],false,false,null,'I');};break;default:addcss(eLock,'locked','red');if(this.__aData.EVNLOCKOWN_EMAIL){eLock.title=getLang('FILE::LOCKED_BY',[this.__aData.EVNLOCKOWN_EMAIL.escapeHTML()]);eLock.onclick=function(){NewMessage.compose({to:aData.EVNLOCKOWN_EMAIL,subject:aData.EVNTITLE});};}
else{eLock.title=getLang('FILE::LOCKED');}}}
else{eLock.onclick=function(){Item.set_lock([aData.aid,aData.fid,aData.iid],true,false,null,'I');};}
this._getAnchor('icon').onclick=this._getAnchor('name').onclick=function(){if(hascss(me._main,'edit'))return;if(out.EVNCLASS=='M'){var aLockInfo={EVNLOCKOWN_EMAIL:me.__aData.EVNLOCKOWN_EMAIL,EVNLOCKOWN_ID:me.__aData.EVNLOCKOWN_ID,EVNTITLE:out.EVNTITLE,draft:me.__aData.EVNFLAGS&128,id:me.__aData.iid};OldMessage.openwindow([aData.aid,aData.fid,aData.iid+'|@@MAIN@@'],null,aLockInfo);}
else
if(out.EVNTICKET&&Path.extension(aData.EVNTITLE)=='pdf'&&GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')!=1&&!currentBrowser().match(/^MSIE([6-9]|10)$/))
gui._create('pdf','frm_pdf')._load(out.EVNTICKET,aData.EVNTITLE);else
if(out.EVNTICKET&&Item.imageSupport(aData.EVNTITLE)){var img=gui._create('imgview','frm_imgview');img._fill([{url:out.EVNTICKET,title:aData.EVNTITLE}]);img._value(0);}
else
if(Item.editSupport(aData.EVNTITLE)){Item.editFile([aData.aid,aData.fid,aData.iid]);}
else
if(Item.officeSupport(aData.EVNTITLE))
Item.officeOpen(aData,[me,'_download'],Path.extension(aData.EVNTITLE));else
me._download();};this._main.querySelector('.control>.share').onclick=function(){Item.collaborate([aData.aid,aData.fid,[aData.iid]]);};this._main.querySelector('.control>.download').onclick=function(){this._download();}.bind(this);};_me._download=function(){if(this.__aData.EVNTICKET)
downloadItem(this.__aData.EVNTICKET,true);else
Item.downloadFile([this.__aData.aid,this.__aData.fid,this.__aData.iid]);};_me._share=function(b){if(b){addcss(this._main,'share');this.email._focus();}
else{removecss(this._main,'share');this.share._focus();}};_me._send=function(){var me=this,email=MailAddress.splitEmailsAndNames(this.email._value());if(!this.send._disabled()&&email&&(email=email[0])&&(email=email.email)){this.email._disabled(true);this.send._disabled(true);WMItems.action({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:{EMAIL:email}},'notify_groupchat',[function(bOK){if(bOK){me._share(false);me.email._value('');gui.notifier._value({type:'message_sent'});}
me.email._disabled(false);me.send._disabled(false);if(!bOK){me.email._select();}}]);}};_me._edit=function(b){if(b){if(!this.inp_edit){addcss(this._main,'edit');var inp=this._create('inp_edit','obj_input','name','obj_input_100 noborder');inp._value(this.__aData.EVNTITLE);inp._setRange(0,Math.ceil(this.__aData.EVNTITLE.lastIndexOf('.'))||this.__aData.EVNTITLE.length);inp._onblur=function(){this._onsubmit();};inp._onsubmit=function(){var v=this.inp_edit._value();if(v&&Is.Filename(v)&&this.__aData.EVNTITLE!==v){this.__aData.EVNTITLE=v;this._getAnchor('name').querySelector('.filename').innerHTML=v.escapeHTML();this._edit(false);var aItemInfo={values:{EVNTITLE:v}};WMItems.add([this.__aData.aid,this.__aData.fid,this.__aData.iid],aItemInfo,'','','',[function(bOK){if(bOK===true){this._parent._fire(this.__aData.iid,'update');}
else
this._getAnchor('name').querySelector('.filename').innerHTML=this.__aData.EVNTITLE.escapeHTML();}.bind(this)]);}
else
this._edit(false);}.bind(this);inp._onclose=function(){this._parent._edit();};}}
else{if(this.inp_edit){this.inp_edit._destruct();}
removecss(this._main,'edit');}};_me.__update=function(){var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid,values:['EVN_ID','EVNTITLE','EVNCLASS','EVNTICKET','EVN_MODIFIED','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVNCOMPLETE','EVNLOCKOWN_EMAIL','EVNLOCKOWN_ID','EVNFLAGS']};WMItems.list(aItemsInfo,'','','',[function(aData){this._edit(false);if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){for(var k in aData)
this.__aData[k]=aData[k];this.__constructor(this.__aData);}}.bind(this)]);};

/* client/inc/obj_groupmembers.js */
_me=obj_groupmembers.prototype;function obj_groupmembers(){};_me.__constructor=function(){this.__options.notify=['-'];this.__skin=GWOthers.getItem('LAYOUT_SETTINGS','skin')||'default';};_me._request=function(bUpdate){if(this.__aRequestData.folder){this.__loading=1;var aFilter={sort:'FRTISGUEST desc, FRTNAME asc, FRTEMAIL asc',limit:this.__options.preload};if(this.__aRequestData.offset)
aFilter.offset=this.__aRequestData.offset;if(this.__aRequestData.filter&&this.__aRequestData.filter.search)
aFilter.search=this.__aRequestData.filter.search;var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:'__@@GROUP@@__/'+this.__aRequestData.folder.fid,values:[],filter:aFilter};if(bUpdate){if(!this._refresh()){var me=this;WMItems.list(aItemsInfo,'','','',[function(aData){var aData=aData[me.__aRequestData.folder.aid];if((aData=aData['__@@GROUP@@__/'+me.__aRequestData.folder.fid])){if(me.__loading==1)
me.__loading=0;me.__check_count(parseInt(aData['/']));}}]);}
else
if(me.__loading==1)
me.__loading=0;}
else
WMItems.list(aItemsInfo,'','','',[this,'_response']);}};_me._response=function(aData,bUpdate){if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData['__@@GROUP@@__/'+this.__aRequestData.folder.fid])){if(!this.__check_count(parseInt(aData['/'])))
return;delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,row;for(var iid in aData){c++;if(this.__aData[iid])continue;aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};var sep='';if(aData[iid].FRTISGUEST>'0')
sep=getLang('CHAT::GUESTS');else
if(aData[iid].FRTISADMIN>'0')
sep=getLang('CHAT::ADMINS');else
sep=getLang('CHAT::MEMBERS');if(this.__sep1.sep!=sep){this._separator('<span>'+sep+'</span>');this.__sep1={sep:sep};}
row=this._row(this.__item(this.__aData[iid].data),'',iid);this.__aData[iid].anchor=row.anchor;}
if(c==this.__options.preload)
this.__loading=0;else
this.__loading=2;this.__aRequestData.offset+=c;}
else
if(!aData){this._clear(true);return;}
if(!bUpdate||this.__aRequestData.fetchnew)
this._fetch();if(sPrimaryAccountIM){addcss(this._main,'im');if(gui.socket.xmpp._user_status()!='offline')
addcss(this._main,'im_active');this._listen('xmpp',true);}};_me.__item=function(aData){var out=clone(aData,true);out.avatar=getAvatarURL(aData.FRTEMAIL);out.name=out.FRTNAME||out.FRTEMAIL;out.fullname=MailAddress.createEmail(out.FRTNAME,out.FRTEMAIL,true).entityify();out.guest=out.FRTISGUEST>'0';out.admin=out.FRTISADMIN>'0';out.hasim=out.FRTEMAIL!=sPrimaryAccount&&dataSet.get('xmpp',['roster',out.FRTEMAIL]);out.confirmed=out.FRTISGUEST!='2';out.guest_user=sPrimaryAccountGUEST;if(!out.guest&&sPrimaryAccountIM&&gui.socket&&gui.socket.xmpp&&gui.socket.xmpp._user_status()!='offline')
out.im=gui.socket.xmpp._user_status(out.FRTEMAIL);return template.tmp('obj_groupmembers_item',{item:out,has_kick_right:WMFolders.getRights(this.__aRequestData.folder).kick&&(aData.FRTEMAIL!==sPrimaryAccount)});};_me.__item_status=function(id){if(this.__aData[id]&&Is.Defined(this.__aData[id].anchor)){var elm=this._getAnchor(this.__aData[id].anchor);if(elm&&(elm=elm.getElementsByTagName('DIV')[1]))
elm.className='avatar unselectable '+gui.socket.xmpp._user_status(WMItems.__serverID(id));}};_me.__update=function(sDName,aDPath){if(sDName!='xmpp'||!aDPath)
return;switch(aDPath[0]){case'roster':if(aDPath[1]){if((!aDPath[2]||aDPath[2]=='show')){this.__item_status(WMItems.__clientID(aDPath[1]));}}
else{for(var id in this.__aData){this.__item_status(id);}}
break;case'status':if(gui.socket.xmpp._user_status()=='offline')
removecss(this._main,'im_active');else
addcss(this._main,'im_active');this.__item_status(WMItems.__clientID(sPrimaryAccount));}};_me._onnotify=function(aData){var iid=WMItems.__clientID(aData.ITEM);if(aData.TYPE=='acl')
switch(aData.ACTION){case'update':if(this.__aData[iid])
this.__check_count();break;case'add':if(!this.__aData[iid])
this.__check_count();break;}};

/* client/inc/obj_groupmentions.js */
_me=obj_groupmentions.prototype;function obj_groupmentions(){};_me.__constructor=function(){this.__options.notify=['Q','R','Y','I','F','E','Z','-'];this.__options.preload=15;this.__aDataLink={};};_me._request=function(bUpdate){if(this.__aRequestData.folder){if(!this.loader){this._main.insertBefore(this._create('loader','obj_loader','')._main,this._main.firstChild);this._main.querySelector('.placeholder').style.setProperty('display','none');}
this.__loading=1;var aFilter={limit:this.__options.preload};if(this.__options.type=='mentions'){aFilter.sort='EVN_ID desc';aFilter.search='gchat:mentions';}
else{aFilter.sort='PIN_ID desc';aFilter.search='gchat:'+this.__options.type;}
if(this.__aRequestData.offset)
aFilter.offset=this.__aRequestData.offset;if(this.__aRequestData.filter){if(this.__aRequestData.filter.sys_search)
aFilter.search+=' and ('+this.__aRequestData.filter.sys_search+')';if(this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';}
var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:['EVN_ID','EVN_CREATED','EVN_MODIFIED','EVNSHARETYPE','EVNLINKEXTRAS','EVNURL','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED'],filter:aFilter};if(bUpdate){if(!this._refresh()){WMItems.list(aItemsInfo,'','','',[function(aData){var aData=aData[this.__aRequestData.folder.aid];if((aData=aData[this.__aRequestData.folder.fid]))
this.__check_count(parseInt(aData['/']));}.bind(this)]);}}
else
WMItems.list(aItemsInfo,'','','',[this,'_response']);}};_me._response=function(aData,bUpdate,bSkipTime){if(this._destructed)return;if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData[this.__aRequestData.folder.fid])){if(this.loader){this.loader._main&&this.loader._main.style.setProperty('display','none');this._main.querySelector('.placeholder').style.setProperty('display','');}
if(!this.__check_count(parseInt(aData['/'])))
return;this.__aRequestData.offset=aData['/']=='0'?'':parseInt(aData['$']);delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,row,d=new IcewarpDate();for(var iid in aData){c++;if(this.__aData[iid])continue;aData[iid].EVN_CREATED=parseInt(aData[iid].EVN_CREATED);aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};d=IcewarpDate.unix(aData[iid].EVN_CREATED);var sep=CalendarFormatting.normal(d),bToday=d.isToday();if(this.__sep1.sep!=sep){if(!bToday)
this._separator('<span>'+sep+'</span>',bToday?'today':'');this.__sep1={sep:sep,today:bToday};}
row=false;switch(aData[iid].EVNCLASS){case'I':case'Q':case'R':case'Y':case'Z':row=this._row('','',iid);this.__aData[iid].anchor=row.anchor;this.__aData[iid].obj=this._create('item','obj_groupmentions_item',row.anchor,'',this.__aData[iid].data);break;}
if(aData[iid].EVNLINKID){var cid=WMItems.__clientID(aData[iid].EVNLINKID);if(cid!=iid)
if(this.__aDataLink[cid]){if(inArray(this.__aDataLink[cid],iid)<0)
this.__aDataLink[cid].push(iid);}
else
this.__aDataLink[cid]=[iid];}}
if(!bSkipTime){if(c==this.__options.preload)
this.__loading=0;else
this.__loading=2;this.__aRequestData.offset+=c;}}
else
if(!aData){this._clear(true);return;}
if(!bUpdate||this.__aRequestData.fetchnew)
this._fetch();};_me._onnotify=function(aData){var cid=WMItems.__clientID(aData.ITEM),arr=[cid];if(Is.Array(this.__aDataLink[cid]))
arr=arr.concat(this.__aDataLink[cid]);for(var iid,i=0;i<arr.length;i++){iid=arr[i];if(aData['ITEM-TYPE']=='-'){if(aData.TYPE==='gw-queue'||aData.TYPE==='gw-queue-failure'){if(aData.ACTION==='add')
aData.ACTION='update';}
else
return;}
switch(aData.ACTION){case'add':if(this.__options.type=='mentions'&&aData.MENTIONS&&!this.__aData[iid])
this.__check_count();break;case'add_mention':if(this.__options.type=='mentions'){if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update)
this.__aData[iid].obj.__update(true);else
this.__check_count();}
break;case'delete':if(this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);break;case'update':if(this.__aData[iid]&&this.__aData[iid].obj&&this.__aData[iid].obj.__update)
this.__aData[iid].obj.__update(true);case"add_pin":if(!this.__aData[iid])
this.__check_count();break;case"add_global_pin":if(this.__options.type=='global_pins'&&!this.__aData[iid])
this.__check_count();break;case"delete_pin":if(this.__options.type=='my_pins'&&this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);break;case"delete_global_pin":if(this.__options.type=='global_pins'&&this.__aData[iid])
this._remove(this.__aData[iid].anchor,iid);break;}}};_me._oncontext=function(e,elm){var id;if((elm=Is.Child(elm,'SECTION',this._main))&&(id=elm.getAttribute('rel'))&&this.__aData[id]&&(aData=this.__aData[id].data)){return false;}};_me._onremove=function(iAnchor,sData_id,bFire){if(this.__aDataLink&&this.__aDataLink[sData_id])
delete this.__aDataLink[sData_id];if(this.__aData&&this.__aData[sData_id])
delete this.__aData[sData_id];};

/* client/inc/obj_groupmentions_item.js */
_me=obj_groupmentions_item.prototype;function obj_groupmentions_item(){};_me.__constructor=function(aData,sType){this.__fill(aData);};_me.__fill=function(aData){this._clean();var me=this;this.__aData=aData;this.__aData.iid=WMItems.__clientID(aData.EVN_ID);var d=IcewarpDate.unix(aData.EVN_CREATED),out=clone(aData,true),parsed=parseURL(aData.EVN_METADATA);out.org_name=(aData.EVNMODIFIEDOWNERNAME&&aData.EVNMODIFIEDOWNERNAME!='0'?aData.EVNMODIFIEDOWNERNAME:aData.EVNMODIFIEDOWNEREMAIL)||parsed.core_own_name;out.action=getLang(this._parent.__options.type=='mentions'?'CHAT::MENTIONED':'CHAT::PINNED')+' <b>'+getLang({I:'CHAT::PIN_POST',Q:'CHAT::PIN_EVENT',R:'CHAT::PIN_FILE',Y:'CHAT::PIN_MAIL'}[aData.EVNCLASS]||'CHAT::PIN_POST')+'</b>:';out.org_time=d.format('LT');out.org_fulltime=d.format('L LT');if(this._parent.__options.type=='mentions'){d=IcewarpDate.unix(aData.EVN_MODIFIED||aData.EVN_CREATED);out.time=d.format('LT');out.fulltime=d.format('L LT');out.name=aData.MENWHOOWNNAME||aData.MENWHOOWNEMAIL;}
else{out.menu=true;if(this._parent.__options.type=='my_pins'){d=IcewarpDate.unix(aData.PINWHEN||aData.LPINWHEN);out.name=aData.PINOWNNAME||aData.PINOWNEMAIL||dataSet.get('main',['fullname'])||sPrimaryAccount;}
else{d=IcewarpDate.unix(aData.PINWHEN||aData.GPINWHEN);out.name=aData.PINOWNNAME||aData.PINOWNEMAIL||aData.GPINOWNNAME||aData.GPINOWNEMAIL;}
out.time=d.format('LT');out.fulltime=d.format('L LT');}
switch(aData.EVNCLASS){case'Q':if(aData.EVNLINKEXTRAS){out.addon={event:{}};linkextras=parseURL(aData.EVNLINKEXTRAS);if(linkextras){if(linkextras.EvnLinkInvalid=='1'){this._parent._remove(this._anchor,this.__aData.iid);return;}
out.addon.event.title=linkextras.EvnTitle||'';var a=IcewarpDate.julian(linkextras.EvnStartDate).setTime(linkextras.EvnStartTime);out.addon.event.date=a.format('LLLL');}}
if(!aData.EVNTHUMBNAILID)
out.preview='ico';break;case'Y':var linkextras={};if(aData.EVNLINKEXTRAS){linkextras=parseURL(aData.EVNLINKEXTRAS)||{};if(linkextras.EvnTicket){aData.EVNTITLE=linkextras.EvnTitle;var aFrom=MailAddress.splitEmailsAndNames(linkextras.EvnOrganizer);out.addon={mail:{subject:linkextras.EvnTitle,from:aFrom?aFrom[0].name||aFrom[0].email:''}};out.preview=linkextras.EvnThumbnailId?'':'ico ico_none ico_eml';}
if(linkextras.EvnThumbnailId){aData.EVNTHUMBNAILID=linkextras.EvnThumbnailId;aData.EVNTHUMBNAILTIME=linkextras.EvnThumbnailTime;}
else
if(linkextras.EvnProcessingQueued=='0'&&linkextras.EvnTicket&&Item.imageSupport(linkextras.EvnTitle))
aData.EVNTICKET=linkextras.EvnTicket;}
break;case'R':case'Z':var linkextras={};if(aData.EVNLINKEXTRAS){linkextras=parseURL(aData.EVNLINKEXTRAS)||{};if(linkextras.EvnTicket){aData.EVNTITLE=linkextras.EvnTitle;if(aData.EVNCLASS=='Z'){var ticketUrl=parseURL(linkextras.EvnTicket.split('#').pop());aData.EVNURL=document.location.origin+'/teamchatapi/files.download?'+buildURL({ticket:ticketUrl.ticket});}
else
aData.EVNURL=linkextras.EvnTicket;out.addon={file:{size:parseFileSize(linkextras.EvnComplete),filename:linkextras.EvnTitle,url:aData.EVNURL}};switch(Path.extension(linkextras.EvnTitle)){case'mp3':out.addon.play=true;break;case'wav':out.addon.play=!(window.ActiveXObject||"ActiveXObject"in window)&&!/^((?!chrome|android).)*safari/i.test(navigator.userAgent);}
out.preview=linkextras.EvnThumbnailId?'':'ico ico_none ico_'+Path.extension(linkextras.EvnTitle);}
if(linkextras.EvnThumbnailId){aData.EVNTHUMBNAILID=linkextras.EvnThumbnailId;aData.EVNTHUMBNAILTIME=linkextras.EvnThumbnailTime;}
else
if(linkextras.EvnProcessingQueued=='0'&&linkextras.EvnTicket&&Item.imageSupport(linkextras.EvnTitle))
aData.EVNTICKET=linkextras.EvnTicket;}
break;case'I':if(aData.EVNURL){out.subclass='link';var a=mkElement('A',{href:aData.EVNURL});out.addon={link:{url:a.hostname}};}
break;}
if(aData.EVNNOTE&&aData.EVNNOTE!=aData.EVNURL){storage.library('obj_groupchat_item');storage.library('obj_highlight');out.body=obj_highlight._highlight(obj_groupchat_item.prototype.__encode_body.call(this,aData.EVNNOTE,aData.MENTIONS,true));}
this._draw('obj_groupmentions_item','main',{item:out});[].forEach.call(this._main.querySelectorAll('.noclick'),function(elm){elm.onclick=function(e){var e=e||window.event;e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();return false;};});var m=this._getAnchor('menu');if(m){var aRights=WMFolders.getAccess([aData.aid,aData.fid]);m.onclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(!this.cmenu||this.cmenu._destructed){var pos=getSize(m),arr=[];switch(this._parent.__options.type){case'global_pins':arr.push({title:'CHAT::PIN_COPYTOMY',arg:[this,'_action',['add_pin']],disabled:!aRights.write},{title:'CHAT::PIN_REMOVE',css:'color2',arg:[this,'_action',['delete_global_pin']],disabled:!(aRights.modify||((aData.PINOWNEMAIL===sPrimaryAccount)&&aRights.write))});break;case'my_pins':arr.push({title:'CHAT::PIN_COPYTOGLOBAL',arg:[this,'_action',['add_global_pin']],disabled:!aRights.write},{title:'CHAT::PIN_REMOVE',css:'color2',arg:[this,'_action',['delete_pin']],disabled:!aRights.write});}
this.cmenu=gui._create('cmenu','obj_context');this.cmenu._fill(arr);this.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);this.cmenu._onclose=function(){removecss(this._main,'active');}.bind(this);addcss(this._main,'active');}
else
this.cmenu._destruct();return false;}.bind(this);}
if(this.btn_open)
this.btn_open._onclick=function(){aData.EVNURL&&window.open(aData.EVNURL);};if(this.btn_download)
this.btn_download._onclick=function(){aData.EVNURL&&downloadItem(aData.EVNURL,true);};if(this.btn_share)
this.btn_share._onclick=function(){Item.collaborate([aData.aid,aData.fid,[aData.EVNLINKID||aData.iid]]);};if(this.btn_info)
this.btn_info._onclick=function(){Item.openwindow([this.__aData.aid,this.__aData.fid,WMItems.__clientID(this.__aData.EVNLINKID)],'','','E',[this,'__update']);}.bind(this);if(this.btn_accept){if(linkextras.EvnMyStatus=='A'){this.btn_accept._value('ATTENDEES::STATUS_A');removecss(this.btn_accept._main,'select');}
else
if(linkextras.EvnMyStatus=='D'){this.btn_accept._value('ATTENDEES::STATUS_D');removecss(this.btn_accept._main,'select');}
else{this.btn_accept._disabled(false);this.btn_accept._onclick=function(e){if(!this.cmenu||this.cmenu._destructed){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();var pos=getSize(this._main);this.cmenu=gui._create('cmenu','obj_context');this.cmenu._fill([{title:'FORM_BUTTONS::ACCEPT',arg:[me,'_action',['accept']]},{title:'FORM_BUTTONS::DECLINE',arg:[me,'_action',['decline']]}]);this.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);return false;}};}}
if(aData.EVNTHUMBNAILID)
this._preview_image(aData.EVNTHUMBNAILID,aData.EVNTHUMBNAILTIME);else
if(aData.EVNTICKET)
this._preview_image('','',aData.EVNTICKET);else
if(!gui.socket&&(!Is.Defined(aData.EVNPROCESSINGQUEUED)||aData.EVNPROCESSINGQUEUED=='1')){this.__timeout=setTimeout(function(){this.__update();}.bind(this),5000);this._add_destructor('__destructor');}};_me._action=function(name){var aItem={aid:this.__aData.aid,fid:this.__aData.fid,iid:WMItems.__clientID(this.__aData.EVNLINKID)};switch(name){case'decline':this.btn_accept._disabled(true);var frm=gui._create('decline','frm_text','','frm_ok_cancel',[function(s){aItem.reason=s;WMItems.imip(aItem,name,[function(){if(!this._destructed)
this.__update(true);}.bind(this)]);}.bind(this)],'EVENT::REASON');frm._onclose=function(){if(this.btn_accept)
this.btn_accept._disabled(false);}.bind(this);frm.x_btn_ok._value('FORM_BUTTONS::DECLINE');break;case'accept':this.btn_accept._disabled(true);WMItems.imip(aItem,name,[function(){if(!this._destructed)
this.__update(true);}.bind(this)]);break;case"add_pin":case"add_global_pin":case"delete_pin":case"delete_global_pin":var aItem={aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid};WMItems.action(aItem,name,[function(bOK,aData){if(bOK){if(name==="add_global_pin"||name==="add_pin"){this._animate(getLang('CHAT::'+name.toUpperCase()));}
var arg={};if(name==="add_global_pin"&&aData.IQ&&aData.IQ[0].RESULT&&aData.IQ[0].RESULT[0].LAST_PINNED_ITEM){arg.LAST_PINNED_ITEM=aData.IQ[0].RESULT[0].LAST_PINNED_ITEM[0].VALUE;}
if(this._parent._fire(this.__aData.iid,name,arg)){return;}}else if(aData.IQ&&aData.IQ[0]&&aData.IQ[0].ERROR&&aData.IQ[0].ERROR[0]&&aData.IQ[0].ERROR[0].ATTRIBUTES&&aData.IQ[0].ERROR[0].ATTRIBUTES.UID){switch(aData.IQ[0].ERROR[0].ATTRIBUTES.UID){case'add_pin_already_exists':if(name==="add_global_pin"||name==="add_pin"){return gui.notifier._value({type:'pin_already_exists'});}
break;}}
this.__update(true);}.bind(this)]);}};_me.__update=function(bOK){if(bOK==true){WMItems.list({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.iid},'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[this.__aData.iid])){if(aData.EVNSTARTDATE!=this.__aData.EVNSTARTDATE||aData.EVNSTARTTIME!=this.__aData.EVNSTARTTIME){this._parent._serverSort(this._parent.__aRequestData.folder,true);return;}
this.__aData.MENWHOOWNNAME&&(aData.MENWHOOWNNAME=this.__aData.MENWHOOWNNAME);this.__aData.MENWHOOWNEMAIL&&(aData.MENWHOOWNEMAIL=this.__aData.MENWHOOWNEMAIL);if(this._parent.__options.type=='mentions'){var bRemove=true;if(aData.MENTIONS)
for(var id in aData.MENTIONS)
if(aData.MENTIONS[id].values.EMAIL==sPrimaryAccount){bRemove=false;break;}
if(bRemove){this._parent._remove(this._anchor,this.__aData.iid);return;}}
this.__fill(aData);}
else
this._parent._remove(this._anchor,this.__aData.iid);}.bind(this)]);if(this._parent&&!this._parent._destructed)
this._parent._serverSort();}};_me._preview_image=function(attid,tstamp,sSRC){if((attid||sSRC)&&this._getAnchor('preview')){var bVid=this.__aData.CORE_LINKINFO&&this.__aData.CORE_LINKINFO['type']==2&&this.__aData.CORE_LINKINFO.videourl,w=bVid?500:300,h=bVid?281:600;this._getAnchor('preview').onclick=function(e){var e=e||window.event,iid=WMItems.__clientID(this.__aData.EVNLINKID);if(this.__aData.EVNCLASS=='Y'){OldMessage.openwindow([this.__aData.aid,this.__aData.fid,iid+'|@@MAIN@@']);}
else{if(Path.extension(this.__aData.EVNTITLE)=='pdf'){if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/))
return downloadItem(this.__aData.EVNURL,true);gui._create('pdf','frm_pdf')._load(this.__aData.EVNURL,this.__aData.EVNTITLE);}
else
if(Item.imageSupport(this.__aData.EVNTITLE)){var img=gui._create('imgview','frm_imgview');img._fill([{url:this.__aData.EVNURL,title:this.__aData.EVNTITLE}]);img._value(0);}
else
if(Item.editSupport(this.__aData.EVNTITLE))
Item.editFile([this.__aData.aid,this.__aData.fid,iid]);else
if(Item.officeSupport(this.__aData.EVNTITLE))
Item.officeOpen({aid:this.__aData.aid,fid:this.__aData.fid,iid:iid},[Item.downloadFile,[this.__aData.aid,this.__aData.fid,iid]],Path.extension(this.__aData.EVNTITLE));else
return;}
e.cancelBubble=true;e.stopPropagation&&e.stopPropagation();return false;}.bind(this);var img=new Image();img.onload=function(){try{if(!this._destructed){var ePrev=this._getAnchor('preview'),eImg=ePrev.querySelector('img');if(eImg)
eImg.src=img.src;else
ePrev.appendChild(mkElement('img',{src:img.src}));removecss(ePrev,'convert','ico','ico');}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);if(sSRC)
img.src=sSRC;else
img.src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[this.__aData.aid,this.__aData.fid,WMItems.__serverID(this.__aData.EVNLINKID||this.__aData.iid),attid].join('/'),'resize':1,'width':w,'height':h,'t':tstamp||0});}};_me._share=function(b){if(b){if(!this.inp_url){this._draw('obj_groupmentions_item_share','share');this._getAnchor('share').onclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};this._getAnchor('close').onclick=function(){this._share(false);}.bind(this);var linkextras={};if(this.__aData.EVNLINKEXTRAS)
linkextras=parseURL(this.__aData.EVNLINKEXTRAS)||{};this.inp_url._readonly(true);this.inp_url._value(linkextras.EvnTicket);this.inp_url._onclick=this.inp_url._onfocus=function(){this._select();};this.inp_email._single=true;this.inp_email._onchange=function(){this.btn_send._disabled(!this.inp_email._value().trim().length);}.bind(this);this.inp_email._onclose=function(){if(this.inp_email._value().length==0)
this._share(false);}.bind(this);this.inp_email._onsubmit=function(){this.btn_send._onclick();}.bind(this);this.btn_send._onclick=function(){var email=MailAddress.splitEmailsAndNames(this.inp_email._value());if(!this.btn_send._disabled()&&email&&(email=email[0])&&(email=email.email)){this.inp_email._disabled(true);this.btn_send._disabled(true);WMItems.action({aid:this.__aData.aid,fid:this.__aData.fid,iid:this.__aData.EVNLINKID,values:{EMAIL:email}},'notify_groupchat',[function(bOK){if(bOK){this._share(false);this.inp_email._value('');gui.notifier._value({type:'message_sent'});}
this.inp_email._disabled(false);this.btn_send._disabled(false);if(!bOK)
this.inp_email._select();}.bind(this)]);}}.bind(this);}
addcss(this._main,'share');this.inp_email._focus();}
else
removecss(this._main,'share');};_me.__destructor=function(){if(this.__timeout){window.clearTimeout(this.__timeout);delete this.__timeout;}};_me._animate=function(sTitle){if(this.__eAnim&&this.__eAnim.parentNode)
this.__eAnim.parentNode.removeChild(this.__eAnim);if(sTitle){this.__eAnim=mkElement('div',{className:'animate'});this.__eAnim.appendChild(mkElement('div',{text:sTitle}));this._main.querySelector('div.item').appendChild(this.__eAnim);setTimeout(function(){if(this._animate)this._animate();}.bind(this),2000);}};

/* client/inc/obj_highlight.js */
function obj_highlight(){};obj_highlight.__casing={"xml":'HTML / XML',"markdown":'Markdown',"dart":'Dart',"cs":'C#',"json":'JSON',"swift":'Swift',"php":'PHP',"bash":'Bash',"dockerfile":'Dockerfile',"css":'CSS',"python":'Python',"objectivec":'Objective-C',"sql":'SQL',"typescript":'TypeScript',"javascript":'JavaScript',"java":'Java',"cpp":'C++',"powershell":'PowerShell',"diff":'Diff',"go":'Go',"delphi":'Delphi'};obj_highlight._highlight=function(sBody){return sBody.replace(/(?:\`\`\`)(?: ?([\w]+)\n)?([\s\S]*?)(?:\`\`\`)|(?:\`)(.+?)(?:\`)/g,function(match,language,code_block,code_inline){var highlight,prefix='',postfix='',code=(code_block||code_inline||'').trim();if(!window.hljs){storage.library('highlight.pack','highlight');}
if(language){try{highlight=hljs.highlight(language,code);}catch(e){highlight=hljs.highlightAuto(code);}}else{highlight=hljs.highlightAuto(code);}
if(!code_inline){prefix='<pre>';postfix=(highlight.language?'<div class="legend">'+(obj_highlight.__casing[highlight.language]||highlight.language)+'</div>':'')+'</pre>';}
return prefix+'<code class="hljs '+(highlight.language||'')+(!code_inline?'':' inline')+'">'+highlight.value+'</code>'+postfix;});};

/* client/inc/obj_hmenu.js */
_me=obj_hmenu.prototype;function obj_hmenu(){};_me.__constructor=function(){this._telemetry='off';this.__idtable={};var me=this;if(window.navigator.msPointerEnabled){this._main.onmspointerdown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='A')
elm=Is.Child(elm,'A',this);me.__pointerTarget=elm.id||null;};this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='A')
elm=Is.Child(elm,'A',this);if(elm&&elm.id){var id=elm.id.substr(me._pathName.length+1);if(me.__idtable[id]&&!me.__idtable[id].disabled&&me.__idtable[id].keep){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;}}};}
this._main[window.navigator.msPointerEnabled?'onmspointerup':'onclick']=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='A')
elm=Is.Child(elm,'A',this);if(e.type=='MSPointerUp'&&this.onmspointerdown&&elm.id&&(!me.__pointerTarget||me.__pointerTarget!==elm.id)){me.__pointerTarget=null;return;}
me.__pointerTarget=null;if(elm){var id=elm.id.substr(me._pathName.length+1);if(me.__idtable[id]&&!me.__idtable[id].disabled){var arg=me.__idtable[id].arg;if(me.__idtable[id].handler){if(!me.__idtable[id].keep&&me.__close)me.__close();executeCallbackFunction(me.__idtable[id].handler,me,elm,id,arg);}
if(arg){if(me.__idtable[id]&&!me.__idtable[id].keep&&me.__close)me.__close();me.__exeEvent('onclick',e,{"arg":arg,"id":id,"elm":elm,"owner":me});if(me._onclick)
me._onclick(e,elm,id,arg);}
if(me.__idtable[id]&&me.__idtable[id].keep){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}}}
if((elm=Is.Child(e.target||e.srcElement,'LI',this))&&(elm=elm.firstChild)&&elm.tagName=='DIV'&&Is.Defined(elm.id)){return true;}
return false;};this._main.oncontextmenu=function(e){return false;};if(gui.telemetry)
this._obeyEvent('onclick',[function(e,arg){var out={id:me._pathName,type:me._type};if(arg){out.id+='/'+arg.id;if(me.__idtable&&me.__idtable[arg.id]){if(me.__idtable[arg.id].label)
out.label=me.__idtable[arg.id].label;if(Is.String(me.__idtable[arg.id].arg))
out.arg=me.__idtable[arg.id].arg;}}
if(me._owner&&me._owner._pathName)
out.owner=me._owner._pathName;gui.telemetry._add(out);}]);};_me.__telemetry=function(id,elm,data){if(id.indexOf('/')>-1){if(data.OWNER&&(!this._owner||data.OWNER!=this._owner._pathName))
return false;var id=id.substr(this._pathName.length+1).split('#').shift();if(id&&!this.__idtable[id])
return false;if(data.ARG&&this.__idtable[id].arg!=data.ARG)
return false;if(data.LABEL&&this.__idtable[id].label!=data.LABEL)
return false;}};_me._fill=function(aData){this._clear();if(typeof aData=='undefined'){if(this._listener)
aData=dataSet.get(this._listener,this._listenerPath);else
if(this.__aData)
aData=this.__aData;}
else
this.__aData=aData;if(aData)
this.__row(aData,'');};_me._clear=function(){this._clean();var ul;if((ul=this._main.getElementsByTagName('ul'))&&(ul=ul[0]))
ul.parentNode.removeChild(ul);};_me.__row=function(aData,child,bSkipNodes){var path,elm1,elm2,me=this;elm1=mkElement("ul",{className:'root'});if(!child){this.__idtable={};path='';}
else
path=child+'/';var n=0;for(var i in aData){if(aData[i].config){if(aData[i].config.css);addcss(elm1,aData[i].config.css);continue;}
elm2=mkElement("li");elm2.__key=i;elm2.__path=path+n;if(!bSkipNodes&&(aData[i]['nodes']||aData[i]['callback'])&&!aData[i]['disabled']){elm2.onmouseover=function(e){clearTimeout(this.timeout);if(!hascss(this,'active')){var elm=this.getElementsByTagName("UL")[0];if(aData[this.__key]['callback']){if(elm)
this.removeChild(elm);var rows=executeCallbackFunction(aData[this.__key]['callback'],e,this.__key,aData[this.__key]);if(rows){if(rows instanceof Element)
elm=rows;else
elm=me.__row(rows,this.__path);}
else
if(rows===false)
return;this.insertBefore(elm,this.firstChild);elm.onclick=function(e){if(aData[i]['arg2'])
e.__arg2=aData[i]['arg2'];};}
else
if(!elm){elm=me.__row(aData[this.__key]['nodes'],this.__path);}
if(elm&&!elm.parentNode){elm.onclick=function(e){if(aData[i]['arg2'])
e.__arg2=aData[i]['arg2'];};this.insertBefore(elm,this.firstChild);}
addcss(this,'active');addcss(elm1,'submenu');var xBody=document.getElementsByTagName('body')[0].clientWidth,yBody=document.getElementsByTagName('body')[0].clientHeight,aPos=getSize(elm);if(xBody<aPos.x+aPos.w)
addcss(this,'left');if(gui._rtl&&aPos.x<10)
addcss(this,'right');if(yBody<aPos.y+aPos.h)
elm.style.marginTop=(yBody-aPos.y-aPos.h)+'px';elm=null;}};elm2.onmouseout=function(e){this.timeout=setTimeout(function(){removecss(this,'active','left','right');removecss(elm1,'submenu');}.bind(this),5);};}
if(aData[i]['title']==' '){addcss(elm2,'space');if(aData[i]['css'])
addcss(elm2,aData[i]['css']);delete aData[i]['nodes'];}
else
if(aData[i]['title']=='-'){addcss(elm2,'hr');if(aData[i]['css'])
addcss(elm2,aData[i]['css']);delete aData[i]['nodes'];}
else
if(aData[i]['anchor']){this._anchors[aData[i]['anchor']]=this._pathName+'/'+path+'#'+aData[i]['anchor'];this.__idtable[path+'#'+aData[i]['anchor']]={keep:aData[i]['keep']};if(aData[i]['css'])
addcss(elm2,aData[i]['css']);elm2.appendChild(mkElement('div',{id:this._anchors[aData[i]['anchor']]}));delete aData[i]['nodes'];}
else
if(aData[i]['html']||aData[i]['element']){if(aData[i]['css'])
addcss(elm2,aData[i]['css']);elm2.appendChild(aData[i]['element']||mkElement('div',{innerHTML:aData[i]['html']}));delete aData[i]['nodes'];}
else{this.__idtable[path+n]={};if(aData[i]['arg'])
this.__idtable[path+n].arg=aData[i]['arg'];if(aData[i]['handler'])
this.__idtable[path+n].handler=aData[i]['handler'];this.__idtable[path+n].keep=aData[i]['keep'];this.__idtable[path+n].string=aData[i]['title']||aData[i]['text'];var css='';if(aData[i]['css'])
css=aData[i]['css'];if(aData[i]['nodes']||aData[i]['callback']){css+=' nodes';this.__idtable[path+n].nodes=true;}
if(aData[i]['disabled']||aData[i]['caption']){if(aData[i]['disabled'])
css+=' disabled';if(aData[i]['caption'])
css+=' caption';this.__idtable[path+n]={"disabled":true};}
var inner_str='<'+(aData[i]['tag']||'span')+(aData[i]['css2']?' class="'+aData[i]['css2']+'"':'')+'>';if(typeof aData[i]['title']=='string'){inner_str+=(aData[i]['title'].length?getLang(aData[i]['title']):'&nbsp;')+'</span>';this.__idtable[path+n].label=aData[i]['title'];}
else
if(typeof aData[i]['text']!='undefined'){inner_str+=(aData[i]['text'].length?aData[i]['text']:'')+'</span>';this.__idtable[path+n].label=aData[i]['title'];}
else
inner_str+=i+'</'+(aData[i]['tag']||'span')+'>';elm2.className=css;var a=mkElement('a',{id:this._pathName+'/'+path+n,title:aData[i]['title2']?getLang(aData[i]['title2']).entityify():'',unselectable:'on'});a.innerHTML=inner_str;elm2.appendChild(a);}
n++;elm1.appendChild(elm2);}
if(elm2){addcss(elm2,'end');elm2=null;}
if(!child){this._main.appendChild(elm1);return;}
return elm1;};_me.__update=function(){this._fill();};

/* client/inc/obj_hmenu_basic.js */
_me=obj_hmenu_basic.prototype;function obj_hmenu_basic(){}
_me.__constructor=function(){storage.library('gw_others');this.__aMenu=[];var me=this;if(!sPrimaryAccountGUEST){this.__aMenu.push({"title":'MAIN_MENU::COMPOSE',"css":'ico2 compose',handler:[function(){me.__createNew();}]},{"title":'MAIN_MENU::NEW',"css":'ico2 new',nodetype:'click',callback:[this,'__menu']});gui._obeyEvent('folderSelected',[this,'__select_handler']);gui._obeyEvent('itemSelected',[this,'__select_handler']);}
this.__ignoreMouseOut=true;this._fill(this.__aMenu,'static');if(!gui.frm_main.upload){gui.frm_main._create('upload','obj_upload_edit',void 0,'hidden_upload');gui.frm_main.upload._click=function(){this.file._click();};gui.frm_main.upload._onuploadstart=function(){me._uploading=true;this.file.__exeEvent('onuploadstart');};gui.frm_main.upload._onuploadend=function(arg){var active_folder=this.__active_folder||Path.split(dataSet.get('active_folder'));var aFolder={aid:active_folder[0],fid:active_folder[1]};var aRights=WMFolders.getRights({aid:active_folder[0],fid:active_folder[1]}),aAccess=WMFolders.getAccess({aid:active_folder[0],fid:active_folder[1]});if(WMFolders.getType(aFolder)!=='F'||!(aRights.owner||aAccess.write)){aFolder={aid:sPrimaryAccount,fid:Mapping.getDefaultFolderForGWType('F')};}
me._uploading=false;if(this._destructed)
return;var v=this._value();if(v&&aFolder){var now=new IcewarpDate();var aValues={values:{EVNSHARETYPE:GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','file_sharing'),EVNSTARTDATE:now.format(IcewarpDate.JULIAN),EVNSTARTTIME:now.hour()*60+now.minute()},ATTACHMENTS:v};WMItems.add([aFolder.aid,aFolder.fid],aValues,'','','',[function(aResponse){var active_folder=Path.split(dataSet.get('active_folder'));if(active_folder[0]===aFolder.aid&&active_folder[1]===aFolder.fid){gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.__update&&gui.frm_main.main.__update(aFolder);}
aResponse&&gui.notifier&&gui.notifier._value({type:'item_saved',args:[aFolder.aid,aFolder.fid]});}]);this._remove();}};}};_me.__select_handler=function(aData){clearTimeout(this.__select_handler_timeout);this.__select_handler_timeout=setTimeout(function(){var account=aData.aid||aData[0];var folder=aData.fid||aData[1];if((account+'/'+folder).indexOf(GWOthers.getItem('DEFAULT_FOLDERS','TRASH'))===0){folder=GWOthers.getItem('DEFAULT_FOLDERS','TRASH').split('/')[1];}
var ds=(account&&folder)?dataSet.get('folders',[account,folder])||{}:(aData||{}),data={'I':['MAIN_MENU::NEW_UPLOAD','upload'],'F':['MAIN_MENU::NEW_UPLOAD','upload'],'E':['MAIN_MENU::CREATE_APPOINTMENT','event'],'C':['MAIN_MENU::CREATE_CONTACT','contact'],'T':['MAIN_MENU::CREATE_TASK','task'],'N':['MAIN_MENU::CREATE_NOTE','note'],'G':dataSet.get('main',['keep_deleted_items_force_expiration'])?['MAIN_MENU::COMPOSE','compose']:['MAIN_MENU::EMPTY_FOLDER','empty'],'R':['MAIN_MENU::EMPTY_FOLDER','empty'],'H':['MAIN_MENU::EMPTY_FOLDER','empty'],'W':[],'QL':~(ds.NAME||'').indexOf('Blacklist')?['BLACKWHITE::BLACK','black']:['BLACKWHITE::WHITE','white']}[ds.DEFAULT||WMFolders.getType(aData)]||['MAIN_MENU::COMPOSE','compose'];if(ds.SPAM==="true"){data=['MAIN_MENU::EMPTY_FOLDER','empty'];}
this.__aMenu[0]=data[0]&&{title:data[0],css:'ico2 '+data[1],handler:[function(){this.__createNew();}.bind(this)]};this._fill(this.__aMenu,'static');}.bind(this),5);};_me.__menu=function(){var me=this;var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');var middle_column_items=[mkElement('div',{className:'label',text:getLang('MAIN_MENU::DOCUMENTS')}),(!dgw||dgw.indexOf('f')<0)&&mkElement('div',{className:'item word',text:getLang('MAIN_MENU::NEW_WORD'),onclick:function(){me.__createNewGW('F','.docx');me.__close();}}),(!dgw||dgw.indexOf('f')<0)&&mkElement('div',{className:'item excel',text:getLang('MAIN_MENU::NEW_EXCEL'),onclick:function(){me.__createNewGW('F','.xlsx');me.__close();}}),(!dgw||dgw.indexOf('f')<0)&&mkElement('div',{className:'item powerpoint',text:getLang('MAIN_MENU::NEW_PPOINT'),onclick:function(){me.__createNewGW('F','.pptx');me.__close();}}),(!dgw||dgw.indexOf('n')<0)&&mkElement('div',{className:'item note',text:getLang('MAIN_MENU::NEW_NOTE'),onclick:function(){me.__createNewGW('N');me.__close();}})].filter(Boolean);var right_column_items=[mkElement('div',{className:'label',text:getLang('MAIN_MENU::CHAT_VOICE_AND_VIDEO')}),gui.frm_main.im&&gui.frm_main.im._is_active()&&mkElement('div',{className:'item chat',text:getLang('CONTACT::CHAT'),onclick:function(){me.__openChat();me.__close();}}),(sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1)&&mkElement('div',{className:'item call',text:getLang('MAIN_MENU::NEW_CALL'),onclick:function(){gui._create('dial','frm_dial','','');me.__close();}}),sPrimaryAccountCONFERENCE&&mkElement('div',{className:'item conference',text:getLang('MAIN_MENU::CONFERENCE'),onclick:function(){me.__startConference();me.__close();}}),(sPrimaryAccountSMS&&(GWOthers.getItem('RESTRICTIONS','disable_sms')||0)<1)&&mkElement('div',{className:'item sms',text:getLang('MAIN_MENU::SMS'),onclick:function(){NewMessage.compose_sms();me.__close();}})].filter(Boolean);var columns=1;if(middle_column_items.length>1){columns++;}
if(right_column_items.length>1){columns++;}
return mkElement('div',{className:'table'},false,[mkElement('div',{className:'column first columns_'+columns},false,[mkElement('div',{className:'label',text:getLang('MAIN_MENU::EMAIL_AND_PLANNING')}),mkElement('div',{className:'item mail',text:getLang('MAIN_MENU::COMPOSE'),onclick:function(){NewMessage.compose({alias:Item.getAliasFromPath(dataSet.get('active_folder'))});me.__close();}}),mkElement('div',{className:'item template',text:getLang('MAIN_MENU::NEW_MESSAGE'),onclick:function(){NewMessage.compose({template:true});me.__close();}}),sPrimaryAccountGW&&(!dgw||dgw.indexOf('e')<0)&&mkElement('div',{className:'item appointment',text:getLang('MAIN_MENU::NEW_EVENT'),onclick:function(){if(gui.frm_main.main&&(gui.frm_main.main._type==='frm_main_calendar_dayweek'||gui.frm_main.main._type==='frm_main_calendar_month')){gui.frm_main.main._createEvent();}else{me.__createNewGW('E');}
me.__close();}}),sPrimaryAccountGW&&(!dgw||dgw.indexOf('c')<0)&&mkElement('div',{className:'item contact',text:getLang('MAIN_MENU::NEW_CONTACT'),onclick:function(){me.__createNewGW('C');me.__close();}}),sPrimaryAccountGW&&(!dgw||dgw.indexOf('c')<0)&&mkElement('div',{className:'item distribution_list',text:getLang('MAIN_MENU::NEW_DISTRIB_LIST'),onclick:function(){me.__createNewGW('L');me.__close();}}),sPrimaryAccountGW&&(!dgw||dgw.indexOf('t')<0)&&mkElement('div',{className:'item task',text:getLang('MAIN_MENU::NEW_TASK'),onclick:function(){me.__createNewGW('T');me.__close();}})]),sPrimaryAccountGW&&middle_column_items.length>1&&mkElement('div',{className:'column columns_'+columns},false,middle_column_items),right_column_items.length>1&&mkElement('div',{className:'column columns_'+columns},false,right_column_items)]);};_me.__startConference=function(){gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@MEETINGS@@__'});gui.frm_main.main._view('home');};_me.__openChat=function(e,elm,id,arg){gui.frm_main.im._chat();};_me.__createNew=function(){var aActive=gui.frm_main.bar.tree.folders._getActive();if(aActive[0]==''||aActive[1]==''){return NewMessage.compose();}
if((aActive[0]+'/'+aActive[1]).indexOf(GWOthers.getItem('DEFAULT_FOLDERS','TRASH'))===0){aActive[1]=GWOthers.getItem('DEFAULT_FOLDERS','TRASH').split('/')[1];}
var aFolder=dataSet.get('folders',[aActive[0],aActive[1]])||{};switch(aFolder.DEFAULT||aFolder.TYPE){case'E':if(gui.frm_main.main._type=='frm_main_calendar_dayweek'||gui.frm_main.main._type=='frm_main_calendar_month'){gui.frm_main.main._createEvent();}else{Item.openwindow([aActive[0],aActive[1]],getActualEventTime());}
break;case'QL':gui._create(frm_blackwhite,'frm_blackwhite','','',aActive[0],aActive[1]);break;case'C':case'N':case'T':case'J':Item.openwindow([aActive[0],aActive[1]]);break;case'I':gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[gui.frm_main.main,'__addItems'],aActive[0],aActive[1],'','r',false,['M','F','I','X'],'X');break;case'F':gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[gui.frm_main,'__copyItem',[aActive]],aActive[0],aActive[1],'','r',false,['F','I','X'],'X');break;case'H':case'R':Folder.empty({aid:aActive[0],fid:aActive[1]});break;case'G':if(dataSet.get('main',['keep_deleted_items_force_expiration'])){NewMessage.compose({alias:Item.getAliasFromPath(aActive[0]+'/'+aActive[1])});}else{Folder.empty({aid:aActive[0],fid:aActive[1]});}
break;case'M':if(aFolder.SPAM==='true'){Folder.empty({aid:aActive[0],fid:aActive[1]});break;}
if(aActive[0]+'/'+aActive[1]==GWOthers.getItem('DEFAULT_FOLDERS','templates')){NewMessage.compose({template:true});break;}
default:NewMessage.compose({alias:Item.getAliasFromPath(aActive[0]+'/'+aActive[1])});}};_me.__createNewGW=function(sType,sDoc){var aActive=gui.frm_main.bar.tree.folders._getActive(),sFolder,sAccount,bActual=false;if(aActive[0]!=''||aActive[1]!=''){var sFolType=WMFolders.getType(aActive);if(sType==sFolType||(sType=='L'&&sFolType=='C')||(sType=='F'&&(sFolType=='I'||sFolType=='Y')))
bActual=true;}
if(bActual){sAccount=aActive[0];sFolder=aActive[1];}else{sAccount=sPrimaryAccount;sFolder=Mapping.getDefaultFolderForGWType(sType);}
if(sType=='E')
Item.openwindow([sAccount,sFolder],getActualEventTime(),null,sType);else{var aValues;if(sDoc)
aValues={'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':sDoc}}]};Item.openwindow([sAccount,sFolder],aValues,null,sType);}};

/* client/inc/obj_hmenu_basic2.js */
_me=obj_hmenu_basic2.prototype;function obj_hmenu_basic2(){};_me.__constructor=function(){gui._obeyEvent('resize',[this,'__checkSize']);this._add_destructor('__destructCheck');};_me.__checkSize=function(){if(document.body.clientWidth<1200&&this._main.firstChild){var tmp=mkElement('div',{className:'obj_hmenu obj_hmenu_basic2',style:{position:'absolute',top:'-100px',left:0,visibility:'hidden'}});tmp.innerHTML=this._main.innerHTML;document.body.appendChild(tmp);var w=tmp.offsetWidth||0;if(tmp.parentNode)
tmp.parentNode.removeChild(tmp);if(w&&w>document.body.clientWidth-380-gui.frm_main.hmenu1._main.offsetWidth){addcss(this._main,'short');return;}}
if(hascss(this._main,'short'))
removecss(this._main,'short');};_me.__destructCheck=function(){gui._disobeyEvent('resize',[this,'__checkSize']);};_me._contextRefill=function(ids){var a=this.__currentFill;if(a)
this._contextFill(a[0],a[1],a[2],a[3],ids);};_me._contextFill=function(sType,oFolder,sView,bEnabled,ids)
{this.__currentFill=arguments;var bEnabled=bEnabled?true:false,aMenu=[];ids=ids||[];var oFolder=clone(oFolder);this.__oFolder=oFolder;this.__bEnabled=bEnabled;switch(sType)
{case'G':aMenu.push({"title":'POPUP_ITEMS::RECOVER','arg':'recover',disabled:!ids.length},{"title":'-'},{"title":'MAIN_MENU::DELETE','arg':'delete',disabled:!ids.length},{"title":'MAIN_MENU::EMPTY_FOLDER','arg':'empty_folder',disabled:false});break;case'M':var folders=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES'],sTrashFolder=folders['trash'],sDraftFolder=folders['drafts'],sTemplateFolder=folders['templates'],sSentFolder=folders['sent'],sSpamFolder=dataSet.get('main',['spam_path']),bRSS=dataSet.get('folders',[oFolder['aid'],oFolder['fid'],'RSS'])?true:false,sFolderID=oFolder['aid']+'/'+oFolder['fid'];if(sFolderID==sTemplateFolder){aMenu.push({"title":'MAIN_MENU::NEW_MESSAGE','arg':'edit_message',disabled:!bEnabled||ids.length!=1},{"title":'POPUP_ITEMS::EDIT','arg':'edit_template',disabled:!bEnabled||ids.length!=1});}
else
if(sFolderID!=sTrashFolder)
{if(sFolderID==sDraftFolder)
aMenu.push({"title":'POPUP_ITEMS::EDIT','arg':'edit_message',disabled:!bEnabled||ids.length!=1});else
if(!bRSS){if(sFolderID!=sSentFolder)
aMenu.push({"title":'MAIN_MENU::REPLY_TO_SENDER','arg':'reply_to_sender',css:'ico reply',disabled:!bEnabled||ids.length!=1},{"title":'MAIN_MENU::REPLY_TO_ALL','arg':'reply_to_all',css:'ico reply_all',disabled:!bEnabled||ids.length!=1});else
aMenu.push({"title":'MAIN_MENU::REPLY_TO_ALL','arg':'reply_to_all',css:'ico reply',disabled:!bEnabled||ids.length!=1});}
aMenu.push({"title":'MAIN_MENU::FORWARD','arg':'forward_from_hmenu',css:'ico forward',disabled:!bEnabled||ids.length!=1});}
if(sFolderID==sTrashFolder||sFolderID==sSpamFolder)
aMenu.push({"title":'MAIN_MENU::EMPTY_FOLDER','arg':'empty_folder',css:'ico empty'});aMenu.push({"title":'-'},{"text":'',tooltip:'COMMON::MORE','arg':'options','css':'ico img menu noarrow',disabled:!ids.length,keep:true,nodetype:'click',callback:[function(){var aMenu=[];if(ids.length){try{aMenu=obj_context_item.prototype.__createMailMenu.call(this,[oFolder.aid,oFolder.fid,oFolder.iid||ids[0]],[oFolder.aid,oFolder.fid,ids],ids.length>1,dataSet.get('items',[oFolder.aid,oFolder.fid,oFolder.iid||ids[0],'FROM']),WMFolders.getAccess(oFolder),true)||[];}
catch(r){aMenu=[];}}
return aMenu;}]},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!bEnabled||!ids.length});if(sView!='mail_view_list'&&sFolderID!=sTrashFolder)
aMenu.push({"text":'',tooltip:'MAIN_MENU::PRINT','arg':'print',css:'ico img print',disabled:!ids.length});break;case'E':var bgn=GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins');var end=GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends');var workweek=bgn>0&&end>0&&!(bgn==1&&end==7);aMenu=[{"title":'MAIN_MENU::DAY_VIEW','arg':'day_view',css:'ico day'+(sView=='day_view'?' active':'')},{"title":(workweek?'MAIN_MENU::FULLWEEK_VIEW':'MAIN_MENU::WEEK_VIEW'),'arg':'week_view',css:'ico week'+(sView=='week_view'?' active':'')}];if(workweek)
aMenu.push({"title":'MAIN_MENU::WORKWEEK_VIEW','arg':'workweek_view',css:'ico week'+(sView=='workweek_view'?' active':'')});aMenu.push({"title":'MAIN_MENU::MONTH_VIEW','arg':'month_view',css:'ico month'+(sView=='month_view'?' active':'')},{"title":'MAIN_MENU::EVENTS_LIST','arg':'goto_list',css:'ico list'+(sView=='list_wide'||sView=='list_view'||sView=='list'?' active':'')},{"title":'-'},{"text":'',tooltip:'COMMON::MORE','arg':'options','css':'ico img menu noarrow',disabled:!ids.length,keep:true,nodetype:'click',callback:[function(){var aMenu=[];if(ids.length){try{aMenu=obj_context_item.prototype.__createGWMenu.call(this,[oFolder.aid,oFolder.fid,oFolder.iid||ids[0]],[oFolder.aid,oFolder.fid,ids],'E',ids.length>1,"",WMFolders.getAccess(oFolder),"EVNTITLE",undefined,true)||[];}
catch(r){aMenu=[];}}
return aMenu;}]},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length});if(sView=='day_view'||sView=='week_view'||sView=='workweek_view'||sView=='month_view')
aMenu.push({"text":'',tooltip:'MAIN_MENU::PRINT','arg':'print_calendar',css:'ico img print noarrow',nodes:[{"title":'MAIN_MENU::PRINT_CALENDAR','arg':'print_calendar',css:'ico print'},{"title":'MAIN_MENU::EVENTS_LIST','arg':'print_list',css:'ico print'}]});break;case'C':if(sPrimaryAccountSIP||sPrimaryAccountSMS||sPrimaryAccountCONFERENCE){if(sPrimaryAccountSIP)
aMenu.push({"title":'MAIN_MENU::DIAL','arg':'dial',css:'ico dial'});if(sPrimaryAccountCONFERENCE)
aMenu.push({"title":'MAIN_MENU::CONFERENCE','arg':'conference',css:'ico conference'});if(sPrimaryAccountSMS)
aMenu.push({"title":'MAIN_MENU::SMS','arg':'sms',css:'ico sms',disabled:!ids.length});aMenu.push({"title":'-'});}
aMenu.push({"text":'',tooltip:'COMMON::MORE','arg':'options','css':'ico img menu noarrow',disabled:!ids.length,keep:true,nodetype:'click',callback:[function(){var aMenu=[];if(ids.length){try{aMenu=obj_context_item.prototype.__createGWMenu.call(this,[oFolder.aid,oFolder.fid,oFolder.iid||ids[0]],[oFolder.aid,oFolder.fid,ids],'C',ids.length>1,"",WMFolders.getAccess(oFolder),"ITMCLASSIFYAS",undefined,true)||[];}
catch(r){aMenu=[];}}
return aMenu;}]},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length});break;case'F':aMenu.push({"title":'ATTACHMENT::UPLOAD','arg':'upload',css:'ico open'},{"title":'-'});case'T':case'J':case'N':aMenu.push({"text":'',tooltip:'COMMON::MORE','arg':'options','css':'ico img menu noarrow',disabled:!ids.length,keep:true,nodetype:'click',callback:[function(){var aMenu=[];if(ids.length)
try{aMenu=obj_context_item.prototype.__createGWMenu.call(this,[oFolder.aid,oFolder.fid,oFolder.iid||ids[0]],[oFolder.aid,oFolder.fid,ids],sType,ids.length>1,"",WMFolders.getAccess(oFolder),sType=='F'?"EVNFILENAME":"EVNTITLE",gui.frm_main.main.list,true)||[];}
catch(r){aMenu=[];}
return aMenu;}]},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length});break;case'Q':aMenu=[{"title":'MAIN_MENU::DELIVER','arg':'deliver',css:'ico deliver',disabled:!ids.length},{"title":'MAIN_MENU::WHITE_LIST','arg':'whitelist',disabled:!ids.length},{"title":'MAIN_MENU::BLACK_LIST','arg':'blacklist',disabled:!ids.length},{"title":'-'},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length}];break;case'QL':if(oFolder['fid'].indexOf('White')>=0){aMenu=[{"title":'MAIN_MENU::BLACK_LIST','arg':'blacklist',disabled:!ids.length},{"title":'-'},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length}];}
else{aMenu=[{"title":'MAIN_MENU::WHITE_LIST','arg':'whitelist',disabled:!ids.length},{"title":'-'},{"text":'',tooltip:'MAIN_MENU::DELETE','arg':'delete',css:'ico img delete',disabled:!ids.length}];}
break;}
switch(sType){case'QL':case'G':case'X':break;case'E':if(sView=='day_view'||sView=='week_view'||sView=='workweek_view'||sView=='month_view')
break;default:var ico='preview';switch(sView){case'mail_view_wide':case'list_wide':ico='wpreview';break;case'mail_view_list':case'list':ico='lpreview';break;}
if(aMenu.length)
aMenu.push({"title":'-'},{"text":'',tooltip:'ITEMVIEW::PREVIEW','css':'noarrow ico img '+ico,nodetype:'click',callback:[this,'__previewMenu',[sType,sView]]});}
this._main.style.display=aMenu.length?'block':'none';this._fill(aMenu,'dynamic');this.__checkSize();};_me.__previewMenu=function(e,id,sType,sView){var a=[];if(sType=='M'||sType=='Q'){a.push({"title":'ITEMVIEW::DOWN','arg':'mail_view','css':'ico ico2 preview'+(sView=='mail_view'?' check':'')},{"title":'ITEMVIEW::RIGHT','arg':'mail_view_wide','css':'ico ico2 wpreview'+(sView=='mail_view_wide'?' check':'')},{"title":'ITEMVIEW::NONE','arg':'mail_view_list','css':'ico ico2 lpreview'+(sView=='mail_view_list'?' check':'')});}
else{a.push({"title":'ITEMVIEW::DOWN','arg':'list_view','css':'ico ico2 preview'+(sView=='list_view'?' check':'')},{"title":'ITEMVIEW::RIGHT','arg':'list_wide','css':'ico ico2 wpreview'+(sView=='list_wide'?' check':'')},{"title":'ITEMVIEW::NONE','arg':'list','css':'ico ico2 lpreview'+(sView=='list'?' check':'')});}
var ld=Cookie.get(['hide_tree']);a.push({title:'-'},{title:'MAIN_MENU::LEFTPANEL',css:'ico',nodes:[{"title":'COMMON::EXPAND','arg':'lp_expand','css':'ico2'+(ld=='2'?' check':'')},{"title":'COMMON::COLLAPSED','arg':'lp_collapsed','css':'ico2'+(ld=='1'?' check':'')},{"title":'COMMON::AUTOCOLLAPSED','arg':'lp_auto','css':'ico2'+(!ld?' check':'')}]});if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1){var rd=Cookie.get(['hide_im']);a.push({title:'MAIN_MENU::RIGHTPANEL',css:'ico',nodes:[{"title":'COMMON::EXPAND','arg':'rp_expand','css':'ico2'+(rd=='2'?' check':'')},{"title":'COMMON::COLLAPSED','arg':'rp_collapsed','css':'ico2'+(rd=='1'?' check':'')},{"title":'COMMON::AUTOCOLLAPSED','arg':'rp_auto','css':'ico2'+(!rd?' check':'')}]});}
return a;};_me.__manageEmptyItems=function(id,sAction){switch(sAction){case'print_calendar':case'print_list':if(gui.frm_main.main&&gui.frm_main.main._print)
gui.frm_main.main._print(sAction=='print_calendar');return;case'dial':if(id[2])return false;gui.frm_main.__showDialDialog();return true;case'conference':if(id[2])return false;gui.frm_main.__showConferenceDialog();return true;case'goto_list':var aView=Cookie.get(['views',this.__oFolder['aid'],this.__oFolder['fid']]);switch(aView.prev){case'1':sAction='list_view';break;case'2':sAction='list_wide';break;default:sAction='list';}
case'day_view':case'week_view':case'workweek_view':case'month_view':gui.frm_main._selectView(this.__oFolder,sAction,true);return true;case'empty_folder':gui._create('frm_confirm','frm_confirm','','',[function(){WMFolders.__emptyFolder(this.__oFolder['aid'],this.__oFolder['fid']);}],'CONFIRMATION::EMPTY_FOLDER_CONFIRMATION','CONFIRMATION::EMPTY_FOLDER');return true;}
return false;};_me.__manageOneItem=function(id,sAction){switch(sAction){case'reply_to_sender':OldMessage.reply(id,false);return true;case'reply_to_all':OldMessage.reply(id,true);return true;case'reply_to_sender_t':OldMessage.replyTemplate(id,false);return true;case'reply_to_all_t':OldMessage.replyTemplate(id,true);return true;case'forward_from_hmenu':OldMessage.forward(id);return true;case'edit_message':OldMessage.edit(id);return true;case'edit_template':OldMessage.edit(id,{template:true});return true;case'dial':gui.frm_main.__showDialDialog(id[0],id[1],id[2]);return true;case'conference':gui.frm_main.__showConferenceDialog(id[0],id[1],id[2]);return true;case'sms':gui.frm_main.__showSMSDialog(id[0],id[1],id[2]);return true;case'office':var arr=clone(id);arr.push('EVNTITLE');var sName=dataSet.get('items',arr)||'',ext=Path.extension(sName);switch(ext){case'txt':case'htm':case'html':Item.editFile(id);break;case'pdf':Item.openPDF(id);break;case'mp3':Item.playFile(id);break;default:if(!sPrimaryAccountWebDAV||(sName&&!Item.officeSupport(sName)))
Item.downloadFile(id);else
Item.officeOpen({aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],ext);}
return true;}
return false;};_me.__manageMoreItems=function(ids,sAction){switch(sAction){case'delete':if(ids){if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list.__deleteItems)
gui.frm_main.main.list.__deleteItems({aid:ids[0],fid:ids[1]},ids[2]);else
if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.calendar){if(ids[2].length==1){var aid=ids[0],fid=ids[1],id=ids[2][0],oRepeating,n;if(Item.hasReccurence([aid,fid,id]))
oRepeating=dataSet.get('items',[aid,fid,id]);if((n=id.indexOf('|'))>=0)
id=id.substr(0,n);Item.remove([aid,fid,[id]],false,oRepeating,gui.frm_main.main.calendar);}}
else
Item.remove(ids);}
break;case'lock':var sLockID;if(!(sLockID=dataSet.get('items',[ids[0],ids[1],ids[2][ids[2].length-1],'EVNLOCKOWN_ID'])))
sLockID=dataSet.get('items',[ids[0],ids[1],ids[2][ids[2].length-1],'EVNLOCKOWN_ID']);var aRights=WMFolders.getRights({aid:ids[0],fid:ids[1]}),bLocked=sLockID&&sLockID!=sPrimaryAccountGWID&&!aRights.owner;if(!bLocked)
Item.set_lock(ids,(sLockID?false:true),true);break;case'office':Item.downloadMultiple(ids);break;case'recover':Item.recover(ids);break;case'deliver':OldMessage.deliver(ids);break;case'whitelist':OldMessage.whitelist(ids);break;case'blacklist':OldMessage.blacklist(ids);break;case'sms':gui.frm_main.__showSMSDialog(ids[0],ids[1],ids[2]);}};_me._onclick=function(e,elm,id,sAction)
{if(typeof sAction!="string"){executeCallbackFunction(sAction);}
switch(sAction){case'upload':gui.frm_main.upload.file._click();return;case'new_file_w':gui.frm_main.hmenu1.__createNewGW('F','.docx');return;case'new_file_e':gui.frm_main.hmenu1.__createNewGW('F','.xlsx');return;case'new_file_p':gui.frm_main.hmenu1.__createNewGW('F','.pptx');return;case'new_file_t':gui.frm_main.hmenu1.__createNewGW('F','.txt');return;case'new_file_h':gui.frm_main.hmenu1.__createNewGW('F','.html');return;case'mail_view':case'mail_view_wide':case'mail_view_list':case'list_view':case'list_wide':case'list':if(gui.frm_main.main){if(gui.frm_main.main._uploading){return gui._create('stop_upload','frm_confirm','','',[function(){gui.frm_main.main._uploading=false;gui.frm_main.main._changeview(sAction);}],'ALERTS::ALERT','CONFIRMATION::STOPUPLOAD');}
gui.frm_main.main._changeview(sAction);}
return;case'lp_expand':Cookie.set(['hide_tree'],2);gui.frm_main._resize_handler();break;case'lp_collapsed':Cookie.set(['hide_tree'],1);gui.frm_main._resize_handler();break;case'lp_auto':Cookie.set(['hide_tree'],'');gui.frm_main._resize_handler();break;case'rp_expand':Cookie.set(['hide_im'],2);gui.frm_main._rightDock(true);break;case'rp_collapsed':Cookie.set(['hide_im'],1);gui.frm_main._rightDock(false);break;case'rp_auto':Cookie.set(['hide_im'],'');gui.frm_main._rightDock(false);break;}
if(sAction=='delete'&&gui.frm_main.main.calendar){var aSelectedItems=gui.frm_main.main.calendar._selectedItems();if(aSelectedItems.length)
this.__manageMoreItems([this.__oFolder['aid'],this.__oFolder['fid'],aSelectedItems],sAction);}
else
if(!gui.frm_main.main.list)
this.__manageEmptyItems([aid,fid],sAction);else{switch(sAction){case'print':if(gui.frm_main.main&&gui.frm_main.main.mailview)
gui.frm_main.main.mailview._print();return;case'Whitelist':case'Blacklist':gui.frm_main._selectView({'aid':this.__oFolder['aid'],'fid':'SPAM_QUEUE/'+sAction});return;}
var aSelectedItems=gui.frm_main.main.list._value();var aid=this.__oFolder['aid'];var fid=this.__oFolder['fid'];if(Is.Empty(aSelectedItems))
this.__manageEmptyItems([aid,fid],sAction);else
if(count(aSelectedItems)==1){if(!this.__manageEmptyItems([aid,fid,aSelectedItems],sAction))
if(!this.__manageOneItem([aid,fid,aSelectedItems[0]],sAction))
this.__manageMoreItems([aid,fid,aSelectedItems],sAction);}
else
if(!this.__manageEmptyItems([aid,fid,aSelectedItems],sAction))
this.__manageMoreItems([aid,fid,aSelectedItems],sAction);}};

/* client/inc/obj_hmenu_calendar_view.js */
function obj_hmenu_calendar_view(){}
obj_hmenu_calendar_view.prototype.__menu=function(ids){var bgn=GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins'),end=GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends'),workweek=bgn>0&&end>0&&!(bgn==1&&end==7);this.__sCurrentView=Cookie.get(['views',ids['aid'],ids['fid'],'view']);this.__ids=ids;var aMenu=[this.__menuItem('day_view'),this.__menuItem('week_view'),workweek&&this.__menuItem('workweek_view'),this.__menuItem('month_view')].filter(Boolean);var itm=this.__menuItem(this.__sCurrentView);itm.css='short';itm.nodes=clone(aMenu,true).map(function(v){v.css='ico2'+(this.__sCurrentView==v.arg?' check':'');return v;},this);this._fill(aMenu.concat(itm),'static');};obj_hmenu_calendar_view.prototype.__menuItem=function(sView){return{title:'MAIN_MENU::'+sView.toUpperCase(),arg:sView,css:this.__sCurrentView==sView?'active':''};};obj_hmenu_calendar_view.prototype._onclick=function(e,elm,id,sView){executeCallbackFunction([gui.frm_main,'_selectView',[this.__ids,sView]]);};

/* client/inc/obj_hmenu_density.js */
_me=obj_hmenu_density.prototype;function obj_hmenu_density(){};_me.__constructor=function(){this.__uniq=unique_id();this.__btncss={im:''};var aMenu=[{"text":'',tooltip:'MAIN_MENU::ITEM_DENSITY',"css":'ico2 img viewsize noarrow',nodetype:['click'],rel:'view',"callback":[this,'__viewSize'],"destructor":[this,'__viewSizeDestruct']}];this.__ignoreMouseOut=true;this._fill(aMenu);};_me.__viewSize=function(e,id){if(this.cmenu){this.cmenu._destruct();delete this.cmenu;}
aMenu=[{"title":'MAIN_MENU::ITEM_DENSITY',"caption":true},{title:'-'},{"anchor":'compact'}];this.__ePull.appendChild(this.__row(aMenu,id));this._create('compact','obj_slider','compact','',[{value:2,title:getLang('SETTINGS::COMPACT_LAYOUT')},{value:1,title:getLang('SETTINGS::SMALL_LAYOUT')},{value:0,title:getLang('SETTINGS::DEFAULT_LAYOUT')}]);this.compact._onchange=function(v,bNoSave){if(!bNoSave){GWOthers.setItem('LAYOUT_SETTINGS','compact_view',v);GWOthers.save([function(){gui.frm_main._changeViewSize(v);}]);}};this.compact._value(GWOthers.getItem('LAYOUT_SETTINGS','compact_view')||"0",true);};_me.__viewSizeDestruct=function(){this.compact&&this.compact._destruct();};

/* client/inc/obj_hmenu_notifications.js */
_me=obj_hmenu_notifications.prototype;function obj_hmenu_notifications(){};_me.__constructor=function(){this.__uniq=unique_id();this.__btncss={im:''};var aMenu=[{"text":'',tooltip:'MAIN_MENU::NOTIFICATIONS',"css":'ico2 img notifier noarrow',nodetype:['click'],rel:'notify',"callback":[this,'__notifyList'],"destructor":[this,'__notifyListDestruct']}];this.__ignoreMouseOut=true;this._fill(aMenu);};_me._onclick=function(e,elm,id,arg)
{switch(arg){case'clear_notifications':gui.notifier._clear_notifications();break;default:if(Is.Object(arg))
executeCallbackFunction(arg);}};_me.__notifyList=function(e,id){if(this.cmenu){this.cmenu._destruct();delete this.cmenu;}
var count=gui.notifier.__saved.length;this.__ePull.appendChild(this.__row([{text:getLang('MAIN_MENU::NOTIFICATIONS')+(count?' ('+count+')':''),caption:true},count&&{title:'MAIN_MENU::CLEAR_ALL',css:'clear_notifications',arg:'clear_notifications'},{title:'-'},count?{anchor:'notifications'}:{title:'MAIN_MENU::NO_NOTIFICATIONS',css:'no_notifications'}].filter(Boolean),id));if(count){this._create('notifications','obj_notifier','notifications','',true);gui._obeyEvent('resize',[this,'__notifyListHeight']);this.__notifyListHeight();}};_me.__notifyListHeight=function(){if(this.notifications){var p=getSize(this.__ePull),n=getSize(this._getAnchor('notifications')),h=window.innerHeight||window.document.body.clientHeight;this.notifications._main.style.maxHeight=(h-n.y-((p.y+p.h)-(n.y+n.h))-50)+'px';}};_me.__notifyListDestruct=function(){if(this.notifications){gui._disobeyEvent('resize',[this,'__notifyListHeight']);this.notifications._destruct();}};

/* client/inc/obj_hmenu_plus.js */
_me=obj_hmenu_plus.prototype;function obj_hmenu_plus(){};_me.__constructor=function(){var me=this;this.__ePull=null;this.__timeout=null;this.__openedNode=[];this.__timeoutdelay=150;this._upMenu=false;function openNodes(id,elm,e){var body=document.body;if(me.__openedNode.length)
me.__close();me.__openedNode.push(id);if(!me.__ePull){me.__ePull=mkElement('div',{className:'obj_context '+(me._css?' '+me._css+'_plus':'')});if(window.navigator.msPointerEnabled)
me.__ePull.onmspointerup=function(e){if(me.__aData[id]['arg2'])
e.__arg2=me.__aData[id]['arg2'];me._main.onmspointerup.apply(me,arguments);};else
me.__ePull.onclick=function(e){if(me.__aData[id]['arg2'])
e.__arg2=me.__aData[id]['arg2'];me._main.onclick.apply(me,arguments);};me.__ePull.onmousemove=function(e){if(me.__timeout){window.clearTimeout(me.__timeout);me.__timeout=null;}};me.__ePull.onmouseout=function(e){if(me.__ignoreMouseOut)
return;if(!me.__timeout)
me.__timeout=window.setTimeout(function(){if(this&&this._destructed===false)
this.__close();}.bind(me),me.__timeoutdelay);};body.appendChild(me.__ePull);}
else{me.__ePull.style.display='block';while(me.__ePull.firstChild)
me.__ePull.removeChild(me.__ePull.firstChild);}
me.__ePull.setAttribute('menu',me.__aData[id]['rel']||'');var pos=getSize(elm);if(me._upMenu){addcss(me.__ePull,'bottom');me.__ePull.style.bottom=(body.clientHeight-pos.y)+'px';}
else{addcss(me.__ePull,'top');me.__ePull.style.top=(pos.y+pos.h)+'px';}
if(me.__ePull.clientHeight>body.clientHeight){addcss(me.__ePull,'scrollable');}else{removecss(me.__ePull,'scrollable');}
if(me.__aData[id]['callback']){var rows=executeCallbackFunction(me.__aData[id]['callback'],e,id,me.__aData[id]);if(rows){if(rows instanceof Element)
me.__ePull.appendChild(rows);else
me.__ePull.appendChild(me.__row(rows,id));}
else
if(rows===false)
return;}
else
if(me.__aData[id]['child'])
me.__ePull.appendChild(me.__aData[id]['child']);else
me.__ePull.appendChild(me.__row(me.__aData[id].nodes,id));var w=window.innerWidth||body.offsetWidth,left=(pos.x+pos.w/2)-me.__ePull.offsetWidth/2;left=left<0?0:left,right=(w-pos.x-pos.w/2-me.__ePull.offsetWidth/2);right=right<10?10:right;right=right>(window.innerWidth-10-me.__ePull.offsetWidth)?(window.innerWidth-10-me.__ePull.offsetWidth):right;if(w<left+me.__ePull.offsetWidth)
left=w-me.__ePull.offsetWidth;if(gui._rtl){me.__ePull.style.right=right+'px';me.__ePull.style.left='auto';}else{me.__ePull.style.left=left+'px';}
var pos2=getSize(me.__ePull);if(gui._rtl){me.__ePull.appendChild(mkElement('div',{style:{right:(pos2.x+pos2.w-pos.x-pos.w/2)+'px',left:'auto'}}));}else{me.__ePull.appendChild(mkElement('div',{style:{left:(pos.x+pos.w/2-pos2.x)+'px'}}));}
var prt=document.getElementById(me._pathName+'/'+id);if(prt){addcss(prt,'active');prt=null;}};function handleOpenEvent(e){var elm=e.target||e.srcElement;if(e.detail instanceof Element){elm=e.detail;}
if(elm.tagName!='A')
elm=Is.Child(elm,'A',me._main);if(elm.tagName!='A'){if(me.__openedNode.length)
me.__close();return false;}
if(me.__timeout){window.clearTimeout(me.__timeout);me.__timeout=null;}
var id=me.__getId(elm.id);if(me.__aData[id]&&e.type=='mousemove'&&(me.__aData[id].tooltip||(me.__aData[id].title&&hascss(me._main,'short')))){var rect=elm.getBoundingClientRect(),place=parseInt(2*document.getElementsByTagName('BODY')[0].offsetWidth/3),title=me.__aData[id].text||getLang(me.__aData[id].tooltip||me.__aData[id].title),left=rect.left>place?rect.left-title.length*7:rect.left;gui.tooltip._show(elm,title,{x:left+(elm.offsetWidth/2),y:rect.top+36});}
if(me.__openedNode[me.__openedNode.length-1]==id){if(e.type=='click')
me.__close();return false;}
me.__timeoutdelay=e.type=='click'?1500:100;if(me.__aData[id]&&!me.__aData[id]['disabled']&&(me.__aData[id]['nodes']||me.__aData[id]['callback'])){var ntype;if(Is.Array(me.__aData[id]['nodetype']))
ntype=me.__aData[id]['nodetype'];else
ntype=[me.__aData[id]['nodetype']];if(e.type=='mousemove'&&(me.__aData[id]['nodetype']==undefined||inArray(ntype,'hover')>-1)||e.type=='contextmenu'&&inArray(ntype,'context')>-1||e.type=='click'&&inArray(ntype,'click')>-1){openNodes(id,elm,e);return;}}
else
me.__close();};AttachEvent(this._main,'onmousemove',function(e){e=e||window.event;handleOpenEvent(e);});AttachEvent(this._main,'onclick',function(e){e=e||window.event;handleOpenEvent(e);});AttachEvent(this._main,'oncontextmenu',function(e){e=e||window.event;handleOpenEvent(e);return false;});AttachEvent(this._main,'onmouseout',function(e){if(me.__ignoreMouseOut){return;}
e=e||window.event;var rel=e.relatedTarget||e.toElement,inside=Is.Child(rel,me._main),elm=e.target||e.srcElement;if(!inside)
gui.tooltip._hide();if(elm.nodeName=='A'&&(!rel||rel.nodeName!='SPAN'))
gui.tooltip._hide(elm);if(me.__openedNode!=null){if(me.__timeout)
window.clearTimeout(me.__timeout);me.__timeout=window.setTimeout(function(){if(this&&this._destructed===false)
this.__close();}.bind(me),me.__timeoutdelay+100);}});gui._obeyEvent('click',[this,'__outsideclick']);this._add_destructor('__destruct_menu');};_me.__outsideclick=function(e){if(Is.Child(e.target||e.srcElement,this.__ePull)==false&&Is.Child(e.target||e.srcElement,this._main)==false)
this.__close();};_me.__destruct_menu=function(e){this.__close(true);gui._disobeyEvent('click',[this,'__outsideclick']);};_me.__close=function(bFully){if(this.__timeout){window.clearTimeout(this.__timeout);this.__timeout=null;}
if(this.__openedNode.length){for(var i=this.__openedNode.length-1;i>=0;i--){if(this.__aData[this.__openedNode[i]]&&this.__aData[this.__openedNode[i]].destructor){executeCallbackFunction(this.__aData[this.__openedNode[i]].destructor,this.__openedNode[i],this.__aData[this.__openedNode[i]]);}
var elm=document.getElementById(this._pathName+'/'+this.__openedNode[i]);if(elm){removecss(elm,'active');elm=null;}
this.__openedNode.splice(i,1);}}
try{if(this.__ePull)
if(bFully){this.__ePull.parentNode.removeChild(this.__ePull);this.__ePull=null;}
else
this.__ePull.style.display='none';}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er)}};_me.__getId=function(elmid){return elmid.substr(this._pathName.length+1);};_me._fill=function(aData){this.__close(true);this._clear();if(!aData&&this._listener)
this.__aData=dataSet.get(this._listener,this._listenerPath);else
if(!(this.__aData=(aData||[]).filter(Boolean)).length)
return;this.__row(this.__aData.filter(Boolean),'',true);};

/* client/inc/obj_hmenu_preview.js */
_me=obj_hmenu_preview.prototype;function obj_hmenu_preview(){};_me.__constructor=function(){this.__uniq=unique_id();this.__btncss={im:''};var aMenu=[{"text":'',tooltip:'ITEMVIEW::PREVIEW',"css":'ico2 img preview noarrow',nodetype:['click'],rel:'layout',"callback":[this,'__layout']}];this.__ignoreMouseOut=true;this._fill(aMenu);gui._obeyEvent('viewSelected',[this,'__updatePreviewIcon']);this._add_destructor('__destructor');};_me.__destructor=function(){gui._disobeyEvent('viewSelected',[this,'__updatePreviewIcon']);};_me.__updatePreviewIcon=function(sView){var icon='';var el=document.getElementById(this._pathName+'/0').parentNode;removecss(this._main,'hidden');switch(sView){case'conference_view':icon='chat';if(!window.sPrimaryAccountIM||(GWOthers.getItem('RESTRICTIONS','disable_im')||0)==1){addcss(this._main,'hidden');}
break;case'day_view':case'week_view':case'workweek_view':case'month_view':icon='calendar';break;case'mail_view':case'list_view':icon='bottom';break;case'mail_view_wide':case'list_wide':case'chat_view':icon='side';break;}
['bottom','side','calendar','chat'].forEach(el.classList.remove.bind(el.classList));icon&&el.classList.add(icon);};_me._onclick=function(e,elm,id,arg)
{var active=gui.frm_main.bar.tree.folders._getActive();switch(arg)
{case'month_view':gui.frm_main._selectView({aid:active[0],fid:active[1]},GWOthers.getItem('DEFAULT_CALENDAR_SETTINGS','event_view'),true);break;case'mail_view':case'mail_view_wide':case'mail_view_list':case'list_view':case'list_wide':case'list':if(gui.frm_main.main){if(gui.frm_main.main._uploading){return gui._create('stop_upload','frm_confirm','','',[function(){gui.frm_main.main._uploading=false;gui.frm_main.main._changeview(arg);}],'ALERTS::ALERT','CONFIRMATION::STOPUPLOAD');}
if(~gui.frm_main._lastView.indexOf('mail')||~gui.frm_main._lastView.indexOf('list')){gui.frm_main.main._changeview(arg);}else{gui.frm_main._selectView({aid:active[0],fid:active[1]},arg,true);}}
return;case'lp_expand':Cookie.set(['hide_tree'],2);gui.frm_main._resize_handler();break;case'lp_collapsed':Cookie.set(['hide_tree'],1);gui.frm_main._resize_handler();break;case'lp_auto':Cookie.set(['hide_tree'],'');gui.frm_main._resize_handler();break;case'rp_expand':Cookie.set(['hide_im'],2);gui.frm_main._rightDock(true);break;case'rp_collapsed':Cookie.set(['hide_im'],1);gui.frm_main._rightDock(false);break;case'rp_auto':Cookie.set(['hide_im'],'');gui.frm_main._rightDock(false);break;case'clear_notifications':gui.notifier._clear_notifications();break;default:if(Is.Object(arg))
executeCallbackFunction(arg);}};_me.__layout=function(e,id){var sType=WMFolders.getType(Path.split(dataSet.get('active_folder'))),sView=gui.frm_main._lastView;var rd=Cookie.get(['hide_im']);var a=[{"title":'ITEMVIEW::PREVIEW',"caption":true},{"title":'-'}];switch(sType){case'M':case'Q':a.push({"title":'ITEMVIEW::DOWN','arg':'mail_view','css':'ico ico2 preview'+(sView=='mail_view'?' check':'')},{"title":'ITEMVIEW::RIGHT','arg':'mail_view_wide','css':'ico ico2 wpreview'+(sView=='mail_view_wide'?' check':'')},{"title":'ITEMVIEW::NONE','arg':'mail_view_list','css':'ico ico2 lpreview'+(sView=='mail_view_list'?' check':'')});break;case'W':return[{"title":'COMMON::EXPAND','arg':'rp_expand','css':'ico2'+(rd=='2'?' check':'')},{"title":'COMMON::COLLAPSED','arg':'rp_collapsed','css':'ico2'+(rd=='1'?' check':'')},{"title":'COMMON::AUTOCOLLAPSED','arg':'rp_auto','css':'ico2'+(!rd?' check':'')}];case'I':case'Y':case'X':a=[];break;case'E':a.push({"title":'SETTINGS::EVENT_VIEW','arg':'month_view','css':'ico ico2 calendar'+(!~sView.indexOf('list')&&!~sView.indexOf('mail')?' check':'')});default:a.push({"title":'ITEMVIEW::DOWN','arg':'list_view','css':'ico ico2 preview'+(sView=='list_view'?' check':'')},{"title":'ITEMVIEW::RIGHT','arg':'list_wide','css':'ico ico2 wpreview'+(sView=='list_wide'?' check':'')},{"title":'ITEMVIEW::NONE','arg':'list','css':'ico ico2 lpreview'+(sView=='list'?' check':'')});}
var ld=Cookie.get(['hide_tree']);if(a.length){a.push({title:'-'});}
a.push({title:'MAIN_MENU::LEFTPANEL',css:'ico2 empty_folder',nodes:[{"title":'COMMON::EXPAND','arg':'lp_expand','css':'ico2'+(ld=='2'?' check':'')},{"title":'COMMON::COLLAPSED','arg':'lp_collapsed','css':'ico2'+(ld=='1'?' check':'')},{"title":'COMMON::AUTOCOLLAPSED','arg':'lp_auto','css':'ico2'+(!ld?' check':'')}]});if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1){a.push({title:'MAIN_MENU::RIGHTPANEL',css:'ico2 im',nodes:[{"title":'COMMON::EXPAND','arg':'rp_expand','css':'ico2'+(rd=='2'?' check':'')},{"title":'COMMON::COLLAPSED','arg':'rp_collapsed','css':'ico2'+(rd=='1'?' check':'')},{"title":'COMMON::AUTOCOLLAPSED','arg':'rp_auto','css':'ico2'+(!rd?' check':'')}]});}
return a;};

/* client/inc/obj_hmenu_status.js */
_me=obj_hmenu_status.prototype;function obj_hmenu_status(){};_me.__constructor=function(){this.__uniq=unique_id();this.__btncss={im:''};var aMenu=[{"text":'<u></u><i><b></b></i>',"css":'noarrow',"arg":'status',rel:'status',nodetype:['click','context'],"callback":[this,'__submenu'],"destructor":[this,'__submenuDestruct']}];this.__ignoreMouseOut=true;this._fill(aMenu);if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1){var elm=document.getElementById(this._pathName+'/'+(this.__aData.length-1)).parentNode;addcss(elm,'im');gui.tooltip._add(elm,getLang('IM::IM')+'  '+getLang('STATUS::OFFLINE'),{x:'-60',y:'+36'});}
this._listen('xmpp',['status']);this.__avatar();};_me._onclick=function(e,elm,id,arg)
{switch(arg)
{case'status':if((e.ctrlKey||e.metaKey)&&Cookie&&!Cookie.store([gui.frm_main,'__logout']))
gui.frm_main.__logout();break;default:if(Is.Object(arg))
executeCallbackFunction(arg);}};_me.__vcard=function(){if(GWOthers.getItem('RESTRICTIONS','disable_gw_types')==1)return;this.__close(true);Item.openwindow([sPrimaryAccount,'@@mycard@@','@@mycard@@'],'','','C',[this,'__refreshMyAvatar']);};_me.__im=function(sStatus){if(gui.frm_main.im){gui.frm_main.im._status(sStatus);}};_me.__refreshMyAvatar=function(){sAvatarNo++;var myEmail=encodeURIComponent(sPrimaryAccount);[].forEach.call(document.querySelectorAll('[style], [src]'),function(element){['src','style'].forEach(function(attr){var value=element.getAttribute(attr);if(value&&~value.indexOf(myEmail)){element.setAttribute(attr,value.replace(/&no=\d+/,'').replace(myEmail,myEmail+'&no='+sAvatarNo));}});});if(gui.socket&&gui.socket.xmpp)
setTimeout(function(){if(gui.socket&&gui.socket.xmpp)
gui.socket.xmpp._updatePresencePhoto();},5000);};_me.__avatar=function(){if(!sPrimaryAccountGW)return;this.__uniq=unique_id();var me=this,sURL=getAvatarURL(sPrimaryAccount),img=new Image();img.onload=function(){var elm=me._main.getElementsByTagName('B')[0];if(elm){if(this.height>10&&this.width>10){if(currentBrowser()=='MSIE7'){var img=mkElement('img',{src:sURL});if(this.width>this.height){var r=this.height/elm.clientHeight;img.style.height='100%';if((this.width/r)>elm.clientWidth)
img.style.right=(((this.width/r)-elm.clientWidth)/2)+'px';}
else{var r=this.width/elm.clientWidth;img.style.width='100%';if((this.height/r)>elm.clientHeight)
this.style.bottom=(((this.height/r)-elm.clientHeight)/2)+'px';}
elm.innerHTML='';elm.appendChild(img);elm.style.backgroundImage='none';}
else
elm.style.backgroundImage='url("'+sURL+'")';elm.style.backgroundColor='#FFFFFF';}
else{elm.style.backgroundImage='';elm.style.backgroundColor='';if(currentBrowser()=='MSIE7')
elm.innerHTML='';}}};img.src=sURL;};_me.__twoFactor=function(e){gui._create('settings','frm_settings','','','account_settings','primary');gui._create('verify','frm_verify');if(this.__ePull){this.__ePull.style.display='none';}};_me.__submenu=function(e,id){try{if(this.cmenu){this.cmenu._destruct();delete this.cmenu;}
var aTplData={path:this._pathName,name:dataSet.get('main',['fullname'])||dataSet.get('main',['user']),type:sPrimaryAccountGUEST?getLang('COMMON::GUEST'):dataSet.get('main',['domain']),msie:(currentBrowser()=='MSIE7'),gw:sPrimaryAccountGW?true:false};if(sPrimaryAccountGW)
aTplData['src']=getAvatarURL(sPrimaryAccount);var aMenu=[{text:template.tmp('obj_hmenu_status',aTplData),css:'info',arg:[this,'__vcard']},{title:'-'}];if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1&&gui.frm_main.im){var im=gui.frm_main.im,s=im&&im._status(),bStatus=im&&im._getStatusText()||e&&(e.type=='contextmenu'||e.type=='click'&&e.shiftKey);if(bStatus)
aMenu.push({anchor:'input',keep:true},{title:'-'});var nodes=[];if(s!='online')
nodes.push({title:'STATUS::ONLINE',arg:[this,'__im',['online']],css:'ico im online'});if(s!='away'&&GWOthers.getItem('IM','status_away')>0)
nodes.push({title:'STATUS::AWAY',arg:[this,'__im',['away']],css:'ico im away'});if(s!='xa'&&GWOthers.getItem('IM','status_xa')>0)
nodes.push({title:'STATUS::XA',arg:[this,'__im',['xa']],css:'ico im xa'});if(s!='dnd'&&GWOthers.getItem('IM','status_dnd')>0)
nodes.push({title:'STATUS::DND',arg:[this,'__im',['dnd']],css:'ico im dnd'});if(s!='offline'&&GWOthers.getItem('IM','status_offline')>0)
nodes.push({title:'STATUS::OFFLINE',arg:[this,'__im',['offline']],css:'ico im offline'});aMenu.push({title:'STATUS::'+s.toUpperCase(),css:'ico im '+s,nodes:nodes},{title:'-'});}
if(!sPrimaryAccountGUEST)
switch(sPrimaryAccountType){case'admin':aMenu.push({"title":'MAIN_MENU::ADMIN_OPTIONS',"arg":[gui,'_create',['settings','frm_settings_admin']],"css":'ico asettings'});break;case'domainadmin':aMenu.push({"title":'MAIN_MENU::DOMAIN_OPTIONS',"arg":[gui,'_create',['settings','frm_settings_admin','','',true]],"css":'ico asettings'});break;}
aMenu.push({"title":'MAIN_MENU::OPTIONS',"arg":[gui,'_create',['settings','frm_settings']],"css":'ico settings'});aMenu.push({"title":'-'});if(!sPrimaryAccountGUEST&&sPrimaryAccount2F&&!sPrimaryAccount2FE){aMenu.push({text:getLang('VERIFICATION::INACTIVE',['<span class="color1">'+getLang('SETTINGS::DISABLED')+'</span>'])+'<span class="color2">'+getLang('SETTINGS::SETUP_NOW')+'</span>',css:'ico two_factor',arg:[this,'__twoFactor']});aMenu.push({title:'-'});}
if(sPrimaryAccountACTIVESYNC)
aMenu.push({"title":'MAIN_MENU::DEVICES',"arg":[gui,'_create',['devices','frm_devices']],"css":'ico devices'});aMenu.push({"title":'MAIN_MENU::HELP',"arg":[function(){if(gui.help)
gui.help._destruct();else
gui._create('help','frm_help');}],"css":'ico help'});aMenu.push({title:'-'});if(!sPrimaryAccountGUEST){if((GWOthers.getItem('LAYOUT_SETTINGS','interfaces')||'').indexOf('b')>-1)
aMenu.push({"title":'MAIN_MENU::BASIC',"css":'ico switch',"arg":[function(){if(GWOthers.getItem('LAYOUT_SETTINGS','confirm_exit')==2)
GWOthers.setItem('LAYOUT_SETTINGS','confirm_exit',1);try{if(window.onbeforeunload)
window.onbeforeunload({});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
document.location.replace(document.location.protocol+'//'+document.location.hostname+(document.location.port?':'+document.location.port:'')+document.location.pathname+'basic/?sid='+dataSet.get('main',['sid']));}]});if((sPrimaryAccountType=='admin'||sPrimaryAccountType=='domainadmin')&&sPrimaryAccountWebAdmin)
aMenu.push({"title":'MAIN_MENU::WEBADMIN',"css":'ico window',"arg":[function(){var win=window.open(sPrimaryAccountWebAdmin+'?sid='+dataSet.get('main',['sid'])+'&from=WebClient&language='+(GWOthers.getItem('LAYOUT_SETTINGS','language')||'en'),'_blank');win.focus();}]});if(sPrimaryAccountOLDWC)
aMenu.push({"title":'MAIN_MENU::OLD_CLIENT',"css":'ico switch',"arg":[function(){if(GWOthers.getItem('LAYOUT_SETTINGS','confirm_exit')==2)
GWOthers.setItem('LAYOUT_SETTINGS','confirm_exit',1);try{if(window.onbeforeunload)
window.onbeforeunload({});}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
document.location.replace(document.location.protocol+'//'+document.location.hostname+(document.location.port?':'+document.location.port:'')+document.location.pathname+'old/?sid='+dataSet.get('main',['sid']));}]});aMenu.push({title:'-'});}
aMenu.push({title:'MAIN_MENU::LOGOUT',arg:[function(){if(Cookie&&!Cookie.store([gui.frm_main,'__logout']))
gui.frm_main.__logout();}],css:'ico logout color2'});this.__ePull.appendChild(this.__row(aMenu,id));if(bStatus){var stat=this._create('status','obj_input','input','noborder status_text');stat._placeholder(getLang('IM::STATUS_MSG'));stat._value(gui.frm_main.im._getStatusText());stat._onblur=function(){if(gui.frm_main.im._getStatusText()!=this._value())
gui.frm_main.im._status(gui.frm_main.im._status(),this._value());};stat._onclose=function(){this._value(gui.frm_main.im._getStatusText()||'');};stat._onsubmit=function(){this._onblur();this._onblur=null;this._parent.__close();};}
if(this.__ePull.clientHeight>document.body.clientHeight)
addcss(this.__ePull,'scrollable');else
removecss(this.__ePull,'scrollable');}catch(r){if(console)
console.log('#Error',r);}};_me.__submenuDestruct=function(){if(this.status)
this.status._destruct();};_me.__update=function(sDName,aDPath){var elm=document.getElementById(this._pathName+'/'+(this.__aData.length-1)),sStatus=gui.frm_main.im._status();elm.setAttribute('state',sStatus);gui.tooltip._title(elm.parentNode,getLang('IM::IM')+'  '+getLang('STATUS::'+sStatus.toUpperCase()));if(sStatus=='offline')
gui.frm_main.im._dock(true);else
if(!Is.Defined(gui.frm_main.__rightDock))
gui.frm_main.im._undock(true);};

/* client/inc/obj_hmenu_toolbar.js */
_me=obj_hmenu_toolbar.prototype;function obj_hmenu_toolbar(){}
_me.__constructor=function(){storage.library('gw_others');this.__currentFolder=[];gui._obeyEvent('viewSelected',[this,'__viewSelect_handler']);gui._obeyEvent('folderSelected',[this,'__folderSelect_handler']);gui._obeyEvent('itemSelected',[this,'__itemSelect_handler']);this._add_destructor('__destructor');};_me.__viewSelect_handler=function(arg){if(this.__currentFolder.length&&~['day_view','week_view','workweek_view','month_view'].indexOf(arg)){this.__currentView=arg;this.__menu(this.__currentFolder);}};_me.__folderSelect_handler=function(arg){var arg_copy=clone(arg);if(arg.aid==sPrimaryAccount&&arg.fid=='__@@VIRTUAL@@__/__@@EVENTS@@__'){arg_copy.fid=Folder.getActiveCalendar();}
if(this.__currentFolder.length){if((arg.ftype&&this.__currentIDs.length==3)||this.__currentFolder[0]!=arg.aid||(this.__currentFolderTranslated[1]!=arg_copy.fid))
this.__menu([arg.aid,arg_copy.fid]);}
else{this.__menu([arg.aid,arg_copy.fid]);}};_me.__itemSelect_handler=function(arg){if(!this.__currentFolder.length||!compareObj(this.__currentIDs,arg,true)){this.__menu(arg);}};_me.__destructor=function(){gui._disobeyEvent('viewSelected',[this,'__viewSelect_handler']);gui._disobeyEvent('folderSelected',[this,'__folder_select_handler']);gui._disobeyEvent('itemSelected',[this,'__itemSelect_handler']);};_me.__menu=function(ids){if(Is.String(ids[2]))
ids[2]=[ids[2]];this.__currentIDs=ids;this.__currentFolder=ids.slice(0,2);this.__currentFolderTranslated=this.__currentFolder.concat();if(this.__currentFolder[0]==sPrimaryAccount&&this.__currentFolder[1]=='__@@VIRTUAL@@__/__@@EVENTS@@__'){this.__currentFolder[1]=Folder.getActiveCalendar();this.__currentFolderTranslated[1]=Folder.getActiveCalendar();}
var aMenu=[],sType=WMFolders.getType(this.__currentFolder),bShort=false,aFolder=dataSet.get('folders',this.__currentFolder),aRights=WMFolders.getRights(this.__currentFolder),aAccess=WMFolders.getAccess(this.__currentFolder),del=false,bNoMore=false,bIsFavorite=(dataSet.get('cookies',['favorites'])||[]).some(function(fav){return fav.arg.aid===this.__currentFolder[0]&&fav.arg.fid===this.__currentFolder[1];}.bind(this));if(ids.length==2){switch(sType){case'M':if(aFolder.RSS){aMenu.push({"title":'POPUP_FOLDERS::CHANGE_CHANNEL',css:'ico2 change_channel',"arg":'change_channel',disabled:!aRights.modify});}
if(!aFolder.SPAM)
aMenu.push({"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'});if(aFolder.SPAM||aFolder.DEFAULT==='H'||aFolder.DEFAULT=='S')
aMenu.push({"title":'MAIN_MENU::EMPTY_FOLDER',css:'ico2 empty_folder',"arg":'empty'});if(GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0&&!bIsFavorite)
aMenu.push({title:'POPUP_FOLDERS::ADD_FAVORITES',arg:'add_favorite',css:'ico2 fav_folder'});break;case'E':if(~['day_view','week_view','workweek_view','month_view'].indexOf(this.__currentView))
aMenu.push({"title":'MAIN_MENU::PRINT',css:'ico2 print noarrow',"arg":'print',nodetype:'click',nodes:[{"title":'MAIN_MENU::PRINT_CALENDAR',css:'ico2 print_calendar',"arg":'print_calendar'},{"title":'MAIN_MENU::EVENTS_LIST',css:'ico2 print_list',"arg":'print_list'},]});aMenu.push({"title":'MAIN_MENU::ADD_CALENDAR',css:'ico2 add_calendar',"arg":'add_folder'});break;case'F':var aDoc=[{"title":'MAIN_MENU::NEW_WORD',"arg":{arg:'new_item',type:'.docx'},css:'ico2 doc shorten',disabled:!aAccess.write},{"title":'MAIN_MENU::NEW_EXCEL',"arg":{arg:'new_item',type:'.xlsx'},css:'ico2 xls shorten',disabled:!aAccess.write},{"title":'MAIN_MENU::NEW_PPOINT',"arg":{arg:'new_item',type:'.pptx'},css:'ico2 ppt shorten',disabled:!aAccess.write}];aMenu=aMenu.concat(aDoc);aMenu.push({"title":'MAIN_MENU::NEW_DOCUMENT',css:'ico2 add_doc short',disabled:!aAccess.write,nodes:aDoc},{"title":'MAIN_MENU::NEW_UPLOAD',css:'ico2 upload',"arg":'upload_file',disabled:!aAccess.write},{"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'});break;case'C':aMenu.push({"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'});break;case'T':aMenu.push({"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'});break;case'N':aMenu.push({"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'});break;case'I':aMenu.push({"title":'CONFERENCE::INVITE',css:'ico2 invite',"arg":'invite',disabled:!aRights.write},{"title":'MAIN_MENU::NEW_UPLOAD',css:'ico2 upload',"arg":'tch_upload',disabled:!aAccess.write});break;case'X':aMenu.push({"title":'MAIN_MENU::ADD_FOLDER',css:'ico2 add_folder',"arg":'add_folder'},{"title":'POPUP_FOLDERS::ADD_SHARED_ACCOUNT',css:'ico2 share_account',"arg":'add_account',disabled:ids[0]!=sPrimaryAccount||!sPrimaryAccountSHARING});bNoMore=true;break;default:bShort=true;switch(sType){case'Q':aMenu.push({"title":'MAIN_MENU::DELIVER',css:'ico2 deliver',disabled:true},{"title":'MAIN_MENU::BLACK_LIST',css:'ico2 blacklist',disabled:true},{"title":'MAIN_MENU::WHITE_LIST',css:'ico2 whitelist',disabled:true});del={disabled:true};break;case'QL':aMenu.push({"title":'MAIN_MENU::NEW',"arg":'new_ql',css:'ico2 new'});if(ids[1]==='SPAM_QUEUE/Blacklist')
aMenu.push({"title":'MAIN_MENU::WHITE_LIST',css:'ico2 whitelist',disabled:true});else
aMenu.push({"title":'MAIN_MENU::BLACK_LIST',css:'ico2 blacklist',disabled:true});aMenu.push({"title":'POPUP_ITEMS::SEND_EMAIL_TO',css:'ico2 send',disabled:true});del={disabled:true};break;case'G':aMenu.push({"title":'POPUP_ITEMS::RECOVER',css:'ico2 recover',disabled:true});if(!dataSet.get('main',['keep_deleted_items_force_expiration'])){aMenu.push({"title":'MAIN_MENU::EMPTY_FOLDER',"arg":'empty',css:'color2 ico2 empty'});del={disabled:true};}
break;}}}
else
if(ids.length===3){var bSingle=ids[2].length===1,id=bSingle?ids.slice(0,2).concat(ids[2][0]):null;switch(sType){case'M':var sPath=this.__currentFolder.join('/'),bTemplates=sPath===GWOthers.getItem('DEFAULT_FOLDERS','templates'),bSent=aFolder.DEFAULT=='S';if(bSingle){if(bTemplates){aMenu.push({"title":'MAIN_MENU::NEW_FROM_TEMPLATE','arg':'edit_message',css:'ico2 from_template'},{"title":'POPUP_ITEMS::EDIT','arg':'edit_template',css:'ico2 edit'});}
else{if(aFolder.DEFAULT=='D'){aMenu.push({"title":'POPUP_ITEMS::EDIT',css:'ico2 edit','arg':'edit_message',disabled:!aAccess.modify});}
if(aFolder.SPAM){aMenu.push({"title":'MAIN_MENU::REPLY_TO_SENDER',"arg":'reply',css:'ico2 reply'});}
else
if(!aFolder.RSS){aMenu.push({"title":'MAIN_MENU::REPLY_TO_SENDER',"arg":'reply',css:'ico2 reply',disabled:bSent},{"title":'MAIN_MENU::REPLY_TO_ALL',"arg":'reply_all',css:'ico2 reply_all'});}
aMenu.push({"title":'MAIN_MENU::FORWARD','arg':'forward',css:'ico2 forward'});}
if(!bTemplates&&!aFolder.RSS&&aFolder.DEFAULT!=='D'){if(aFolder.SPAM){if(dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Whitelist'])){aMenu.push({"title":'MAIN_MENU::WHITE_LIST',"arg":'whitelist_sender',css:'ico2 whitelist'});}}
else
if(dataSet.get('folders',[sPrimaryAccount,'SPAM_QUEUE/Blacklist'])){aMenu.push({"title":'MAIN_MENU::BLACK_LIST',"arg":'blacklist_sender',css:'ico2 blacklist'});}}
if(this.__currentView!='mail_view_list'&&aFolder.DEFAULT!='H'){aMenu.push({'title':'MAIN_MENU::PRINT','arg':'print',css:'ico2 print'});}}
else{aMenu.push({"title":'POPUP_ITEMS::MOVE_MAIL_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_MAIL_TO','arg':'copy',css:'ico2 copy'},{"title":'POPUP_ITEMS::MARK_AS_READ','arg':'mark_read',css:'ico2 markread',disabled:!aAccess.modify},{"title":'POPUP_ITEMS::MARK_AS_UNREAD','arg':'mark_unread',css:'ico2 markunread',disabled:!aAccess.modify});if(!bTemplates&&!aFolder.RSS&&aFolder.DEFAULT!=='D'){aMenu.push(aFolder.SPAM?{"title":'MAIN_MENU::WHITE_LIST',"arg":'whitelist_sender',css:'ico2 whitelist'}:{"title":'MAIN_MENU::BLACK_LIST',"arg":'blacklist_sender',css:'ico2 blacklist'});}}
del={disabled:!aAccess.remove};break;case'E':if(bSingle){var iFlags=dataSet.get('items',id.concat('EVNFLAGS'));aMenu.push({"title":'MAIL_VIEW::ACCEPT','arg':'accept',css:'ico2 accept',disabled:!(iFlags&32)},{"title":iFlags&2?'MAIL_VIEW::DECLINE':'MAIN_MENU::DELETE','arg':'delete',css:'ico2 '+(iFlags&2?'decline':'delete'),disabled:!aAccess.remove});}
else{aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_ITEM_TO','arg':'copy',css:'ico2 copy'});}
break;case'F':var bLocked=false;if(bSingle){sLockID=dataSet.get('items',id.concat('EVNLOCKOWN_ID'));bLocked=sLockID&&sLockID!=sPrimaryAccountGWID,sName=dataSet.get('items',id.concat('EVNTITLE'));if(Item.officeSupport(sName)){var aArgAuto=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName)]],aArgWeb=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName)]],aArgWebView=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName),'view']],aArgExt=[Item.officeOpen,[{aid:id[0],fid:id[1],iid:id[2]},[Item.downloadFile,[id]],Path.extension(sName),'external']],bIWD=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';aMenu.push({"title":'POPUP_ITEMS::OPEN',css:'ico2 open',"arg":aArgAuto,nodes:[{"title":'DOCUMENT::OPENDOCUMENT',css:'ico2 open_edit','arg':aArgWeb,disabled:!bIWD},{"title":'DOCUMENT::OPENDOCUMENTVIEW',css:'ico2 open_edit','arg':aArgWebView,disabled:!bIWD},{"title":'OFFICELAUNCHER::OFFICESUITE',css:'ico2 open_suite','arg':aArgExt}]},{"title":'POPUP_ITEMS::DOWNLOAD_FILE',css:'ico2 download',"arg":'download_file'});}
else
aMenu.push({"title":'POPUP_ITEMS::DOWNLOAD_FILE',css:'ico2 download',"arg":'download_file'});}
else{aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_ITEM_TO','arg':'copy',css:'ico2 copy'});}
del={disabled:!aAccess.remove||bLocked};break;case'C':if(bSingle){var item=dataSet.get('items',id)||{};aMenu.push({"title":'IM::SEND_MAIL',css:'ico2 send',"arg":'send'},{"title":'MAIN_MENU::DIAL',css:'ico2 dial',"arg":'dial',disabled:item.ITMCLASS=='L'});if(sPrimaryAccountCHAT)
aMenu.push({title:'POPUP_ITEMS::INVITE_TEAMCHAT',css:'ico2 teamchat',arg:'invite_to_teamchat'});}
else{aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_ITEM_TO','arg':'copy',css:'ico2 copy'},{"title":'MAIN_MENU::PRINT',css:'ico2 print',"arg":'print'});}
del={disabled:!aAccess.remove};break;case'T':if(!bSingle){aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_ITEM_TO','arg':'copy',css:'ico2 copy'});}
aMenu.push({"title":'MAIN_MENU::PRINT',css:'ico2 print',"arg":'print'});del={disabled:!aAccess.remove};break;case'N':if(!bSingle){aMenu.push({"title":'POPUP_ITEMS::MOVE_ITEM_TO','arg':'move',css:'ico2 move',disabled:!aAccess.remove},{"title":'POPUP_ITEMS::COPY_ITEM_TO','arg':'copy',css:'ico2 copy'});}
aMenu.push({"title":'MAIN_MENU::PRINT',css:'ico2 print',"arg":'print'});del={disabled:!aAccess.remove};break;default:bShort=true;switch(sType){case'Q':aMenu.push({"title":'MAIN_MENU::DELIVER',"arg":'new_doc',css:'ico2 deliver'},{"title":'MAIN_MENU::BLACK_LIST',"arg":'blacklist',css:'ico2 blacklist'},{"title":'MAIN_MENU::WHITE_LIST',"arg":'whitelist',css:'ico2 whitelist'});del=true;break;case'QL':aMenu.push({"title":'MAIN_MENU::NEW',"arg":'new_ql',css:'ico2 new'});if(ids[1]==='SPAM_QUEUE/Blacklist')
aMenu.push({"title":'MAIN_MENU::WHITE_LIST',"arg":'whitelist',css:'ico2 whitelist'});else
aMenu.push({"title":'MAIN_MENU::BLACK_LIST',"arg":'blacklist',css:'ico2 blacklist'});aMenu.push({"title":'POPUP_ITEMS::SEND_EMAIL_TO',"arg":'send',css:'ico2 send'});del=true;break;case'G':aMenu.push({"title":'POPUP_ITEMS::RECOVER',"arg":'recover',css:'ico2 recover'});if(!dataSet.get('main',['keep_deleted_items_force_expiration'])){del=true;aMenu.push({"title":'MAIN_MENU::EMPTY_FOLDER',"arg":'empty',css:'color2 ico2 empty'});}
break;}}}
if(!bNoMore&&(!bShort&&aMenu.length))
aMenu.push({"title":'COMMON::MORE',css:'ico2 more noarrow',"arg":'more',nodetype:'click',keep:true,callback:[this,'__more_menu',[dataSet.get('items',[ids[0],ids[1],ids[2]])]]});if(ids.length===2&&!bShort&&sType!='I'&&aRights.owner){var title='POPUP_FOLDERS::SHARING';if(sType==='E'){title='POPUP_FOLDERS::SHARING_CALENDAR';}else if(sType==='X'){title='POPUP_FOLDERS::SHARING_ACCOUNT';}
aMenu.push({"title":title,css:'ico2 share_folder',"arg":'share',disabled:ids[0]!=sPrimaryAccount});}
del&&aMenu&&aMenu.push({"title":'MAIN_MENU::DELETE',"arg":'delete',css:'color2 ico2 delete',disabled:(del||{}).disabled});this._fill(aMenu,'static');};_me.__more_menu=function(e,id,parentData,aData){var aMenu,sType=WMFolders.getType(this.__currentFolder),aAccess=WMFolders.getAccess(this.__currentFolder),ids=this.__currentIDs;try{if(ids[2]&&ids[2].length){storage.library('obj_context_item');var id=ids.slice(0,2).concat(ids[2][0]);switch(sType){case'M':aMenu=obj_context_item.prototype.__createMailMenu.call(null,id,ids,ids[2]&&ids[2].length>1,dataSet.get('items',id.concat('FROM')),aAccess,true);break;default:if(sType=='C'&&aData.ITMCLASS=='L')
sType='L';aMenu=obj_context_item.prototype.__createGWMenu.call(null,id,ids,sType,ids[2]&&ids[2].length>1,"",aAccess,{C:'ITMCLASSIFYAS',F:'EVNFILENAME'}[sType]||"EVNTITLE",gui.frm_main.main.list,true,aData);break;}}
else{storage.library('obj_tree_folder_context');storage.library('obj_context_folder');aMenu=obj_tree_folder_context.__createFolderMenu({aid:this.__currentFolder[0],fid:this.__currentFolder[1]},true);parentData.arg2=obj_context_folder.prototype._onclick;}}
catch(r){aMenu=false;}
return aMenu||false;};_me._onclick=function(e,elm,id,arg){if(e.__arg2){if(!e.__arg2.apply({_owner:gui.frm_main.bar.tree.folders},arguments)){return;}}
else
if(Is.Array(arg)){executeCallbackFunction(arg);return;}
var sType=WMFolders.getType(this.__currentFolder),sPath=this.__currentFolder.join('/'),ids=this.__currentIDs,aFolderId={aid:this.__currentFolder[0],fid:this.__currentFolder[1]};if(sType==='X')
delete aFolderId.fid;var args=clone(arg);if(Is.Object(arg))
arg=arg.arg;switch(arg){case'new_mail':NewMessage.compose({alias:Item.getAliasFromPath(sPath)});break;case'new_template':NewMessage.compose({template:true});break;case'add_folder':storage.library('obj_context_folder');Folder.addFolder(aFolderId,[obj_context_folder.__openFolder]);break;case'add_account':storage.library('obj_context_folder');obj_context_folder.prototype._onclick.call(obj_context_folder.prototype,null,null,null,{aid:'',fid:'',method:'add_account'});break;case'add_favorite':if(gui.frm_main.bar&&gui.frm_main.bar.fav)
gui.frm_main.bar.fav._ondrop({value:[{aid:this.__currentFolder[0],fid:this.__currentFolder[1]}],type:'folder'});break;case'change_channel':Folder.changeChannel(aFolderId);break;case'upload_file':gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[gui.frm_main,'__copyItem',[this.__currentFolder]],this.__currentFolder[0],this.__currentFolder[1],'','r',false,['F','I','X'],'X');break;case'download_file':Item.downloadFile([ids[0],ids[1],ids[2][0]]);break;case'new_ql':gui._create('frm_blackwhite','frm_blackwhite','','',this.__currentFolder[0],this.__currentFolder[1]);break;case'empty':Folder.empty(aFolderId);break;case'share':Folder.share(aFolderId);break;case'new_item':switch(sType){case'E':if(gui.frm_main.main&&(gui.frm_main.main._type==='frm_main_calendar_dayweek'||gui.frm_main.main._type==='frm_main_calendar_month'))
gui.frm_main.main._createEvent();else
Item.openwindow(this.__currentFolder,getActualEventTime(),null,sType);break;case'I':var aMap={'.docx':'_word','.xlsx':'_excel','.pptx':'_ppoint'};if(aMap[args.type]&&gui.frm_main.main[aMap[args.type]])
gui.frm_main.main[aMap[args.type]]();break;default:var aValues;if(args.type)
aValues={'ATTACHMENTS':[{'values':{'ATTTYPE':'document','ATTDESC':args.type}}]};Item.openwindow(this.__currentFolder,aValues,null,sType);}
break;case'tch_upload':if(gui.frm_main.main._attachFile)
gui.frm_main.main._attachFile();break;case'add_room':Folder.addFolder(aFolderId,[Folder.openFolder]);break;case'invite':if(gui.frm_main.main._addMember)
gui.frm_main.main._addMember();break;case'print_calendar':case'print_list':if(gui.frm_main.main&&gui.frm_main.main._print)
gui.frm_main.main._print(arg=='print_calendar');break;default:if(ids.length===3){var id=this.__currentFolder.concat(ids[2].slice(0,1));switch(arg){case'recover':Item.recover(ids);break;case'deliver':OldMessage.deliver(ids);break;case'whitelist':OldMessage.whitelist(ids);break;case'blacklist':OldMessage.blacklist(ids);break;case'send':case'invite_to_teamchat':var item=dataSet.get('items',id),email;if(item.ITMCLASS=='L')
email='['+ids[1]+'::'+(item.ITMCLASSIFYAS||item.ITMTITLE)+']';else
email=item.LCTEMAIL1||item.LCTEMAIL2||item.LCTEMAIL3||item.SNDEMAIL;if(email){if(arg=='send')
NewMessage.compose({to:email});else{Item.invite_tch(email);}}
break;case'dial':gui.frm_main.__showDialDialog.apply(null,id);break;case'delete':if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list.__deleteItems)
gui.frm_main.main.list.__deleteItems({aid:ids[0],fid:ids[1]},ids[2]);else
if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.calendar){if(ids[2].length==1){var aid=ids[0],fid=ids[1],id=ids[2][0],oRepeating,n;if(Item.hasReccurence([aid,fid,id]))
oRepeating=dataSet.get('items',[aid,fid,id]);if((n=id.indexOf('|'))>=0)
id=id.substr(0,n);Item.remove([aid,fid,[id]],false,oRepeating,gui.frm_main.main.calendar);}}
else
Item.remove(ids);break;case'mark_read':OldMessage.markAsRead(ids);break;case'mark_unread':OldMessage.markAsUnread(ids);break;case'reply':OldMessage.reply(id);break;case'reply_all':OldMessage.reply(id,true);break;case'forward':OldMessage.forward(id);break;case'edit_message':OldMessage.edit(id);break;case'edit_template':OldMessage.edit(id,{template:true});break;case'blacklist_sender':OldMessage.blacklistSender(ids);break;case'whitelist_sender':OldMessage.whitelistSender(ids);break;case'accept':WMItems.imip({aid:id[0],fid:id[1],iid:id[2]},'accept',[function(bOK){if(bOK){var itm=dataSet.get('items',id);if(itm['EVNFLAGS']&32){itm['EVNFLAGS']-=30;dataSet.update('items',id);this.__menu(this.__currentIDs);}
else
Item.__refreshView(ids);}}.bind(this)]);break;case'move':Item.move(ids);break;case'copy':Item.copy(ids);break;case'print':switch(sType){case'M':if(gui.frm_main.main&&gui.frm_main.main.mailview)
gui.frm_main.main.mailview._print();default:Item.print(ids);}
break;}}}};

/* client/inc/obj_im.js */
_me=obj_im.prototype;function obj_im(){};_me.__constructor=function(){var me=this;this._telemetry='id';this.__activeUser={};this.__chat=null;this.__showOnlineContactsOnly=GWOthers.getItem('IM','hide_offline_contacts')==='1'&&GWOthers.getItemAccess('IM','hide_offline_contacts')===false;if(this.__showOnlineContactsOnly){this.__showAllContacts=false;}
else{this.__showAllContacts=Cookie.get(['im','show_all_contacts'])?true:false;}
this.__activeBuffer={};this.__noRefresh=false;this.__doRefresh=false;this.__totalHeight=0;this.__renderedHeight=0;this.__lastScrollTop=0;this.__renderedScrollTop=0;this.__extraRendering=1000;this.__scrollTimeoutId;this.__avatarCache={};if(GWOthers.getItem('RESTRICTIONS','DISABLE_IM_CONTACT_MANAGEMENT')==1)
this.btn_add._disabled(true);else
this.btn_add._onclick=function(){if(me._is_active())
me._add_item();};if(this.__showOnlineContactsOnly){this.btn_show._disabled(true);}
else{if(!me.__showAllContacts){addcss(this.btn_show._main,'active');}
this.btn_show._title(this.__showAllContacts?'IM::HIDE':'IM::SHOW');this.btn_show._onclick=function(){me.__showAllContacts=!me.__showAllContacts;Cookie.set(['im','show_all_contacts'],me.__showAllContacts?1:'',true);this._title(me.__showAllContacts?'IM::HIDE':'IM::SHOW');togglecss(this._main,'active');me._fill();};}
this.inp_search._onkeyup=function(e){if(e.keyCode===27){this._value('');me.__hide2();if(this.__lastValue==='')
me._focus();else
me._fill();this.__lastValue='';}
else{var value=this._value();if(this.__lastValue!==value){if(this.__lastValue===undefined||(this.__lastValue&&this.__lastValue.length<value.length)){me.__body.parentNode.scrollTop=0;me.__lastScrollTop=0;}
this.__lastValue=value;me.__show2();me._fill();}}};this.inp_search._onblur=function(){if(!this._value())me.__hide2();};var hasFocus=false;this._main.setAttribute('tabindex',-1);if(~currentBrowser().indexOf('MSIE')){AttachEvent(this._main,'onclick',function(){hasFocus=true;});}
else{AttachEvent(this._main,'onfocus',function(){hasFocus=true;});}
AttachEvent(this._main,'onblur',function(){hasFocus=false;});AttachEvent(this._main,'onkeydown',function(e){if(hasFocus&&!e.isComposing&&e.keyCode!==229&&(e.key||'').length===1){me.inp_search._focus();}});this.__xmpp=gui.socket.xmpp;this.__active=this._getAnchor('active');this.__recent=this._getAnchor('recent');this.__body=this._getAnchor('body');this._create('scroll_body','obj_scrollbar');this.scroll_body._scrollbar(this.__body.parentNode,this.__body.parentNode.parentNode);this.__body.parentNode.onscroll=function(e){var scrollTop=Math.max(Math.min(this.scrollHeight-this.offsetHeight,this.scrollTop),0);if(Math.abs(me.__renderedScrollTop-scrollTop)>me.__extraRendering){if(me.__scrollTimeoutId){clearTimeout(me.__scrollTimeoutId);}
me.__scrollTimeoutId=setTimeout(function(){me.__lastScrollTop=scrollTop;me._fill();},50);}};this.__body.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.__dndtimer){window.clearTimeout(me.__dndtimer);delete me.__dndtimer;}
if(elm!=this){switch(elm.tagName){case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');case'LI':if(elm.tagName=='LI'&&elm.id){var id=Path.basename(decodeURIComponent(elm.id));if(e.button>0&&me.__activeUser[id])return;if(e.button==0){var x=e.clientX,y=e.clientY;gui._obeyEvent('mouseup',[me,'__dndDispatch']);me.__dndtimer=setTimeout(function(){if(!me.__activeUser[id])
me._activate(id,e.ctrlKey);me.__initdrag(id,'jabber',x,y);},500);}}}}};this.__body.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm!=this){switch(elm.tagName){case'DIV':if(e.button==0){e.cancelBubble=true;if(e.preventDefault){e.preventDefault();}
if(e.stopPropagation){e.stopPropagation();}
me._open(decodeURIComponent(elm.id.substr(me._pathName.length+1)));}
break;case'EM':var aPos=getSize(elm);this.oncontextmenu({target:Is.Child(elm,'LI'),clientX:aPos.x,clientY:aPos.y+(aPos.h/2)});e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');case'LI':if(elm.id){var id=Path.basename(decodeURIComponent(elm.id));if(e.button>0&&me.__activeUser[id])return;me._activate(id,e.ctrlKey);}}}};this.__body.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm!=this){switch(elm.tagName){case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');case'LI':if(elm.id){var id=Path.basename(decodeURIComponent(elm.id));me._activate(id,e.ctrlKey);me._chat(id);}}}};this.__body.onmouseover=function(e){var e=e||window.event,elm=e.target||e.srcElement;switch(elm.tagName){case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');}
if(elm.id){var sFrom=Path.basename(decodeURIComponent(elm.id)),iTime=dataSet.get('xmpp',['roster',sFrom,'status_time']);if(iTime){var d=new IcewarpDate(),t=d.unix()-iTime,s=dataSet.get('xmpp',['roster',sFrom,'show'])||'offline';s=getLang('STATUS::'+s.toUpperCase(),'',2);if(s){if(t<60)
elm.title=getLang('IM::STATUS_SEC',[s]);else
if(t<3600)
elm.title=getLang('IM::STATUS_MIN',[s,Math.ceil(t/60)]);else
elm.title=getLang('IM::STATUS_HOUR',[s,Math.ceil(t/3600)]);}}
else
elm.title='';}};this.__body.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;switch(elm.tagName){case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');}
if(elm.id){var aMenu,bLogin=!me._is_active(),id=Path.basename(decodeURIComponent(elm.id)),bManagement=GWOthers.getItem('RESTRICTIONS','DISABLE_IM_CONTACT_MANAGEMENT')==1;if(elm.tagName=='LI'){if(me.__activeUser[id]&&count(me.__activeUser)>1)
id='';else
me._activate(id);var aTmp=me._getGroups(),aGrp=[{'title':'IM::OTHER','arg':{method:'grp_set',grp:'',id:id}},{'title':'-'}];for(var i in aTmp)
if(i!='*')
aGrp.push({'text':i,'arg':{method:'grp_set',grp:i,id:id}});if(aGrp.length>2)
aGrp.push({'title':'-'});aGrp.push({'title':'IM::NEW_GROUP','arg':{method:'grp_new',id:id}});if(id===''){aMenu=[{'title':'IM::GROUPMSG','arg':{'method':'chat'},disabled:bLogin},{'title':'IM::SEND_MAIL','arg':{'method':'send'}},{'title':'-'},{'title':'IM::GROUP',nodes:aGrp,disabled:bLogin},{'title':'-'},{'title':'MAIN_MENU::FILTER','arg':{'method':'search'}},{'title':'-'},{'title':'MAIN_MENU::DELETE','arg':{'method':'user_remove'},disabled:bLogin||bManagement}];}
else{aMenu=[{'title':'IM::CHAT','arg':{'method':'chat',id:id},disabled:bLogin}];if(window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){aMenu.push({'title':'IM::AUDIO_CALL','arg':{'method':'call',id:id},disabled:bLogin||id.indexOf('@')<0});aMenu.push({'title':'IM::VIDEO_CALL','arg':{'method':'call_video',id:id},disabled:bLogin||id.indexOf('@')<0||IceSIP&&!IceSIP.supported()});}
if(window.sPrimaryAccountCONFERENCE)
aMenu.push({'title':(dataSet.get('conference',['live'])?'IM::INVITE':'IM::CONFERENCE'),'arg':{'method':'conference',id:id},disabled:bLogin||id.indexOf('@')<0});aMenu.push({'title':'IM::SEND_MAIL','arg':{'method':'send',id:id},disabled:id.indexOf('@')<0},{'title':'-'},{'title':'IM::VCARD','arg':{'method':'vcard',id:id},disabled:bLogin||id.indexOf('@')<0},{'title':'-'},{'title':'IM::RENAME','arg':{'method':'user_rename',id:id},disabled:bLogin},{'title':'IM::GROUP',nodes:aGrp,disabled:bLogin},{'title':'IM::SUBSCRIPTION',nodes:[{'title':'IM::SEND','arg':{method:'sub_add',id:id}},{'title':'IM::REQUEST','arg':{method:'sub_get',id:id}},{'title':'IM::REMOVE','arg':{method:'sub_remove',id:id}}],disabled:bLogin},{'title':'-'},{'title':'MAIN_MENU::DELETE','arg':{'method':'user_remove',id:id},'css':'color2','disabled':bLogin||bManagement});}}
else
if(elm.tagName=='DIV')
if(elm==me.__body)
aMenu=[{'title':'IM::ADD','arg':{'method':'user_add'},disabled:bLogin||bManagement},{'title':'IM::ADD_SERVICE','arg':{'method':'user_gate'},disabled:bLogin},{'title':'-'},{'title':'MAIN_MENU::FILTER','arg':{'method':'search'}},{'title':'COMMON::APPEARANCE',nodes:[{'title':'COMMON::EXPAND','arg':{method:'im_mode',v:2},css:'ico2'+(Cookie.get(['hide_im'])==2?' check':'')},{'title':'COMMON::COLLAPSED','arg':{method:'im_mode',v:1},css:'ico2'+(Cookie.get(['hide_im'])==1?' check':'')},{'title':'COMMON::AUTOCOLLAPSED','arg':{method:'im_mode'},css:'ico2'+(Cookie.get(['hide_im'])?'':' check')}]}];else
if(elm.id)
aMenu=[{'title':'IM::GROUPMSG','arg':{'method':'chat',id:'~'+id},disabled:bLogin},{'title':'IM::ADD','arg':{'method':'user_add',id:id},disabled:bLogin||bManagement},{'title':'IM::ADD_GATEWAY','arg':{'method':'user_gate',id:id},disabled:bLogin},{'title':'-'},{'title':'IM::RENAME','arg':{'method':'grp_rename',id:id},'disabled':id=='*'||id=='~'||bLogin},{'title':'-'},{'title':'MAIN_MENU::FILTER','arg':{'method':'search'}},{'title':'COMMON::APPEARANCE',nodes:[{'title':'COMMON::EXPAND','arg':{method:'im_mode',v:2},css:'ico2'+(Cookie.get(['hide_im'])==2?' check':'')},{'title':'COMMON::COLLAPSED','arg':{method:'im_mode',v:1},css:'ico2'+(Cookie.get(['hide_im'])==1?' check':'')},{'title':'COMMON::AUTOCOLLAPSED','arg':{method:'im_mode'},css:'ico2'+(Cookie.get(['hide_im'])?'':' check')}]},{'title':'-'},{'title':'IM::REM_GRP','arg':{'method':'grp_remove',id:id},'disabled':id=='*'||id=='~'||bLogin},{'title':'IM::REM_GRPC','arg':{'method':'grp_removec',id:id},'disabled':bManagement||id=='*'||id=='~'||bLogin}];var cmenu=gui._create("cmenu","obj_context",'','',me);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);cmenu._onclick=function(e,elm,id,arg){me._oncontext(e,elm,id,arg);};}
return false;};this.__active.onmouseover=this.__body.onmouseover;this.__active.ondblclick=this.__body.ondblclick;this.__active.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm!=this){switch(elm.tagName){case'DIV':for(var uid in me.__activeBuffer){me._activate(uid);me._chat(uid);break;}
break;case'B':gui.frm_main._pin_im();break;case'EM':me.__body.onclick(e);break;case'H3':case'H4':case'SPAN':case'IMG':elm=Is.Child(elm,'LI');case'LI':if(elm.id){var id=Path.basename(decodeURIComponent(elm.id));if(e.button>0&&me.__activeUser[id])return;me._activate(id,e.ctrlKey);}}}};this.__recent.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm!=this)
switch(elm.tagName){case'B':gui.frm_main._pin_im();break;case'DIV':if(me.__chat&&!me.__chat._destructed){me.__chat._focus();}
else{var r=Cookie.get(['im_recent'])||[];me._chat(r.shift(),'','','','',true);}}};this.__recent.oncontextmenu=this.__active.oncontextmenu=function(e){var e=e||window.event;var a={target:me.__body,clientX:e.clientX,clientY:e.clientY};return me.__body.oncontextmenu(a);};this._listen('xmpp',['roster']);this.__xmpp._obeyEvent('response',[this,'_response']);this.__xmpp._obeyEvent('status',[this,'_status_response']);this._add_destructor('__onDestruct');var sStatus=Cookie.get(['im','status'])||'offline';if(sStatus=='offline'&&GWOthers.getItem('IM','auto_status')>'0'){sStatus='online';}
if(sStatus!='offline')
this.__xmpp._presence(sStatus);var r=Cookie.get(['im_recent']);if(Is.Array(r)&&r.length)
removecss(this.__recent,'empty');if(gui.frm_main&&gui.frm_main.dnd)
gui.frm_main.dnd.registr_drop(this,['jabber']);gui._obeyEvent('click',[function(e){if(this._destructed)
return false;if(this.inp_search&&this.inp_search._value().length){var elm=e.target||e.srcElement;if(elm&&!Is.Child(elm,this._main)){this.inp_search._value('');this.__hide2();this._fill();}}}.bind(this)]);gui._obeyEvent('resize',[function(){if(me._destructed)
return false;me.__height();}]);};_me.__dndDispatch=function(){if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
return false;};_me._dock=function(bRefresh){if(!this._docked||bRefresh){if(this._getStatus()=='offline')
gui.frm_main._rightDock();else
gui.frm_main._rightDock(false);this._docked=true;}
return true;};_me._undock=function(bRefresh){if(this._docked||bRefresh){gui.frm_main._rightDock(Cookie.get(['hide_im'])==2);this._docked=false;return true;}};_me.__getVisibleRange=function(){var scrollTop,viewPortHeight,documentHeight;scrollTop=this.__body.parentNode.scrollTop||0;documentHeight=Math.max(document.documentElement.clientHeight,window.innerHeight||0);viewPortHeight=this.__body.parentNode.clientHeight===0?documentHeight:Math.min(this.__body.parentNode.offsetHeight,documentHeight);viewPortHeight=Math.max(viewPortHeight,100);return{scrollTop:scrollTop,viewPortHeight:viewPortHeight};};_me._activate=function(id,bCtrl){var elm,aData=dataSet.get('xmpp',['roster']);for(var i in this.__activeUser)
if((!bCtrl&&i!=id)||(bCtrl&&i==id)){if(aData[i]&&(elm=document.getElementById(this._pathName+'/'+encodeURIComponent(aData[i].group||'*')+'/'+encodeURIComponent(i)))){removecss(elm,'active');}
delete this.__activeUser[i];if(bCtrl){this._activate_active();return false;}}
if(id&&!this.__activeUser[id]){if(aData[id]&&(elm=document.getElementById(this._pathName+'/'+encodeURIComponent(aData[id].group||'*')+'/'+encodeURIComponent(id))))
addcss(elm,'active');this.__activeUser[id]=true;this._activate_active();return true;}
this._activate_active();return false;};_me._openQueue=function(){if(this._is_active()){var queue=Cookie.get(['im','queue'])||[];if(count(queue)){for(var i in queue)
if(queue[i])
this._chat(i,'','','','',true);return true;}}
return false;};_me.__show2=function(){addcss(this._main,'search');};_me.__hide2=function(){removecss(this._main,'search');};_me._is_active=function(){return this.__xmpp&&this.__xmpp._state()>=5;};_me._add_item=function(sGroup,sJID,sName,sTab){gui._create('frm_im_add','frm_im_add','','',this.__xmpp,sGroup,sJID,sName,sTab);};_me._open=function(id){Cookie.set(['im','roster',id],Cookie.get(['im','roster',id])?undefined:1);this._fill();};_me.__onDestruct=function(aHandler){this.__xmpp._presence('offline','',[function(){if(aHandler)
executeCallbackFunction(aHandler);dataSet.remove(this._listener,this._listenerPath,true);this.__xmpp._disobeyEvent('response',[this,'_response']);this.__xmpp._disobeyEvent('status',[this,'_status_response']);}.bind(this)]);};_me._oncontext=function(e,elm,id,arg){if(!arg)return;switch(arg.method){case'send':if(arg.id)
arg.id=MailAddress.createEmail(dataSet.get('xmpp',['roster',arg.id,'name']),arg.id);else{arg.id='';for(var i in this.__activeUser)
if(i.indexOf('@')>-1)
arg.id+=(arg.id?', ':'')+MailAddress.createEmail(dataSet.get('xmpp',['roster',i,'name']),i);}
if(arg.id)
NewMessage.compose({to:arg.id});break;case'file':gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[this.__chat._getChat(arg.id),'__addItems'],sPrimaryAccount,'','','r',false,['F','X']);break;case'chat':if(!arg.id){arg.id='';for(var i in this.__activeUser)
arg.id+=(arg.id?'; ':'')+i;if(arg.id)
arg.id='~'+arg.id;}
if(arg.id){this._activate(arg.id);this._chat(arg.id);}
break;case'conference':storage.library('wm_conference');var running=dataSet.get('main',['conference']);if(running){wm_conference.get(running).invite([arg.id]);}else{wm_conference.create(function(conference){conference.join();conference.invite([arg.id]);});}
break;case'vcard':gui._create('frm_im_vcard','frm_im_vcard','','',arg.id,this.__xmpp);break;case'sub_add':this.__xmpp._user_subscribed(arg.id);break;case'search':this.__show2();this._focus();break;case'sub_get':this.__xmpp._user_subscribe(arg.id);break;case'sub_remove':this.__xmpp._user_unsubscribed(arg.id);break;case'user_remove':gui._create('frm_confirm','frm_confirm','','',[this,'_removeUsr',[[arg.id]]],'IM::REMOVE',arg.id?'IM::REMOVE_ACCOUNT':'IM::REMOVE_ACCOUNTS',[arg.id]);break;case'user_gate':case'user_add':this._add_item(arg.id=='*'||arg.id=='~'?'':arg.id,'','',arg.method=='user_gate'?'gateway':'');break;case'call':gui.frm_main._call(arg.id);break;case'call_video':gui.frm_main._call(arg.id,true);break;case'grp_set':this._addGroup(arg.grp,arg.id);break;case'grp_new':gui._create('frm_input','frm_input','','',[this,'_addGroup',[arg.id]],'IM::NEW_GROUP');break;case'user_rename':var aTmp=dataSet.get('xmpp',['roster',arg.id]);this.__renameInput(document.getElementById(this._pathName+'/'+encodeURIComponent(aTmp.group)+'/'+encodeURIComponent(arg.id)),aTmp.name||arg.id,[this,'_renameUsr',[arg.id]]);break;case'grp_rename':this.__renameInput(document.getElementById(this._pathName+'/'+encodeURIComponent(arg.id)),arg.id,[this,'_oncontext',['','',{method:'grp_rename_response',id:arg.id}]]);break;case'grp_rename_response':case'grp_remove':this.__xmpp._group_rename(arg.id,e);break;case'im_mode':Cookie.set(['hide_im'],arg.v||'');gui.frm_main._rightDock(arg.v==2);break;case'grp_removec':var aID=[],aDS=dataSet.get('xmpp',['roster']);for(var i in aDS)
if(aDS[i].group==arg.id)
aID.push(i);if(aID.length)
this._removeUsr(aID);}};_me._removeUsr=function(aID){if(!aID[0]){aID=[];for(var i in this.__activeUser)
aID.push(i);}
if(aID.length){this.__xmpp._user_remove(aID,[function(){for(var i in aID)
Cookie.set(['im','queue',aID[i]]);}]);}};_me._renameUsr=function(sName,sJID){if(sJID){var aTmp=dataSet.get('xmpp',['roster',sJID]);if(aTmp&&aTmp.name!=sName)
this.__xmpp._user_rename(sJID,sName==sJID?'':sName,aTmp.group);}};_me._addGroup=function(sGrp,sJID){if(Is.Array(sJID)){for(var i in sJID)
if(sJID[i])
this._addGroup(sGrp,sJID[i]);}
else
if(!sJID){for(var i in this.__activeUser)
if(i)
this._addGroup(sGrp,i);}
else{var aTmp=dataSet.get('xmpp',['roster',sJID]);if(aTmp&&aTmp.group!=sGrp)
this.__xmpp._user_rename(sJID,aTmp.name,(sGrp=='*'||sGrp=='~'?'':sGrp));}};_me._focus=function(){this._main.focus();};_me.__renameInput=function(hAnchor,sText,oResponse){var me=this;this.__noRefresh=true;removecss(hAnchor,'active');addcss(hAnchor,'edit');hAnchor.innerHTML='';var inp=mkElement('input',{type:'text',className:'rename_input'});inp.value=sText;inp.onmousedown=function(e){var e=e||window.event;e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();};inp.onclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};inp.onblur=function(e){me._doRefresh(true);};inp.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 13:this.onblur=null;if(oResponse)
executeCallbackFunction(oResponse,this.value);me._doRefresh(true);break;case 27:this.blur();break;}};inp.onsubmit=function(){return false;};hAnchor.appendChild(inp);try{if(document.selection){var r=inp.createTextRange();r.collapse(true);r.moveStart("character",0);r.moveEnd("character",sText.length);r.select();}
else
inp.setSelectionRange(0,sText.length);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
inp.focus();};_me._inRoster=function(sUID){return dataSet.get('xmpp',['roster',sUID.toLowerCase(),'show'])||false;};_me._translateUID=function(sUID){return sUID.split('/').shift().toLowerCase();};_me._translateName=function(sUID){if(sUID){sUID=this._translateUID(sUID);return dataSet.get('xmpp',['roster',sUID,'name'])||sUID;}};_me._chat=function(sFrom,sTo,sBody,iDate,conference_id,bNoFocus){if(!this._is_active())return;var add_focus=bNoFocus?false:true;if(Is.String(sFrom)&&sFrom.length)
sFrom=sFrom?this._translateUID(sFrom):'';else{if(this.__chat&&!this.__chat._destructed){this.__chat._focus();this.__chat.tabs.inp_add._focus();return;}
else
sFrom='';add_focus=true;}
if(sBody&&!sTo){if(conference_id&&conference_id!=dataSet.get('conference',['id'])&&sPrimaryAccountCONFERENCE){if(dataSet.get('conference',['live'])){if(!gui.conferencealert)
gui.notifier._value({type:'alert',args:{header:'MAIN_MENU::CONFERENCE',text:'CONFERENCE::CHATALREADYCONFERENCE'}});}else
if(!gui.confirmconference){if(gui.notifier)
gui.notifier._value({type:'conference_invite',args:[conference_id]});}}
if(gui.frm_main&&gui.frm_main.sound&&GWOthers.getItem('IM','sound_notify')>0)
gui.frm_main.sound._play('im');if((!gui.frm_chat||!gui.frm_chat._getChat(sFrom)||!gui.frm_chat._getChat(sFrom)._isActive)&&GWOthers.getItem('LAYOUT_SETTINGS','notifications')!='2'&&gui.notifier&&gui.notifier._getPermissions()!='denied'&&gui.notifier._getPermissions()!='unsupported'){var sNotify='';if(Is.String(sBody))
sNotify=sBody;else
switch(sBody.type){case"geoloc":sNotify=getLang('IM::REC_GEO');break;case"file":sNotify=getLang('IM::REC_FILE',[sBody.desc]);break;}
var oNot=gui.notifier._value({type:'im',args:{jid:sFrom,text_plain:sNotify},aHandler:[this,'_chat',[sFrom]],});if(oNot){dataSet.add('xmpp',['roster',sFrom,'notification'],oNot,true);var oHandler=[function(e){try{if(oNot)
oNot.close();if(sFrom)
dataSet.remove('xmpp',['roster',sFrom,'notification'],true);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
gui._disobeyEvent('focus',oHandler);}];gui._obeyEvent('focus',oHandler);}}
if(gui.frm_main&&gui.frm_main.title)
gui.frm_main.title._add(getLang('TITLE::NEW_IM',[this._translateName(sFrom)]),5);if(!this._inRoster(sFrom))
dataSet.add('xmpp',['roster',sFrom],{show:'from',group:'~',user:sFrom});}
var bNew=false;if(!this.__chat||this.__chat._destructed==true)
if(!sBody||(GWOthers.getItem('IM','auto_chat')>0&&this._getStatus()!='dnd'&&!conference_id)){this.__chat=gui._create('frm_chat','frm_chat');this.__chat.__im=this;bNew=true;}
else
delete this.__chat;if(this.__chat){if(bNew){var r=Cookie.get(['im_recent']);if(Is.Array(r)){for(var i=0;i<r.length;i++)
if(r[i]!==sFrom){if(!sFrom)
sFrom=r[i];this.__chat._createChat(r[i]);}}}
if(sFrom){var oChat=this.__chat._createChat(sFrom,!sBody||bNew,true);if(this.__chat._docked){if(!sBody||(this._getStatus()!='dnd'&&GWOthers.getItem('IM','auto_chat')>0))
this.__chat._undock();else
if(sBody&&!conference_id){var dock=this.__chat._mydock||gui._dock;if(dock&&oChat){dataSet.add('xmpp',['roster',sFrom,'action'],'msg',true);dock._add(this.__chat,this.__chat._ondock().title,'event');}}}
if(oChat&&sBody&&!conference_id)
if(!oChat._isActive||!oChat.text._hasFocus())
this._add(sFrom);}}
if(!this.__chat||(sFrom&&this.__chat&&this.__chat._getChat(sFrom)&&this.__chat._getChat(sFrom)._wasActivated==false)){if(!sPrimaryAccountIMHISTORY||sFrom.indexOf('~')==0||Is.Defined(dataSet.get('xmpp',['roster',sFrom,'history']))){var oMessage={'from':sFrom,'to':sTo,'body':sBody,'date':iDate||(new IcewarpDate()).unix()};if(conference_id)
oMessage.conference=conference_id;var q=dataSet.get('xmpp',['roster',sFrom,'history'])||[];q.push(oMessage);dataSet.add('xmpp',['roster',sFrom,'history'],q,true);}
if(sBody&&!conference_id){dataSet.add('xmpp',['roster',sFrom,'action'],'msg',true);this._add(sFrom);dataSet.update('xmpp',['roster',sFrom,'action']);Cookie.set(['im','queue',sFrom],1);if(this.__chat)
this.__chat._getChat(sFrom)._animate();}
dataSet.update('main',['im']);return;}
if(sBody&&!conference_id)
this.__chat._getChat(sFrom)._animate();this.__chat._chat(sFrom,sTo,sBody,iDate,false,false);dataSet.update('main',['im']);this._undock();if(add_focus&&this.__chat){this.__chat._focus();if(sFrom==='')
this.__chat.tabs.inp_add._focus();}};_me._send=function(sTo,sBody,bConference){if(this._is_active()){var aTo=this._getGroupUsers(sTo);if(this.__chat&&this.__chat.tabs){if(aTo){if(this.__chat.__tabIndex[sTo]&&this.__chat.tabs[this.__chat.__tabIndex[sTo]])
this.__chat.tabs[this.__chat.__tabIndex[sTo]]._close();}
else
this.__chat._chat(sTo,sPrimaryAccount,sBody,false,false,true);}
if(bConference){if(gui.notifier)
gui.notifier._value({type:'invitation_sent',args:[sTo]});this.__xmpp._invitation(aTo||sTo,sBody);}
else{this.__xmpp._message(aTo||sTo,sBody);if(aTo){aTo.forEach(function(sTo){if(sTo!==sPrimaryAccount){var aData={MESSAGE:[{ATTRIBUTES:{FROM:sPrimaryAccount,TO:sTo},BODY:[{VALUE:sBody}]}]};this._response('sent',aData);}}.bind(this));}}
return true;}
return false;};_me._geo=function(sTo,aArg){if(this._is_active()){var aTo=this._getGroupUsers(sTo)||[sTo];this.__xmpp._geo(aTo,aArg,[function(aArg){if(this.__chat&&this.__chat.tabs){var geo={ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/geoloc",'XML\:LANG':"en"},LAT:[{VALUE:aArg.lat}],LON:[{VALUE:aArg.lon}]};if(sTo.charAt(0)==='~'){if(this.__chat&&this.__chat.__tabIndex[sTo]&&this.__chat.tabs[this.__chat.__tabIndex[sTo]])
this.__chat.tabs[this.__chat.__tabIndex[sTo]]._close();aTo.forEach(function(sTo){if(sTo!==sPrimaryAccount){var aData={MESSAGE:[{ATTRIBUTES:{FROM:sPrimaryAccount,TO:sTo},EVENT:[{ITEMS:[{ITEM:[{GEOLOC:[geo]}]}]}]}]};this._response('sent',aData);}}.bind(this));}
else
this.__chat._chat(sTo,sPrimaryAccount,{geoloc:geo,type:"geoloc"},false,false,true);}}.bind(this,aArg)]);return true;}
return false;};_me._link=function(sTo,aArg){var aTo=this._getGroupUsers(sTo);this.__xmpp._file_upload(aTo||sTo,aArg,[function(aArg){if(this.__chat&&this.__chat.tabs){if(sTo.charAt(0)==='~'){if(this.__chat&&this.__chat.__tabIndex[sTo]&&this.__chat.tabs[this.__chat.__tabIndex[sTo]])
this.__chat.tabs[this.__chat.__tabIndex[sTo]]._close();if(aTo){aTo.forEach(function(sTo){if(sTo!==sPrimaryAccount){var aData={MESSAGE:[{ATTRIBUTES:{FROM:sPrimaryAccount,TO:sTo},X:[{URL:[{VALUE:aArg.link}],DESC:[{VALUE:aArg.desc}],SIZE:[{VALUE:aArg.size}],ATTRIBUTES:{XMLNS:'jabber:x:oob'}}]}]};this._response('sent',aData);}}.bind(this));}}
else
this.__chat._chat(sTo,sPrimaryAccount,{url:aArg.link,desc:aArg.desc,size:aArg.size,type:"file"},false,false,true);}}.bind(this,aArg)]);};_me._status_response=function(){Cookie.set(['im','status'],this._getStatus());};_me._response=function(sType,aData){switch(sType){case'notice':if(aData&&this.__chat){var aFrom=this._translateUID(aData.FROM);sFrom=aFrom.shift();if(!dataSet.get('xmpp',['roster',sFrom]))
if(dataSet.get('xmpp',['roster',aData.FROM]))
sFrom=aData.FROM;else
break;this.__chat._notice(sFrom,aData.TEXT);}
break;case'error':if(aData.IQ){try{if(aData.IQ[0].ERROR&&aData.IQ[0].ERROR[0]&&aData.IQ[0].ERROR[0].ATTRIBUTES&&aData.IQ[0].ERROR[0].ATTRIBUTES.STATUS!=408)
gui.notifier._value({type:'alert',args:{header:'IM::ERROR_IM',text_plain:aData.IQ[0].ERROR[0].VALUE+' ('+aData.IQ[0].ERROR[0].ATTRIBUTES.STATUS+')'}});}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e)}}
break;case'event':if(aData.EVENT&&aData.EVENT[0].ITEMS&&aData.EVENT[0].ITEMS[0].ITEM&&aData.EVENT[0].ITEMS[0].ITEM[0].GEOLOC){aData.BODY=[{VALUE:{geoloc:aData.EVENT[0].ITEMS[0].ITEM[0].GEOLOC[0],type:"geoloc"}}];return this._response('message',aData);}
break;case'x':if(aData.X&&aData.X[0].URL){var aVal={url:aData.X[0].URL[0].VALUE,type:"file"};if(aData.X[0].DESC)
aVal.desc=aData.X[0].DESC[0].VALUE;if(aData.X[0].SIZE)
aVal.size=aData.X[0].SIZE[0].VALUE;aData.BODY=[{VALUE:aVal}];return this._response('message',aData);}
case'message':if(aData.BODY&&aData.BODY[0]&&aData.BODY[0].VALUE){var iDate='',stamp;if(aData.X&&aData.X[0]&&aData.X[0].ATTRIBUTES&&(stamp=aData.X[0].ATTRIBUTES.STAMP)){iDate=(new IcewarpDate(stamp,{format:'YYYYMMDDThh:mm:ss'}));iDate=iDate.add(iDate.utcOffset(),'m').unix();}
var conference_id;if(aData.X&&aData.X[0]&&aData.X[0].ATTRIBUTES&&aData.X[0].ATTRIBUTES.XMLNS=='jabber:x:icewarpconference')
conference_id=aData.X[0].ID[0].VALUE;this._chat(aData.ATTRIBUTES.FROM,'',aData.BODY[0].VALUE,iDate,conference_id,true);}
break;case'sent':case'received':var sFrom=this._translateUID(aData.MESSAGE[0].ATTRIBUTES.FROM),sTo=this._translateUID(aData.MESSAGE[0].ATTRIBUTES.TO),sUser=sType==='sent'?sTo:sFrom;if(sFrom.indexOf('~')===0)
break;if(sPrimaryAccountIMHISTORY&&!Is.Defined(dataSet.get('xmpp',['roster',sUser,'history'])))
break;var iDate='',stamp;if(aData.DELAY&&aData.DELAY[0]&&aData.DELAY[0].ATTRIBUTES&&(stamp=aData.DELAY[0].ATTRIBUTES.STAMP)){iDate=(new IcewarpDate(stamp,{format:'YYYYMMDDThh:mm:ss'}));iDate=iDate.add(iDate.utcOffset(),'m').unix();}
else
iDate=(new IcewarpDate()).unix();var sBody='',conference_id;if(aData.MESSAGE[0].EVENT&&aData.MESSAGE[0].EVENT[0].ITEMS&&aData.MESSAGE[0].EVENT[0].ITEMS[0].ITEM&&aData.MESSAGE[0].EVENT[0].ITEMS[0].ITEM[0].GEOLOC){sBody={geoloc:aData.MESSAGE[0].EVENT[0].ITEMS[0].ITEM[0].GEOLOC[0],type:"geoloc"};}
else{sBody=(aData.MESSAGE[0].BODY&&aData.MESSAGE[0].BODY[0].VALUE)||'';if(aData.MESSAGE[0].X&&aData.MESSAGE[0].X[0]&&aData.MESSAGE[0].X[0].ATTRIBUTES){switch(aData.MESSAGE[0].X[0].ATTRIBUTES.XMLNS){case'jabber:x:icewarpconference':conference_id=aData.MESSAGE[0].X[0].ID[0].VALUE;break;case'jabber:x:oob':if(aData.MESSAGE[0].X[0].URL){sBody={url:aData.MESSAGE[0].X[0].URL[0].VALUE,type:"file"};if(aData.MESSAGE[0].X[0].DESC)
sBody.desc=aData.MESSAGE[0].X[0].DESC[0].VALUE;if(aData.MESSAGE[0].X[0].SIZE)
sBody.size=aData.MESSAGE[0].X[0].SIZE[0].VALUE;}
break;}}}
if(dataSet.get('xmpp',['roster',sUser,'active'])===true&&this.__chat){this.__chat._chat(sUser,sType==='sent'?sFrom:'',sBody,iDate);}
else
{var oMessage={'from':sFrom,reply:sType==='sent','body':sBody,'date':iDate};if(conference_id)
oMessage.conference=conference_id;var q=dataSet.get('xmpp',['roster',sUser,'history'])||[];q.push(oMessage);dataSet.add('xmpp',['roster',sUser,'history'],q,true);}
break;case'gone':if(aData&&this.__chat)
this.__chat._gone(aData);break;case'paused':if(aData){if(gui.frm_main&&gui.frm_main.title)
gui.frm_main.title._refresh();if(this.__chat)
this.__chat._wait(aData);}
break;case'composing':if(aData){if(gui.frm_main&&gui.frm_main.title)
gui.frm_main.title._add(getLang('IM::COMPOSING',[this._translateName(aData)]),5);if(this.__chat)
this.__chat._compose(aData);}
break;case'subscribe':if(aData.ATTRIBUTES.FROM){if(GWOthers.getItem('IM','auto_subscribe')>0)
this.__subscribed(true,aData.ATTRIBUTES.FROM);else{var frm=gui._create('subscribe','frm_confirm_threestates','','',[this,'__subscribed',[aData.ATTRIBUTES.FROM]],'IM::SUBSCRIPTION','IM::SUB_ASK',[aData.ATTRIBUTES.FROM],'FORM_BUTTONS::ACCEPT','FORM_BUTTONS::DECLINE'),me=this;if(aData.ATTRIBUTES.FROM.indexOf('@')==-1){frm.x_btn_cancel2._disabled(true);frm.x_btn_cancel._onclick=function(){me.__xmpp._user_remove([aData.ATTRIBUTES.FROM]);frm._destruct();};}}}
break;case'subscribed':break;case'unavailable':if(aData.ATTRIBUTES&&aData.ATTRIBUTES.FROM){var sFrom=this._translateUID(aData.ATTRIBUTES.FROM);if(dataSet.get('xmpp',['roster',sFrom])){dataSet.remove('xmpp',['roster',sFrom,'status'],true);dataSet.remove('xmpp',['roster',sFrom,'sip'],true);dataSet.remove('xmpp',['roster',sFrom,'show'],true);dataSet.update('xmpp',['roster',sFrom]);}}
break;case'unsubscribed':if(aData.ATTRIBUTES&&aData.ATTRIBUTES.FROM){var sFrom=this._translateUID(aData.ATTRIBUTES.FROM);if(dataSet.get('xmpp',['roster',sFrom])){dataSet.remove('xmpp',['roster',sFrom,'status'],true);dataSet.add('xmpp',['roster',sFrom,'status'],'from');Cookie.set(['im','queue',sFrom]);gui.notifier._value({type:'alert',args:{header:'IM::SUBSCRIPTION',text:'IM::UNSUBSCRIBED',args:[sFrom]}});}}
break;case'state_change':if(aData.ATTRIBUTES&&aData.ATTRIBUTES.FROM){var aFrom=aData.ATTRIBUTES.FROM.split('/'),sFrom=aFrom.shift();if(!dataSet.get('xmpp',['roster',sFrom]))
if(dataSet.get('xmpp',['roster',aData.ATTRIBUTES.FROM]))
sFrom=aData.ATTRIBUTES.FROM;else
break;var ds=dataSet.get('xmpp',['roster',sFrom]),bUpdate=false;var sStat='';if(aData.STATUS&&aData.STATUS[0]&&aData.STATUS[0].VALUE)
sStat=aData.STATUS[0].VALUE;if(ds.status!=sStat){bUpdate=true;dataSet.add('xmpp',['roster',sFrom,'status'],sStat,true);}
if(aFrom[0])
dataSet.add('xmpp',['roster',sFrom,'resource'],aFrom[0],true);var bSIP=false;if(aData.X)
for(var i in aData.X){switch(aData.X[i].ATTRIBUTES.XMLNS){case'sip-presence:x:update':bSIP=true;break;case'vcard-temp:x:update':if(aData.X[i].PHOTO){var new_hash=aData.X[i].PHOTO[0].VALUE;if(ds.photo&&new_hash!==ds.photo)
bUpdate=true;dataSet.add('xmpp',['roster',sFrom,'photo'],new_hash,true);}}}
dataSet.add('xmpp',['roster',sFrom,'sip'],bSIP,true);dataSet.add('xmpp',['roster',sFrom,'status_time'],(new IcewarpDate()).unix(),true);var new_show='offline';if(aData.SHOW&&aData.SHOW[0]&&aData.SHOW[0].VALUE)
new_show=aData.SHOW[0].VALUE.toLowerCase();else
if(aData.ATTRIBUTES.TYPE!="unavailable")
new_show=ds.show=='from'?'from':'online';if(ds.show!==new_show){dataSet.add('xmpp',['roster',sFrom,'show'],new_show,true);bUpdate=true;}
bUpdate&&dataSet.update('xmpp',['roster',sFrom]);}
break;case'download':if(aData){var sDesc=(aData.FILE[0].DESC&&aData.FILE[0].DESC[0]&&aData.FILE[0].DESC[0].VALUE?aData.FILE[0].DESC[0].VALUE:''),sFrom=this._translateName(aData.FROM[0].VALUE);if(aData&&aData.FILE&&aData.FEATURE){if(aData.FEATURE[0].X&&aData.FEATURE[0].X[0].ATTRIBUTES&&aData.FEATURE[0].X[0].ATTRIBUTES.XMLNS=='jabber:x:data'&&aData.FEATURE[0].X[0].FIELD&&aData.FEATURE[0].X[0].FIELD[0].ATTRIBUTES&&aData.FEATURE[0].X[0].FIELD[0].ATTRIBUTES.TYPE=='list-single'&&aData.FEATURE[0].X[0].FIELD[0].OPTION&&aData.FEATURE[0].X[0].FIELD[0].OPTION[0].VALUE&&aData.FEATURE[0].X[0].FIELD[0].OPTION[0].VALUE[0].VALUE=='http://jabber.org/protocol/bytestreams'){if(!aData.FILE[0].ATTRIBUTES||aData.FILE[0].ATTRIBUTES.SIZE>5242880){var me=this,sHtml=getLang('IM::RECEIVE_NOTE',[sFrom.escapeHTML(),aData.FILE[0].ATTRIBUTES.NAME.escapeHTML()])+(sDesc?'<hr size="1">'+sDesc.escapeHTML():''),frm=gui._create('download','frm_confirm','','',[this,'_response',['stream_start',aData]],'IM::RECEIVE_FILE','',sHtml);frm.x_btn_cancel._onclick=function(){me.__xmpp._stream_cancel(aData.ID[0].VALUE,aData.FROM[0].VALUE);this._parent._destruct();};}
else
this.__xmpp._stream_accept(aData,aData.ID[0].VALUE,aData.FROM[0].VALUE);}
else
this.__xmpp._stream_cancel(aData.ID[0].VALUE,aData.FROM[0].VALUE);}
else
if(aData&&aData.URL&&aData.URL[0]&&aData.URL[0].VALUE){var me=this,sHtml=getLang('IM::RECEIVE_NOTE',[sFrom.escapeHTML(),Path.basename(aData.URL[0].VALUE).escapeHTML()])+(sDesc?'<hr size="1">'+sDesc.escapeHTML():''),frm=gui._create('download','frm_confirm','','',[this,'_response',['download_start',aData.URL[0].VALUE]],'IM::RECEIVE_FILE','',sHtml);frm.x_btn_cancel._onclick=function(){me._response('download_stop',aData);this._parent._destruct();};}}
break;case'stream_start':this.__xmpp._stream_accept(aData,aData.ID[0].VALUE,aData.FROM[0].VALUE);break;case'streamhost':if(aData&&aData.size>0&&aData.socket){var aUrl={'sid':dataSet.get('main',['sid']),'class':'socks','fullpath':aData.name+'/'+aData.size+'/'+aData.socket};downloadItem(buildURL(aUrl));}
else
gui.notifier._value({type:'alert',args:{header:'',text:'IM::ERROR_SOCKET'}});break;case'download_start':window.open(aData,"file","directories=no,toolbar=no,status=no,menubar=yes,width=200,height=200");break;case'download_stop':var sID='',sTo='';if(aData.ID){var sID=aData.ID[0].VALUE;delete aData.ID;}
if(aData.FROM){var sTo=aData.FROM[0].VALUE;delete aData.FROM;}
this.__xmpp._oob_cancel(aData,sID,sTo);break;case'roster':if(aData.ITEM){var oldShow,sJID,sSub,sName,bRefresh=false,tmp;for(var i in aData.ITEM){sSub=aData.ITEM[i].ATTRIBUTES.SUBSCRIPTION;sJID=aData.ITEM[i].ATTRIBUTES.JID;sName=aData.ITEM[i].ATTRIBUTES.NAME;if(sSub=='remove')
dataSet.remove('xmpp',['roster',sJID],true);else{oldShow=dataSet.get('xmpp',['roster',sJID,'show']);if(!oldShow||sSub!='both'||(sSub=='both'&&(oldShow=='from'||oldShow=='to')))
dataSet.add('xmpp',['roster',sJID,'show'],sSub,true);dataSet.add('xmpp',['roster',sJID,'name'],sName,true);dataSet.add('xmpp',['roster',sJID,'user'],sJID,true);dataSet.add('xmpp',['roster',sJID,'group'],aData.ITEM[i].GROUP?aData.ITEM[i].GROUP[0].VALUE:'*',true);}
bRefresh=true;}
if(sPrimaryAccountIMHISTORY){var mem=Cookie.get(['im','queue']);if(mem)
for(var sFrom in mem)
if(dataSet.get('xmpp',['roster',sFrom])){dataSet.add('xmpp',['roster',sFrom,'action'],'msg',true);this._add(sFrom);bRefresh=true;}
else
Cookie.set(['im','queue',sFrom]);}
if(bRefresh)
dataSet.update('xmpp',['roster']);}
break;}};_me.__subscribed=function(bOK,sJID){this.__xmpp[bOK?'_user_subscribed':'_user_unsubscribed'](sJID);};_me.__update=function(sDataSet,aDName){if(aDName&&aDName[0]=='roster'){if(!Is.Empty(this.__activeBuffer)){var aData=dataSet.get('xmpp',['roster']);for(var sUID in this.__activeBuffer)
if(!aData[sUID]||aData[sUID].action!='msg')
this._remove(sUID);}
this._fill();}};_me._getGroups=function(){var aData=dataSet.get('xmpp',['roster']),out={};for(var i in aData)
out[aData[i].group]=true;return out;};_me._getGroupUsers=function(sGroup){var aTo;if(sGroup.indexOf('~')===0){var g=sGroup.replace(/^\~/g,''),aTo=[];if(g.indexOf(';')>-1)
aTo=g.split('; ');else{var aTmp=dataSet.get('xmpp',['roster']);for(var i in aTmp)
if(aTmp[i].group==g)
aTo.push(i);}}
return aTo;};_me._doRefresh=function(b){this.__noRefresh=false;if(b||this.__doRefresh){this.__doRefresh=false;this._fill();}};_me.__sortUsr=function(a,b){var n1=(a.name||a.user),n2=(b.name||b.user);if(n1<n2){return-1;}
else if(n1>n2){return 1;}
else{return 0;}};_me.__sortGrp=function(n1,n2){if(n2==='*'){return-1;}
if(n1==='*'){return 1;}
var tmp1=n1.toLowerCase(),tmp2=n2.toLowerCase();if(tmp1!==tmp2){n1=tmp1;n2=tmp2;}
if(n1<n2){return-1;}
else if(n1>n2){return 1;}
else{return 0;}};_me.__prepareData=function(aCookie){var
aData={},aData2={},aGet=dataSet.get('xmpp',['roster']),aGrpSort=[],aTmp,i;if(typeof aGet=='object'){for(i in aGet){if(i.toString().charAt(0)!=='~'){if(!aData2[aGet[i].group]){aData2[aGet[i].group]=[];}
aTmp=aGet[i];aTmp.user=i;aData2[aGet[i].group].push(aTmp);}}}
for(i in aData2){aGrpSort.push(i);aData2[i].sort(this.__sortUsr);}
aGrpSort.sort(this.__sortGrp);for(i in aGrpSort){aData[aGrpSort[i]]=aData2[aGrpSort[i]];}
if(aCookie){for(i in aCookie){if(!aData2[i]){Cookie.set(['im','roster',i]);}}}
return aData;};_me.__getHtmlUserRowParts=function(id,data){var css,html;css='user_'+encodeURIComponent(data.show||'offline');if(data.action){css+=' action_'+encodeURIComponent(data.action);}
html='<h3>'+((data.name?data.name.trim():'')||data.user||'').escapeHTML()+'</h3>';if(data.status){css+=' status';html+='<h4>'+data.status.escapeHTML()+'</h4>';}
if(this.__activeUser[data.user]){css+=' active';}
if(data.type){css+=' '+encodeURIComponent('set_'+data.type);}
if(sPrimaryAccountGW&&data.type!=='service'&&data.type!=='email'){css+=' avatar';html+='<span class="bg">'+(data.name||data.user||'').substr(0,1).escapeHTML()+'</span>';html+='<span></span>';}
return{html:html,css:css,image:getAvatarURL(data.user,data.photo)};};_me.__getHtmlUserRow=function(id,data,userRowParts){return'<li id="'+id+'" class="'+userRowParts.css+'" unselectable="on">'+userRowParts.html+'<em></em></li>';};_me.__getLocalizedName=function(name){if('*'===name){return getLang('IM::OTHER');}
else if('~'===name){return getLang('IM::NOT_LISTED');}
else if('-'===name){return getLang('IM::INCOMMING');}
else{return name;}};_me.__getHtmlGroupRow=function(i,isGroupClosed,itemsInGroup,renderGroup){var groupName=this.__getLocalizedName(i);return'<li'+(isGroupClosed?' class="close"':'')+'>'+'<div id="'+this._pathName+'/'+encodeURIComponent(i)+'"'+
(renderGroup?'':' class="notRendered"')+'>'+groupName.escapeHTML()+
(renderGroup?'<span>'+groupName.substr(0,2).escapeHTML()+'</span>':'')+'</div><ul>'+itemsInGroup.join('')+'</ul></li>';};_me.__addToAvatarCache=function(key,imageUrl){if(!this.__avatarCache[key]){this.__avatarCache[key]=new Image();var me=this;this.__avatarCache[key].onload=function(){me.__setFromAvatarCache(key,this);};this.__avatarCache[key].onerror=function(){delete me.__avatarCache[key];};}
if(this.__avatarCache[key].src!=imageUrl)
this.__avatarCache[key].src=imageUrl;};_me.__setFromAvatarCache=function(key,cachedImage){var elm,span;if(cachedImage&&cachedImage.naturalWidth&&(elm=document.getElementById(key))&&(span=elm.getElementsByTagName('span'))&&span[1]&&!span[1].style.backgroundImage){span[1].style.backgroundImage='url('+cachedImage.src+')';gui.tooltip._add(span[1],'<img class="avatar_preview" style="background-image: url('+cachedImage.src+')">',{x:'-75',y:'-155',html:true,css:'borderless'});}};_me.__setAllAvatarCache=function(){for(var key in this.__avatarCache){if(this.__avatarCache[key]){this.__setFromAvatarCache(key,this.__avatarCache[key]);}}};_me._fill=function(){if(this.__showAllContacts)
if(this.__noRefresh){this.__doRefresh=true;return;}
var groups={},groupsForRender=[],aCookie=Cookie.get(['im','roster']),aData,i,j,itemsInGroup,totalItemsInGroup,sSearch,data,isGroupClosed,range,newTopPosition,renderRow,renderGroup,userRowParts,id,currentHeight;aData=this.__prepareData(aCookie);this.__totalHeight=0;this.__renderedHeight=0;sSearch=this.inp_search._value().toLowerCase();for(i in aData){isGroupClosed=false;itemsInGroup={};totalItemsInGroup=0;if(aData[i]){isGroupClosed=aCookie&&aCookie[i]?true:false;for(j in aData[i]){data=aData[i][j];if(sSearch&&data.action!=='msg'&&(data.name||data.user).toLowerCase().indexOf(sSearch)===-1){continue;}
else
if(!this.__showAllContacts&&!sSearch&&data.action!=='msg'&&~['offline','both','from','none','to',''].indexOf(data.show||'')){continue;}
else
if(this.__activeBuffer[data.user]){continue;}
itemsInGroup[j]=data;totalItemsInGroup++;}}
if(totalItemsInGroup>0){groups[i]=itemsInGroup;this.__totalHeight+=this.__rowGroupHeight;if(!isGroupClosed)
this.__totalHeight+=totalItemsInGroup*this.__rowHeight;}}
range=this.__getVisibleRange();if(range.scrollTop+range.viewPortHeight>this.__totalHeight)
range.scrollTop=Math.max(0,this.__totalHeight-range.viewPortHeight);currentHeight=0;for(i in groups){isGroupClosed=false;itemsInGroup=[];if(groups[i]){isGroupClosed=aCookie&&aCookie[i]?true:false;renderGroup=(currentHeight>=range.scrollTop-this.__extraRendering&&currentHeight<=range.scrollTop+range.viewPortHeight+this.__extraRendering);if(renderGroup){if(undefined===newTopPosition){newTopPosition=currentHeight;}
this.__renderedHeight+=this.__rowGroupHeight;}
currentHeight+=this.__rowGroupHeight;totalItemsInGroup=0;if(isGroupClosed===false){for(j in groups[i]){data=groups[i][j];renderRow=(currentHeight>=range.scrollTop-this.__extraRendering&&currentHeight<=range.scrollTop+range.viewPortHeight+this.__extraRendering);if(renderRow){id=this._pathName+'/'+encodeURIComponent(i)+'/'+encodeURIComponent(data.user);userRowParts=this.__getHtmlUserRowParts(id,data);this.__addToAvatarCache(id,userRowParts.image);if(undefined===newTopPosition){newTopPosition=currentHeight;}
itemsInGroup.push(this.__getHtmlUserRow(id,data,userRowParts));this.__renderedHeight+=this.__rowHeight;}
currentHeight+=this.__rowHeight;totalItemsInGroup++;}}}
groupsForRender.push(this.__getHtmlGroupRow(i,isGroupClosed,itemsInGroup,renderGroup));}
var eChild=this.__body.firstChild;if(!eChild||eChild.tagName!=='UL'){eChild=mkElement('UL',{className:"huge_content"});this.__body.innerHTML='';this.__body.appendChild(eChild);}
this.__body.style.height=this.__totalHeight+'px';this.__body.firstChild.style.top=newTopPosition+'px';eChild.innerHTML=groupsForRender.join('');if(this.__totalHeight<this.__lastScrollTop){this.__lastScrollTop=Math.max(0,this.__totalHeight-range.viewPortHeight);this.__body.parentNode.scrollTop=this.__lastScrollTop;}
this.__renderedScrollTop=this.__lastScrollTop;this.__setAllAvatarCache();};_me.__initdrag=function(id,sType,x,y){var sBody,i,value;if(this._is_active()){if(!this.__activeUser[id]){this._activate(id);}
if((id=arrayKeys(this.__activeUser))){sBody='';for(i in id){value=dataSet.get('xmpp',['roster',id[i],'name']);if(!value||(value&&''===value.trim())){value=id[i];}
sBody+='<div class="drag_folder drag_'+sType+'">'+value.escapeHTML()+'</div>';}
gui.frm_main.dnd.create_drag(sBody,{type:sType,value:id},x,y);}}};_me._active_dropzone=function(v){this.__aDragGroups=[];var elms=this.__body.getElementsByTagName('DIV'),tmp;for(var i=0;i<elms.length;i++){tmp=getSize(elms[i]);tmp.id=elms[i].id;tmp.h=elms[i].parentNode.clientHeight;this.__aDragGroups.push(tmp);}
this.__objPos=getSize(this.__body.parentNode);return true;};_me._ondragover=function(v){if(!this.__dragON){this.__dragON=true;gui._obeyEvent('mousewheel',[this,'__mousewheel']);}
if(this.__objPos){var delta;if(((delta=gui.__Y-this.__objPos.y)<51&&(delta-=50))||((delta=gui.__Y-this.__objPos.y-this.__objPos.h)>-51&&(delta+=50)))
this.__body.parentNode.scrollTop+=Math.floor(delta/10);}
var tmp=this.__body.getElementsByTagName('UL');if(tmp&&(tmp=tmp[0])){tmp=getSize(tmp);if(v.y>tmp.y&&v.y<tmp.y+tmp.h)
return true;}
return false;};_me._ondragout=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;};_me._ondrop=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;if(v.value){var elms=this.__body.getElementsByTagName('DIV'),tmp;for(var i=0;i<elms.length;i++){tmp=getSize(elms[i]);tmp.h=elms[i].parentNode.clientHeight;if(v.x>tmp.x&&v.x<tmp.x+tmp.w&&v.y>tmp.y&&v.y<tmp.y+tmp.h)
this._addGroup(decodeURIComponent(elms[i].id.split('/').pop()),v.value);}}};_me.__mousewheel=function(e){this.__body.scrollTop+=e.delta*20;};_me._add=function(sUID,bNew){var bCSSAnim=false,bCSSMove=false,aUser=dataSet.get('xmpp',['roster',sUID],true);if(!aUser)return;if(this.__activeBuffer[sUID]){if(bNew)return;if(!this.__activeBuffer[sUID].anim){if(this.__activeBuffer[sUID].elm.parentNode.firstChild!==this.__activeBuffer[sUID].elm){if('transition'in document.body.style)
bCSSMove=true;else
this.__activeBuffer[sUID].elm.parentNode.insertBefore(this.__activeBuffer[sUID].elm,this.__activeBuffer[sUID].elm.parentNode.firstChild);}
else
if(this.__activeBuffer[sUID].action!=aUser.action){bCSSAnim=true;}}}
else{this.__activeBuffer[sUID]={elm:mkElement('li',{id:this._pathName+'/'+sUID})};if(this._getAnchor('chats').firstChild){if('transition'in document.body.style){this._getAnchor('chats').appendChild(this.__activeBuffer[sUID].elm);bCSSMove=true;}
else
this._getAnchor('chats').insertBefore(this.__activeBuffer[sUID].elm,this._getAnchor('chats').firstChild);}
else{this._getAnchor('chats').appendChild(this.__activeBuffer[sUID].elm);bCSSAnim=true;}}
this.__activeBuffer[sUID].action=aUser.action||'msg';var css='user_'+encodeURIComponent(aUser.show||'offline')+' action_'+encodeURIComponent(this.__activeBuffer[sUID].action),txt='<h3>'+(aUser.name||aUser.user||sUID).escapeHTML()+'</h3>';if(aUser.status){css+=' status';txt+='<h4>'+aUser.status.escapeHTML()+'</h4>';}
if(aUser.type)
css+=' '+encodeURIComponent('set_'+aUser.type);if(sPrimaryAccountGW&&aUser.type!='service'&&aUser.type!='email'){css+=' avatar';txt+='<span class="bg">'+(aUser.name||aUser.user||sUID).substr(0,1).escapeHTML()+'</span>';txt+='<span style="background-image: url(\''+getAvatarURL(sUID)+'\')"></span>';}
this.__activeBuffer[sUID].elm.innerHTML=txt+'<em></em>';gui.tooltip._add(this.__activeBuffer[sUID].elm.querySelectorAll('span')[1],'<img class="avatar_preview" style="background-image: url('+getAvatarURL(sUID)+')">',{x:'-75',y:'+36',html:true,css:'borderless'});this.__activeBuffer[sUID].elm.className=css;this._activate_active();this.__height();if(bCSSMove)
this.__animate(sUID);else
if(bCSSAnim)
addcss(this.__activeBuffer[sUID].elm,'anim');var elm=document.getElementById(this._getID(sUID));if(elm)
this._fill();};_me._activate_active=function(){for(var id in this.__activeBuffer)
if(this.__activeUser[id])
addcss(this.__activeBuffer[id].elm,'active');else
removecss(this.__activeBuffer[id].elm,'active');};_me._remove=function(sUID){if(this.__activeBuffer[sUID]){if(this.__activeBuffer[sUID].elm&&this.__activeBuffer[sUID].elm.parentNode)
this.__activeBuffer[sUID].elm.parentNode.removeChild(this.__activeBuffer[sUID].elm);if(this.__activeBuffer[sUID].anim){if(this.__activeBuffer[sUID].anim.interval)
clearInterval(this.__activeBuffer[sUID].anim.interval);if(this.__activeBuffer[sUID].anim.etop&&this.__activeBuffer[sUID].anim.etop.parentNode)
this.__activeBuffer[sUID].anim.etop.parentNode.removeChild(this.__activeBuffer[sUID].anim.etop);if(this.__activeBuffer[sUID].anim.ebottom&&this.__activeBuffer[sUID].anim.ebottom.parentNode)
this.__activeBuffer[sUID].anim.ebottom.parentNode.removeChild(this.__activeBuffer[sUID].anim.ebottom);}
delete this.__activeBuffer[sUID];this.__height();if(dataSet.get('xmpp',['roster',sUID]))
this._fill();}};_me.__animate=function(sUID){var elm;if(this.__activeBuffer[sUID]&&!this.__activeBuffer[sUID].anim&&(elm=this.__activeBuffer[sUID].elm)){this.__activeBuffer[sUID].anim={etop:mkElement('li',{className:'helper top'}),ebottom:mkElement('li',{className:'helper bottom'})};var offset=elm.offsetTop,height=elm.offsetHeight,me=this;elm.parentNode.insertBefore(this.__activeBuffer[sUID].anim.etop,elm.parentNode.firstChild);if(elm.nextSibling)
elm.parentNode.insertBefore(this.__activeBuffer[sUID].anim.ebottom,elm.nextSibling);else
elm.parentNode.appendChild(this.__activeBuffer[sUID].anim.ebottom);elm.style.position='absolute';elm.style.zIndex=100;elm.style.top=offset+'px';elm.style.transitionDuration=(offset/200)+'s';this.__activeBuffer[sUID].anim.interval=setTimeout(function(){if(elm)
elm.style.top='0';if(me.__activeBuffer[sUID]&&me.__activeBuffer[sUID].anim){me.__activeBuffer[sUID].anim.etop.style.height=height+'px';me.__activeBuffer[sUID].anim.ebottom.style.height='0';me.__activeBuffer[sUID].anim.interval=setTimeout(function(){if(elm&&elm.parentNode){if(me.__activeBuffer[sUID]&&me.__activeBuffer[sUID].anim&&me.__activeBuffer[sUID].anim.etop)
elm.parentNode.replaceChild(elm,me.__activeBuffer[sUID].anim.etop);elm.style.position='';elm.style.zIndex='';elm.style.transitionDuration='';}
if(me.__activeBuffer[sUID]&&me.__activeBuffer[sUID].anim){if(me.__activeBuffer[sUID].anim.ebottom)
me.__activeBuffer[sUID].anim.ebottom.parentNode.removeChild(me.__activeBuffer[sUID].anim.ebottom);delete me.__activeBuffer[sUID].anim;}},(offset/0.2)+30);}},100);}};_me.__height=function(){var m=0,active=this.__active.parentNode,recent=this.__recent.parentNode;if(Is.Empty(this.__activeBuffer)){active.style.display='';recent.style.display='';var r=Cookie.get(['im_recent']);if(Is.Array(r)&&r.length)
removecss(this.__recent,'empty');}
else{recent.style.display='';if(recent.style.display!='none')
recent.style.display='none';if(active.style.display!='block')
active.style.display='block';m=active.offsetHeight;}
this.__body.parentNode.parentNode.style.top=m?m+'px':'';};_me._getID=function(sUID){var aUser=dataSet.get('xmpp',['roster',sUID]);return this._pathName+'/'+encodeURIComponent(aUser.group)+'/'+encodeURIComponent(aUser.user);};_me._getStatus=function(sJID){return this.__xmpp._user_status(sJID);};_me._status=function(sStatus,sStatusText){if(sStatus)
this.__xmpp._presence(sStatus,sStatusText);else
return this._getStatus();};_me._getStatusText=function(){return this._getStatus()==='offline'?'':dataSet.get('xmpp',['statusText'])||'';};

/* client/inc/obj_info_box.js */
_me=obj_info_box.prototype;function obj_info_box(){};_me.__constructor=function(){this.__eBox=this._getAnchor('box');};_me._context=function(context,dimension){if(dimension==undefined)
dimension={};this._main.oncontextmenu=function(e){return false;};var target=this.__eTarget=context.target;var box=this.__eBox;var leftpad=dimension.left||5;var rightpad=dimension.right||5;var toppad=dimension.top||7;var offset=dimension.offset||2;var flip=dimension.flip!=undefined?dimension.flip:true;var rect=target.getBoundingClientRect();offsetX=context.x-rect.left;offsetY=context.y-rect.top;var x=rect.left,y=context.y;var elm=target;while(elm&&elm.offsetParent){elm=elm.offsetParent;}
if(target.offsetHeight<50)
y=target.getBoundingClientRect().top;var xspace=elm.offsetWidth;box.style.maxWidth=(xspace-leftpad-rightpad)+'px';box.style.position='absolute';box.style.display='block';var yspace=elm.offsetHeight;var placing=toppad+y+offset+10+box.offsetHeight;if(flip&&yspace<placing){addcss(box,'up');box.style.bottom=((elm.offsetHeight-y)+10-offset-4)+'px';}else{addcss(box,'down');if(target.offsetHeight<50)
y+=target.offsetHeight;else if(offsetY<30)
y+=30-offsetY;box.style.top=(y+offset+10-7)+'px';}
var boxwidth=target.offsetWidth;var boxmid=boxwidth/2;var width=box.offsetWidth;var place=parseInt(x+boxmid-width/2);if(place<leftpad){box.style.left=leftpad+'px';box.style.right='auto';box.style[(hascss(box,'up')?'borderBottomLeftRadius':'borderTopLeftRadius')]='3px';}else if(leftpad+x+width+rightpad>xspace){box.style.left='auto';box.style.right=rightpad+'px';box.style[(hascss(box,'up')?'borderBottomRightRadius':'borderTopRightRadius')]='3px';}else{box.style.left=place+'px';}
box.style.zIndex=maxZIndex.get();this._main.style.display='none';};_me._show=function(){addcss(this._main,'show');this._main.style.display='block';var box=this.__eBox.style;box.opacity=box.opacity||0;if(navigator.userAgent.indexOf('MSIE 8')!=-1)
box.filter="alpha(opacity="+parseInt(box.opacity*100)+")";if(this.__fade_interval)
clearInterval(this.__fade_interval);this.__fade_interval=setInterval(function(){var opacity=parseFloat(box.opacity)+0.1;if(opacity>0.95){box.opacity=1;clearInterval(this.__fade_interval);}else{box.opacity=opacity;if(navigator.userAgent.indexOf('MSIE 8')!=-1)
box.filter="alpha(opacity="+parseInt(opacity*100)+")";}},50);};_me._hide=function(){var me=this;var box=this.__eBox.style;removecss(this._main,'show');if(this.__fade_interval)
clearInterval(this.__fade_interval);this.__fade_interval=setInterval(function(){var opacity=box.opacity-0.1;if(opacity<0.05){box.opacity=0;clearInterval(me.__fade_interval);maxZIndex.remove(box.zIndex);me._destruct();}else{box.opacity=opacity;if(navigator.userAgent.indexOf('MSIE 8')!=-1)
box.filter="alpha(opacity="+parseInt(opacity*100)+")";}},50);};_me._content=function(sHtml){if(sHtml==undefined)
return this.__eBox.innerHTML;else
this.__eBox.innerHTML=sHtml;};_me._template=function(template,values){this._draw(template,'box',values);};

/* client/inc/obj_info_button.js */
_me=obj_info_button.prototype;function obj_info_button(){};_me.__constructor=function(){this.__eIN.value="";var elm=document.createElement('div');var bubble=document.createElement('div');bubble.className='bubble';elm.appendChild(bubble);var flap=document.createElement('div');flap.className='flap';flap.appendChild(document.createElement('div'));elm.appendChild(flap);this._main.appendChild(elm);elm.className=this._type;bubble.style.zIndex=maxZIndex.get();flap.style.zIndex=maxZIndex.get();bubble.style.display='none';flap.style.display='none';var container=this._main.parentNode.parentNode.parentNode;var me=this;var open=false;this.__eInfo=bubble;function close(e){var trg=e?e.target:event.srcElement;while(trg.nodeName!='BODY'){if(trg==me._main)break;trg=trg.parentNode;}
if(trg.nodeName=='BODY'){bubble.style.display='none';flap.style.display='none';removecss(me._main,'open');gui._disobeyEvent('click',[me,close]);open=false;}}
this._main.parentNode.style.overflow='visible';this.__eIN.onclick=this._main.onclick=function(e){if(!e){e=window.event;e.target=e.srcElement;}
if(this==e.target){if(!me._disabled()){if(!open){addcss(me._main,'open');var y=this.offsetHeight;if(container.offsetHeight/2<this.offsetTop){bubble.style.bottom=(y+2)+'px';flap.style.top='-3px';addcss(flap,'up');}else{bubble.style.top=(y-2)+'px';flap.style.bottom='0px';addcss(flap,'down');}
var x=this.offsetWidth/2-14;flap.style.left=x+'px';var m=me._main.parentNode.offsetWidth;bubble.style.maxWidth=(m-10)+'px';bubble.style.display='block';var w=bubble.offsetWidth;var l=this.parentNode.offsetLeft;var r=m-l-this.offsetWidth;if(w/2>l){bubble.style.left=(-l+5)+'px';bubble.style[(hascss(flap,'up')?'borderBottomLeftRadius':'borderTopLeftRadius')]=(l+x)<7?(l+x)+'px':'7px';}else if(w/2>r){bubble.style.left='auto';bubble.style.right=(-r+3)+'px';bubble.style[(hascss(flap,'up')?'borderBottomRightRadius':'borderTopRightRadius')]=(r+x)<7?(r+x)+'px':'7px';}else{bubble.style.left=(-w/2+15)+'px';}
flap.style.display='block';gui._obeyEvent('click',[me,close]);open=true;}else
close({target:document.body});if(elm==me._main)
me._focus();if(me._onclick)
me._onclick(e);}
if(e.stopPropagation)e.stopPropagation();return false;}}
this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(open&&elm.nodeType==1&&elm.nodeName=='DIV'){close(e);}}};_me._content=function(sHtml){if(sHtml==undefined)
return this.__eInfo.innerHTML;else
this.__eInfo.innerHTML=sHtml;}

/* client/inc/obj_input.js */
_me=obj_input.prototype;function obj_input(){};_me.__constructor=function(){var me=this;this.__placeholder='';this.__eIN=mkElement('input',{"type":'text',"name":this._pathName+'#main',"id":this._pathName+'#main',"className":this._type!='obj_input'?'obj_input '+this._type:'obj_input'});if(this._type=='obj_password'){this.__eIN.setAttribute('type','password');AttachEvent(this.__eIN,'onkeydown',function(e){var e=e||window.event,is_lowercase=/^[a-z]$/.test(e.key);if(is_lowercase===e.shiftKey&&e.key.length===1)
addcss(this,'caps');else
removecss(this,'caps');});this.__eIN.setAttribute('autocomplete',"new-password");}else{this.__eIN.setAttribute('autocomplete',"off");}
this._main.appendChild(this.__eIN);this.__eIN.onkeyup=function(e){var e=e||window.event;if(me._onkeyup&&me._onkeyup(e)==false)return false;me.__exeEvent('onkeyup',e,{"owner":me});};this.__eIN.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 13:if(e.ctrlKey){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;}
break;case 27:if(me._onclose&&me._onclose(e)==false)return false;break;case 9:break;}
if(me._onkeydown&&me._onkeydown(e)===false)return false;me.__exeEvent('onkeydown',e,{"owner":me});if(e.keyCode==13&&me._onsubmit)
setTimeout(function(){try{me._onsubmit({ctrlKey:e.ctrlKey});}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}},0);return e.keyCode==13?false:true;};AttachEvent(this.__eIN,'onkeyup',function(e){if(me._onchange)me._onchange();me.__exeEvent('change',null,{"owner":me});});AttachEvent(this.__eIN,'onpaste',function(e){if(me._onchange)me._onchange();me.__exeEvent('change',null,{"owner":me});});AttachEvent(this.__eIN,'oninput',function(e){if(me._onchange)me._onchange();me.__exeEvent('change',null,{"owner":me});});this.__eIN.onfocus=function(e){var e=e||window.event;me.__hasFocus=true;if(me.__placeholder&&this.value==me.__placeholder){removecss(this,'placeholder');this.value='';}
if(me._onfocus)me._onfocus(e);me.__exeEvent('onfocus',e,{"owner":me});addcss(me._main,'focus');return true;};this.__eIN.onblur=function(e){var e=e||window.event;me.__hasFocus=false;if(me._type=='obj_password')
removecss(this,'caps');if(me.__placeholder&&!this.value){addcss(this,'placeholder');this.value=me.__placeholder;}
if(me._onblur&&me._onblur(e)===false)return false;me.__exeEvent('onblur',e,{"owner":me});removecss(me._main,'focus');return true;};this.__eIN.onclick=function(e){var e=e||window.event;if(me._onclick&&me._onclick(e)===false)
return false;me.__exeEvent('click',e,{"owner":me});return true;};this._main.onfocus=function(e){me._focus(true);};if(window.FormData){this.__eIN.addEventListener("drag",function(e){gui.frm_main.__filedrag=false;},false);this.__eIN.addEventListener("dragstart",function(e){gui.frm_main.__filedrag=false;},false);this.__eIN.addEventListener("dragend",function(e){gui.frm_main.__filedrag=true;},true);}};_me._maxlength=function(i){if(Is.Defined(i)){if(i>0)
this.__eIN.setAttribute('maxlength',i);else
this.__eIN.removeAttribute('maxlength');}
else
return this.__eIN.getAttribute('maxlength')||0;};_me._value=function(v,bSkipPH){if(Is.Defined(v)){this.__eIN.value=v;if(this.__restrictions&&this.__restrictions.length)
this.__check();if(!bSkipPH&&this.__placeholder)
if(this.__eIN.value.length>0)
removecss(this.__eIN,'placeholder');else
if(!this._hasFocus()){this.__eIN.value=this.__placeholder;addcss(this.__eIN,'placeholder');}
this.__showMaskHelper();if(!bSkipPH){if(this._onchange)this._onchange();this.__exeEvent('change',null,{"owner":this});}}
else
return(this.__eIN.value==this.__placeholder?'':this.__eIN.value);};_me._readonly=function(b){if(Is.Defined(b)){this.__eIN.readOnly=b;if(b)
addcss(this._main,'readonly');else
removecss(this._main,'readonly');}
else
return this.__eIN.readOnly?true:false;};_me._hasFocus=function(){return this.__eIN.__hasFocus;};_me._getCartPos=function(){if("selectionStart"in this.__eIN)
return this.__eIN.selectionStart;else
if(document.selection){this.__eIN.focus();var r=document.selection.createRange().duplicate();r.moveEnd('character',this.__eIN.value.length);return r.text==''?this.__eIN.value.length:this.__eIN.value.lastIndexOf(r.text);}else
return 0;};_me._setRange=function(pos1,pos2){pos1=pos1||0;try{if(document.selection&&this.__eIN.createTextRange){var r=this.__eIN.createTextRange();r.collapse(true);r.moveStart("character",pos1);if(pos2)r.moveEnd("character",pos2);r.select();}
else
this.__eIN.setSelectionRange(pos1,pos2||pos1);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
this._focus(true);};_me._select=function(){this._setRange(0,this.__eIN.value.length);};_me._placeholder=function(str){if(typeof this.__eIN.placeholder=='undefined'){if(!this.__eIN.value||this.__placeholder==this.__eIN.value){this.__placeholder=str;if(this._hasFocus()){removecss(this.__eIN,'placeholder');this.__eIN.value='';}
else{this.__eIN.value=this.__placeholder;addcss(this.__eIN,'placeholder');}}}
else
this.__eIN.placeholder=str;};_me.__setMask=function(aButtons,aHandler,bMouseDown){if(aButtons){this.__mask_size=[0,0];if(!this.__mask){this._main.appendChild((this.__mask=mkElement('div',{'className':'mask_container'})));this._obeyEvent('change',[this,'__showMaskHelper']);this._obeyEvent('onkeyup',[this,'__showMaskHelper']);}
else
this.__mask.innerHTML='';var elm;for(var i in aButtons){elm=mkElement('a',{'href':'',rel:i,title:aButtons[i][1]||''});elm.innerHTML=aButtons[i][0];switch(parseInt(aButtons[i][2]||0)){case 1:elm.className='hide';this.__mask_size[1]+=16;break;case 2:elm.className='always';this.__mask_size[1]+=16;default:this.__mask_size[0]+=16;break;}
this.__mask.appendChild(elm);}
if(this.__mask_size[0])
this.__mask_size[0]+=5;if(this.__mask_size[1])
this.__mask_size[1]+=5;if(aHandler){var me=this;var mouse_down=false;var timeout;var event_handler=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(timeout)
clearTimeout(timeout);if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;if(!me._destructed){if(elm.tagName==='A'&&elm.rel)
executeCallbackFunction(aHandler,elm.rel,me);timeout=setTimeout(function(){!me._destructed&&mouse_down&&event_handler(e);},175);}
return false;};if(bMouseDown){this.__mask.onmousedown=function(e){mouse_down=true;event_handler(e);};this.__mask.onmouseup=function(e){mouse_down=false;};this.__mask.onmouseout=function(e){mouse_down=false;};}else{this.__mask.onclick=event_handler;}}}
else
if(this.__mask){this.__mask.removeChild(this.__mask);this.__eIN.style[gui._rtl?'paddingLeft':'paddingRight']='';this._disobeyEvent('change',[this,'__showMaskHelper']);this._disobeyEvent('onkeyup',[this,'__showMaskHelper']);}};_me.__showMask=function(){if(this.__mask){addcss(this.__mask,'show');this.__mask.style.width=this.__mask_size[0]+'px';this.__eIN.style[gui._rtl?'paddingLeft':'paddingRight']=(this.__mask_size[0]+10)+'px';}};_me.__hideMask=function(){if(this.__mask){removecss(this.__mask,'show');this.__mask.style.width=this.__mask_size[1]+'px';this.__eIN.style[gui._rtl?'paddingLeft':'paddingRight']=(this.__mask_size[1]+10)+'px';}};_me.__showMaskHelper=function(){if(this._value())
this.__showMask();else
this.__hideMask();};

/* client/inc/obj_input_calendar.js */
_me=obj_input_calendar.prototype;function obj_input_calendar(){};_me.__constructor=function(empty,bNoEmpty,opt){var me=this;this._create('input','obj_input');this.input._readonly(true);this.__opt=opt||{};if(this.__opt.week)
addcss(this._main,'week');if(empty){this.__value='';this.__empty=true;}else{this.__bNoEmpty=bNoEmpty;this.__value=new IcewarpDate();this.__empty=false;this._value(this.__value);}
this.input._onkeydown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.input.__eIN==elm){switch(e.keyCode){case 27:if(me.block){me.__hideCal();e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();}
break;case 9:if(me.block)
me.__hideCal();return true;default:me.input._onclick();}
return false;}};this.input._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.block&&me.block._destructed==false){if(elm==this)
return true;}else
if(elm==this)
me.input._onclick();e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};this.input._onclick=function(e){if(!this._disabled()){if(me.block&&me.block._destructed==false)
me.__hideCal();else
me.__showCal();}
return true;};if(hascss(this._main,'noborder')){addcss(this.input._main,'noborder');}
if(hascss(this._main,'bold')){addcss(this.input._main,'bold');}};_me._weekMode=function(b){this.__opt.week=b;if(b){addcss(this._main,'week');this.input._value(getLang('DATES::WEEK2')+' '+this.__value.week()+', '+this.__value.format('L'));}
else{removecss(this._main,'week');this.input._value(this.__value.format('L'));}};_me.__showCal=function(){var me=this,pos=getSize(this.input._main);if(!this.block||this.block._destructed){this.block=gui._create('calendar_block','obj_block_ext_uni','','',this._main);this.block._create('calendar','obj_calendar','','bubble2 obj_input_calendar_bubble',this.__opt);this.block.calendar._value(this._value());if(!this.__bNoEmpty){this.block.calendar.empty._main.classList.add('show');this.block.calendar.empty._onclick=function(){me._value('empty');me.__hideCal();me._focus();if(me._ondateselect)
me._ondateselect();me.__exeEvent('_ondateselect',null,{"owner":me});};}
this.block.calendar._onchange=function(e){var dDate=this._value();me.__empty=false;me.__value=dDate;me.input._value(dDate.format('L'));me.__hideCal();me._focus();if(me.__restrictions)
me.__check();if(me._ondateselect)
me._ondateselect(dDate);me.__exeEvent('_ondateselect',null,{"date":dDate,"owner":me});};}
var h=0;if(window.innerHeight)
h=window.innerHeight;else
if(window.document.body)
h=window.document.body.clientHeight;var posh=Math.max(this.block.calendar._main.scrollHeight,256);var w=document.body.offsetWidth;var x=pos.x;if(gui._rtl){x=(pos.x+pos.w)-380;if(x<0)x=0;}
else
if(pos.x+380>w)
x=w-380;if(h<(pos.y+posh))
this.block._place(x,pos.y-posh+1,380,posh,'bottom');else
this.block._place(x,pos.y+pos.h+4,380,posh,'top');};_me.__hideCal=function(){setTimeout(function(){if(this.block){this.block._destruct();this.block=null;delete this.block;}}.bind(this),0);};_me._value=function(aData){if(aData){this.__empty=false;if(aData instanceof IcewarpDate){this.__value=aData;}else if(Is.Number(aData)||Is.String(aData)&&!isNaN(parseInt(aData,10))){aData=parseInt(aData,10);if(aData==0){this.__value='';this.__empty=true;}else{this.__value=new IcewarpDate(aData,{format:IcewarpDate.JULIAN});}}else if(aData=='empty'){this.__value='';this.__empty=true;}else{this.__value=new IcewarpDate(aData);this.__value.hour(0);this.__value.minute(0);this.__value.second(0);this.__value.millisecond(0);}
if(this.block&&this.block.calendar){if(this.__empty){var oDate=new IcewarpDate();oDate.hour(0);oDate.minute(0);oDate.second(0);oDate.millisecond(0);this.block.calendar._value(oDate,true);}else
this.block.calendar._value(this.__value);}
if(this.__empty||+this.__value===0){this.input._value(' ');}
else
if(this.__opt.week){this.input._value(getLang('DATES::WEEK2')+' '+this.__value.week()+', '+this.__value.format('L'));}else{this.input._value(this.__value.format('L'));}
if(this.__restrictions){this.__check();}}else{if(this.__empty){return'';}
return this.__value?this.__value.format(IcewarpDate.JULIAN):'';}};_me._getObjectDate=function(){if(this.__empty)
return'';return this.__value;};_me._parseDate=function(y,m,d){var tmpDate=new IcewarpDate([y,m-1,d,12,0,0]);if(d!=tmpDate.getDate())
tmpDate.hour(25);return tmpDate.format('L');};_me._disabled=function(b){if(typeof b=='undefined')
return this.input._disabled();else
this.input._disabled(b);};_me._restrict=function(){this.__restrictions=true;this.__check();};_me.__check=function(){if(this.__empty)
addcss(this._main,'error');else
removecss(this._main,'error');};_me._tabIndex=function(sContainer,i,oDock){this.input._tabIndex(sContainer,i,oDock);};_me._focus=function(b){return this.input._focus(b);};

/* client/inc/obj_input_dynamic.js */
_me=obj_input_dynamic.prototype;function obj_input_dynamic(){};_me.__constructor=function(){var me=this;this.__maxWidth=300;this.__minWidth=45;AttachEvent(this.__eIN,'onkeydown',function(e){me.__resize();});AttachEvent(this.__eIN,'onkeyup',function(e){me.__resize();});AttachEvent(this.__eIN,'onchange',function(e){me.__resize();});AttachEvent(this.__eIN,'onpaste',function(e){setTimeout(function(){me.__resize();},100);});this._obeyEvent('change',[this,'__resize']);};_me.__resize=function(){if(!this.__sizediv){this.__sizediv=mkElement('div',{className:'size'});this._main.appendChild(this.__sizediv);}
else
this.__sizediv.innerHTML='';if(this.__mask_size)
this.__sizediv.style.paddingRight=(Math.max(this.__mask_size[0]||0,this.__mask_size[1]||0)+15)+'px';this.__sizediv.appendChild(document.createTextNode(this.__eIN.value));this.__eIN.style.width=(this.__sizediv.offsetWidth<this.__maxWidth?(this.__minWidth>this.__sizediv.offsetWidth?this.__minWidth:this.__sizediv.offsetWidth):this.__maxWidth)+'px';};

/* client/inc/obj_input_email.js */
_me=obj_input_email.prototype;function obj_input_email(){this.__disabled=false;};_me.__constructor=function(){this._create('inp','obj_input','','obj_input_100');this._create('btn','obj_button','','simple ico img');this.btn._onclick=function(){if(this.__disabled)return;var mail=this._parent.inp._value();if(mail)
NewMessage.compose({to:mail});};};_me._disabled=function(bDisable){if(typeof bDisable!="boolean")
return this.__disabled;else{this.__disabled=bDisable;this.inp._disabled(bDisable);this.btn._disabled(bDisable);}}
_me._readonly=function(b){return this.inp._readonly(b);};_me._value=function(v){return this.inp._value(v);};_me._getFocusElement=function(){return this.inp._getFocusElement();};_me._focus=function(b){return this.inp._focus(b);};

/* client/inc/obj_input_month.js */
_me=obj_input_month.prototype;function obj_input_month(){};obj_input_month.DATE_FORMAT='MMMM YYYY';_me.__constructor=function(opt){var me=this;this._create('input','obj_input');this.input._readonly(true);this.__opt=opt||{};this.input._onkeydown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.input.__eIN==elm){switch(e.keyCode){case 27:if(me.block){me.__hideCal();e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();}
break;case 9:if(me.block)
me.__hideCal();return true;default:me.input._onclick();}
return false;}};this.input._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me.block&&me.block._destructed==false){if(elm==this)
return true;}else
if(elm==this)
me.input._onclick();e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();return false;};this.input._onclick=function(e){if(!this._disabled()){if(me.block&&me.block._destructed==false)
me.__hideCal();else
me.__showCal();}
return true;};if(hascss(this._main,'noborder')){addcss(this.input._main,'noborder');}
if(hascss(this._main,'bold')){addcss(this.input._main,'bold');}
this._value(new IcewarpDate());};_me.__showCal=function(){var me=this,pos=getSize(this.input._main);if(!this.block||this.block._destructed){this.block=gui._create('calendar_block','obj_block_ext','','bubble2 obj_input_month_bubble');this.block._create('calendar','obj_month','','',this.__opt);this.block.calendar._value(this._value(),true);this.block.calendar._onchange=function(e){var dDate=this._value();me.__empty=false;me.__value=dDate;me.input._value(dDate.format(obj_input_month.DATE_FORMAT));me.__hideCal();me._focus();if(me.__restrictions)
me.__check();if(me._ondateselect)
me._ondateselect(dDate);me.__exeEvent('_ondateselect',null,{"date":dDate,"owner":me});};}
var h=0;if(window.innerHeight)
h=window.innerHeight;else
if(window.document.body)
h=window.document.body.clientHeight;var posh=Math.max(this.block.calendar._main.scrollHeight,256);var w=document.body.offsetWidth;var x=pos.x;if(gui._rtl){x=(pos.x+pos.w)-250;if(x<0)x=0;}
else
if(pos.x+250>w)
x=w-250;if(h<(pos.y+posh))
this.block._place(x,pos.y-posh+1,250,posh,'bottom');else
this.block._place(x,pos.y+pos.h+4,250,posh,'top');};_me.__hideCal=function(){if(this.block){this.block._destruct();delete this.block;}};_me._value=function(aData){if(aData){this.__empty=false;if(aData instanceof IcewarpDate){this.__value=aData;}else if(Is.Number(aData)||Is.String(aData)&&!isNaN(parseInt(aData,10))){aData=parseInt(aData,10);if(aData==0){this.__value='';this.__empty=true;}else{this.__value=new IcewarpDate(aData,{format:IcewarpDate.JULIAN});}}else if(aData=='empty'){this.__value='';this.__empty=true;}else{this.__value=new IcewarpDate(aData);this.__value.hour(0);this.__value.minute(0);this.__value.second(0);this.__value.millisecond(0);}
if(this.block&&this.block.calendar){if(this.__empty){var oDate=new IcewarpDate();oDate.hour(0);oDate.minute(0);oDate.second(0);oDate.millisecond(0);this.block.calendar._value(oDate,true);}else
this.block.calendar._value(this.__value,true);}
if(this.__empty||+this.__value===0){this.input._value('');}
else{this.input._value(this.__value.format(obj_input_month.DATE_FORMAT));}
if(this.__restrictions){this.__check();}}
else
if(this.__empty)
return'';else
return this.__value?this.__value.format(IcewarpDate.JULIAN):'';};_me._getObjectDate=function(){if(this.__empty)
return'';return this.__value;};_me._disabled=function(b){return this.input._disabled(b);};_me._restrict=function(){this.__restrictions=true;this.__check();};_me.__check=function(){if(this.__empty)
addcss(this._main,'error');else
removecss(this._main,'error');};_me._tabIndex=function(sContainer,i,oDock){this.input._tabIndex(sContainer,i,oDock);};_me._focus=function(b){return this.input._focus(b);};

/* client/inc/obj_input_number.js */
_me=obj_input_number.prototype;function obj_input_number(){};_me.__constructor=function(){var me=this;this.__range=[];this.__setMask({'sub':['&#xe043;','',2],'add':['&#xe044;','',2]},[function(id){if(!me._disabled()){var i=parseInt(me._value(),10)||0;switch(id){case'add':if(!Is.Number(me.__range[1])||i<me.__range[1])
me._value(i+1);break;case'sub':if(!Is.Number(me.__range[0])||i>me.__range[0])
me._value(i-1);}
if(!me.__check()){me._value(i);}}}],true);this._obeyEvent('onkeyup',[function(e){var v=me.__eIN.value.replace(/[^0-9]/g,'')||0;if(Is.Number(me.__range[0]))
if(v<me.__range[0])v=me.__range[0];if(Is.Number(me.__range[1]))
if(v>me.__range[1])v=me.__range[1];me.__eIN.value=v;}]);};_me._range=function(a,b){this.__range=[a,b];};

/* client/inc/obj_input_phone.js */
_me=obj_input_phone.prototype;function obj_input_phone(){this.__disabled=false;};_me.__constructor=function(){this._create('inp','obj_input','','obj_input_100');if(sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){this._create('btn','obj_button','','simple ico img');this.btn._onclick=function(){if(this.__disabled)return;var num=this._parent.inp._value();if(num){gui.frm_main._call(num);}};}};_me._value=function(v){return this.inp._value(v);};_me._disabled=function(bDisable){if(typeof bDisable=="undefined")
return this.__disabled;else{this.__disabled=bDisable?true:false;this.inp._disabled(bDisable);}}
_me._sms=function(b){if(b&&sPrimaryAccountSMS&&(GWOthers.getItem('RESTRICTIONS','disable_sms')||0)<1){if(!this.btn2){addcss(this._main,'sms');this._create('btn2','obj_button','','simple ico img sms')._onclick=function(){var num=this._parent.inp._value();if(num)
NewMessage.compose({sms:num});};}}
else
if(this.btn2){removecss(this._main,'sms');this.btn2._destruct();}};_me._readonly=function(b){return this.inp._readonly(b);};_me._value=function(v){return this.inp._value(v);};_me._getFocusElement=function(){return this.inp._getFocusElement();};_me._focus=function(b){return this.inp._focus(b);};

/* client/inc/obj_input_search.js */
_me=obj_input_search.prototype;function obj_input_search(){};_me.__constructor=function(){var me=this;this.__setMask({'clear':['&#xe036;',getLang('COMMON::CLEAR')]},[function(id){if(id=='clear'){if(me._onsubmit){me._value('');me._onsubmit();}
else
if(me._onkeyup)
me._onkeyup({keyCode:27});me._focus();}}]);this._main.appendChild(mkElement('a',{className:'input_ico',onclick:function(e){if(!me._onsubmit||!me._onsubmit())
me._focus();}}));this._obeyEvent('change',[this,'__hasValue']);this._obeyEvent('onkeyup',[this,'__hasValue']);};_me.__hasValue=function(){if(this._value())
addcss(this._main,'value');else
removecss(this._main,'value');};

/* client/inc/obj_input_search_auto.js */
_me=obj_input_search_auto.prototype;function obj_input_search_auto(){};_me.__constructor=function(){this.__timeout;this._obeyEvent('onkeyup',[this,'__starttimer']);var me=this;this.__setMask({'clear':['&#xe036;',getLang('COMMON::CLEAR')]},[function(id){if(id=='clear'&&me._value()){me._value('');if(me._onsubmit)
me._onsubmit();}}]);this._onsubmit=function(){if(this.__timeout)clearTimeout(this.__timeout);this._search();};};_me.__starttimer=function(){if(this.__timeout)clearTimeout(this.__timeout);this.__timeout=setTimeout("try{"+this._pathName+"._search();}catch(er){gui._REQUEST_VARS.debug && console.log(this._name||false,er);}",1000);};_me._search=function(){if(this._onsearch)this._onsearch(this._value());this.__exeEvent('onsearch',null,{"owner":this,"value":this._value()});};

/* client/inc/obj_input_search_next.js */
_me=obj_input_search_next.prototype;function obj_input_search_next(){};_me.__constructor=function(){var me=this;this.__setMask({'next':['&#xe043;',getLang('COMMON::NEXT')],'prev':['&#xe044;',getLang('COMMON::PREVIOUS')],'clear':['&#xe036;',getLang('COMMON::CLEAR')]},[function(id){switch(id){case'clear':if(me._onsubmit){me._value('');me._onsubmit();}
else
if(me._onkeyup)
me._onkeyup({keyCode:27});me._focus();break;case'next':if(me._onnext&&me._value())
me._onnext();break;case'prev':if(me._onprev&&me._value())
me._onprev();}}]);};

/* client/inc/obj_input_url.js */
_me=obj_input_url.prototype;function obj_input_url(){this.__disabled=false;};_me.__constructor=function(bText){var me=this;this._features='toolbar=1,menubar=1,status=1,location=1,scrollbars=1';if(bText)
this._create('inp','obj_text');else
this._create('inp','obj_input','','obj_input_100');this.inp._onclick=function(){if(me._onclick&&!me.__disabled)
me._onclick();};this._create('btn','obj_button','','simple ico img');this.btn._onclick=function(){if(me.__disabled)return;var url=this._parent.inp._value();if(url){if(url.indexOf('://')<0)
url='http://'+url;window.open(url,'',me._features);}};};_me._disabled=function(bDisable){if(typeof bDisable!="boolean")
return this.__disabled;else{this.__disabled=bDisable;this.inp._disabled(bDisable);this.btn._disabled(bDisable);}}
_me._value=function(v){return this.inp._value(v);};_me._readonly=function(b){return this.inp._readonly(b);};_me._setRange=function(pos1,pos2){return this.inp._setRange(pos1,pos2);};_me._getFocusElement=function(){return this.inp._getFocusElement();};_me._focus=function(b){return this.inp._focus(b);};

/* client/inc/obj_item_search.js */
_me=obj_item_search.prototype;function obj_item_search(){};_me.__constructor=function(aFolder){this._SQL='';var me=this;this._create('search','obj_suggest_search','main','obj_input_100');if(aFolder)
this._setFolder(aFolder);this.search._onsubmit=function(){me._buildSQL();if(me._SQL)
addcss(this._main,'active');else
removecss(this._main,'active');if(me._onsearch)me._onsearch(me._value(),me.__string);me.__exeEvent('onsearch',null,{"sql":me._value,"string":me.__string,"owner":me});};this.search._onblur=function(){if(this._onsubmit&&me._SQL!=me._buildSQL())
this._onsubmit();me._onblur&&me._onblur();return true;};this.search._createWizard=function(){me.search.__eICO.onclick({});};this.search.__eICO.onclick=function(e){var e=e||window.event,aFolPath=me.search._getFolder(),sType='',aFolder={};if(aFolPath.fid){aFolder=dataSet.get('folders',[aFolPath.aid,aFolPath.fid])||{};sType=WMFolders.getType(aFolPath)||'C';}
if(!me.wizard){switch(sType){case'W':case'J':sType='E';case'M':if(aFolder.RSS)
sType='R';case'E':case'C':case'F':case'T':case'N':addcss(me._main,'wizard');var pos=getSize(me.search._main),bSFolder=me._parent&&me._parent._pathName=="gui.frm_main.stat"&&GWOthers.getItem('RESTRICTIONS','disable_virtual')!='1';me.wizard=gui._create('search_wizard','obj_search_wizard','','search_wizard',sType,[function(v){if(Is.String(v)){me.search._value(v)
if(me.search._onsubmit)
me.search._onsubmit();}
else
me.search._focus();}],bSFolder);me.wizard._place(pos.x,pos.y+pos.h,pos.w);me.wizard.__removecss=function(){removecss(me._main,'wizard');delete me.wizard;};me.wizard._add_destructor('__removecss');me.wizard._value(me.search._value());if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}}
else
if(me.wizard)
me.wizard._destruct();me._focus();return;};this.search.__eICO.onmousedown=function(e){var e=e||window.event;if(me.wizard){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;}};if('selectionStart'in this.search.__eIN){if('paste'in window.document)
AttachEvent(this.search.__eIN,'paste',function(e){me.__onpaste();});else
if('onpaste'in window.document)
AttachEvent(this.search.__eIN,'onpaste',function(e){me.__onpaste();});AttachEvent(this.search.__eIN,'onkeyup',function(e){if(me.__paste){var v=me.search._value();if(me.__paste.v!=v){var s=v.substring(me.__paste.start,v.length-me.__paste.end);if(s.charAt(0)!=='"'&&~s.indexOf(' ')){for(var i=0,l=me.__paste.start,q=false;i<l;i++)
if(v.charAt(i)==='"'&&v.charAt(i-1)!=='\\')
q=!q;if(!q){s=v.substr(0,me.__paste.start)+'"'+s.replace(/\\/g,"\\\\").replace(/([^\\])"/g,'$1\\"')+'"'+(me.__paste.end?v.substr(-me.__paste.end):'');me.search._value(s);me.search._setRange(s.length-me.__paste.end);}}}
delete me.__paste;}});}};_me.__onpaste=function(){this.__paste={v:this.search._value(),start:this.search.__eIN.selectionStart,end:this.search._value().length-this.search.__eIN.selectionEnd};};_me._getFolder=function(){return this.search._folder;};_me._setFolder=function(aFolder,sType){this.search._setFolder(aFolder,sType);};_me._deactivate=function(){this._value('');removecss(this.search._main,'active');};_me._disabled=function(b){return this.search._disabled(b);};_me._focus=function(){return this.search._focus();};_me._select=function(){this.search._select();};_me._tabIndex=function(sContainer,i,oDock){this.search._tabIndex(sContainer,i,oDock);};_me._value=function(v,bActivate){if(Is.String(v)){this._SQL=v;this.search._value(v);if(v.length&&bActivate)
addcss(this.search._main,'active');else
removecss(this.search._main,'active');}
else
return this._SQL||this._defaultSQL||'';};_me._setRange=function(pos1,pos2){return this.search._setRange(pos1,pos2);};_me._buildSQL=function(){return(this._SQL=this.search._value());};

/* client/inc/obj_itemview.js */
_me=obj_itemview.prototype;function obj_itemview(){};_me.__constructor=function(sDataSet,sDataPath){var me=this;this._scrollbar(this._getAnchor('scroll'),this._main);this._aValues={};this._aRefresh=null;this.__refresh=true;this.__last_tab={};this._getAnchor('body').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(!elm.parentNode)return;if(elm.parentNode.className=='tags'&&gui.frm_main.search&&gui.frm_main.search.search){gui.frm_main.search.search._value('tag:"'+elm.innerHTML+'"');if(gui.frm_main.search.search._onsubmit)
gui.frm_main.search.search._onsubmit();return false;}
else{if(elm.tagName!='A')
elm=elm.parentNode;if(elm.tagName=='A'){if(hascss(elm,'lock')){var aRights=WMFolders.getRights({aid:me.__activeItemID[0],fid:me.__activeItemID[1]}),aAccess=WMFolders.getAccess({aid:me.__activeItemID[0],fid:me.__activeItemID[1]});if(aAccess.modify&&!me.__activeItem.EVNLOCKOWN_ID){me.__activeItem.EVNLOCKOWN_ID=sPrimaryAccountGWID;elm.className='lock locked';elm.innerHTML=getLang('FILE::LOCKED_BY_ME');Item.set_lock(me.__activeItemID,true);}
else
if(aAccess.modify&&(aRights.owner||me.__activeItem.EVNLOCKOWN_ID==sPrimaryAccountGWID)){me.__activeItem.EVNLOCKOWN_ID='';elm.className='lock';elm.innerHTML=getLang('FILE::UNLOCKED');Item.set_lock(me.__activeItemID,false);}
else
if(me.__activeItem.EVNLOCKOWN_EMAIL)
Item.sendEmailTo(me.__activeItem.EVNLOCKOWN_EMAIL,{sSubject:me.__activeItem.EVNTITLE});return false;}
else
if(hascss(elm,'revisions')){if(Is.Array(me.__activeItemID)){Item.openwindow(me.__activeItemID,'','',me.__activeType,null,[function(frm){if(frm.maintab['revisions'])
frm.maintab['revisions']._active();}]);}
return false;}
else
if(hascss(elm,'itmnote')){if(Is.Array(me.__activeItemID)){Item.openwindow(me.__activeItemID,'','',me.__activeType,null,[function(frm){if(frm.maintab['tab1']){frm.maintab.tab1.EVNNOTE._focus();frm.maintab.tab1.x_folders&&frm.maintab.tab1.x_folders._main.parentNode.removeChild(frm.maintab.tab1.x_folders._main);frm.maintab.tab1._getAnchor('name').setAttribute('readonly',true);frm.maintab.tab1._getAnchor('tags_row').parentNode.removeChild(frm.maintab.tab1._getAnchor('tags_row'));}}]);}
return false;}
else
if(hascss(elm,'itmtags')){if(Is.Array(me.__activeItemID))
Item.edit_tags([me.__activeItemID[0],me.__activeItemID[1],[me.__activeItemID[2]]]);return false;}
else
if(sPrimaryAccountWebDAV&&hascss(elm,'att')&&elm.rel&&me.__activeItemID&&elm.title&&Item.officeSupport(elm.title)){Item.officeOpen({aid:me.__activeItemID[0],fid:me.__activeItemID[1],iid:me.__activeItemID[2],attid:elm.rel},[downloadItem,[elm.href,true]],Path.extension(elm.title));return false;}}}};if(sDataSet)
this._listen(sDataSet,sDataPath);this._add_destructor('__destructor');};_me._onnotify=function(aData){if(aData.ACTION==='add'){if(aData.TYPE==='gw-queue'){this.__reload_image(true);}
else
if(aData.TIME>0&&this.__activeItem.EVN_MODIFIED<aData.TIME){this.__refresh=true;dataSet.add(this._listener,(this._listenerPath||[]).concat(this.__activeItemID,'EVN_MODIFIED'),aData.TIME);}}};_me.__destructor=function(){if(this.__reload_timer)
clearTimeout(this.__reload_timer);};_me.__btnmenu=function(){var aMenu=[];switch(this.__activeType){case'E':case'J':case'C':case'T':case'N':aMenu.push({title:'POPUP_ITEMS::OPEN',arg:[this,'__btnaction',['edit']]});break;}
aMenu.push({title:'-'},{title:'POPUP_ITEMS::ATTACH_TO_EMAIL',arg:[this,'__btnaction',['email']]},{title:'ITEM::PUBLIC',arg:[this,'__btnaction',['public']]},{title:'-'},{title:'MAIN_MENU::DELETE',arg:[this,'__btnaction',['delete']],css:'color2',disabled:!WMFolders.getAccess(this.__activeItemID,'remove')});return aMenu;};_me.__btnaction=function(type,arg){switch(type){case'edit':Item.openwindow(this.__activeItemID,'','',this.__activeType);break;case'delete':Item.remove([this.__activeItemID[0],this.__activeItemID[1],[this.__activeItemID[2]]]);break;case'email':Item.sendAsEmail([this.__activeItemID[0],this.__activeItemID[1],[this.__activeItemID[2]]]);break;case'public':if(this._aValues.TICKET)
Item.collaborate([this.__activeItemID[0],this.__activeItemID[1],[this.__activeItemID[2]]]);break;}};_me._refreshing=function(b){if(Is.Defined(b)){if(b){if(this._aRefresh!=null)
this._fill(this._aRefresh,this.__activeType);else
this.__refresh=true;}
else
this.__refresh=false;}
else
return this.__refresh;};_me.__update=function(){var aData=dataSet.get(this._listener,this._listenerPath);for(var aid in aData)
for(var fid in aData[aid]){var lastId=dataSet.get('active_items',[aid,fid]);if(lastId&&aData[aid][fid][lastId]){var aItem=aData[aid][fid][lastId],sFolderType=WMFolders.getType([aid,fid]);if(aItem&&sFolderType){if(this.__refresh||!this.__activeItemID||this.__activeItemID[0]!=aItem.aid||this.__activeItemID[1]!=aItem.fid||this.__activeItemID[2]!=WMItems.__clientID(aItem.ITM_ID||aItem.EVN_ID)){this._fill(sFolderType,aItem);}
else{this._aRefresh=aItem;}
return;}}}
this._fill();};_me._fill=function(sFolderType,aItem){var me=this;if(this.__reload_timer)
clearTimeout(this.__reload_timer);this._clean();this._getAnchor('body').innerHTML='';this._aValues=aItem;this.__reloadme=false;this.__refresh=true;this._aRefresh=null;if(!Is.Defined(sFolderType)){this.__activeItemID=null;this.__activeItem=null;if(this.X_btn)
this.X_btn._disabled(true);this._getAnchor('body').innerHTML='<h5>'+getLang('ITEMVIEW::NOITEM')+'</h5>';return;}
if(sFolderType=='G'||sFolderType=='C')
sFolderType=aItem.ITMCLASS||aItem.EVNCLASS;this.__activeItem=aItem;this.__activeItemID=[aItem.aid,aItem.fid,WMItems.__clientID(aItem.ITM_ID||aItem.EVN_ID)];this.__activeType=sFolderType;var aOut={};if(sFolderType!='F'){this._create('X_btn','obj_button','scroll','simple color1 select btn_open');this.X_btn._disabled(true);this.X_btn._value('POPUP_ITEMS::OPEN_ITEM');this.X_btn._onclick=function(e){if(!this.__cmenu||this.__cmenu._destructed){if(Is.Array(me.__activeItemID)){var pos=getSize(this.__eIN),aMenu=me.__btnmenu();this.__cmenu=gui._create('cmenu','obj_context');this.__cmenu._fill(aMenu);this.__cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',1);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}}};}
switch(sFolderType){case'N':var d=IcewarpDate.unix(aItem.EVN_CREATED);aOut={title:aItem.EVNTITLE||getLang("EVENT_VIEW::NOTITLE"),date:d.format('L LT')};try{aOut.note=aItem.NOTES[0]?aItem.NOTES[0].values.NOTE_TEXT:'';if(aItem.EVNDESCFORMAT==='text/html'){aOut.note=DOMPurify.sanitize(aOut.note);}else{aOut.note=(aOut.note||'').escapeHTML();}}
catch(r){aOut.note='';}
break;case'L':case'C':aOut.fullname=(aItem.ITMCLASSIFYAS||'').escapeHTML();aOut.birthday=parseInt(aItem.ITMBDATE,10)?IcewarpDate.julian(aItem.ITMBDATE).format('L'):'';if(aItem.ITMDESCFORMAT==='text/html'){aOut.note=DOMPurify.sanitize(aItem.ITMDESCRIPTION);}else{aOut.note=aItem.ITMDESCRIPTION;}
aOut.company=(aItem.ITMCOMPANY||'').escapeHTML();aOut.department=(aItem.ITMDEPARTMENT||'').escapeHTML();aOut.jobtitle=(aItem.ITMJOBTITLE||'').escapeHTML();aOut.profession=(aItem.ITMPROFESSION||'').escapeHTML();aOut.location=(aItem.ITMOFFICELOCATION||'').escapeHTML();aOut.assistant=(aItem.ITMASSISTANTNAME||'').escapeHTML();aOut.manager=(aItem.ITMMANAGERNAME||'').escapeHTML();var mapping={H:'home_',B:'business_',O:'other_'};aOut.phones=[];aOut.emails=[];aOut.im=[];if(aItem.LOCATIONS){var loc,aMap;for(var l in aItem.LOCATIONS){loc=aItem.LOCATIONS[l].values;aOut[mapping[loc.LCTTYPE]+'street']=(loc.LCTSTREET||'').escapeHTML();aOut[mapping[loc.LCTTYPE]+'city']=(loc.LCTCITY||'').escapeHTML();aOut[mapping[loc.LCTTYPE]+'zip']=(loc.LCTZIP||'').escapeHTML();aOut[mapping[loc.LCTTYPE]+'state']=(loc.LCTSTATE||'').escapeHTML();aOut[mapping[loc.LCTTYPE]+'country']=(loc.LCTCOUNTRY||'').escapeHTML();if(loc.LCTSTREET){aMap=[loc.LCTSTREET];if(loc.LCTZIP||loc.LCTCITY)
aMap.push((loc.LCTZIP||'')+' '+(loc.LCTCITY||'').trim());if(loc.LCTSTATE)
aMap.push(loc.LCTSTATE);if(loc.LCTCOUNTRY)
aMap.push(loc.LCTCOUNTRY);aOut[mapping[loc.LCTTYPE]+'map']=aMap.join(', ').escapeHTML();}
if(aItem.ITMCLASS=='L'){if(loc.LCTEMAIL1)
aOut.emails.push((loc.LCTEMAIL1||'').escapeHTML());}
else
if(loc.LCTTYPE=='H'){if(loc.LCTEMAIL1)aOut.emails.push((loc.LCTEMAIL1||'').escapeHTML());if(loc.LCTEMAIL2)aOut.emails.push((loc.LCTEMAIL2||'').escapeHTML());if(loc.LCTEMAIL3)aOut.emails.push((loc.LCTEMAIL3||'').escapeHTML());if(loc.LCTIM)aOut.im.push((loc.LCTIM||'').escapeHTML());if(loc.LCTIM2)aOut.im.push((loc.LCTIM2||'').escapeHTML());if(loc.LCTIM3)aOut.im.push((loc.LCTIM3||'').escapeHTML());for(var i in loc)
if(i.indexOf('LCTPHN')===0&&loc[i])
aOut.phones.push({title:getLang('PHONE::'+i),number:(loc[i]||'').escapeHTML(),type:i});}}}
if(sFolderType==='C'){aOut.contactid=aItem.ITM_ID;}
if(!aOut.emails.length){delete aOut.emails;aOut.avatar=aOut.avatar||aOut.fullname;}else if(sFolderType==='L'){aOut.avatar='['+aItem.fid+'::'+(aItem.ITMCLASSIFYAS||aItem.ITMTITLE)+']';}else{aOut.avatar=MailAddress.createEmail((aOut.fullname||'').escapeHTML(),aOut.emails[0]);}
if(!aOut.phones.length)
delete aOut.phones;if(aItem.ATTACHMENTS)
for(var i in aItem.ATTACHMENTS)
if(aItem.ATTACHMENTS[i].values&&aItem.ATTACHMENTS[i].values.ATTTYPE=='P'&&aItem.ATTACHMENTS[i].values.TICKET){aOut.img=aItem.ATTACHMENTS[i].values.TICKET;break;}
sFolderType='C';break;case'J':if(aItem.EVNLOCATION){var tmp=aItem.EVNLOCATION.split('|');aOut.type=tmp[0];aOut.company=tmp[1];var tmp={'Conversation':"JOURNAL::CONVERSATION",'Document':"JOURNAL::DOCUMENT",'E-mail Message':"JOURNAL::E-MAIL_MESSAGE",'Fax':"JOURNAL::FAX",'Letter':"JOURNAL::LETTER",'Conference':"JOURNAL::CONFERENCE",'Conference Cancellation':"JOURNAL::CONFERENCE_CANCELLATION",'Conference Request':"JOURNAL::CONFERENCE_REQUEST",'Conference Response':"JOURNAL::CONFERENCE_RESPONSE",'Microsoft Office Access':"JOURNAL::MICROSOFT_OFFICE_ACCESS",'Microsoft Office Excel':"JOURNAL::MICROSOFT_OFFICE_EXCEL",'Microsoft PowerPoint':"JOURNAL::MICROSOFT_POWERPOINT",'Microsoft Visio':"JOURNAL::MICROSOFT_VISIO",'Microsoft Word':"JOURNAL::MICROSOFT_WORD",'Note':"JOURNAL::NOTE",'Phone Call':"JOURNAL::PHONE_CALL",'Remote Session':"JOURNAL::REMOTE_SESSION",'Task':"JOURNAL::TASK",'Task Request':"JOURNAL::TASK_REQUEST",'Task Response':"JOURNAL::TASK_RESPONSE"}[aOut.type];if(tmp)
aOut.type=getLang(tmp);}
case'E':aOut.title=aItem.EVNTITLE||getLang('EVENT_VIEW::NOTITLE');aOut.location=aItem.EVNLOCATION;if(aItem.EVNDESCFORMAT==='text/html'){aOut.note=DOMPurify.sanitize(aItem.EVNNOTE);}else{aOut.note=(aItem.EVNNOTE||'').escapeHTML();}
aOut.rcr=aItem.EVNRCR_ID?true:false;if(aItem.REMINDERS&&count(aItem.REMINDERS))
aOut.rmn=true;if(aItem.EVNSTARTTIME<0){aOut.t1=IcewarpDate.julian(aItem.EVNSTARTDATE).format("L");aOut.t2=IcewarpDate.julian(aItem.EVNENDDATE-1).format("L");}else{aOut.t1=IcewarpDate.julian(aItem.EVNSTARTDATE,aItem.EVNSTARTTIME).format('L LT');aOut.t2=IcewarpDate.julian(aItem.EVNENDDATE,aItem.EVNENDTIME).format((aItem.EVNSTARTDATE==aItem.EVNENDDATE?'L':"")+' LT');}
if(aOut.t1==aOut.t2)
delete aOut.t2;break;case'T':aOut.title=aItem.EVNTITLE||getLang('EVENT_VIEW::NOTITLE');if(aItem.EVNDESCFORMAT==='text/html'){aOut.note=DOMPurify.sanitize(aItem.EVNNOTE);}else{aOut.note=(aItem.EVNNOTE||'').escapeHTML();}
aOut.rcr=aItem.EVNRCR_ID?true:false;if(aItem.REMINDERS&&count(aItem.REMINDERS))
aOut.rmn=true;if(aItem.EVNENDDATE>0)aOut.t1=IcewarpDate.julian(aItem.EVNENDDATE,0).format("L");if(aItem.EVNSTARTDATE>0)aOut.t2=IcewarpDate.julian(aItem.EVNSTARTDATE,0).format("L");if(aItem.EVNSTATUS){aOut.status=getLang('TASK::'+{B:'NOT_STARTED',I:'IN_PROGRESS',M:'COMPLETED',Q:'DEFERRED',N:'WAITING'}[aItem.EVNSTATUS]);if(aItem.EVNSTATUS!='B'&&aItem.EVNSTATUS!='M'&&Is.Number(parseInt(aItem.EVNCOMPLETE)))
aOut.complete=aItem.EVNCOMPLETE+'%';}
break;case'F':aOut.title=aItem.EVNTITLE||getLang('EVENT_VIEW::NOTITLE');aOut.size=parseFileSize(aItem.EVNCOMPLETE||0);if(aItem.EVNDESCFORMAT==='text/html'){aOut.note=DOMPurify.sanitize(aItem.EVNNOTE);}else{aOut.note=(aItem.EVNNOTE||'').escapeHTML();}
aOut.date=IcewarpDate.unix(aItem.EVN_MODIFIED).format(IcewarpDate.SHORT_L);aOut.full_date=IcewarpDate.unix(aItem.EVN_MODIFIED).format('L LT');aOut.security=getLang(aItem.EVNSHARETYPE=='P'?'SHARING::PRIVATE':'SHARING::PUBLIC');aOut.extension=Path.extension(aItem.EVNTITLE);if(aItem.EVN_METADATA){var metadata=parseURL(aItem.EVN_METADATA);if(metadata){aOut.created_by=metadata.core_own_name;aOut.modified_by=metadata.core_modifiedown_name;}}
var aRights=WMFolders.getRights({aid:this.__activeItemID[0],fid:this.__activeItemID[1]}),aAccess=WMFolders.getAccess({aid:this.__activeItemID[0],fid:this.__activeItemID[1]});if(aItem.EVNLOCKOWN_ID){if(aItem.EVNLOCKOWN_ID==sPrimaryAccountGWID){aOut.lock_info=getLang('FILE::LOCKED_BY_ME');aOut.lock_type=aAccess.modify?' locked':' locked2';}
else{aOut.lock_info=aItem.EVNLOCKOWN_EMAIL?getLang('FILE::LOCKED_BY',[aItem.EVNLOCKOWN_EMAIL]):getLang('FILE::LOCKED');aOut.lock_type=aRights.owner&&aAccess.modify?' locked':' locked2';}
this.__reloadme=true;}
else
aOut.lock_info=getLang('FILE::UNLOCKED');if(aItem.EVNLOCKAPPMASK&0x10)
aOut.conversion=true;if(aItem.REVISIONS)
aOut.revisions=true;aOut.sharing=aItem.EVNOWN_ID===sPrimaryAccountGWID||aAccess.modify;aOut.shared=aItem.EVNDOCINVITE==1;aOut.editing=!!aItem.EVNDOCEDITABLE;aOut.password_protected=!!aItem.EVNDOCPASS;aOut.has_rights=aRights.owner||aAccess.modify;break;default:return;}
if(aItem.ATTACHMENTS){aOut.att=[];atmp={};for(var i in aItem.ATTACHMENTS)
if(aItem.ATTACHMENTS[i].values.TICKET){atmp={id:aItem.ATTACHMENTS[i].values.ATTNAME||aItem.ATTACHMENTS[i].values.ATTDESC,link:aItem.ATTACHMENTS[i].values.TICKET,type:aItem.ATTACHMENTS[i].values.ATTTYPE,time:aItem.ATTACHMENTS[i].values.ATTTIME,mime:aItem.ATTACHMENTS[i].values.ATTPARAMS,queued:aItem.ATTACHMENTS[i].values.ATTQUEUED,size:parseFileSize(aItem.ATTACHMENTS[i].values.ATTSIZE),ico:(aItem.ATTACHMENTS[i].values.ATTDESC&&aItem.ATTACHMENTS[i].values.ATTDESC.indexOf('.')>-1?Path.extension(aItem.ATTACHMENTS[i].values.ATTDESC):'')+(Item.officeSupport(aItem.ATTACHMENTS[i].values.ATTDESC)?' office_support':(Path.extension(aItem.ATTACHMENTS[i].values.ATTDESC)=='pdf'?' pdf_support':'')),title:(aItem.ATTACHMENTS[i].values.ATTDESC||getLang('EVENT_VIEW::NOTITLE'))};if(atmp.type=='thumbnail'){aOut.thumbnail=atmp;}
else
if(atmp.type=='pdf')
aOut.pdf=atmp;else{if(atmp.ico=='mp3')
atmp.play='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),atmp.id].join('/')});aOut.att.push(atmp);}}
if(!aOut.att.length)
delete aOut.att;}
if(sFolderType=='F'){if(aOut.att){var ratio=window.retina||window.devicePixelRatio||1;if(aOut.thumbnail){aOut.preview_img={title:aOut.thumbnail.title,small:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.thumbnail.id].join('/'),'resize':1,'width':1024,'height':1024,'crop':'50%','editcounter':aItem.EVN_EDITCOUNTER,'t':aOut.thumbnail.time}),url:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.thumbnail.id].join('/'),'resize':1,'width':screen.availWidth*ratio,'height':screen.availHeight*ratio,'editcounter':aItem.EVN_EDITCOUNTER})};if(aOut.pdf){aOut.preview_img.title=aOut.pdf.title;aOut.preview_img.pdf='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.pdf.id].join('/')});}}
for(var i=aOut.att.length-1;i>=0;i--){aOut.mime=aOut.att[i].ico.toUpperCase();if(aOut.att[i].mime){var mime=aOut.att[i].mime.toLowerCase();if(mime.indexOf('image')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_IMG');else
if(mime.indexOf('audio')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_SOUND');else
if(mime.indexOf('video')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_VIDEO');else
if(mime.indexOf('template')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_TPL');else
if(mime.indexOf('spreadsheet')>-1||mime.indexOf('ms-excel')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_SS');else
if(mime.indexOf('document')>-1||mime.indexOf('msword')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_DOC');else
if(mime.indexOf('compressed')>-1)
aOut.mime=getLang('ITEMVIEW::MIME_ARCHIVE');}
switch(aOut.mime){case'PDF':aOut.mime=getLang('ITEMVIEW::MIME_PDF');break;case'TXT':aOut.mime=getLang('ITEMVIEW::MIME_TXT');break;}
if(parseInt(aOut.att[i].queued)>0)
aOut.conversion=true;switch(aOut.att[i].ico.split(' ')[0]){case'jpg':case'jpeg':case'png':case'gif':aOut.preview_img={title:aOut.att[i].title,small:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.att[i].id].join('/'),'resize':1,'width':1024,'height':1024,'crop':'50%','editcounter':aItem.EVN_EDITCOUNTER}),url:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.att[i].id].join('/'),'resize':1,'width':screen.availWidth*ratio,'height':screen.availHeight*ratio,'editcounter':aItem.EVN_EDITCOUNTER})};aOut.itmview=true;break;case'mp3':aOut.play=aOut.att[i].play;break;case'pdf':if(aOut.preview_img&&!aOut.preview_img.pdf){aOut.preview_img.title=aOut.att[i].title;aOut.preview_img.pdf='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,(aItem.ITM_ID||aItem.EVN_ID),aOut.att[i].id].join('/')});aOut.itmview=true;break;}
default:if((Item.officeSupport(aItem.EVNTITLE)&&dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true')||Item.editSupport(aItem.EVNTITLE)){if(GWOthers.getItem('DOCUMENTS','office_app')=='webdoc_read')
aOut.itmview=true;else
aOut.itmedit=true;}}}}
if(aOut.revisions){aOut.rev_data=[];var i=1;for(var id in aItem['REVISIONS'])
aOut.rev_data.push({id:id,date:CalendarFormatting.normalWithTime(IcewarpDate.unix(aItem['REVISIONS'][id].values.REVTIMESTAMP)),name:aItem['REVISIONS'][id].values.REVEMAIL||(getLang('ITEMVIEW::VERSION')+' '+i++),title:aItem['REVISIONS'][id].values.REVCOMMENT,avatar:getAvatarURL(aItem['REVISIONS'][id].values.REVEMAIL)});}}
if(aItem.EVNTYPE||aItem.ITMCATEGORY){aOut.tags=[];var arr=(aItem.EVNTYPE||aItem.ITMCATEGORY).split(','),aTags=dataSet.get('tags');for(var i in arr)
if((arr[i]=arr[i].trim()))
aOut.tags.push({tagcolor:aTags[arr[i]]?aTags[arr[i]].TAGCOLOR:'',textcolor:aTags[arr[i]]?aTags[arr[i]].TEXTCOLOR:'#000000',tagname:arr[i]});}
if(aOut.note)
aOut.note=mkElement('div',{innerHTML:aOut.note}).innerHTML;this._draw('obj_itemview_'+sFolderType.toLowerCase(),'body',aOut);this.avatar&&sFolderType==='C'&&this.avatar.__specifyIds([aItem.aid,aItem.fid]);[].forEach.call(this._getAnchor('body').querySelectorAll('.office_support, .pdf_support'),function(file){if(file.href)
file.addEventListener('click',function(e){me.__cmenu=gui._create('cmenu','obj_context');me.__cmenu._fill([{config:{css:'small'}},{title:'POPUP_ITEMS::OPEN',css:'ico',arg:[function(){if(hascss(file,'pdf_support')){if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/)){downloadItem(file.href);}else{gui._create('pdf','frm_pdf')._load(file.href,file.rel);}}else
Item.officeOpen({url:e.target.href},[downloadItem,[e.target.href]],file.textContent.split('.').pop(),'view');}]},{title:'ATTACHMENT::DOWNLOAD',css:'ico',arg:[function(){downloadItem(e.target.href,true);}]}]);me.__cmenu._place(e.clientX,e.clientY);e.preventDefault&&e.preventDefault();e.stopPropagation&&e.stopPropagation();e.stopImmediatePropagation&&e.stopImmediatePropagation();return false;});});this._aOut=aOut;if(sFolderType=='F'){if(this.share){this.share._onclick=function(){Item.collaborate(me.__activeItemID,[function(new_id){me.__activeItemID[2]=new_id?WMItems.__clientID(new_id):me.__activeItemID[2];WMItems.list({aid:me.__activeItemID[0],fid:me.__activeItemID[1],iid:me.__activeItemID[2]},'','','',[function(result){dataSet.add('items',me.__activeItemID,result[me.__activeItemID[0]][me.__activeItemID[1]][me.__activeItemID[2]]);dataSet.add('active_items',[me.__activeItemID[0],me.__activeItemID[1]],me.__activeItemID[2]);me._fill('F',dataSet.get('items',me.__activeItemID));}]);}]);};[].forEach.call(this._main.querySelectorAll('.sharing'),function(elm){elm.addEventListener('click',me.share._onclick);});}
if(this.__last_tab['F']){this.menu._value(this.__last_tab['F']);}
if(aOut.preview_img&&aOut.preview_img.small){this._getAnchor('previewimg').appendChild(mkElement('img',{src:aOut.preview_img.small,onload:function(){me.__imagew&&me.__imagew(this,true)},onerror:function(){me.__imagew&&me.__imagew(this,false)}}));}
if(this._getAnchor('frame')){this._getAnchor('frame').contentWindow.onresize=function(){var ec=me._getAnchor('container');if(me._getAnchor('body').offsetWidth<555){if(!hascss(ec,'small'))
addcss(ec,'small');}
else
removecss(ec,'small');};this._getAnchor('frame').contentWindow.onresize();addcss(this._getAnchor('container'),'visible');}
this.menu.detail._onactive=function(){me.__last_tab['F']=this._name;};this.menu.revision._onactive=function(){me.__last_tab['F']=this._name;};var aRights=WMFolders.getRights({aid:this.__activeItemID[0],fid:this.__activeItemID[1]}),aAccess=WMFolders.getAccess({aid:this.__activeItemID[0],fid:this.__activeItemID[1]});if(!aAccess.modify){this.menu.revision._getAnchor('revlist').querySelector('.new').classList.add('hidden');var revisions=this.menu.revision._getAnchor('main').querySelector('a.revisions');revisions&&revisions.classList.add('hidden');}
this.menu.revision._getAnchor('revlist').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'||(elm=Is.Child(elm,'A',this))){for(var attid in aItem['ATTACHMENTS'])
break;var id=elm.getAttribute('rel');if(attid){if(id)
downloadItem(buildURL({'sid':dataSet.get('main',['sid']),'class':'revision','fullpath':me.__activeItemID[0]+'/'+me.__activeItemID[1]+'/'+WMItems.__serverID(me.__activeItemID[2])+'|'+id+'/'+attid}));else if(aAccess.modify)
gui._create('revision','frm_revision','','',{aid:me.__activeItemID[0],fid:me.__activeItemID[1],iid:me.__activeItemID[2]});}}};this._getAnchor('previewimg').onclick=function(e){if(Item.editSupport(me.__activeItem.EVNTITLE)){Item.editFile(me.__activeItemID);}
else
if(Item.officeSupport(me.__activeItem.EVNTITLE)&&(aOut.itmedit||aOut.itmview)){Item.officeOpen({aid:me.__activeItemID[0],fid:me.__activeItemID[1],iid:me.__activeItemID[2]},[Item.downloadFile,[me.__activeItemID]],Path.extension(me.__activeItem.EVNTITLE));}
else
if(aOut.preview_img){if(aOut.preview_img.pdf){if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/)){Item.downloadFile(me.__activeItemID);}
else{Item.openPDF(me.__activeItemID);}}
else
if(aOut.preview_img.url){var img=gui._create('imgview','frm_imgview');img._fill([me._aOut.preview_img]);img._value(0);}}
else{var e=e||window.event,elm=e.target||e.srcElement,info=me._getAnchor('info');if(elm==info||Is.Child(elm,info)){if(!aOut.play)
Item.downloadFile(me.__activeItemID);}}};}
if(aOut.note){var elm=this._getAnchor('note');if(elm){for(var a=elm.getElementsByTagName('a'),i=a.length-1;i>=0;i--)
if((href=a[i].getAttribute('href'))&&href.indexOf('#')!=0)
if(href.toLowerCase().indexOf('mailto:')==0){a[i].onclick=function(){var out={to:this.href.substr(7)};if(out.to&&out.to.indexOf('?')>-1){out.subject=parseURL(out.to).subject;out.to=out.to.substring(0,out.to.indexOf('?'));}
NewMessage.compose(out);return false;};}
else
a[i].setAttribute('target','_blank');}}
if(aOut.phones)
for(var i=aOut.phones.length-1;i>=0;i--)
if(aOut.phones[i].type=='LCTPHNMOBILE')
this[i>0?'X_p_'+(i-1):'X_p']._sms(true);if(aOut.complete){this.X_PROGRESS._range(100);this.X_PROGRESS._value(aItem.EVNCOMPLETE);}
if(this.X_btn)
this.X_btn._disabled(false);};_me.__imagew=function(img,bOK){if(bOK){if(img.naturalHeight){img.parentNode.style.maxWidth=img.naturalWidth+'px';img.parentNode.style.maxHeight=img.naturalHeight+'px';}
img.style.visibility='visible';}
else
addcss(this._getAnchor('imgpreview'),'max');};_me.__reload_image=function(bForce){var aItem={aid:this.__activeItemID[0],fid:this.__activeItemID[1],iid:WMItems.__serverID(this.__activeItemID[2]),values:['EVN_ID','EVN_EDITCOUNTER','ATTACHMENTS']};WMItems.list(aItem,'','','',[function(aResult){if(!this._destructed&&Is.Object(aResult)&&(aResult=aResult[this.__activeItemID[0]])&&(aResult=aResult[this.__activeItemID[1]])&&(aResult=aResult[this.__activeItemID[2]])){var val,stype;switch(Path.extension(this._aOut.title)){case'jpg':case'jpeg':case'png':case'gif':stype='attachment';break;default:stype='thumbnail';}
var ratio=window.retina||window.devicePixelRatio||1;for(var aid in aResult['ATTACHMENTS']){if((val=aResult['ATTACHMENTS'][aid].values)&&val.ATTTYPE=='pdf'){if(!this._aOut.preview_img)
this._aOut.preview_img={};this._aOut.preview_img.pdf='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,aResult.EVN_ID,encodeURIComponent(aid)].join('/')});this.menu&&this.menu.action&&this.menu.action.print&&this.menu.action.print._disabled(false);}
else
if((this._aOut.conversion||bForce)&&(val=aResult['ATTACHMENTS'][aid].values)&&val.ATTTYPE==stype){if(!val.ATTQUEUED||val.ATTQUEUED==0){if(!this._aOut.preview_img)
this._aOut.preview_img={};if(!this._aOut.preview_img.title)
this._aOut.preview_img.title=val.ATTNAME||val.ATTDESC;this._aOut.preview_img.small='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,aResult.EVN_ID,encodeURIComponent(aid)].join('/'),'resize':1,'width':1024,'height':1024,'crop':'50%','editcounter':aResult.EVN_EDITCOUNTER,'t':val.ATTTIME});this._aOut.preview_img.url='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':[aItem.aid,aItem.fid,aResult.EVN_ID,encodeURIComponent(aid)].join('/'),'resize':1,'width':screen.width*ratio,'height':screen.height*ratio,'editcounter':aResult.EVN_EDITCOUNTER});this._aOut.conversion=false;try{var eImg=this._getAnchor('previewimg').querySelector('img');if(eImg){eImg.src=this._aOut.preview_img.small;}
else{var me=this;this._getAnchor('previewimg').appendChild(mkElement('img',{src:this._aOut.preview_img.small,onload:function(){me.__imagew&&me.__imagew(this,true)},onerror:function(){me.__imagew&&me.__imagew(this,false)}}));}
removecss(this._getAnchor('imgpreview'),'max');this._getAnchor('convert').style.display='none';}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}}}}
if(this._aOut.conversion){if(this.__reload_timer)
clearTimeout(this.__reload_timer);this.__reload_timer=setTimeout(function(){if(!this._destructed)
this.__reload_image();}.bind(this),5000);}}.bind(this)]);};

/* client/inc/obj_itemview_notify.js */
_me=obj_itemview_notify.prototype;function obj_itemview_notify(){};_me.__constructor=function(){if(gui.socket){this._add_destructor('__notify_off');this._notification(true);}};_me._notification=function(b){if(gui.socket)
if(b)
gui.socket.api._obeyEvent('onnotify',[this,'__notify']);else
this.__socket_off();};_me.__notify=function(aData){if(this._destructed)
return false;if((aData.owner&&aData.owner==this._pathName)||!this.__activeItemID)
return;var current_folder_data=dataSet.get("folders",[this.__activeItemID[0],this.__activeItemID[1]]);if(current_folder_data&&current_folder_data.RELATIVE_PATH===Path.slash(aData.FOLDER)&&aData.ITEM===WMItems.__serverID(this.__activeItemID[2])){if(this._onnotify)
this._onnotify(aData);this.__exeEvent('onnotify',null,{"data":aData,"owner":this});}};_me.__notify_off=function(){if(gui.socket)
gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);};

/* client/inc/obj_label.js */
_me=obj_label.prototype;function obj_label(){};_me.__constructor=function(bLink){this._escape=false;if(bLink)
this.__eIN=mkElement('a',{name:this._pathName+'#main',id:this._pathName+'#main',href:''});else
this.__eIN=mkElement('label',{name:this._pathName+'#main',id:this._pathName+'#main'});this._main.appendChild(this.__eIN);this.__eIN.className=this._type;var me=this;this._main.onclick=function(e){e=e||window.event;if(!me._disabled||!me._disabled()){if(me._onclick)return me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});}};};_me._value=function(v){if(typeof v!='undefined'){if(this._escape)
this.__eIN.innerHTML=v.toString().escapeHTML();else
this.__eIN.innerHTML=v;if(this._onchange)this._onchange();this.__exeEvent('onchange',null,{"owner":this});}
else
return this.__eIN.innerHTML;};_me._title=function(v){if(Is.Defined(v))
this.__eIN.title=v;else
return this.__eIN.title;};_me.__update=function(sDataSet){if(!this._listener)
this._listener=sDataSet;else
if(sDataSet&&this._listener!=sDataSet)return;this._value(dataSet.get(this._listener,this._listenerPath));};_me._bind=function(sElmName){this.__eIN.setAttribute("for",sElmName);};

/* client/inc/obj_label_mail.js */
_me=obj_label_mail.prototype;function obj_label_mail(){};_me._onclick=function(e){var v=this._value();if(v&&(v=MailAddress.createEmail('',v)))
NewMessage.compose({to:v});};

/* client/inc/obj_label_phone.js */
_me=obj_label_phone.prototype;function obj_label_phone(){};_me.__constructor=function(){this.__showSMS=false;};_me._onclick=function(e){var v=this._value(),aMenu=[];if(v&&(!this.__cmenu||this.__cmenu._destructed)){if(this.__showSMS&&sPrimaryAccountSMS&&(GWOthers.getItem('RESTRICTIONS','disable_sms')||0)<1){aMenu.push({title:'MAIN_MENU::SMS','arg':[function(){NewMessage.compose({sms:v});}]});}
if(sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1){aMenu.push({title:'MAIN_MENU::DIAL','arg':[function(){gui.frm_main._call(v);}]});}
if(aMenu.length){var pos=getSize(this._main);this.__cmenu=gui._create('cmenu','obj_context'),this.__cmenu._fill(aMenu);this.__cmenu._place(pos.x+pos.w/2,pos.y,'',3);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}}};_me._sms=function(b){this.__showSMS=b?true:false;};

/* client/inc/obj_labeled_input.js */
_me=obj_labeled_input.prototype;function obj_labeled_input(){};_me.__constructor=function(sTitle){if(Is.Defined(sTitle))
this.label._value(sTitle);};_me._value=function(v){return this.input._value(v);};_me._disabled=function(b)
{this.input._disabled(b);};

/* client/inc/obj_labeled_select.js */
_me=obj_labeled_select.prototype;function obj_labeled_select(){};_me.__constructor=function(sTitle){if(Is.Defined(sTitle))
this.label._value(sTitle);};_me._value=function(v){return this.select._value(v);};_me._disabled=function(b){this.select._disabled(b);};_me._getFocusElement=function(){return this.select._getFocusElement();};_me._focus=function(b){return this.select._focus(b);};

/* client/inc/obj_link.js */
function obj_link(){};obj_link.prototype={__constructor:function(sEmails,bFull){this._fill(sEmails,bFull);this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'){if(elm.rel){var aMail=MailAddress.splitEmailsAndNames(elm.rel);if(aMail&&aMail[0]){addcss(elm,'selected');var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',aMail[0].name,aMail[0].email);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);cmenu.__remove_class=function(){elm&&removecss(elm,'selected');};cmenu._add_destructor('__remove_class');}
if(e.preventDefault)e.preventDefault();e.cancelBubble=true;return false;}}};this._main.oncontextmenu=function(e){var e=e||window.event;this.onclick(e);};if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1)
dataSet.obey(this,'_listener_data','xmpp',true);},_fill:function(sEmails,bFull){if(sEmails){var out=gui._rtl?'<bdi>':'',stat,emails=MailAddress.splitEmailsAndNames(sEmails.unescapeXML()),bIM=gui.frm_main&&gui.frm_main.im&&gui.frm_main.im._is_active();for(var i in emails)
out+='<a class="address'+(bIM&&(stat=gui.frm_main.im._inRoster(emails[i].email))?' im_'+stat.escapeXML(true):'')+(emails[i].email==sPrimaryAccount?' primary':'')+'" rel="'+MailAddress.createEmail(emails[i].name,emails[i].email).escapeXML(true)+'" title="'+getLang('ITEMVIEW::MESSAGE_TO',[emails[i].email.escapeXML(true)])+'">'+(bFull?MailAddress.createEmail(emails[i].name,emails[i].email,true):(emails[i].name||emails[i].email)).escapeXML()+'</a> ';this._main.innerHTML=gui._rtl?out+'</bdi>':out;}},__update:function(sName,aPath){if(sName=='xmpp'){var tmp,links=this._main.getElementsByTagName('A');if(aPath&&aPath[0]=='roster'&&aPath[1]&&aPath[2]=='show'){for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&(tmp=MailAddress.splitEmailsAndNames(links[i].rel))&&(tmp=tmp[0]))
if(tmp.email.toLowerCase()==aPath[1])
links[i].className='address im_'+gui.frm_main.im._inRoster(aPath[1])+(hascss(links[i],'primary')?' primary':'');}
else
if(!gui.frm_main.im._is_active())
for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&hascss(links[i],'address'))
links[i].className='address'+(hascss(links[i],'primary')?' primary':'');}}};

/* client/inc/obj_list.js */
_me=obj_list.prototype;function obj_list(){};_me.__constructor=function(){this.__idTable={};this.__value={};this.__multi=true;this.__disabled=false;setSelectNone(this._main);var me=this;this._main.oncontextmenu=function(e){if(me.__disabled)return false;var e=e||window.event;var elm=e.target||e.srcElement;if(elm==this)return;if(elm.parentNode.tagName=='LI')
elm=elm.parentNode;var id=elm.getAttribute('id').substr(me._pathName.length);me._selected(id);if(me._oncontext)
me._oncontext(e,id,me.__idTable[id]);return false;};this._main.onclick=function(e){if(me.__disabled)return false;var e=e||window.event;var elm=e.target||e.srcElement;if(elm==this)return;if(elm.tagName!='B'){if(elm.parentNode.tagName=='LI')
elm=elm.parentNode;var id=elm.getAttribute('id').substr(me._pathName.length);if(hascss(elm,'active')&&(e.target||e.srcElement)&&(e.target||e.srcElement).nodeName=='EM'&&(!e.x&&e.explicitOriginalTarget&&e.explicitOriginalTarget.nodeType==1&&e.layerX&&e.layerX<20||e.offsetX&&e.offsetX>108)&&me._oncontext)
me._oncontext(e,id,me.__idTable[id]);var etmp;if(me.__multi&&e.ctrlKey){if(typeof me.__value[id]=='undefined'){me.__value[id]=elm.getAttribute('id');addcss(elm,'active');}
else{delete me.__value[id];removecss(elm,'active');}}
else{for(var j in me.__value){if(j!=id){if((etmp=document.getElementById(me.__value[j])))
removecss(etmp,'active');delete me.__value[j];}}
me.__value[id]=elm.getAttribute('id');addcss(elm,'active');}}
if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;if(me._onclick)me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});};this._main.ondblclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName!='DIV'||elm==this)return;var id=elm.getAttribute('id').substr(me._pathName.length);if(me._ondblclick)me._ondblclick(e,id,me.__value[id]);me.__exeEvent('ondblclick',e,{"owner":me,"src":id,"value":me.__value[id]});};};_me._deselectall=function(){var ul=this._main.getElementsByTagName('LI');for(var i=ul.length;i;)
removecss(ul[--i],'active');this.__value={};}
_me._emptylabel=function(sText){if(sText==undefined)
return this.__emptytext;else
this.__emptytext=sText;}
_me._multiple=function(b){if(typeof b=='undefined')return this.__multi;b=b?true:false;if(!b&&!Is.Empty(this.__value)){var etmp,first=true;for(var i in this.__value){if((etmp=document.getElementById(this.__value[i]))){if(first){first=false;continue;}
removecss(etmp,'active');delete this.__value[i];}}}
this.__multi=b;};_me._selected=function(v){if(typeof v=='undefined'){var out=[];for(var i in this.__value){out.push(i);if(!this.__multi)break;}
return out;}
else{if(!Is.Object(v))v=[v];var etmp,id;for(var i in this.__value)
if((etmp=document.getElementById(this._pathName+"#"+i)))removecss(etmp,'active');this.__value=[];for(var i in v){if(typeof this.__idTable[v[i]]=='undefined')continue;id=this._pathName+"#"+v[i];this.__value[v[i]]=id;if((etmp=document.getElementById(id)))addcss(etmp,'active');}}}
_me._value=function(v){return this._selected(v);};_me._fill=function(oData){var tmp,id,text;this._main.innerHTML='';this.__idTable={};var ul=mkElement('ul');for(var i in oData){if(oData[i].html)
text=oData[i].html;else
text=(typeof oData[i]=='string'?oData[i]:oData[i].text).escapeXML();id=this._pathName+'#'+i;tmp=mkElement('li');tmp.setAttribute('id',id);if(oData[i].tooltip){if(gui.tooltip)
gui.tooltip._add(tmp,oData[i].tooltip);else
tmp.title=oData[i].tooltip;}
if(oData[i].css)
tmp.className=oData[i].css;tmp.innerHTML=text;this.__idTable[i]=oData[i];ul.appendChild(tmp);}
if(ul.hasChildNodes())
this._main.appendChild(ul);else
if(this.__emptytext){tmp=mkElement('h3',{className:'empty'});tmp.innerHTML=this.__emptytext.escapeXML();this._main.appendChild(tmp);}
var value=this._selected();if(value)this._selected(value);};_me._disabled=function(b){this.__disabled=(b?true:false);if(this.__disabled)
addcss(this._main,'disabled');else
removecss(this._main,'disabled');};_me.__update=function(sDataSet){if(!sDataSet)return;if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));else
if(this._listener_data==sDataSet)
this._fill(dataSet.get(this._listener_data,this._listenerPath_data));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};

/* client/inc/obj_list_conference.js */
_me=obj_list_conference.prototype;function obj_list_conference(){};_me.__constructor=function(){this.__options.search='';this.__options.sort=['EVNSTARTDATE','EVNSTARTTIME'];this.__options.order='asc';this.__options.notify=['E','O','J'];};_me._placeholder=function(v){var elm=this._getAnchor('placeholder');if(v&&elm)elm.innerHTML=(Array.isArray(v)?v:[v]).join('<br />');};_me.__notify=function(aData){if(this._destructed)
return false;if(aData.owner&&aData.owner==this._pathName)
return;if(this.__aRequestData.folder){aData['ITEM-TYPE']=aData['ITEM-TYPE']||'-';if((aData.FOLDER==Mapping.getDefaultFolderForGWType('E')||aData.FOLDER==Mapping.getDefaultFolderForGWType('J')||aData.FOLDER==this.__aRequestData.folder.fid)&&~inArray(this.__options.notify,aData['ITEM-TYPE'])){if(this._onnotify)
this._onnotify(aData);this.__exeEvent('onnotify',null,{"data":aData,"owner":this});}}};_me._onnotify=function(aData){var iid=WMItems.__clientID(aData.ITEM);switch(aData.ACTION){case'add':if(!this.__aData[iid])
this.__check_count();break;case'delete':if(this.__aData[iid]){this._remove(this.__aData[iid].obj);}
else
if(Object.keys(this.__aData).some(function(id){return id.indexOf(iid+'|')===0})){this.__check_count();}
break;case'update':case'edit':var found;for(var i in this.__aData){if(i.indexOf(iid)===0){found=true;var obj=((this.__aData[i]||{}).obj||{});(obj.__update||function(){}).call(obj,true);}}
if(!found){this.__check_count(-1);}}};_me._request=function(bUpdate){if(this.__aRequestData.folder){this.__loading=1;var aFilter={sort:this.__options.sort.map(function(sort){return sort+' '+this.__options.order;},this).join(', '),limit:this.__options.preload,search:this.__options.search,meeting:1};if(this.__aRequestData.offset)
aFilter.offset=this.__aRequestData.offset;else
this.__sep=null;if(this.__aRequestData.filter&&this.__aRequestData.filter.search)
aFilter.search+=' and ('+this.__aRequestData.filter.search+')';var aItemsInfo={aid:this.__aRequestData.folder.aid,fid:this.__aRequestData.folder.fid,values:['EVN_ID','EVNTITLE','EVNSTARTDATE','EVNSTARTTIME','EVNENDDATE','EVNENDTIME','OSD','EVNCLASS','EVNMEETINGID','EVNORGANIZER','EVNRCR_ID'],filter:aFilter};if(bUpdate){if(!this._refresh()){var me=this;WMItems.list(aItemsInfo,'','','',[function(aData){var aData=aData[me.__aRequestData.folder.aid];if((aData=aData[me.__aRequestData.folder.fid])){me.__check_count(parseInt(aData['/']),true);}}]);}}
else
WMItems.list(aItemsInfo,'','','',[this,'_response']);}};_me._response=function(aData,bUpdate,bSkipTime){if(this.__bSearch){this.__bSearch=false;}
if((aData=aData[this.__aRequestData.folder.aid])&&(aData=aData[this.__aRequestData.folder.fid])){if(!parseInt(aData['/'])){this._placeholder(this.__options.order==='asc'?['<b> '+getLang('CONFERENCE::UPCOMING_NO_ITEMS')+'</b>',getLang('CONFERENCE::UPCOMING_NO_ITEMS_HELPER')]:['<b> '+getLang('CONFERENCE::HISTORY_NO_ITEMS')+'</b>']);}
if(!this.__check_count(parseInt(aData['/']))){return;}
this.__aRequestData.count=aData['/'];delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];var c=0,row,now=new IcewarpDate();now={date:now.format(IcewarpDate.JULIAN),time:now.format(IcewarpDate.JULIAN_TIME)};for(var iid in aData){c++;if(this.__aData[iid])continue;row=false;switch(aData[iid].EVNCLASS){case'J':case'O':case'E':if(this.__options.order=='asc'&&aData[iid].EVNENDDATE==now.date&&aData[iid].EVNENDTIME<now.time)
continue;if(this.__sep!=aData[iid].EVNSTARTDATE){this.__sep=aData[iid].EVNSTARTDATE;this._separator('<span>'+this.__separatorValue(this.__sep)+'</span>');}
row=this._row('','',iid);aData[iid].iid=iid;this.__aData[iid]={data:aData[iid]};this.__aData[iid].anchor=row.anchor;this.__aData[iid].obj=this._create('item','obj_list_conference_item',row.anchor,'',aData[iid]);break;}}
if(Is.Empty(this.__aData))
addcss(this._main,'noitems');if(!bSkipTime){if(c==this.__options.preload)
this.__loading=0;else
this.__loading=2;this.__aRequestData.offset+=c;}}
else
if(!aData){this._clear(true);return;}
if(!bUpdate||this.__aRequestData.fetchnew)
this._fetch();};_me.__separatorValue=function(iJul){return CalendarFormatting.normalWithWeekDay(IcewarpDate.julian(iJul));};_me._remove=function(obj,iTime){if(this.__aData[obj.__aData.iid]){setTimeout(function(){this.__aRequestData.count=-1;this._serverSort();}.bind(this),iTime||0);}};

/* client/inc/obj_list_conference_item.js */
_me=obj_list_conference_item.prototype;function obj_list_conference_item(){};_me.__constructor=function(aData){this.__aData=aData;this.__aData.start=IcewarpDate.julian(aData.EVNSTARTDATE,Math.max(aData.EVNSTARTTIME,0));this.__aData.end=IcewarpDate.julian(aData.EVNENDDATE,Math.max(aData.EVNENDTIME,0));var out=clone(aData,true),org=(out.EVNORGANIZER?MailAddress.splitEmailsAndNames(out.EVNORGANIZER):[{name:out.EVNOWNERNAME,email:out.EVNOWNEREMAIL}])[0];out.date=this.__info();out.avatar='<span style="background-image: url(\''+getAvatarURL(org.email||'blank')+'\')"></span>';out.modified_name=org.name||org.email;out.EVNTITLE=out.EVNTITLE||getLang('EVENT_VIEW::NOTITLE');this._draw('obj_list_conference_item','main',{item:out});this._add_destructor('__destructTimers');this._main.ondblclick=function(){if(this.__aData.EVNCLASS==='J'){this._getAnchor('btn_copy').onclick();}else{Item.openwindow([sPrimaryAccount,this.__aData.EVNFOLDER,WMItems.__clientID(this.__aData.EVN_ID)],null,this.__aData,void 0,[function(bOk,aData){if(bOk&&gui.socket){var f=dataSet.get('folders',[sPrimaryAccount,Mapping.getDefaultFolderForGWType('E')]);f&&gui.socket.api._notify({ACTION:'edit',TYPE:'item',ITEM:aData.id,FOLDER:f.RELATIVE_PATH,'FOLDER-TYPE':f.TYPE,EMAIL:sPrimaryAccount,'ITEM-TYPE':'E'});}}]);}}.bind(this);if(this.__aData.EVNCLASS!=='J'){this._main.oncontextmenu=function(e){gui._create("cmenu","obj_context",'','',this);var aMenu=[{title:'POPUP_ITEMS::EDIT',arg:[function(){this._main.ondblclick();}.bind(this)]},{title:'POPUP_ITEMS::DELETE',arg:[Item.remove,[[sPrimaryAccount,this.__aData.EVNFOLDER,[WMItems.__clientID(this.__aData.EVN_ID)]],false,null,'','',[function(bOK){if(bOK)
this._parent._fire(WMItems.__clientID(this.__aData.EVN_ID),'delete');}.bind(this)]]]},];gui.cmenu._fill(aMenu);gui.cmenu._place(e.clientX,e.clientY);e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();}.bind(this);this.__badge();}
this._getAnchor('btn_copy').onclick=function(){var id=aData.iid;var date;if(Is.Defined(aData.EVNRCR_ID)&&Is.Defined(aData.EVNSTARTDATE)){date=aData.EVNSTARTDATE;id=id.split('|')[0];}
WMItems.list({aid:aData.aid,fid:aData.fid,iid:id,date:date},null,null,null,[function(aResponse){storage.library('wm_conference');wm_conference.get(aData.EVNMEETINGID,aResponse[aData.aid][aData.fid][WMItems.__clientID(aData.EVN_ID)]).join();}]);}.bind(this);};_me.__badge=function(){var t=new IcewarpDate();if((this.__aData.start.isToday()&&this.__aData.start.isAfter(t))||this.__aData.start.isTomorrow()){if(t.unix()+3600>=this.__aData.start.unix()){var elm=this._getAnchor('badge');var fce=function(){var t=new IcewarpDate();var sec=Math.max(this.__aData.start.unix()-t.unix(),0);if(sec){elm.textContent=getLang('CONFERENCE::MIN_TO_GO',[Math.ceil(sec/60)]);addcss(elm,'show');}
else{clearInterval(this.__badgeInterval);removecss(elm,'show');this.__badge();}}.bind(this);this.__badgeInterval&&clearInterval(this.__badgeInterval);this.__badgeInterval=setInterval(fce,10000);fce();}
else{this.__badgeTimer&&clearTimeout(this.__badgeTimer);this.__badgeTimer=setTimeout(function(){this.__badge();}.bind(this),(this.__aData.start.unix()-t.unix()+5)*1000);}}
else
if(this.__aData.end.isSameOrAfter(t)&&this.__aData.start.isSameOrBefore(t)){var t=new IcewarpDate(),elm=this._getAnchor('badge');elm.textContent=getLang('TASK::IN_PROGRESS');addcss(elm,'show');addcss(elm,'in_progress');this.__badgeTimer&&clearTimeout(this.__badgeTimer);this.__badgeTimer=setTimeout(function(){this.__badge();}.bind(this),(this.__aData.end.unix()-t.unix()+5)*1000);}
else{removecss(this._getAnchor('badge'),'show');if(this._parent.__options.order=='asc'&&this.__aData.end.isBefore(t)){this._parent._remove(this,2000);}}};_me.__info=function(){var aOrg=MailAddress.splitEmailsAndNames(this.__aData.EVNORGANIZER||''),sName=(aOrg[0]?(aOrg[0].name||aOrg[0].email):'')||dataSet.get('main',['fullname'])||sPrimaryAccount,sDate='';if(this.__aData.EVNSTARTTIME<0){if(this.__aData.EVNSTARTDATE<this.__aData.EVNENDDATE-1){sDate=this.__aData.start.format('L')+' - '+this.__aData.end.format('L');}
else{sDate=CalendarFormatting.normalWithWeekDay(this.__aData.start);}}
else{sDate=CalendarFormatting.normalWithWeekDayAndTime(this.__aData.start);if(this.__aData.EVNSTARTDATE<this.__aData.EVNENDDATE){sDate+=' - '+CalendarFormatting.normalWithWeekDayAndTime(this.__aData.end);}
else{sDate+=' - '+this.__aData.end.format('LT');}}
return getLang('CONFERENCE::CONFERENCE_INFO',[sDate,sName]);};_me.__destructTimers=function(){this.__badgeInterval&&clearInterval(this.__badgeInterval);this.__badgeTimer&&clearTimeout(this.__badgeTimer);};_me.__update=function(){var date,id=this.__aData.iid;if(~id.indexOf('|')){id=this.__aData.iid.split('|');date=id[1];id=id[0];}
var aItemsInfo={aid:this.__aData.aid,fid:this.__aData.fid,iid:id,date:date,values:['EVN_ID','EVNTITLE','EVNCLASS','EVNTICKET','EVN_MODIFIED','EVNTHUMBNAILID','EVNTHUMBNAILTIME','EVNPROCESSINGQUEUED','EVNCOMPLETE','EVNLOCKOWN_EMAIL','EVNLOCKOWN_ID','EVNFLAGS','EVNSTARTDATE','EVNSTARTTIME','EVNENDDATE','EVNENDTIME','OSD']};WMItems.list(aItemsInfo,'','','',[function(aData){if(aData&&(aData=aData[this.__aData.aid])&&(aData=aData[this.__aData.fid])&&(aData=aData[id])){for(var k in aData)
this.__aData[k]=aData[k];this.__constructor(this.__aData);}}.bind(this)]);};

/* client/inc/obj_list_load.js */
_me=obj_list_load.prototype;function obj_list_load(){};_me.__constructor=function(){this.__separators=[];this.__separator;this.__aRequestData={counter:0};this.__loading=2;this.__refresh=false;this.__norefresh=false;this.__aData={};this.__idTable={};var me=this;this.__body=this._getAnchor('main');this.__w=this._main.offsetWidth;this.__h=this._main.offsetHeight;this.__sep1={};this.__sep2={};this._getAnchor('refresh').onclick=function(){if(me._onrefresh&&me._refresh())
me._onrefresh();};this.__body.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me._onclick)
me._onclick(e,elm);me.__exeEvent('onclick',e,{"elm":elm,"owner":me});};this.__body.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement,b=true;if(me._oncontext)
b=me._oncontext(e,elm);me.__exeEvent('oncontext',e,{"elm":elm,"owner":me});return b;};this.__body.onscroll=function(e){if(me._destructed)return;if(me.__body.scrollHeight-me.__body.scrollTop<me.__body.clientHeight*1.2){if(!me.__loading)
me._fetch();}
var top=me.__body.scrollTop;if(top<10&&me._refresh()&&me._onrefresh)
me._onrefresh();for(var elm1,elm2,i=me.__separators.length-1;i>=0;i--)
if(top<me.__separators[i].offsetTop)
elm2=me.__separators[i];else{elm1=me.__separators[i];break;}
if(me.__separator!==elm1){if(me.__anim&&me.__anim.parentNode)
me.__anim.parentNode.removeChild(me.__anim);if(elm1){me.__separator=elm1;me.__anim=elm1.cloneNode(true);me.__anim.style.position='absolute';me._main.appendChild(me.__anim);}
else{delete me.__anim;delete me.__separator;}}
if(me.__anim)
if(elm2&&top+me.__anim.offsetHeight>elm2.offsetTop){me.__anim.style.top=(elm2.offsetTop-top-me.__anim.offsetHeight)+'px';}
else
me.__anim.style.top=0;if(me._onscroll)me._onscroll();me.__exeEvent('onscroll',e,{"owner":me});};var t,eFrame=mkElement('iframe',{frameborder:0,name:this._pathName+"#frame",marginheight:0,marginwidth:0,src:"",id:this._pathName+'#frame'});this._main.appendChild(eFrame);eFrame.contentWindow.onresize=function(e){try{if(this.__innerHeight!=this.innerHeight||this.__innerWidth!=this.innerWidth){this.__innerHeight=this.innerHeight;this.__innerWidth=this.innerWidth;if(Is.Defined(t))clearTimeout(t);t=setTimeout(function(){if(me&&!me._destructed){me.__body.onscroll();if(me._onresize)me._onresize(e,me._main);me.__exeEvent('onresize',e,{"elm":me._main,"owner":me});}},500);}}catch(e){}};this._scrollbar(this.__body,this._main);};_me._refresh=function(b){if(Is.Defined(b)){if(b)
addcss(this._main,'refresh');else
removecss(this._main,'refresh');this.__refresh=b;}
else
return this.__refresh||false;};_me._clear=function(bNoRequest,bNoPlaceholder){this.__loading=2;this.__w=0;this.__h=0;this.__aData={};this.__aDataLink={};this.__idTable={};if(this.__refresh)
removecss(this._main,'refresh');removecss(this._main,'loading');this._mask(false);this.__refresh=false;this.__norefresh=false;this.__separators=[];this.__sep1={};this.__sep2={};if(this.__anim&&this.__anim.parentNode){this.__anim.parentNode.removeChild(this.__anim);delete this.__anim;}
if(this.__anim_last&&this.__anim_last.parentNode){this.__anim_last.parentNode.removeChild(this.__anim_last);delete this.__anim_last;}
delete this.__separator;if(!bNoRequest)
this.__aRequestData={};this.__aRequestData.counter=0;this.__aRequestData.uniq=unique_id()*1;this._clean();[].slice.call(this.__body.childNodes).reverse().forEach(function(elm){elm.parentNode.removeChild(elm);});};_me._fetch=function(){if(this.__loading==0){var hmax=Math.min(this.__body.clientHeight||1,window.screen.height)*1.2,elm,n=this.__body.childNodes;if(!n.length||!(elm=n[n.length-1]))
elm={offsetTop:0,offsetHeight:0};if(this._request&&elm.offsetTop+elm.offsetHeight<hmax+this.__body.scrollTop){this._request();return true;}}
return false;};_me._row=function(sHTML,sCSS,sRel){var anchor=this.__aRequestData.counter++,elm=mkElement('section',{id:this._pathName+'#'+anchor,innerHTML:sHTML||'',className:'item'+(sCSS?' '+sCSS:'')});if(sRel)
elm.setAttribute('rel',sRel);this.__body.appendChild(elm);return{anchor:anchor,elm:elm};};_me._separator=function(sHTML,sCSS){var anchor=this.__aRequestData.counter++;anchor=this._pathName+'#'+anchor;var elm=mkElement('div',{id:anchor,innerHTML:sHTML||'',className:'separator'+(sCSS?' '+sCSS:'')});this.__body.appendChild(elm);this.__separators.push(elm);return{anchor:anchor,elm:elm};};_me._remove=function(iAnchor,sData_id,bFire){this._clean(iAnchor);var elm=this._getAnchor(iAnchor);if(elm){if(elm.nextSibling&&hascss(elm.nextSibling,'group'))
this._ungroupNode(elm,elm.nextSibling);if(elm.previousSibling&&hascss(elm.previousSibling,'separator')&&(!elm.nextSibling||hascss(elm.nextSibling,'separator'))){var tmp=elm.previousSibling,p=inArray(this.__separators,tmp);if(p>-1){this.__separators.splice(p,1);tmp.parentNode.removeChild(tmp);this.__body.onscroll();}
if(this.__sep1&&this.__sep1.row&&this.__sep1.row.elm===elm)
delete this.__sep1.row;}
if(this.__sep2&&this.__sep2.row&&this.__sep2.row.elm===elm)
delete this.__sep2.row;elm.parentNode.removeChild(elm);if(!this.__body.childElementCount)
addcss(this._main,'noitems');}
if(this._onremove)
this._onremove(iAnchor,sData_id,bFire);this._fetch();};_me._ungroupNode=function(prev,elm){removecss(elm,'group');};_me._placeholder=function(v){var elm=this._getAnchor('placeholder');if(elm)
elm.innerHTML=getLang(v);};_me._mask=function(b){if(b)
addcss(this._main,'mask');else
removecss(this._main,'mask');};

/* client/inc/obj_list_load_im.js */
_me=obj_list_load_im.prototype;function obj_list_load_im(){};_me.__constructor=function(){storage.library('obj_highlight');this.__options={autoscroll:true};this._row2=obj_list_load.prototype._row.bind(this);this.__aRequestData.fetchnew=false;this._getAnchor('loading').innerHTML=getLang('CHAT::LOADING');this._onclick=function(e){var elm=e.target;if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();NewMessage.compose({to:elm.pathname});return false;}};this._oncontext=function(e){var elm=e.target;if(elm.tagName=='A'&&elm.protocol==='mailto:'){e.preventDefault();e.stopPropagation();var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','','',elm.pathname);cmenu._place(pos.x+pos.w,pos.y+(pos.h/2));return false;}};};_me._fill=function(aData,bSkipTodayLabel,bTop){if(aData&&aData.length){this.__loading=1;this._response(aData,!bTop,!bTop);}};_me._response=function(aData,bUpdate,bScroll,bSkipTime){var bScrollDown=false,scroll=false;if(bScroll){var elm,n=this.__body.childNodes;if(n.length&&(elm=n[n.length-1])){if(elm.offsetTop<this.__body.scrollTop+this.__body.clientHeight)
bScrollDown=true;else
if(this.__body.scrollTop+this.__body.scrollHeight==this.__body.clientHeight)
bScrollDown=true;}
else
bScrollDown=true;}
else
if(!bUpdate)
scroll=[this.__body.scrollTop,this.__body.scrollHeight];var last,date;for(var iid in aData){this.__aData[iid]={data:aData[iid]};date=IcewarpDate.unix(aData[iid].date);var sep=CalendarFormatting.normal(date),bToday=date.isToday();if(bUpdate){if(this.__sep2.sep!=sep){this.__sep2={sep:sep,today:bToday};obj_list_load.prototype._separator.call(this,'<span>'+this.__sep2.sep+'</span>',this.__sep2.today?'today':'');}}
else
if(this.__sep1.sep!=sep){if(this.__sep1.sep)
this._separator('<span>'+this.__sep1.sep+'</span>',this.__sep1.today?'today':'',false,true);this.__sep1={sep:sep,today:bToday};if(!this.__sep2.sep)
this.__sep2={sep:sep,today:bToday};}
var row=false,bGroup=false;if(bUpdate){row=this._row2('',bToday?'today':'',iid);if(this.__sep2.row&&this.__sep2.row.group&&this.__sep2.row.email==aData[iid].from&&['system','notice'].indexOf(aData[iid].type)<0&&this.__sep2.row.time>date.unix()-300)
addcss(row.elm,'group');}
else{row=this._row('',bToday?'today':'',iid);if(this.__sep1.row&&this.__sep1.row.group&&this.__sep1.row.email==aData[iid].from&&this.__sep1.row.time<date.unix()+300)
addcss(this.__sep1.row.elm,'group');}
if(row){try{switch(aData[iid].type){case'system':var tmp={time:date.format('LT'),fulltime:date.format('L LT'),body:this.__encode_body(aData[iid].body)};row.elm.innerHTML=template.tmp('obj_list_load_im_system',tmp);break;case'notice':var tmp={from:this._translateUser(aData[iid].from),time:date.format('LT'),fulltime:date.format('L LT'),body:this.__encode_body(aData[iid].body)};row.elm.innerHTML=template.tmp('obj_list_load_im_notice',tmp);break;default:var tmp={me:aData[iid].reply,avatar:getAvatarURL(aData[iid].from),from:this._translateUser(aData[iid].from),time:date.format('LT'),fulltime:date.format('L LT')};if(Is.Object(aData[iid].body)){switch(aData[iid]['body'].type){case"file":this._create('item','obj_list_load_im_file',row.anchor,'',aData[iid],tmp);break;case"geoloc":var key=GWOthers.getItem('EXTERNAL_SETTINGS','google_maps_api_key')||'';if(key){tmp.addon=true;tmp.addon_body=mkElement('iframe',{frameborder:0,src:'./client/gmaps.html?obj=gui.map&scale_controll=0&'+buildURL({lat:aData[iid]['body'].geoloc.LAT[0].VALUE,lon:aData[iid]['body'].geoloc.LON[0].VALUE,key:key})}).outerHTML+'<p class="overlay"></p>';row.elm.innerHTML=template.tmp('obj_list_load_im_message',tmp);row.elm.querySelector('iframe + p.overlay').onclick=function(){this.parentNode.removeChild(this);};}else{tmp.body=this.__encode_body(getLang('IM::GEO_KEY_MISSING'))+'<br><a target="_blank" href="https://www.google.com/maps/place/'+encodeURIComponent(aData[iid]['body'].geoloc.LAT[0].VALUE+','+aData[iid]['body'].geoloc.LON[0].VALUE)+'">'+getLang('IM::OPEN_IN_GOOGLE_MAPS')+'</a>';row.elm.innerHTML=template.tmp('obj_list_load_im_message',tmp);}
break;}}
else{var m;if(~aData[iid]['body'].indexOf('/conference/')&&Is.Array(m=aData[iid]['body'].match(wm_conference.linkRegExp))){tmp.body=Smiles.replaceSmiles(aData[iid].body.escapeHTML()).replace(wm_conference.linkRegExp,'<a onclick="wm_conference.get(\''+m[2]+'_'+m[1]+'\').join(); return false;">'+m[0]+'</a>');this._create('item','obj_list_load_im_conference',row.anchor,'',aData[iid],tmp,m[2]+'_'+m[1]);}
else{tmp.body=obj_highlight._highlight(this.__encode_body(aData[iid].body));row.elm.innerHTML=template.tmp('obj_list_load_im_message',tmp);bGroup=true;}}}}
catch(r){if(this.__aData[iid]&&(!this.__aData[iid].obj||!this.__aData[iid].obj._destructed))
throw r;return;}
this.__aData[iid].anchor=row.anchor;if(bUpdate)
this.__sep2.row={elm:row.elm,email:aData[iid].from,time:date.unix(),group:bGroup};else{this.__sep1.row={elm:row.elm,email:aData[iid].from,time:date.unix(),group:bGroup};if(!this.__sep2.row)
this.__sep2.row=clone(this.__sep1.row);}
last=row;}
if(this.__options.autoscroll){if(bScrollDown)
this._scroll(0);else
if(scroll)
this.__body.scrollTop=scroll[0]+this.__body.scrollHeight-scroll[1];}}
if(!bUpdate){if(this.__anim_last&&this.__anim_last.parentNode)
this.__anim_last.parentNode.removeChild(this.__anim_last);if(this.__sep1.sep){this.__anim_last=this._separator('<span>'+this.__sep1.sep+'</span>',this.__sep1.today?'today':'',true).elm;addcss(this.__anim_last,'last');this._main.appendChild(this.__anim_last);}}
if(this.__sep1.sep&&!this.__anim&&last&&this.__sep1.elm!==last.elm){this.__anim=this._separator('<span>'+this.__sep1.sep+'</span>',this.__sep1.today?'today':'',true).elm;this._main.appendChild(this.__anim);}
if(this.__body.style.visibility=='hidden')
this.__body.style.visibility='visible';if(!bSkipTime)
this.__loading=0;this._fetch();};_me._system=function(sStatus){var aData=[{body:sStatus,date:new IcewarpDate(),type:'system'}];this._response(aData,true,true,true);};_me._notice=function(sFrom,sBody){var aData=[{from:sFrom,body:sBody,date:(new IcewarpDate()).unix(),type:'notice'}];this._response(aData,true,true,true);};_me._add=function(sFrom,sTo,sBody,bReply,date){var aData=[{from:sTo||sFrom,body:sBody,reply:bReply,date:date}];this._response(aData,true,true,true);};_me._translateUser=function(sUser){if(sUser==sPrimaryAccount)
return dataSet.get('main',['fullname'])||dataSet.get('main',['user']);return dataSet.get('xmpp',['roster',sUser,'name'])||sUser;};_me.__encode_body=function(sBody,bShortUrl){if(sBody){var aOut=[],aBody=sBody.split('```');if(aBody.length<3)
aBody=[sBody];aBody.forEach(function(s,i){if(i%2==0){var a=s.split('`');if(a.length>2){a.forEach(function(v,j,a){var l=aOut.length;if(j&&l%2&&(a[j]==''||(j-1&&a[j-1]=='')||typeof a[j+1]=='undefined'))
aOut[l-1].value+='`'+v;else
aOut.push({value:v,wrapper:j%2&&'`'});});return;}}
aOut.push({value:s,wrapper:i%2&&'```'});});return aOut.map(function(v,i){if(i%2==0){var hla=v.value.highlight_links_array(bShortUrl),str=GWOthers.getItem('CHAT','smiles')=='1'?Smiles.replaceSmiles(hla.string.escapeHTML()):hla.string.escapeHTML();var sOut=str.replace(new RegExp(hla.replace,'g'),function(s,id){return hla.array[id];});return sOut;}
if(v.wrapper){v.value=v.wrapper+v.value+v.wrapper;}
return v.value;}).join('');}
return'';};

/* client/inc/obj_list_load_im_conference.js */
function obj_list_load_im_conference(){};obj_list_load_im_conference.prototype.__constructor=function(aData,aTmpData,aConference){addcss(this._main,'obj_groupchat_event','obj_groupchat_conference');aTmpData.addon=true;this._draw('obj_list_load_im_message','main',aTmpData);this._draw('obj_groupchat_conference','addon');this.btn_accept._onclick=function(){storage.library('wm_conference');wm_conference.get(aConference).join();};this.btn_decline._onclick=function(){this._disabled(true);gui.frm_chat._send(getLang('CHAT::CONFERENCE_DECLINE_MSSG'));};this.btn_accept._disabled(false);this.btn_decline._disabled(false);};

/* client/inc/obj_list_load_im_file.js */
_me=obj_list_load_im_file.prototype;function obj_list_load_im_file(){};_me.__constructor=function(aData,aTmpData){var tmp=mkElement('A',{href:aData['body'].url}),sFileName=aData['body'].url,sUrl=aData['body'].url,doc=false;if(tmp.pathname){sFileName=Path.basename(tmp.pathname).urlDecode();if(tmp.pathname.indexOf('/teamchatapi/')==0||tmp.pathname.indexOf('teamchatapi/')==0)
sUrl+='&thumbnail=1&waittime=10000';}
tmp=null;aTmpData.desc=aData['body'].desc||sFileName||'';this._draw('obj_list_load_im_file','main',aTmpData);switch(Path.extension(sFileName)){default:if(Item.officeSupport(sFileName))
doc=true;case'ico':case'jpg':case'jpeg':case'gif':case'png':addcss(this._getAnchor('image').parentNode,'ico');addcss(this._getAnchor('image'),'ico_'+Path.extension(sFileName));var img=new Image();img.onload=function(){if(!this||this._destructed)
return;var bScroll=false,bSafari=false,h=this._main.offsetHeight;if(this._parent._scroll){var pos1=getSize(this._parent.__body),pos2=getSize(this._main);if((bScroll=(pos1.y+pos1.h>=pos2.y+pos2.h)))
bSafari=window.navigator&&window.navigator.browser&&window.navigator.browser.application&&window.navigator.browser.application.toLowerCase()=='safari';}
removecss(this._getAnchor('image').parentNode,'ico');removecss(this._getAnchor('image'),'ico_'+Path.extension(sFileName));if(!this.__preview){this.__preview=mkElement('img');this._getAnchor('image').appendChild(this.__preview);addcss(this._getAnchor('image'),'preview');if(doc)
addcss(this._getAnchor('image'),'doc');}
if(bScroll&&bSafari)
this.__preview.onload=function(){try{if(!this._destructed&&this._main.offsetHeight-h!=0)
this._parent._scrollBy(Math.abs(this._main.offsetHeight-h));}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}.bind(this);this.__preview.src=img.src;if(bScroll&&!bSafari&&this._main.offsetHeight-h!=0)
this._parent._scrollBy(Math.abs(this._main.offsetHeight-h));}.bind(this);img.onerror=function(){if(!this._getAnchor('image')){return;}}.bind(this);img.src=sUrl;}
this.btn_download._onclick=function(){downloadItem(aData['body'].url,true);};if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')=='1'&&(Item.officeSupport(sFileName)||Path.extension(sFileName)==='pdf')){this._create('btn_open','obj_button',{target:'btn',first:true},'color1');this.btn_open._value('POPUP_ITEMS::OPEN');this.btn_open._onclick=function(){if(Path.extension(sFileName)==='pdf'){if(currentBrowser().match(/^MSIE([6-9]|10)$/)){this.btn_download._onclick();}else{gui._create('pdf','frm_pdf')._load(aData['body'].url,sFileName);}}
else
if(Item.officeSupport(sFileName)){var parsed=parseURL(aData['body'].url)||{};Item.officeOpen(parsed.id?{iid:parsed.id,ticket:parsed.ticket}:{url:aData['body'].url,ticket:parsed.ticket},[downloadItem,[aData['body'].url,true]],Path.extension(sFileName),parsed.id||'view');}}.bind(this);}
this._getAnchor('image').onclick=function(){if(this.__preview&&Path.extension(sFileName)==='pdf'){if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')=='1'||currentBrowser().match(/^MSIE([6-9]|10)$/))
this.btn_download._onclick();else
gui._create('pdf','frm_pdf')._load(aData['body'].url,sFileName);}
else
if(Item.officeSupport(sFileName)){var parsed=parseURL(aData['body'].url)||{};Item.officeOpen(parsed.id?{iid:parsed.id,ticket:parsed.ticket}:{url:aData['body'].url,ticket:parsed.ticket},[downloadItem,[aData['body'].url,true]],Path.extension(sFileName),parsed.id||'view');}
else
if(this.__preview&&!Item.editSupport(sFileName)){var img=gui._create('imgview','frm_imgview');img._fill([{url:aData['body'].url,title:sFileName}]);img._value(0);}
else
this.btn_download._onclick();}.bind(this);};

/* client/inc/obj_list_load_item.js */
_me=obj_list_load_item.prototype;function obj_list_load_item(){};_me.__constructor=function(){this.__options={preload:30};};_me._search=function(s){if(Is.Defined(s)){var aFilter=this.__aRequestData.filter?clone(this.__aRequestData.filter,true):{};aFilter.search=s;this.__bSearch=true;this._serverSort(this.__aRequestData.folder,true,aFilter);}
else
if(this.__aRequestData.filter)
return this.__aRequestData.filter.search;else
return'';};_me._serverSort=function(aFolder,bUpdate,aFilter){if(Is.Defined(aFilter))
bUpdate=true;else
if(!aFolder||(this.__aRequestData.folder&&compareObj(this.__aRequestData.folder,aFolder,true)))
aFilter=this.__aRequestData.filter;if(this.__aRequestData.folder)
if(!bUpdate&&((!aFolder&&this.__aRequestData.folder)||compareObj(this.__aRequestData.folder,aFolder,true))){this._request(true);return;}
this._clear();this.__aRequestData.folder=aFolder;this.__aRequestData.offset=0;this.__aRequestData.filter=aFilter;this.__loading=0;if(WMFolders.getRights(this.__aRequestData.folder,'kick'))
addcss(this._main,'acc_remove');else
removecss(this._main,'acc_remove');this._fetch();};_me._onrefresh=function(){if(this.__aRequestData.folder)
this._serverSort(this.__aRequestData.folder,true);};_me.__check_count=function(count,bCheckData){if(!Is.Defined(count)||(this.__aRequestData.count&&count!=this.__aRequestData.count)){if(count===0){this._clear(true);return false;}
else{if(this.__body.scrollTop>10||this.__norefresh){this._refresh(true);return true;}
else{this._serverSort(this.__aRequestData.folder,true);return false;}}}
if(count==0||(bCheckData&&Is.Empty(this.__aData))){this._clear(true);addcss(this._main,'noitems');}
else
removecss(this._main,'noitems');return true;};_me._editItem=function(id){if(Is.Defined(id)&&this.__aData[id]&&this.__aData[id].obj&&!this.__aData[id].obj._destructed&&this.__aData[id].obj._edit)
return this.__aData[id].obj._edit(true);return false;};_me._removeItem=function(aData,elm){var me=this;WMItems.remove({aid:aData.aid,fid:aData.fid,iid:[aData.iid]},'','','',[function(bOK){if(bOK&&me.__aRequestData.folder.aid==aData.aid&&me.__aRequestData.folder.fid==aData.fid){if(elm&&elm.id){var id=elm.id.substr(elm.id.lastIndexOf('#')+1);me._remove(id,aData.iid);}}}]);};_me._onremove=function(iAnchor,sData_id){if(this.__aData&&this.__aData[sData_id])
delete this.__aData[sData_id];if(this.__aRequestData.offset)
this.__aRequestData.offset--;};

/* client/inc/obj_list_load_notify.js */
_me=obj_list_load_notify.prototype;function obj_list_load_notify(){};_me.__constructor=function(){if(this.__options)
this.__options.notify=[];else
this.__options={notify:[]};if(gui.socket){this._add_destructor('__notify_off');this._notification(true);}};_me._notification=function(b){if(gui.socket)
if(b)
gui.socket.api._obeyEvent('onnotify',[this,'__notify']);else
this.__socket_off();};_me.__notify=function(aData){if(this._destructed)
return false;if(aData.owner&&aData.owner==this._pathName)
return;if(this.__aRequestData.folder){var f=dataSet.get('folders',[this.__aRequestData.folder.aid,this.__aRequestData.folder.fid]);aData['ITEM-TYPE']=aData['ITEM-TYPE']||'-';if(aData.FOLDER&&aData.TYPE=='item'&&f.RELATIVE_PATH==Path.slash(aData.FOLDER)&&f.OWNER==aData.EMAIL&&(aData.ACTION=='reaction'||~inArray(this.__options.notify,aData['ITEM-TYPE']))){if(this._onnotify)
this._onnotify(aData);this.__exeEvent('onnotify',null,{"data":aData,"owner":this});}}};_me.__notify_off=function(){if(gui.socket)
gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);};_me._fire=function(iid,sAction,arg,bNoUpdate){if(gui.socket){var t=WMFolders.getType(this.__aRequestData.folder);if(t){var f=dataSet.get('folders',[this.__aRequestData.folder.aid,this.__aRequestData.folder.fid])||{RELATIVE_PATH:this.__aRequestData.folder.fid,TYPE:t,OWNER:sPrimaryAccount};var aOut={'ACTION':sAction,'TYPE':'item','ITEM':WMItems.__serverID(iid),'FOLDER':f.RELATIVE_PATH,'FOLDER-TYPE':t,'EMAIL':f.OWNER};if(this.__aData[iid]&&this.__aData[iid].obj)
aOut['ITEM-TYPE']=this.__aData[iid].obj.__aData.EVNCLASS;if(Is.Object(arg))
aOut=objConcat(arg||{},aOut);if(bNoUpdate)
aOut.owner=this._pathName;gui.socket.api._notify(aOut);return true;}}
return false;};

/* client/inc/obj_list_load_reverse.js */
_me=obj_list_load_reverse.prototype;function obj_list_load_reverse(){};_me.__constructor=function(){this.__newitems=0;this.__body.onscroll=function(e){if(this._destructed)return;if(this.__loading==0&&this.__body.scrollTop<this.__body.clientHeight/4)
this._fetch();else
if(this.__aRequestData.fetchnew&&this.__loading!=1&&this.__aRequestData.youngest)
this._fetch();var top=this.__body.scrollTop;if(this.__separators.length){for(var elm1,elm2,i=this.__separators.length-1;i>=0;i--)
if(top<this.__separators[i].offsetTop)
elm2=this.__separators[i];else{elm1=this.__separators[i];break;}
if(this.__separator!==elm1){if(this.__anim&&this.__anim.parentNode)
this.__anim.parentNode.removeChild(this.__anim);if(elm1){this.__separator=elm1;this.__anim=elm1.cloneNode(true);this._main.appendChild(this.__anim);}
else{delete this.__anim;delete this.__separator;}}}
if(this.__anim){if(elm2&&top+this.__anim.offsetHeight>elm2.offsetTop)
this.__anim.style.top=(elm2.offsetTop-top-this.__anim.offsetHeight)+'px';else
this.__anim.style.top=0;if(this.__anim_last)
this.__anim_last.style.top=this.__anim.style.top;}
else
if(this.__anim_last){if(elm2&&top+this.__anim_last.offsetHeight>elm2.offsetTop)
this.__anim_last.style.top=(elm2.offsetTop-top-this.__anim_last.offsetHeight)+'px';else
this.__anim_last.style.top=0;}
if(this._scroll()>50)
addcss(this._main,'refresh');else{removecss(this._main,'refresh','newitem','scrollbtn');this._getAnchor('refresh').innerHTML=getLang('COMMON::SCROLL_DN');this.__newitems=0;}
if(this._onscroll)this._onscroll();this.__exeEvent('onscroll',e,{"owner":this});}.bind(this);this._getAnchor('refresh').innerHTML=getLang('COMMON::SCROLL_DN');this._getAnchor('refresh').onclick=function(){this._scroll(0);}.bind(this);};_me._scroll=function(v){if(Is.Number(v))
this.__body.scrollTop=this.__body.scrollHeight-this.__body.clientHeight-v;else
return this.__body.scrollHeight-this.__body.clientHeight-this.__body.scrollTop;};_me._scrollBy=function(y){if(this.__body.scrollBy)
this.__body.scrollBy(0,y);else{this.__body.scrollTop=(this.__body.scrollTop+y);}};_me._row=function(sHTML,sCSS,sRel){var anchor=this.__aRequestData.counter++,elm=mkElement('section',{id:this._pathName+'#'+anchor,innerHTML:sHTML||'',className:'item'+(sCSS?' '+sCSS:'')});if(sRel)
elm.setAttribute('rel',sRel);var offset=this.__body.scrollHeight-this.__body.clientHeight-this.__body.scrollTop;if(this.__pinned){if(this.__pinned.nextSibling==null)
this.__body.appendChild(elm);else
this.__body.insertBefore(elm,this.__pinned.nextSibling);}
else
if(this.__body.firstChild)
this.__body.insertBefore(elm,this.__body.firstChild);else
this.__body.appendChild(elm);this.__body.scrollTop=(this.__body.scrollHeight-this.__body.clientHeight-offset);return{anchor:anchor,elm:elm};};_me._separator=function(sHTML,sCSS,bLoose,bCleanup){var elm=mkElement('div',{innerHTML:sHTML||'',className:'unselectable separator'+(sCSS?' '+sCSS:'')});if(bLoose)
return{elm:elm};if(bCleanup)
this.__separators=this.__separators.filter(function(separator){if(separator&&separator.innerHTML===sHTML){this.__body.removeChild(separator);return false;}
return true;},this);var anchor=this.__aRequestData.counter++,offset=this.__body.scrollHeight-this.__body.clientHeight-this.__body.scrollTop;elm.setAttribute('id',this._pathName+'#'+anchor);if(this.__body.firstChild)
this.__body.insertBefore(elm,this.__body.firstChild);else
this.__body.appendChild(elm);this.__separators.unshift(elm);this.__body.scrollTop=(this.__body.scrollHeight-this.__body.clientHeight-offset);return{anchor:anchor,elm:elm};};_me._fetch=function(uid){if(uid&&this.__aRequestData.uniq!=uid)
return;if(this.__loading==0){var hmax=Math.min(this.__body.clientHeight,window.screen.height);if(this.__body.scrollTop<hmax/4||this.__body.scrollHeight<hmax){if(this._request){this._request(uid);return true;}
return false;}}
if(this.__loading!=1&&this.__aRequestData.fetchnew){if(this.__aRequestData.youngest||this.__loading==2){if(this.__body.clientHeight===0||(this.__body.scrollTop+this.__body.clientHeight>this.__body.scrollHeight*0.75&&this._request2)){this._request2(uid);return true;}}
else{this._clear(true);this.__loading=0;}}
return false;};

/* client/inc/obj_listbox.js */
_me=obj_listbox.prototype;function obj_listbox(){};_me.__constructor=function(){this.__idTable={};this.__value={};this.__multi=true;this.__disabled=false;setSelectNone(this._main);var me=this;this._main.oncontextmenu=function(e){if(me.__disabled)return false;var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName!='DIV'||elm==this)return;var id=elm.getAttribute('id').substr(me._pathName.length+1);if(me._oncontext)
me._oncontext(e,id,me.__idTable[id]);return false;};this._main.onclick=function(e){if(me.__disabled)return false;var e=e||window.event,elm=e.target||e.srcElement,checkbox=false;if(elm==this)return;if(elm.tagName=='SPAN'){elm=elm.parentNode;checkbox=true;}
var id=elm.getAttribute('id').substr(me._pathName.length+1);if(checkbox){me._checked(id,me.__idTable[id].checked?false:true);}
else{if(me.__multi&&e.ctrlKey){var v=me._value(),p=inArray(v,id);if(p<0){v.push(id);me._value(v);}
else{v.splice(p,1);me._value(v);}}
else
me._value(id);}
if(me._onclick)me._onclick(e,id,me.__idTable[id]);me.__exeEvent('onclick',e,{"owner":me,id:id,data:me.__idTable[id]});};this._main.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='DIV'||elm==this)return;var id=elm.getAttribute('id').substr(me._pathName.length+1);if(me._ondblclick)me._ondblclick(e,id,me.__value[id]);me.__exeEvent('ondblclick',e,{"owner":me,"src":id,"value":me.__value[id]});};};_me._multiple=function(b){if(typeof b=='undefined')return this.__multi;if(!(this.__multi=b?true:false))
this._value(this._value());};_me._value=function(v,bNoUpdate){if(typeof v=='undefined'){var out=[];for(var i in this.__value){out.push(this.__value[i]);if(!this.__multi)break;}
return out;}
else{if(!Is.Object(v))v=[v];var etmp;for(var i in this.__value)
if((etmp=document.getElementById(this._pathName+'/'+this.__value[i])))
removecss(etmp,'active');this.__value=[];for(var i in v){if(typeof this.__idTable[v[i]]=='undefined')continue;this.__value.push(v[i]);if((etmp=document.getElementById(this._pathName+'/'+v[i]))){addcss(etmp,'active');etmp.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"});}
if(!this.__multi)
break;}
if(!bNoUpdate){if(this._onchange)this._onchange();this.__exeEvent('onchange',null,{"owner":this});}}};_me._checked=function(id,b){if(Is.Defined(id)&&this.__idTable[id])
if(Is.Defined(b)){var b=b?true:false;if(!this.__idTable[id].disabled&&this.__idTable[id].checked!=b){this.__idTable[id].checked=b;var elm=document.getElementById(this._pathName+'/'+id);if(elm)
window[b?'addcss':'removecss'](elm,'checked');if(this._oncheck)this._oncheck(id,this.__idTable[id]);this.__exeEvent('oncheck',null,{"owner":this,id:id,data:this.__idTable[id]});}}
else
return this.__idTable[id].checked?true:false;};_me._fill=function(aData){var elm;this._main.innerHTML='';this.__idTable={};for(var i in aData){this.__idTable[i]=aData[i];elm=mkElement('div',{id:this._pathName+'/'+i});if(Is.String(aData[i]))
elm.innerHTML=(aData[i]||'').escapeHTML();else{if(Is.Defined(aData[i].checked))
elm.appendChild(mkElement('span'));elm.appendChild(document.createTextNode(aData[i].title||''));if(aData[i].css)
addcss(elm,aData[i].css);if(aData[i].checked)
addcss(elm,'checked');if(aData[i].disabled)
addcss(elm,'disabled');}
this._main.appendChild(elm);}
this._value(this._value());};_me._disabled=function(b){this.__disabled=(b?true:false);if(this.__disabled)
addcss(this._main,'disabled');else
removecss(this._main,'disabled');};_me.__update=function(sDataSet){if(!sDataSet)return;if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));else
if(this._listener_data==sDataSet)
this._fill(dataSet.get(this._listener_data,this._listenerPath_data));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};

/* client/inc/obj_listbox_settings.js */
_me=obj_listbox_settings.prototype;function obj_listbox_settings(){};_me.__constructor=function(sTitleKey,sTitle2Key)
{this.__titleKey=sTitleKey;this.__title2Key=sTitle2Key;this.__values=[];this._create('list','obj_listbox','main',this._css);};_me._disabled=function(b){return this.list._disabled(b);};_me._add=function(aValues)
{if(this.__titleKey){var sTitle;for(var i in aValues)
if((sTitle=aValues[i][this.__titleKey]))
{var add=false;for(var j in this.__values)
if((aValues[i].uid&&this.__values[j].uid==aValues[i].uid)||(this.__values[j][this.__titleKey]==sTitle)){if(this.__values[j].uid)
aValues[i].uid=this.__values[j].uid;this.__values[j]=aValues[i];add=true;break;}
if(!add)
this.__values.push(aValues[i]);}
var tmp=this.__titleKey;function sortit(a,b){if(a[tmp]>b[tmp])
return 1;else
if(a[tmp]==b[tmp])
return 0;return-1;};this.__values=this.__values.sort(sortit);this.__fill();}};_me.__fill=function(){var aNames=[];for(var i in this.__values)
if((sTitle=this.__values[i][this.__titleKey]))
if(this.__values[i][this.__title2Key])
aNames.push(sTitle+' ('+(this._ontitle2?this._ontitle2(this.__values[i][this.__title2Key]):this.__values[i][this.__title2Key])+')');else
aNames.push(sTitle);this.list._fill(aNames);};_me._remove=function(aIndexes)
{if(this.__titleKey)
{var aValues=clone(this.__values);var sUId,k;for(var i in aIndexes)
{k=0;for(var j in aValues)
{if(aValues[j][this.__titleKey])
if(k==aIndexes[i])
{if((sUId=this.__values[j]['uid']))
this.__values[j]={'uid':sUId};else
this.__values.splice(j,1);break;}
else
k++;}}
this.__fill();}};_me._removeSelected=function()
{this._remove(this.list._value());this.list._value([]);};_me._getSelectedValue=function()
{if(this.__titleKey)
{var nIndex=this.list._value();if((nIndex=nIndex[0])){var k=0;for(var i in this.__values)
if(this.__values[i][this.__titleKey])
if(k==nIndex)
return clone(this.__values[i]);else
k++;}}};_me._value=function(aValues)
{if(Is.Defined(aValues)){this._add(aValues);}
else{return clone(this.__values);}};

/* client/inc/obj_lister.js */
_me=obj_lister.prototype;function obj_lister(){};_me.__constructor=function(){this.__range=0;this.__value=0;this.__list=100;this.__server=false;this.__selected=0;this.__bind;var me=this;var list=this._main.getElementsByTagName('a');list[0].onclick=function(e){me._value(0);};list[1].onclick=function(e){me._value(me.__value-me.__list);};list[2].onclick=function(e){me._value(me.__value+me.__list);};list[3].onclick=function(e){me._value(me.__range);};this.input._onsubmit=function(e){var v=parseInt(this._value())-1;v=v<0?0:v;me._value(v*me.__list);};this.input._onblur=this.input._onsubmit;this.input._onclose=function(e){this._value((me._value()/me.__list)+1);};};_me._bind=function(oObj){if(oObj.lister&&oObj.lister._pathName!=this._pathName)
oObj.lister._destruct();oObj.lister=this;this.__bind=oObj;};_me._list=function(v,bNoChange){if(typeof v=='undefined')return this.__list;this.__list=parseInt(v);this.__list=this.__list<1?1:this.__list;if(!bNoChange&&this._onchange){this._onchange(this.__value);this.__exeEvent('onkeyup',null,{"value":this.__value,"owner":this});}};_me._range=function(r){if(typeof r=='undefined')return this.__range;this.__range=parseInt(r);if(this.__value>this.__range-1)
this._value(this.__range);this._selected();};_me._selected=function(i){if(typeof i!='undefined')this.__selected=i;this.label._value((Math.ceil(this.__range/this.__list)||1)+'&nbsp;&nbsp;('+(this.__selected>0?this.__selected+' / ':'')+this.__range+')');};_me._value=function(v,bNoChange){if(typeof v=='undefined')return this.__value;var old=this.__value;this.__value=parseInt(v);if(isNaN(this.__value))this.__value=0;if(this.__value>this.__range-1){this.__value=Math.floor(this.__range/this.__list)*this.__list;if(this.__range&&this.__value==this.__range)
this.__value-=this.__list;}
else
this.__value=Math.floor(this.__value/this.__list)*this.__list;this.__value=this.__value<0?0:this.__value;this.input._value((this.__value/this.__list)+1);if(!bNoChange&&old!==this.__value){if(this._onchange)this._onchange(this.__value);this.__exeEvent('onkeyup',null,{"value":this.__value,"owner":this});}};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;if(sDataSet)
dataSet.obey(this,'_listener_data',sDataSet);else
dataSet.disobey(this,'_listener_data');};_me.__update=function(sName){if(!sName)return;if(this._listener_data==sName)
this._range(dataSet.get(this._listener_data,this._listenerPath_data));if(this._listener==sName)
this._value(dataSet.get(this._listener,this._listenerPath));};

/* client/inc/obj_lister_client.js */
_me=obj_lister_client.prototype;function obj_lister_client(){};_me.__bindobj=function(){var obj=window;try{this.__bind&&this.__bind.split('.').forEach(function(part){obj=obj[part];});}
catch(er){obj=null;}
return obj;};_me._bind=function(obj){if(this.__bind){try{this.__bind.__bindlist=null;this.__bind=null;}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}}
if(typeof obj=='object'&&obj._pathName)
this.__bind=obj._pathName;else
return false;obj._bindlist(this._pathName);this.__value=0;this._value(0);if(obj._aData){this.__range=obj._aData.length;if(this.__range)this._range(this.__range);}
obj=null;};

/* client/inc/obj_mail_suggest.js */
_me=obj_mail_suggest.prototype;function obj_mail_suggest(){};_me.__constructor=function(){var me=this;this.__activeFirst=true;this._min=1;this._limit=15;this._folder;this.__hints=[];this.__block=this._getAnchor('container');this._scrollbar(this.__block,this._main);if(gui.frm_main&&gui.frm_main.dnd){this.__etag.onmousedown=function(e){if(me.__dndtimer){window.clearTimeout(me.__dndtimer);delete me.__dndtimer;}
var e=e||window.event;if(e.button>1||e.ctrlKey||!me.__initdrag)return;var elm=e.target||e.srcElement;if(elm==this||elm.tagName=='INPUT')return;if(elm.tagName!='SPAN')
elm=Is.Child(elm,'SPAN');if(elm){var x=e.clientX,y=e.clientY;gui._obeyEvent('mouseup',[me,'__dndDispatch']);me.__dndtimer=setTimeout(function(){me.__initdrag(elm,x,y);},500);if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;}};this._placeholder(getLang('POPUP_ITEMS::ENTER_EMAIL_ADDRESS'));gui.frm_main.dnd.registr_drop(this,['rcp','jabber','item']);}};_me._onexpand=function(elm){if(elm){var elm=elm,v=elm.getAttribute('val'),me=this;v=v.substr(1,v.length-2);gui._create('expand','frm_confirm','','frm_alert noblur',[function(){if(elm&&v){var id=v;if(v.indexOf('::')){id=v.split('::')[0];}
if(~['I','Y'].indexOf(dataSet.get('folders',[sPrimaryAccount,id,'TYPE']))){WMItems.list({aid:sPrimaryAccount,fid:'__@@GROUP@@__/'+id},'','','',[function(response){response=((response||{})[sPrimaryAccount]||{})['__@@GROUP@@__/'+id];if(!response){return gui.notifier._value({type:'alert',args:{header:'ALERTS::NOT_FOUND',text:'CONFIRMATION::DL_NOT_FOUND'}});}
for(var i in response){if(!i.indexOf('*')){var a=me._decode(MailAddress.createEmail(response[i].FRTNAME,response[i].FRTEMAIL));for(var i in a){me._addTag(a[i],elm);elm='';}}}}]);}else{var fid='__@@ADDRESSBOOK@@__';if(v.indexOf('::')>1){var tmp=v.split('::');fid=tmp[0];v=tmp[1];}
WMItems.list({"aid":sPrimaryAccount,"fid":fid,filter:{search:'classify:"'+v.replace(/"/g,'\\"')+'"'},values:['ITMCLASS']},'','','',[function(aData){if(aData&&(aData=aData[sPrimaryAccount])&&(aData=aData[fid])){for(var iid in aData)
if(iid.charAt(0)=='*')
if(aData[iid].ITMCLASS=='L'){WMItems.list({"aid":sPrimaryAccount,"fid":fid,iid:iid},'','','',[function(aData){if(aData&&(aData=aData[sPrimaryAccount])&&(aData=aData[fid])&&(aData=aData[iid])&&(aData=aData.LOCATIONS))
for(var lid in aData)
if(aData[lid].values&&aData[lid].values.LCTEMAIL1){var a=me._decode(MailAddress.createEmail(aData[lid].values.LCTDESCRIPTION,aData[lid].values.LCTEMAIL1));for(var i in a){me._addTag(a[i],elm);elm='';}}}]);return;}}
gui.notifier._value({type:'alert',args:{header:'ALERTS::NOT_FOUND',text:'CONFIRMATION::DL_NOT_FOUND'}});}]);}}}],'ALERTS::ALERT','CONFIRMATION::EXPAND');}};_me._decode=function(v){var aIN=MailAddress.splitEmailsAndNames(v),rx=new RegExp("^([a-z0-9\\'\\!\\#\\$\\%\\&\\+\\-\\/\\=\\?\\^\\_\\`\\{\\|\\}\\~\\*][\\.]?)+",'gim');aOut=[];for(var i in aIN)
if(aIN[i].name&&aIN[i].email)
aOut.push({tag:MailAddress.createEmail(aIN[i].name,aIN[i].email),label:MailAddress.createEmail(aIN[i].name,aIN[i].email,true)});else
if(aIN[i].email){if(!Is.Email(aIN[i].email)){if(aIN[i].email.indexOf('[')===0&&aIN[i].email.indexOf(']')===aIN[i].email.length-1){aOut.push({tag:aIN[i].email,label:((aIN[i].email.match(/\[.*::(.*)\]/)||[])[1])||false,expand:true});continue;}
if(aIN[i].email.indexOf('@')<0){if(aIN[i].email.indexOf(' ')>-1){var a=v.split(' ');if(a.length>1){aOut=aOut.concat(this._decode(a.join(',')));continue;}}
else
if(rx.test(aIN[i].email)){aOut.push({tag:aIN[i].email});continue;}}
aOut.push({tag:aIN[i].email,err:1});}
else
aOut.push({tag:aIN[i].email});}
return aOut;};_me._qdata=function(v){var cart=this._getCartPos(),end=false,word=[0,0];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':if(cart<=i)
end=true;else
word=[i+1,i+1];break;default:word[1]=i+1;}
if(end)break;}
v=v.substring(word[0],word[1]);this.__last_pos=[word[0],word[1],v];return v;};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(typeof v!='undefined'){var inp=this._getFocusedInput();if(inp){var old=inp._value();this._qdata(old);inp._value(old.substr(0,this.__last_pos[0])+v+old.substr(this.__last_pos[1]));if(inp._name=='plus')
this.__inpBlur('',{owner:inp});}}};_me._query=function(v){if(v.indexOf('[')==0){var tmp=v;if(!(v=v.replace(/[\[\]]+/g,'')))
return;this.__last_qdata={email:tmp};v=v.quoteSQL();var aFilter={search:'class:L AND classify:'+v,sort:'ITMCLASSIFYAS',limit:this._limit};}
else{var aParsed=MailAddress.splitEmailsAndNames(v)[0];if(!aParsed.name)
aParsed.name=aParsed.email;this.__last_qdata=aParsed;var aFilter={search:'has:email AND ('+(GWOthers.getItem('MAIL_SETTINGS_GENERAL','search_primary')==1?'email1':'email')+':"'+aParsed.email.replace(/"/g,'\\"')+'" OR classify:"'+aParsed.name.replace(/"/g,'\\"')+'" OR title:"'+aParsed.name.replace(/"/g,'\\"')+'" OR name:"'+aParsed.name.replace(/"/g,'\\"')+'")',sort:'ITMCLASSIFYAS,ITMFIRSTNAME,ITMSURNAME,LCTEMAIL1,LCTEMAIL2,LCTEMAIL3',limit:this._limit,groupbyemail:GWOthers.getItem('MAIL_SETTINGS_GENERAL','GROUP_CONTACTS_BY_EMAIL')=='1'};}
if(!sPrimaryAccountGW||(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1)
this._parse(v,[]);else{WMItems.list({'aid':sPrimaryAccount,'fid':(GWOthers.getItem('RESTRICTIONS','gal_suggest')==1?"__@@ADDRESSBOOK@@__":Mapping.getDefaultFolderForGWType('C')),'values':['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTTYPE'],'filter':aFilter},'','','',[this,'_parse',[v]]);}};_me._parse=function(sWord,aValues){if(!aValues||this._input_value()!=sWord){this.__show();this.__sLastRequestString='';return;}
var rcp,emails=[],name,email;if((rcp=Cookie.get(['suggest_address']))){emails=MailAddress.splitEmailsAndNames(rcp);name=this.__last_qdata.name?this.__last_qdata.name.toLowerCase():'';email=this.__last_qdata.email?this.__last_qdata.email.toLowerCase():'';for(var i=emails.length-1;i>=0;i--)
if(!((email&&emails[i].email.toLowerCase().indexOf(email)>-1)||(name&&emails[i].name.toLowerCase().indexOf(name)>-1)))
emails.splice(i,1);}
if(!Is.Empty(aValues)){for(var aid in aValues)
for(var fid in aValues[aid]);if(aid&&fid&&(aValues=aValues[aid][fid])){delete aValues['/'];delete aValues['#'];delete aValues['$'];delete aValues['@'];var found;for(var i in aValues){if(aValues[i].ITMCLASS=='L'){email=['['+aValues[i].ITMCLASSIFYAS+']'];name='';}
else
if(!aValues[i].LCTEMAIL1&&!aValues[i].LCTEMAIL2&&!aValues[i].LCTEMAIL3)
continue;else{name=aValues[i].ITMCLASSIFYAS||((aValues[i].ITMFIRSTNAME||'')+(aValues[i].ITMSURNAME?' '+aValues[i].ITMSURNAME:''));email=[];if(aValues[i].LCTEMAIL1)
email.push(aValues[i].LCTEMAIL1);if(GWOthers.getItem('MAIL_SETTINGS_GENERAL','search_primary')!=1){if(aValues[i].LCTEMAIL2)
email.push(aValues[i].LCTEMAIL2);if(aValues[i].LCTEMAIL3)
email.push(aValues[i].LCTEMAIL3);}}
for(var j in email){found=false;for(var k in emails)
if(emails[k].email.toLowerCase()==email[j].toLowerCase()||(aValues[i].ITMCLASS=='L'&&('['+emails[k].email.toLowerCase()+']')==email[j].toLowerCase())){if(name&&!emails[k].name)
emails[k].name=name;found=true;}
if(!found)
emails.push({name:name,email:email[j]});}}}}
var sc=function(a,b){var x=(a.name||'')+a.email.replace(/[\[\]]/g,'');var y=(b.name||'')+b.email.replace(/[\[\]]/g,'');if(x>y)
return 1;else
if(x<y)
return-1;else
return 0;};emails=emails.sort(sc);var out=[],MSIE=currentBrowser()=='MSIE7';for(var i in emails){name=emails[i].name;email=emails[i].email;if((name&&this.__last_qdata.name!=name)||(email&&this.__last_qdata.email!=email)){if(email.indexOf('[')===0)
out.push(MSIE?email:{value:email,css:'avatar'});else
out.push(MSIE?MailAddress.createEmail(name,email):{value:MailAddress.createEmail(name,email),text:MailAddress.createEmail(name,email,true),css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(email)+'\')"></span>'});}}
if(out.length)
this.__show(out);else
this.__hide();this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;};_me.__dndDispatch=function(){if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
return false;};_me.__initdrag=function(elm,x,y){if(this.edit||!elm.parentNode)return false;var sBody='<div class="drag_rcp">'+elm.getAttribute('val').escapeHTML()+'</div>';this.__dragged=elm;addcss(elm,'drag');gui.frm_main.dnd.create_drag(sBody,{type:'rcp',obj:this,value:elm},x,y);};_me._active_dropzone=function(v){this.__aDragTargets=[];if(v){if(v.type=='item'&&WMFolders.getType(v.value[0])!='C')
return false;this.__objPos=getSize(this._main);var a=this.__etag.getElementsByTagName('SPAN');for(var i=a.length-1;i>=0;i--)
if(a[i]!=v.value)
this.__aDragTargets.push([a[i],getSize(a[i])]);}
else
if(this.__dragged&&this.__dragged.parentNode){removecss(this.__dragged,'drag');removecss(this._main,'dragover');this.__dragged=null;}};_me._ondragover=function(v){addcss(this._main,'dragover');};_me._ondragout=function(v){removecss(this._main,'dragover');};_me._ondrop=function(v){if(v.value&&v.target!==v.obj){var a=[];switch(v.type){case'item':if(v.value){var aID=[];for(var i=0;i<v.value.length;i++)
aID.push(WMItems.__serverID(v.value[i].iid));if(aID.length){var me=this;WMItems.list({aid:v.value[0].aid,fid:v.value[0].fid,filter:{search:'items:('+aID.join(' OR ')+')'},values:['ITMCLASSIFYAS','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','ITMCLASS']},'','','',[function(itm){if(me._addTag&&itm&&(itm=itm[v.value[0].aid])&&(itm=itm[v.value[0].fid]))
for(var i in itm)
if(Is.Object(itm[i]))
if(itm[i].ITMCLASS=='L'){var sPrefix='',sName=itm[i].ITMCLASSIFYAS;if(itm[i].aid!=sPrimaryAccount||sName.indexOf('::')>=0)
sPrefix=itm[i].aid+'::'+itm[i].fid+'::';else
if(itm[i].fid!=Mapping.getDefaultFolderForGWType('C')&&itm[i].fid!="__@@ADDRESSBOOK@@__")
sPrefix=itm[i].fid+'::';me._addTag({tag:'['+sPrefix+sName+']'});}
else
if(itm[i].LCTEMAIL1||itm[i].LCTEMAIL2||itm[i].LCTEMAIL3)
me._addTag({tag:MailAddress.createEmail(itm[i].ITMCLASSIFYAS,(itm[i].LCTEMAIL1||itm[i].LCTEMAIL2||itm[i].LCTEMAIL3))});}]);}}
return;case'jabber':for(var tmp,i=0;i<v.value.length;i++){tmp=dataSet.get('xmpp',['roster',v.value[i],'name']);tmp=MailAddress.createEmail(tmp&&tmp!=v.value[i]?tmp:'',v.value[i]);if(tmp)
a.push({tag:tmp});}
break;case'rcp':a=this._decode(v.value.getAttribute('val'));}
if(a.length)
for(var i=0;i<a.length;i++)
this._addTag(a[i]);}};_me._ondragstart=function(v){if(v.value.parentNode)
addcss(v.value,'dragged');};_me._ondragend=function(v){if(v.value.parentNode)
if(v.target&&v.target!==this)
v.value.parentNode.removeChild(v.value);else
removecss(v.value,'dragged');};_me._collapsedValue=function(v){var dv=this._decode(v);if(dv.length>this.__collapse_limit)
this._value(v,true);else
this._value(v);};

/* client/inc/obj_mailview.js */
_me=obj_mailview.prototype;function obj_mailview(){};_me.__constructor=function(sDataSet,sDataPath,bCheckActive){var me=this;this._skipsaving=false;this._noupdate=false;this._checkActive=bCheckActive;this._MSIE=currentBrowser().indexOf('MSIE')>-1;this.__eHeader=this._getAnchor('header');this.__eSubject=this._getAnchor('subject');this.__eFrom=this._getAnchor('from');this.__FullHeaders=null;this.__HiddenImages=true;this.__TextBody=false;var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');this.__ab_support=sPrimaryAccountGW>0&&(!dgw||dgw.indexOf('c')<0);this._scrollbar(this._getAnchor('block'),this._getAnchor('block').parentNode);this.__imgarray={};this.__eFrame=this._getAnchor('frame');this.__doc=this.__eFrame.contentDocument||this.__eFrame.contentWindow.document;this.__doc_base=document.getElementsByTagName('base');this.__doc_base=this.__doc_base[this.__doc_base.length-1].getAttribute('href');var eHelp=mkElement('iframe',{frameborder:0,marginheight:0,marginwidth:0,src:"",className:'helper',style:{height:'1px'}});this._main.appendChild(eHelp);eHelp.contentWindow.onresize=function(e){if(this.__width!=eHelp.offsetWidth){this.__width=eHelp.offsetWidth;me.__resize&&me.__resize(true);}};this._getAnchor('teamchat')&&this._getAnchor('teamchat').addEventListener('click',function(e){function __uploadhandler(aTo,aBuffer,sName,sDesc,aArg){if(aBuffer&&aBuffer.length){var d=new IcewarpDate(),aItemInfo={values:{},ATTACHMENTS:[]};aItemInfo.values.EVNSHARETYPE='U';aItemInfo.values.EVNCLASS='F';aItemInfo.values.EVNSTARTDATE=d.format(IcewarpDate.JULIAN);aItemInfo.values.EVNSTARTTIME=d.hour()*60+d.minute();if(aBuffer.length==1){aItemInfo['values']['EVNRID']=aItemInfo['values']['EVNLOCATION']=aItemInfo['values']['EVNTITLE']=sName||aBuffer[0].name;aItemInfo['values']['EVNCOMPLETE']=aBuffer[0].size;if(Is.String(sDesc)&&sDesc.length){aItemInfo['values']['EVNNOTE']=sDesc;aItemInfo['values']['EVNDESCFORMAT']='text/plain';}}
for(var i=0,j=aBuffer.length;i<j;i++){aItemInfo['ATTACHMENTS'].push({values:aBuffer[i]});}
WMItems.add(aTo,aItemInfo,'','','',[function(bOK,aData){if(bOK){gui.notifier._value({type:'message_sent_tch',args:[dataSet.get('folders',aTo).NAME||dataSet.get('folders',aTo).RELATIVE_PATH||'']});}else{if(aData==='item_create'){aData='ALERTS::FOLDER_INSUFFICIENT_RIGHTS';}else{aData='ERROR::'+aData;}
gui.notifier._value({type:'alert',args:{header:'ALERTS::MESSAGE_NOT_SAVED',text:aData}});}}.bind(this)]);}};var f=dataSet.get('folders',[sPrimaryAccount]);for(var id in f){if(f[id].TYPE=='I'){sFolder=id;break;}}
if(sFolder){gui._create('frm_select_folder','frm_select_folder','','','CHAT::SELECT',sPrimaryAccount,sFolder,[function(aid,fid){var __upload_buffer=[];var data=dataSet.get('items',[me.__aid,me.__fid,me.__iid]);__upload_buffer.push({'class':'item','description':(data.SUBJECT||'').replace(/[<>:\/\\|?*""\[\]]/g,''),'size':data.SIZE,'fullpath':me.__aid+'/'+me.__fid+'/'+me.__iid.replace(/^\*/,'')});if(__upload_buffer.length==1){gui._create('chat_upload','frm_chat_upload','','',__upload_buffer[0].description,'',{aid:aid,fid:fid},[function(sName,sDesc,aArg){__uploadhandler([aid,fid],__upload_buffer,sName,sDesc,aArg);}]);}else{__uploadhandler([aid,fid],__upload_buffer);}}],true,true,['Y','I'],'',true);}});var html="<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n"+"<html>\n<head>\n"+"\n</head>\n<body></body>\n</html>";this.__doc.open('text/html','replace');this.__doc.write(html);this.__doc.close();if(window.FormData){this.__doc.addEventListener("dragstart",function(e){gui.frm_main.__filedrag=false;},false);this.__doc.addEventListener("dragend",function(e){gui.frm_main.__filedrag=true;},false);}
this._getAnchor('skip').onclick=function(){if(!me.__HTMLBody){me.__showHTML();this.style.display='none';}};this._getAnchor('show').onclick=function(){me.__showImages();};this._getAnchor('deferred').onclick=function(){OldMessage.delivery_report([me.__aid,me.__fid,me.__iid]);};this.__eHeader.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'){if(hascss(elm,'tag')){if(gui.frm_main.search.search){gui.frm_main.search.search._value('tag:"'+elm.innerHTML+'"');if(gui.frm_main.search.search._onsubmit)
gui.frm_main.search.search._onsubmit();}}
else
if(elm.rel){var aMail=MailAddress.splitEmailsAndNames(elm.rel);if(aMail&&aMail[0]){try{var aCert;if(me.__header_cert&&me.__header_cert.values.TYPE.toLowerCase()=='certificate'&&(me.__header_cert.values.CERT.INFO[0].SUBJECT[0].EMAILADDRESS&&me.__header_cert.values.CERT.INFO[0].SUBJECT[0].EMAILADDRESS[0].VALUE.toLowerCase()==aMail[0].email.toLowerCase()))
aCert=[{values:{'class':'item','fullpath':me.__aid+'/'+me.__fid+'/'+WMItems.__serverID(me.__iid)}}];}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
elm&&elm.classList&&elm.classList.add('selected');var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',aMail[0].name,aMail[0].email,aCert,undefined,me._recipients);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);cmenu.__remove_class=function(){elm&&elm.classList&&elm.classList.remove('selected');};cmenu._add_destructor('__remove_class');}
if(e.preventDefault)e.preventDefault();e.cancelBubble=true;return false;}}};this.__eHeader.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='A'&&hascss(elm,'address')&&elm.rel)
this.__eHeader.onclick(e);return false;}.bind(this);this._getAnchor('block').oncontextmenu=function(e,frame){var elm=e.target||e.srcElement;if(elm.tagName==='A'||elm.tagName==='IMG'){return;}
try{var s=(frame?frame.contentDocument:document).getSelection(),r=s.getRangeAt(0);if((s.focusNode.parentNode||s.focusNode.parentElement)===elm&&r.startOffset<r.endOffset)
return;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
if(!dataSet.get('folders',[me.__aid,me.__fid,'RSS'])){var e=e||window.event,pos=frame?getSize(frame):{x:0,y:0},cmenu=gui._create('cmenu','obj_context','','mailview_menu');cmenu._fill([{config:{css:'large'}},{title:'ATTACHMENT::SHOW_HEADERS',arg:[me,'__showHeaders'],css:(me.__FullHeaders?'ico2 check':'ico')},{title:'ATTACHMENT::SHOW_TEXT',arg:[me,'__showText',[!me.__TextBody]],css:(me.__TextBody?'ico2 check':'ico')},{title:'POPUP_ITEMS::SOURCE',arg:[function(){OldMessage.source([me.__aid,me.__fid,me.__iid])}],css:'ico'},{title:'MAIN_MENU::PRINT',arg:[me,'_print'],css:('ico')},{title:'-'},{title:'MAIL_VIEW::SHOW_RAW',arg:[function(){var w=window.open('client/raw.html?'+buildURL({'sid':dataSet.get('main',['sid']),'aid':me.__aid,'fid':me.__fid,'iid':WMItems.__serverID(me.__iid)}),"_blank");w.opener=w;w.focus();w=null;}],css:'ico'}]);cmenu._place(e.clientX+pos.x,e.clientY+pos.y);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();return false;}};this.__eFrom.onclick=this.__eHeader.onclick;this.__eFrom.oncontextmenu=this.__eHeader.oncontextmenu;this._listen(sDataSet,sDataPath);if(window.sPrimaryAccountIM&&(GWOthers.getItem('RESTRICTIONS','disable_im')||0)<1){dataSet.on('xmpp',['roster'],this.__updateAddress,this,false,true);this._add_destructor('__removeIMListener');}};_me.__removeIMListener=function(){dataSet.off('xmpp',['roster'],this.__updateAddress);};_me.__updateAddress=function(data){[].forEach.call(this.__eFrom.querySelectorAll('a.address'),function(elm){if(elm.rel){var user=MailAddress.splitEmailsAndNames(elm.rel);if(user&&user[0]&&user[0].email){elm.className='address'+(data[user[0].email]?' im_'+data[user[0].email].show:'');}}});};_me.__prepare=function(bResize){if(GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){storage.library('night_mode');NightMode(this.__eFrame.contentWindow).activate(false,function(){this._main.style.visibility='visible';}.bind(this));}
this.__resize(bResize);};_me.__resize=function(bResize){var h=0,div=this.__doc.getElementsByTagName('div');this._getAnchor('message')&&(this._getAnchor('message').style.width='100%');if(div&&(div=div[0])){this._getAnchor('message')&&(this._getAnchor('message').style.width=this._main.clientWidth<div.scrollWidth?(div.scrollWidth)+'px':'100%');div.style.height=0;if(div.scrollHeight)
h=div.scrollHeight;else{div.style.height='auto';h=(Math.max(div.offsetHeight,div.scrollHeight));}}
this.__eFrame.style.height=h+'px';if(this.__doc.body.scrollHeight>h){h=this.__doc.body.scrollHeight;this.__eFrame.style.height=h+'px';}};_me._context_link=function(e,sName,sMail){var pos=getSize(this.__eFrame);var c=gui._create('cmenu','obj_context_link','','',sName,sMail);c._place(pos.x+e.clientX,pos.y+e.clientY);c=null;e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;};_me.__parseHeader=function(sEmails,bFull){var out=gui._rtl?'<bdi>':'',stat,emails=MailAddress.splitEmailsAndNames(sEmails.unescapeXML()),bIM=gui.frm_main&&gui.frm_main.im&&gui.frm_main.im._is_active();for(var i in emails)
out+='<a class="address'+(bIM&&(stat=gui.frm_main.im._inRoster(emails[i].email))?' im_'+stat.escapeXML(true):'')+(emails[i].email==sPrimaryAccount?' primary':'')+'" rel="'+MailAddress.createEmail(emails[i].name,emails[i].email).escapeXML(true)+'" title="'+getLang('ITEMVIEW::MESSAGE_TO',[emails[i].email.escapeXML(true)])+'">'+(bFull?MailAddress.createEmail(emails[i].name,emails[i].email,true):(emails[i].name||emails[i].email)).escapeXML()+'</a> ';return gui._rtl?out+'</bdi>':out;};_me.__avatar=function(sEmail){if(sEmail&&sPrimaryAccountGW){var me=this,sURL=getAvatarURL(sEmail),img=new Image();img.onload=function(){if(!me._getAnchor('avatar')){return;}
var elm=mkElement('b');me._getAnchor('avatar').innerHTML='';me._getAnchor('avatar').appendChild(elm);if(elm){if(this.height>10&&this.width>10){if(currentBrowser()=='MSIE7'){var img=mkElement('img',{src:sURL});if(this.width>this.height){var r=this.height/elm.clientHeight;img.style.height='100%';if((this.width/r)>elm.clientWidth)
img.style.right=(((this.width/r)-elm.clientWidth)/2)+'px';}
else{var r=this.width/elm.clientWidth;img.style.width='100%';if((this.height/r)>elm.clientHeight)
this.style.bottom=(((this.height/r)-elm.clientHeight)/2)+'px';}
elm.appendChild(img);elm.style.backgroundImage='none';}
else
elm.style.backgroundImage='url("'+sURL+'")';elm.style.backgroundColor='#FFFFFF';}
else{elm.style.backgroundImage='';elm.style.backgroundColor='';}}};img.src=sURL;}
else
this._getAnchor('avatar').innerHTML='<b></b>';};_me._header=function(aData){if(this.attach)
this.attach._destruct();var child;while(child=this.__eHeader.lastChild)
this.__eHeader.removeChild(child);var scr=this._getAnchor('pre');scr.innerHTML='';scr.style.display='';if(!aData){removecss(this._getAnchor('container'),'show');return;}
var tr,th,td,aData2=[],bHeader=false;if(aData['COLOR']){this._getAnchor('date').className='th date '+aData['COLOR'];delete aData['COLOR'];}
if(aData['DATE']){this._getAnchor('date').innerHTML=IcewarpDate.unix(aData['DATE']).format('dd L LT');delete aData['DATE'];}
else
this._getAnchor('date').innerHTML='';if(aData['TO']){var tmp=MailAddress.splitEmailsAndNames(aData['TO'].replace(/&gt;/gi,">").replace(/&lt;/gi,"<").replace(/&quot;/gi,'"'));if(tmp.length>1||(tmp[0]&&tmp[0].email!=sPrimaryAccount))
aData2[getLang('DATAGRID_ITEMS_VIEW::TO')]=this.__parseHeader(aData['TO']);delete aData['TO'];}
if(aData['CC']){aData2[getLang('DATAGRID_ITEMS_VIEW::CC')]=this.__parseHeader(aData['CC']);delete aData['CC'];}
if(aData['BCC']){aData2[getLang('DATAGRID_ITEMS_VIEW::BCC')]=this.__parseHeader(aData['BCC']);delete aData['BCC'];}
if(aData['TAGS']){var arr=aData['TAGS'].split(','),tmp='',aTags=dataSet.get('tags');for(var sTag in arr)
if((arr[sTag]=arr[sTag].trim()))
tmp+='<a class="tag"'+(aTags[arr[sTag]]&&aTags[arr[sTag]].TAGCOLOR?' style="background-color: '+aTags[arr[sTag]].TAGCOLOR+'; color: '+aTags[arr[sTag]].TEXTCOLOR+'"':'')+'>'+arr[sTag]+'</a>';aData2[getLang('DATAGRID_ITEMS_VIEW::ITMCATEGORY')]=tmp;delete aData['TAGS'];}
if(aData['REPLY_FULLPATH'])
delete aData['REPLY_FULLPATH'];if(aData['ATTACHMENTS']){aData2['ATTACHMENTS']=aData['ATTACHMENTS'];delete aData['ATTACHMENTS'];delete aData['SMART_ATTACH'];}
aData2=arrConcat(aData2,aData);for(var i in aData2){if(!bHeader){bHeader=true;addcss(this._getAnchor('container'),'show');}
tr=mkElement('tr');this.__eHeader.appendChild(tr);if(i=='ATTACHMENTS'){td=mkElement('td',{id:this._pathName+'#attach'});td.style.width="100%";td.colSpan=2;tr.appendChild(td);this._create('attach','obj_attach_mailview','attach');this.attach._aid=this.__aid;this.attach._fid=this.__fid;this.attach._iid=this.__iid;var urlAll='';for(var j in aData2['ATTACHMENTS'])
if(aData2['ATTACHMENTS'][j]['values'].SMART){if(aData2['ATTACHMENTS'][j]['values'].ALL){urlAll=aData2['ATTACHMENTS'][j]['values'].URL;break;}}
var out,aOut=[];for(var j in aData2['ATTACHMENTS'])
if(!aData2['ATTACHMENTS'][j]['values'].ALL){out={"name":aData2['ATTACHMENTS'][j]['values'].NAME,"cert":aData2['ATTACHMENTS'][j]['values'].CERT,"size":aData2['ATTACHMENTS'][j]['values'].SIZE,"id":j,"type":aData2['ATTACHMENTS'][j]['values'].TYPE};if(aData2['ATTACHMENTS'][j]['values'].SMART){out.allurl=urlAll;out.url=aData2['ATTACHMENTS'][j]['values'].URL;}
aOut.push(out);}
this.attach._value({'attachments':aOut});}
else
if(i=='ALL_HEADERS'){td=mkElement('td');td.style.width="100%";td.className='obj_mailview_allheaders';td.colSpan=2;tr.appendChild(td);scr.innerHTML=this._MSIE?aData2[i].replace(/\n/gm,'<br>'):aData2[i];scr.style.display='block';}
else{th=mkElement('th',{'className':'th minw'});th.style.width="0.1%";td=mkElement('td');td.style.width="99.9%";tr.appendChild(th);tr.appendChild(td);if(aData2[i].length>600)
td.innerHTML='<div class="scroll_header">'+aData2[i]+'</div>';else
td.innerHTML=aData2[i];th.innerHTML=i+':';}
tr=null;th=null;td=null;}
if(!bHeader)
removecss(this._getAnchor('container'),'show');if(dataSet.get('folders',[this.__aid,this.__fid]).TYPE==='I'||!sPrimaryAccountCHAT){var ta=this._getAnchor('teamchat');ta&&ta.parentNode.removeChild(ta);}};_me._frame=function(v){var me=this;if(typeof v!='undefined'){if(GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){this._main.style.visibility='hidden';}
this.__showImages(true);var tmp=mkElement('div');tmp.innerHTML=v;[].forEach.call(tmp.querySelectorAll('img'),function(img){if(~img.src.indexOf('http:/')){img.src='/teamchatapi/http.download?token='+sPrimaryAccountTeamchatToken+'&url='+encodeURIComponent(img.src);}
if(img.style.height.indexOf('%')){img.style.height='auto';}});[].forEach.call(tmp.querySelectorAll('table, div'),function(el){el.getAttribute('style')&&el.setAttribute('style',el.getAttribute('style').replace(/\s*height:\s*100%\s*(!important)?;?/gi,'height: auto;'));el.getAttribute('height')&&el.setAttribute('height','auto');});if(navigator.userAgent.indexOf('WebKit')!=-1){var img=tmp.getElementsByTagName('img');for(var i=img.length-1;i>=0;i--)
if(img[i].nodeName=='IMG')
img[i].addEventListener('load',function(e){me.__resize&&me.__resize()},false);}
var html="<!DOCTYPE HTML PUBLIC \"-//W3C//DTD HTML 4.01 Transitional//EN\">\n"+"<html>\n<head>\n"+'<link type="text/css" rel="stylesheet" iw-skip="true" href="'+this.__doc_base+'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'font.css'})+'" />\n'+'<link type="text/css" rel="stylesheet" iw-skip="true" href="'+this.__doc_base+'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:'obj_mailview_body.css'})+'" />\n'+'<meta http-equiv="x-dns-prefetch-control" content="off" />\n'+'<base href="'+this.__doc_base+'" />\n'+"</head>\n"+'<body id=\"iw_webmail_msg_body\" onload="window.parent.'+this._pathName+'.__prepare();" style="visibility: hidden"><div style="height: auto!important;">'+tmp.innerHTML+"</div></body>\n</html>";tmp=null;this.__doc.open('text/html','replace');this.__doc.write(html);this.__doc.close();this.__doc.body.scrollTop=0;function mouseEvn(e){var e=e||me.__eFrame.contentWindow.event,pos=getSize(me.__eFrame);if(document.createEventObject){var evt=document.createEventObject();evt.clientX=e.clientX+pos.x;evt.clientY=e.clientY+pos.y;return me.__eFrame.fireEvent('on'+e.type,evt)?true:false;}
else{var evt=document.createEvent("MouseEvents");evt.initMouseEvent(e.type,true,true,window,0,0,0,e.clientX+pos.x,e.clientY+pos.y,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,null);return me.__eFrame.dispatchEvent(evt);}};this.__doc.onmousemove=mouseEvn;this.__doc.onmousedown=mouseEvn;this.__doc.onmouseup=mouseEvn;this.__doc.onclick=mouseEvn;this.__doc.addEventListener('click',function(event){var tmp;if(event.target.tagName==='A'&&(tmp=event.target.href.match(wm_conference.linkRegExp))){event.preventDefault();event.stopPropagation();event.stopImmediatePropagation();wm_conference.get(tmp[2]+'@'+tmp[1]).join();}});this.__doc.oncontextmenu=function(e){return me._getAnchor('block').oncontextmenu(e,me.__eFrame);};this.__doc.onmouseover=mouseEvn;AttachEvent(this.__doc,"onmousewheel",function(e){var elm=me._getAnchor('block'),deltaX=e.deltaX,deltaY=e.deltaY;if(!deltaX&&deltaY&&elm.scrollHeight<=elm.clientHeight){deltaX=deltaY;deltaY=0;}
me.__sbar_wheel(elm,deltaX,deltaY);});AttachEvent(this.__doc,"onkeydown",function(e){var elm=e.target||e.srcElement;if(elm.tagName=='INPUT'||elm.tagName=='TEXTAREA')
return;if(me._onkeypress)
me._onkeypress(e);var jump=[0,0];switch(e.keyCode){case 36:me._getAnchor('block').scrollTop=0;return;case 35:me._getAnchor('block').scrollTop=me._getAnchor('block').scrollHeight;return;case 38:jump=[-28,0];break;case 40:jump=[28,0];break;case 37:jump=[0,-28];break;case 39:jump=[0,28];break;case 33:jump=[(me._getAnchor('block').clientHeight*-1),0];break;case 34:jump=[me._getAnchor('block').clientHeight,0];break;default:return;}
if(jump[0])
me._getAnchor('block').scrollTop+=jump[0];if(jump[1])
me._getAnchor('block').scrollLeft+=jump[1];});AttachEvent(this.__doc,"oncopy",function(e){var se=this.getSelection(),fn=se[se.focusOffset>se.anchorOffset?'focusNode':'anchorNode'];if(fn&&fn.textContent){var tx=fn.textContent;if(tx.match(/\($/g)&&fn.nextElementSibling&&fn.nextElementSibling.tagName=='A'&&fn.nextElementSibling.protocol=='mailto:'){var name=tx.replace(/(^([^:.]+)\:)|\($/g,''),mail=fn.nextElementSibling.href.substring(fn.nextElementSibling.protocol.length);if(mail){var div=mkElement('div',{text:MailAddress.createEmail(name,mail),style:{position:'fixed',left:'-99999px'}},this);this.body.appendChild(div);se.selectAllChildren(div);window.setTimeout(function(){if(div.parentNode)
this.removeChild(div);}.bind(this.body),100);}}}});this.__resize();}
else{try{if(currentBrowser()!='Mozilla')
this.__doc.getElementsByTagName('body')[0].innerHTML;else
return this.__doc.getElementsByTagName('div')[0].innerHTML;}
catch(e){return'';}}};_me.__update=function(sName,aPath)
{var aMails=dataSet.get(sName);if(sName=='xmpp'){var tmp,links=this.__eHeader.getElementsByTagName('A');if(aPath&&aPath[0]=='roster'&&aPath[1]&&aPath[2]=='show'){for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&(tmp=MailAddress.splitEmailsAndNames(links[i].rel))&&(tmp=tmp[0]))
if(tmp.email.toLowerCase()==aPath[1])
links[i].className='address im_'+gui.frm_main.im._inRoster(aPath[1])+(hascss(links[i],'primary')?' primary':'');}
else
if(!gui.frm_main.im._is_active())
for(var i=links.length-1;i>-1;i--)
if(links[i].rel&&hascss(links[i],'address'))
links[i].className='address'+(hascss(links[i],'primary')?' primary':'');}
else
if(!aMails){addcss(this._getAnchor('message'),'empty');this._value();}
else{for(var sAccId in aMails){for(var sFolId in aMails[sAccId]){delete aMails[sAccId][sFolId]['#'];delete aMails[sAccId][sFolId]['/'];delete aMails[sAccId][sFolId]['$'];delete aMails[sAccId][sFolId]['@'];for(var sItId in aMails[sAccId][sFolId])
break;break;}
break;}
if((!('HTML'in aMails[sAccId][sFolId][sItId])&&typeof(aMails[sAccId][sFolId][sItId].CLEAN_HTML||aMails[sAccId][sFolId][sItId].TEXT||aMails[sAccId][sFolId][sItId].MESSAGE_ID)=='undefined')||(this._checkActive&&sItId.indexOf('|')<0&&(dataSet.get('active_items',[sAccId,sFolId])&&dataSet.get('active_items',[sAccId,sFolId])!=sItId)))
return;if(this.__aid!=sAccId||this.__fid!=sFolId||this.__iid!=sItId){var eblock=this._getAnchor('block');if(eblock){eblock.scrollTop=0;eblock=null;}}
if(this.__FullHeaders&&(this.__FullHeaders.aid!=sAccId||this.__FullHeaders.fid!=sFolId||this.__FullHeaders.iid!=sItId))
this.__FullHeaders='';aMails=clone(aMails[sAccId][sFolId][sItId]);this._recipients=MailAddress.splitEmailsAndNames(aMails.FROM);this._recipients=this._recipients.concat(MailAddress.splitEmailsAndNames(aMails.TO),MailAddress.splitEmailsAndNames(aMails.CC));delete aMails.aid;delete aMails.fid;delete aMails.FLAGS;delete aMails.HAS_ATTACHMENT;delete aMails.HAS_EMBEDDED_ATTACHMENT;delete aMails.PRIORITY;delete aMails.CONFIRM_ADDR;delete aMails.REPLY_TO;delete aMails.SIZE;delete aMails.MESSAGE_ID;delete aMails.REFERENCES;delete aMails.IN_REPLY_TO;delete aMails.TEAMCHAT;delete aMails.TEAMCHAT_COMMENT;aMails.AID=sAccId;aMails.FID=sFolId;aMails.IID=sItId;removecss(this._getAnchor('message'),'empty');this._value(aMails);}};_me.__showImages=function(bHide){this.__HiddenImages=bHide;var me=this;if(bHide){var elm=document.getElementById(this._pathName+'/frame_images');if(elm)
elm.parentNode.removeChild(elm);removecss(this._main,'images');if(Is.Empty(this.__aImages))
removecss(this._main,'preview');else
addcss(this._main,'preview');}
else
{var sURL,sFullPath=this.__aid+'/'+this.__fid+'/'+WMItems.__serverID(this.__iid);removecss(this._main,'preview');if(this.preview)
this.preview._destruct();addcss(this._main,'images');var etmp=mkElement('div',{id:this._pathName+'/frame_images',className:'obj_mailview_images'}),etmp2=mkElement('p',{className:'maxbox relative'});etmp2.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='IMG'){var imgs=this.getElementsByTagName('img'),out=[],v=0;for(var i=imgs.length-1;i>=0;i--)
if(imgs[i].src&&imgs[i].src==elm.src){v=i;break;}
var ratio=window.retina||window.devicePixelRatio||1;for(var i in me.__aImages)
if(me.__aImages[i].url.indexOf('http://')==0||me.__aImages[i].url.indexOf('https://')==0)
out.push(me.__aImages[i]);else
out.push({title:me.__aImages[i].title,url:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath+'/'+me.__aImages[i].url,'resize':1,'width':screen.availWidth*ratio,'height':screen.availHeight*ratio})});if(out.length){var img=gui._create('imgview','frm_imgview');img._fill(out);img._value(v);}}};if(this.attach)
etmp2.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='IMG'&&Is.Defined(elm.getAttribute('rel'))){var att=me.__aImages[elm.getAttribute('rel')];if(att){var cmenu=gui._create("cmenu","obj_context"),aMenu=[{"title":'ATTACHMENT::SAVE','arg':[downloadItem,[buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath+'/'+att.url})]]}],pos=getSize(elm);if(sPrimaryAccountGW>0){var dgw=GWOthers.getItem('RESTRICTIONS','disable_gw_types');if(!dgw||dgw.indexOf('f')<0)
aMenu.push({"title":'ATTACHMENT::SAVE_TO_FOLDER','arg':[me.attach,'_saveFolder',[[{'name':elm.title,'size':0,'fullpath':sFullPath+'/'+att.url}]]]});}
cmenu._fill(aMenu);cmenu._place(pos.x+(pos.w/2),pos.y,'',3);}}
return false;};for(var i in this.__aImages){if(this.__aImages[i].url.indexOf('http://')==0||this.__aImages[i].url.indexOf('https://')==0)
sURL=this.__aImages[i].url;else
sURL='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath+'/'+this.__aImages[i].url,'resize':1,'width':100,'height':100,crop:'50%'});etmp2.appendChild(mkElement('img',{'src':sURL,'title':this.__aImages[i].title,'rel':i}));}
etmp.appendChild(etmp2);this._main.appendChild(etmp);this._scrollbar(etmp2,etmp2.parentNode);}};_me.__showText=function(b){var aMails=dataSet.get(this._listener,this._listenerPath);if(!aMails)return;for(var sAccId in aMails)
for(var sFolId in aMails[sAccId]){delete aMails[sAccId][sFolId]['#'];delete aMails[sAccId][sFolId]['/'];delete aMails[sAccId][sFolId]['$'];delete aMails[sAccId][sFolId]['@'];for(var sItId in aMails[sAccId][sFolId]);}
this.__TextBody=b;WMItems.list({"aid":sAccId,"fid":sFolId,"iid":sItId,"values":this.__TextBody?OldMessage.__TEXTMAIL_VALUES:OldMessage.__FULLMAIL_VALUES},this._listener,this._listenerPath);};_me.__showHTML=function(b){var aMails=dataSet.get(this._listener,this._listenerPath);if(!aMails)return;this.__HTMLBody=true;for(var sAccId in aMails)
for(var sFolId in aMails[sAccId]){delete aMails[sAccId][sFolId]['#'];delete aMails[sAccId][sFolId]['/'];delete aMails[sAccId][sFolId]['$'];delete aMails[sAccId][sFolId]['@'];for(var sItId in aMails[sAccId][sFolId]);}
WMItems.list({"aid":sAccId,"fid":sFolId,"iid":sItId,"values":OldMessage.__FULLMAIL_VALUES_DANGER},this._listener,this._listenerPath);};_me.__showHeaders=function(aHandler){var aMails=dataSet.get(this._listener,this._listenerPath);if(!aMails)return;for(var sAccId in aMails)
for(var sFolId in aMails[sAccId]){delete aMails[sAccId][sFolId]['#'];delete aMails[sAccId][sFolId]['/'];delete aMails[sAccId][sFolId]['$'];delete aMails[sAccId][sFolId]['@'];for(var sItId in aMails[sAccId][sFolId]);}
if(this.__FullHeaders&&this.__FullHeaders.aid==sAccId&&this.__FullHeaders.fid==sFolId&&this.__FullHeaders.iid==sItId){WMItems.list({"aid":sAccId,"fid":sFolId,"iid":sItId,"values":this.__TextBody?OldMessage.__TEXTMAIL_VALUES:(this.__HTMLBody?OldMessage.__FULLMAIL_VALUES_DANGER:OldMessage.__FULLMAIL_VALUES)},this._listener,this._listenerPath,'',aHandler);this.__FullHeaders='';return;}
var MAILINFO_VALUES=['FROM','SUBJECT','ALL_HEADERS',this.__TextBody?'TEXT':(this.__HTMLBody?'HTML':'CLEAN_HTML'),'DATE','ATTACHMENTS','FLAGS','HAS_ATTACHMENT','PRIORITY','STATIC_FLAGS','SMIME_STATUS','CONFIRM_ADDR'];WMItems.list({"aid":sAccId,"fid":sFolId,"iid":sItId,"values":MAILINFO_VALUES},this._listener,this._listenerPath);this.__FullHeaders={"aid":sAccId,"fid":sFolId,"iid":sItId};};_me._print=function(){if(!this.__aid||!this.__fid||!this.__iid||!this.__doc)return false;if(this.__header_cert||(Is.Array(this.__aImages)&&this.__aImages.length)){if(this.print_opt)
this.print_opt._destruct();this.print_opt=gui._create('print_opt','frm_mail_print','','',[this,'__print'],{cert_info:this.__header_cert?true:false,images:this.__aImages.length>0});}
else
this.__print();};_me.__print=function(aOpt){if(this.__FullHeaders){this.__showHeaders([this,'__print']);return false;}
if(Is.Object(aOpt)){window[aOpt.images?'addcss':'removecss'](this.__doc.body,'print_images');window[aOpt.cert_info?'addcss':'removecss'](this.__doc.body,'print_cert');}
this.__eFrame.contentWindow.focus();var NM=NightMode(this.__eFrame.contentWindow);if(NM.init){NM.reset(function(){if(this.__doc.queryCommandSupported('print'))
this.__doc.execCommand('print',false,null);else
this.__eFrame.contentWindow.print();NM.activate();}.bind(this));}else{if(this.__doc.queryCommandSupported('print'))
this.__doc.execCommand('print',false,null);else
this.__eFrame.contentWindow.print();}};_me._value=function(aData){try{var me=this;if(me.x_freebusy){me.x_freebusy._destruct();}
this._getAnchor('smart').style.display='none';this._getAnchor('serror').style.display='none';this._getAnchor('deferred').style.display='none';this._getAnchor('skip').style.display='none';this._getAnchor('player').style.display='none';var obj=this._getChildObjects();for(var i in obj)
if(obj[i]._name.indexOf('X_')==0)
obj[i]._destruct();if(!aData){this.__aid='';this.__fid='';this.__iid='';this.__FullHeaders=null;this.__HiddenImages=true;this.__TextBody=false;this.__eSubject.innerHTML='';this.__eFrom.innerHTML='';this._getAnchor('date').innerHTML='';this._getAnchor('avatar').innerHTML='';this.__aImages=[];this._frame('');this._header();return;}
if(aData['HTML']||aData['CLEAN_HTML']){delete aData['TEXT'];this.__TextBody=false;this.__HTMLBody=aData['HTML']?true:false;}
else
if(aData['TEXT'])
this.__TextBody=true;if(!aData.ALL_HEADERS)
this.__FullHeaders=null;var aHeaders={},sBody='',sStyles;var aIMIP=[];this.__aImages=[];removecss(this.__eSubject);this.__header_cert='';this.__header_base='';this.__header_html=false;aData=Object.assign({SUBJECT:null,FROM:null},aData);if(aData['ATTACHMENTS']){for(var n in aData['ATTACHMENTS'])
if(aData['ATTACHMENTS'][n]['values']&&aData['ATTACHMENTS'][n]['values']['NAME'])
switch(Path.extension(aData['ATTACHMENTS'][n]['values']['NAME'])){case"jpg":case"bmp":case"jpeg":case"gif":case"png":this.__aImages.push({title:aData['ATTACHMENTS'][n]['values']['NAME'],url:aData['ATTACHMENTS'][n]['values']['URL']||n});break;default:if(aData['ATTACHMENTS'][n]['values']['TYPE'])
if(aData['ATTACHMENTS'][n]['values']['TYPE'].indexOf('image')==0)
switch(aData['ATTACHMENTS'][n]['values']['TYPE'].toLowerCase()){case'image/png':case'image/jpeg':case'image/gif':case'image/tif':case'image/bmp':this.__aImages.push({title:aData['ATTACHMENTS'][n]['values']['NAME'],url:aData['ATTACHMENTS'][n]['values']['URL']||n});}
else
if(aData['ATTACHMENTS'][n]['values']['TYPE'].toLowerCase()=='text/calendar'&&aData['ATTACHMENTS'][n]['values']['IMIP']&&WMFolders.getType({aid:aData.AID,fid:aData.FID})==='M'){try{var arr=XMLTools.Str2Arr(aData['ATTACHMENTS'][n]['values']['IMIP']);arr.VCALENDAR[0].PARTID=[{VALUE:n}];aIMIP.push(arr);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
delete aData['ATTACHMENTS'][n];}}
aHeaders['ATTACHMENTS']=aData['ATTACHMENTS'];}
if(aData['CERTIFICATE'])
try{aData['CERTIFICATE']=XMLTools.Str2Arr(aData['CERTIFICATE']);if(!aHeaders['ATTACHMENTS'])
aHeaders['ATTACHMENTS']={};aHeaders['ATTACHMENTS'].CERT=this.__header_cert={values:{TYPE:'certificate',CERT:aData['CERTIFICATE'],NAME:getLang('MAIL_VIEW::CERTIFICATE')}};if(!aData.FROM||(me.__header_cert.values.CERT.INFO[0].SUBJECT[0].EMAILADDRESS&&MailAddress.splitEmailsAndNames(aData.FROM)[0].email.toLowerCase()!=aData['CERTIFICATE'].INFO[0].SUBJECT[0].EMAILADDRESS[0].VALUE.toLowerCase()))
aData.SMIME_STATUS=10;}
catch(r){aData.SMIME_STATUS=2;}
var sAvatarOrigin='';if(Is.String((sAvatarOrigin=aData['FROM']||aData['TO']))){sAvatarOrigin=MailAddress.splitEmailsAndNames(sAvatarOrigin);if(!Is.Empty(sAvatarOrigin)&&(sAvatarOrigin=sAvatarOrigin[0].email))
this.__avatar(sAvatarOrigin);else
this.__avatar();this._getAnchor('avatar').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='B'||elm.tagName=='IMG'){var aMail=MailAddress.splitEmailsAndNames(aData['FROM']||aData['TO']);if(aMail&&aMail[0]){try{var aCert;if(me.__header_cert&&me.__header_cert.values.TYPE.toLowerCase()=='certificate'&&(me.__header_cert.values.CERT.INFO[0].SUBJECT[0].EMAILADDRESS&&me.__header_cert.values.CERT.INFO[0].SUBJECT[0].EMAILADDRESS[0].VALUE.toLowerCase()==aMail[0].email.toLowerCase()))
aCert=[{values:{'class':'item','fullpath':me.__aid+'/'+me.__fid+'/'+WMItems.__serverID(me.__iid)}}];}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
var pos=getSize(elm),cmenu=gui._create('cmenu','obj_context_link','','',aMail[0].name,aMail[0].email,aCert);cmenu._place(pos.x+(pos.w/2),pos.y+pos.h,'',2);e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;}}};}
else{this.__avatar();this._getAnchor('avatar').onclick=null;}
for(var i in aData){switch(i){case'STATIC_FLAGS':this.__header_html=(aData.STATIC_FLAGS&1)?true:false;break;case'BASE_URL':if(aData['BASE_URL'].indexOf('file://')===0)
delete aData['BASE_URL'];else{if(!(/\/$/gi.test(aData['BASE_URL'])))
this.__header_base=aData['BASE_URL']+'/';else
this.__header_base=aData['BASE_URL'];if(!(/^((http)|(https))\:/gi.test(this.__header_base)))
this.__header_base='http://'+this.__header_base;}
break;case'SUBJECT':if(Is.String(aData[i]))
this.__eSubject.innerHTML=(aData[i].length>256?aData[i].substring(0,256)+'...':aData[i]).entityify();else
this.__eSubject.innerHTML=getLang('MAIL_VIEW::NOSUBJECT');break;case'FROM':if(Is.String(aData[i])){if(Is.String(aData.SENDER))
this.__eFrom.innerHTML=this.__parseHeader(aData.SENDER)+'<span class="behalf">'+getLang('MAIL_VIEW::SENDER')+'</span>'+this.__parseHeader(aData[i]);else
this.__eFrom.innerHTML=this.__parseHeader(aData[i],!dataSet.get('folders',[aData['AID'],aData['FID'],'RSS']));}
else
this.__eFrom.innerHTML='';break;case'CLEAN_HTML':if(!aIMIP.length){this._getAnchor('skip').style.display='block';}
case'HTML':if(aData[i]){aData[i]=aData[i].replace(/<!--\[if(.*?)\]>[\w\W]*?\[endif\]-->/g,function(match,conditions){var result=conditions.trim().replace(/\(*([^|&)]*)\)*([|&]*)/g,function(match,condition,andOr){return condition?(+!!~condition.indexOf('!')).toString()+andOr+andOr:'';});return eval(result)?match:'';});var matches=aData[i].match(/<style[\w\W]*?<\/style>/g);sBody=DOMPurify.sanitize(aData[i]);sStyles=matches&&matches.join('');}
break;case'TEXT':if(aData[i])sBody=aData[i].entityify().wrap();break;case'AID':this.__aid=aData[i];break;case'FID':this.__fid=aData[i];break;case'IID':this.__iid=aData[i];break;case'SENDER':case'CERTIFICATE':break;case'SMART_ATTACH':this._getAnchor('smart').style.display='block';break;case'DEFERRED_DELIVERY':if(GWOthers.getItem('DEFAULT_FOLDERS','sent')==aData.AID+'/'+aData.FID){var d=new IcewarpDate(aData.DEFERRED_DELIVERY),elm=this._getAnchor('deferred');elm.innerHTML=getLang('MAIL_VIEW::DEFERRED',[d.format('dd L LT')]);elm.style.display='block';}
break;case'SMIME_STATUS':switch(parseInt(aData.SMIME_STATUS)){case 3:addcss(this.__eSubject,'smime');break;case 4:addcss(this.__eSubject,'sign');break;case 5:addcss(this.__eSubject,'ssmime');break;case 2:case 6:case 7:case 10:addcss(this.__eSubject,'serror');var elm=this._getAnchor('serror');elm.innerHTML=getLang('MAIL_VIEW::'+({2:'SERROR',6:'EXPIRED',7:'EXPIRED',10:'SVERIFY'}[parseInt(aData.SMIME_STATUS)]));elm.style.display='block';break;}
break;case'LIST_UNSUBSCRIBE_POST':break;case'LIST_UNSUBSCRIBE':var list=MailAddress.splitEmailsAndNames(aData.LIST_UNSUBSCRIBE);list.forEach(function(adr){if(adr.email.toLowerCase().indexOf('mailto:')===0){var tmp=mkElement('a',{href:adr.email});if(tmp.pathname){var elm=mkElement('span',{text:getLang('MAIL_VIEW::UNSUBSCRIBE'),className:'unsubscribe'}),web=tmp.pathname.split('@')[1];web=web?web.escapeHTML():'';elm.onclick=function(){gui._create('unsubscribe','frm_confirm','','frm_alert',[function(){if(!hascss(this,'disabled')){var msg=new NewMessage();msg.sTo=tmp.pathname;if(tmp.search)
msg.sSubject=parseURL(tmp.search).subject;addcss(this,'disabled');msg.send(false,[function(bOK){if(bOK){gui.notifier&&gui.notifier._value({type:'alert',args:{header:'MAIL_VIEW::UNSUBSCRIBE',text_plain:getLang('MAIL_VIEW::UNSUBSCRIBED',[web])}});elm.parentElement&&elm.parentElement.removeChild(elm);}
else{removecss(elm,'disabled');}}]);}}.bind(this)],'MAIL_VIEW::UNSUBSCRIBE','CONFIRMATION::UNSUBSCRIBE_LIST',[web]);};me._getAnchor('from').appendChild(elm);list=[];return false;}}});list.forEach(function(adr){if(Is.URL(adr.email)){var host=mkElement('a',{href:adr.email}).hostname,elm=mkElement('span',{text:getLang('MAIL_VIEW::UNSUBSCRIBE'),className:'unsubscribe'});elm.onclick=function(){gui._create('unsubscribe','frm_confirm','','frm_alert',[function(){window.open(adr.email);}.bind(this)],'MAIL_VIEW::UNSUBSCRIBE','CONFIRMATION::UNSUBSCRIBE_LIST',[host]);};me._getAnchor('from').appendChild(elm);return false;}});break;case'COLOR':aHeaders[i]='bg_'+({'1':'red','2':'blue','3':'green','4':'gray','5':'orange','6':'cyan','7':'brown','8':'purple','9':'light_blue','A':'yellow','Y':'complete','Z':'none'}[aData[i]]||'none');break;case'TO':if(aData['TO']=='"Undisclosed Recipients" <>')
break;default:if(Is.String(aData[i])&&i.indexOf('X_')<0)aHeaders[i]=aData[i].entityify();}}
if(aData.X_ICEWARP_CONFERENCE){sBody=template.tmp('obj_mailview_conference',{conference:aData.X_ICEWARP_CONFERENCE.split('@')[0]})+sBody;}
if(aData.X_ICEWARP_VOICEMAIL&&aData.ATTACHMENTS){for(var atid in aData.ATTACHMENTS)
if(aData.ATTACHMENTS[atid].values&&aData.ATTACHMENTS[atid].values.TYPE=='audio/mpeg'){this._getAnchor('player').style.display='block';var p=this._create('X_player','obj_player','player');p._value([{src:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':this.__aid+'/'+this.__fid+'/'+WMItems.__serverID(this.__iid)+'/'+atid}),title:aData.ATTACHMENTS[atid].values.NAME}]);break;}}
if(aData.X_ICEWARP_SERVER_REQUEST&&(!aData.X_ICEWARP_SERVER_REQUEST.METHOD||aData.X_ICEWARP_SERVER_REQUEST.METHOD[0].VALUE!='invite')){var aRights=aData.X_ICEWARP_SERVER_REQUEST.RIGHTS&&aData.X_ICEWARP_SERVER_REQUEST.RIGHTS[0].VALUE?aData.X_ICEWARP_SERVER_REQUEST.RIGHTS[0].VALUE.split(""):[],tmpi=[],tmpf=[],aTplData={'user':aData.X_ICEWARP_SERVER_REQUEST.USER[0].VALUE,'author':aData.X_ICEWARP_SERVER_REQUEST.AUTHOR?aData.X_ICEWARP_SERVER_REQUEST.AUTHOR[0].VALUE:'','folder':aData.X_ICEWARP_SERVER_REQUEST.DISPLAYNAME?aData.X_ICEWARP_SERVER_REQUEST.DISPLAYNAME[0].VALUE:aData.X_ICEWARP_SERVER_REQUEST.FOLDER[0].VALUE,'btn_folder':true,'btn_account':true};for(var r in aRights)
switch(aRights[r]){case'r':tmpi.push(getLang('SETTINGS::READ'));break;case'i':tmpi.push(getLang('SETTINGS::WRITE'));break;case'w':tmpi.push(getLang('SETTINGS::MODIFY'));break;case't':tmpi.push(getLang('SETTINGS::DELETE'));break;case'a':tmpf.push(getLang('SETTINGS::OWNER'));break;case'l':tmpf.push(getLang('SETTINGS::READ'));break;case'k':tmpf.push(getLang('SETTINGS::WRITE'));break;case'x':tmpf.push(getLang('SETTINGS::DELETE'));break;}
if(tmpi.length)
aTplData.items=tmpi.join(', ');if(tmpf.length)
aTplData.folders=tmpf.join(', ');if(aTplData.folder=='*')
aTplData.summary=getLang('MAIL_VIEW::ACCOUNT_ACCESS',[aTplData.author||aTplData.user]);else
aTplData.summary=getLang('MAIL_VIEW::ACCESS',[aTplData.folder,aTplData.author||aTplData.user]);if(aData.AID==sPrimaryAccount){var sSType='';if(aTplData.folder=='*'){var tmp_fol=dataSet.get('folders',[sPrimaryAccount,sPrimaryAccountSPREFIX+aTplData.user]);if(tmp_fol){if(tmp_fol.SUBSCRIPTION_TYPE)
sSType=tmp_fol.SUBSCRIPTION_TYPE;if(tmp_fol.SHARED)
aTplData.btn_account=false;}
aTplData.btn_folder=false;}
else
if(aTplData.folder)
sSType=dataSet.get('folders',[sPrimaryAccount,sPrimaryAccountSPREFIX+aTplData.user+'/'+aTplData.folder,'SUBSCRIPTION_TYPE']);if(sSType){aTplData.btn_folder=false;if(sSType=='account')
aTplData.btn_account=false;}}
else{aTplData.btn_folder=false;aTplData.btn_account=false;}
sBody=template.tmp('obj_mailview_subscribe',aTplData);}
else
if(aIMIP.length>0){var atmp,aData;for(var i in aIMIP){if(!aIMIP[i]||!aIMIP[i].VCALENDAR||!aIMIP[i].VCALENDAR[0])
continue;aTplData={};if(aIMIP[i].VCALENDAR[0]['X-SERVER-NONEDITABLE'])
aTplData.groupchat=true;if(aIMIP[i].VCALENDAR[0].METHOD)
aTplData.imip_method=aIMIP[i].VCALENDAR[0].METHOD[0].VALUE.toUpperCase();atmp=aIMIP[i].VCALENDAR[0];if(atmp.VEVENT){var out='',t1=0,t2;for(var j in atmp.VEVENT){if(atmp.VEVENT[j]['LAST-MODIFIED']&&atmp.VEVENT[j]['LAST-MODIFIED'][0].VALUE){t2=new IcewarpDate(atmp.VEVENT[j]['LAST-MODIFIED'][0].VALUE).unix();if(t1<t2||(t1==t2&&atmp.VEVENT[j]['RECURRENCE-ID'])){t1=t2;out=atmp.VEVENT[j];}}}
atmp=out||atmp.VEVENT[0];aTplData.imip_type='VEVENT';if(aTplData.imip_method!='COUNTER')
aTplData.timecontrols='true';}
else
if(atmp.VTODO){atmp=atmp.VTODO[0];aTplData.imip_type='VTODO';}
else
if(atmp.VJOURNAL){atmp=atmp.VJOURNAL[0];aTplData.imip_type='VJOURNAL';if(aTplData.imip_method!='COUNTER')
aTplData.timecontrols='true';}
else
continue;aTplData.pid=aIMIP[i].VCALENDAR[0].PARTID[0].VALUE;aTplData.summary=atmp.SUMMARY&&atmp.SUMMARY[0]&&atmp.SUMMARY[0].VALUE?atmp.SUMMARY[0].VALUE.entityify():'- - -';if(atmp.LOCATION&&atmp.LOCATION[0]&&atmp.LOCATION[0].VALUE)
aTplData.location=atmp.LOCATION[0].VALUE.entityify();if(atmp.DTSTART){var a=IcewarpDate.julian(atmp.DTSTART[0].ATTRIBUTES['X-CTZDATE'],Math.max(atmp.DTSTART[0].ATTRIBUTES['X-CTZTIME'],0)),aa=atmp.DTSTART[0].ATTRIBUTES['X-ORIGINALDATE']&&IcewarpDate.julian(atmp.DTSTART[0].ATTRIBUTES['X-ORIGINALDATE'],Math.max(atmp.DTSTART[0].ATTRIBUTES['X-ORIGINALTIME'],0)),time=~atmp.DTSTART[0].VALUE.indexOf('T');aTplData.date='<strong>'+a.format('dddd')+'</strong>, '+a.format('L'+(time?' LT':''));if(aa){aTplData.original_date='<strong>'+aa.format('dddd')+'</strong>, '+aa.format('L'+(time?' LT':''));}
if(atmp.DTEND||atmp.DTDUE){var end=atmp.DTEND||atmp.DTDUE,time=~end[0].VALUE.indexOf('T'),b=IcewarpDate.julian(end[0].ATTRIBUTES['X-CTZDATE'],Math.max(end[0].ATTRIBUTES['X-CTZTIME'],0)),bb=end[0].ATTRIBUTES['X-ORIGINALDATE']&&IcewarpDate.julian(end[0].ATTRIBUTES['X-ORIGINALDATE'],Math.max(end[0].ATTRIBUTES['X-ORIGINALTIME'],0));if(aTplData.imip_type==="VEVENT"&&!time){a.date(a.date()-1);b.date(b.date()-1);aa&&aa.date(aa.date()-1);bb&&bb.date(bb.date()-1);}
if(a.isSame(b,'day')){if(+a!=+b)
aTplData.date+=' - '+b.format('LT');}
else{aTplData.date+=' - '+b.format('L'+(time?' LT':''));}
if(aa&&bb){if(aa.isSame(bb,'day')){if(+aa!=+bb)
aTplData.original_date+=' - '+bb.format('LT');}
else{aTplData.original_date+=' - '+bb.format('L'+(time?' LT':''));}}}
if(atmp.ATTENDEE){if(atmp.ORGANIZER&&atmp.ORGANIZER[0].ATTRIBUTES&&atmp.ORGANIZER[0].ATTRIBUTES.CN){aTplData.organiser=atmp.ORGANIZER[0].VALUE;aTplData.attendee='<a href="'+aTplData.organiser.escapeHTML()+'">'+atmp.ORGANIZER[0].ATTRIBUTES.CN.escapeHTML()+'</a>';if(aTplData.organiser.indexOf('mailto:')===0)
aTplData.organiser=aTplData.organiser.substr(7);}
else
aTplData.attendee='';for(var atd in atmp.ATTENDEE)
if(atmp.ATTENDEE[atd].ATTRIBUTES&&atmp.ATTENDEE[atd].ATTRIBUTES.ROLE!='NON-PARTICIPANT'&&(!atmp.ORGANIZER||atmp.ATTENDEE[atd].VALUE!=atmp.ORGANIZER[0].VALUE))
aTplData.attendee+=(aTplData.attendee?', ':'')+'<a href="'+atmp.ATTENDEE[atd].VALUE.escapeHTML()+'">'+(atmp.ATTENDEE[atd].ATTRIBUTES.CN||atmp.ATTENDEE[atd].VALUE.replace(/^mailto\:/gi,'')).escapeHTML()+'</a>';}
if(atmp.CATEGORIES&&atmp.CATEGORIES[0].VALUE){aTplData.tags=[];var arr=atmp.CATEGORIES[0].VALUE.split(','),aTags=dataSet.get('tags');for(var sTag in arr)
if((arr[sTag]=arr[sTag].trim()))
aTplData.tags.push({TAGNAME:arr[sTag],TAGCOLOR:(aTags[arr[sTag]]&&aTags[arr[sTag]].TAGCOLOR?aTags[arr[sTag]].TAGCOLOR:'')});}
if(atmp.RRULE){aTplData.rcr=true;var recur=new iMipRecurrence(atmp.RRULE[0].VALUE,a,time,b);aTplData.date=recur.toString();}
else
if(atmp['RECURRENCE-ID'])
aTplData.ocr=true;if(atmp['X-ALT-DESC']&&atmp['X-ALT-DESC'][0]&&atmp['X-ALT-DESC'][0].VALUE){if(atmp['X-ALT-DESC'][0].ATTRIBUTES&&atmp['X-ALT-DESC'][0].ATTRIBUTES.FMTTYPE==='text/html'){aTplData.description=DOMPurify.sanitize(atmp['X-ALT-DESC'][0].VALUE);}else{aTplData.description=atmp['X-ALT-DESC'][0].VALUE.escapeHTML();}}else if(atmp.DESCRIPTION&&atmp.DESCRIPTION[0]&&atmp.DESCRIPTION[0].VALUE){aTplData.description=atmp.DESCRIPTION[0].VALUE.escapeHTML().highlight_links();}
if(aTplData.description){aTplData.description=aTplData.description.trim().replace(/\n\s*\n/g,'\n').replace(/\n/g,'<br>');}
if(atmp.COMMENT&&atmp.COMMENT[0]&&atmp.COMMENT[0].VALUE)
aTplData.comment=atmp.COMMENT[0].VALUE.escapeHTML().highlight_links();}
aTplData.disabled=!WMFolders.getAccess([this.__aid,this.__fid]).write||!aTplData.imip_method||!~['REQUEST','COUNTER','DECLINECOUNTER','PUBLISH'].indexOf(aTplData.imip_method);aTplData.import_only=aTplData.imip_method==='PUBLISH';aTplData.organiser=aTplData.organiser==sPrimaryAccount;aTplData.canceled=aTplData.imip_method==='CANCEL';sBody=template.tmp('obj_mailview_imip',aTplData);}}
var date=dataSet.get('items',[this.__aid,this.__fid,this.__iid,'DATE']);if(date){var oDate=IcewarpDate.unix(date);}
sBody_data='<div class="iw_webmail_msg_header">'+'<h1>'+(aData['SUBJECT']?aData['SUBJECT'].escapeHTML():'')+'</h1>'+'<table>'+'<tr><th width="0%" nowrap>'+getLang('DATAGRID_ITEMS_VIEW::FROM')+':&nbsp;</th><td width="100%">'+(aData['FROM']?aData['FROM'].escapeXML():'')+'</td>'+(oDate?'<td width="0%" valign="top" nowrap>'+(oDate?oDate.format('L LT'):'')+'</td>':'')+'</tr>'+
(aData['TO']?'<tr><th width="0%" nowrap>'+getLang('DATAGRID_ITEMS_VIEW::TO')+':&nbsp;</th><td width="100%" colspan="2">'+aData['TO'].escapeXML()+'</td></tr>':'')+
(aData['CC']?'<tr><th width="0%" nowrap>'+getLang('DATAGRID_ITEMS_VIEW::CC')+':&nbsp;</th><td width="100%" colspan="2">'+aData['CC'].escapeXML()+'</td></tr>':'')+
(aData['BCC']?'<tr><th width="0%" nowrap>'+getLang('DATAGRID_ITEMS_VIEW::BCC')+':&nbsp;</th><td width="100%" colspan="2">'+aData['BCC'].escapeXML()+'</td></tr>':'');if(aData['ATTACHMENTS']){sBody_data+='<tr><th width="0%" nowrap>'+getLang('DATAGRID_ITEMS_VIEW::ATTACHMENTS')+':&nbsp;</th><td colspan="2">';for(var j in aData['ATTACHMENTS']){var att=aData['ATTACHMENTS'][j]['values'];if(att.NAME)
sBody_data+=att.NAME.escapeXML()+(att.SIZE?' ('+parseFileSize(att.SIZE)+')':'')+'; ';}
sBody_data+='</td></tr>';}
sBody_data+='</table></div>';if(sBody)
if(this.__TextBody)
sBody_data+='<div style="font-family: Lucida Console,Courier New,Courier,Monospace;">'+sBody+'</div>';else
if(this.__header_html)
sBody_data+=sBody;else
sBody_data+='<div>'+sBody+'</div>';if(this.__header_cert){var aOut={purposes:{},data:this.__header_cert.values.CERT.INFO[0]};aOut.from=IcewarpDate.utct(aOut.data.VALIDFROM[0].VALUE).format('L LT');aOut.to=IcewarpDate.utct(aOut.data.VALIDTO[0].VALUE).format('L LT');if(aOut.data.PURPOSES&&aOut.data.PURPOSES[0]&&aOut.data.PURPOSES[0].ITEM)
for(var i in aOut.data.PURPOSES[0].ITEM)
if(aOut.data.PURPOSES[0].ITEM[i].VAR1&&aOut.data.PURPOSES[0].ITEM[i].VAR1[0]&&aOut.data.PURPOSES[0].ITEM[i].VAR1[0].VALUE=='1'&&aOut.data.PURPOSES[0].ITEM[i].VAR3&&aOut.data.PURPOSES[0].ITEM[i].VAR3[0]&&aOut.data.PURPOSES[0].ITEM[i].VAR3[0].VALUE)
switch(aOut.data.PURPOSES[0].ITEM[i].VAR3[0].VALUE){case'sslclient':aOut.purposes.SSL=true;break;case'smimeencrypt':case'smimesign':aOut.purposes.SMIME=true;break;}
sBody_data+='<div class="iw_webmail_msg_cert">'+template.tmp('frm_certificate',aOut)+'</div>';}
if(!Is.Empty(this.__aImages)){sBody_data+='<div class="iw_webmail_msg_images">';var sFullPath=this.__aid+'/'+this.__fid+'/'+WMItems.__serverID(this.__iid);for(var i in this.__aImages)
sBody_data+='<img src="'+(this.__aImages[i].url.indexOf('http://')==0||this.__aImages[i].url.indexOf('https://')==0?this.__aImages[i].url:'server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':sFullPath+'/'+this.__aImages[i].url}))+'" />';sBody_data+='</div>';}
if(sStyles){sBody_data+=sStyles;}
this._frame(sBody_data);if(sBody){[].forEach.call(this.__doc.querySelectorAll('span[iw-to="'+sPrimaryAccount+'"]'),function(elm){elm.style.display='none';});var r=/^((http)|(https)|(ftp))\:/gi,h=new RegExp("^"+this.__doc_base.quoteMeta(),"gi"),a=[].concat([].slice.apply(this.__doc.getElementsByTagName('a')),[].slice.apply(this.__doc.getElementsByTagName('area')));this.__anchors={};for(var i=0;i<a.length;i++)
try{if(a[i].getAttribute('href')){a[i].setAttribute('target','_blank');if(a[i].getAttribute('href').indexOf('#')==0||a[i].href.indexOf(document.location.href+'#')==0||(this.__doc_base&&a[i].href.indexOf(this.__doc_base+'#')==0)){a[i].removeAttribute('target');a[i].onclick=function(e){var anchor=me.__anchors[this.hash]||me.__anchors[unescape(this.hash)];if(Is.Defined(anchor)){var elm;if(elm=this.ownerDocument.getElementById('wm_anchor_'+anchor))
try{var pos1=getSize(elm,this.ownerDocument),pos2=getSize(me.__eFrame),pos3=getSize(me._main);me._getAnchor('block').scrollTop+=pos1.y+pos2.y-pos3.y;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
return false;}
if(this.getAttribute('href').indexOf('#')==0)
return false;};}
else
if(a[i].href.toLowerCase().indexOf('mailto:')==0){a[i].onclick=function(){var out={to:this.href.substr(7)};if(out.to&&out.to.indexOf('?')>-1){out.subject=parseURL(out.to).subject;out.body=parseURL(out.to).body;out.to=out.to.substring(0,out.to.indexOf('?'));}
NewMessage.compose(out);return false;};a[i].oncontextmenu=function(e){var p,e=e||me.__eFrame.contentWindow.event,sMail=this.href.substr(7),sName=this.innerHTML;if((p=sMail.indexOf('?'))>-1)
sMail=sMail.substr(0,p);if(sName.indexOf('@')>-1){if(sName.indexOf('&lt;')>-1){var aMail=MailAddress.splitEmailsAndNames(sName.unescapeHTML());if(aMail&&aMail[0]&&aMail[0].name&&aMail[0].email){sName=aMail[0].name;sMail=aMail[0].email;}
else
sName='';}
else
sName='';}
me._context_link(e,sName,sMail);return false;};}
else{if(this.__header_base)
a[i].href=a[i].href.replace(h,this.__header_base);if(!Is.URL(a[i].href)&&currentBrowser().indexOf('MSIE')==0)
a[i].onmousedown=function(e){window.open(this.href);return false;};}}
else
if(a[i].name){this.__anchors['#'+a[i].name]=i;a[i].id='wm_anchor_'+i;a[i].removeAttribute('href');}
else{a[i].removeAttribute('href');a[i].onclick=function(){return false};}}
catch(r){a[i].removeAttribute('href');a[i].onclick=function(){return false};}
if(this.__header_base){var a=this.__doc.getElementsByTagName('link');for(var i=2;i<a.length;i++)
if(!a[i].getAttribute('iw-skip'))
a[i].href=a[i].href.replace(h,this.__header_base);}
if(aData.X_ICEWARP_SERVER_TEAMCHAT_NOTIFICATIONS){var data=aData.X_ICEWARP_SERVER_TEAMCHAT_NOTIFICATIONS||{};if(!data.SERVER_ID||data.SERVER_ID[0].VALUE!==dataSet.get('main',['server_id'])||((data.USER||[])[0]||{}).VALUE!==sPrimaryAccount){[].forEach.call(this.__doc.querySelectorAll('.iw-hidden'),function(elm){elm.classList.remove('iw-hidden');});}
var elms=this.__doc.querySelectorAll('.btn-primary');[].forEach.call(elms,function(elm){elm.addEventListener('click',function(e){var roomID=data.ROOM_ID[0].VALUE.replace(/\\/g,'/');if(!dataSet.get('folders',[sPrimaryAccount,roomID])){return;}
e.preventDefault();e.stopPropagation();e.stopImmediatePropagation();data.POST_ID&&data.POST_ID[0]&&data.POST_ID[0].VALUE&&dataSet.add('teamchat',['forced_last_read_id'],data.POST_ID[0].VALUE.replace('*',''));Cookie.set(['filter_tree'],'I,Y');gui.frm_main.filter.__filter('I');var folders=gui.frm_main.bar.tree.folders;folders._setActive(sPrimaryAccount+'/'+roomID);folders._handleNode({aid:sPrimaryAccount,fid:roomID});folders._filter_folder(['I','Y']);folders._fill();});});}else if(aData.X_ICEWARP_SERVER_REQUEST){if(aData.X_ICEWARP_SERVER_REQUEST.METHOD&&aData.X_ICEWARP_SERVER_REQUEST.METHOD[0].VALUE=='invite'){if(aData.X_ICEWARP_SERVER_REQUEST.SERVER_ID&&aData.X_ICEWARP_SERVER_REQUEST.SERVER_ID[0].VALUE==dataSet.get('main',['server_id'])&&aData.X_ICEWARP_SERVER_REQUEST.USER&&aData.X_ICEWARP_SERVER_REQUEST.FOLDER){var elms=this.__doc.querySelectorAll('.btn-primary');[].forEach.call(elms,function(elm){var aF=dataSet.get('folders',[sPrimaryAccount]),srp=Path.slash(aData.X_ICEWARP_SERVER_REQUEST.FOLDER[0].VALUE),onclick=function(){if(dataSet.get('folders',[sPrimaryAccount,fid])){gui.frm_main._selectView({'aid':sPrimaryAccount,'fid':fid});gui.frm_main.filter.__filter('I');return false;}
gui.notifier._value({type:'teamchat_not_exists',args:[srp]});return false;};for(var fid in aF){if(aF[fid].TYPE=="I"&&aF[fid].RELATIVE_PATH==srp){elm.onclick=onclick;break;}}
elm.onclick=elm.onclick||function(){accounts.refresh({'aid':sPrimaryAccount},'folders','',[function(){for(var fid in aF){if(aF[fid].TYPE=="I"&&aF[fid].RELATIVE_PATH==srp){return onclick();}}
gui.notifier._value({type:'teamchat_not_exists',args:[srp]});}]);return false;};});}}
else{var elm=this.__doc.getElementsByTagName('form');if(elm&&(elm=elm[0])){if((elm=elm.getElementsByTagName('input'))){for(var i=elm.length-1;i>=0;i--)
if(elm[i].type=='button'){if(elm[i].name=='account'){elm[i].onclick=function(e){this.disabled=true;var aAccountInfo={aid:sPrimaryAccount,subscription:[aData.X_ICEWARP_SERVER_REQUEST.USER[0].VALUE]};WMAccounts.subscribe(aAccountInfo,[this,'__disable']);};elm[i].__disable=function(aResponse){try{if(aResponse.IQ[0].ERROR){gui.notifier._value({type:'alert',args:{header:'',text:'ERROR::SUBSCRIBE_ERROR',args:[aResponse.IQ[0].ERROR[0].VALUE]}});this.disabled=false;return;}
else{gui.notifier._value({type:'account_subscribed',args:[aData.X_ICEWARP_SERVER_REQUEST.USER[0].VALUE]});if(me.__aid&&me.__fid&&me.__iid){Item.remove([me.__aid,me.__fid,[me.__iid]],true);if(me._parent._type=='frm_mail')
me._parent._destruct();}}}
catch(r){this.disabled=false;}
accounts.refresh({'aid':sPrimaryAccount},'folders');};}
else
if(elm[i].name=='subscribe'){elm[i].__disable=function(bOK,aResponse,sType,sAccount,sFolder){try{if(bOK){gui.notifier._value({type:(!sFolder||sFolder=='*'?'ACCOUNT':'FOLDER')+'_'+(sType=='subscribe'?'SUBSCRIBED':'UNSUBSCRIBED'),args:[sAccount,sFolder]});if(bOK&&me.__aid&&me.__fid&&me.__iid){Item.remove([me.__aid,me.__fid,[me.__iid]],true);if(me._parent._type=='frm_mail')
me._parent._destruct();}}
else{gui.notifier._value({type:'alert',args:{header:'',text:'MAIL_VIEW::ERROR',args:[sAccount,sFolder]}});this.disabled=false;return;}}
catch(r){this.disabled=false;}
accounts.refresh({'aid':sPrimaryAccount},'folders');};elm[i].onclick=function(e){if(me.__aid&&me.__fid&&me.__iid){this.disabled=true;WMItems.action({aid:me.__aid,fid:me.__fid,iid:me.__iid},this.name,[this,'__disable',[this.name,aData.X_ICEWARP_SERVER_REQUEST.USER[0].VALUE,aData.X_ICEWARP_SERVER_REQUEST.FOLDER[0].VALUE]]);}};}}}}}}
else
if(aIMIP.length>0&&atmp&&(atmp.DTSTART||atmp['PERCENT-COMPLETE'])){aItem={aid:this.__aid,fid:this.__fid,iid:this.__iid};if(atmp.DTSTART){this._create('x_freebusy','obj_freebusy','block','');var freebusy_helper=mkElement('div',{className:'freebusy_helper'});this.x_freebusy._main.insertAdjacentElement('beforebegin',freebusy_helper);this.x_freebusy._obeyEvent('ondestruct',[function(){freebusy_helper.parentElement.removeChild(freebusy_helper);}]);this.x_freebusy._init({evnid:atmp.UID[0].VALUE,users:[sPrimaryAccount],});this.x_freebusy._readonly(true);this.x_freebusy._obeyEvent('oncollision',[function(_,args){if(args.arg){freebusy_helper.classList.add('collision');if(aTplData.imip_method==='COUNTER'||aTplData.imip_method==='REPLY'){freebusy_helper.innerHTML=getLang('MAIL_VIEW::FREEBUSY_BUSY');}else{freebusy_helper.innerHTML=getLang('MAIL_VIEW::FREEBUSY_BUSY_PROPOSE',['<a>'+getLang('MAIL_VIEW::PROPOSE')+'</a>']);freebusy_helper.querySelector('a').onclick=function(){var button=me.__doc.getElementsByTagName('form')[0].querySelector('input[name=propose]');button.onclick.call(button);};}}else{freebusy_helper.innerHTML=getLang('MAIL_VIEW::FREEBUSY_FREE');freebusy_helper.classList.remove('collision');}}]);this.x_freebusy._value({startdate:+atmp.DTSTART[0].ATTRIBUTES['X-CTZDATE'],starttime:Math.max(atmp.DTSTART[0].ATTRIBUTES['X-CTZTIME'],0),enddate:+(atmp.DTEND||atmp.DTDUE)[0].ATTRIBUTES['X-CTZDATE'],endtime:Math.max((atmp.DTEND||atmp.DTDUE)[0].ATTRIBUTES['X-CTZTIME'],0),title:atmp.SUMMARY?atmp.SUMMARY[0].VALUE:'',tzid:GWOthers.getItem('CALENDAR_SETTINGS','timezone')});}
for(var i in aIMIP){if((frm=this.__doc.getElementsByTagName('form')))
for(var i=0;i<frm.length;i++){elm=frm[i].getElementsByTagName('input');for(var j=0;j<elm.length;j++){if(elm[j].type!='button')continue;if(me.__aid!=sPrimaryAccount)
elm[j].disabled=true;else{elm[j].__disable=function(bOK,bObsolete,aItem,bRemove){if(((bOK&&bRemove)||bObsolete)&&aItem&&aItem.aid&&aItem.fid&&aItem.iid){Item.remove([aItem.aid,aItem.fid,[aItem.iid]],true);me.x_freebusy&&me.x_freebusy._destruct();if(me._parent._type=='frm_mail')
me._parent._destruct();if(!bObsolete)
gui.notifier._value({type:'event_'+({accept:"accepted",tentative:"unsure",decline:"declined",propose:'proposed'})[this.name]});}
else{var inp=this.form.querySelectorAll('input[type=button]');for(var i=inp.length;i--;)
inp[i].disabled=bOK&&inp[i]==this;}};elm[j].__imipID=i;elm[j].onclick=function(e){aItem.partid=this.form.partid.value;aItem.imip_type=this.form.imip_type.value;var name=this.name+(this.form.imip_method.value=='COUNTER'?'_counter':''),self=this;this.disabled=true;switch(this.name){case'decline':var frm=gui._create('decline','frm_text','','frm_ok_cancel',[function(s){aItem.reason=s;WMItems.imip(aItem,name,[self,'__disable',[aItem,true]]);}],'EVENT::REASON');frm._onclose=function(){self.disabled=false;return true;};frm.x_btn_ok._value('FORM_BUTTONS::DECLINE');break;case'propose':WMItems.action({aid:me.__aid,fid:me.__fid,iid:me.__iid+'|'+aItem.partid,attrs:{delete:1}},'importattachment',[function(bOK,xResponse){var aValues=WMItems.parse(xResponse);for(var aid in aValues)
for(var fid in aValues[aid]){delete aValues[aid][fid]['/'];delete aValues[aid][fid]['#'];delete aValues[aid][fid]['$'];delete aValues[aid][fid]['@'];for(var iid in aValues[aid][fid]){aValues=aValues[aid][fid][iid];Item.openwindow([aid,fid,iid],aValues,null,'E',{propose:true},[function(frm){frm._onclose=function(){self.disabled=false;return true;};frm.x_btn_ok._onclick=function(){if(frm._userEdited()){aItem.gwparams=frm.X_TIMEINTERVAL._value();WMItems.imip(aItem,'propose',[self,'__disable',[aItem,true]]);}
frm._destruct();};frm.x_btn_ok._disabled(false);}]);}}
self.__disable(bOK,aItem,true);}]);break;case'tentative':WMItems.imip(aItem,name,[this,'__disable',[aItem,false]]);break;default:WMItems.imip(aItem,name,[this,'__disable',[aItem,true]]);}};}}}}}}
this._header(aHeaders);if(!Is.Empty(this.__aImages)){storage.library('gw_others');if(parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','auto_show_images'))==1)
this.__showImages();else
this.__showImages(true);}
else
this.__showImages(true);}
catch(r){if(console)
console.log(r);}};

/* client/inc/obj_mailview_notify.js */
_me=obj_mailview_notify.prototype;function obj_mailview_notify(){};_me.__constructor=function(){if(gui.socket){this._add_destructor('__notify_off');this._notification(true);}};_me._notification=function(b){if(gui.socket)
if(b)
gui.socket.api._obeyEvent('onnotify',[this,'__notify']);else
this.__socket_off();};_me.__notify=function(aData){if(this._destructed)
return false;if(aData.owner&&aData.owner==this._pathName)
return;if(aData['TYPE']=='item'&&this.__aid==sPrimaryAccount&&this.__fid&&this.__fid==Path.slash(aData.FOLDER)){if(this._onnotify)
this._onnotify(aData);this.__exeEvent('onnotify',null,{"data":aData,"owner":this});}};_me.__notify_off=function(){if(gui.socket)
gui.socket.api._disobeyEvent('onnotify',[this,'__notify']);};

/* client/inc/obj_minismile.js */
_me=obj_minismile.prototype;function obj_minismile(){};_me.__constructor=function(aHandler){this._main.onclick=function(e){if(aHandler){var elm=e.target||e.srcElement;if(elm.tagName=='SPAN'&&!hascss(elm,'disabled')){executeCallbackFunction(aHandler,elm.getAttribute('rel'));if(this._onclose)
this._onclose();}}
this._hide(true);}.bind(this);};

/* client/inc/obj_month.js */
_me=obj_month.prototype;function obj_month(){};_me.__constructor=function(opt){var me=this;this.__timeout;this.__opt=opt||{};var aTemplateData={month_names:IcewarpDate.months().map(function(month,i){return{index:i,month:month};},this)};this._draw('obj_month','',aTemplateData);this.__eMain=this._getAnchor('main');this._create('_scrollbar','obj_scrollbar')._scrollbar(this.__eMain,this.__eMain.parentElement);this.__eMain.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(hascss(elm,'month')){var rel=elm.getAttribute('rel');if(Is.Defined(rel)){var dDate=me._dDate.clone();dDate.month(rel);me._value(dDate);}}};this.year._onchange=function(){var date=new IcewarpDate();if(date.calendar_type===IcewarpDate.Calendars.HIJRI&&(this._value()<1356||this._value()>1500)){return true;}
this._value()&&(me._dDate.year()!==this._value())&&me._setDate(this._value());return true;};this.year._fillYear=function(v){for(var aFill={},i=v-25,j=v+25;i<=j;i++)
aFill[i]=i;this._fill(aFill);};this.year._onkeydown=function(e){if((e.keyCode>47&&e.keyCode<58)||(e.keyCode>95&&e.keyCode<106)){var v=me.year._value();if(!v&&!(e.keyCode===49||e.keyCode===50||e.keyCode===97||e.keyCode===98)){return false;}
if(e.keyCode!==37&&e.keyCode!==39){if(me.__timeout){window.clearTimeout(me.__timeout);}
me.__timeout=window.setTimeout(function(){try{me.__setYear();}catch(e){gui._REQUEST_VARS.debug&&console.log(me._name||false,e);}},300);}
if(v&&v.length===4&&(e.target.selectionStart===e.target.selectionEnd)){return false;}
return true;}
else
return e.keyCode===8||e.keyCode===46||e.keyCode===37||e.keyCode===39;};this.left1._onclick=function(){if(me._dDate.year()>1||me._dDate.month()>0){me._dDate.subtract(1,'year');me.__draw();}};this.right1._onclick=function(){me._dDate.add(1,'year');me.__draw();};this.close._onclick=function(e){me._parent._destruct();};this._value(new IcewarpDate(),true);this._add_destructor('__destruct');};_me.__destruct=function(){if(this.__timeout)
window.clearTimeout(this.__timeout);};_me.__setYear=function(){var date=new IcewarpDate();this.year.__restrictions=[].slice.call(this.year.__restrictions);if(date.calendar_type===IcewarpDate.Calendars.HIJRI&&~!this.year.__restrictions.indexOf('<1500i')){this.year.__restrictions.push('<1500i');this.year.__restrictions.push('2');}
try{var year=parseInt(this.year._value());if(date.calendar_type!==IcewarpDate.Calendars.HIJRI||(year>1355&&year<1501)){this._setDate(year);}}catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}};_me._setDate=function(year,month){this._dDate.year(+(year||this._dDate.year())).month(+(month||this._dDate.month()));this.__draw();};_me._value=function(date,no_update){if(date){if(date instanceof IcewarpDate){this._dDate=date.clone();}else if(Is.Number(date)||(Is.String(date)&&!isNaN(parseInt(date)))){this._dDate=new IcewarpDate(date,{format:IcewarpDate.JULIAN});}else{this._dDate=new IcewarpDate(date);}
this._active=this._dDate.clone();this.__draw();if(!no_update){if(this._onchange)
this._onchange(this._dDate);this.__exeEvent('onchange',null,{"owner":this,"date":this._dDate});}}else{return this._active;}};_me.__draw=function(){var today=new IcewarpDate();this.year._fillYear(this._dDate.year());this.year._value(this._dDate.year(),true);while(this.__eMain.firstChild)
this.__eMain.removeChild(this.__eMain.firstChild);var elm,eActive;IcewarpDate.months().forEach(function(month,i){elm=mkElement('div',{rel:i,text:month,className:'month'});if(today.year()==this._dDate.year()&&today.month()==i)
addcss(elm,'today');if(this._dDate.month()==i){addcss(elm,'active');eActive=elm;}
this.__eMain.appendChild(elm);},this);if(eActive)
eActive.scrollIntoView({block:"nearest"});};

/* client/inc/obj_multistate_switch.js */
_me=obj_multistate_switch.prototype;function obj_multistate_switch(){}
_me.__constructor=function(values,callback){values&&this._fill(values);var me=this;var radio_down=false;this._getAnchor('radios').addEventListener('mousedown',function(e){var elm=e.target||e.srcElement;if(hascss(elm,'radio'))
radio_down=true;});this._getAnchor('radios').addEventListener('mouseup',function(e){var elm=e.target||e.srcElement;if(hascss(elm,'radio')&&radio_down)
me._value(elm.getAttribute('data-value'));radio_down=false;});this._getAnchor('minus').addEventListener('click',function(e){var prev=me._getAnchor('radios').querySelector('div.radio.active').previousSibling;if(prev){me._value(prev.getAttribute('data-value'));}});this._getAnchor('plus').addEventListener('click',function(e){var next=me._getAnchor('radios').querySelector('div.radio.active').nextSibling;if(next){me._value(next.getAttribute('data-value'));}});};_me._value=function(v,bNoSave){if(Is.Defined(v)){if(this.__value!=v){var active=this._main.querySelector('div.radio.active');if(active){active.className=active.className.replace('active','');}
this._getAnchor('radios').querySelector('div.radio[data-value="'+v+'"]').className+=' active';this.__value=''+v;if(this._onchange)
this._onchange(this.__value,bNoSave);this.__exeEvent('onchange',null,{"owner":this});}}else{return this.__value;}};_me._fill=function(aRadios){if(!Is.Array(aRadios))return;while(this._getAnchor('radios').firstChild){this._getAnchor('radios').removeChild(this._getAnchor('radios').lastChild);}
for(var i in aRadios){var radio=mkElement('div',{'data-value':aRadios[i].value,name:this._name+'-radio',title:aRadios[i].title,'class':'radio'});this._getAnchor('radios').appendChild(radio);}};

/* client/inc/obj_notifier.js */
_me=obj_notifier.prototype;function obj_notifier(){};_me.__constructor=function(list){if(!list){return;}
var notification_icon=gui.frm_main.notifications._main.querySelector('li.notifier a');var count=notification_icon.querySelector('div.count');if(count){addcss(count,'hidden');count.textContent=0;}
this._create('scrollbar','obj_scrollbar')._scrollbar(this._main);gui.notifier.__saved=gui.notifier.__saved.map(function(saved){saved.time=this.__getTime(saved.id);saved.viewed=true;return saved;},this);this._draw('obj_notifier','main',{notifications:gui.notifier.__saved});[].forEach.call(this._main.querySelectorAll('li'),function(li){li.addEventListener('click',function(event){var id=li.getAttribute('data-id');var onclick=(gui.notifier.__saved.filter(function(saved){return saved.id===+id;})[0]||{}).onclick;onclick&&onclick();});});};_me.__getTime=function(time){var date=new Date(time);var diff=Math.floor((new Date()-date)/1000);if(diff<10){return getLang('NOTIFICATION::NOW');}else if(diff<60){return getLang(diff===1?'NOTIFICATION::SECOND_AGO':'NOTIFICATION::SECONDS_AGO',[diff]);}else if(diff<60*60){var minutes=Math.floor(diff/60);return getLang(minutes===1?'NOTIFICATION::MINUTE_AGO':'NOTIFICATION::MINUTES_AGO',[minutes]);}else if(diff<60*60*12){var hours=Math.floor(diff/60/60);return getLang(hours===1?'NOTIFICATION::HOUR_AGO':'NOTIFICATION::HOURS_AGO',[hours]);}else if(diff<60*60*24){return getLang('NOTIFICATION::TODAY_AT',[(new IcewarpDate(date)).format('HH:mm')]);}else if(diff<60*60*24*2){return getLang('NOTIFICATION::YESTERDAY_AT',[(new IcewarpDate(date)).format('HH:mm')]);}else{return(new IcewarpDate(date)).format('YYYY-MM-DD HH:mm:ss');}};_me._clear_notifications=function(){this.__saved=[];};_me.closeNotification=function(notification){clearTimeout(notification.timeout);clearInterval(notification.interval);var event=browserEvent('transitionend');if(event){var transition_callback=function(){if(!notification.element||!notification.element.parentNode){return;}
notification.element.removeEventListener(event,transition_callback);notification.element.parentNode.removeChild(notification.element);};notification.element.addEventListener(event,transition_callback);notification.element.classList.add('closing');setTimeout(function(){notification.element.parentNode&&notification.element.parentNode.removeChild(notification.element);},400);}else{notification.element.parentNode.removeChild(notification.element);}
this.notifications=this.notifications.filter(function(notif){return notif!==notification;});};_me._value2=function(v,aArg){this.notifications=this.notifications||[];var notification={element:mkElement('div',{className:'container'},false,[mkElement('div',{className:'notification '+(v.type||''),onclick:function(){if(v.onclick){v.onclick();this.closeNotification(notification);}}.bind(this),onmouseenter:function(){if(!v.args.interval){clearTimeout(notification.timeout);}}.bind(this),onmouseleave:function(){if(!~this.__sticky.indexOf(v.type)){notification.timeout=setTimeout(function(){this.closeNotification(notification);}.bind(this),2000);}}.bind(this)},false,[mkElement('div',{className:'icon'+(v.avatar?' avatar':'')},false,v.avatar?[mkElement('img',{src:v.avatar,className:'avatar'})]:false),mkElement('div',{className:'content'},false,[v.header&&mkElement('div',{className:'header',title:v.header,text:v.header}),v.text&&mkElement('div',{className:'text',innerHTML:v.html}),v.subtext&&mkElement('div',{className:'subtext',text:v.subtext})].filter(Boolean)),v.buttons?mkElement('div',{className:'right'},false,[mkElement('div',{className:'buttons'},false,v.buttons.map(function(button){return mkElement('div',{className:'button'+(button.className?' '+button.className:'')},false,mkElement('div',{className:'button_label',text:button.text,onclick:function(){this.closeNotification(notification);button.onclick();}.bind(this)}));},this))]):mkElement('div',{className:'close',onclick:function(){this.closeNotification(notification);}.bind(this)})].filter(Boolean))])};this._main.insertBefore(notification.element,this._main.firstChild);if(this.__sticky.indexOf(v.type)===-1){notification.timeout=setTimeout(function(){this.closeNotification(notification);}.bind(this),5000);}
if(v.args&&v.args.interval){var timeleft=v.args.interval;notification.interval=setInterval(function(){switch(v.type){case'send_message':notification.element.querySelector('.text').innerHTML=this.__getNotificationText(v.type,{interval:--timeleft},true);}
if(timeleft<=0){v.args.callback.success.call(v.args.callback.context);this.closeNotification(notification);}}.bind(this),1000);}
this.notifications.push(notification);};_me.__sticky=['conference_invite','send_message'];_me.__saved=[];_me.__getNotificationHeader=function(type,args){switch(type){case'im':return dataSet.get('xmpp',['roster',args.jid,'name'])||args.jid;case'teamchat':return args.data['ORIGINATOR-NAME']||args.data.NAME||args.data['ORIGINATOR-EMAIL']||args.data.EMAIL;case'sip':return getLang((args||{}).header?args.header:'SIP::SIP');case'document_added':case'document_edited':return args['ORIGINATOR-NAME']||args['ORIGINATOR-EMAIL'];case'alert':return getLang((args||{}).header?args.header:'ALERTS::ALERT');case'success':default:return(args||{}).header?getLang(args.header):'';}};_me.__getNotificationButtons=function(type,args){switch(type){case'conference_invite':return[{className:'accept',text:getLang('EVENT::JOINCONFERENCE'),onclick:function(){storage.library('wm_conference');wm_conference.get(args[0]).join();}},{className:'decline',text:getLang('FORM_BUTTONS::DECLINE'),onclick:function(){}}];case'send_message':return[{className:'clear',text:getLang('FORM_BUTTONS::UNDO'),onclick:function(){args.callback.cancel.call(args.callback.context);}}];case'message_sent':case'send_message_deferred':return(sPrimaryAccountDELIVERY&&args[0])?[{className:'clear',text:getLang('ITEMVIEW::DETAILS'),onclick:function(){gui._create('frm_delivery','frm_delivery','','','',args[0]);}}]:false;}};_me.__getNotificationText=function(type,args,bHTML){var langBold=false,langKey='NOTIFICATION::'+type,langArr=args,sOut='';switch(type){case'conference':sOut=args.text||'';langKey=args[0];break;case'item_saved':var folder=dataSet.get('folders',[args[0]||args.aid,args[1]||args.fid]);if(folder&&folder.TYPE&&!folder.VIRTUAL){switch(folder.TYPE){case'F':case'C':case'E':langKey='NOTIFICATION::ITEM_SAVED_'+folder.TYPE;break;default:langKey='NOTIFICATION::ITEM_SAVED_TO';break;}
langArr=[folder.NAME||folder.RELATIVE_PATH];langBold=true;}
break;case'new_email':case'invitation_sent':langBold=true;break;case'reminder':var formattedStartDate=CalendarFormatting.formatStartDate(args[0]);formattedStartDate=(formattedStartDate==='')?'':' ('+formattedStartDate+')';langArr=[args[0].title,formattedStartDate];break;case'send_message_deferred':langArr=["\r\n"+args[1].format('L'),args[1].format('LT')];langBold=true;break;case'send_message':langArr=[args.interval];langBold=true;break;case'document_added':sOut=getLang('NOTIFICATION::DOCUMENT_ADDED',[args.data.EVNTITLE]);break;case'document_edited':sOut=getLang('NOTIFICATION::DOCUMENT_EDITED',[args.data.EVNTITLE]);break;case'teamchat':case'im':case'sip':case'alert':default:if(args.text_plain){sOut=this.__substituteMentions(args.text_plain,(args.data||{}).MENTIONS);}else if(args.text){langKey=args.text;langArr=args.args;}
break;}
if(bHTML){if(sOut.length)
return sOut.toString().escapeHTML().wrap();else
if(Is.Array(langArr)){langArr=langArr.map(function(v){v=v.toString();if(v.length){v=v.escapeHTML().wrap();if(langBold)
v='<b>'+v+'</b>';}
return v;});}}else
if(sOut.length)
return sOut;return getLang(langKey.toUpperCase(),langArr,2);};_me.__getNotificationSubtext=function(type,args){switch(type){case'im':return getLang('NOTIFICATION::IM_HELPER');case'teamchat':return getLang('NOTIFICATION::TEAMCHAT_HELPER',[this.__getRoomName(args.data.FOLDER)]);case'document_added':case'document_edited':return this.__getRoomName(args.FOLDER);}};_me.__getRoomName=function(folder){var room_name='';if(folder){var folders=dataSet.get('folders',[sPrimaryAccount]);for(var i in folders){if(Path.slash(folders[i].RELATIVE_PATH)===Path.slash(folder)){room_name=Path.slash(folders[i].NAME||folders[i].RELATIVE_PATH).split('/').pop();break;}}}
return room_name;};_me.__getNotificationAvatar=function(type,args){switch(type){case'im':return getAvatarURL(args.jid);case'teamchat':case'sip_canceled':return getAvatarURL(args.data['ORIGINATOR-EMAIL']||args.data.EMAIL);case'document_added':case'document_edited':return getAvatarURL(args['ORIGINATOR-EMAIL']);}};_me.__getNotificationAction=function(type,args){switch(type){case'im':return function(){gui.frm_main.im._activate(args.jid);gui.frm_main.im._chat(args.jid);};case'teamchat':return function(){var folder=Path.slash(args.data.FOLDER),aFolders=dataSet.get('folders',[sPrimaryAccount]);if(folder&&args&&args.data&&args.data.EMAIL)
for(var fid in aFolders)
if(aFolders[fid].OWNER===args.data.EMAIL&&aFolders[fid].RELATIVE_PATH===folder){gui.frm_main.bar.tree.folders._setActive(sPrimaryAccount+'/'+fid);gui.frm_main._selectView({aid:sPrimaryAccount,fid:fid});gui.frm_main.filter.__filter('I');break;}};case'document_added':case'document_edited':return function(){var sFolder,folders=dataSet.get('folders',[sPrimaryAccount]);for(var sFolder in folders){if(((args.EMAIL===sPrimaryAccount&&!folders[sFolder].OWNER)||(folders[sFolder].OWNER===args.EMAIL))&&folders[sFolder].RELATIVE_PATH===Path.slash(args.FOLDER)){break;}}
gui.frm_main.bar.tree.folders._setActive(sPrimaryAccount+'/'+sFolder);gui.frm_main._selectView({aid:sPrimaryAccount,fid:sFolder});gui.frm_main.filter.__filter(folders[sFolder].TYPE);};}};_me.__getNotificationType=function(type,args){switch(type){case'item_saved':var folder=dataSet.get('folders',[args[0],args[1]]);if(folder&&folder.TYPE){switch(folder.TYPE){case'F':return'folder_subscribed';case'C':return'invitation_sent';}}
break;case'document_added':case'document_edited':var sExtension=(args.data.EVNTITLE.split('.').pop()||'').toLowerCase();switch(sExtension){case'doc':case'dot':case'docx':case'docm':case'dotx':case'dotm':case'docb':case'odt':case'rtf':type='document';break;case'xls':case'csv':case'xlsx':case'xla':case'xlam':case'xlsb':case'ods':case'xlsb':case'xlsm':case'xlt':case'xltm':case'xltx':type='spreadsheet';break;case'ppt':case'pptx':case'odp':case'pps':case'ppsm':case'ppsx':case'pptm':case'ppa':case'ppam':type='presentation';break;case'pdf':type='pdf';default:type='file';break;}
return type;}
return type;};_me.__getNotificationData=function(type,args){args=args||[];return{type:this.__getNotificationType(type,args),onclick:this.__getNotificationAction(type,args),avatar:this.__getNotificationAvatar(type,args),header:this.__getNotificationHeader(type,args),text:this.__getNotificationText(type,args),html:this.__getNotificationText(type,args,true),buttons:this.__getNotificationButtons(type,args),subtext:this.__getNotificationSubtext(type,args),args:args};};_me.__getFirstLine=function(aOptions){switch(aOptions.type){case'teamchat':return'<b>'+(aOptions.args.data['ORIGINATOR-NAME']||aOptions.args.data.NAME||aOptions.args.data['ORIGINATOR-EMAIL']||aOptions.args.data.EMAIL).escapeHTML()+'</b>';case'sip_canceled':return'<b>'+(aOptions.args.data.NAME||aOptions.args.data.EMAIL).escapeHTML()+'</b> <i>'+getLang('NOTIFICATION::MISSED_CALL')+'</i>';case'document_added':return getLang('NOTIFICATION::ADDED_DOCUMENT',['<b>'+(aOptions.args['ORIGINATOR-NAME']||aOptions.args['ORIGINATOR-EMAIL']).escapeHTML()+'</b>','<i>'+aOptions.args.data.EVNTITLE.escapeHTML()+'</i>']);case'document_edited':return getLang('NOTIFICATION::EDITED_DOCUMENT',['<b>'+(aOptions.args['ORIGINATOR-NAME']||aOptions.args['ORIGINATOR-EMAIL']).escapeHTML()+'</b>','<i>'+aOptions.args.data.EVNTITLE.escapeHTML()+'</i>']);}
return'';};_me.__getSecondLine=function(aOptions){switch(aOptions.type){case'teamchat':return this.__substituteMentions(aOptions.args.text_plain,aOptions.args.data.MENTIONS).escapeHTML();}
return'';};_me.__substituteMentions=function(text,mentions){text=text||'';if(!mentions){return text;}
var aMentions=parseParamLine(mentions),aMen={};for(var id in aMentions){aMen[aMentions[id].values.EMAIL]={name:aMentions[id].values.NAME,email:aMentions[id].values.EMAIL};}
return text.replace(/(@\[([^\]]{1,128})\])/g,function(){var name=arguments[2],email=name.indexOf('@')>-1?name:name+'@'+dataSet.get('main',['domain']);if(aMen[email]){name=aMen[email].name||aMen[email].email;}
return'@'+name;});};_me.__getIcon=function(aOptions){switch(aOptions.type){case'document_added':case'document_edited':return aOptions.data.type;}
return aOptions.type;};_me._value=function(aOptions){var should_update_count=true;if(!aOptions||!aOptions.type){return;}
var iSetting=parseInt(GWOthers.getItem('LAYOUT_SETTINGS','notifications')||0,10);aOptions.type=aOptions.type.toLowerCase();aOptions.timeout=(parseInt(aOptions.timeout||3,10)||3)*1000;aOptions.data=this.__getNotificationData(aOptions.type,aOptions.args);aOptions.data.group=aOptions.group;if(aOptions.save){if(aOptions.group){this.__saved=this.__saved.filter(function(notification){if(notification.group===aOptions.group){if(!notification.viewed){should_update_count=false;}
return false;}
return true;});}
aOptions.data.id=+new Date();aOptions.data.room=this.__getRoomName(aOptions.args.FOLDER||aOptions.args.data.FOLDER);aOptions.data.icon=this.__getIcon(aOptions);aOptions.data.first_line=this.__getFirstLine(aOptions);aOptions.data.second_line=this.__getSecondLine(aOptions);this.__saved.unshift(aOptions.data);var notification_icon=gui.frm_main.notifications._main.querySelector('li.notifier a');var count=notification_icon.querySelector('div.count');var amount=0;if(count){amount=count.textContent;}
else{count=mkElement('div',{className:'count'});notification_icon.appendChild(count);}
if(should_update_count){amount=amount==='99+'?100:++amount;}
count.textContent=amount>99?'99+':amount;window[amount>0?'removecss':'addcss'](count,'hidden');}
if(window.Notification&&(iSetting==1||(iSetting==0&&!gui.__focus)))
if(this._value3(aOptions.data.header||aOptions.data.subtext||' ',aOptions.data.text,aOptions.aHandler,aOptions.timeout,aOptions.group)!==false&&this.__sticky.indexOf(aOptions.type)===-1)
return;this._value2(aOptions.data,aOptions.aHandler,aOptions.timeout);};_me._value3=function(sTitle,sBody,aHandler,iTime,sGroup){if(window.Notification){if(!window.Notification.permission&&window.webkitNotifications&&window.webkitNotifications.checkPermission)
window.Notification.permission=(['granted','default','denied'])[window.webkitNotifications.checkPermission()];if(window.Notification.permission=='granted'){if(sTitle&&!sBody&&GWOthers.getItem('LAYOUT_SETTINGS','title')){sBody=sTitle;sTitle=GWOthers.getItem('LAYOUT_SETTINGS','title');}
var arg={body:sBody||'',dir:"auto",tag:sGroup,icon:'./client/skins/default/images/logo.png'};var n=new Notification(sTitle||getLang('PRELOADER::LOADING'),arg);n.onclick=function(){window.focus();if(aHandler)
try{executeCallbackFunction(aHandler);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
window.focus();this.close();};n.onshow=function(){this._date=new IcewarpDate();if(iTime)
setTimeout(function(){n.close();},iTime);};return n;}else
if(window.Notification.permission=='denied')
return false;else
if(!this.__permission){this.__permission=true;var me=this;this._setPermissions([function(perm){if(perm=='granted')
me._value3(sTitle,sBody,aHandler,iTime,sGroup);}]);return true;}}else
return false;};_me._getPermissions=function(){if(window.Notification){if(!window.Notification.permission&&window.webkitNotifications&&window.webkitNotifications.checkPermission)
window.Notification.permission=(['granted','default','denied'])[window.webkitNotifications.checkPermission()];return window.Notification.permission;}else
return'unsupported';};_me._setPermissions=function(aHandler){if(this._getPermissions()=='denied'){gui._create('ask_notify','frm_alert','','',[function(){if(aHandler)
executeCallbackFunction(aHandler,'denied');}],'NOTIFIER::NOTIFIER','NOTIFIER::DENIED');}else
if(this._getPermissions()!='granted'){gui._create('ask_notify','frm_confirm_select','','',[function(v){GWOthers.setItem('LAYOUT_SETTINGS','notifications',v,true);GWOthers.save();if(v!=2)
window.Notification.requestPermission(function(perm){window.Notification.permission=perm;if(aHandler)
executeCallbackFunction(aHandler,perm);});}],'NOTIFIER::NOTIFIER','NOTIFIER::PERMISSIONS','',[getLang('SETTINGS::NOFOCUS'),getLang('SETTINGS::ALWAYS'),getLang('SETTINGS::NEVER')],GWOthers.getItem('LAYOUT_SETTINGS','notifications')||'0');}};

/* client/inc/obj_phone.js */
_me=obj_phone.prototype;function obj_phone(){this.__disabled=false;};_me.__constructor=function(){this.__data={};var aData=storage.aStorage.language['PHONE'];var me=this;this.PHNTYPE._fill(aData);this.PHNTYPE._onchange=function(){var data=me._listener?dataSet.get(me._listener,me._listenerPath):this.__data;if(data){if(this._value()=='SIP'){if(data.LCTPHNOTHER&&data.LCTPHNOTHER.toLowerCase().indexOf('sip:')==0)
me.PHNNUMBER._value(data.LCTPHNOTHER.substring(data.LCTPHNOTHER.indexOf(':')+1),true);else
me.PHNNUMBER._value('',true);}
else
me.PHNNUMBER._value(data[this._value()]||'',true);}
me.PHNNUMBER._sms(this._value()=='LCTPHNMOBILE');};this.PHNNUMBER.inp._onblur=function(){if(!me._destructed){var n=me.PHNTYPE._value(),v=me.PHNNUMBER._value()||'';if(n=='SIP'){n='LCTPHNOTHER';if(v.length)
v='sip:'+v;}
if(me._listener)
dataSet.add(me._listener,(me._listenerPath||[]).concat(n),v);else
me.__data[n]=v;}};};_me.__update=function(sDSName,aDSPath){var t=this.PHNTYPE._value();t=t=='SIP'?'LCTPHNOTHER':t;if(aDSPath&&aDSPath.slice(-1)[0]===t){var n=dataSet.get(this._listener,(this._listenerPath||[]).concat(t));if(n!=this.PHNNUMBER._value())
this.PHNNUMBER._value(n||'',true);}};_me._value=function(sName,aData){if(sName){if(typeof aData=='object')
this.__data=aData;if(sName=='LCTPHNOTHER'&&(this.__data[sName]||'').toLowerCase().indexOf('sip:')==0)
this.PHNTYPE._value('SIP',true);else
this.PHNTYPE._value(sName.toUpperCase(),true);this.PHNTYPE._onchange();}
else
return{PHNTYPE:this.PHNTYPE._value(),PHNNUMBER:this.PHNNUMBER._value(),DATA:this._listener?dataSet.get(this._listener,this._listenerPath):this.__data};};_me._readonly=function(bReadOnly){if(typeof bReadOnly=="undefined")
return this.__readonly;else{this.__readonly=bReadOnly?true:false;this.PHNTYPE._disabled(bReadOnly);this.PHNNUMBER._readonly(bReadOnly);}};_me._disabled=function(bDisable){if(typeof bDisable=="undefined")
return this.__disabled;else{this.__disabled=bDisable?true:false;this.PHNTYPE._disabled(bDisable);this.PHNNUMBER._disabled(bDisable);}};_me._tabIndex=function(sContainer,i,oDock){this.PHNNUMBER._tabIndex(sContainer,i,oDock);this.PHNTYPE._tabIndex(sContainer,i?++i:i,oDock);};_me._focus=function(b){return this.PHNNUMBER._focus(b);};

/* client/inc/obj_phone_suggest.js */
_me=obj_phone_suggest.prototype;function obj_phone_suggest(){};_me.__constructor=function(){this.__activeFirst=true;this._limit=15;this._useCookie=false;this.plus&&this.plus.__eIN&&this.plus.__eIN.setAttribute('placeholder',getLang('POPUP_ITEMS::ENTER_PHONE_NUMBER'));};_me._query=function(v){this.__last_qdata=v;var aFilter={search:'has:mobile AND (classify:"'+v.replace(/"/g,'\\"')+'" OR title:"'+v.replace(/"/g,'\\"')+'" OR name:"'+v.replace(/"/g,'\\"')+'" OR phone:"'+v.replace(/"/g,'\\"')+'")',sort:'ITMCLASSIFYAS,ITMFIRSTNAME,ITMSURNAME',limit:this._limit};WMItems.list({'aid':sPrimaryAccount,'fid':"__@@ADDRESSBOOK@@__",'values':['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTPHNMOBILE'],'filter':aFilter},'','','',[this,'_parse']);};_me._parse=function(aValues){if(!aValues){this.__show();return;}
this.__eActive=null;this.__sQuery_data='';if(Is.Empty(aValues))return;for(var aid in aValues)
for(var fid in aValues[aid]);if(aid&&fid)
aValues=aValues[aid][fid];else
return;delete aValues['/'];delete aValues['#'];delete aValues['$'];delete aValues['@'];var emails=[],found,name;for(var i in aValues){name=aValues[i].ITMCLASSIFYAS||((aValues[i].ITMFIRSTNAME||'')+(aValues[i].ITMSURNAME?' '+aValues[i].ITMSURNAME:''));for(var j in aValues[i])
if((j.indexOf('LCTPHN')===0)&&aValues[i][j]){found=false;for(var k in emails)
if(emails[k].email.toLowerCase()==aValues[i][j].toLowerCase()){found=true;break;}
if(!found)
emails.push({name:name,email:aValues[i][j]});}}
function sc(a,b){var x=(a.name||'')+a.email;var y=(b.name||'')+b.email;if(x>y)
return 1;else
if(x<y)
return-1;else
return 0;};emails=emails.sort(sc);var out=[],MSIE=currentBrowser()=='MSIE7';for(var i in emails){name=emails[i].name;email=emails[i].email;if((!name||emails[i].dlist||this.__last_qdata.name==name)&&(!email||this.__last_qdata.email==email))
continue;if(email.indexOf('[')===0)
out.push(MSIE?email:{value:email,css:'avatar'});else
out.push(MSIE?MailAddress.createEmail(name,email):{value:MailAddress.createEmail(name,email),css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(email)+'\')"></span>'});}
if(out.length)
this.__show(out);else
this.__hide();};_me._decode=function(v){var aOut=[],tmp=MailAddress.splitEmails(v);for(var i=0;i<tmp.length;i++)
aOut.push({tag:tmp[i]});return aOut;};_me._encode=function(a){var aOut=[],aUnq={};for(var i in a)
if((a[i]=a[i].trim())&&!aUnq[a[i]]){aOut.push(a[i]);aUnq[a[i]]=true;}
return aOut.join(',');};

/* client/inc/obj_player.js */
_me=obj_player.prototype;function obj_player(){};_me.__constructor=function(){this.__seekable=false;this.btn_play._onupdate=function(aData){switch(aData.action){case'timerupdate':if(aData.value){var st=IcewarpDate.unix(Math.ceil(aData.value.currentTime)).format('mm:ss');if(!this._parent.timeline.__mousedn)
this._parent.timeline._value(aData.value.currentTime);this._parent.lbl_time._value(st);}
case'durationchange':if(aData.value){this._parent.timeline._range(Math.floor(aData.value.duration));this._parent.__seekable=true;}
break;case'ended':this._parent.lbl_time._value('00:00');this._parent.timeline._value(0);break;}};var cursor=mkElement('div',{className:'text'});this.timeline._main.appendChild(cursor);this.timeline._onmousemove=function(e){var r=this._range();if(this._parent.__seekable&&r>1){var pos=getSize(this._main);if(e.clientX>=pos.x&&e.clientX<=pos.x+pos.w){var st=IcewarpDate.unix(Math.round(r*((e.clientX-pos.x)/(pos.w)))).format('mm:ss');cursor.style.left=(e.clientX-pos.x)+'px';cursor.innerHTML='<span>'+st+'</span>';this.__seekto=(e.clientX-pos.x)/(pos.w/100);if(this.__mousedn)
this._parent.timeline._value((r*((e.clientX-pos.x)/(pos.w))));}}
else
cursor.innerHTML='';};this.timeline._onmousedown=function(e){if(this._parent.__seekable){var pos=getSize(this._main);if(e.clientX>=pos.x&&e.clientX<=pos.x+pos.w){this._parent.btn_play._pause();this.__mousedn=true;this._onmousemove(e);gui._obeyEvent('mouseup',[this._parent,'__dispatch']);}}};};_me.__dispatch=function(){this.timeline.__mousedn=false;if(this.__seekable)
this.btn_play._seek(this.timeline.__seekto);return false;};_me._disabled=function(b){return this.btn_play._disabled(b);};_me._value=function(aData){if(Is.Array(aData)){this.btn_play._src(aData[0].src,aData[0].title);this.lbl_title._value(aData[0].title);}};_me._src=function(s){return this.btn_play._src(s);}
_me._title=function(s){this.lbl_title._value(s);return this.btn_play._title(s);};

/* client/inc/obj_popup.js */
_me=obj_popup.prototype;function obj_popup(){};obj_popup._oldPositioning=currentBrowser()=='MSIE7'||(navigator&&navigator.browser&&navigator.browser.engine=='WebKit');obj_popup.activeStack={__stack:[],add:function(obj){this.remove(obj);this.__stack.unshift(obj);return true;},remove:function(obj){for(var i=this.__stack.length;i--;)
if(this.__stack[i]===obj){this.__stack.splice(i,1);return true;}},focusNext:function(){var obj=this.get();return obj&&obj._focus&&obj._focus();},get:function(id){return this.__stack[id||0];},order:function(){for(var i=0,j=this.__stack.length;i<j;i++)
if(this.__stack[i]&&this.__stack[i]._isModal()&&this.__stack[i]._focus){this.__stack[i]._focus();break;}}};AttachEvent(document,"onkeydown",function(e){if(e&&e.keyCode==27){var p=obj_popup.activeStack.get();if(p){if((e.target.nodeName==='INPUT'||e.target.nodeName==='TEXTAREA')){if(!p._docked&&!p.__hidden&&p.__closable&&p._main.contains(e.target)){p._close(true,e);}}
else
if(!p._docked&&!p.__hidden&&p.__closable){p._close(true,e);}}}});_me.__constructor=function(owner){this._owner=owner;this.__resizable=true;this.__closable=true;this.__dockable=true;this.__moveble=true;this.__zindex;this.__position={};this.__positionShadow={};this.__hidden=false;var me=this;this._mydock;this.__eTitle=this._getAnchor('title_text');this.__eContainer=this._getAnchor('container');this.__eMain=this._getAnchor('main');this.__eContainer.style.zIndex=this.__zindex=maxZIndex.get();obj_popup.activeStack.add(this);this._add_destructor('_onclose');this._add_destructor('__destructor');var sResize;this.__eContainer.onmousemove=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(this!==elm||!me.__resizable||me.__position.max){this.style.cursor='default';return;}
var elmleft=me.__positionShadow.x,elmtop=me.__positionShadow.y,elmwidth=elm.offsetWidth,elmheight=elm.offsetHeight;if(e.clientX-elmleft<9){if(e.clientY-elmtop<9){this.style.cursor='nwse-resize';sResize='lt';}
else
if((elmtop+elmheight)-e.clientY<9){this.style.cursor='nesw-resize';sResize='lb';}
else{this.style.cursor='ew-resize';sResize='l';}}
else
if((elmleft+elmwidth)-e.clientX<9){if(e.clientY-elmtop<9){this.style.cursor='nesw-resize';sResize='rt';}
else
if((elmtop+elmheight)-e.clientY<9){this.style.cursor='nwse-resize';sResize='rb';}
else{this.style.cursor='ew-resize';sResize='r';}}
else{this.style.cursor='ns-resize';if(e.clientY-elmtop<8)
sResize='t';else
if((elmtop+elmheight)-e.clientY<8)
sResize='b';}};this.__eContainer.onmouseout=function(e){this.style.cursor='default';};function dispatch(e){me.__hideBlock();gui._disobeyEvent('mousemove',[me,'__move_handler']);if(me._onresize_end)
me._onresize_end();return false;};if(currentBrowser()=='MSIE7')
this.__eContainer.ondblclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;switch(elm.id){case me._anchors['top']:case me._anchors['title']:me._maximize();if(me._onresize)me._onresize(e,'max');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'max'});return;case me._pathName+'#ico':me._close(true,e);}};this.__eContainer.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement,disp=false,bStop=false;me._focus();if(this===elm){if(!me.__resizable||me.__position.max)
return;me.__resize(e,sResize);disp=true;}
else
switch(elm.id.substr(me._pathName.length)){case'#top':case'#title_text':case'#title':if(!this.ondblclick)
var t=+new IcewarpDate();if(this.__lastClick&&this.__lastClick+600>t){this.__lastClick=0;me._maximize();if(me._onresize)me._onresize(e,'max');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'max'});return;}
else
this.__lastClick=t;if(!me.__moveble)return;me.__showBlock('m');var difX=e.clientX-me.__positionShadow.x,difY=e.clientY-me.__positionShadow.y;if(me.__move_handler)
gui._disobeyEvent('mousemove',[me,'__move_handler']);me.__move_handler=function(e){me._place(e.clientX-difX,e.clientY-difY);};gui._obeyEvent('mousemove',[me,'__move_handler']);if(me._onmove)
me._onmove(e);disp=true;break;case'#max':if(e.button<2){me._maximize();if(me._onresize)me._onresize(e,'max');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'max'});}
bStop=true;break;case'#min':if(!me._isModal()&&e.button<2)
me._dock();bStop=true;break;case'#ico':if(this.ondblclick)
break;else
{var t=+new IcewarpDate();if(!this.__lastClick||this.__lastClick+600<t){this.__lastClick=t;break;}}
case'#rem':if(me.__closable&&e.button<2)
me._close(true,e);bStop=true;break;}
if(disp||bStop){document.onclick({type:'click','clientY':e.clientY,'clientX':e.clientX,'target':elm});if(disp)
gui._obeyEvent('mouseup',[dispatch,[e]]);if(bStop){e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();}
return false;}};this.__eContainer.onmouseup=function(e){if(!Is.Child(e.target,me.__eMain))
if(!me._preventfocus&&me._activeElement){if(document.activeElement!=me._activeElement)
me._activeElement.focus();}
else
document.activeElement&&document.activeElement.blur&&document.activeElement.blur();};this.__eMain.scrollTop=0;this.__eContainer.scrollTop=0;this._activeElement=null;if(document.addEventListener){this.__eContainer.addEventListener('focus',function(e){var elm=e.target;if(elm.nodeName=='DIV'&&elm.getElementsByTagName('iframe').length){elm=elm.getElementsByTagName('iframe')[0];elm=elm.contentWindow.document.body;}
if(elm.nodeName=='BODY'||(('onfocus'in elm)&&elm.getAttribute('iw-focus')!='false'))
me._activeElement=elm;},true);}
obj_popup.activeStack.order();gui._obeyEvent('resize',[this,'__checkPosition']);AttachEvent(this._main,"onfocusin",function(e){me._activate();});};_me._dockable=function(b){this._getAnchor('min').style.display=(this.__dockable=(b?true:false))?'':'none';};_me._resizable=function(b){this._getAnchor('max').style.display=(this.__resizable=(b?true:false))?'':'none';};_me._closable=function(b){if((this.__closable=b?true:false))
removecss(this._getAnchor('rem'),'dim');else
addcss(this._getAnchor('rem'),'dim');};_me._moveble=function(b){this.__moveble=b?true:false;};_me._autofocusfields=function(b){this._preventfocus=!b;};_me._fullscreen=function(elm){if(!elm)
elm=this._getAnchor('box')||this.__eMain;var fullelm=this._isfullscreen();var fullscreen=elm.requestFullscreen||elm.msRequestFullscreen||elm.mozRequestFullScreen||elm.webkitRequestFullscreen;if(fullscreen&&!fullelm){fullscreen.apply(elm);if(fullelm=this._isfullscreen())
fullelm.onkeydown=function(e){e.stopPropagation();};}else if(fullelm){var exit=document.exitFullscreen||document.msExitFullscreen||document.mozCancelFullScreen||document.webkitExitFullscreen;exit.apply(document);}};_me._isfullscreen=function(){return document.fullscreenElement||document.msFullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement;};_me.__onCreateChild=function(sName,sType,sTarget){if(sTarget=='footer'||sTarget=='header'){var elm=this._getAnchor(sTarget);elm.style.display='block';this._getAnchor('box').style[sTarget=='header'?'paddingTop':'paddingBottom']=elm.offsetHeight+'px';elm=null;}};_me.__onDestroyChild=function(sName,sType,sTarget){if(sTarget=='footer'||sTarget=='header'){if(this._getChildObjects(sTarget).length>0)
this._getAnchor('box').style[sTarget=='header'?'paddingTop':'paddingBottom']=this._getAnchor(sTarget).offsetHeight+'px';else{this._getAnchor(sTarget).style.display='none';this._getAnchor('box').style[sTarget=='header'?'paddingTop':'paddingBottom']=0;}}};_me.__hide=function(){this.__eContainer.style.zIndex=-1000;this.__hidden=true;if(this._isModal()){this.__modaldiv.style.display='none';}
obj_popup.activeStack.remove(this);obj_popup.activeStack.focusNext();this.__exeEvent('onhide','',{"owner":this});};_me.__show=function(){this.__eContainer.style.zIndex=this.__zindex;this.__hidden=false;if(this._isModal()){this.__modaldiv.style.display='block';}
obj_popup.activeStack.add(this);this.__exeEvent('onshow','',{"owner":this});};_me.__showBlock=function(sResize){if(!this.__maskDIV){this.__maskDIV=mkElement('div',{className:'obj_popup_mask'});var me=this;this.__maskDIV.onclick=function(){me.__hideBlock();};document.getElementsByTagName('body')[0].appendChild(this.__maskDIV);}
if(sResize)
this.__maskDIV.style.cursor={m:'Move',tl:'se-resize',lb:'sw-resize',l:'w-resize',rt:'sw-resize',rb:'se-resize',r:'w-resize',t:'s-resize',b:'s-resize'}[sResize];};_me.__hideBlock=function(){if(this.__maskDIV){try{this.__maskDIV.parentNode.removeChild(this.__maskDIV);}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}
this.__maskDIV=null;return true;}
return false;};_me._dock=function(skip){var dock=this._mydock||gui._dock,sTitle=false,sCSS='';if(!this.__dockable||!dock)return;if(this._ondock){var out=this._ondock(dock);if(!out)
return;else
if(Is.String(out))
sTitle=out;else
if(Is.Object(out)){if(Is.Defined(out.title))
sTitle=out.title;if(Is.Defined(out.css))
sCSS=out.css;}}
if(!Is.String(sTitle))
sTitle=this._title().unescapeHTML();obj_popup.activeStack.remove(this);obj_popup.activeStack.focusNext();this.__eContainer.style.marginLeft='-300%';this.__eContainer.style.visibility='hidden';if('activeElement'in document){var elm=document.activeElement;if(elm&&elm!==document.body&&typeof elm.blur=='function'&&Is.Child(elm,this._main)){elm.blur();}}
this._docked=true;if(!skip)dock._add(this,sTitle,sCSS);return true;};_me._undock=function(skip){var dock=this._mydock||gui._dock;if(dock&&this._docked){this.__eContainer.style.marginLeft='auto';this.__eContainer.style.visibility='visible';this._docked=false;if(!skip)
dock._remove(this);this._focus();if(this._onundock)
this._onundock(dock);return true;}};_me.__resize=function(e,sResize){var me=this;var difX,difY,dif1,dif2,dif3,dif4;if(this.__move_handler){gui._disobeyEvent('mousemove',[this,'__move_handler']);this.__move_handler=null;}
this.__showBlock(sResize);var position=getSize(this.__eContainer);switch(sResize){case't':difY=e.clientY;dif1=position.h;dif2=position.y;me.__move_handler=function(evn){var evn=evn||window.event,Y=evn.clientY;Y=Y<0?0:Y;Y-=difY;if(dif1-101<Y)
Y=dif1-100;me._place('',(dif2+Y),'',(dif1-Y));if(me._onresize)me._onresize(e,'t');me.__exeEvent('onresize',e,{"owner":me,"main":me.__eContainer,"body":me.__eMain,"type":'t'});};break;case'lt':difY=e.clientY;difX=e.clientX;dif1=position.h;dif2=position.y;dif3=position.w;dif4=position.x;me.__move_handler=function(evn){var evn=evn||window.event,X=evn.clientX,Y=evn.clientY;X=X<0?0:X;Y=Y<0?0:Y;var size1=dif1-Y+difY;if(size1<101){Y=dif1+difY-100;size1=100;}
var size3=dif3-X+difX;if(size3<201){X=dif3+difX-200;size3=200;}
var size2=dif2+Y-difY;var size4=dif4-difX+X;me._place(size4,size2,size3,size1);if(me._onresize)me._onresize(e,'lt');me.__exeEvent('onresize',e,{"owner":me,"main":me.__eContainer,"body":me.__eMain,"type":'lt'});};break;case'l':difX=e.clientX;dif1=position.w;dif2=position.x;me.__move_handler=function(evn){var evn=evn||window.event,X=evn.clientX;X=X<0?0:X;var size1=dif1-X+difX;if(size1<201){X=dif1-200+difX;size1=200;}
var size2=dif2-difX+X;me._place(size2,'',size1);if(me._onresize)me._onresize(e,'l');me.__exeEvent('onresize',e,{"owner":me,"main":me.__eContainer,"body":me.__eMain,"type":'l'});};break;case'lb':difX=e.clientX;difY=e.clientY;dif1=position.w;dif2=position.x;dif3=position.h;me.__move_handler=function(evn){var evn=evn||window.event,X=evn.clientX,Y=evn.clientY;X=X<0?0:X;Y=Y<0?0:Y;var size1=dif1-X+difX;if(size1<200){X=dif1-200+difX;size1=200;}
var size2=dif2-difX+X;var size3=dif3+Y-difY;if(size3<100)
size3=100;me._place(size2,'',size1,size3);if(me._onresize)me._onresize(e,'lb');me.__exeEvent('onresize',e,{"owner":me,"main":me.__eContainer,"body":me.__eMain,"type":'lb'});};break;case'b':difY=e.clientY;dif1=position.h;me.__move_handler=function(evn){var evn=evn||window.event,Y=evn.clientY;Y=Y<0?0:Y;var size=dif1+Y-difY;size=size<100?100:size;me._size('',size);if(me._onresize)me._onresize(e,'b');me.__exeEvent('onresize',e,{"owner":me,"main":me.__eContainer,"body":me.__eMain,"type":'b'});};break;case'rb':difX=e.clientX;difY=e.clientY;dif1=position.w;dif2=position.h;me.__move_handler=function(evn){var evn=evn||window.event,X=evn.clientX,Y=evn.clientY;X=X<0?0:X;Y=Y<0?0:Y;var size1=dif1+X-difX;size1=size1<200?200:size1;var size2=dif2+Y-difY;size2=size2<100?100:size2;me._size(size1,size2);if(me._onresize)me._onresize(e,'rb');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'rb'});};break;case'r':difX=e.clientX;dif1=position.w;me.__move_handler=function(evn){var evn=evn||window.event,X=evn.clientX;X=X<0?0:X;var size1=dif1+X-difX;size1=size1<200?200:size1;me._size(size1);if(me._onresize)me._onresize(e,'r');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'r'});};break;case'rt':difX=e.clientX;difY=e.clientY;dif1=position.w;dif2=position.h;dif3=position.y;me.__move_handler=function(evn){var evn=evn||window.event,Y=evn.clientY,X=evn.clientX;Y=Y<0?0:Y;X=X<0?0:X;var size2=dif2-Y+difY;if(size2<100){Y=dif2-100+difY;size2=100;}
var size3=dif3+Y-difY;var size1=dif1+X-difX;size1=size1<200?200:size1;me._place('',size3,size1,size2);if(me._onresize)me._onresize(e,'rt');me.__exeEvent('onresize',e,{"owner":me,"main":me._main,"body":me.__eContainer,"type":'rt'});};break;}
if(this.__move_handler&&this.__move_handler!=null)
gui._obeyEvent('mousemove',[this,'__move_handler']);};_me._title=function(sVal,bText){if(typeof sVal=='undefined')
return this.__eTitle.innerHTML;else
if(bText)
this.__eTitle.innerHTML=sVal?sVal.escapeHTML():'';else{var tmp=getLang(sVal);this.__eTitle.innerHTML=tmp?tmp.escapeHTML():'';}};_me._close=function(b,e){if(!this.__closable||(this._onclose&&!this._onclose(b,e)))return false;this._remove_destructor('_onclose');this._destruct();return true;};_me._focus=function(){if(this._docked&&this._undock())
return;maxZIndex.remove(this.__zindex);this.__zindex=maxZIndex.get();this.__eContainer.style.zIndex=this.__zindex;if(this.__modaldiv){this.__modaldiv.style.zIndex=this.__zindex-1;}
obj_popup.activeStack.add(this);if(this._onfocus)
this._onfocus();if(!this.__modaldiv)
obj_popup.activeStack.order();this._activate();};_me._activate=function(){if(!hascss(this._main,'active')){addcss(this._main,'active');var pops=gui._main.querySelectorAll('div.obj_popup');for(var i=pops.length;i--;){if(this._main!==pops[i])
removecss(pops[i],'active');}}};_me._isModal=function(){return this.__modaldiv?true:false;};_me._modal=function(b){this._dockable(!b);if(b&&!this.__modaldiv){maxZIndex.remove(this.__zindex);this.__zindex=maxZIndex.get();this.__eContainer.style.zIndex=this.__zindex;this.__modaldiv=mkElement("div");this.__modaldiv.style.zIndex=this.__zindex-1;this._main.insertBefore(this.__modaldiv,this.__eContainer);this.__modaldiv.className='obj_popup_modaldiv';addcss(this._main,'modal');}
else
if(!b&&this.__modaldiv){this._main.removeChild(this.__modaldiv);this.__modaldiv=null;this.__eContainer.style.zIndex=this.__zindex;removecss(this._main,'modal');}};_me._maximize=function(bWait){if(this.__resizable==false)return;if(this.__position.max){this.__moveble=true;this.__position.max=0;removecss(this.__eContainer,'maximized');this._place(this.__position.x,this.__position.y,this.__position.w,this.__position.h);}
else{this.__position.max=1;this.__moveble=false;var tmp=clone(this.__position,true);if(bWait){var me=this;this.__position_tmp=tmp;window.setTimeout(function(){try{addcss(me.__eContainer,'maximized');me._place(0,0,document.body.offsetWidth,document.body.offsetHeight+(me.__eMain.offsetHeight-me.__eContainer.offsetHeight));me.__position=me.__position_tmp;}
catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}},500);}
else{addcss(this.__eContainer,'maximized');this._place(0,0,document.body.offsetWidth,document.body.offsetHeight);this.__position=tmp;}}};_me._defaultSize=function(x,y,w,h,bMax){this.__defaultSize={x:x,y:y,w:w,h:h,max:bMax};var aSize;if(Cookie)
aSize=Cookie.get(['popup_'+this._type,screen.width+'x'+screen.height]);if(Is.Defined(aSize)){if(Is.Defined(aSize['x'])&&(x=parseInt(aSize['x'])||0))
x=Math.max(0,x);if(Is.Defined(aSize['y'])&&(y=parseInt(aSize['y'])||0))
y=Math.max(0,y);if(aSize['w']&&(w=parseInt(aSize['w'])))
w=Math.max(200,w);if(aSize['h']&&(h=parseInt(aSize['h'])))
h=Math.max(88,h);if(aSize['max'])
bMax=!!aSize['max'];}
this.__position.x=x;this.__position.y=y;this.__position.w=w;this.__position.h=h;this.__positionShadow=clone(this.__position);if(bMax){this._maximize();}
else
if(Is.Number(x)&&Is.Number(y)&&x>=0&&y>=0){this._placeShift();}
else
if(Is.Number(w)&&w>0){if(Is.Number(h)&&h>0)
this._size(w,h,1);else
this._size(w,'',1);if(!this._isModal())
this._placeShift(true);}
this._add_destructor('__rememberSize');};_me.__rememberSize=function(){if(Cookie){var tmp=clone(this.__position);for(var i in tmp)
if(tmp[i]==this.__defaultSize[i])
delete tmp[i];Cookie.set(['popup_'+this._type,screen.width+'x'+screen.height],tmp);}};_me._placeShift=function(bShiftOnly){var bForced=false;var x=this.__positionShadow.x,y=this.__positionShadow.y,w=this.__positionShadow.w,h=this.__positionShadow.h;if(!this._isModal()){var aPop=gui._getChildObjects('main',this._type),iH=gui._main.offsetHeight,iW=gui._main.offsetWidth,bShifted=false;for(var i=aPop.length;i--;){if(aPop[i]!==this&&!aPop[i]._destructed&&!aPop[i]._docked){if(x==aPop[i].__positionShadow.x&&y==aPop[i].__positionShadow.y){bForced=true;x+=30;y+=30;if(!bShifted&&(iH<y+h||iW<x+w)){y=30;x=30;bShifted=true;}
i=aPop.length;}}}}
if(!bShiftOnly||bForced){if(Is.Number(w)&&w>0){if(Is.Number(h)&&h>0)
this._place(x,y,w,h,bForced);else
this._place(x,y,w,undefined,bForced);}
else
this._place(x,y,undefined,undefined,bForced);}};_me._place=function(x,y,w,h,bForced){if(!Is.Defined(x)&&!Is.Defined(y)&&!Is.Defined(w)&&!Is.Defined(h))
return this.__position;var iH=gui._main.offsetHeight,iW=gui._main.offsetWidth,bRender=this.__eContainer.style.transform=="";if(!this.__position.max&&Is.Defined(x)&&Is.Defined(y)&&Is.Defined(w)&&Is.Defined(h)){if(h>window.innerHeight){h=window.innerHeight;}
if(iH<y+h){y=iH-h;if(y<0){if(this.__resizable)
h=Math.max(88,h+y);y=0;}
bForced=true;}
if(iW<x+w){x=iW-w;if(x<0){if(this.__resizable)
w=Math.max(200,w+x);x=0;}
bForced=true;}}
if(Is.Number(x)){x=Math.max(0,(x>iW-100?iW-100:x));if(this.__positionShadow.x!=x)
bRender=true;this.__positionShadow.x=x;if(!bForced)
this.__position.x=x;}
if(Is.Number(y)){y=Math.max(0,(y>iH-100?iH-100:y));if(this.__positionShadow.y!=y)
bRender=true;this.__positionShadow.y=y;if(!bForced)
this.__position.y=y;}
if(bRender){if(obj_popup._oldPositioning){this.__eContainer.style.left=this.__positionShadow.x+'px';this.__eContainer.style.top=this.__positionShadow.y+'px';}
else
this.__eContainer.style.transform='translate('+this.__positionShadow.x+'px,'+this.__positionShadow.y+'px)';}
if(Is.Number(w)||Is.Number(h))
this._size(w,h,false,bForced);};_me._size=function(w,h,center,bForced){var tmp,bRender=false;if(w>=200||w==='auto'){if(this.__eContainer.offsetWidth!=w){this.__eContainer.style.width=w!=='auto'?w+'px':w;w=this.__eContainer.offsetWidth;}
if(center){tmp=document.body.clientWidth-w;tmp=tmp<0?0:tmp;tmp=Math.round(tmp/2);this.__positionShadow.x=tmp;bRender=true;}
this.__positionShadow.w=w;if(!bForced)
this.__position.w=w;}
if(h>=88||h==='auto'){if(h==='auto'&&this.__eContainer.clientHeight>window.innerHeight){h='100%';}
if(this.__eContainer.offsetHeight!=h){this.__eContainer.style.height=Is.Number(h)?h+'px':h;h=this.__eContainer.offsetHeight;}
if(center){tmp=(document.body.clientHeight-h)/2;tmp=tmp<0?0:tmp;tmp=Math.round(tmp/2);this.__positionShadow.y=tmp;bRender=true;}
this.__positionShadow.h=h;if(!bForced)
this.__position.h=h;}
if(bRender){if(obj_popup._oldPositioning){this.__eContainer.style.left=this.__positionShadow.x+'px';this.__eContainer.style.top=this.__positionShadow.y+'px';}
else
this.__eContainer.style.transform='translate('+this.__positionShadow.x+'px,'+this.__positionShadow.y+'px)';}
this.__eContainer.style.visibility='visible';};_me.__checkPosition=function(){if(!this.__position.max){if(!Is.Defined(this.__position.x)||!Is.Defined(this.__position.y))
var position=getSize(this.__eContainer);else
var position=this.__position;this._place(position.x,position.y,position.w,position.h,true);}};_me._isActive=function(){return this===obj_popup.activeStack.get();};_me.__destructor=function(){this._undock();this.__hideBlock();maxZIndex.remove(this.__zindex);obj_popup.activeStack.remove(this);obj_popup.activeStack.focusNext();gui._disobeyEvent('resize',[this,'__checkPosition']);};

/* client/inc/obj_print.js */
_me=obj_print.prototype;function obj_print(){};_me.__constructor=function(s){var me=this;this._create('frame','obj_frame');this.frame._onresize=function(b){if(b){me.frame._resize=false;setTimeout(function(){if(me.frame)me.frame._print();},500);}};};_me._print=function(s,bText){if(Is.String(s)){this.frame._resize=true;this.frame._write(bText?s.escapeHTML().wrap():s);}};

/* client/inc/obj_progress.js */
_me=obj_progress.prototype;function obj_progress(){};_me.__constructor=function(){this.__range=100;this.__value=0;this.__eBar=mkElement('div',{className:'bar'});this._main.appendChild(this.__eBar);this.__eText=mkElement('div',{className:'text'});this._main.appendChild(this.__eText);var me=this;this._main.onmousemove=function(e){var e=e||window.event;if(me._onmousemove)
me._onmousemove(e);};this._main.onclick=function(e){var e=e||window.event;if(me._onclick)
me._onclick(e);};this._main.onmousedown=function(e){var e=e||window.event;if(me._onmousedown)
me._onmousedown(e);};this._main.onmouseup=function(e){var e=e||window.event;if(me._onmouseup)
me._onmouseup(e);};};_me._range=function(i){if(!i)return this.__range;i=parseInt(i);if(i==NaN)i=1;this.__range=i;};_me._value=function(i){if(!Is.Defined(i))return this.__value;i*=1;if(i==NaN)i=0;this.__value=i;var no=0;if(i>0){no=(i/(this.__range/100));no=no>100?100:no;}
this.__eBar.style.width=no+'%';this.__eText.style.left=no+'%';for(var css='',i=Math.floor(no/10),j=1;j<=i;j++)
css+=' c'+(j*10);this.__eBar.className='bar'+css;};_me._title=function(s){try{this.__eText.innerHTML='';s&&this.__eText.appendChild(mkElement('span',{innerHTML:s}));}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};

/* client/inc/obj_radio.js */
_me=obj_radio.prototype;function obj_radio(){};_me.__constructor=function(){this._listener_data;this._listenerPath_data;this.__parentFrm=document.forms[this._main.name];};_me._fill=function(aData){if(!aData){if(!this._listener_data)return;aData=dataSet.get(this._listener_data,this._listenerPath_data);}
var ii=0,rows=[];for(var i in aData)rows.push({"value":i,"label":getLang(aData[i]),"key":ii++});var tmpData={"_ins":this._pathName,"row":rows};this._main.innerHTML=template.exe(storage.template('obj_radio'),tmpData);var me=this;var list=this._main.elements;for(var i=list.length-1;i>=0;i--){list[i].onclick=function(e){e=e||window.event;if(me._onchange)me._onchange(e);me.__exeEvent('onchange',e,{"owner":me});};}};_me._listen_data=function(sDataSet,aDataPath){if(sDataSet)return false;this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me._value=function(v){var elm;for(var i=this.__parentFrm.elements.length-1;i>=0;i--){elm=this.__parentFrm.elements[i];if(elm.tagName!='INPUT'||elm.type!='radio'||this._pathName!=elm.name)continue;if(v==null){if(elm.checked)return elm.value;}
else
if(elm.value==v){elm.checked=true;elm.onclick({'target':elm});return elm.value;}}
return null;};_me._disabled=function(b){var elm;for(var i=this.__parentFrm.elements.length-1;i>=0;i--){elm=this.__parentFrm.elements[i];if(elm.tagName!='INPUT'||elm.type!='radio'||this._pathName!=elm.name)continue;elm.disabled=b;}
elm=null;};_me.__update=function(sDataSet){if(!sDataSet)return;if(this._listener_data==sDataSet)this._fill();if(this._listener==sDataSet)this._value(dataSet.get(this._listener,this._listenerPath));};

/* client/inc/obj_reminder.js */
_me=obj_reminder.prototype;function obj_reminder(){};_me.__constructor=function(sType){var me=this;this.reminder_1._disabled(true);this.checkbox_1._title('REMINDER::REMIND1');this.checkbox_1._onchange=function(){me.reminder_1._disabled(!this._value());if(!me.__prdka&&isFormEmpty(me._value())){storage.library('gw_others');var aReminderDefault=null;if(sType&&(aReminderDefault=GWOthers.get(sType,'storage')['VALUES']))
loadDataIntoForm(me.reminder_1,aReminderDefault);}
me.__prdka=true;}
var tmp=GWOthers.get(sType,'storage').VALUES;if(tmp.default_reminder>0)
this.checkbox_1._value(1);};_me._value=function(aValues){if(Is.Defined(aValues)){if(aValues){var aReminder;if((aReminder=shiftObject(aValues))!=null){if(typeof aReminder.RMNDAYSBEFORE=='undefined')
aReminder.RMNDAYSBEFORE=aReminder.RMNHOURSBEFORE=aReminder.RMNMINUTESBEFORE=0;this.reminder_1._value(aReminder);this.checkbox_1._value(true);this.reminder_1._disabled(false);}}
else{this.checkbox_1._value(false);this.reminder_1._disabled(true);}}else{var aResult=[];var aReminder1=this.reminder_1._value();if(this.checkbox_1._value()){aResult.push(aReminder1);}else{if(Is.Defined(aReminder1['uid'])){delete aReminder1['values'];aResult.push(aReminder1);}}
return aResult;}}
_me._tabIndex=function(sContainer,i,oDock){this.checkbox_1._tabIndex(sContainer,i,oDock);this.reminder_1.time._tabIndex(sContainer,i?++i:i,oDock);};_me._focus=function(b){return this.checkbox_1._focus(b);};

/* client/inc/obj_reminder_item.js */
_me=obj_reminder_item.prototype;function obj_reminder_item(){};_me._value=function(aValues){if(this._parent._type!='obj_reminder')
this._getAnchor('label').innerHTML=getLang('REMINDER::REMIND1');if(Is.Defined(aValues)){if(Is.Defined(aValues['values'])){var aSubValues=aValues['values'];this.time._value(((parseInt(aSubValues['RMNDAYSBEFORE'])*24+parseInt(aSubValues['RMNHOURSBEFORE']))*60+parseInt(aSubValues['RMNMINUTESBEFORE']))*60000);this._id=aSubValues['RMN_ID'];}}else{var aResult={'values':{}};var aSubValues=aResult['values'];aSubValues['RMNDAYSBEFORE']=0;aSubValues['RMNHOURSBEFORE']=0;aSubValues['RMNMINUTESBEFORE']=this.time._getMinutes();if(Is.Defined(this._id))aResult['uid']=this._id;return aResult;}};_me._disabled=function(b){var aObjects=getSubobjects(this,aObjects);for(var i in aObjects)
aObjects[i]._disabled(b);};

/* client/inc/obj_reminder_task.js */
_me=obj_reminder_task.prototype;function obj_reminder_task(){};_me.__constructor=function(){var me=this;this.__value={};this.time._disabled(true);this.calendar._disabled(true);this.checkbox_1._onchange=function(){var v=this._value();me.time._disabled(!v);me.calendar._disabled(!v);if(!me.__prdka){me.__prdka=true;var tmp=new IcewarpDate();me.time._value(tmp.hour()*3600000+tmp.minute()*60000+tmp.second()*1000+tmp.millisecond());}};};_me._value=function(aValues){if(Is.Defined(aValues)){if((this.__value=shiftObject(aValues))!=null){this.__value=this.__value.values;this.__prdka=true;this.checkbox_1._value(1);this.time._disabled(false);this.calendar._disabled(false);if(this.__value.RMNTIME){var tmp=IcewarpDate.unix(this.__value.RMNTIME);this.calendar._value(tmp);this.time._value(tmp.hour()*3600000+tmp.minute()*60000+tmp.second()*1000+tmp.millisecond());}}}
else{var aResult=[];if(this.checkbox_1._value()){var out={};if(this.__value.RMN_ID)
out.uid=this.__value.RMN_ID;var tmp=this.calendar._getObjectDate(),tim=this.time._value();tmp.hour(Math.floor(tim/3600000));tmp.minute(Math.floor((tim%3600000)/60000));out.values={'RMNTIME':tmp.unix()};aResult.push(out);}
else
if(this.__value.RMN_ID)
aResult=[{uid:this.__value.RMN_ID}];return aResult;}};_me._tabIndex=function(sContainer,i,oDock){this.checkbox_1._tabIndex(sContainer,i,oDock);this.time._tabIndex(sContainer,i,oDock);};_me._focus=function(b){return this.checkbox_1._focus(b);};

/* client/inc/obj_repeating.js */
_me=obj_repeating.prototype;function obj_repeating(){};_me.__constructor=function(){var me=this;this.__date=new IcewarpDate();this.__values={};this.__aMonths={'1':'MONTHS::JANUARY','2':'MONTHS::FEBRUARY','3':'MONTHS::MARCH','4':'MONTHS::APRIL','5':'MONTHS::MAY','6':'MONTHS::JUNE','7':'MONTHS::JULY','8':'MONTHS::AUGUST','9':'MONTHS::SEPTEMBER','10':'MONTHS::OCTOBER','11':'MONTHS::NOVEMBER','12':'MONTHS::DECEMBER'};this.__aWeekNo={'1':'REPEATING::FIRST','2':'REPEATING::SECOND','3':'REPEATING::THIRD','4':'REPEATING::FOURTH','-1':'REPEATING::LAST'};this.__aDays={'127':'REPEATING::DAY_LIST','62':'REPEATING::WEEKDAY','65':'REPEATING::WEEKEND_DAY','1':'DAYS::SUNDAY','2':'DAYS::MONDAY','4':'DAYS::TUESDAY','8':'DAYS::WEDNESDAY','16':'DAYS::THURSDAY','32':'DAYS::FRIDAY','64':'DAYS::SATURDAY'};this.__sSelected=undefined;this.__aValues=[];this.radio_repeats._onchange=function(){if(me.__sSelected&&me.__sSelected!='no_repeats'){me.__aValues[me.__sSelected]={};storeDataFromForm(me.container,me.__aValues[me.__sSelected]);}
me.__sSelected=this._value();if(me.container)me.container._destruct();me._create('container','obj_form','container');switch(this._value()){case'no_repeats':me.__disableForm(true);me.__aValues=[];me.__validate();break;case'daily':me.__disableForm(false);me.__drawDaily();break;case'weekly':me.__disableForm(false);me.__drawWeekly();break;case'monthly':me.__disableForm(false);me.__drawMonthly();break;case'yearly':me.__disableForm(false);me.__drawYearly();break;}
if(Is.Defined(me.__aValues[this._value()]))
loadDataIntoForm(me.container,me.__aValues[this._value()]);};this.radio_ends._onchange=function(){switch(this._value()){case'1':me.RCRCOUNT._disabled(true);me.RCRENDDATE._disabled(false);break;case'2':me.RCRCOUNT._disabled(false);me.RCRENDDATE._disabled(true);break;default:me.RCRCOUNT._disabled(true);me.RCRENDDATE._disabled(true);}
me.__validate();};this.RCRCOUNT._restrict([this,'__numerical',[void 0,0]]);this.RCRCOUNT._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.RCRCOUNT._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.RCRCOUNT.__check();});this.radio_repeats._value('no_repeats');this.radio_ends._value('0');this.__disableForm(true);};_me.__drawYearly=function(){this.container._draw('obj_repeating_yearly','main');this.container.year_no._fill({'1':'1','2':'2','3':'3','4':'4','5':'5'});this.container.week_no._fillLang(this.__aWeekNo);this.container.day_of_week._fillLang(this.__aDays);this.container.the_month._fillLang(this.__aMonths);this.container.type._value('1');this.container.year_no._value('1');this.container.week_no._value('1');var nDay=this.__date.day();nDay=(nDay=='7')?'1':Math.pow(2,nDay);this.container.day_of_week._value(nDay);this.container.the_month._value(this.__date.month()+1);this.__validate();};_me.__drawMonthly=function(){var me=this;this.container._draw('obj_repeating_monthly','main');this.container.week_no._fillLang(this.__aWeekNo);this.container.day_of_week._fillLang(this.__aDays);this.container.day_repetition._value(this.__date.date());this.container.day_repetition._restrict([this,'__numerical',[31,0]]);this.container.day_repetition._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.container.day_repetition._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.container.day_repetition.__check();});this.container.month_repetition1._value('1');this.container.month_repetition1._restrict([this,'__numerical',[void 0,0]]);this.container.month_repetition1._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.container.month_repetition1._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.container.month_repetition1.__check();});this.container.type._value('1');this.container.week_no._value('1');var nDay=this.__date.day();nDay=(nDay=='7')?'1':Math.pow(2,nDay);this.container.day_of_week._value(nDay);this.container.month_repetition2._value('1');this.container.month_repetition2._restrict([this,'__numerical',[void 0,0]]);this.container.month_repetition2._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.container.month_repetition2._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.container.month_repetition2.__check();});this.__validate();};_me.__drawWeekly=function(){var me=this;this.container._draw('obj_repeating_weekly','main');this.container.week_repetition._value('1');this.container.week_repetition._restrict([this,'__numerical',[void 0,0]]);this.container.week_repetition._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.container.week_repetition._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.container.week_repetition.__check();});var nDay=this.__date.day();nDay=(nDay=='7')?'1':Math.pow(2,nDay);this.container.day_of_week._value(nDay);this.__validate();};_me.__drawDaily=function(){var me=this;this.container._draw('obj_repeating_daily','main');this.container.type._value('1');this.container.day_repetition._value('1');this.container.day_repetition._restrict([this,'__numerical',[void 0,0]]);this.container.day_repetition._onerror=function(has_error){if(this._onerror)
this._onerror(has_error);}.bind(this);AttachEvent(this.container.day_repetition._main.getElementsByTagName('input')[0],'onchange',function(e){this.value=parseInt(this.value)||1;me.container.day_repetition.__check();});this.__validate();};_me.__validate=function(){var has_error=false;this.container._getChildObjects('main','obj_input').forEach(function(input){input._checkError=[];input._validate();has_error=!!input._checkError.length||has_error;});if(!this.RCRCOUNT._disabled()){this.RCRCOUNT._checkError=[];this.RCRCOUNT._validate();has_error=!!this.RCRCOUNT._checkError.length||has_error;}
if(this._onerror)
this._onerror(has_error);};_me.__numerical=function(num,max,min){if(!num)return true;if(num==0||(max!==void 0&&num>max)||(min!==void 0&&num<min))return false;return!isNaN(num);};_me.__disableForm=function(b){this.radio_ends._disabled(b);if(b){this.RCRENDDATE._disabled(true);this.RCRCOUNT._disabled(true);}
else
{switch(this.radio_ends._value()){case'1':this.RCRCOUNT._disabled(true);this.RCRENDDATE._disabled(false);break;case'2':this.RCRCOUNT._disabled(false);this.RCRENDDATE._disabled(true);break;default:this.RCRCOUNT._disabled(true);this.RCRENDDATE._disabled(true);}}};_me.__zeroNonsetVariables=function(aValues){var aAttributes=['RCRDAYREPETITION','RCRDAYOFWEEKNUMBER','RCRWEEKREPETITION','RCRWEEKOFMONTHNUMBER','RCRMONTHREPETITION','RCRMONTHOFYEARNUMBER','RCRYEARREPETITION'];for(var i in aAttributes){if(!Is.Defined(aValues[aAttributes[i]]))
aValues[aAttributes[i]]='0';}};_me.__setYearly=function(aValues){this.radio_repeats._value('yearly');this.radio_repeats._onchange();if(aValues['RCRWEEKOFMONTHNUMBER']=='0'){this.container.type._value('1');this.container.year_no._value(aValues['RCRYEARREPETITION']);}else{this.container.type._value('2');this.container.week_no._value(aValues['RCRWEEKOFMONTHNUMBER']);this.container.day_of_week._value(aValues['RCRDAYOFWEEKNUMBER']);this.container.the_month._value(aValues['RCRMONTHOFYEARNUMBER']);}};_me.__getYearly=function(){var aValues={};switch(this.container.type._value()){case'1':aValues['RCRYEARREPETITION']=this.container.year_no._value();break;case'2':aValues['RCRWEEKOFMONTHNUMBER']=this.container.week_no._value();aValues['RCRDAYOFWEEKNUMBER']=this.container.day_of_week._value();aValues['RCRMONTHOFYEARNUMBER']=this.container.the_month._value();aValues['RCRYEARREPETITION']='1';break;}
return aValues;};_me.__setMonthly=function(aValues){this.radio_repeats._value('monthly');this.radio_repeats._onchange();if(aValues['RCRWEEKOFMONTHNUMBER']=='0'){this.container.type._value('1');this.container.day_repetition._value(aValues['RCRDAYREPETITION']);this.container.month_repetition1._value(aValues['RCRMONTHREPETITION']);}else{this.container.type._value('2');this.container.week_no._value(aValues['RCRWEEKOFMONTHNUMBER']);this.container.day_of_week._value(aValues['RCRDAYOFWEEKNUMBER']);this.container.month_repetition2._value(aValues['RCRMONTHREPETITION']);}};_me.__getMonthly=function(){var aValues={};switch(this.container.type._value()){case'1':aValues['RCRDAYREPETITION']=this.container.day_repetition._value();aValues['RCRMONTHREPETITION']=this.container.month_repetition1._value();break;case'2':aValues['RCRWEEKOFMONTHNUMBER']=this.container.week_no._value();aValues['RCRDAYOFWEEKNUMBER']=this.container.day_of_week._value();aValues['RCRMONTHREPETITION']=this.container.month_repetition2._value();break;}
return aValues;};_me.__setWeekly=function(aValues){this.radio_repeats._value('weekly');this.radio_repeats._onchange();this.container.week_repetition._value(aValues['RCRWEEKREPETITION']);this.container.day_of_week._value(aValues['RCRDAYOFWEEKNUMBER']);};_me.__getWeekly=function(){var aValues={};aValues['RCRWEEKREPETITION']=this.container.week_repetition._value();aValues['RCRDAYOFWEEKNUMBER']=this.container.day_of_week._value();return aValues;};_me.__setDaily=function(aValues){this.radio_repeats._value('daily');this.radio_repeats._onchange();if(aValues['RCRDAYREPETITION']!='0'){this.container.type._value('1');this.container.day_repetition._value(aValues['RCRDAYREPETITION']);}
else
this.container.type._value('2');};_me.__getDaily=function(){var aValues={};switch(this.container.type._value()){case'1':aValues['RCRDAYREPETITION']=this.container.day_repetition._value();break;case'2':aValues['RCRWEEKREPETITION']='1';var wwb=GWOthers.getItem('CALENDAR_SETTINGS','workweek_begins')%7,wwe=GWOthers.getItem('CALENDAR_SETTINGS','workweek_ends')%7;if(wwb>=0&&wwe>=0){var d=[1,2,4,8,16,32,64];if(wwb<=wwe)
d=d.slice(wwb,++wwe);else
d=[].concat(d.slice(0,++wwe),d.slice(wwb));aValues['RCRDAYOFWEEKNUMBER']=d.reduce(function(a,v){return a+v});}
else
aValues['RCRDAYOFWEEKNUMBER']='62';break;}
return aValues;};_me._setDate=function(oDate){this.__date=oDate;if(!this.__values['RCRENDDATE']&&this.RCRENDDATE._value()<oDate.format(IcewarpDate.JULIAN))
this.RCRENDDATE._value(oDate);};_me._value=function(aValues){if(Is.Defined(aValues)){if(Is.Defined(aValues['values'])&&!Is.Empty(aValues['values'])){this.__values=aValues['values'];this.__zeroNonsetVariables(this.__values);if(this.__values['RCRYEARREPETITION']!='0')
this.__setYearly(this.__values);else
if(this.__values['RCRMONTHREPETITION']!='0')
this.__setMonthly(this.__values);else
if(this.__values['RCRWEEKREPETITION']!='0')
this.__setWeekly(this.__values);else
this.__setDaily(this.__values);if(this.__values['RCRENDDATE']&&this.__values['RCRENDDATE']!='0'&&this.__values['RCRENDDATE']!='undefined'){this.radio_ends._value('1');this.RCRENDDATE._value(this.__values['RCRENDDATE']);}
else
if(this.__values['RCRCOUNT']&&this.__values['RCRCOUNT']!='0'&&this.__values['RCRCOUNT']!='undefined'){this.radio_ends._value('2');this.RCRCOUNT._value(this.__values['RCRCOUNT']);}
else
this.radio_ends._value('0');this.__disableForm(false);this._id=aValues['values']['RCR_ID'];}}
else{var aResult={};if(Is.Defined(this._id))aResult['uid']=this._id;switch(this.radio_repeats._value()){case'no_repeats':return aResult;case'daily':aResult['values']=this.__getDaily();break;case'weekly':aResult['values']=this.__getWeekly();break;case'monthly':aResult['values']=this.__getMonthly();break;case'yearly':aResult['values']=this.__getYearly();break;}
this.__zeroNonsetVariables(aResult['values']);aResult['values']['RCRENDDATE']=(this.radio_ends._value()!='1')?'':this.RCRENDDATE._value();aResult['values']['RCRCOUNT']=(this.radio_ends._value()!='2')?'':this.RCRCOUNT._value();return aResult;}};

/* client/inc/obj_room_status.js */
function obj_room_status(){}
obj_room_status._STATUSES={OFFLINE:0,ONLINE:3,TYPING:1,COMMENTING:2,BACKGROUND:4};obj_room_status._WIDTH=26;obj_room_status._HEIGHT=32;obj_room_status._MAX_AVATARS=10;obj_room_status.prototype.__constructor=function(){this._folder={};if(gui.socket){this.__users={};this.__list=[];gui.socket.api._obeyEvent('onStatusChange',[this,'__notify']);this._main.appendChild(this.__more=mkElement('div',{"class":"user more","text":this.__list.length-this.__getMaxNumberOfAvatars()}));this._add_destructor('__notify_off');}
gui._obeyEvent('resize',[this,'_removeOffline']);};obj_room_status.prototype.__getMaxNumberOfAvatars=function(){if(!(this._main||{}).parentNode){return 0;}
return Math.min(Math.floor(this._main.parentNode.clientWidth/obj_room_status._WIDTH),obj_room_status._MAX_AVATARS);};obj_room_status.prototype._setFolder=function(aFolder){if(this._folder.fid&&(this._folder.aid!=aFolder.aid||this._folder.fid!=aFolder.fid)){this.__users={};this.__list=[];while(this._main.firstChild){this._main.removeChild(this._main.firstChild);}
this._checkSize();}
this._folder=aFolder;};obj_room_status.prototype.__notify=function(users){if(this._destructed)
return false;if(!this._folder.fid)
return;var folder=dataSet.get('folders',[this._folder.aid,this._folder.fid]);if(users&&users[0]&&users[0].ATTRIBUTES&&users[0].ATTRIBUTES.FOLDER!==folder.RELATIVE_PATH.replace('/','\\')){return;}
users.forEach(function(user){if(user.ATTRIBUTES.STATUSEMAIL===sPrimaryAccount){return;}
var email=user.ATTRIBUTES.STATUSEMAIL;var device=user.ATTRIBUTES.DEVICEID;var status=+user.ATTRIBUTES.STATUSID;if(status===obj_room_status._STATUSES.OFFLINE){return this._removeUser(email,device);}
if(!this.__users[email]||(this.__users[email].statuses[device]===void 0)){this._addUser(email,device,status);}else if(this.__users[email].dom){this._moveUser(email,status);this.__users[email].dom&&this.__users[email].dom.classList[status===obj_room_status._STATUSES.TYPING?'add':'remove']('typing');}else{this._removeUser(email,device);this._addUser(email,device,status);}
this.__users[email]&&(this.__users[email].statuses[device]=status);},this);this._reOrder();this._removeOffline();};obj_room_status.prototype.__notify_off=function(){if(gui.socket)
gui.socket.api._disobeyEvent('onStatusChange',[this,'__notify']);};obj_room_status.prototype._reOrder=function(){setTimeout(function(){var i=0;this.__list=this.__list.filter(function(item){return item.dom;});this.__list.slice(0,this.__getMaxNumberOfAvatars()).forEach(function(item){var is_offline=true;for(var j in item.statuses){if(item.statuses[j]!==obj_room_status._STATUSES.OFFLINE){is_offline=false;break;}}
if(!is_offline){item.dom.style.transform="translateX("+(gui._rtl?-i:i)*obj_room_status._WIDTH+"px) translateY("+obj_room_status._HEIGHT+"px)";i++;item.dom.style.opacity=1;}else{item.dom.style.opacity=0;}});var min=Math.min(this.__list.length,this.__getMaxNumberOfAvatars());this.__list.slice(this.__getMaxNumberOfAvatars()).forEach(function(item){item.dom.style.opacity=0;item.dom.style.transform="translateX("+min*obj_room_status._WIDTH+"px) translateY("+obj_room_status._HEIGHT+"px)";});}.bind(this),5);};obj_room_status.prototype._removeOffline=function(){this.__removeOfflineTimeout&&clearTimeout(this.__removeOfflineTimeout);this.__removeOfflineTimeout=setTimeout(function(){var change=false;this.__list.filter(function(item){var is_offline=true;for(var i in item.statuses){if(item.statuses[i]!==obj_room_status._STATUSES.OFFLINE){is_offline=false;break;}}
return is_offline;}).forEach(function(item){if(!item.dom){return;}
item.dom.parentElement.removeChild(item.dom);delete this.__users[item.email];this.__list.splice(this.__list.indexOf(item),1);change=true;},this);change&&this._checkSize();this._moreUsers();}.bind(this),500);};obj_room_status.prototype._getIndex=function(status){if(!this.__list.length){return 0;}
for(var i=0;i<this.__list.length;i++){var global_status=0;for(var j in this.__list[i].statuses){if(this.__list[i].statuses[j]>0){global_status=global_status?Math.min(global_status,this.__list[i].statuses[j]):this.__list[i].statuses[j];}}
if(global_status>=status){return i;}}};obj_room_status.prototype._moreUsers=function(){if(this.__list.length>this.__getMaxNumberOfAvatars()){var amount=Math.min(this.__list.length,this.__getMaxNumberOfAvatars());this.__more.textContent='+'+(this.__list.length-this.__getMaxNumberOfAvatars());this.__more.style.transform="translateX("+amount*obj_room_status._WIDTH+"px) translateY("+obj_room_status._HEIGHT+"px)";this.__more.style.opacity=1;this.__more.setAttribute('title',this.__list.slice(amount).map(function(user){return user.email}).join("\n"));}else{this.__more.style.opacity=0;}};obj_room_status.prototype._moveUser=function(email,status){this.__list.splice(this.__list.indexOf(this.__users[email]),1);var index=this._getIndex(status);this.__list.splice(index,0,this.__users[email]);};obj_room_status.prototype._addUser=function(email,device,status){if(!this.__users[email]){var dom=this._createUser(email,status);this.__users[email]={email:email,statuses:{},dom:dom};this._main.appendChild(dom);var index=this._getIndex(status);this.__list.splice(index,0,this.__users[email]);this._checkSize();}
this.__users[email].statuses[device]=status;};obj_room_status.prototype._removeUser=function(email,device){this.__users[email]=this.__users[email]||{statuses:{}};this.__users[email].statuses[device]=obj_room_status._STATUSES.OFFLINE;this.__list.splice(this.__list.indexOf(this.__users[email]),1);this.__list.push(this.__users[email]);};obj_room_status.prototype._createSpinner=function(){var spinner=mkElement('div',{class:"spinner"});for(var i=1;i<=3;i++){spinner.appendChild(mkElement('div',{class:"bounce"+i}));}
return spinner;};obj_room_status.prototype._createAvatar=function(user_email){var avatar=mkElement('div',{class:'img'});avatar.setAttribute('style','background-image: url("'+getAvatarURL(user_email)+'")');return avatar;};obj_room_status.prototype._createUser=function(user_email){var div=mkElement('div',{"class":"user","title":user_email});div.appendChild(this._createAvatar(user_email));div.appendChild(this._createSpinner());return div;};obj_room_status.prototype._checkSize=function(){for(var size=0,style,i=0;i<this.__list.length;i++){if(this.__list[i].dom){style=getComputedStyle(this.__list[i].dom);size+=(this.__list[i].dom.offsetWidth||0)+parseInt(style.marginLeft||0,10);}}
this.__exeEvent('onresize',null,{size:size});};

/* client/inc/obj_room_suggest.js */
_me=obj_room_suggest.prototype;function obj_room_suggest(){};_me.__constructor=function(){var me=this;this.__activeFirst=true;this._min=1;this._limit=15;this._folder;this.__hints=[];this.__block=this._getAnchor('container');this._scrollbar(this.__block,this._main);AttachEvent(this.__block,'onscroll',function(e){if(me.__block.scrollTop<5)
me.__block.scrollTop=0;else
if(me.__block.scrollHeight-me.__block.scrollTop<me.__block.clientHeight+5)
me.__block.scrollTop=me.__block.scrollHeight-me.__block.clientHeight;});this._placeholder(getLang('POPUP_ITEMS::ENTER_EMAIL_ADDRESS'));};_me._decode=function(v){var aIN=MailAddress.splitEmails(v),rx=/^(\[)|(\])$/g,aOut=[],path=[];for(var i in aIN){aIN[i]=aIN[i].replace(rx,'');path=aIN[i].split('::');if(path[0].indexOf('/')>0&&WMFolders.getType([sPrimaryAccount,path[0]])=='I'){aOut.push({tag:'['+aIN[i]+']',label:path[1]||false});}
else
aOut.push({tag:aIN[i],err:1});}
return aOut;};_me._qdata=function(v){var cart=this._getCartPos(),end=false,word=[0,0];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':if(cart<=i)
end=true;else
word=[i+1,i+1];break;default:word[1]=i+1;}
if(end)break;}
v=v.substring(word[0],word[1]);this.__last_pos=[word[0],word[1],v];return v;};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(typeof v!='undefined'){var inp=this._getFocusedInput();if(inp){var old=inp._value();this._qdata(old);inp._value(old.substr(0,this.__last_pos[0])+'['+v+']'+old.substr(this.__last_pos[1]));if(inp._name=='plus')
this.__inpBlur('',{owner:inp});}}};_me._query=function(v){var sWord=v;if(v.indexOf('[')==0&&!(v=v.replace(/[\[\]]+/g,'')))
return;this.__last_qdata={folder:v};var ds=dataSet.get('folders',[sPrimaryAccount],true),aValues=[];for(var sFolder in ds){if(ds[sFolder].TYPE==='I'){var tmp=sFolder.split('/');if(ds[sFolder].NAME){tmp.pop();tmp.push(ds[sFolder].NAME);}
var folder=tmp.join('/').replace('/TeamChat/','/');if(folder.toLowerCase().indexOf(v.toLowerCase())>-1){aValues.push({path:sFolder+'::'+folder,folder:folder});if(aValues.length==this._limit)
break;}}}
this._parse(sWord,aValues);};_me._parse=function(sWord,aValues){if(!aValues||this._input_value()!=sWord){this.__show();this.__sLastRequestString='';return;}
var sc=function(a,b){if(a.folder>b.folder)
return 1;else
if(a<b)
return-1;else
return 0;};aValues=aValues.sort(sc);var aOut=[];for(var i in aValues)
if(aValues[i].folder!=this.__last_qdata.folder)
aOut.push({value:aValues[i].path,text:aValues[i].folder,css:'room'});if(aOut.length)
this.__show(aOut);else
this.__hide();this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;};

/* client/inc/obj_schedule.js */
_me=obj_schedule.prototype;function obj_schedule(){};_me.__constructor=function(owner,bHasAllDay,evnid,bAttendee){this.__owner=MailAddress.splitEmailsAndNames(owner)[0].email||sPrimaryAccount;this._draw('obj_schedule','main',{'timeinterval':bHasAllDay});this._create('X_TIMETABLE',"obj_timetable",'table','',this.__owner,evnid||{},bAttendee);this.X_TIMETABLE._onselectend=function(){var v=this._value();this._parent.X_TIMEINTERVAL._value({EVNSTARTTIME:v.STARTTIME,EVNENDTIME:v.ENDTIME,EVNSTARTDATE:v.STARTDATE,EVNENDDATE:v.ENDDATE});};};_me._sync=function(oInterval){if(oInterval){var me=this;this.X_TIMETABLE.__tzid=oInterval._value().TZID;this.X_TIMEINTERVAL._onchange=null;this.X_TIMEINTERVAL._value(oInterval._value(),true);this.X_TIMEINTERVAL._onchange=function(noSync){var v=this._value();if(!noSync)
oInterval._value(v);var old=me.X_TIMETABLE._value();if(noSync||v.EVNSTARTDATE!=old.STARTDATE||v.EVNSTARTTIME!=old.STARTTIME||v.EVNENDDATE!=old.ENDDATE||v.EVNENDTIME!=old.ENDTIME){old.STARTDATE=v.EVNSTARTDATE;old.STARTTIME=v.EVNSTARTTIME;old.ENDDATE=v.EVNENDDATE;old.ENDTIME=v.EVNENDTIME;me.X_TIMETABLE._value(old);}};this.X_TIMEINTERVAL._onchange(true);}};_me._attendees=function(aValues){if(Is.Defined(aValues)){var acc={css:'main_account',email:this.__owner,role:'G',status:'A'};var aAccInfo=dataSet.get('accounts',[this.__owner]);if(aAccInfo&&aAccInfo['FULLNAME'])
acc.name=aAccInfo['FULLNAME'];this.X_TIMETABLE._list.__users=[acc];for(var i in aValues)
if(this.__owner!=aValues[i].values.CNTEMAIL){if(aValues[i].values.CNTEMAIL==='__@@groupchat@@__'){aValues[i].values.CNTCONTACTNAME='All Attendees';}
var user={email:aValues[i].values.CNTEMAIL,name:aValues[i].values.CNTCONTACTNAME,role:aValues[i].values.CNTROLE,status:aValues[i].values.CNTSTATUS};if(aValues[i].values.NEW)
user.action='new';else{user.id=i;user.action='ignore';}
this.X_TIMETABLE._list.__users.push(user);}
this.X_TIMETABLE._list._fill();}
else{var users=this.X_TIMETABLE._list.__users;var aResult=[];for(var i in users){if(i==0)
continue;switch(users[i].action){case'remove':if(typeof users[i]['id']!='undefined')
aResult.push({'uid':users[i]['id']});break;case'edit':if(typeof users[i]['id']!='undefined'){aResult.push({'uid':users[i]['id'],'values':{CNTEMAIL:users[i].email,CNTCONTACTNAME:users[i].name,CNTROLE:users[i].role,CNTSTATUS:users[i].status}});break;}
case'new':aResult.push({'values':{CNTEMAIL:users[i].email,CNTCONTACTNAME:users[i].name,CNTROLE:users[i].role,CNTSTATUS:users[i].status}});}}
return aResult;}};

/* client/inc/obj_scrollbar.js */
_me=obj_scrollbar.prototype;function obj_scrollbar(){};_me.__constructor=function(){this.__scrollbars={};this._add_destructor('__sbar_disobey');};_me._disable_scrolbar=function(elm,bX,bY){if(this.__scrollbars[elm]){this.__scrollbars[elm].disabledX=bX===true;this.__scrollbars[elm].disabledY=Is.Defined(bY)?(bY?true:false):(bX?true:false);if(bX)
addcss(elm,'scroll_disabled_x');else
removecss(elm,'scroll_disabled_x');if(bY)
addcss(elm,'scroll_disabled_y');else
removecss(elm,'scroll_disabled_y');}};_me._scrollbar=function(elm,elm2,elm3,bX,bY){var me=this;var fx_version=parseInt((window.navigator.userAgent.match(/Firefox\/([0-9]+)\./)||[])[1])||0;if(navigator.userAgent.indexOf('Mobile')>0){this.__sbar_init=function(){};elm.style.overflow='auto';addcss(elm,'scroll_mobile');return;}
else
if(gui.__BROWSER.touch&&(currentBrowser()!='Mozilla'||fx_version>=64)){addcss(elm,'scroll_tablet');}
else{switch(currentBrowser()){case'MSIE11':case'Chrome':case'Safari':case'Mozilla':if(currentBrowser()!='Mozilla'||fx_version>=64){addcss(elm,'scroll_tablet');break;}
default:elm.style.overflow='hidden';AttachEvent(elm,"onmousewheel",function(e){var eSrc=e.srcElement,deltaY=e.deltaY,deltaX=e.deltaX;if(eSrc&&eSrc!==this&&(eSrc.tagName=='TEXTAREA'||(eSrc.clientHeight<eSrc.scrollHeight&&getComputedStyle(eSrc).overflow!='hidden'))&&((deltaY<0&&eSrc.scrollTop>0)||(deltaY>0&&eSrc.scrollTop+eSrc.clientHeight<eSrc.scrollHeight))){return;}
if(!deltaX&&deltaY&&this.scrollHeight<=this.clientHeight){deltaX=deltaY;deltaY=0;}
if(me.__sbar_wheel(this,deltaX,deltaY)&&e.originalEvent){e.originalEvent.cancelBubble=true;if(e.originalEvent.stopPropagation)
e.originalEvent.stopPropagation();}}.bind(elm));var focusElm=this._main||this._parent._main||elm;if(!focusElm.getAttribute('tabindex'))
focusElm.setAttribute('tabindex',-1);AttachEvent(focusElm,'onkeydown',function(e){if(e.srcElement===focusElm){var deltaX=0,deltaY=0;switch(e.keyCode){case 38:deltaY=-3;break;case 40:deltaY=3;break;case 37:deltaX=-3;break;case 39:deltaX=3;break;default:return;}
me.__sbar_wheel(this,deltaX,deltaY);}}.bind(elm));}}
this.__scrollbars[elm]={dock:elm2,dime:elm3,disabledX:(bX===false?true:false),disabledY:(bY===false?true:false)};AttachEvent(elm,'onmousemove',function(e){me.__sbar_init(this);}.bind(elm));AttachEvent(elm,'onclick',function(e){setTimeout(function(){me.__sbar_init&&me.__sbar_init(this)}.bind(this),100);}.bind(elm));AttachEvent(elm,"onscroll",function(e){me.__sbar_init(this,false,true);}.bind(elm));};_me.__sbar_scroll=function(e,arg,elm,elm2,sType,iScroll,iStart){try{if(sType=='Y')
elm.scrollTop=iScroll+((elm.scrollHeight-elm.clientHeight)*((gui['__Y']-iStart)/((elm2.firstChild.offsetHeight)*((100-this.__scrollbars[elm]['y_size'])/100))));else{var move=((elm.scrollWidth-elm.clientWidth)*((gui['__X']-iStart)/(elm2.firstChild.offsetWidth*(100-this.__scrollbars[elm]['x_size'])/100)));var ua=navigator.browser;if(gui._rtl&&ua){elm.scrollLeft=ua.engine=='Trident'||ua.engine=='Spartan'?iScroll-move:iScroll+move;elm.scrollRight=ua.engine=='WebKit'?elm.scrollWidth-(elm.scrollLeft+elm.offsetWidth):Math.abs(elm.scrollLeft);}else
elm.scrollLeft=iScroll+move;}}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}};_me.__sbar_wheel=function(elm,deltaX,deltaY){if(this.__scrollbars[elm]){var st1=elm.scrollTop,st2=elm.scrollLeft;if(!this.__scrollbars[elm].disabledX)
elm.scrollLeft=elm.scrollLeft+(deltaX*12);if(!this.__scrollbars[elm].disabledY)
elm.scrollTop=elm.scrollTop+(deltaY*12);return(st1!=elm.scrollTop||st2!=elm.scrollLeft);}};_me.__sbar_init=function(elm,bRedraw,bShow){if(!this.__scrollbars[elm]){if(bRedraw)return;this.__scrollbars[elm]={};}
if((this.__scrollbars[elm].disabledX&&this.__scrollbars[elm].disabledY)||(bRedraw&&((this.__scrollbars[elm].disabledX&&!this.__scrollbars[elm].y)||(this.__scrollbars[elm].disabledY&&!this.__scrollbars[elm].x))))
return;var x=Math.ceil(elm.clientWidth/(elm.scrollWidth/100)),y=Math.ceil(elm.clientHeight/(elm.scrollHeight/100)),me=this;if(!this.__scrollbars[elm].disabledY&&y<100){var iMin=elm.clientHeight?20/(elm.clientHeight/100):1;y=y<iMin?Math.ceil(iMin):y;this.__scrollbars[elm].y_size=y;if(this.__scrollbars[elm].y&&this.__scrollbars[elm].y.parentNode==(this.__scrollbars[elm].dock||elm)){if(bShow){if(Is.Defined(this.__scrollbars[elm].t))
window.clearTimeout(this.__scrollbars[elm].t);removecss(this.__scrollbars[elm].y,'hide');}}
else{this.__scrollbars[elm].y=mkElement('em',{className:'sbarY'});this.__scrollbars[elm].y.innerHTML='<ins><sub ondragstart="return false;" unselectable="on"></sub></ins><b ondragstart="return false;" unselectable="on"></b><i ondragstart="return false;" unselectable="on"></i>';this.__scrollbars[elm].y.ondblclick=this.__scrollbars[elm].y.onclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};this.__scrollbars[elm].y.onmousedown=function(e,bScrollInt){var e=e||window.event,tmp=e.target||e.srcElement;switch(tmp.tagName){case'SUB':addcss(this,'active');gui._obeyEvent('mouseup',[me,'__sbar_disobey',[this]]);gui._obeyEvent('mousemove',[me,'__sbar_scroll',[elm,this,'Y',elm.scrollTop,gui.__Y]]);bScrollInt=true;break;case'B':elm.scrollTop-=Math.ceil(elm.clientHeight/4);break;case'I':elm.scrollTop+=Math.ceil(elm.clientHeight/4);break;case'EM':case'INS':var sub=this.firstChild.firstChild,pos2=getSize(sub),y=gui.__Y;if(y<pos2.y)
elm.scrollTop-=elm.clientHeight;else
if(y>pos2.y+pos2.h)
elm.scrollTop+=elm.clientHeight;else{if(y<pos2.y+(pos2.h*0.25))
elm.scrollTop-=elm.clientHeight/3;else
if(y>pos2.y+(pos2.h*0.75))
elm.scrollTop+=elm.clientHeight/3;}
break;default:bScrollInt=true;}
this.onclick(e);if(!bScrollInt){if(Is.Defined(me.__scrollbars[elm].__scrollint))
window.clearInterval(me.__scrollbars[elm].__scrollint);me.__scrollbars[elm].__scrollint=window.setInterval(function(){me.__scrollbars[elm].y.onmousedown({srcElement:tmp},true);},500);gui._obeyEvent('mouseup',[function(){if(Is.Defined(me.__scrollbars[elm].__scrollint))
window.clearInterval(me.__scrollbars[elm].__scrollint);return false;}]);}
return false;};(this.__scrollbars[elm].dock||elm).appendChild(this.__scrollbars[elm].y);}
if(this.__scrollbars[elm].dime)
this.__scrollbars[elm].y.style.height=this.__scrollbars[elm].dime.offsetHeight+'px';this.__scrollbars[elm].y.firstChild.firstChild.style.height=y+'%';this.__scrollbars[elm].y.firstChild.firstChild.style.top=(100-y)*(elm.scrollTop/(elm.scrollHeight-elm.clientHeight))+'%';if(elm.scrollHeight/elm.clientHeight>3)
addcss(this.__scrollbars[elm].y,'long');else
removecss(this.__scrollbars[elm].y,'long');}
else
if(this.__scrollbars[elm].y){if(this.__scrollbars[elm].y.parentNode)
(this.__scrollbars[elm].dock||elm).removeChild(this.__scrollbars[elm].y);delete this.__scrollbars[elm].y;}
if(!this.__scrollbars[elm].disabledX&&x<100){if(gui._rtl)
elm.scrollRight=navigator.browser&&navigator.browser.engine=='WebKit'?elm.scrollWidth-(elm.scrollLeft+elm.offsetWidth):Math.abs(elm.scrollLeft);var iMin=elm.clientWidth?20/(elm.clientWidth/100):1;x=x<iMin?Math.ceil(iMin):x;this.__scrollbars[elm].x_size=x;if(this.__scrollbars[elm].x&&this.__scrollbars[elm].x.parentNode==(this.__scrollbars[elm].dock||elm)){if(bShow){if(Is.Defined(this.__scrollbars[elm].t))
window.clearTimeout(this.__scrollbars[elm].t);removecss(this.__scrollbars[elm].x,'hide');}}
else{this.__scrollbars[elm].x=mkElement('em',{className:'sbarX'});this.__scrollbars[elm].x.innerHTML='<ins><sub ondragstart="return false;" unselectable="on"></sub></ins>';this.__scrollbars[elm].x.ondblclick=this.__scrollbars[elm].x.onclick=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();return false;};this.__scrollbars[elm].x.onmousedown=function(e,bScrollInt){var e=e||window.event,tmp=e.target||e.srcElement;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();switch(tmp.tagName){case'SUB':addcss(this,'active');me.__scrollbars[elm].sl=elm.scrollLeft;gui._obeyEvent('mouseup',[me,'__sbar_disobey',[this]]);gui._obeyEvent('mousemove',[me,'__sbar_scroll',[elm,this,'X',elm.scrollLeft,gui.__X]]);bScrollInt=true;break;case'INS':case'EM':var sub=this.firstChild.firstChild,pos2=getSize(sub),x=gui.__X;if(x<pos2.x)
elm.scrollLeft-=elm.clientWidth;else
if(x>pos2.x+pos2.w)
elm.scrollLeft+=elm.clientWidth;else{if(x<pos2.x+(pos2.w*0.25))
elm.scrollLeft-=elm.clientWidth/3;else
if(x>pos2.x+(pos2.w*0.75))
elm.scrollLeft+=elm.clientWidth/3;}
break;default:bScrollInt=true;}
this.onclick(e);if(!bScrollInt){if(Is.Defined(me.__scrollbars[elm].__scrollint))
window.clearInterval(me.__scrollbars[elm].__scrollint);me.__scrollbars[elm].__scrollint=window.setInterval(function(){this.onmousedown({srcElement:tmp},true);}.bind(this),500);gui._obeyEvent('mouseup',[function(){if(Is.Defined(me.__scrollbars[elm].__scrollint))
window.clearInterval(me.__scrollbars[elm].__scrollint);return false;}]);}
return false;};(this.__scrollbars[elm].dock||elm).appendChild(this.__scrollbars[elm].x);}
this.__scrollbars[elm].x.firstChild.firstChild.style.width=x+'%';this.__scrollbars[elm].x.firstChild.firstChild.style[gui._rtl?'right':'left']=(100-x)*(elm[gui._rtl?'scrollRight':'scrollLeft']/(elm.scrollWidth-elm.clientWidth))+'%';}
else
if(this.__scrollbars[elm].x){if(this.__scrollbars[elm].x.parentNode)
(this.__scrollbars[elm].dock||elm).removeChild(this.__scrollbars[elm].x);delete this.__scrollbars[elm].x;}
if(y<100||x<100){var me=this;this.__scrollbars[elm].t=window.setTimeout(function(){try{me.__sbar_hide(elm);}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}},1000);}};_me.__sbar_hide=function(elm){if(this.__scrollbars[elm]){if(this.__scrollbars[elm].x)
addcss(this.__scrollbars[elm].x,'hide');if(this.__scrollbars[elm].y)
addcss(this.__scrollbars[elm].y,'hide');}};_me.__sbar_disobey=function(e,arg,elm){for(var bar in this.__scrollbars){if((!elm||bar===elm)&&Is.Defined(this.__scrollbars[bar].__scrollint))
window.clearInterval(this.__scrollbars[bar].__scrollint);}
gui._disobeyEvent('mouseup',[this,'__sbar_disobey']);gui._disobeyEvent('mousemove',[this,'__sbar_scroll']);if(elm)
removecss(elm,'active');for(var bar in this.__scrollbars){if(bar.x&&bar.x.parentNode)
bar.x.parentNode.removeChild(bar.x);if(bar.y&&bar.y.parentNode)
bar.y.parentNode.removeChild(bar.y);};};

/* client/inc/obj_search_wizard.js */
_me=obj_search_wizard.prototype;function obj_search_wizard(){};_me.__constructor=function(sType,oCallBack,bCreateFolder){var me=this;this.__sType=sType.toLowerCase();this._draw('search_wizard_'+this.__sType,'main',{fulltext:sPrimaryAccountFULLTEXT});if(this.X_BEFORE&&this.X_AFTER){this.before.__bNoEmpty=true;this.X_BEFORE._onchange=function(){me.before._disabled(!this._value());if(this._value())
if(!me.before._getObjectDate()){if(me.after._getObjectDate())
me.before._value(me.after._getObjectDate());else
me.before._value(new IcewarpDate());}};this.after.__bNoEmpty=true;this.X_AFTER._onchange=function(){me.after._disabled(!this._value());if(this._value())
if(!me.after._getObjectDate()){if(me.before._getObjectDate())
me.after._value(me.before._getObjectDate());else
me.after._value(new IcewarpDate());}};}
if(bCreateFolder){var a=document.createElement('a');a.appendChild(document.createTextNode(getLang('SEARCH::MAKEFOLDER')));a.onclick=function(e){gui._create('frm_virtual','frm_virtual','','',Path.split(dataSet.get('active_folder'))[1],me._value());me._destruct();};this._main.appendChild(a);}
if(oCallBack){this._create('x_search','obj_button');this.x_search._value('FORM_BUTTONS::SEARCH');this.x_search._onclick=function(){executeCallbackFunction(oCallBack,me._value());me._destruct();};}
setTimeout(function(){try{var obj=me._getChildObjects();for(var i in obj)
if(obj[i]._focus){obj[i]._focus();break;}}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}},100);AttachEvent(this._main,'onkeydown',function(e){var e=e||window.event;if(e.keyCode=='27'){executeCallbackFunction(oCallBack);me._destruct();}});var inp=this._getChildObjects();for(var i=inp.length-1;i>=0;i--)
if(inp[i]._type=='obj_input'){if(!inp[i]._onsubmit)
inp[i]._onsubmit=function(){me.x_search._onclick();};if(!inp[i]._onclose)
inp[i]._onclose=function(){executeCallbackFunction(oCallBack);me._destruct();};}};_me._value=function(str){if(Is.Defined(str)){var aData=this._parse(str);if(aData.before&&(aData.before=new IcewarpDate(aData.before))!=NaN)
this.X_BEFORE._value(1);else
delete aData.before;if(aData.after&&(aData.after=new IcewarpDate(aData.after))!=NaN)
this.X_AFTER._value(1);else
delete aData.after;loadDataIntoForm(this,aData);}
else{var aValues={},aOut=[];storeDataFromForm(this,aValues);for(var i in aValues){if(Is.String(aValues[i]))
aValues[i]=aValues[i].trim();switch(i){case'private':case'busy':case'free':case'done':if(aValues[i])
aOut.push('is:'+i);break;case'attachment':if(aValues[i])
aOut.push('has:'+i);break;case'any':if(Is.String(aValues[i])&&aValues[i].length)
aOut.push(aValues[i]);break;case'before':if(this.X_BEFORE._value()&&aValues[i]){var d=IcewarpDate.julian(aValues[i],false,{calendar:IcewarpDate.Calendars.GREGORIAN});aOut.push(i+':'+d.format('searchDate'));}
break;case'after':if(this.X_AFTER._value()&&aValues[i]){var d=IcewarpDate.julian(aValues[i],false,{calendar:IcewarpDate.Calendars.GREGORIAN});aOut.push(i+':'+d.format('searchDate'));}
break;default:if(aValues[i]&&Is.String(aValues[i])){switch(i){case'from':case'to':case'subject':if(aValues[i].indexOf(' ')>-1&&!(aValues[i].charAt(0)=='('&&aValues[i].charAt(aValues[i].length-1)==')'))
aValues[i]='('+aValues[i]+')';break;default:if(aValues[i].indexOf(' ')>-1&&!((aValues[i].charAt(0)=='"'&&aValues[i].charAt(aValues[i].length-1)=='"')||(aValues[i].charAt(0)=='('&&aValues[i].charAt(aValues[i].length-1)==')'))){if(aValues[i].toLowerCase().indexOf(' and ')>-1||aValues[i].toLowerCase().indexOf(' or ')>-1)
aValues[i]='('+aValues[i]+')';else{aValues[i]=aValues[i].replace(/\"/g,'\\"');aValues[i]='"'+aValues[i]+'"';}}}
aOut.push(i+':'+aValues[i]);}}}
return aOut.join(' ');}};_me._parse=function(str){var str=str.trim()+' ';var sChar='',out={'any':''},flags={'slash':false,'word':'','block':false,'block2':0,'key':false};for(var i=0;i<str.length;i++){sChar=str.charAt(i);if(flags.slash)
flags.word+=sChar;else
switch(sChar){case'\\':flags.slash=true;continue;case'"':flags.block=!flags.block;break;case'(':if(flags.block2)
flags.word+=sChar;flags.block2++;break;case')':if(flags.block2>0)
flags.block2--;if(flags.block2)
flags.word+=sChar;break;case' ':if(flags.block||flags.block2>0)
flags.word+=sChar;else
if(flags.key){if(flags.key=='is'||flags.key=='has')
out[flags.word]=true;else
out[flags.key]=flags.word;flags.word='';flags.key='';}
else
if(flags.word){out['any']+=' '+flags.word;flags.word='';}
break;case':':if(flags.word&&!flags.block&&!flags.block2){flags.key=flags.word;flags.word='';break;}
default:flags.word+=sChar;}
flags.slash=false;}
out['any']=out['any'].trim();if(out['any']==''||out['any']=='?')
delete out['any'];return out;};

/* client/inc/obj_select.js */
_me=obj_select.prototype;function obj_select(){};_me.__constructor=function(){var me=this;this._readonly(true);this.__idTable={};this.__natSort=false;this.__eLBL=mkElement('label',{className:'unselectable'});this._main.appendChild(this.__eLBL);AttachEvent(this._main,'onclick',function(e){if(!me._disabled()){var e=e||window.event;me._focus();if(me.block&&me.block._destructed==false){me.block._destruct();}else{me._show();}}});var oldVal='';this.__eIN.onkeydown=function(e){var e=e||window.event;oldVal=this.value;switch(e.keyCode){case 13:if(!me.block||me.block._destructed)
me._show();else
if(me.block)
me.block._destruct();case 9:case 27:if(me.block&&!me.block._destructed&&e.keyCode!=13){me.block._destruct();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;}
if(!this._readonly&&me._onsubmit)
me._onsubmit(e);if(e.preventDefault)
e.preventDefault();break;case 38:var tmp=null;if(Is.Defined(me.__value)){for(var i in me.__idTable)
if(me.__idTable.hasOwnProperty(i)){if(me.__value==i)break;tmp=i;}
if(tmp!=null)
me._value(tmp);}
return false;case 40:var tmp=null;if(Is.Defined(me.__value)){for(var i in me.__idTable)
if(me.__idTable.hasOwnProperty(i)){if(tmp!=null){tmp=i;break;}
if(i==me.__value)
tmp=me.__value;}
if(tmp!=null)
me._value(tmp);}
return false;}
if(me._onkeydown)return me._onkeydown(e);me.__exeEvent('onkeydown',e,{"owner":me});return e.keyCode==13?false:true;};this.__searchPointer=0;this.__searchValue='';AttachEvent(this.__eIN,'onkeyup',function(e){if(!me._disabled()&&me._readonly()){if(oldVal!=this.value){oldVal=this.value;me._quickSearch();}
else
return false;}});};_me._setNatSort=function(bNatSort){this.__natSort=bNatSort;};_me._quickSearch=function(){var inp=this.__inputValue().toLowerCase(),old=this.__searchValue,resetPointer=false;if(old!=inp&&this._getTextValue().toLowerCase().indexOf(inp)!=0)
resetPointer=true;if((this.__searchValue=inp)){var res=[];for(var i in this.__idTable){var s=(Is.Object(this.__idTable[i])?this.__idTable[i][0]:this.__idTable[i]).toLowerCase();if(s.indexOf(inp)===0){res.push(i);if(resetPointer||res.length-1==this.__searchPointer){this.__searchPointer=resetPointer?1:this.__searchPointer+1;this._value(i);return;}}}
if(!Is.Empty(res)){this.__searchPointer=1;this._value(res[0]);}
else{if(inp.length>1){inp=inp.substr(-1);if(old!=inp)
this.__searchPointer=0;this.__inputValue(inp);this._quickSearch();}
else{this.__inputValue('');}}}};_me._show=function(e){setTimeout(function(){this.__searchPointer=0;this.__searchValue='';if(this._oncreateOptionList)
this._oncreateOptionList();if(count(this.__idTable)){var pos=getSize(this._main),me=this;this.block=gui._create('block','obj_block_ext2','','bubble1 obj_select_plus '+(this._custom_list_className||this._main.className||''),this._main);this.block._place(pos.x,pos.y+pos.h-1);this.block._telemetry='off';if(pos.w<500){this.block._main.style.visibility='hidden';this.block._main.style.minWidth=pos.w+'px';this.block._main.style.maxWidth='500px';}
else
this.block._main.style.width=pos.w+'px';AttachEvent(this.block._main,'onclick',function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='A')
elm=Is.Child(elm,'A',this);if(elm&&elm.tagName=='A'){me._focus();me._value(elm.rel);if(me.block)
me.block._destruct();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;if(gui.telemetry)
gui.telemetry._add({id:me._pathName,type:me._type});}});var elm2,elm=mkElement('div',{className:'maxbox'}),v=this._readonly()?this.__value:this.__inputValue();this.block._main.appendChild(elm);var keys=Object.keys(this.__idTable);if(this.__natSort){keys.sort(function(a,b){return a.localeCompare(b,undefined,{numeric:true,sensitivity:'base'});});}
keys.forEach(function(i){if(Is.Object(this.__idTable[i])){if(Is.Object(this.__idTable[i][0])){elm2=mkElement('a',{rel:i,text:this.__idTable[i][0].text||'',className:this.__idTable[i][1],title:this.__idTable[i][2]||''});if(this.__idTable[i][0].html)
elm2.innerHTML+=this.__idTable[i][0].html;}
else{elm2=mkElement('a',{rel:i,text:this.__idTable[i][0],className:this.__idTable[i][1],title:this.__idTable[i][2]||''});}}
else
elm2=mkElement('a',{rel:i,text:this.__idTable[i]});elm.appendChild(elm2);if(i==v){addcss(elm2,'active');this.__scrollActive(elm2);}},this)
elm.style.width=elm.offsetWidth+'px';elm=null;if(pos.w<500){if(this.block._main.offsetWidth>500)
this.block._main.style.width='500px';this.block._main.style.visibility='visible';}
if(this.block._main.offsetHeight>260)
this.block._scrollbar(this.block._main.firstChild,this.block._main);if(gui.frm_main&&gui.frm_main._main&&(pos.y+pos.h+this.block._main.offsetHeight>gui.frm_main._main.offsetHeight)&&(this.block._main.offsetHeight<pos.y))
this.block._place(pos.x,pos.y-this.block._main.offsetHeight+1);}
this.__exeEvent('show',e,{"owner":this});}.bind(this),5);};_me.__scrollActive=function(elm){if(elm&&this.block&&this.block._main&&this.block._main.firstChild.clientHeight<this.block._main.firstChild.scrollHeight){var pos1=getSize(elm),pos2=getSize(this.block._main.firstChild);if(pos1.y<pos2.y)
this.block._main.firstChild.scrollTop+=pos1.y-pos2.y;else
if(pos1.y+pos1.h>pos2.y+pos2.h)
this.block._main.firstChild.scrollTop+=((pos1.y+pos1.h)-(pos2.y+pos2.h));}};_me._fill=function(aData){this.__idTable=aData||{};};_me._fillLang=function(aData){this.__idTable={};if(aData)
for(var i in aData){if(typeof aData[i]=='object')
this.__idTable[i]=[getLang(aData[i][0],aData[i][1]),aData[i][2]];else
this.__idTable[i]=getLang(aData[i]);}};_me._value=function(v,bNoEvn){if(Is.Defined(v)){if(!this._readonly())
this.__value=this.__inputValue();if(v==this.__value){if(!bNoEvn){if(this._onselect)
this._onselect(null);this.__exeEvent('onselect',null,{"owner":this});}
return true;}
else
if(!bNoEvn&&this.__value){if(this._onbeforechange&&this._onbeforechange(this.__value,v)===false)
return;this.__exeEvent('onbeforechange',null,{"owner":this,"before":this.__value,"current":v});}
var bBlock=this.block&&this.block._destructed==false,bReturn=false;this.__value=v;if(this.__idTable[v]){bReturn=true;if(Is.Object(this.__idTable[v])){this._main.setAttribute('iw-value',this.__idTable[v][1]);if(this._readonly()){if(this.__idTable[v][2])
this.__eLBL.title=this.__idTable[v][2];if(Is.Object(this.__idTable[v][0])){this.__eLBL.innerText=this.__idTable[v][0].text||'';if(this.__idTable[v][0].html)
this.__eLBL.innerHTML+=this.__idTable[v][0].html;}
else
this.__eLBL.innerText=this.__idTable[v][0];}
else
this.__eIN.value=Is.Object(this.__idTable[v][0])?this.__idTable[v][0].text||'':this.__idTable[v][0];}
else{if(this._readonly())
this.__eLBL.innerText=this.__idTable[v];else
this.__eIN.value=this.__idTable[v];this._main.removeAttribute('iw-value');}
if(bBlock){var elms=this.block._main.getElementsByTagName('A')||[];for(var i=elms.length-1;i>=0;i--){if(elms[i].rel==v){addcss(elms[i],'active');this.__scrollActive(elms[i]);}
else
removecss(elms[i],'active');}}}
else
if(!this._readonly())
this.__inputValue(v);if(!bNoEvn){if(this._onchange)
this._onchange(null);this.__exeEvent('onchange',null,{"owner":this});if(this._onselect)
this._onselect(null);this.__exeEvent('onselect',null,{"owner":this});}
if(this.__restrictions)
this.__check();return bReturn;}
else
return this._readonly()?this.__value:this.__inputValue();};_me._readonly=function(b){if(Is.Defined(b)){this.__readonly=!!b;if(b)
addcss(this._main,'readonly');else
removecss(this._main,'readonly');}
else
return this.__readonly;};_me._getTextValue=function(){if(this._readonly()){if(Is.Defined(this.__value))
return Is.Object(this.__idTable[this.__value])?this.__idTable[this.__value][0]:this.__idTable[this.__value];else
return'';}
else
return this.__inputValue();};_me._getDataValue=function(){if(this._readonly()){if(Is.Defined(this.__value))
return Is.Object(this.__idTable[this.__value])?this.__idTable[this.__value][1]:this.__idTable[this.__value];}
return;};_me.__inputValue=function(v){if(Is.Defined(v)){this.__eIN.value=v;this.__eLBL.innerText=v;}
else
return this.__eIN.value||'';};_me.__update=function(sDataSet){if(!sDataSet)return;if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));else
if(this._listener_data==sDataSet)
this._fill(dataSet.get(this._listener_data,this._listenerPath_data));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};

/* client/inc/obj_select_import.js */
_me=obj_select_import.prototype;function obj_select_import(){};_me.__constructor=function(){this.__selectdata={NONE:'----',ITMCOMPANY:getLang('CONTACT::COMPANY'),ITMCLASSIFYAS:getLang('CONTACT::CONTACT_NAME'),ITMFIRSTNAME:getLang('CONTACT::FIRST_NAME'),ITMMIDDLENAME:getLang('CONTACT::MIDDLE_NAME'),ITMSURNAME:getLang('CONTACT::LAST_NAME'),ITMNICKNAME:getLang('CONTACT::NICK_NAME'),ITMTITLE:getLang('CONTACT::TITLE'),ITMSUFFIX:getLang('CONTACT::SUFFIX'),LCTEMAIL1:getLang('BACKUP::EMAIL1'),LCTEMAIL2:getLang('BACKUP::EMAIL2'),LCTEMAIL3:getLang('BACKUP::EMAIL3'),LCTPHNWORK1:getLang('BACKUP::PHONE1'),LCTPHNHOME1:getLang('BACKUP::PHONE2'),LCTPHNHOME2:getLang('BACKUP::PHONE5'),LCTPHNFAXWORK:getLang('BACKUP::PHONE3'),LCTPHNMOBILE:getLang('BACKUP::PHONE4'),LCTSTREETB:getLang('CONTACT::STREET')+" ("+getLang('CONTACT::BUSINESS')+")",LCTCITYB:getLang('CONTACT::CITY')+" ("+getLang('CONTACT::BUSINESS')+")",LCTSTATEB:getLang('CONTACT::STATE')+" ("+getLang('CONTACT::BUSINESS')+")",LCTZIPB:getLang('CONTACT::ZIP')+" ("+getLang('CONTACT::BUSINESS')+")",LCTCOUNTRYB:getLang('CONTACT::COUNTRY')+" ("+getLang('CONTACT::BUSINESS')+")",LCTWEBPAGEB:getLang('CONTACT::WEB')+" ("+getLang('CONTACT::BUSINESS')+")",LCTSTREET:getLang('CONTACT::STREET')+" ("+getLang('CONTACT::PERSONAL')+")",LCTCITY:getLang('CONTACT::CITY')+" ("+getLang('CONTACT::PERSONAL')+")",LCTSTATE:getLang('CONTACT::STATE')+" ("+getLang('CONTACT::PERSONAL')+")",LCTZIP:getLang('CONTACT::ZIP')+" ("+getLang('CONTACT::PERSONAL')+")",LCTCOUNTRY:getLang('CONTACT::COUNTRY')+" ("+getLang('CONTACT::PERSONAL')+")",LCTWEBPAGE:getLang('CONTACT::WEB')+" ("+getLang('CONTACT::PERSONAL')+")",LCTSTREETO:getLang('CONTACT::STREET')+" ("+getLang('CONTACT::OTHER_L')+")",LCTCITYO:getLang('CONTACT::CITY')+" ("+getLang('CONTACT::OTHER_L')+")",LCTSTATEO:getLang('CONTACT::STATE')+" ("+getLang('CONTACT::OTHER_L')+")",LCTZIPO:getLang('CONTACT::ZIP')+" ("+getLang('CONTACT::OTHER_L')+")",LCTCOUNTRYO:getLang('CONTACT::COUNTRY')+" ("+getLang('CONTACT::OTHER_L')+")",LCTWEBPAGEO:getLang('CONTACT::WEB')+" ("+getLang('CONTACT::OTHER_L')+")",ITMINTERNETFREEBUSY:getLang('CONTACT::CALENDAR_URL'),LCTIM:getLang('CONTACT::IM'),ITMBDATE:getLang('CONTACT::BIRTHDATE'),ITMGENDER:getLang('CONTACT::GENDER'),ITMANNIVERSARY:getLang('CONTACT::ANNIVERSARY'),ITMSPOUSE:getLang('CONTACT::SPOUSE'),ITMCATEGORY:getLang('CONTACT::CATEGORY'),ITMJOBTITLE:getLang('CONTACT::JOB'),ITMPROFESSION:getLang('CONTACT::PROFESSION'),ITMDEPARTMENT:getLang('CONTACT::DEPARTMENT'),ITMASSISTANTNAME:getLang('CONTACT::ASSISTANT'),ITMMANAGERNAME:getLang('CONTACT::MANAGER'),ITMOFFICELOCATION:getLang('CONTACT::OFFICE_LOCATION'),ITMDESCRIPTION:getLang('CONTACT::NOTES'),ITMSHARETYPE:getLang('CONTACT::SHARE_TYPE')};this.__eBody=mkElement('div');this._main.appendChild(this.__eBody);};_me.__exportdata={COMPANY:"ITMCOMPANY",CONTACTNAME:"ITMCLASSIFYAS",FIRSTNAME:"ITMFIRSTNAME",MIDDLENAME:"ITMMIDDLENAME",LASTNAME:"ITMSURNAME",NICKNAME:"ITMNICKNAME",TITLE:"ITMTITLE",SUFFIX:"ITMSUFFIX",EMAIL:"LCTEMAIL1",EMAIL2:"LCTEMAIL2",EMAIL3:"LCTEMAIL3",PHONE_WORK:"LCTPHNWORK1",PHONE_HOME:"LCTPHNHOME1",PHONE_HOME2:"LCTPHNHOME2",PHONE_FAX:"LCTPHNFAXWORK",PHONE_MOBILE:"LCTPHNMOBILE",STREETB:"LCTSTREETB",CITYB:"LCTCITYB",STATEB:"LCTSTATEB",ZIPB:"LCTZIPB",COUNTRYB:"LCTCOUNTRYB",WEB:"LCTWEBPAGEB",STREET:"LCTSTREET",CITY:"LCTCITY",STATE:"LCTSTATE",ZIP:"LCTZIP",COUNTRY:"LCTCOUNTRY",HOMEPAGE:"LCTWEBPAGE",STREETO:"LCTSTREETO",CITYO:"LCTCITYO",STATEO:"LCTSTATEO",ZIPO:"LCTZIPO",COUNTRYO:"LCTCOUNTRYO",HOMEPAGEO:"LCTWEBPAGEO",BIRTHDAY:"ITMBDATE",GENDER:"ITMGENDER",ANNIVERSARY:"ITMANNIVERSARY",SPOUSE:"ITMSPOUSE",CATEGORY:"ITMCATEGORY",FREEBUSYURL:"ITMINTERNETFREEBUSY",IM:"LCTIM",JOB:"ITMJOBTITLE",PROFESSION:"ITMPROFESSION",DEPARTMENT:"ITMDEPARTMENT",ASSISTANT:"ITMASSISTANTNAME",MANAGER:"ITMMANAGERNAME",OFFICELOCATION:"ITMOFFICELOCATION",NOTES:"ITMDESCRIPTION",SHARETYPE:"ITMSHARETYPE"};_me._fill=function(aData){this._clean();for(var i in this._anchors)
if(i.indexOf('select_')==0)
delete this._anchors[i];this.__eBody.innerHTML='';this._create('scrollbar','obj_scrollbar','main','',false,true)._scrollbar(this.__eBody,this._main);if(typeof aData!='object'||Is.Empty(aData))return false;var len=aData[0].length,out='<table>';for(var i=0;i<len;i++)
out+='<col>';out+='<thead><tr>';for(var i=0;i<len;i++){out+='<th id="'+this._pathName+'#select_'+i+'"></th>';this._anchors['select_'+i]=this._pathName+'#select_'+i;}
out+='</tr></thead>';out+='<tbody>';for(var i=0;i<aData.length;i++){out+='<tr>';for(var j=0;j<len;j++){out+='<td>'+(aData[i][j]?aData[i][j].escapeHTML():'')+'</td>';}
out+='</tr>';}
out+='</tbody>';out+='</table>';this.__eBody.innerHTML=out;var me=this,cols=this.__eBody.getElementsByTagName('col');for(var i=0;i<len;i++){var obj=this._create('select_'+i,'obj_select','select_'+i);obj._fill(this.__selectdata);if(this.__exportdata[aData[0][i]]){obj._value(this.__exportdata[aData[0][i]]);addcss(cols[i],'active');}
else
obj._value('NONE');obj._onchange=function(){var col=me.__eBody.getElementsByTagName('col')[this._name.substr(7)];if(this._value()=='NONE')
removecss(col,'active');else
addcss(col,'active');};}};_me._refill=function(aData){if(typeof aData!='object'||Is.Empty(aData))return false;var len=aData[0].length,out='';for(var i=0;i<aData.length;i++){out+='<tr>';for(var j=0;j<len;j++){out+='<td>'+(aData[i][j]?aData[i][j].escapeHTML():'')+'</td>';}
out+='</tr>';}
var tbody=this.__eBody.getElementsByTagName('tbody')[0];tbody.innerHTML=out;}
_me._value=function(){var out={},v,ch=this._getChildObjects(void 0,'obj_select'),loc1=null,loc2=null,loc3=null;for(var i in ch){v=ch[i]._value();if(v=='NONE')continue;if(v.indexOf('LCT')==0){if(v.lastIndexOf('B')==v.length-1){if(!loc2)loc2={VALUES:[{LCTTYPE:[{VALUE:'B'}]}]};loc2.VALUES[0][v.substr(0,v.length-1)]=[{VALUE:i}];}
else
if(v.lastIndexOf('O')==v.length-1){if(!loc3)loc3={VALUES:[{LCTTYPE:[{VALUE:'O'}]}]};loc3.VALUES[0][v.substr(0,v.length-1)]=[{VALUE:i}];}
else{if(!loc1)loc1={VALUES:[{LCTTYPE:[{VALUE:'H'}]}]};loc1.VALUES[0][v]=[{VALUE:i}];}}
else
if(v.indexOf('PHONE_TYPE')==0){}
else
if(v.indexOf('PHONE')==0){if(!loc1)loc1={VALUES:[{LCTTYPE:[{VALUE:'H'}]}]};if(!loc1.PHONES)
loc1.PHONES=[{PHONE:[]}];var atmp={PHNNUMBER:[{VALUE:i}]};var stmp=v.replace('PHONE','PHONE_TYPE');for(var j in ch)
if(ch[j]._value()==stmp)
atmp.PHNTYPE=[{VALUE:j}];loc1.PHONES[0].PHONE.push({VALUES:[atmp]});}
else{if(!out.VALUES)out.VALUES=[{}];out.VALUES[0][v]=[{VALUE:i}];}}
if(loc1||loc2||loc3){out.LOCATIONS=[{LOCATION:[]}];if(loc1)
out.LOCATIONS[0].LOCATION.push(loc1);if(loc2)
out.LOCATIONS[0].LOCATION.push(loc2);if(loc3)
out.LOCATIONS[0].LOCATION.push(loc3);}
return out;};

/* client/inc/obj_select_input.js */
function obj_select_input(){};obj_select_input.prototype.__constructor=function(){this._readonly(false);};

/* client/inc/obj_selectfolder.js */
_me=obj_selectfolder.prototype;function obj_selectfolder(){};_me.__constructor=function(bOneAccount,sFolderType,sFilterRights,bFilterPublic,bForceShowFolderIcons)
{var me=this;this.__value='';this.__primaryOnly=bOneAccount;this.__folderTypes=sFolderType||'';this.__folderRights=sFilterRights;this._create('path','obj_button','main','ico '+(this.__folderTypes.split(',').map(function(ft){return'type_'+ft;}).join(' ')));this.path._onclick=function(){var aPath=Path.split(me.__value);gui._create('select_folder','frm_select_folder','','','SELECT_FOLDER::SELECT_FOLDER',aPath[0],aPath[1],[me,'__callback'],true,me.__primaryOnly,me.__folderTypes,me.__folderRights,false,undefined,bFilterPublic,bForceShowFolderIcons);}};_me.__callback=function(sAccount,sFolder){if(sAccount&&sFolder){if(this.__value&&this._onbeforechange)
this._onbeforechange(this.__value,sAccount+'/'+sFolder);this.__value=sAccount+'/'+sFolder;var name=dataSet.get('folders',[sAccount,sFolder,'NAME']);if(name){sFolder=sFolder.split('/');sFolder.pop();sFolder=sFolder.join('/')+'/'+name;}
this.path._text((this.__primaryOnly?'':sAccount+'/')+translateFolder(sFolder));this.path._title(sAccount+'/'+translateFolder(sFolder),true);if(this._onchange)
this._onchange(this.__value);}};_me._setType=function(s){if(s){this.__folderTypes=s;var css='obj_button ico';if(Is.String(s))
css+=' type_'+s;this.path._main.className=css;}};_me._setRight=function(s){if(Is.Defined(s))
this.__folderRights=s;};_me._value=function(v){if(v){var aPath=Path.split(v);this.__callback(aPath[0],aPath[1]);}
else
return this.__value;};_me._disabled=function(b){return this.path._disabled(b);};

/* client/inc/obj_send_message.js */
_me=obj_send_message.prototype;function obj_send_message(){};_me.__constructor=function(){var me=this;this.__aValues={};this._create('button','obj_button');this.button._value('FILTERS::THREE_DOTS');this.button._onclick=function(){gui._create('send_message','frm_send_message','','',me.__aValues);};};_me._value=function(v){if(Is.Defined(v))
this.__aValues=clone(v);else
return this.__aValues;};_me._disabled=function(b){this.button._disabled(b);};

/* client/inc/obj_sharing.js */
_me=obj_sharing.prototype;function obj_sharing(){};_me.__constructor=function(sPrivate){this.__privateValue=sPrivate||'P';this._create('btn','obj_button_check','main','ico img private simple noborder transparent');this.btn._title('SHARING::PRIVATE');};_me._value=function(v){if(Is.Defined(v)){if(v===true||v==this.__privateValue||v=='C'||v=='P')
this.btn._checked(true);else
this.btn._checked(false);}
else
return(this.btn._checked())?this.__privateValue:'U';};_me._disabled=function(b){return this.btn._disabled(b);};

/* client/inc/obj_sip.js */
_me=obj_sip.prototype;function obj_sip(){};_me.__constructor=function(aHandler){this.__aHandler=aHandler;this.__playSounds=true;storage.library('sip_bridge');this._use_webrtc=window.JsSIP&&IceSIP&&IceSIP.supported();if(document.location.protocol!='https:'){var nortc=gui._create('no_webrtc','frm_confirm','','',[function(){window.open('https://www.icewarp.com/support/troubleshoot_webrtc/?'+buildURL({ishttps:(location.protocol.indexOf("https")===0?'1':'0'),lang:GWOthers.getItem('LAYOUT_SETTINGS','language')}));}],'SIP::SIP','SIP::NOTSECURE');nortc.x_btn_ok._value('ERROR::TROUBLESHOOT');addcss(nortc.x_btn_ok._main,'help');this._destruct();return false;}
var ext=navigator.browser&&navigator.browser.application=='Opera'?'ogg':'mp3';var loc=GWOthers.getItem('LAYOUT_SETTINGS','language')=='en'?'uk':'eu';this._ringtone=new Audio();this._ringtone.src='client/inc/sip/tones/phone.'+ext;this._ringtone.loop=true;this._busytone=new Audio();this._busytone.src='client/inc/sip/tones/busy.'+ext;this._calltone=new Audio();this._calltone.src='client/inc/sip/tones/'+loc+'/call.'+ext;this._calltone.loop=true;this._failtone=new Audio();this._failtone.src='client/inc/sip/tones/fail.'+ext;this.__callBuffer=[];this._add_destructor('__destructor');this.__init();};_me.__init=function(){var me=this;if(this.__timeout)
clearTimeout(this.__timeout);if(this._use_webrtc){obj_sip._activity('');this.__started=true;var c={display_name:dataSet.get('main',['fullname']),trace_sip:true};if(GWOthers.getItem('SIP','external')>0&&(GWOthers.getItem('RESTRICTIONS','disable_esip')||0)<1&&GWOthers.getItem('SIP','user')&&GWOthers.getItem('SIP','pass')&&(GWOthers.getItem('SIP','server')||GWOthers.getItem('SIP','user').indexOf('@'))){var tmp=GWOthers.getItem('SIP','user').split('@');var user=tmp[0];var server=tmp.length==1?GWOthers.getItem('SIP','server'):tmp[1];if(GWOthers.getItem('SIP','ext')){c.authorization_user=user;c.uri='sip:'+GWOthers.getItem('SIP','ext')+'@'+server;}else
c.uri='sip:'+user+'@'+server;c.password=GWOthers.getItem('SIP','pass');}else{var user=sPrimaryAccount.split('@');var port=dataSet.get('accounts',[sPrimaryAccount,'SIP_PORT']);c.uri='sip:'+(dataSet.get('accounts',[sPrimaryAccount,'SIP_EXTENSION'])||dataSet.get('accounts',[sPrimaryAccount,'SIP_USERNAME'])||user[0])+'@'+((dataSet.get('accounts',[sPrimaryAccount,'SIP_HOST'])+(port?':'+port:''))||user[1]);c.ha1=dataSet.get('accounts',[sPrimaryAccount,'SIP_HASH']);c.authorization_user=dataSet.get('accounts',[sPrimaryAccount,'SIP_USERNAME'])||user[0];c.realm=dataSet.get('accounts',[sPrimaryAccount,'SIP_HOST'])||user[1];}
this.phone=new IceSIP(c);this.phone.onconnect=function(e){dataSet.add('sip',['state'],'online');if(me.__aHandler){me.__aHandler.call(me,true);delete me.__aHandler;}};this.phone.ondisconnect=function(e){dataSet.add('sip',['state'],'offline');if(me.__aHandler&&e.reason=='failed'){me.__aHandler.call(me,false);delete me.__aHandler;}};this.phone.onmedia=function(e){if(e.constraints)
me.__process('UserMediaRequested','',e.constraints);else if(e.granted)
me.__process('UserMediaGranted');else
me.__process('UserMediaDenied','',e.reason);};this.phone.oncall=function(e){me.call=e.call;var alias=dataSet.get('accounts',[sPrimaryAccount,'SIP_CALLERALIAS'])||'';var domain=sPrimaryAccount.split('@')[1];alias+='@'+domain;if(domain&&e.user==alias){me.call.onhangup=function(e){};me.call.hangup(488);return;}
var email=MailAddress.createEmail(e.name,e.user);me.call.onhangup=function(e){obj_sip._activity("",true);me.__process(e.remote?'CallCanceled':'CallFinished',email,e.reason);};me.__presentation=e.show;obj_sip._activity("Ringing",true);me.__process('IncomingCall',email,e.video,e.show);};this.phone.start();return true;}else
return false;};_me._login=function(aHandler){if(this.phone&&!this.phone.online()){if(aHandler)
this.__aHandler=aHandler;this.phone.register();}};_me._logout=function(){if(this.phone&&this.phone.online())
this.phone.unregister();dataSet.update('main',['sip']);};_me._add_callbeck=function(aHandler){var tmp=getCallbackFunction(aHandler);for(var i=this.__callBuffer.length-1;i>=0;i--)
if(getCallbackFunction(this.__callBuffer[i])===tmp)
return;this.__callBuffer.push(aHandler);};_me._execute=function(aData){for(var i=this.__callBuffer.length-1;i>=0;i--)
if(!getCallbackFunction(this.__callBuffer[i])||executeCallbackFunction(this.__callBuffer[i],aData)===false)
this.__callBuffer.splice(i,1);};_me.__process=function(sType,sParam1,sParam2,sParam3){var me=this;var sValue='';if(this._ringtone)
this._ringtone.pause();if(this._calltone)
this._calltone.pause();if(sType=='Error'){var str='';if(sParam1=='server'){str=getLang('SIP::UNREACHABLE');dataSet.add('sip',['info'],getLang('SIP::OFFLINE'));}
else{if(sParam1=='unhandled_exception')return;var arr=sParam1.split(',');for(var i=0;i<arr.length;i++)
str+=(str?"\n":'')+getLang('SIP::'+arr[i]);}
gui.notifier._value({type:'sip_not_reachable',args:{header:'SIP::ERROR',text_plain:str}});gui.__exeEvent('sip',{type:'error',p1:sParam1,p2:sParam2,p3:sParam3});return;}
switch(sType.toString()){case'UserMediaRequested':me.__mrfrm=true;setTimeout(function(){if(me.__mrfrm){me.__mrfrm=gui._create('sip_alert','frm_alert','','sip',[function(){}],'SIP::WEBPHONE_SETUP','SIP::MEDIAREQUEST'+(me.__bVideo?'_VIDEO':''));me.__mrfrm._size(620);var browser=false;switch(currentBrowser()){case'Chrome':case'Safari':case'Opera':browser=currentBrowser().toLowerCase();break;case'MSIE7':case'MSIE9':case'MSIE11':browser='IE';case'Mozilla':browser='firefox';}
var label=mkElement('div',{className:'label',textContent:getLang('SIP::ACCESS_'+(me.__bVideo?'CAMERA':'MICROPHONE'))});me.__mrfrm.obj_label._main.insertBefore(label,me.__mrfrm.obj_label._main.firstChild);if(browser){var image=mkElement('img',{className:'image '+browser+(currentBrowser.HighDensity?' x2':''),src:'./client/skins/default/images/allow_dialogs_cross_bws/'+browser+'/'+(me.__bVideo?'camera':'microphone')+'@'+(currentBrowser.HighDensity?'2':'1')+'x.png'});me.__mrfrm.obj_label._main.insertBefore(image,me.__mrfrm.obj_label._main.firstChild);image.onload=function(){me.__mrfrm._size(620,me.__mrfrm.obj_label._main.offsetHeight+110);};}
var test=mkElement('div',{className:'test',textContent:getLang('SIP::BEGIN_TEST')});me.__mrfrm.obj_label._main.appendChild(test);test.onclick=function(){window.open('https://www.icewarp.com/support/troubleshoot_webrtc/?'+buildURL({ishttps:(location.protocol.indexOf("https")===0?'1':'0'),lang:GWOthers.getItem('LAYOUT_SETTINGS','language')}));};me.__mrfrm._size(620,me.__mrfrm.obj_label._main.offsetHeight+110);}},location.protocol.indexOf('https')===0?2500:0);dataSet.add('sip',['media'],'requesting',false);return;case'UserMediaGranted':if(me.__mrfrm&&me.__mrfrm._destruct)
me.__mrfrm._destruct();delete me.__mrfrm;dataSet.add('sip',['media'],'granted',false);return;case'UserMediaDenied':if(me.__mrfrm&&me.__mrfrm._destruct)
me.__mrfrm._destruct();delete me.__mrfrm;var m;switch(sParam2){case'InvalidStateError':m="SIP::INVALIDSTATE";break;case'PermissionDeniedError':case'PERMISSION_DENIED':m="SIP::NOPERMISSION";break;case'TrackStartError':default:m="SIP::MEDIADENIED";}
gui._create('alert','frm_alert','','','','SIP::ERROR',m);dataSet.add('sip',['media'],'denied',false);return;case'PreparingCall':dataSet.add('sip',['video'],!!sParam2,false);return;case'Calling':var tmp=MailAddress.splitEmailsAndNames(sParam1)[0]||{};var name=tmp.name||tmp.email.split('@')[0];dataSet.add('sip',['remote'],{name:name,id:sParam1},false);if(this._calltone)
this._calltone.play();break;case'IncomingCall':var tmp=MailAddress.splitEmailsAndNames(sParam1)[0]||{};var name=tmp.name||tmp.email.split('@')[0];sValue=getLang('SIP::INCOMINGCALL',[name]);gui.notifier._value({type:'sip_incoming',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});dataSet.add('sip',['remote'],{name:name,id:tmp.email||'',video:sParam2||false},false);dataSet.add('sip',['video'],!!sParam2,false);if(this._ringtone)
this._ringtone.play();break;case'Joining':break;case'ConferenceStarted':break;case'ConferenceCanceled':case'ConferenceFinished':break;case'CallEstablished':if(!dataSet.get('sip',['remote','id']))
dataSet.add('sip',['remote'],{id:sParam1},false);sValue=getLang('SIP::CALLESTABLISHED',[sParam1]);gui.notifier._value({type:'sip_established',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});break;case'UserBusy':if(this._busytone)
this._busytone.play();sValue=getLang('SIP::USERBUSY',[dataSet.get('sip',['remote','name'])]);gui.notifier._value({type:'sip_user_busy',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});dataSet.add('sip',['remote'],{},false);break;case'CallFinished':switch(sParam2){case'Rejected':sValue=getLang('SIP::CALLDECLINED');gui.notifier._value({type:'sip_declined',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});break;default:sValue=getLang('SIP::CALLFINISHED');gui.notifier._value({type:'sip_finished',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});}
dataSet.add('sip',['remote'],{},false);dataSet.add('sip',['onhold'],false);break;case'CallCanceled':switch(sParam2){case'Not Found':sValue=getLang('SIP::NOTAVAILABLE');gui.notifier._value({type:'sip_not_reachable',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});if(this._failtone)
this._failtone.play();break;case'Unavailable':sValue=getLang('SIP::USERBUSY',[dataSet.get('sip',['remote','name'])]);gui.notifier._value({type:'sip_user_busy',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});if(this._busytone)
this._busytone.play();break;default:var tmp=MailAddress.splitEmailsAndNames(sParam1)[0]||{};var name=tmp.name||tmp.email.split('@')[0];sValue=getLang('SIP::CALLFINISHED');gui.notifier._value({type:'sip_canceled',args:{header:'SIP::SIP',text_plain:sValue,data:{NAME:name,EMAIL:tmp.email}},group:'sip',save:true});}
dataSet.add('sip',['remote'],{},false);dataSet.add('sip',['onhold'],false);break;case'Info':sValue=getLang('SIP::INFO',[sParam1]);gui.notifier._value({type:'sip_external',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});break;case'Notification':sValue=getLang('SIP::NOTIFICATION',[sParam1,sParam2]);gui.notifier._value({type:'sip_external',args:{header:'SIP::SIP',text_plain:sValue},group:'sip'});break;}
dataSet.add('sip',['info'],sValue,true);dataSet.add('sip',['type'],sType,true);dataSet.add('sip',['p1'],sParam1,true);dataSet.add('sip',['p2'],sParam2,true);dataSet.update('sip');this._execute({type:sType,value:sValue,p1:sParam1,p2:sParam2});};obj_sip._activity=function(sVal,bNoUpd){if(!sVal)
dataSet.add('sip',['muted'],false,false);switch(sVal){case'Phoning':case'Conference':dataSet.add('sip',['timer'],new Date(),true);break;default:dataSet.remove('sip',['timer'],true);}
dataSet.add('sip',['activity'],sVal,bNoUpd);};_me._call=function(address,bVideo,bScreen){var me=this;me.__bVideo=bVideo;address=address.replace(/\s/g,'');if(address.indexOf('sip:')==0)
address=address.substr(4);if(!address)
return false;if(address.indexOf('@')<0){if(GWOthers.getItem('SIP','external')>0&&(GWOthers.getItem('RESTRICTIONS','disable_esip')||0)<1){var server=(GWOthers.getItem('SIP','user')||"").indexOf('@');server=server==-1?GWOthers.getItem('SIP','server'):GWOthers.getItem('SIP','user').substr(server+1);address+='@'+server;}
else
address+='@'+dataSet.get('accounts',[sPrimaryAccount,'SIP_HOST']);}
this.__lastCalled=address;if(this.phone&&this.phone.online()){this.call=new IceSIP.Call(this.phone);this.__process('PreparingCall',address,bVideo);this.call.oncalling=function(e){obj_sip._activity("Calling",true);me.__process('Calling',address,'true');};this.call.onanswer=function(e){obj_sip._activity("Phoning",true);me.__process('CallEstablished',e.user,{});};this.call.onstreaming=function(e){me.__process('Broadcasting','',{});if(e.video)
me.__video(e.video.remote,e.video.local);};this.call.onhangup=function(e){obj_sip._activity("",true);if(e.reason=='Busy')
me.__process('UserBusy');else
me.__process(e.remote?'CallCanceled':'CallFinished',address,e.reason);};this.call.make(address,bVideo,bScreen);return true;}else
return false;};_me.__video=function(remoteStream,localStream){return gui._create('video','frm_video','','',remoteStream,localStream);};_me._dtmf=function(sChar){if(Is.Defined(sChar)){if(this.phone){if(this.call&&this.call.state!='Ended')
this.call.dial(sChar,dataSet.get('accounts',[sPrimaryAccount,'SIP_DTMF'])=="0");}}};_me._hangup=function(){this.__lastCalled='';if(this.phone){if(this.call){this.call.hangup();this.call=null;}}};_me._answerCall=function(){var me=this;this.__lastCalled='';if(this.phone){if(this.call){this.call.onanswer=function(e){obj_sip._activity("Phoning",true);me.__process('CallEstablished',e.user,{});};this.call.onstreaming=function(e){obj_sip._activity("Phoning",true);if(e.video)
me.__video(e.video.remote,e.video.local);};this.call.answer(me.__presentation);}}};_me._declineCall=function(){if(this.phone){if(this.call)
this.call.hangup();}};_me._addVideo=function(){if(this.phone){if(this.call)
this.call.addvideo();}};_me._join=function(conferenceNumber){var me=this;IceSIP.devices(function(d){me.__join(conferenceNumber,d.microphone===false);});};_me.__join=function(conferenceNumber,bSkipMic){var me=this;this.conference=new IceSIP.Conference(this.phone);this._conference_id=conferenceNumber;if(bSkipMic)
this.conference.microphone=false;obj_sip._activity("Joining",true);this.__process('Joining',conferenceNumber,'true');this.conference.onjoined=function(e){me.callid=e.callid;obj_sip._activity("Conference",true);me.__process('ConferenceStarted',e.user,{stream:e.video&&!bOrganise?true:false,callid:e.callid});if(e.video)
me.__video(e.video);};this.conference.onfailed=function(e){if(me.conference.microphone){me.conference.microphone=false;me.conference.join(conferenceNumber);}else{obj_sip._activity("",true);me.__process('ConferenceCanceled','',e.reason);}};this.conference.onended=function(e){obj_sip._activity("",true);me.__process('ConferenceFinished','',e.reason);};this.conference.oninfo=function(e){me.__process('ConferenceInformation',e.mimetype,e.message);};this.phone.onmessage=function(e){if(e.group)
me.__process('IncomingConferenceMessage',e.from_id,e.content);else
me.__process('IncomingParticipantMessage',e.from_id,e.content);};this.conference.onsent=function(e){};this.conference.tracking='data=client%3Dinternal';this.conference.join(conferenceNumber);};_me._passive=function(){return!this.conference.microphone;};_me._mute=function(mute){if(Is.Boolean(mute)){var muted=false;if(this.call)
muted=this.call.mute(mute);else if(this.conference)
muted=this.conference.mute(mute);dataSet.add('sip',['muted'],mute&&muted);}
else
return dataSet.get('sip',['muted'])?true:false;};_me._hold=function(hold){if(Is.Boolean(hold)){var onhold=false;if(this.call)
onhold=this.call.hold(hold);dataSet.add('sip',['onhold'],hold&&onhold);}
else
return dataSet.get('sip',['onhold'])?true:false;};_me._silence=function(quiet){if(this.conference)
this.conference.silence(!!quiet);};_me._share=function(bSend,callback){if(this.conference){this.conference.share=new IceSIP.Sharing(this.conference);this.conference.share.onstarted=function(e){if(e.video)
callback(e.video);else if(e.sending)
callback(true);};this.conference.share.onfailed=function(e){callback(false);};this.conference.share.onended=function(e){callback(false);};if(bSend)
this.conference.share.share();else
this.conference.share.join();}};_me._unshare=function(){if(this.conference&&this.conference.share){this.conference.share.stop();this.conference.share=null;}};_me._leave=function(){obj_sip._activity('');if(this.conference){this._unshare();if(this.conference.state!='Ended')
this.conference.leave();}
this._silence(false);};_me._send=function(from,message,to){this.conference.send(from,message,to);};_me._alive=function(){return this.__started?true:false;};_me.__destructor=function(){if(this.__timeout)
window.clearTimeout(this.__timeout);if(this.phone)
this.phone.stop();};

/* client/inc/obj_slide.js */
_me=obj_slide.prototype;function obj_slide(){};_me.__constructor=function(){this.__eSlide=mkElement('div',{id:this._pathName+'#slide',className:'slide'});this._main.appendChild(this.__eSlide);this._anchors['main']=this.__eSlide.id;};_me._value=function(sName){if(Is.Defined(sName)){var slide=0;if(!Is.Object(this[sName])||this[sName].constructor!==Gui||![].some.call(this.__eSlide.querySelectorAll('.panel'),function(panel,i){if(panel.id===this[sName]._pathName){slide=i;return true;}},this)){var panel=this.__eSlide.querySelector('.panel');sName=panel?panel.id.split('.').pop():undefined;}
if(this.__value!==sName){if(this[this.__value]&&this[this.__value]._oninactive){this[this.__value]._oninactive();}
if(Is.String(sName)&&this[sName]&&this[sName]._onactive){if(Is.Defined(this.__timeout)){clearTimeout(this.__timeout);}
this.__timeout=setTimeout(function(){this[sName]&&!this[sName]._destructed&&this[sName]._onactive();}.bind(this),250);}
this.__value=sName;this.__eSlide.style.transform='translate('+(slide*-100)+'%, 0)';}}
else
return this.__value;};

/* client/inc/obj_slide_panel.js */
_me=obj_slide_panel.prototype;function obj_slide_panel(){};_me._onactive=function(){};_me._oninactive=function(){};

/* client/inc/obj_slider.js */
_me=obj_slider.prototype;function obj_slider(){}
_me.__constructor=function(aValues){var isIE=document.documentMode||/Edge/.test(navigator.userAgent);this.__slider=this._getAnchor('slider');this.__slider.addEventListener(isIE?'change':'input',function(){this._value(this._aValues[this.__slider.value].value);}.bind(this));aValues&&this._fill(aValues);this._getAnchor('before').addEventListener('click',function(){var v=this._aValues[+this.__slider.value-1];v&&this._value(v.value);}.bind(this));this._getAnchor('after').addEventListener('click',function(){var v=this._aValues[+this.__slider.value+1];v&&this._value(v.value);}.bind(this));this._main.className+=isIE?' IE':'';};_me._value=function(v,bNoSave){if(!Is.Defined(v)){return this.__value;}
if(this.__value!=v){var i=false;for(i in this._aValues){if(this._aValues[i].value==v){break;}}
if(i!==false){this.__slider.value=i;this.__value=v;if(this._onchange)
this._onchange(this.__value,bNoSave);this.__exeEvent('onchange',null,{"owner":this});}}};_me._fill=function(aValues){if(aValues){this._aValues=aValues;this.__slider.setAttribute('min',0);this.__slider.setAttribute('max',this._aValues.length-1);}
else
return this._aValues;};

/* client/inc/obj_smart_input.js */
_me=obj_smart_input.prototype;function obj_smart_input(){};_me.__constructor=function(){var me=this;this.__placeholder='';this.__eIN=mkElement('div');this._main.appendChild(this.__eIN);this._readonly(false);this.__eIN.onkeyup=function(e){var e=e||window.event;if(me._onkeyup&&me._onkeyup(e)==false)return false;me.__exeEvent('onkeyup',e,{"owner":me});};this.__eIN.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 8:me._focus();break;case 81:if(window.getSelection){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var node=document.createElement('SPAN');node.contentEditable=false;node.innerHTML='ahoj';range.insertNode(node);range.setStartAfter(node);range.setEndAfter(node);}}
return false;case 13:if(window.getSelection){var sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();var node=document.createTextNode("\r\n");range.insertNode(node);range.setStartAfter(node);range.setEndAfter(node);var node=document.createTextNode("");range.insertNode(node);range.setStartAfter(node);range.setEndAfter(node);}}
break;case 27:if(me._onclose&&me._onclose(e)==false)return false;break;case 9:break;}
if(me._onkeydown&&me._onkeydown(e)===false)return false;me.__exeEvent('onkeydown',e,{"owner":me});if(e.keyCode==13&&e.ctrlKey&&me._onsubmit)
setTimeout(function(){try{me._onsubmit({ctrlKey:true});}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}},0);return e.keyCode==13?false:true;};AttachEvent(this.__eIN,'onkeyup',function(e){if(me._onchange)me._onchange();me.__exeEvent('change',null,{"owner":me});});AttachEvent(this.__eIN,'onpaste',function(e){e.preventDefault();if(e.clipboardData&&e.clipboardData.getData){var text=e.clipboardData.getData("text/plain");document.execCommand("insertHTML",false,text);}
else
if(window.clipboardData&&window.clipboardData.getData){var text=window.clipboardData.getData("Text");insertTextAtCursor(text);}
if(me._onchange)me._onchange();me.__exeEvent('change',null,{"owner":me});});this.__eIN.onfocus=function(e){var e=e||window.event;me.__hasFocus=true;if(me._onfocus)me._onfocus(e);me.__exeEvent('onfocus',e,{"owner":me});addcss(me._main,'focus');return true;};this.__eIN.onblur=function(e){var e=e||window.event;me.__hasFocus=false;if(me._type=='obj_password')
removecss(this,'caps');if(me._onblur&&me._onblur(e)===false)return false;me.__exeEvent('onblur',e,{"owner":me});removecss(me._main,'focus');return true;};this.__eIN.onclick=function(e){var e=e||window.event;if(me._onclick&&me._onclick(e)===false)
return false;me.__exeEvent('click',e,{"owner":me});return true;};this._main.onfocus=function(er){me._focus(true);};function insertTextAtCursor(text){var sel,range;if(window.getSelection){sel=window.getSelection();if(sel.getRangeAt&&sel.rangeCount){range=sel.getRangeAt(0);range.deleteContents();range.insertNode(document.createTextNode(text));}}
else
if(document.selection&&document.selection.createRange)
document.selection.createRange().text=text;};};_me._value=function(v){if(Is.Defined(v)){var v=v.replace(/<br[^>]*>/gi,"\r\n").trim();this.__eIN.innerHTML=v;if(this.__restrictions&&this.__restrictions.length)
this.__check();if(this._onchange)this._onchange();this.__exeEvent('change',null,{"owner":this});}
else
return this.__eIN.innerHTML.replace(/<br[^>]*>/gi,"\r\n").trim();};_me._placeholder=function(str){this.__placeholder=str;if(str){if(!this.__ePH){this.__ePH=mkElement('div',{className:'placeholder'});this._main.appendChild(this.__ePH);this._obeyEvent('change',[this,'__helper_ph']);}
this.__ePH.innerHTML=str;}
else
if(this.__ePH){this._disobeyEvent('change',[this,'__helper_ph']);this.__ePH.parentNode.removeChild(this.__ePH);}
this.__helper_ph();};_me.__helper_ph=function(){if(this.__placeholder&&this._value()==="")
addcss(this._main,'placeholder');else
removecss(this._main,'placeholder');};_me._hasFocus=function(){return this.__eIN.__hasFocus;};_me._readonly=function(b){if(Is.Defined(b)){this.__eIN.contentEditable=!b;if(!!b)
addcss(this._main,'readonly');else
removecss(this._main,'readonly');}
else
return this.__eIN.contentEditable?false:true;};_me._select=function(){var range=document.createRange();range.selectNode(this.__eIN);var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);};_me._getCartPos=function(){var caretOffset=0;if(this._hasFocus()){var element=this._main,doc=element.ownerDocument||element.document,win=doc.defaultView||doc.parentWindow,sel,range,preCaretRange;if(typeof win.getSelection!="undefined"){sel=win.getSelection();if(sel.rangeCount){range=sel.getRangeAt(0);preCaretRange=range.cloneRange();preCaretRange.selectNodeContents(element);preCaretRange.setEnd(range.endContainer,range.endOffset);caretOffset=preCaretRange.toString().length;}}
else
if((sel=doc.selection)&&sel.type!="Control"){range=doc.selection.createRange();preCaretRange=doc.body.createTextRange();preCaretRange.moveToElementText(element);preCaretRange.setEndPoint("EndToEnd",textRange);caretOffset=preCaretTextRange.text.length;}}
return caretOffset;};_me._setRange=function(pos1,pos2){pos1=pos1||0;var range=document.createRange();try{range.setStart(this.__eIN.firstChild,pos1);range.setEnd(this.__eIN.firstChild,pos2);}
catch(r){range.selectNode(this.__eIN);}
var sel=window.getSelection();sel.removeAllRanges();sel.addRange(range);this._focus(true);};

/* client/inc/obj_smilebox.js */
_me=obj_smilebox.prototype;function obj_smilebox(){}
_me.__constructor=function(aResponse){this._create('tabs','obj_tabs','','ico small nobuttons transparent');this.tabs._getAnchor('main').onclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName==='B'&&aResponse){executeCallbackFunction(aResponse,{name:elm.getAttribute('data-name'),smiley:elm.getAttribute('data-smiley'),sprite:elm.getAttribute('data-sprite')});}};Smiles.getSmiles(function(smiles_list){this._init(smiles_list);},this);};_me._init=function(smiles){var me=this;Object.keys(smiles).map(function(type){var tab=me.tabs._create(type,'obj_tab','','ico_'+type);tab._onactive=function(bFirstTime){if(bFirstTime){var em=this._getAnchor('main');em.appendChild(mkElement('H2',{text:getLang('smiles::'+type)}));em.appendChild(mkElement('DIV',{},false,me._createList(smiles[type],type)));}};});this.tabs[this.tabs._value()]._onactive(true);};_me._createList=function(list,type){return Object.keys(list).map(function(smile){return mkElement('span',{},false,[mkElement('b',{title:list[smile].join(' '),'data-name':list[smile][0],'data-smiley':smile,'data-sprite':type,className:'smiley smiley-'+smile+' sprite-'+type})]);});};

/* client/inc/obj_sound.js */
_me=obj_sound.prototype;function obj_sound(){};_me.__constructor=function(){this.__sounds={mail:'msg.mp3',chat:'chat.mp3',im:'im.mp3',im_out:'im_out.mp3'};this.__audio={};};_me._play=function(sName){if(this.__sounds[sName]){if(!this.__audio[sName]){this.__audio[sName]=new Audio();this.__audio[sName].__loaded=false;this.__audio[sName].src='client/inc/sound/'+this.__sounds[sName];this.__audio[sName].oncanplaythrough=function(){this.__loaded=true;try{this.play()}catch(r){}};this.__audio[sName].onended=function(){delete this.__audio[sName];}.bind(this);}
if(this.__audio[sName]&&this.__audio[sName].__loaded&&this.__audio[sName].paused){try{this.__audio[sName].play()}catch(r){}}}};

/* client/inc/obj_storage_usage.js */
_me=obj_storage_usage.prototype;function obj_storage_usage(){}
_me.__constructor=function(quota,usage,id){this._draw('obj_storage_usage');var label='';quota=(quota||0)*1024;usage=(usage||0)*1024;if(quota){this.progress._range(quota);this.progress._value(usage);this.progress._title(100/quota*usage>90?getLang('USAGE::ALMOST_FULL'):'');label=getLang('USAGE::LABEL',[this._format(usage),this._format(quota)]);}else{label=getLang('USAGE::LABEL2',[this._format(usage)]);this._getAnchor('progress').classList.add('no-progress');}
this._getAnchor('label').textContent=label;this._getAnchor('manage').onclick=function(){gui._create('storage','frm_storage','','',id,quota,usage);};};_me._format=function(bytes,decimals){if(!bytes){return'0 B';}
var i=Math.floor(Math.log(bytes)/Math.log(1024));return parseFloat((bytes/Math.pow(1024,i)).toFixed(decimals||1))+' '+['B','KB','MB','GB','TB','PB','EB','ZB','YB'][i];};

/* client/inc/obj_subscriber.js */
function obj_subscriber(){};obj_subscriber.prototype={__constructor:function(){var relogin=false;gui.socket.api._obeyEvent('onstatechange',[function(iState){if(iState==0){relogin=true;}
else
if(iState==2&&relogin){relogin=false;this.__subscribe();}}.bind(this)]);this.__subscribe();},__subscribe:function(){gui.socket.api._subscribe('ALL');}};

/* client/inc/obj_suggest.js */
_me=obj_suggest.prototype;function obj_suggest(){};_me.__constructor=function(){if(!sPrimaryAccountGW)
return;this.__hideTime;this.__showTime;this.__sLastSuggest='';this.__sLastRequestString='';this.__aQuery_data=[];this.__activeFirst=false;this.__active=-1;this._min=3;this._limit=15;this.__cleanDS=true;this.__direction='down';this._listener_data;this._listenerPath_data;this._obeyEvent('onfocus',[this,'__onfocus']);this._obeyEvent('onblur',[this,'__onblur']);this._obeyEvent('onkeyup',[this,'__onkeyup']);this._obeyEvent('onkeydown',[this,'__onkeydown']);this._obeyEvent('onclick',[this,'__onclick']);gui._obeyEvent('click',[this,'__hide']);this._add_destructor('__destructor');};_me.__onfocus=function(){if(this.__hideTime){window.clearTimeout(this.__hideTime);this.__hideTime=null;}
if(this.__showTime)
window.clearTimeout(this.__showTime);if(this.__skipcycle)return;var me=this;this.__showTime=window.setTimeout(function(){try{me.__suggest();}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}},300);};_me.__onblur=function(){if(this.__showTime){window.clearTimeout(this.__showTime);this.__showTime=null;}
if(this.__hideTime)
window.clearTimeout(this.__hideTime);if(this.__skipcycle){this._focus();this.__skipcycle=false;return;}
var me=this;this.__hideTime=window.setTimeout(function(){try{me.__hide();}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}},10);};_me.__onkeydown=function(e){if(this.__showTime){window.clearTimeout(this.__showTime);this.__showTime=null;}
switch(e.keyCode){case 38:if(this.suggest){this.__up();e.preventDefault();return;}
break;case 40:if(this.suggest){this.__dn();e.preventDefault();return;}
break;case 13:if(this.__aQuery_data[this.__active]){if(!this.__sLastRequestString||this.__sLastRequestString==this._input_value()){this._qvalue(this.__aQuery_data[this.__active]);}
this.__hide();e.preventDefault();return;}
else
this.__hide();break;case 27:if(this.suggest){e.preventDefault();e.cancelBubble=true;this.__hide();}}};_me.__onkeyup=function(e){if(!e.keyCode||inArray([9,40,38,13,27],e.keyCode)>-1)return;if(this.__showTime)
window.clearTimeout(this.__showTime);this.__showTime=window.setTimeout("try{"+this._pathName+".__suggest();}catch(e){gui._REQUEST_VARS.debug && console.log(this._name||false,e);}",300);};_me.__onclick=function(e){if(!e.contextmenu){if(this.__hideTime){window.clearTimeout(this.__hideTime);this.__hideTime=null;}
if(this.__showTime)
window.clearTimeout(this.__showTime);this.__showTime=window.setTimeout("try{"+this._pathName+".__suggest();}catch(e){gui._REQUEST_VARS.debug && console.log(this._name||false,e);}",300);}};_me.__show=function(aValues){if(this.__hideTime){window.clearTimeout(this.__hideTime);this.__hideTime=null;}
if(!aValues||!aValues.length||this._destructed||!this.__hasFocus){this.__hide();return;}
if(!this.suggest){this.suggest=gui._create('suggest','obj_block','','gui_suggest_block '+this._type+'_plus');this.suggest._position('absolute');var me=this;this.suggest._main.onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='DIV'){if(currentBrowser()!='Mozilla')
me.__skipcycle=true;return;}
if(elm.tagName=='SPAN')
elm=elm.parentNode;if(elm.tagName=='A'){var list=this.getElementsByTagName('A');for(var i=list.length-1;i>=0;i--)
if(list[i]===elm){me.__skipblur=true;me.__active=i;me._qvalue(me.__aQuery_data[i]);if(me._onmouseselect)
me._onmouseselect();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;me.__hide();return false;}}};this.suggest._main.onmousemove=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm.tagName=='SPAN')
elm=elm.parentNode;if(elm.tagName=='A'){var list=this.getElementsByTagName('A');for(var i=list.length-1;i>=0;i--)
if(list[i]===elm)
me.__activate(elm,i);else
removecss(list[i],'active');}};}
if(this.__active&&this.__aQuery_data&&this.__aQuery_data.length&&this.__active>-1){var tmp,old=this.__aQuery_data[this.__active];if(Is.Array(old))old=old[0];this.__active=this.__activeFirst?0:-1;if(old)
for(var i in aValues){tmp=Is.Object(aValues[i])?aValues[i].value:aValues[i];if(tmp==old){this.__active=i;break;}}}
else
this.__active=this.__activeFirst?0:-1;var elm=mkElement('div');if(this.__caption){if(Is.Function(this.__caption))
elm.appendChild(mkElement('h2',{innerHTML:this.__caption(this.__last_qdata)+'<span>'+getLang('COMMON::ESC_MESSAGE')+'</span>'}));else
elm.appendChild(mkElement('h2',{innerHTML:getLang(this.__caption,[(this.__last_qdata.length?mkElement('b',{text:'"'+this.__last_qdata+'"'}).outerHTML:'')])+'<span>'+getLang('COMMON::ESC_MESSAGE')+'</span>'}));}
var j=0,a;for(var i in aValues){j++;if(Is.Object(aValues[i])){a=mkElement('a');if((aValues[i].value+aValues[i].hint).length>32)
a.title=aValues[i].value+(aValues[i].hint?' '+aValues[i].hint:'');if(aValues[i].css)
a.className=aValues[i].css;a.innerHTML=(aValues[i].prefix||'')+(aValues[i].text||aValues[i].value).escapeHTML()+(aValues[i].hint?'<span>'+aValues[i].hint.escapeHTML()+'</span>':'');}
else
a=mkElement('a',{text:aValues[i]});elm.appendChild(a);}
this.suggest._main.style.height=j>10?'287px':'auto';this.suggest._main.innerHTML=elm.outerHTML;var oPos=getSize(this._main),h=this.suggest._main.offsetHeight;if(oPos.y+oPos.h+h>gui._main.clientHeight&&oPos.y>gui._main.clientHeight-(oPos.y+oPos.h)){this.__direction='up';this.suggest._place(oPos.x,oPos.y-h,this.__minWidth||oPos.w);if(h>oPos.y)
this.suggest._main.style.height=oPos.y+'px';}
else{this.__direction='down';this.suggest._place(oPos.x,oPos.y+oPos.h,this.__minWidth||oPos.w);if(oPos.y+oPos.h+h>gui._main.clientHeight)
this.suggest._main.style.height=gui._main.clientHeight-(oPos.y+oPos.h)+'px';}
this.suggest._main.className='gui_suggest_block '+this._type+'_plus '+this.__direction;this.suggest._focus();var elm;if(this.__active>-1&&(elm=this.suggest._main.getElementsByTagName('A')[this.__active])){this.__activate(elm,this.__active);elm=null;}
this.__aQuery_data=aValues;if(this._destructed)
this.__hide();};_me.__hide=function(){if(this.__hideTime){window.clearTimeout(this.__hideTime);this.__hideTime='';}
this.__aQuery_data=[];this.__active=-1;if(this.suggest){this.suggest._destruct();delete this.suggest;}
this.__sLastSuggest='';};_me.__activate=function(elm,id){this.__active=id;addcss(elm,'active');var ediv=this.suggest._main.firstChild;if(ediv.scrollTop>elm.offsetTop)
ediv.scrollTop=elm.offsetTop;else
if(elm.offsetTop+elm.offsetHeight>ediv.scrollTop+ediv.clientHeight)
ediv.scrollTop=elm.offsetTop+elm.offsetHeight-ediv.offsetHeight;};_me.__up=function(){var list,no=parseInt(this.__active,10);if(no&&this.suggest&&this.suggest._main&&(list=this.suggest._main.getElementsByTagName('A'))){if(this.__direction=='up'&&no<0)
no=list.length;for(var i=list.length-1;i>=0;i--)
if(i==no-1)
this.__activate(list[i],no-1);else
removecss(list[i],'active');}};_me.__dn=function(){var list,no=parseInt(this.__active,10);if(this.suggest&&this.suggest._main&&(list=this.suggest._main.getElementsByTagName('A'))){if(list.length>no+1)
for(var i=list.length-1;i>=0;i--)
if(i==no+1)
this.__activate(list[i],no+1);else
removecss(list[i],'active');}};_me.__destructor=function(){gui._disobeyEvent('click',[this,'__hide']);if(this.__showTime){window.clearTimeout(this.__showTime);this.__showTime=null;}
this.__hide();};_me.__suggest=function(){if(!this.__showTime)return;var inp=this._getFocusElement();if(this._destructed||!inp){this.__hide();return;}
this.__input_value=inp.value;var v=this._qdata(this.__input_value);if(!v||v.length<this._min){this.__hide();return;}
if(this.__sLastSuggest!=v){this._query(v);this.__sLastSuggest=v;}
else
if(!this.suggest&&!this._destructed&&this._parse)
this._parse();};_me._input_value=function(){var inp=this._getFocusElement();return this._destructed||!inp?'':this._qdata(inp.value);};

/* client/inc/obj_suggest_im.js */
_me=obj_suggest_im.prototype;function obj_suggest_im(){};_me.__constructor=function(){this.__activeFirst=true;this._min=1;this._limit=15;this._single=true;};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(this._single){this._value(v);this._setRange(v.length);if(this._onsubmit)
this._onsubmit();}
else{this._value(this.__input_value);var s=this._value(),end=s.slice(this.__last_pos[1]).trim(),txt=s.slice(0,this.__last_pos[0]>0?this.__last_pos[0]+1:0).trim();if(txt.lastIndexOf(';')!=txt.length-1&&txt.lastIndexOf(',')!=txt.length-1)
txt+=',';txt+=(txt?' ':'')+v+(end.indexOf(';')===0||end.indexOf(',')===0?' ':', ');this._value(txt+end);this._setRange(txt.length);}};_me._qdata=function(v){var col=false,sep=[];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':case';':if(!col)
sep.push(i);break;case'"':if(!i||(i&&v.charAt(i-1)!='\\'))
col=!col;}}
var cart=this._getCartPos();var pos1=0,pos2=l;for(var i=0;i<sep.length;i++){if(sep[i]<cart)
pos1=sep[i];else
if(sep[i]>=cart){pos2=sep[i];break;}}
var adr=v.substring(pos1>0?pos1+1:0,pos2);adr=adr.trim();this.__last_pos=[pos1,pos2,adr];return adr;};_me._query=function(v){var aParsed=MailAddress.splitEmailsAndNames(v.toLowerCase())[0],aIn=dataSet.get('xmpp',['roster']),aOut=[];aParsed.name=aParsed.name||aParsed.email;this.__last_qdata=aParsed;for(var id in aIn)
if((aIn[id].name&&aIn[id].name.toLowerCase().indexOf(aParsed.name)>-1)||aIn[id].user.toLowerCase().indexOf(aParsed.email)>-1)
aOut.push({name:aIn[id].name||'',user:aIn[id].user});this._parse(v,aOut);};_me._parse=function(sWord,aValues){if(!aValues||this._input_value()!=sWord){this.__show();this.__sLastRequestString='';removecss(this._main,'error');return;}
var sc=function(a,b){var x=(a.name||'')+a.user.replace(/[\[\]]/g,'');var y=(b.name||'')+b.user.replace(/[\[\]]/g,'');if(x>y)
return 1;else
if(x<y)
return-1;else
return 0;};aValues=aValues.sort(sc);var out=[];for(var i in aValues){name=aValues[i].name;email=aValues[i].user;out.push({value:MailAddress.createEmail(name,email),css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(email)+'\')"></span>'});}
if(out.length){removecss(this._main,'error');this.__show(out);}
else{addcss(this._main,'error');this.__hide();}
this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;};

/* client/inc/obj_suggest_mail.js */
_me=obj_suggest_mail.prototype;function obj_suggest_mail(){};_me.__constructor=function(){this.__activeFirst=true;this._min=2;this._limit=15;this._single=false;this._itemClass=['C','L'];this._obeyEvent('change',[this,'_checksize']);};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(this._single){this._value(v);this._setRange(v.length);}
else{this._value(this.__input_value);var s=this._value(),end=s.slice(this.__last_pos[1]).trim(),txt=s.slice(0,this.__last_pos[0]>0?this.__last_pos[0]+1:0).trim();if(txt.lastIndexOf(';')!=txt.length-1&&txt.lastIndexOf(',')!=txt.length-1)
txt+=',';txt+=(txt?' ':'')+v+(end.indexOf(';')===0||end.indexOf(',')===0?' ':', ');this._value(txt+end);this._setRange(txt.length);}};_me.__getTextWidth=function(){if(!this.__sizediv){this.__sizediv=mkElement('div',{className:'size'});this._main.appendChild(this.__sizediv);}
else
this.__sizediv.innerHTML='';this.__sizediv.appendChild(document.createTextNode(this._value()));var iSize=this.__sizediv.offsetWidth;this.__sizediv.innerHTML='';return iSize;};_me._checksize=function(){if(this.__eIN.offsetWidth>0){var elm=null,siz=this.__getTextWidth()-this.__eIN.offsetWidth;if(siz>-6&&this.__eIN.type=='text')
elm=mkElement('textarea',{id:this._pathName+'#main',name:this._pathName+'#main'});else
if(siz<-5&&this.__eIN.type!='text')
elm=mkElement('input',{"type":'text',id:this._pathName+'#main',name:this._pathName+'#main',className:'obj_input'});if(elm!=null){var p=this._getCartPos();elm.value=this._value();var aMethods=['onclick','onmousedown','onmouseup','onmousemove','onmouseover','onfocus','onblur','onsubmit','onkeydown','onkeyup','onchange'];for(var i in aMethods)
if(this.__eIN[aMethods[i]])
elm[aMethods[i]]=this.__eIN[aMethods[i]];this._main.replaceChild(elm,this.__eIN);this.__eIN=elm;this._setRange(p);}}};_me._qdata=function(v){this._checksize();var col=false,sep=[];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':case';':if(!col)
sep.push(i);break;case'"':if(!i||(i&&v.charAt(i-1)!='\\'))
col=!col;}}
var cart=this._getCartPos();var pos1=0,pos2=l;for(var i=0;i<sep.length;i++){if(sep[i]<cart)
pos1=sep[i];else
if(sep[i]>=cart){pos2=sep[i];break;}}
var adr=v.substring(pos1>0?pos1+1:0,pos2);adr=adr.trim();this.__last_pos=[pos1,pos2,adr];return adr;};_me._query=function(v){if(v.indexOf('[')==0){if(this._itemClass.indexOf('L')>=0){var tmp=v;if(!(v=v.replace(/[\[\]]+/g,'')))
return;this.__last_qdata={email:tmp};v=v.quoteSQL();var aFilter={search:'class:L AND classify:"'+v.replace(/"/g,'\\"')+'"',sort:'ITMCLASSIFYAS',limit:this._limit};}
else
return;}
else{var aParsed=MailAddress.splitEmailsAndNames(v)[0];if(!aParsed.name)
aParsed.name=aParsed.email;this.__last_qdata=aParsed;var sClass='',name=aParsed.name.replace(/"/g,'\\"');if(Is.Array(this._itemClass))
sClass=' AND ('+this._itemClass.map(function(v){return'class:"'+v+'"'}).join(' OR ')+')';var aFilter={search:'has:email AND ('+(GWOthers.getItem('MAIL_SETTINGS_GENERAL','search_primary')==1?'email1':'email')+':"'+aParsed.email.replace(/"/g,'\\"')+'" OR classify:"'+name+'" OR title:"'+name+'" OR name:"'+name+'")'+sClass,sort:'ITMCLASSIFYAS,ITMFIRSTNAME,ITMSURNAME,LCTEMAIL1,LCTEMAIL2,LCTEMAIL3',limit:this._limit};}
if(!sPrimaryAccountGW||(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||'').indexOf('c')>-1)
this._parse(v,[]);else{if(+GWOthers.getItem('RESTRICTIONS','disable_group_sharing'))
aFilter.search+=' AND flags:0';WMItems.list({'aid':sPrimaryAccount,'fid':(GWOthers.getItem('RESTRICTIONS','gal_suggest')==1?"__@@ADDRESSBOOK@@__":Mapping.getDefaultFolderForGWType('C')),'values':['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTEMAIL1','LCTEMAIL2','LCTEMAIL3','LCTTYPE'],'filter':aFilter},'','','',[this,'_parse',[v]]);}};_me._parse=function(sWord,aValues){if(!aValues||this._input_value()!=sWord){this.__show();this.__sLastRequestString='';return;}
var rcp,emails=[],name,email;if((rcp=Cookie.get(['suggest_address']))){emails=MailAddress.splitEmailsAndNames(rcp);name=this.__last_qdata&&this.__last_qdata.name?this.__last_qdata.name.toLowerCase():'';email=this.__last_qdata&&this.__last_qdata.email?this.__last_qdata.email.toLowerCase():'';for(var i=emails.length-1;i>=0;i--)
if(!((email&&emails[i].email.toLowerCase().indexOf(email)>-1)||(name&&emails[i].name.toLowerCase().indexOf(name)>-1)))
emails.splice(i,1);}
if(!Is.Empty(aValues)){for(var aid in aValues)
for(var fid in aValues[aid]);if(aid&&fid&&(aValues=aValues[aid][fid])){delete aValues['/'];delete aValues['#'];delete aValues['$'];delete aValues['@'];var found;for(var i in aValues){if(aValues[i].ITMCLASS=='L'){email=['['+aValues[i].ITMCLASSIFYAS+']'];name='';}
else
if(!aValues[i].LCTEMAIL1&&!aValues[i].LCTEMAIL2&&!aValues[i].LCTEMAIL3)
continue;else{name=aValues[i].ITMCLASSIFYAS||((aValues[i].ITMFIRSTNAME||'')+(aValues[i].ITMSURNAME?' '+aValues[i].ITMSURNAME:''));email=[];if(aValues[i].LCTEMAIL1)
email.push(aValues[i].LCTEMAIL1);if(aValues[i].LCTEMAIL2)
email.push(aValues[i].LCTEMAIL2);if(aValues[i].LCTEMAIL3)
email.push(aValues[i].LCTEMAIL3);}
for(var j in email){found=false;for(var k in emails)
if(emails[k].email.toLowerCase()==email[j].toLowerCase()||(aValues[i].ITMCLASS=='L'&&('['+emails[k].email.toLowerCase()+']')==email[j].toLowerCase())){if(name&&!emails[k].name)
emails[k].name=name;found=true;}
if(!found)
emails.push({name:name,email:email[j]});}}}}
var sc=function(a,b){var x=(a.name||'')+a.email.replace(/[\[\]]/g,'');var y=(b.name||'')+b.email.replace(/[\[\]]/g,'');if(x>y)
return 1;else
if(x<y)
return-1;else
return 0;};emails=emails.sort(sc);var out=[];for(var i in emails){name=emails[i].name;email=emails[i].email;if((name&&this.__last_qdata.name!=name)||(email&&this.__last_qdata.email!=email)){if(email.indexOf('[')===0)
out.push({value:email,css:'avatar'});else
out.push({value:MailAddress.createEmail(name,email),css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(email)+'\')"></span>'});}}
if(out.length)
this.__show(out);else
this.__hide();this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;};

/* client/inc/obj_suggest_phone.js */
_me=obj_suggest_phone.prototype;function obj_suggest_phone(){};_me.__constructor=function(){this.__activeFirst=true;this._limit=15;this._useCookie=false;};_me._query=function(v){this.__last_qdata=v;var aFilter={search:'has:mobile AND (classify:"'+v.replace(/"/g,'\\"')+'" OR title:"'+v.replace(/"/g,'\\"')+'" OR name:"'+v.replace(/"/g,'\\"')+'" OR phone:"'+v.replace(/"/g,'\\"')+'")',sort:'ITMCLASSIFYAS,ITMFIRSTNAME,ITMSURNAME',limit:this._limit};WMItems.list({'aid':sPrimaryAccount,'fid':"__@@ADDRESSBOOK@@__",'values':['ITMTITLE','ITMCLASS','ITMCLASSIFYAS','ITMFIRSTNAME','ITMMIDDLENAME','ITMSURNAME','ITMSUFFIX','LCTPHNMOBILE'],'filter':aFilter},'','','',[this,'_parse']);};_me._parse=function(aValues){if(!aValues){this.__show();return;}
this.__eActive=null;this.__sQuery_data='';if(Is.Empty(aValues))return;for(var aid in aValues)
for(var fid in aValues[aid]);if(aid&&fid)
aValues=aValues[aid][fid];else
return;delete aValues['/'];delete aValues['#'];delete aValues['$'];delete aValues['@'];var emails=[],found,name;for(var i in aValues){name=aValues[i].ITMCLASSIFYAS||((aValues[i].ITMFIRSTNAME||'')+(aValues[i].ITMSURNAME?' '+aValues[i].ITMSURNAME:''));for(var j in aValues[i])
if((j.indexOf('LCTPHN')===0)&&aValues[i][j]){found=false;for(var k in emails)
if(emails[k].email.toLowerCase()==aValues[i][j].toLowerCase()){found=true;break;}
if(!found)
emails.push({name:name,email:aValues[i][j]});}}
function sc(a,b){var x=(a.name||'')+a.email;var y=(b.name||'')+b.email;if(x>y)
return 1;else
if(x<y)
return-1;else
return 0;};emails=emails.sort(sc);var out=[],MSIE=currentBrowser()=='MSIE7';for(var i in emails){name=emails[i].name;email=emails[i].email;if((!name||emails[i].dlist||this.__last_qdata.name==name)&&(!email||this.__last_qdata.email==email))
continue;if(email.indexOf('[')===0)
out.push(MSIE||!sPrimaryAccountGW?email:{value:email,css:'avatar'});else
out.push(MSIE||!sPrimaryAccountGW?MailAddress.createEmail(name,email):{value:MailAddress.createEmail(name,email),css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(email)+'\')"></span>'});}
if(out.length)
this.__show(out);else
this.__hide();};

/* client/inc/obj_suggest_search.js */
_me=obj_suggest_search.prototype;function obj_suggest_search(){};_me.__constructor=function(aFolder){this._min=1;this._limit=15;this._folder;this.__wizard=false;if(aFolder)
this._setFolder(aFolder);else
this._disabled(true);this._placeholder(getLang('TAGS::PLACEHOLDER'));var me=this;this.__setMask({'clear':['&#xe036;',getLang('COMMON::CLEAR')]},[function(id){if(id=='clear')
if(me._value()){me._value('');if(me._onsubmit)
me._onsubmit();}}]);this.__eICO=mkElement('a',{className:'input_ico',onclick:function(e){if(me._onsubmit)me._onsubmit();}});this._main.appendChild(this.__eICO);};_me._setType=function(sType){this.__wizard=false;this.__operators=['tag:','keyword:'];this.__hints=[];var sType=sType.toLowerCase(),sIco=sType;switch(sType){case'g':this.__operators=['title:','after:','before:','folder:'];this.__hints.push('title:','folder:');break;case'm':if(this._folder&&this._folder.fid){var aFolder=dataSet.get('folders',[this._folder.aid,this._folder.fid]);if(aFolder.RSS){sIco='r';this.__operators.push('has:attachment','from:','to:','subject:','is:unread','is:read','is:flagged','smaller:','greater:','after:','before:','priority:','has:tag');this.__hints.push('from:','to:','subject:');if(sPrimaryAccountFULLTEXT){this.__operators.splice(0,0,'fulltext:');this.__hints.push('fulltext:');}
break;}}
this.__operators.push('has:attachment','from:','to:','cc:','bcc:','sms:','subject:','is:unread','is:read','is:flagged','smaller:','greater:','after:','before:','priority:','has:tag');this.__hints.push('from:','to:','subject:');if(sPrimaryAccountFULLTEXT){this.__operators.splice(0,0,'fulltext:');this.__hints.push('fulltext:');}
this.__wizard=true;break;case'c':this.__operators.push('name:','email:','company:','department:','note:','is:public','is:private');this.__hints.push('name:','email:','company:');this.__wizard=true;break;case'n':this.__operators.push('title:','description:');this.__hints.push('title:');this.__wizard=true;break;case'f':this.__operators.push('smaller:','greater:','title:','description:','is:public','is:private','after:','before:');this.__hints.push('title:');this.__wizard=true;break;case't':this.__operators.push('title:','description:','is:done','is:public','is:private','after:','before:');this.__hints.push('title:');this.__wizard=true;break;case'j':case'e':case'w':this.__operators.push('title:','description:','after:','before:','location:','is:public','is:private','is:free','is:busy');this.__hints.push('title:');this.__wizard=true;break;case'i':this.__operators=['from:','aftertime:','beforetime:','creationdate:'];this.__hints.push('from:','aftertime:','beforetime:','creationdate:');break;}
this.__eICO.className='input_ico type_'+sIco;var hint;for(var i in this.__operators)
if(hint=getLang('SEARCH_HINTS::'+this.__operators[i].replace(/[\: ]/g,'').toUpperCase()+'_'+sType.toUpperCase(),false,2))
this.__operators[i]=[this.__operators[i],hint];else
if(hint=getLang('SEARCH_HINTS::'+this.__operators[i].replace(/[\: ]/g,'').toUpperCase()))
this.__operators[i]=[this.__operators[i],hint];};_me._setFolder=function(aFolder,sType){this._disabled(aFolder?false:true);this._folder=aFolder;var sType=WMFolders.getType(aFolder)||sType;if(sType)
this._setType(sType);};_me._getFolder=function(){return this._folder;};_me._qdata=function(v){var cart=this._getCartPos(),block=false,end=false,skip=false,word=[0,0];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case'\\':skip=true;break;case')':case'(':case' ':if(!block){if(cart<=i)
end=true;else
word=[i+1,i+1];}
else
word[1]=i+1;break;case'"':if(skip)
skip=false;else{if(cart<=i){end=true;word[0]=[word[0]-1];}
else
word=[i+1];block=!block;}
default:word[1]=i+1;}
if(end)break;}
v=v.substring(word[0],word[1]).toLowerCase();this.__last_pos=[word[0],word[1],v];return v;};_me._qvalue=function(v){if(Is.Object(v)){if(Is.Object(v.callback))
v=executeCallbackFunction(v.callback);else
v=v.value;}
if(Is.String(v)){this._value(this.__input_value.slice(0,this.__last_pos[0])+v+this.__input_value.substring(this.__last_pos[1]));this._setRange(this.__last_pos[0]+v.length);}
else
this.__skipblur=false;};_me._query=function(v){var tmp,hint,out=[];if(this.__operators.length)
for(var i in this.__operators){if(Is.Array(this.__operators[i])){tmp=this.__operators[i][0].toLowerCase();hint=this.__operators[i][1]||'';}
else{tmp=this.__operators[i].toLowerCase();hint='';}
if(v=='?'||!v||(tmp!=v&&tmp.indexOf(v)===0))
out.push({value:tmp,hint:hint});}
if(!out.length&&this.__hints.length&&v.indexOf(':')<0){var skip=false,str=this.__last_pos[2].substring(0,this.__last_pos[0]);for(var s,i=str.length-1;i>=0;i--){s=str.charAt(i);if(s==':'){skip=true;break;}
else
if(s!=' ')
break;}
if(!skip)
for(var i in this.__hints)
out.push({value:this.__hints[i]+v.toString()});}
this._parse(clone(out));if(v=='tag'||v=='keyword')
return;else
if(v.indexOf(':')>-1){var m=v.match(/^(tag|keyword):\s*(.+)$/i);if(m&&m[2])
v='tag:'+m[2];else
return;}
if(v){var aFilter={search:v.trim(),sort:'TAGNAME',limit:this._limit};if(Is.Object(this._folder))
aFilter.folder=this._folder.fid;WMItems.list({'aid':sPrimaryAccount,'fid':"__@@TAGS@@__",'values':['TAGNAME','TAGCOUNT'],'filter':aFilter},'','','',[this,'__appendTAG',[v,out]]);}};_me.__appendTAG=function(sWord,aOut,aData){if(this.__last_pos[2]==sWord){aData=aData[sPrimaryAccount]['__@@TAGS@@__'];if(parseInt(aData['#'],10)>0){delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];for(var id in aData)
aOut.push({value:'tag:'+(aData[id].TAGNAME.match(/[ \+\-\!]/g)?'"'+aData[id].TAGNAME+'"':aData[id].TAGNAME),hint:getLang('SEARCH_HINTS::TAG2',[aData[id].TAGNAME,aData[id].TAGCOUNT])});this._parse(aOut);}}};_me._parse=function(aValues){if(!Is.Array(aValues)||!aValues.length)
this.__hide();else{if(this.__wizard&&this._createWizard)
aValues.push({value:getLang('SEARCH::WIZARD'),css:'wizard',callback:[this,'_createWizard']});this.__show(aValues);}};

/* client/inc/obj_suggest_tag.js */
_me=obj_suggest_tag.prototype;function obj_suggest_tag(){};_me.__constructor=function(aFolder){this.__activeFirst=true;this._min=1;this._limit=15;this._folder;this.__hints=[];};_me._value=function(v,bSkipCheck){var aOut={},sTag,aTmp=[];if(Is.Defined(v)){if(bSkipCheck)
this.__eIN.value=v;else{aTmp=v.split(',');for(var i=0;i<aTmp.length;i++)
if(aTmp[i]&&(sTag=aTmp[i].trim()))
aOut[sTag]=true;sTag='';for(var i in aOut)
sTag+=(sTag?', ':'')+i;this.__eIN.value=sTag;}
if(this.__restrictions&&this.__restrictions.length)
this.__check();}
else{aTmp=this.__eIN.value.replace(/\r\n/g,"\n").split(',');for(var i=0;i<aTmp.length;i++)
if(aTmp[i]&&(sTag=aTmp[i].trim()))
aOut[sTag]=true;sTag='';for(var i in aOut)
sTag+=(sTag?',':'')+i;return sTag;}};_me._qdata=function(v){var cart=this._getCartPos(),end=false,word=[0,0];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':if(cart<=i)
end=true;else
word=[i+1,i+1];break;default:word[1]=i+1;}
if(end)break;}
v=v.substring(word[0],word[1]);this.__last_pos=[word[0],word[1],v];return v;};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(typeof v!='undefined'){var str1=this.__input_value.slice(0,this.__last_pos[0]),str2=this.__input_value.substring(this.__last_pos[1]);if(str1)
v=' '+v;if(!str2)
v+=', ';this._value(str1+v+str2,true);this._setRange(this.__last_pos[0]+v.length);}};_me._query=function(v){var aFilter={search:'tag:'+v.trim(),sort:'TAGNAME',limit:this._limit};if(Is.Object(this._folder))
aFilter.folder=this._folder.fid;WMItems.list({'aid':sPrimaryAccount,'fid':"__@@TAGS@@__",'values':['TAGNAME','TAGCOUNT'],'filter':aFilter},'','','',[this,'__appendTAG',[v]]);};_me.__appendTAG=function(sWord,aData){if(this.__last_pos[2]==sWord){var aData=aData[sPrimaryAccount]['__@@TAGS@@__'];if(aData&&parseInt(aData['#'],10)>0){delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];aOut=[];for(var id in aData)
if(aData[id].TAGNAME)
aOut.push({value:aData[id].TAGNAME,hint:getLang('TAGS::HINT',[aData[id].TAGCOUNT||0])});this._parse(aOut);}}};_me._parse=function(aValues){if(!Is.Array(aValues)||!aValues.length)
this.__hide();else
this.__show(aValues);};

/* client/inc/obj_tab.js */
_me=obj_tab.prototype;function obj_tab(){};_me.__constructor=function(bFirst){var me=this;this.__eLi=mkElement('li',{id:this._parent._pathName+"/"+this._name,className:this._css});this.__eLi.onmousedown=function(e){var e=e||window.event;e.cancelBubble=true;try{e.preventDefault();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
try{e.stopPropagation();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
if(!me._isActive){me._active(null,true);if(gui.telemetry)
gui.telemetry._add({id:this.id,type:me._parent._type});}
else{if(me._ondeactive)me._ondeactive();me.__exeEvent('ondeactive',null,{"owner":me});}
return false;};this.__eLi.oncontextmenu=function(e){var e=e||window.event;if(me._oncontext)
me._oncontext(e);return false;};var elm=this._parent._getAnchor('links');if(bFirst&&elm.firstChild)
elm.insertBefore(this.__eLi,elm.firstChild);else
elm.appendChild(this.__eLi);};_me._value=function(v,bNoLang){if(v){this.__tabTitle=v;this.__eLi.innerHTML='<span class="mask">'+(bNoLang?v:getLang(v))+'</span><span>'+(bNoLang?v:getLang(v))+'</span>';}
else
return this.__tabTitle||'';};_me._incorrect=function(bError){if(bError)
addcss(this.__eLi,'error');else
removecss(this.__eLi,'error');};

/* client/inc/obj_tab_close.js */
_me=obj_tab_close.prototype;function obj_tab_close(){};_me.__constructor=function(){var me=this;addcss(this.__eLi,'obj_tab_close_link');this.__eLi.onmousedown=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();var elm=e.target||e.srcElement;if(elm.parentElement.tagName=='B'&&!e.button){me._close();}
else
me._active(null,true);return false;};};_me._value=function(v,bNoLang){if(v){this.__tabTitle=v;this.__eLi.innerHTML='<span>'+(bNoLang?v:getLang(v))+'</span><b><span></span></b>';}
else
return this.__tabTitle||'';};

/* client/inc/obj_tab_core.js */
_me=obj_tab_core.prototype;function obj_tab_core(){};_me.__constructor=function(){this._telemetry='off';this._isActive=false;this._isDisabled=false;this._wasActivated=false;var me=this;this.__drawTpl=null;this.__drawObj=null;this.__drawData=null;this._add_destructor('__destruct');this._getAnchor('main').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(me._onclick)me._onclick(e,elm);me.__exeEvent('onclick',e,{"elm":elm,"owner":me});};};_me._disabled=function(b){if(b==this._isDisabled)return;if(b){if(this.__eLi)
addcss(this.__eLi,'disabled');if(this._main)
addcss(this._main,'obj_tabdisabled');}
else{if(this.__eLi)
removecss(this.__eLi,'disabled');if(this._main)
removecss(this._main,'obj_tabdisabled');}
this._isDisabled=b;};_me._readonly=function(){if(this._main)
addcss(this._main,'obj_tabreadonly');var obj=this._getChildObjects();for(var i in obj)
if(obj[i]._readonly)
obj[i]._readonly(true);else
if(obj[i]._disabled)
obj[i]._disabled(true);};_me._active=function(draw,bClick){if(this._isDisabled)return;if(!Is.Boolean(draw))
if(!this._wasActivated)
draw=true;else
draw=false;if(!this._isActive){this._isActive=true;this._wasActivated=true;var old=this._parent._value();this._parent.__value=this._name;if(old&&this._parent[old])
this._parent[old].__deactive();addcss(this._parent._main,'active');if(this._main)
addcss(this._main,'obj_tab_active');if(this.__eLi)
addcss(this.__eLi,'active');if(this.__drawTpl){if(count(this.__drawTpl[2])<=0&&count(this.__drawData)>0)
this.__drawTpl[2]=this.__drawData;this._draw(this.__drawTpl[0],this.__drawTpl[1],this.__drawTpl[2]);this.__drawTpl=null;}
if(this.__drawObj){this.__addObjects(this.__drawObj,null,this.__drawData);this.__drawObj=null;}
if(this.__eLi)
this._parent._scrollHeader(this.__eLi);if(this._onactive)this._onactive(draw,bClick);this.__exeEvent('onactive',null,{"draw":draw,"click":bClick,"owner":this});if(this.__tabIndexes&&this.__tabIndexes.main&&!this.__lastFocus){try{var tmp=window;this.__tabIndexes.main[0].split('.').forEach(function(part){tmp=tmp[part];});if(tmp._focus&&(!tmp._disabled||!tmp._disabled())&&(!tmp._readonly||!tmp._readonly()))
tmp._focus();}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}}
if(this._parent._onchange)
this._parent._onchange(this._name);this._parent.__exeEvent('onchange',null,{"value":this._name,"owner":this._parent});}
else{if(this._onactive)this._onactive(draw,bClick);this.__exeEvent('onactive',null,{"draw":draw,"click":bClick,"owner":this});if(draw)
this._wasActivated=true;}
if(!draw&&this.__last_focused_field)
this.__last_focused_field.focus();if(draw&&this._scrollbar)
this._scrollbar(this._getAnchor('main'));};_me.__deactive=function(bNoEvent){if(this._isActive==false)return;if(this._main){removecss(this._main,'obj_tab_active');this.__last_focused_field=document.activeElement&&document.activeElement.nodeName=='INPUT'&&document.activeElement.type=='text'&&Is.Child(document.activeElement,this._main)?document.activeElement:null;var input=this._main.getElementsByTagName('input');for(var n=input.length-1;n>0;n--)
if(input[n].type=="text")
input[n].blur();}
if(this.__eLi)
removecss(this.__eLi,'active');this._isActive=false;if(this._parent._value()==this._name)
this._parent._value('');if(!bNoEvent){if(this._ondeactive)this._ondeactive();this.__exeEvent('ondeactive',null,{"owner":this});if(this._parent._onchange)
this._parent._onchange('');}};_me._close=function(){if(this._isActive){var aObj=this._parent._getChildObjects(),oPrev;for(var i in aObj)
if(aObj[i]._name==this._name){if(oPrev){oPrev._active();break;}
else
oPrev=1;}
else
if(aObj[i]._active){if(oPrev===1){aObj[i]._active();break;}
else
oPrev=aObj[i];}}
this._destruct();};_me.__destruct=function(){if(this._isActive&&this._parent._value()==this._name)
this._parent._value('');if(this.__eLi){this.__eLi.parentNode.removeChild(this.__eLi);this.__eLi=null;}
this.__eMain=null;if(this._onclose)
this._onclose();};

/* client/inc/obj_tabs.js */
_me=obj_tabs.prototype;function obj_tabs(){};_me.__constructor=function(){this._telemetry='off';var me=this;this._getAnchor('header').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,oTab;if(elm!=this)
if(hascss(elm,'prev')){me._previous();if(sPrimaryTelemetry&&oTab)
gui.telemetry._add({id:me._pathName+'#prev',type:me._type});}
else
if(hascss(elm,'next')){me._next();if(sPrimaryTelemetry&&oTab)
gui.telemetry._add({id:me._pathName+'#next',type:me._type});}
if(oTab)
oTab._active(null,true);return false;};var header2=this._getAnchor('header2');AttachEvent(header2,"onmousewheel",function(e){var e=e||window.event,deltaY=e.deltaY,deltaX=e.deltaX;if(!deltaX&&deltaY)
deltaX=deltaY;var ul=header2.getElementsByTagName('UL')[0],li=ul.getElementsByTagName('LI');if(li&&(li=li[li.length-1])){var l=parseInt(ul.style.marginLeft||0,10);if(li.offsetLeft-(deltaX*6)+li.offsetWidth<header2.clientWidth&&deltaX>0){if(l<0)
ul.style.marginLeft=(l+(header2.clientWidth-(li.offsetLeft+li.offsetWidth)))+'px';}
else{l-=deltaX*6;ul.style.marginLeft=(l>0?0:l)+'px';}}
else
ul.style.marginLeft='';e.cancelBubble=true;e.returnValue=false;if(e.stopPropagation)e.stopPropagation();});this.__onCreateChild=function(sName,sType,sTarget,sClass){if(sName.length&&me[sName]._active&&(!this.__value||this.__value==sName)){me[sName]._active();me.__onCreateChild=null;}};};_me._next=function(){var i,oTab,tmp=false,obj=this._getChildObjects('main');for(i in obj)
if(obj[i]._name==this.__value)
tmp=true;else
if(tmp){oTab=obj[i];break;}
if(oTab)
oTab._active(null,true);};_me._previous=function(){var i,oTab,obj=this._getChildObjects('main');for(i in obj)
if(obj[i]._name==this.__value)
break;else
oTab=obj[i];if(oTab)
oTab._active(null,true);};_me._value=function(v){if(Is.Defined(v)){if(typeof this[v]=='object')
this[v]._active();else{this.__value=v;removecss(this._main,'active');if(this._onchange)
this._onchange(v);this.__exeEvent('onchange',null,{"value":v,"owner":this});}}
return this.__value;};_me._scrollHeader=function(eLi){var eLink=this._getAnchor('links'),iLeft=parseInt(eLi.offsetLeft,10)-parseInt(eLink.style.marginLeft||0),eHead=this._getAnchor('header2');if(eHead.clientWidth>0){if(currentBrowser().indexOf('MSIE')==0){if(parseInt(eLink.style.marginLeft||0,10)*-1>parseInt(eLi.offsetLeft,10))
eLink.style.marginLeft=(parseInt(eLi.offsetLeft,10)*-1)+'px';else
if(parseInt(eLi.offsetLeft,10)+parseInt(eLi.offsetWidth,10)>parseInt(eHead.clientWidth,10)+parseInt(eLink.style.marginLeft||0,10)*-1)
eLink.style.marginLeft=(parseInt(eHead.clientWidth,10)-(parseInt(eLi.offsetLeft,10)+parseInt(eLi.offsetWidth,10)))+'px';}
else{if(eHead.clientWidth<(iLeft+parseInt(eLi.offsetWidth))+parseInt(eLink.style.marginLeft||0)){eLink.style.marginLeft=(parseInt(eHead.clientWidth)-(iLeft+parseInt(Math.min(eHead.clientWidth,eLi.offsetWidth))))+'px';}
else
if(iLeft+parseInt(eLink.style.marginLeft||0)<0){eLink.style.marginLeft=(iLeft*-1)+'px';}}}};

/* client/inc/obj_tag.js */
_me=obj_tag.prototype;function obj_tag(){}
_me.__constructor=function(){var me=this;this.__tagFocus=null;this.__plus_placeholder='';this.__collapse_limit=2;this.__etag=this._getAnchor('tag');this.__etag.onclick=function(e){if(me._readonly()||this.__collapsed){return true}
var e=e||window.event,elm=e.target||e.srcElement;switch(elm.tagName){case'SPAN':if(me._scrollbar){me._focusTag(elm);e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
return false;}else{me._focusTag(elm);}
break;case'EM':me._focusNextTag(elm);if((elm=elm.parentNode)){elm.parentNode.removeChild(elm)}
if(me._onchange){me._onchange()}
me.__exeEvent('onchange',e,{'owner':me});break;case'B':if((elm=elm.parentNode)){me._focusTag(elm);if(me._onexpand){me._onexpand(elm)}
me.__exeEvent('onexpand',e,{'owner':me,elm:elm});e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
return false;}
break;}};this.__etag.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;switch(elm.tagName){case'SPAN':me._editTag(elm);break;}};this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!='INPUT'){me._focus()}};this._readonly(false);};_me._value=function(v,bCollapse,sCollapsedLang){if(Is.Defined(v)){bCollapse=bCollapse&&this.plus;this._editTag();this.__etag.innerHTML='';var aVal=this._decode(v),c=0;for(var i in aVal){if(bCollapse&&c&&!this.__collapsed){aVal[i].css=(aVal[i].css?' ':'')+'collapsed';}
this._addTag(aVal[i]);c++;}
if(this.__collapsed){this._expandInput();}else
if(bCollapse&&c>this.__collapse_limit){this.__collapsed=true;addcss(this._main,'collapsed');this._placeholder(getLang(sCollapsedLang||'CHAT::REACTIONS_BUBBLE',[--c]),true);this.plus._obeyEvent('onfocus',[function(){this._expandInput();return false;}.bind(this)]);}
if(this._onChange){var iHash=this.__etag.innerHTML.hashCode();if(this.__lastHash!==iHash){this._onChange();this.__lastHash=iHash;}}}else{var a=this.__etag.getElementsByTagName('SPAN'),aTags=[];for(var i=0;i<a.length;i++){aTags.push(a[i].getAttribute('val'))}
return this._encode(aTags);}};_me._expandInput=function(){if(this.__collapsed){[].map.call(this._main.querySelectorAll('SPAN.tag.collapsed'),function(a){removecss(a,'collapsed');});this._placeholder(this._placeholder());this.__collapsed=false;removecss(this._main,'collapsed');}};_me._readonly=function(b){if(Is.Defined(b)){if(!(this.__readonly=b?true:false)){removecss(this._main,'readonly');if(!this.plus){this._create('plus','obj_input_dynamic','plus','ico plus');this.plus.__eIN.setAttribute('placeholder',this._placeholder());this.plus._value('');this.plus._obeyEvent('onkeydown',[this,'__inpKey'],true);this.plus._obeyEvent('onblur',[this,'__inpBlur'],true);this.plus._obeyEvent('onfocus',[this,'__inpEvent_plus']);this.plus._obeyEvent('onblur',[this,'__inpEvent_plus']);this.plus._obeyEvent('onkeyup',[this,'__inpEvent_plus']);this.plus._obeyEvent('click',[this,'__inpEvent_plus']);var me=this;this.plus._onkeydown=function(e){if(me._onkeydown&&me._onkeydown(e)===false){return false}
me.__exeEvent('onkeydown',e);};this.plus._onsubmit=function(e){if(me._onsubmit){return me._onsubmit(e)}};}}else{addcss(this._main,'readonly');this._focusTag(null);if(this.plus){this.plus._destruct()}}}else{return this.__readonly}};_me._placeholder=function(s,bTmp){if(Is.String(s)){if(!bTmp){this.__plus_placeholder=s}
this.plus&&this.plus.__eIN&&this.plus.__eIN.setAttribute('placeholder',s);}else{return this.__plus_placeholder}};_me._disabled=function(b){return this._readonly(b);};_me._getFocusedInput=function(){return this.edit||this.plus;};_me._getFocusElement=function(){var o=this._getFocusedInput();if(o){return o.__eIN}};_me._focus=function(){if(this.plus){return this.plus._focus()}};_me._getCartPos=function(){var inp=this._getFocusedInput();return inp&&inp._getCartPos?inp._getCartPos():0;};_me._focusTag=function(elm){if(typeof elm!='undefined'&&(!this.__readonly||elm==null)){if(this.__tagFocus&&this.__tagFocus.parentNode){if(this.__tagFocus===elm){return}else{removecss(this.__tagFocus,'active')}}
if(elm!=null){addcss(elm,'active');this.__tagFocus=elm;if(elm&&this._scrollbar){var ec=this._getAnchor('container'),p1=getSize(ec),p2=getSize(elm);if(p2.y<p1.y){ec.scrollTop-=p1.y-p2.y}else
if(p2.y+p2.h>p1.y+p1.h){ec.scrollTop+=p2.y+p2.h-p1.y-p1.h}}}}
if(this.__tagFocus!=null&&!this.__tagFocus.parentNode){this.__tagFocus=null}
return this.__tagFocus;};_me._focusNextTag=function(elm){var elm=elm||this._focusTag();if(elm&&(elm=elm.nextSibling)){return this._focusTag(elm)}else{return this._focusTag(null)}};_me._focusPrevTag=function(elm){var elm=elm||this._focusTag();if(elm==null){if((elm=this.__etag.lastChild)){return this._focusTag(elm)}else{return null}}
if(elm&&(elm=elm.previousSibling)){return this._focusTag(elm)}};_me._addTag=function(aTag,elm){if(aTag.tag){if(!elm){elm=mkElement('SPAN',{className:'tag'});this.__etag.appendChild(elm);}else{elm.className='tag'}
if(aTag.css){addcss(elm,aTag.css)}
if(aTag.err){addcss(elm,'error')}
elm.innerHTML=(aTag.label||aTag.tag).escapeHTML();elm.setAttribute('val',aTag.tag);if(aTag.expand){addcss(elm,'expand');elm.appendChild(mkElement('B'));}
if(!this.__readonly){elm.appendChild(mkElement('EM'))}
elm.style.backgroundColor=aTag.bgcolor||'';elm.style.color=aTag.color||'';if(this._onchange){this._onchange();}
this.__exeEvent('onchange',null,{'owner':this});}};_me.__inpEvent=function(e,arg){if(e.type=='focus'){this.__hasFocus=true;addcss(this._main,'focus');}else
if(e.type=='blur'){this.__hasFocus=false;removecss(this._main,'focus');}
this.__exeEvent('on'+e.type,e,arg);};_me.__inpEvent_plus=function(e,arg){if(e.type=='keyup'&&this.plus._value().length){this._focusTag(null)}
this.__inpEvent(e,arg);};_me.__inpBlur=function(e,arg){if(this.edit&&arg.owner===this.edit){this.edit._onsubmit()}else{this.__inpKey({keyCode:13},arg)}};_me.__inpKey=function(e,arg){switch(e.keyCode){case 113:var elm;if(this.plus._value()==''&&(elm=this._focusTag())){this._editTag(elm)}
e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
break;case 8:if(this.plus._value()==''){var elm=this._focusPrevTag();if(elm){this._focusNextTag(elm);elm.parentNode.removeChild(elm);if(this._onchange){this._onchange()}
this.__exeEvent('onchange',null,{'owner':this});}}
break;case 46:var elm;if(this.plus._value()==''&&(elm=this._focusTag())){this._focusNextTag(elm);elm.parentNode.removeChild(elm);if(this._onchange){this._onchange()}
this.__exeEvent('onchange',null,{'owner':this});}
break;case 13:var v=this.plus._value();if(v){this.plus._value('');var a=this._decode(v);for(var i in a){this._addTag(a[i])}}
break;case 27:if(this.suggest){this.__hide()}else
if(arg.owner._value().length){arg.owner._value('')}
else{break}
e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
break;case 37:if(this.plus._value()==''){e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
this._focusPrevTag();}
break;case 39:if(this.plus._value()==''){e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
this._focusNextTag();}
break;case 36:case 35:if(!e.shiftKey&&!e.ctrlKey){this._focusTag(null);this.plus._focus();}
break;}};_me._editTag=function(elm){if(this._readonly()||this.__collapsed){return}
if(this.edit){var v=this.edit._value(),elm=this.edit._main.parentNode;this.edit._destruct();if(this.suggest){this.__hide()}
if(elm){if(v){removecss(elm,'edit');elm.removeAttribute('id');var a=this._decode(v);for(var i in a){this._addTag(a[i],elm);elm='';}}else
if(elm.parentNode){elm.parentNode.removeChild(elm)}
this._focus();if(this._onchange){this._onchange()}
this.__exeEvent('onchange',null,{'owner':this});}}else
if(elm){elm.innerHTML='';elm.id=this._pathName+'/'+unique_id();this._anchors.edit=elm.id;addcss(elm,'edit');var me=this;this._create('edit','obj_input_dynamic','edit','noborder edit');this.edit.__maxWidth=parseInt(getComputedStyle(this.edit._main.parentElement).getPropertyValue('max-width')||400,10);this.edit._onsubmit=function(){me._editTag();me._focusTag(null);};this.edit._onblur=function(){me._editTag();};this.edit._onclose=function(e){this._value(elm.getAttribute('val'));me._editTag();e.cancelBubble=true;try{e.preventDefault()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
try{e.stopPropagation()}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}};this.edit._obeyEvent('onfocus',[this,'__inpEvent']);this.edit._obeyEvent('onblur',[this,'__inpEvent']);this.edit._obeyEvent('onkeyup',[this,'__inpEvent']);this.edit._obeyEvent('onkeydown',[this,'__onkeydown']);this.edit._obeyEvent('click',[this,'__inpEvent']);this.edit._onkeydown=function(e){if(e.keyCode==9){me._editTag();if(e.shiftKey){me._focusPrevTag()}else{me._focusNextTag()}
me._editTag(me._focusTag());}else
if(me._onkeydown&&me._onkeydown(e)===false){return false}else{this.__exeEvent('onkeydown',e)}};this.edit._value(elm.getAttribute('val'));this.edit._focus();}};_me._decode=function(v){var aIN=v.split(','),aOut=[];for(var i in aIN){if((aIN[i]=aIN[i].trim())){aOut.push({tag:aIN[i]});}}
return aOut;};_me._encode=function(a){var aOut=[],aUnq={};for(var i in a){if((a[i]=a[i].trim())&&!aUnq[a[i]]){aOut.push(a[i]);aUnq[a[i]]=true;}}
return aOut.join(',');};

/* client/inc/obj_tag_color.js */
_me=obj_tag_color.prototype;function obj_tag_color(){};_me.__constructor=function(){this._listen_data('tags');};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me.__update=function(sDataSet,sDataPath){if(!sDataSet||this._destructed)return;if(this._listener_data==sDataSet)
this._value(this._value());else
if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath));};_me._decode=function(v){var aTags=dataSet.get(this._listener_data,this._listenerPath_data)||{},aIN=v.split(','),aOut=[];for(var i in aIN)
if((aIN[i]=aIN[i].trim())){aOut.push({tag:aIN[i],bgcolor:(aTags[aIN[i]]&&aTags[aIN[i]].TAGCOLOR?aTags[aIN[i]].TAGCOLOR:''),color:(aTags[aIN[i]]&&aTags[aIN[i]].TEXTCOLOR?aTags[aIN[i]].TEXTCOLOR:'')});}
return aOut;};

/* client/inc/obj_tag_suggest.js */
_me=obj_tag_suggest.prototype;function obj_tag_suggest(){};_me.__constructor=function(){this.__activeFirst=true;this._min=1;this._limit=15;this._folder;this.__hints=[];};_me._qdata=function(v){var cart=this._getCartPos(),end=false,word=[0,0];for(var i=0,l=v.length;i<l;i++){switch(v.charAt(i)){case',':if(cart<=i)
end=true;else
word=[i+1,i+1];break;default:word[1]=i+1;}
if(end)break;}
v=v.substring(word[0],word[1]);this.__last_pos=[word[0],word[1],v];return v;};_me._qvalue=function(v){if(Is.Object(v))
v=v.value;if(typeof v!='undefined'){var inp=this._getFocusedInput();if(inp){var old=inp._value();this._qdata(old);inp._value(old.substr(0,this.__last_pos[0])+v+old.substr(this.__last_pos[1]));this.__inpBlur('',{owner:inp});}}};_me._query=function(v){var aFilter={search:'tag:'+v.trim(),sort:'TAGNAME',limit:this._limit};if(Is.Object(this._folder))
aFilter.folder=this._folder.fid;WMItems.list({'aid':sPrimaryAccount,'fid':"__@@TAGS@@__",'values':['TAGNAME','TAGCOUNT'],'filter':aFilter},'','','',[this,'_parse',[v]]);};_me._parse=function(sWord,aData){if(this._input_value()==sWord){var aData=aData[sPrimaryAccount]['__@@TAGS@@__'];if(aData&&parseInt(aData['#'],10)>0){delete aData['/'];delete aData['#'];delete aData['$'];delete aData['@'];aOut=[];for(var id in aData)
if(aData[id].TAGNAME)
aOut.push({value:aData[id].TAGNAME,hint:getLang('TAGS::HINT',[aData[id].TAGCOUNT||0])});if(!Is.Array(aOut)||!aOut.length)
this.__hide();else
this.__show(aOut);}
this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;}
else{this.__show();this.__sLastRequestString='';}};

/* client/inc/obj_tch_control.js */
_me=obj_tch_control.prototype;function obj_tch_control(){};_me.__constructor=function(aOpt,aData,aHandler){this.__state='hidden';if(aOpt){aOpt.nomore=aOpt.noedit&&aOpt.notrash;}
this._draw('obj_tch_control','main',aOpt);this._main.onclick=function(e){var elm=e.target||e.srcElement;if(elm!=this._main&&!hascss(elm,'disabled'))
var rel=elm.getAttribute('rel'),obj,fresh=false;switch(rel){case'like':if(!this.smiles||this.smiles._destructed){this.smiles=gui._create('smiles','obj_minismile','','',[function(sReaction){executeCallbackFunction(aHandler,'reaction',sReaction);}]);fresh=true;}
obj=this.smiles;[].forEach.call(obj._main.querySelectorAll('.active'),function(elm){removecss(tmp,'active');});if(aData.REAVALUE){var tmp=obj._main.querySelector('.'+aData.REAVALUE);if(tmp)addcss(tmp,'active');}
break;case'pin':if(!this.pins||this.pins._destructed){this.pins=gui._create('pins','obj_minipin','','',[function(sType){executeCallbackFunction(aHandler,'pin',sType);}]);fresh=true;}
obj=this.pins;var linkextras;if((aData.PINOWNEMAIL&&aData.PINOWNEMAIL!==sPrimaryAccount)||(aData.EVNLINKEXTRAS&&(linkextras=parseURL(aData.EVNLINKEXTRAS))&&linkextras.AccountEmail))
addcss(obj._main.querySelector('.public'),'disabled');window[aData.GPINWHEN?'addcss':'removecss'](obj._main.querySelector('.public'),'active');window[aData.LPINWHEN?'addcss':'removecss'](obj._main.querySelector('.private'),'active');break;case'more':if(!this.more||this.more._destructed){this.more=gui._create('more','obj_minimore','','',[function(sAction){executeCallbackFunction(aHandler,sAction);}]);if(aOpt.noedit)
addcss(this.more._main.querySelector('.edit'),'disabled');if(aOpt.notrash)
addcss(this.more._main.querySelector('.remove'),'disabled');fresh=true;}
obj=this.more;break;default:addcss(elm,'active');executeCallbackFunction(aHandler,rel);removecss(elm,'active');return;}
['smiles','pins','more'].forEach(function(s){if(rel!=s&&this[s]&&!this[s]._destructed&&this[s].__state=='visible')
this[s]._hide(true);}.bind(this))
if(fresh){obj._modal(true);obj._onclose=function(){obj._hide();this._hide(true);}.bind(this);obj._onstate=function(s){if(s=='visible')
addcss(elm,'active');else
removecss(elm,'active');};}
else
if(obj.__state=='visible'){obj._hide(true);return;}
var pos=getSize(this._main);obj._place({left:'auto',right:(document.body.offsetWidth-pos.x-pos.w)+'px',top:(pos.y-obj._main.offsetHeight-4)+'px'});addcss(elm,'active');obj._show();}.bind(this);};_me._hide=function(bForce){if(this.__state=='visible'){for(var i=0,a=['smiles','pins','more'];a[i];i++)
if(this[a[i]]&&!this[a[i]]._destructed&&this[a[i]].__state=='visible')
if(bForce)
this[a[i]]._hide(true);else
return false;removecss(this._main,'show');this.__state='hidden';if(this._onhide)
this._onhide();}
return true;};_me._show=function(){if(this.__state=='hidden'){addcss(this._main,'show');this.__state='visible';}};

/* client/inc/obj_text.js */
_me=obj_text.prototype;function obj_text(){};_me.__constructor=function(bWrap){this.__placeholder='';var me=this;this.__eIN=mkElement('textarea',{"name":this._pathName+'#main',"id":this._pathName+'#main'});if(bWrap)
this.__eIN.setAttribute('wrap','off');this._main.appendChild(this.__eIN);this.__eIN.className=this._type;this.__eIN.onclick=function(e){var e=e||window.event;if(me._onclick)me._onclick(e);me.__exeEvent('onclick',e,{"owner":me});return true;};this.__eIN.onpaste=function(e){var e=e||window.event;if(me._onpaste)me._onpaste(e);me.__exeEvent('onpaste',e,{"owner":me});return true;};this.__eIN.onfocus=function(e){var e=e||window.event;me.__hasFocus=true;addcss(me._main,'focus');if(me.__placeholder&&this.value==me.__placeholder){removecss(this,'placeholder');this.value='';}
if(me._onfocus)me._onfocus(e);me.__exeEvent('onfocus',e,{"owner":me});return true;};this.__eIN.onblur=function(e){var e=e||window.event;me.__hasFocus=false;removecss(me._main,'focus');if(me.__placeholder&&!this.value){addcss(this,'placeholder');this.value=me.__placeholder;}
if(me._onblur)return me._onblur(e);me.__exeEvent('onblur',e,{"owner":me});return true;};this.__eIN.onkeydown=function(e){var e=e||window.event;if(me._onsubmit&&e.keyCode==13&&e.ctrlKey){if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;setTimeout(function(){me._onsubmit()},0);return false;}
else
if(me._onclose&&e.keyCode==27)
me._onclose(e);if(me._onkeydown&&me._onkeydown(e)===false)return false;me.__exeEvent('onkeydown',e,{"owner":me});return true;};this.__eIN.onkeyup=function(e){var e=e||window.event;if(me._onkeyup&&me._onkeyup(e)===false)return false;me.__exeEvent('onkeyup',e,{"owner":me});return true;};this._main.onfocus=function(er){me._focus(true);};};_me._readonly=function(b){this.__eIN.readOnly=b;if(b)
addcss(this.__eIN,'readonly');else
removecss(this.__eIN,'readonly');};_me._hasFocus=function(){return this.__eIN.__hasFocus;};_me._nowrap=function(b){this.__eIN.setAttribute('wrap',b?'off':'soft');};_me._setRange=function(pos1,pos2){pos1=pos1||0;if(document.selection){var r=this.__eIN.createTextRange();r.collapse(true);r.moveStart("character",pos1);if(pos2)r.moveEnd("character",pos2);r.select();this._focus(true);}
else{this._focus(true);this.__eIN.setSelectionRange(pos1,pos2||pos1);}};_me._getCartPos=function(){if("selectionStart"in this.__eIN)
return this.__eIN.selectionStart;else
if(document.selection){this.__eIN.focus();var r=document.selection.createRange().duplicate();r.moveEnd('character',this.__eIN.value.length);return r.text==''?this.__eIN.value.length:this.__eIN.value.lastIndexOf(r.text);}else
return 0;};_me._value=function(v,bSkipPH,_,callback){if(typeof v!='undefined'){this.__eIN.value=v;if(!bSkipPH){if(this.__restrictions&&this.__restrictions.length)
this.__check();if(this.__placeholder)
if(v)
removecss(this.__eIN,'placeholder');else{this.__eIN.value=this.__placeholder;addcss(this.__eIN,'placeholder');}}
if(this.__resize)
this.__resize();if(!bSkipPH){if(this._onchange)this._onchange();this.__exeEvent('change',null,{"owner":this});}
callback&&callback();}
else
return this.__eIN.value==this.__placeholder?'':this.__eIN.value.replace(/(\r\n|\r|\n)/gm,'\r\n');};_me._placeholder=function(str){if(typeof this.__eIN.placeholder=='undefined'){if(this.__placeholder&&this.__placeholder==this.__eIN.value){removecss(this.__eIN,'placeholder');this.__eIN.value='';}
this.__placeholder=str;if(!this.__eIN.value&&!this._hasFocus()){this.__eIN.value=this.__placeholder;addcss(this.__eIN,'placeholder');}}
else
this.__eIN.placeholder=str;};

/* client/inc/obj_text_dynamic.js */
_me=obj_text_dynamic.prototype;function obj_text_dynamic(){};_me.__constructor=function(bWrap){var me=this;this.__maxHeight=94;AttachEvent(this.__eIN,'onkeyup',function(e){me.__resize()});AttachEvent(this.__eIN,'onpaste',function(e){setTimeout(function(){me&&!me._destructed&&me.__resize()},100)});};_me.__resize=function(){var height=this._main.style.height,bRedraw=false,w=this.__eIN.offsetWidth;var str=this.__eIN.value.replace(/\n$/,"\n.");if(!this.__sizediv){this.__sizediv=mkElement('div',{className:'size'},'',[document.createTextNode(str)]);this._main.appendChild(this.__sizediv);}
else
this.__sizediv.firstChild.nodeValue=str;if(parseInt(this.__sizediv.style.width,10)!==w)
this.__sizediv.style.width=w+'px';var h=(this.__sizediv.offsetHeight<this.__maxHeight?this.__sizediv.offsetHeight:this.__maxHeight);if(h<10){this._main.style.height='';if(this._onresize)
this._onresize({height:this._main.offsetHeight});bRedraw=true;}
else
if(parseInt(this._main.style.height,10)!==h){this._main.style.height=h+'px';if(height!=this._main.style.height){if(this._onresize)
this._onresize({height:parseInt(this._main.style.height)});bRedraw=true;}}
if(bRedraw&&currentBrowser()=='Chrome'){this._parent._main.style.borderRight='1px solid transparent';setTimeout(function(){if(this._parent&&!this._parent._destructed)
this._parent._main.style.borderRight='';}.bind(this),20);}};

/* client/inc/obj_text_dynamic_label_within.js */
_me=obj_text_dynamic_label_within.prototype;function obj_text_dynamic_label_within(){};_me.__constructor=function(){this.__eLabel=document.createElement('label');this._main.insertBefore(this.__eLabel,this._main.firstChild);};_me._label=function(s,bClose){if(Is.Defined(s)){this.__eLabel.title=s;this.__eLabel.innerHTML=(s.length>23?s.substr(0,20)+'...':s)+(bClose?'<em></em>':'');}
else
return this.__eLabel.innerHTML;var i=parseInt(this.__eLabel.offsetWidth);this._main.style.paddingLeft=(i?i+6:0)+'px';};

/* client/inc/obj_text_mentions.js */
_me=obj_text_mentions.prototype;function obj_text_mentions(){};_me.__constructor=function(){this._limit=10;this._min=1;this.__direction='up';this.__folder={};this.__mentions={};};_me.__caption=function(){return getLang('CHAT::MENTIONS_SUGGEST',[mkElement('b',{text:'"'+(this.__last_qdata.length>1?this.__last_qdata.substr(1):getLang('COMMON::ALL'))+'"'}).outerHTML]);};_me._qdata=function(v){var iStart=0,iEnd=0,s,cart=this._getCartPos();for(var i=cart;i>=0&&cart-i<16;i--){s=v.charAt(i);if(s==']')
return;else
if(s=='@'){if((s=v.charAt(i+1))&&s=="[")
return;if(i>0&&(s=v.charAt(i-1))&&/\s/g.test(s)===false)
return;iStart=i;iEnd=cart;break;}}
this.__last_pos=[iStart,iEnd,v.substring(iStart,iEnd),v];return this.__last_pos[2];};_me._query=function(v){if(this.__folder&&this.__folder.aid&&this.__folder.fid&&this._getFocusElement().value===this.__last_pos[3]){this.__last_qdata=v;var aFilter={search:v.substr(1),sort:'FRTISGUEST DESC, FRTNAME, FRTEMAIL',limit:this._limit};if(v.length>1)
aFilter.startswith=1;WMItems.list({'aid':this.__folder.aid,'fid':'__@@GROUP@@__/'+this.__folder.fid,'values':[],'filter':aFilter},'','','',[this,'_parse',[v]]);}};_me._parse=function(sWord,aData){if(this.__last_qdata===sWord&&this._getFocusElement().value===this.__last_pos[3]){if(aData&&(aData=aData[this.__folder.aid])&&(aData=aData['__@@GROUP@@__/'+this.__folder.fid])){var out=[];if(~getLang('CHAT::ALL_MEMBERS').toLowerCase().indexOf(sWord.replace(/^@/,'').toLowerCase())){out.push({value:getLang('CHAT::ALL_MEMBERS'),email:'@all@',css:'avatar'});}
for(var iid in aData)
if(aData[iid].FRTEMAIL)
out.push({value:MailAddress.createEmail(aData[iid].FRTNAME,aData[iid].FRTEMAIL),name:aData[iid].FRTNAME,email:aData[iid].FRTEMAIL,css:'avatar',prefix:'<span class="avatar" style="background-image:url(\''+getAvatarURL(aData[iid].FRTEMAIL)+'\')"></span>'});if(out.length)
this.__show(out);else
this.__hide();this.__sLastRequestString=sWord;this.__sLastSuggest=sWord;}
else
this.__hide();}};_me._qvalue=function(v){var old=this._getFocusElement().value;if(Is.Object(v)&&v.email&&old===this.__last_pos[3]){var s=v.email,a=s.toLowerCase().split('@'),appendix=old.substr(this.__last_pos[1]);if(a[1]&&a[1]==dataSet.get('main',['domain']))
s=a[0];this._mention(v);this._qdata(old);this._value(old.substr(0,this.__last_pos[0])+'@['+s+']'+(appendix?appendix:' '));this._setRange(this.__last_pos[0]+('@['+s+']').length+(appendix?0:1));}};_me._mention=function(v){if(Is.Defined(v)){if(Is.Object(v))
this.__mentions[v.email]=v.name||v.email;else
this.__mentions={};}
else
return this.__mentions;};_me._addMention=function(v){var email=v.email,a=email.toLowerCase().split('@');if(a[1]&&a[1]===dataSet.get('main',['domain']))
email=a[0];this._mention(v);var old=(this._getFocusElement().value||'').trim();this._value((old?old+' ':'')+'@['+email+'] ');this._setRange(this._getFocusElement().value.length);};

/* client/inc/obj_time.js */
_me=obj_time.prototype;function obj_time(){};obj_time.HOURSONLY=/^[0-2]?[0-9]$/;obj_time.HOURSMERIDIEM=/^([0-9]|1[0-2]) ?([pa]m)$/i;obj_time.WITHOUTCOLON=/^([0-2]?[0-9])([0-5][0-9])$/;_me.__constructor=function(bLength){var me=this;if(bLength){this.__regExp=/^([0-2]?[0-9])\:([0-5][0-9])$/;this.__12Format=0;}
else{this.__regExp=/^([0-2]?[0-9])\:([0-5][0-9]) *(pm|am)?$/i;this.__12Format=GWOthers.getItem('LAYOUT_SETTINGS','time_format')>0;}
AttachEvent(this.__eIN,'onblur',function(e){var v=this.value,m;if(v.search(obj_time.HOURSONLY)!=-1)
this.value=v+':00';else if(m=v.match(obj_time.HOURSMERIDIEM))
this.value=m[1]+':00 '+m[2];else if(m=v.match(obj_time.WITHOUTCOLON))
this.value=m[1]+':'+m[2];if(v!=this.value)
me._validate();if(me._onchange)
me._onchange(null);});this._restrict(this.__regExp);};_me._oncreateOptionList=function(){this.__idTable={};var iValue=this.__value;if(iValue){var sMinValue=Math.ceil((iValue%3600000)/60000);if(sMinValue<10)
sMinValue='0'+sMinValue.toString();}
var iWStart=GWOthers.getItem('CALENDAR_SETTINGS','day_begins'),iWEnd=GWOthers.getItem('CALENDAR_SETTINGS','day_ends');for(var j,k='',i=0;i<24;i++){j=i;if(this.__12Format){k=' PM';if(i<12){j=i?i:12;k=' AM';}
else
if(i>12)
j=i-12;}
this.__idTable[i*3600000]=j+':'+'00'+k;if(iValue&&iValue>i*3600000&&iValue<(i+0.5)*3600000)
this.__idTable[iValue]=j+':'+sMinValue+k;if(i>=iWStart&&i<iWEnd){this.__idTable[(i+0.25)*3600000]=j+':'+'15'+k;this.__idTable[(i+0.5)*3600000]=j+':'+'30'+k;this.__idTable[(i+0.75)*3600000]=j+':'+'45'+k;}
else
this.__idTable[(i+0.5)*3600000]=j+':'+'30'+k;if(iValue&&iValue>(i+0.5)*3600000&&iValue<(i+1)*3600000)
this.__idTable[iValue]=j+':'+sMinValue+k;}};_me.__inputValue=function(v){var minute=60000;var hour=3600000;var day=86400000;if(Is.Defined(v)){v=parseInt(v);v=(v===NaN?0:v%day);this.__value=v;var pos='',hours=Math.floor(v/hour),minutes=Math.floor((v%hour)/minute);if(minutes<10)
minutes='0'+minutes;if(this.__12Format){pos=' AM';if(!hours)
hours=12;else
if(hours>11){pos=' PM';if(hours>12)
hours-=12;}}
this.__eIN.value=hours+':'+minutes+pos;}
else{var m=this.__eIN.value.match(this.__regExp);if(m){m[1]=parseInt(m[1]);m[2]=parseInt(m[2]);if(m[3])
switch(m[3].toLowerCase()){case'am':if(m[1]>11)
m[1]=0;break;case'pm':if(m[1]>=12)
m[1]=12;else
m[1]+=12;break;}
else
if(m[1]>23)
m[1]=23;this.__value=(m[1]*3600000)+(m[2]*60000)||0;}
return this.__value;}};

/* client/inc/obj_time_days.js */
_me=obj_time_days.prototype;function obj_time_days(){};_me._value=function(nMilliSeconds,bNoUpdate){var minute=60000;var hour=60*minute;var day=24*hour;if(Is.Defined(nMilliSeconds)){var which,val,negative;if(nMilliSeconds!=0){var time=nMilliSeconds;if(time<0){time=time*-1;negative=true;}
var days=Math.floor(time/day);time%=day;var hours=Math.floor(time/hour);time%=hour;var minutes=Math.floor(time/minute);if(minutes==0){if(hours==0){val=days;which='days';}else{val=hours+24*days;which='hours';}}else{val=minutes+60*(hours+24*days);which='mins';}}else{val='0';which='mins';}
if(negative)val=val*-1;this.x_text._value(val);this.x_type._value(which);if(!bNoUpdate)if(this._onchange)this._onchange();}else{var number=parseInt(this.x_text._value());if(Is.Number(number))
return number*this.__getMultiplier()*60000;else
return 0;}}
_me._disabled=function(b){this.x_text._disabled(b);this.x_type._disabled(b);}
_me.__getMultiplier=function(){var multiplier;switch(this.x_type._value()){case'mins':multiplier=1;break;case'hours':multiplier=60;break;case'days':multiplier=60*24;break;}
return multiplier;}
_me._getMinutes=function(){if(Is.Defined(this.x_text._value()))
return this.x_text._value()*this.__getMultiplier();else
return 0;}
_me._tabIndex=function(sContainer,i,oDock){this.x_text._tabIndex(sContainer,i,oDock);this.x_type._tabIndex(sContainer,i?++i:i,oDock);};_me._focus=function(b){return this.x_text._focus(b);};

/* client/inc/obj_timeinterval.js */
_me=obj_timeinterval.prototype;function obj_timeinterval(){};_me.__constructor=function(bWithAllDay,bWithTZ,oControls){var me=this;if(oControls){for(var n in oControls)
this[n]=oControls[n];}
else
this._draw('obj_timeinterval');this.startDate._ondateselect=function(){me.__setFrom();};this.startTime._onchange=function(){me.__setFrom();};this.endDate._ondateselect=function(){me.__setEnd();};this.endTime._onchange=function(){me.__setEnd();};this.durationTime._onchange=function(){me.__setFrom();};this.durationDays._onkeyup=function(){if(this._value()===''||this._value()=='0')
this._value(me.__allDayEvent()?1:0,true);me.__setFrom();};this.durationDays._onkeydown=function(e){var key=e.keyCode;if(key>46&&key<58)key+=48;if(this._value()==0){if(key==96)
return false;else
if(key>96&&key<106){this._value(key-96,true);return false;}}
if((key>95&&key<106)||(key>36&&key<41)||key==8||key==46||key==16)
return true;else
return false;};if(bWithTZ){if(!this.timezone)
this._create('timezone','obj_timezones','tz','max');if(!this.tzlink)
this._create('tzlink','obj_label','dtzl','tzlink');this.tzlink._value(getLang('TIME_INTERVAL::CHANGE_DEFAULT'));this.tzlink._onclick=function(){gui._create('settings','frm_settings','','','calendar_settings');};storage.library('wm_tools');this.timezone.__tools=new wm_tools();this.timezone._onchange=function(){if(me.__tzid!=this._value()){if(me.__tzid=='F'||this._value()=='F')
me.__tzid=this._value();else{me._disabled(true);this.__tools.timezone({'from':me.__tzid,'to':this._value(),'times':{'start':{'date':me.startDate._value(),'time':Math.floor(me.startTime._value()/60000)},'end':{'date':me.endDate._value(),'time':Math.floor(me.endTime._value()/60000)}}},[me,'__updateTZ',[this._value()]]);}}};this.__updateTZ=function(aData,sTZid){if(this.timezone._value()==sTZid){this.startDate._value(aData['start'].date,true);this.startTime._value(aData['start'].time*60000,true);this.endDate._value(aData['end'].date,true);this.endTime._value(aData['end'].time*60000,true);this.__tzid=sTZid;this.__setEnd();this._disabled(false);this.timezone._focus();}};}
if(bWithAllDay===true||bWithAllDay=='true'){if(!this.allDay)
this._create('allDay','obj_checkbox','all_day')._title('TIME_INTERVAL::ALL_DAY_EVENT');this.allDay._onchange=function(){var bDisable=false;if(this._value()){bDisable=true;me.startTime._value(0,true);me.endTime._value(0,true);}
else{var v=me._value();if(!v.EVNSTARTTIME&&!v.EVNENDTIME){var aActual=getActualEventTime();me.startTime._value(aActual.EVNSTARTTIME*60000,true);me.endTime._value(aActual.EVNENDTIME*60000,true);}}
me.__setEnd();me.startTime._disabled(bDisable);me.endTime._disabled(bDisable);me.durationTime._disabled(bDisable);if(me.timezone)
me.timezone._disabled(bDisable);};}};_me._disabled=function(b){this.startDate._disabled(b);this.startTime._disabled(b);this.endDate._disabled(b);this.endTime._disabled(b);this.durationTime._disabled(b);this.durationDays._disabled(b);if(this.timezone)
this.timezone._disabled(b);if(this.allDay)
this.allDay._disabled(b);};_me.__setFrom=function(bNoChange){if(!this.startDate){return;}
var iEnd=(this.startDate._value()+(this.durationDays._value()*1))*86400000;if(!this.__allDayEvent())
iEnd+=this.startTime._value()+this.durationTime._value();if(this.__allDayEvent())
iEnd--;else
this.endTime._value(iEnd%86400000,true);this.endDate._value(Math.floor(iEnd/86400000),true);if(!bNoChange){this.__setEnd();}};_me.__setEnd=function(bNoChange){var iStart=this.startDate._value()*86400000,iEnd=this.endDate._value()*86400000;if(!this.__allDayEvent()){iStart+=this.startTime._value();iEnd+=this.endTime._value();}
var iDays=0,iTime=0;if(iEnd>iStart){iDays=Math.floor((iEnd-iStart)/86400000);if(!this.__allDayEvent())
iTime=(iEnd-iStart)%86400000;}
else
if(iEnd<iStart){this.startDate._value(this.endDate._value(),true);if(!this.__allDayEvent())
this.startTime._value(this.endTime._value(),true);}
if(this.__allDayEvent())
iDays++;this.durationDays._value(iDays,true);this.durationTime._value(iTime,true);if(this._onchange&&!bNoChange)
this._onchange();};_me.__allDayEvent=function(){return Is.Defined(this.allDay)&&this.allDay._value();};_me._value=function(aValues,bNoChange){if(Is.Defined(aValues)){if(Is.Defined(aValues['EVNSTARTDATE'])&&aValues['EVNSTARTDATE']!='undefined')
this.startDate._value(aValues['EVNSTARTDATE'],true);if(this.timezone&&aValues.EVNTIMEFORMAT=='Z'&&aValues.TZID){this.__tzid=aValues.TZID;this.timezone._value(aValues.TZID,true);}
if(Is.Defined(aValues['EVNSTARTTIME'])&&aValues['EVNSTARTTIME']!='undefined'&&Is.Defined(aValues['EVNENDDATE'])&&aValues['EVNENDDATE']!='undefined'){if(aValues['EVNSTARTTIME']>-1&&aValues['EVNENDTIME']>-1){this.startTime._value(aValues['EVNSTARTTIME']*60000,true);this.endTime._value(aValues['EVNENDTIME']*60000,true);this.endDate._value(aValues['EVNENDDATE'],true);if(this.allDay)
this.allDay._value(0);}
else
if(this.allDay){if(Is.Defined(aValues['EVNENDDATE'])&&aValues['EVNENDDATE']!='undefined')
this.endDate._value(aValues['EVNENDDATE']-1,true);this.allDay._value(1);return;}}
else
if(this.allDay)
this.allDay._value(0);if(Is.Defined(aValues['EVNENDDATE'])&&aValues['EVNENDDATE']!='undefined')
this.endDate._value(aValues['EVNENDDATE'],true);this.__setEnd(bNoChange);}
else{var aReturn={'EVNSTARTDATE':this.startDate._value(),'EVNENDDATE':this.endDate._value()};if(this.__allDayEvent()){aReturn['EVNSTARTTIME']=-1;aReturn['EVNENDTIME']=-1;aReturn['EVNENDDATE']++;aReturn.EVNTIMEFORMAT='F';}
else{aReturn['EVNSTARTTIME']=this.startTime._value()/60000;aReturn['EVNENDTIME']=this.endTime._value()/60000;if(this.timezone){if(this.__tzid){aReturn.TZID=this.__tzid;aReturn.EVNTIMEFORMAT='Z';}
else
aReturn.EVNTIMEFORMAT='L';}}
return aReturn;}};_me._tabIndex=function(sContainer,i,oDock){this.startTime._tabIndex(sContainer,i,oDock);this.endTime._tabIndex(sContainer,i?++i:i,oDock);this.durationDays._tabIndex(sContainer,i?++i:i,oDock);this.durationTime._tabIndex(sContainer,i?++i:i,oDock);if(this.allDay)
this.allDay._tabIndex(sContainer,i?++i:i,oDock);};_me._focus=function(b){return this.startTime._focus(b);};

/* client/inc/obj_timetable.js */
_me=obj_timetable.prototype;function obj_timetable(){};_me.__constructor=function(owner,evnid,bAttendee){var me=this;this.__owner=owner||sPrimaryAccount;this.__evnid=evnid||{};this.__attendee=bAttendee;storage.library('gw_others');this.__workstart=GWOthers.getItem('CALENDAR_SETTINGS','day_begins')*60;this.__workend=GWOthers.getItem('CALENDAR_SETTINGS','day_ends')*60;this.__base_position=10080;this.__base_date=(new IcewarpDate()).format('julian');this.__rendered={};this.__range=21600;this.__hop=4320;this.__hopzone=1440;this.__tzid='';this.__oldMove;this.__oldUp;this.__data={};this.__users=[];this.__timer;this.__value={};this._body=this._getAnchor('body');this._list=this._getAnchor('list');this._heading=this._getAnchor('heading');storage.library('wm_freebusy');this._freeBusy=new wm_freebusy();this._time=mkElement('div',{'className':'timeline'});this._time.style.width=this.__range+'px';this._getAnchor('time').appendChild(this._time);this._container=mkElement('div',{className:'container',unselectable:"on"});this._container.style.width=this.__range+'px';this._getAnchor('body').appendChild(this._container);this._getAnchor('body').unselectable="on";this._body.onscroll=function(e){var scpos=this.scrollLeft;me._list.style.marginTop=(this.scrollTop*-1)+'px';me._time.style.marginLeft=(scpos*-1)+'px';var pozice=Math.floor((scpos-me.__base_position)/1440);var zobrazeno=Math.ceil(this.clientWidth/1440)+Math.floor(((scpos%1440)+this.clientWidth)/1440);for(var i=0;i<zobrazeno;i++)
if(typeof me.__rendered[me.__base_date+pozice+i]=='undefined')
me._addDay(me.__base_date+pozice+i);if(this.__timer)
window.clearTimeout(this.__timer);this.__timer=setTimeout(me._pathName+'.__query('+(me.__base_date+pozice)+','+(me.__base_date+pozice+zobrazeno-1)+')',500);};this._body.onmousedown=function(e){this.__lastScrollLeft=this.scrollLeft;};if(currentBrowser().indexOf('MSIE')!==0)
this._body.onmouseup=function(e){var e=e||window.event;var elm=e.target||e.srcElement;if(elm==this&&this.__lastScrollLeft!=this.scrollLeft){if(this.scrollLeft<me.__hopzone)
me._scrollPrev();else
if(me._container.clientWidth-this.scrollLeft<me.__hopzone)
me._scrollNext();}};this.rf._onclick=function(){me._body.scrollLeft=0;me._scrollPrev();};this.ff._onclick=function(){me._body.scrollLeft=me._body.scrollWidth;me._scrollNext();};this.now._onclick=function(){var d=new IcewarpDate();me._setDate(d.format(IcewarpDate.JULIAN),d.format(IcewarpDate.JULIAN_TIME));};var dispatch=function(){gui._disobeyEvent('mouseup',[dispatch]);gui._disobeyEvent('mousemove',[me,'__move_handler']);if(me._onselectend)
me._onselectend(me._value());};this._container.ondragstart=function(e){return false;};this._container.onmousedown=function(e){var e=e||window.event;var elm=e.target||e.srcElement;var posC=getSize(me._body);if(elm.className&&(elm.className=='LSide'||elm.className=='RSide')){gui._obeyEvent('mouseup',[dispatch]);var div=document.getElementById(me._pathName+'/selection');var posX=div.offsetLeft;var posD=div.offsetWidth;if(elm.className=='LSide'){if(me.__move_handler)
gui._disobeyEvent('mousemove',[me,'__move_handler']);me.__move_handler=function(e){var move=e.clientX-posC.x+me._body.scrollLeft;var moveX=Math.floor(move/30)*30;var move15=Math.floor(move/15)*15;if(move15<=moveX){if(posD+posX-moveX<30)
moveX=posD+posX-30;div.style.width=(posD+(posX-moveX))+'px';div.style.left=moveX+'px';var a=me.__base_date-(me.__base_position/1440);var b=Math.floor(moveX/1440);me.__value.STARTDATE=a+b;me.__value.STARTTIME=moveX-(b*1440);}};gui._obeyEvent('mousemove',[me,'__move_handler']);}
else
if(elm.className=='RSide'){if(me.__move_handler)
gui._disobeyEvent('mousemove',[me,'__move_handler']);me.__move_handler=function(e){var move=e.clientX-posC.x+me._body.scrollLeft;var move15=Math.ceil(move/15)*15;var moveX=Math.ceil(move/30)*30;if(move15>=moveX){if(moveX<=posX)
posX=moveX-30;div.style.width=(moveX-posX)+'px';var a=me.__base_date-(me.__base_position/1440);var b=Math.floor(posX/1440);me.__value.ENDDATE=a+b;var dif,tmp=moveX-(b*1440);if(tmp>1440){dif=Math.floor(tmp/1440);me.__value.ENDDATE+=dif;me.__value.ENDTIME=tmp-(dif*1440);}
else
me.__value.ENDTIME=tmp;}};gui._obeyEvent('mousemove',[me,'__move_handler']);}
return;}
var posX=e.clientX-posC.x+me._body.scrollLeft;posX=Math.floor(posX/30)*30;var a=me.__base_date-(me.__base_position/1440);var b=Math.floor(posX/1440);me._value({STARTDATE:a+b,STARTTIME:posX-(b*1440),ENDDATE:a+b,ENDTIME:posX-(b*1440)+30},1);var div=document.getElementById(me._pathName+'/selection');gui._obeyEvent('mouseup',[dispatch]);if(me.__move_handler)
gui._disobeyEvent('mousemove',[me,'__move_handler']);me.__move_handler=function(e){var move=e.clientX-posC.x+me._body.scrollLeft;var move15=Math.ceil(move/15)*15;var moveX=Math.ceil(move/30)*30;var left,width;if(move15>posX&&move15>=moveX){left=posX;width=moveX-posX;}
else{moveX=Math.floor(move/30)*30;move15=Math.floor(move/15)*15;if(move15<posX&&move15<=moveX){left=moveX;width=posX-moveX;}}
var b,a=me.__base_date-(me.__base_position/1440);if(!Is.Undefined(left)){b=Math.floor(left/1440);me.__value.STARTDATE=a+b;me.__value.STARTTIME=left-(b*1440);div.style.left=left+'px';}
if(!Is.Undefined(width)){var b=Math.floor((left+width)/1440);me.__value.ENDDATE=a+b;me.__value.ENDTIME=(left+width)-(b*1440);div.style.width=width+'px';}};gui._obeyEvent('mousemove',[me,'__move_handler']);};if(me.__attendee){this.add_button._disabled(true);this.addr_button._disabled(true);this.inp_add._disabled(true);}
else{this.add_button._onclick=function(){gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook',['Q']],['ADDRESS_BOOK::SELECTED_ADDRESSES'],'','',true,undefined,true);};if(dataSet.get('main',['resources_path'])){this.addr_button._disabled(false);this.addr_button._onclick=function(){var frm=gui._create('address_book','frm_addaddress','','',[me,'__onAddNewFromAddressbook',['S']],['ADDRESS_BOOK::SELECTED_ADDRESSES'],'','',true,4);frm.select._disabled(true);};}
this.inp_add._single=true;this.inp_add.__minWidth=400;this.inp_add._disobeyEvent('change',[this.inp_add,'_checksize']);this.inp_add._checksize=function(){};this.inp_add._placeholder(getLang('ATTENDEES::QUICK_ADD'));this.inp_add._onsubmit=function(){if(!this._checkError.length){var tmp=MailAddress.splitEmailsAndNames(this._value());this._value('');if(tmp&&tmp[0]&&tmp[0].email)
me.__onAddNewFromAddressbook(true,[[MailAddress.createEmail(tmp[0].name,tmp[0].email)]]);}};this.inp_add._onmouseselect=this.inp_add._onsubmit;this.inp_add._restrict([function(v){if(v==='')return true;var tmp=MailAddress.splitEmailsAndNames(v);if(tmp&&tmp[0]&&tmp[0].email)
return Is.Email(tmp[0].email);return false;}]);}
this._list.__users=[];this._heading.onclick=function(e){if((e.offsetX>228&&!gui._rtl||gui._rtl&&e.offsetX<22)&&me._list.__users.length){var to=[];for(var i=0;i<me._list.__users.length;i++){var user=me._list.__users[i];if(user.email!=sPrimaryAccount&&user.role!='S'&&user.email!=='__@@groupchat@@__')
to.push(MailAddress.createEmail(user.name,user.email));}
if(to.length)
NewMessage.compose({to:to.join(',')});}};this._list.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,bRemove=false;if(elm.tagName=='SPAN'){bRemove=true;elm=elm.parentNode;};var id=elm.id.substr((me._pathName+'.list/').length);if(this.__users[id]&&id>0){if(this.__users[id].active&&(e.ctrlKey||e.metaKey)){removecss(elm,'active');this.__users[id].active=false;}
else{if(!e.ctrlKey&&!e.metaKey){var active=this._getActive();var tmp;for(var i in active){try{tmp=document.getElementById(me._pathName+'.list/'+active[i]);removecss(tmp,'active');this.__users[active[i]].active=false;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}}
addcss(elm,'active');this.__users[id].active=true;}
if(bRemove)
me._list._removeUser();else{var pos=e.clientX-getSize(elm).x;if(pos<40&&!gui._rtl||gui._rtl&&pos>205){this.oncontextmenu(e);e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();if(e.stopPropagation)
e.stopPropagation();return false;}}}};this._list.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='SPAN')
elm=elm.parentNode;var id=elm.id.substr((me._pathName+'.list/').length);if(this.__users[id]&&id>0){var aMenu,pos=getSize(elm);if(e.clientX-pos.x<20&&me.__attendee)
return;me.cmenu=gui._create('cmenu','obj_context','','obj_timetable_context');me.cmenu._onclick=function(e,elm,id,arg){var usr;if((usr=me._list.__users[arg.id])){usr[arg.key]=arg.value;me._list._editUser(usr,arg.id);}};if(e.clientX-pos.x<20&&!gui._rtl||gui._rtl&&e.clientX-pos.x<228){aMenu=[{'title':'ATTENDEES::STATUS_P',css:'bg_status_P','arg':{'id':id,'key':'status',value:''}},{'title':'ATTENDEES::STATUS_A',css:'bg_status_A','arg':{'id':id,'key':'status',value:'A'}},{'title':'ATTENDEES::STATUS_D',css:'bg_status_D','arg':{'id':id,'key':'status',value:'D'}}];me.cmenu._fill(aMenu);me.cmenu._place(gui._rtl?pos.x+218:pos.x+10,pos.y+pos.h,150,2);}
else{aMenu=[{'title':'ATTENDEES::ROLE_Q',css:'bg_role_Q','arg':{'id':id,'key':'role',value:'Q'}},{'title':'ATTENDEES::ROLE_S',css:'bg_role_S','arg':{'id':id,'key':'role',value:'S'}},{'title':'ATTENDEES::ROLE_T',css:'bg_role_T','arg':{'id':id,'key':'role',value:'T'}}];me.cmenu._fill(aMenu);me.cmenu._place(gui._rtl?pos.x+236:pos.x+30,pos.y+pos.h,150,2);}}
return false;};this._list.ondblclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.id&&elm.id.indexOf((me._pathName+'.list/'))==0){var active=this._getActive();if(active.length){var user=this.__users[active[0]];gui._create('edit_dialog','frm_edit_attendee','','','frm_edit_attendee','ATTENDEES::EDIT_TITLE',[me,'__onEdit'],{CNTEMAIL:user.email,CNTCONTACTNAME:user.name,CNTROLE:user.role,CNTSTATUS:user.status},active,me.__attendee);}}
else
if(elm.tagName!='SPAN'&&!me.__attendee)
gui._create('edit_dialog','frm_edit_attendee','','','frm_edit_attendee','ATTENDEES::ADD_TITLE',[me,'__onAddNew'],'','',me.__owner!=sPrimaryAccount);};this._list._getActive=function(){var active=[];for(var i in this.__users)
if(this.__users[i]&&this.__users[i].active&&this.__users[i].action!='remove')
active.push(i);return active;};this._list._fill=function(){var c=0,css,out=mkElement('div');var folder=me.__evnid.fid?dataSet.get('folders',[me.__evnid.aid,me.__evnid.fid.replace(/\\/g,'/')]):{};var bIsOrganizer=!me.__evnid.iid||this.__users.some(function(user){return user.email===sPrimaryAccount&&user.role==='G';})||~(folder.RIGHTS||'').indexOf('w')||(me.__evnid.owner_id===sPrimaryAccountGWID);for(var i=0;i<this.__users.length;i++){if(this.__users[i].action=='remove')
continue;css='';if(this.__users[i].status)
css='status_'+this.__users[i].status;if(this.__users[i].role)
css+=(css?' ':'')+'role_'+this.__users[i].role;out.appendChild(mkElement('div',{id:me._pathName+'.list/'+i,className:(this.__users[i].active?'active':'')+(this.__users[i].css?' '+this.__users[i].css:'')+' '+css,unselectable:'on',title:this.__users[i].email,innerHTML:MailAddress.createEmail(this.__users[i].name,this.__users[i].email).escapeHTML()+((this.__users[i].role!='G'&&bIsOrganizer)?'<span></span>':'')}));c++;}
this.innerHTML=out.innerHTML;out=null;if(me._container)
me._container.style.height=(c>8?(c*25)+'px':'100%');};this._list._addUser=function(aInfo,bNoUpdate){if(aInfo.email&&aInfo.email.indexOf('[')==0){(new wm_tools()).distrib({name:aInfo.email},[this,'_addGroup',[aInfo.role]]);return false;}
else{for(var i=this.__users.length-1;i>-1;i--)
if(this.__users[i].email==aInfo.email&&this.__users[i].action!='remove')
return false;aInfo.action='new';this.__users.push(aInfo);this._fill();if(!bNoUpdate)
me._update();return true;}};this._list._addGroup=function(aData,sRole,bNoUpdate){for(var i in aData){aData[i].role=sRole;this._addUser(aData[i],true);}
if(!bNoUpdate)
me._update();};this._list._editUser=function(aValues,iid){if(Is.Defined(iid)&&this.__users[iid]){for(var i=this.__users.length-1;i>-1;i--)
if(i!=iid&&this.__users[i].email==aValues.email){aValues.email=this.__users[iid].email;break;}
var doUpd=false;if(this.__users[iid].email!=aValues.email)
doUpd=true;for(var i in aValues)
this.__users[iid][i]=aValues[i];this.__users[iid].action='edit';this._fill();if(doUpd)
me._update();}
else{aValues.checked=true;this._addUser(aValues);}};this._list._removeUser=function(){var rem=false;for(var i in this.__users)
if(this.__users[i]&&this.__users[i].active){if(this.__users[i].action=='new')
this.__users.splice(i,1);else
this.__users[i].action='remove';rem=true;}
if(rem){this._fill();me.__data={};me._update();}};AttachEvent(this._list,"onmousewheel",function(e){me._body.scrollTop+=e.deltaY*10;});var acc=MailAddress.splitEmailsAndNames(this.__owner)[0];acc.css='main_account';acc.role='G';acc.status='A';var aAccInfo=dataSet.get('accounts',[this.__owner]);if(aAccInfo&&aAccInfo['FULLNAME'])
acc.name=aAccInfo['FULLNAME'];this._list._addUser(acc,1);};_me._scrollPrev=function(){var base=this.__base_date+(((this.__range/1440)-1)/2);var elm;for(var i=(this.__hop/1440)-1;i>=0;i--){if(typeof this.__rendered[base-i]!='undefined'){if((elm=document.getElementById(this._pathName+'/body/'+(base-i)))){elm.parentNode.removeChild(elm);elm=null;}
if((elm=document.getElementById(this._pathName+'/time/'+(base-i)))){elm.parentNode.removeChild(elm);elm=null;}
delete this.__rendered[base-i];}}
for(var i in this.__rendered){this.__rendered[i][0]+=this.__hop;if((elm=document.getElementById(this._pathName+'/time/'+i))){elm.style.left=this.__rendered[i][0]+'px';elm=null;}
if((elm=document.getElementById(this._pathName+'/body/'+i))){elm.style.left=this.__rendered[i][0]+'px';elm=null;}
else
delete this.__rendered[i];}
this.__base_date-=this.__hop/1440;this._body.scrollLeft+=this.__hop;this._value(this.__value,1);};_me._scrollNext=function(e){var base=this.__base_date-(((this.__range/1440)-1)/2);var elm;for(var i=(this.__hop/1440)-1;i>=0;i--){if(typeof this.__rendered[base+i]!='undefined'){if((elm=document.getElementById(this._pathName+'/body/'+(base+i)))){elm.parentNode.removeChild(elm);elm=null;}
if((elm=document.getElementById(this._pathName+'/time/'+(base+i)))){elm.parentNode.removeChild(elm);elm=null;}
delete this.__rendered[base+i];}}
for(var i in this.__rendered){this.__rendered[i][0]-=this.__hop;if((elm=document.getElementById(this._pathName+'/time/'+i))){elm.style.left=this.__rendered[i][0]+'px';elm=null;}
if((elm=document.getElementById(this._pathName+'/body/'+i))){elm.style.left=this.__rendered[i][0]+'px';elm=null;}
else
delete this.__rendered[i];}
this.__base_date+=this.__hop/1440;this._body.scrollLeft-=this.__hop;this._value(this.__value,1);};_me._update=function(){var view=this._currentView();this.__data={};this.__query(view[0],view[1],true);};_me.__query=function(iStart,iEnd,bClean){var bHas=false;for(var i=iStart;i<=iEnd;i++)
if(this.__data[i]){if(i==iStart&&iStart<iEnd)
iStart++;else
if(i==iEnd&&iEnd>iStart)
iEnd--;else
bHas=true;}
else{bHas=false;break;}
if(bHas)return;var aData={users:[]};for(var i in this._list.__users)
if(this._list.__users[i].action!='remove')
aData.users.push(this._list.__users[i].email||this._list.__users[i].name);if(aData.users.length){aData.from=iStart;aData.to=iEnd;aData.evnid=this.__evnid.iid;aData.tzid=this.__tzid;aData.owner=this.__owner;this._freeBusy.get(aData,'null','',[this,'_response',[bClean,iStart,iEnd]]);}};_me._response=function(aData,bClean,iStart,iEnd){try{for(var i in aData)
this.__data[i]=aData[i];if(bClean)
for(var day in this.__rendered)
if(day<iStart||day>iEnd)
this._removeDay(day);for(var i=iStart;i<=iEnd;i++)
this._addEvents(i);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};_me._addEvents=function(day){if(typeof this.__rendered[day]=='undefined'||this.__rendered[day][1])
this._addDay(day);else{if(!this.__data[day])return;var sum=[],str,email,pos=0,eDay=document.getElementById(this._pathName+'/body/'+day);for(var i in this._list.__users){if(this._list.__users[i].action=='remove')
continue;email=this._list.__users[i].email;if(this.__data[day][email]){this.__data[day][email].sort(function(a,b){if(a.TYPE==b.TYPE)
return 0;else
return a.TYPE>b.TYPE?-1:1;});for(var j in this.__data[day][email]){eDay.appendChild(mkElement('div',{className:'evn '+this.__data[day][email][j].TYPE,style:{top:pos+'px',left:this.__data[day][email][j].STARTTIME+'px',width:(this.__data[day][email][j].ENDTIME-this.__data[day][email][j].STARTTIME)+'px'},innerHTML:(this.__data[day][email][j].SUMMARY||'').escapeHTML(),title:(this.__data[day][email][j].SUMMARY||'').escapeHTML()}));sum.push({STARTTIME:this.__data[day][email][j].STARTTIME,ENDTIME:this.__data[day][email][j].ENDTIME});}}
pos+=25;}
function sorter(a,b){return a.STARTTIME-b.STARTTIME;};sum.sort(sorter);for(var i=1;i<sum.length;i++){if((sum[i-1].ENDTIME)>=(sum[i].STARTTIME)){if(sum[i-1].ENDTIME<sum[i].ENDTIME)
sum[i-1].ENDTIME=sum[i].ENDTIME;sum.splice(i,1);i--;}}
str='';for(var i=0;i<sum.length;i++)
str+='<div class="busy" style="left: '+sum[i].STARTTIME+'px;width:'+(sum[i].ENDTIME-sum[i].STARTTIME)+'px"></div>';if(str){document.getElementById(this._pathName+'/time/'+day).innerHTML+=str;this.__rendered[day][1]=true;}
else
this.__rendered[day][1]=false;}};_me._currentView=function(){var scpos=this._body.scrollLeft;var pozice=Math.floor((scpos-this.__base_position)/1440);var zobrazeno=Math.ceil(this._body.clientWidth/1440)+Math.floor(((scpos%1440)+this._body.clientWidth)/1440);var istart=this.__base_date+pozice;var iend=istart+zobrazeno-1;return[istart-7,iend+7];};_me._addDay=function(day){if(typeof this.__rendered[day]!='undefined'&&this.__rendered[day][1])
this._removeDay(day);var x=this.__base_position+((day-this.__base_date)*1440);if(x>=this._container.clientWidth)
return;this.__rendered[day]=[x];var d=IcewarpDate.julian(day);this._time.innerHTML+='<div class="time" id="'+this._pathName+'/time/'+day+'" style="left:'+x+'px">'+'<div class="text" unselectable="on">'+d.format('dddd MMM DD YYYY hh:mm:ss ZZ')+'</div>'+
(this.__workstart?'<div class="free" style="left: 2px;width: '+this.__workstart+'px"></div>':'')+
(this.__workend||this.__workend<1440?'<div class="free" style="left: '+this.__workend+'px; width: '+(1440-this.__workend)+'px"></div>':'')+'</div>';this._container.innerHTML+='<div class="day" id="'+this._pathName+'/body/'+day+'" style="left:'+x+'px">'+
(this.__workstart?'<div class="free" style="left: 0;width: '+this.__workstart+'px"></div>':'')+
(this.__workend||this.__workend<1440?'<div class="free" style="left: '+this.__workend+'px; width: '+(1440-this.__workend)+'px"></div>':'')+'</div>';this._addEvents(day);};_me._removeDay=function(day){delete this.__rendered[day];var elm;if((elm=document.getElementById(this._pathName+'/time/'+day)))
elm.parentNode.removeChild(elm);if((elm=document.getElementById(this._pathName+'/body/'+day)))
elm.parentNode.removeChild(elm);elm=null;};_me._value=function(aValue,bNoScroll,bForce){if(aValue){if(Is.Undefined(aValue.STARTDATE)||Is.Undefined(aValue.STARTTIME)||Is.Undefined(aValue.ENDDATE)||Is.Undefined(aValue.ENDTIME))
return;if(!bNoScroll)
this._setDate(aValue.STARTDATE,aValue.STARTTIME);var a=this.__base_date-(this.__base_position/1440);var b=a+(this.__range/1440);var str='<div class="fill"></div>',left,width;if(aValue.STARTDATE>a&&aValue.STARTDATE<b){str+='<div class="LSide"></div>';left=(aValue.STARTDATE-a)*1440+(aValue.STARTTIME||0);}
else
left=0;if(aValue.ENDDATE>a&&aValue.ENDDATE<b){str+='<div class="RSide"></div>';width=(aValue.ENDDATE-a)*1440+(aValue.ENDTIME||0)-left;}
else
width=this.__range-left;var div=document.getElementById(this._pathName+'/selection');if(!str){if(div)
div.parentNode.removeChild(div);}
else{if(!div){div=mkElement('div',{id:this._pathName+'/selection','className':'selection'});this._container.appendChild(div);}
div.innerHTML=str;div.style.left=left+'px';div.style.width=width+'px';}
this.__value=aValue;div=null;}
else
return this.__value;};_me._setDate=function(iDate,iTime){this.__base_position=10080;this.__base_date=iDate;this._body.scrollLeft=this.__base_position+(iTime||0);this._update();};_me.__onEdit=function(aValues,iid){var out={name:aValues.CNTCONTACTNAME,email:aValues.CNTEMAIL,role:aValues.CNTROLE,status:aValues.CNTSTATUS};this._list._editUser(out,iid);};_me.__onAddNew=function(aValues){var out={};out.name=aValues.CNTCONTACTNAME;out.email=aValues.CNTEMAIL;out.role=aValues.CNTROLE;if(aValues.CNTSTATUS!='P')
out.status=aValues.CNTSTATUS;this._list._addUser(out);};_me.__onAddNewFromAddressbook=function(bOK,aAddresses,sRole){if(bOK&&aAddresses[0]){var tmp,bUpdate=false;for(var i in aAddresses[0]){tmp=MailAddress.splitEmailsAndNames(aAddresses[0][i]);if(typeof tmp[0]=='object'){tmp[0].role=Is.String(sRole)?sRole:'Q';bUpdate=this._list._addUser(tmp[0],true);}}
if(bUpdate)
this._update();}};

/* client/inc/obj_timezones.js */
_me=obj_timezones.prototype;function obj_timezones(){};_me.__constructor=function(sDefault){var aTZ=dataSet.get('storage',['TIMEZONES','ITEMS']);for(var i in aTZ)
this.__idTable[aTZ[i].VALUES.TZID.VALUE]=[aTZ[i].VALUES.NAME.VALUE,'',aTZ[i].VALUES.NAME.VALUE];if(this.__idTable['F']){delete this.__idTable['F'];this.__idTable['F']=getLang('SETTINGS::FTIME');}
if(sDefault){if(this.__idTable[sDefault])
this._value(sDefault);else
this.__inputValue(sDefault);}
else
this._value('F');};

/* client/inc/obj_title.js */
_me=obj_title.prototype;function obj_title(){};_me.__constructor=function(){this.__buffer=[[document.title]];this._add_destructor('__destructor');gui._obeyEvent('blur',[this,'_reset']);};_me._add=function(sTitle,iTime,bForce){if(iTime){var id=unique_id();document.title=sTitle;this.__buffer.push([sTitle,id,iTime,setTimeout('try{'+this._pathName+'._remove('+id+','+(bForce?'true':'false')+');}catch(r){gui._REQUEST_VARS.debug && console.log(this._name||false,r);}',iTime*1000)]);return id;}
else{this.__buffer[0]=[sTitle];if(this.__buffer.length==1)
document.title=sTitle;return 0;}};_me._reset=function(){if(this.__buffer[0]){this.__buffer=this.__buffer.splice(0,1);this._refresh();}};_me._remove=function(id,bForce){if(typeof id!='undefined')
for(var i=1;i<this.__buffer.length;i++)
if(this.__buffer[i][1]==id){clearTimeout(this.__buffer[i][3]);if(bForce||gui.__focus)
this.__buffer.splice(i,1);else
this.__buffer[i][3]=setTimeout('try{'+this._pathName+'._remove('+id+');}catch(r){gui._REQUEST_VARS.debug && console.log(this._name||false,r);}',(this.__buffer[i][2])*1000);break;}
this._refresh();};_me._refresh=function(bForce){if(bForce)
document.title='';document.title=this.__buffer[this.__buffer.length-1][0];};_me.__destructor=function(){gui._disobeyEvent('blur',[this,'_reset']);document.title=this.__buffer[0][0];};

/* client/inc/obj_tooltip.js */
_me=obj_tooltip.prototype;function obj_tooltip(){};_me.__constructor=function(){this.__active_tooltip=null;this.__pending_tooltip=null;this.__default_className=this._main.className;gui._obeyEvent('click',[this,'_hide']);this._position('absolute');this._zIndex();};_me._add=function(elm,title,args){var me=this,args=args||{};AttachEvent(elm,'onmousemove',function(e){var m,rect=elm.getBoundingClientRect(),top=parseInt(rect.top),left=parseInt(rect.left),place={x:args.x,y:args.y};if(typeof args.x=="string"&&(m=args.x.match(/^([+-])(.*)$/)))
place.x=m[1]=='-'?left-parseInt(m[2]):left+parseInt(m[2]);else if(!args.x)
place.x=e.clientX;if(typeof args.y=="string"&&(m=args.y.match(/^([+-])(.*)$/)))
place.y=m[1]=='-'?top-parseInt(m[2]):top+parseInt(m[2]);else if(!args.y)
place.y=e.clientY;args.place=place;me._show(elm,title,args);});AttachEvent(elm,'onmouseout',function(e){e=e||window.event;if(!Is.Child(e.relatedTarget||e.toElement,elm))
me._hide(elm);});};_me._show=function(elm,title,args){var me=this,args=args||{},title=title;if(this.__active_tooltip==elm){if(this.__close_timeout)
clearTimeout(this.__close_timeout);if(args.hide!==false)
this.__close_timeout=setTimeout(function(){try{me._hide()}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e)}},args.hide||3000);return;}else if(this.__pending_tooltip==elm)return;this._hide();this.__tooltip_timeout=setTimeout(function(){me.__display(elm,title,args)},args.delay||200);this.__pending_tooltip=elm;};_me._hide=function(elm){if(!(elm&&elm instanceof HTMLDivElement))
elm=null;if(this.__tooltip_timeout){clearTimeout(this.__tooltip_timeout);this.__pending_tooltip=null;}
if(this.__active_tooltip&&(elm&&this.__active_tooltip==elm||!elm)){this._main.innerHTML='';this.__active_tooltip=null;this._main.className=this.__default_className;this._main.style.display='none';}
this._main.className=this.__default_className;if(this.__close_timeout)
clearTimeout(this.__close_timeout);};_me._title=function(elm,sTitle){if(elm)elm.setAttribute('x-tooltip',sTitle);};_me.__display=function(elm,sTitle,args){var me=this,x=args.place?args.place.x:args.x,y=args.place?args.place.y:args.y,css=args.css;this.__pending_tooltip=null;this.__active_tooltip=elm;if(!elm||!elm.parentNode)return;if(elm.getAttribute('x-tooltip'))
sTitle=elm.getAttribute('x-tooltip');this._place(x||'0',y||'0');if(args.html)
this._main.innerHTML=sTitle;else
this._main.appendChild(document.createTextNode(sTitle));this._main.style.display='block';if(css)
addcss(me._main,css);if(args.hide!==false)
this.__close_timeout=setTimeout(function(){try{me._hide()}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e)}},args.hide||3000);this._focus();};

/* client/inc/obj_tree.js */
_me=obj_tree.prototype;function obj_tree(){};_me.__constructor=function(){this._telemetry='id';this.__value=[];this._saveState=true;this.__idtable;this.__activeNode;this._tree;this._treeCookie;this.__filter='';this.__filterOpen=[];var me=this;this.inp_search._onkeyup=function(e){var v=this._value();if(e.keyCode==27){if(v==='')
me._focus();else{this._value('');v='';}}
window[v.length?'addcss':'removecss'](me._main,'search');if(me.__filter!==v){me.__filter=v;me._fill();}};this.inp_search._onblur=function(){if(!this._value())removecss(me._main,'search');};this.__eBody=this._getAnchor('body');this._scrollbar(this.__eBody,this.__eBody.parentNode);var hasFocus=false;this._main.setAttribute('tabindex',-1);if(~currentBrowser().indexOf('MSIE')){AttachEvent(this._main,'onclick',function(){hasFocus=true;});}
else{AttachEvent(this._main,'onfocus',function(){hasFocus=true;});}
AttachEvent(this._main,'onblur',function(){hasFocus=false;});AttachEvent(this._main,'onkeydown',function(e){if(hasFocus&&!e.isComposing&&e.keyCode!==229&&(e.key||'').length===1)
me.inp_search._focus();});this.__eBody.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,eli,id;switch(elm.tagName){case'B':elm=Is.Child(elm,'DIV');case'DIV':if(elm.parentNode.tagName=='LI'){if(hascss(elm.parentNode,'active')||hascss(elm.parentNode,'menu')){var p=getSize(me._main),ctx;if(gui._rtl){ctx=e.clientX-p.x<33;}
else{ctx=p.x+p.w-e.clientX<33;}
if(ctx){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();var p2=getSize(elm);e={srcElement:elm,clientX:gui._rtl?p.x+22:p.x+p.w,clientY:p2.y+(p2.h/2),type:'contextmenu',originalType:e.type};}}}
else
break;case'SPAN':case'I':case'U':eli=Is.Child(elm,'LI');id=eli.id.substr(me._pathName.length+1);if(elm.tagName=='SPAN'&&e.type!='contextmenu'){me.__open(id);break;}
var idt=me.__idtable[id]?clone(me.__idtable[id],true):{};if(!idt.disabled||e.type=='contextmenu'){var realId=me._getRealId(id);if(e.type!='contextmenu'&&me._isSelectable(idt))
me._setActive(realId);if(me._onclick)me._onclick(e,elm,realId,idt||{});me.__exeEvent('click',e,{"arg":idt,"id":realId,"elm":elm,"owner":me});}
else{me.__open(id);}
break;}
return false;};this.__eBody.ondblclick=function(e){var e=e||window.event;var elm=e.target||e.srcElement;switch(elm.tagName){case'U':case'B':if(me._ondblclick){var eli=Is.Child(elm,'LI'),id=eli.id.substr(me._pathName.length+1),idt=me.__idtable[id]?clone(me.__idtable[id],true):{};var realId=me._getRealId(id);if(me._ondblclick(e,elm,realId,idt||{})){me._setActive(realId);return;}}
case'I':var eli=Is.Child(elm,'LI');me.__open(eli.id.substr(me._pathName.length+1),hascss(eli,'root')?'plus':'');}};this.__eBody.oncontextmenu=this.__eBody.onclick;};_me._disabled=function(b){if(Is.Defined(b))
window[b?'addcss':'removecss'](this._main,'disabled');else
return hascss(this._main,'disabled');};_me._getFocusElement=function(){return this._main;};_me._focus=function(){return this._main.focus();};_me._fill=function(aData){if(aData){this.__aData=aData;}
else{if(this._listener_data)
aData=dataSet.get(this._listener_data,this._listenerPath_data);else
if(this.__aData)
aData=clone(this.__aData,true);}
if(aData){if(this.__filter){this.__filter=this.__filter.toLowerCase();var oFilter=this._filter(aData);var aOpen=oFilter.aOpen;aData=oFilter.aData;}
if(this._filterRawData)
aData=this._filterRawData(aData);this.__aFillData=this.__prepare_data?this.__prepare_data(aData):aData;this.__row(this.__aFillData);var filterOpen=[];if(this.__filter&&aOpen.length){aOpen.forEach(function(id){this._getTreeId(id,true).forEach(function(treeId){this.__openup('minus',treeId);}.bind(this));id.split('/').forEach(function(v,i,a){filterOpen.push(a.slice(0,i+1).join('/'));},this);},this);this.__filterOpen=this.__clear(filterOpen);}}
else
this.__eBody.innerHTML='';this.__sbar_init(this.__eBody,true);};_me._filter=function(aData){var aData2={},aOpen=[];var aKey=[],sName;for(var i in aData)
aKey.push(i);aKey.sort();for(var sLast='',i=aKey.length-1;i>=0;i--){if(aKey[i]==sLast)
sLast=aKey[i].indexOf('/')>-1?aKey[i].substr(0,aKey[i].lastIndexOf('/')):aKey[i];else{if((!aData[aKey[i]].NAME&&aKey[i].toLowerCase().indexOf(this.__filter)>-1)||(aData[aKey[i]].NAME&&aData[aKey[i]].NAME.toLowerCase().indexOf(this.__filter)>-1))
sLast=aKey[i].indexOf('/')>-1?aKey[i].substr(0,aKey[i].lastIndexOf('/')):aKey[i];else{aKey.splice(i,1);continue;}}
if((sName=aData[aKey[i]].NAME?aData[aKey[i]].NAME:Path.basename(aKey[i]))&&sName.toLowerCase().indexOf(this.__filter)>-1)
aOpen.push(sLast?'/'+sLast:'');}
if(aKey.length){aData2={};for(var i in aData)
if(inArray(aKey,i)>-1)
aData2[i]=aData[i];}
return{aData:aData2,aOpen:aOpen};};_me._invalidateActive=function(){try{removecss(document.getElementById(this._getElmId(this._getTreeId(this.__activeNode))),'active');}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}
delete this.__activeNode;};_me._getActive=function(bNamed){return Path.split(this.__activeNode,bNamed);};_me._setActive=function(id,bNoOpen){var elm,treeId=this._getTreeId(id);if(this.__activeNode&&this.__activeNode!=id){elm=document.getElementById(this._getElmId(this._getTreeId(this.__activeNode)));if(elm)
removecss(elm,'active');}
elm=document.getElementById(this._getElmId(treeId));if(elm&&elm.parentNode){if(!bNoOpen){var iSPos;if((iSPos=id.lastIndexOf('/'))>-1)
this._open(id.substr(0,iSPos),'minus');else
this._open(id,'minus');}
addcss(elm,'active');}
if(this._onactivate)
this._onactivate(id,this.__activeNode!=id);this.__activeNode=id;this.__exeEvent('activate',null,{"id":id,"owner":this});return!!elm;};_me._getElmId=function(id){return this._pathName+'/'+id;};_me._parseElmId=function(id){return id.slice(this._pathName.length+1);};_me.__row=function(aData,child){var path='',elm1,elm2,elm3,elm4,liclass;elm1=mkElement("ul");if(!child){this.__idtable={};var iTop=this.__eBody.scrollTop;liclass='root';}
else{path=child;liclass='none';}
for(var i in aData){elm2=mkElement("li",{"className":liclass+(aData[i]["liclass"]?' '+aData[i]["liclass"]:''),"id":this._pathName+'/'+path+(aData[i].id||i)});elm3=mkElement("div",{"className":(aData[i]['ico']?'ico '+aData[i]['ico']:'')});elm3.innerHTML='<span class="plussign"></span><i></i>';if(aData[i]['arg'])
this.__idtable[path+i]=aData[i]['arg'];if(aData[i]["arg"]["disabled"])
elm4=mkElement("span",{"className":'inactive'});else
elm4=mkElement("b");if(aData[i]["itmclass"])
addcss(elm4,aData[i]["itmclass"]);elm4.innerHTML=(aData[i]['title']?getLang(aData[i]['title'],null,true):(aData[i]['text']?aData[i]['text']:i.toString().entityify()));elm3.appendChild(elm4);aData[i].group&&elm3.appendChild(mkElement('div',{text:aData[i].group,class:'unread-group'}));if(aData[i]['title2'])
elm3.appendChild(mkElement('u',{innerHTML:aData[i]['title2']}));elm2.appendChild(elm3);if(aData[i]['nodes']&&!Is.Empty(aData[i]['nodes'])){addcss(elm2,'plus');removecss(elm2,'none');elm2.appendChild(this.__row(aData[i]['nodes'],path+i+'/'));}
elm1.appendChild(elm2);}
if(elm2)addcss(elm2,'end');elm2=null;elm3=null;elm4=null;if(!child){this.__eBody.innerHTML='';this.__eBody.appendChild(elm1);elm1.className='fTree';if(!Is.Empty(this.__value))
this._value(this.__value);else
if(this._listener)
this.__update(this._listener);if(this.__activeNode){var bDoNotOpen=this._value().indexOf(Path.basedir(this.__activeNode))==-1;this._setActive(this.__activeNode,bDoNotOpen);}
this.__eBody.scrollTop=iTop;return;}
return elm1;};_me.__openup=function(css,id){css=css=='minus'?'minus':'plus';var inv=css=='minus'?'plus':'minus';var a;if(id)
a=[id];else
a=this.__value.map(this._getTreeId,this);for(var elm,newPath,i=0;a[i];i++){var newPath=Path.basedir(a[i]);if(newPath&&a.indexOf(newPath)==-1)
a.push(newPath);elm=document.getElementById(this._getElmId(a[i]));if(elm&&elm.tagName=='LI'&&!hascss(elm,css)&&hascss(elm,inv)){addcss(elm,css);removecss(elm,inv);}}};_me.__open=function(id,style){this._open(this._getRealId(id),style);};_me._open=function(id,style){if(!id)return;this._getTreeId(id,true).forEach(function(treeId){var elm,elmid=this._getElmId(treeId);if(!(elm=document.getElementById(elmid)))return;if(style=='minus'||hascss(elm,'plus')){this.__value.push(id);this.__value=this.__clear(this.__value);this.__openup('minus',treeId);}
else
if(style=='plus'||hascss(elm,'minus')){removecss(elm,'minus');addcss(elm,'plus');for(var i=0;i<this.__value.length;i++){if(this.__value[i]==id){try{this._getTreeId(this.__value[i],true).forEach(function(treeId){var tmp=document.getElementById(this._getElmId(treeId));if(tmp&&hascss(tmp,'minus')){removecss(tmp,'minus');addcss(tmp,'plus');}}).bind(this);}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}
this.__value.splice(i,1);break;}}}else{elm=null;var a=treeId.split("/");if(a.length>1)
this.__open(a.slice(0,-1).join("/"),'minus');return;}}.bind(this));elm=null;if(this._saveState&&this._listener)
this._saveme();if(this._treeCookie)
Cookie.set([this._treeCookie],clone(this._value(),true));};_me._listen_cookie=function(sCookieName)
{this._treeCookie=sCookieName;this._value(Cookie.get([sCookieName]));};_me._listen_data=function(sDataSet,aDataPath){this._listener_data=sDataSet;if(typeof aDataPath=='object')this._listenerPath_data=aDataPath;dataSet.obey(this,'_listener_data',sDataSet);};_me.__update=function(sDataSet,aDataPath){if(this._norefresh){this._updateBuffer=true;return false;}
else
this._updateBuffer=false;if(this._listener_data==sDataSet){if(aDataPath&&aDataPath[2]=='RECENT'){var elm,elm2;if((elm=document.getElementById(this._pathName+'/'+aDataPath[0]+'/'+aDataPath[1]))){var tmp=dataSet.get(sDataSet,[aDataPath[0],aDataPath[1]]);iRec=tmp.RECENT,elm2=(elm2=elm.getElementsByTagName('DIV'))&&(elm2=elm2[0].getElementsByTagName('U'))?elm2[0]:false;if((parseInt(iRec)||parseInt(tmp.COUNT))>0){if(!elm2){elm2=mkElement('U');elm.getElementsByTagName('DIV')[0].appendChild(elm2);}
elm2.innerHTML=tmp.COUNT||('&#8234;'+iRec.toString().escapeHTML());elm.classList.add('unread');}
else{elm.classList.remove('unread');if(elm2){var parent=document.getElementById(this._pathName+'/'+aDataPath[0]+'/'+aDataPath[1].split('/').slice(0,-1).join('/'));if(parent){var count=parent.querySelector('div div.unread-group');if(count&&parseInt(count.innerText)){var new_count=parseInt(count.innerText)-elm2.innerText.match(/\d+/);if(new_count){count.innerText=new_count;}else{count.parentNode.removeChild(count);}}}
elm2.parentNode.removeChild(elm2);}}
elm=null;elm2=null;return;}}
this._fill();}
if(this._listener==sDataSet)
this._value(dataSet.get(this._listener,this._listenerPath,true));};_me._value=function(v){if(v&&typeof(v)=='object'){if(this.__value.length)this.__openup('plus');this.__value=this.__clear(v);var elm,treeId,sPath,aPath,fPath,ds=this._listener_data?dataSet.get(this._listener_data,this._listenerPath_data):null;for(var i=this.__value.length;i--;){if(typeof this.__value[i]!=='string'){continue;}
aPath=this.__value[i].split('/');fPath=Path.split(this.__value[i]);do{sPath=aPath.join('/');treeId=this._getTreeId(sPath,true);if(treeId.length){if(sPath!=this.__value[i]&&(!this._listener_data||!ds[fPath[0]]||(fPath[1]&&!ds[fPath[0]][fPath[1]]))){this.__value.splice(i,1,sPath);}
break;}
aPath.pop();}
while(aPath.length);if(treeId.length){treeId.forEach(function(treeId){if((elm=document.getElementById(this._getElmId(treeId)))){if(elm.tagName=='LI'&&elm.getElementsByTagName('UL').length>0){removecss(elm,'plus');addcss(elm,'minus');}}}.bind(this));}
else
if(!this._listener_data||!ds[fPath[0]]||(fPath[1]&&!ds[fPath[0]][fPath[1]])){this.__value.splice(i,1);}}}
else
return this.__clear(this.__value);};_me.__clear=function(arr){return arrUnique(arr).sort();};_me._isSelectable=function(idt){return idt.ftype!="X";};_me._getTreeId=function(id,bArray){return bArray?[id]:id;};_me._getRealId=function(id){return id;};

/* client/inc/obj_tree_folder.js */
_me=obj_tree_folder.prototype;function obj_tree_folder(){};_me.__constructor=function(sFilterAccountId,sFilterFolderType,sFilterRights,bSkipVirtual)
{var me=this;if(sFilterAccountId)
this._filter_account(sFilterAccountId);if(sFilterFolderType)
this._filter_folder(sFilterFolderType);if(sFilterRights)
this._filter_rights(sFilterRights);if(bSkipVirtual)
this._sFilterVirtual=true;var aAccounts={};if(!(aAccounts=dataSet.get('accounts'))){aAccounts=accounts.list();dataSet.add('accounts',null,aAccounts);}
if(!dataSet.get('folders')){var aFolders={};for(var sAccId in aAccounts){aFolders[sAccId]=WMFolders.list({"aid":sAccId})[sAccId];}
dataSet.add('folders',null,aFolders);}
this._listen_data('folders');this._main.onmousedown=function(e){if(me.__dndtimer){window.clearTimeout(me.__dndtimer);delete me.__dndtimer;}
if(me.rename)return;var e=e||window.event;if(e.button>1||e.ctrlKey||!me.__initdrag)return;var elm=e.target||e.srcElement;if(elm==this)return;if(elm.tagName!='LI')
elm=Is.Child(elm,'LI');if(!elm||!elm.id)return;var tmp=(elm.id.substring(me._pathName.length+1)).split('/');if(tmp.length<2)return true;var id=[{aid:tmp.splice(0,1)[0],fid:tmp.join('/')}],sType=WMFolders.getType(id[0]),sDragType='folder';if(!sType||sType=='A')
return true;else
if(id[0].aid==sPrimaryAccount&&id[0].fid.indexOf('__@@VIRTUAL@@__/')==0)
sDragType='virtual_folder';var x=e.clientX,y=e.clientY;gui._obeyEvent('mouseup',[me,'__dndDispatch']);me.__dndtimer=setTimeout(function(){me.__initdrag(id,sType,x,y,sDragType);},500);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;};this.___lastdragover='';if(gui.frm_main&&gui.frm_main.dnd)
gui.frm_main.dnd.registr_drop(this,['item','folder']);};_me.__dndDispatch=function(){if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
return false;};_me._filter=function(aData){var aData2={},aOpen=[];for(var sDomain in aData){var aTmp=aData[sDomain],aKey=[],sName;for(var i in aTmp)
aKey.push(i);aKey.sort();for(var sLast='',i=aKey.length-1;i>=0;i--){if(aKey[i]==sLast)
sLast=aKey[i].indexOf('/')>-1?aKey[i].substr(0,aKey[i].lastIndexOf('/')):aKey[i];else{if((!aTmp[aKey[i]].NAME&&aKey[i].toLowerCase().indexOf(this.__filter)>-1)||(aTmp[aKey[i]].NAME&&aTmp[aKey[i]].NAME.toLowerCase().indexOf(this.__filter)>-1))
sLast=aKey[i].indexOf('/')>-1?aKey[i].substr(0,aKey[i].lastIndexOf('/')):aKey[i];else{aKey.splice(i,1);continue;}}
if((sName=aTmp[aKey[i]].NAME?aTmp[aKey[i]].NAME:Path.basename(aKey[i]))&&sName.toLowerCase().indexOf(this.__filter)>-1)
aOpen.push(sDomain+(sLast?'/'+sLast:''));}
if(aKey.length){aData2[sDomain]={};for(var i in aTmp)
if(inArray(aKey,i)>-1)
aData2[sDomain][i]=aTmp[i];}}
return{aData:aData2,aOpen:aOpen};};_me._filter_account=function(sFilterAccountId){this.sFilterAccountId=sFilterAccountId;};_me._filter_folder=function(sFilterFolderType){this._sFilterFolderType={};if(typeof sFilterFolderType=='object')
for(var i in sFilterFolderType)
this._sFilterFolderType[sFilterFolderType[i]]=true;else
if(sFilterFolderType)
this._sFilterFolderType[sFilterFolderType]=true;if(Is.Empty(this._sFilterFolderType))
removecss(this._main,'filter');else
addcss(this._main,'filter');};_me._filter_public=function(bFilterPublic){this._bFilterPublic=!!bFilterPublic;};_me._filter_rights=function(sFilterRights){this._sFilterRights=[];if(sFilterRights)
this._sFilterRights=sFilterRights.split('');};_me._filter_rights_or=function(sFilterRightsOr){this._sFilterRightsOr=[];if(sFilterRightsOr)
this._sFilterRightsOr=sFilterRightsOr.split('');};_me._listen_cookie=function(sCookieName)
{this._treeCookie=sCookieName;var aCookieValue=Cookie.get([sCookieName]);if(!Is.Array(aCookieValue)||!aCookieValue.length)
aCookieValue=[sPrimaryAccount];this._value(aCookieValue);};_me.__initdrag=function(id,sType,x,y,sDragType){if(this.rename)
return false;if((!sDragType||sDragType=='folder')&&WMFolders.getType(id[0])=='Y')
return false;var aName=id[0].fid.split('/'),sBody='<div class="drag_folder drag_folder_'+sType+'">'+aName[aName.length-1]+'</div>';gui.frm_main.dnd.create_drag(sBody,{type:sDragType||'folder',value:id},x,y);};_me.__mousewheel=function(e){this.__eBody.scrollTop+=e.delta*20;};_me._active_dropzone=function(v){this.__aDragFolders=[];if(v){var val={},tmp=this._value();for(var i in tmp)
val[tmp[i]]=1;if(this.__filter&&this.__filterOpen)
for(var i in this.__filterOpen)
val[this.__filterOpen[i]]=1;switch(v['type']){case'item':var itmtype=WMFolders.getType(v.value[0]);var getTargets=function(data,out){out=out||[];if(typeof data!='object')return out;var i,sPath,bActive;for(i in data){bActive=false;sPath=data[i].arg.aid+(data[i].arg.fid?'/'+data[i].arg.fid:'');if(data[i].arg){if((itmtype=='M'||itmtype=='P')&&data[i].arg.ftype=='QL'&&(data[i].arg.aid!=v.value[0].aid||data[i].arg.fid!=v.value[0].fid))
bActive=true;else
if((itmtype=='M'||itmtype=='P'||data[i].arg.ftype!='M')&&WMFolders.getAccess({aid:data[i].arg.aid,fid:data[i].arg.fid},'write')&&(data[i].arg.fid!=v.value[0].fid||data[i].arg.aid!=v.value[0].aid))
bActive=true;}
out.push([sPath,bActive]);if(data[i].nodes&&val[sPath])
getTargets(data[i].nodes,out);}
return out;};this.__aDragFolders=getTargets(this.__aFillData);break;case'folder':var sType=WMFolders.getType(v.value[0]);if(!this.__aFillData[v.value[0].aid]||!this.__aFillData[v.value[0].aid].nodes||!WMFolders.getRights(v.value[0],'remove')||sType=='QL'||sType=='I'||sType=='Y')
break;var getTargets=function(data,out){if(typeof data!='object')return out;var i,sPath,bActive;for(i in data){bActive=false;sPath=data[i].arg.aid+'/'+data[i].arg.fid;if(data[i].arg.ftype!='QL'){if((data[i].arg.ftype!='X'||data[i].arg['public'])&&v.value[0].aid+'/'+v.value[0].fid!=sPath&&WMFolders.getAccess({aid:v.value[0].aid,fid:data[i].arg.fid},'write'))
bActive=true;out.push([sPath,bActive]);if(data[i].nodes&&val[sPath])
getTargets(data[i].nodes,out);}}
return out;};this.__aDragFolders=getTargets(this.__aFillData[v.value[0].aid].nodes,[[v.value[0].aid,true]]);break;default:return;}
addcss(this._main,'active_drop');this.__objPos=getSize(this.__eBody);}
else{removecss(this._main,'active_drop');this._ondragout();}};_me.__dragscroll=function(){if(this.__objPos){var delta;if(((delta=gui.__Y-this.__objPos.y)<51&&(delta-=50))||((delta=gui.__Y-this.__objPos.y-this.__objPos.h)>-51&&(delta+=50)))
this.__eBody.scrollTop+=Math.floor(delta/10);}};_me._ondragover=function(v){var me=this;if(!this.__dragON){this.__dragON=true;gui._obeyEvent('mousewheel',[this,'__mousewheel']);this.__dragscrollloop=window.setInterval(function(){if(me.__objPos){var delta;if(((delta=gui.__Y-me.__objPos.y)<51&&(delta-=50))||((delta=gui.__Y-me.__objPos.y-me.__objPos.h)>-51&&(delta+=50)))
me.__eBody.scrollTop+=Math.floor(delta/4);}},100);}
var a,size,elm,bOK=false,bFound=false;if(this.__aDragFolders){for(var i=0;i<this.__aDragFolders.length;i++){if(!(elm=document.getElementById(this._pathName+'/'+this.__aDragFolders[i][0])))
continue;size=getSize(elm);if(v.y>=size.y&&v.y<=size.y+elm.firstChild.offsetHeight){bOK=this.__aDragFolders[i][1];if((a=elm.firstChild.getElementsByTagName('B')[0])){bFound=true;if(!this.___lastdragover||this.___lastdragover[1]!=this.__aDragFolders[i][0]){if(this.___lastdragover)
removecss(this.___lastdragover[0],'dragover');addcss(a,'dragover');this.___lastdragover=[a,this.__aDragFolders[i][0]];if(this.__dragopentimer)
if(this.__dragopentimer[1]!=this.__aDragFolders[i][0]){window.clearTimeout(this.__dragopentimer[0]);this.__dragopentimer='';}
else
break;if(hascss(elm,'plus')){this.__dragopentimer=[window.setTimeout(function(){if(me.__dragopentimer){me._open(me.__dragopentimer[1]);me._active_dropzone(v);}},800),me.__aDragFolders[i][0]];}}}
break;}}
if(!bFound&&this.___lastdragover){removecss(this.___lastdragover[0],'dragover');this.___lastdragover='';}}
a=null;elm=null;return bOK;};_me._ondragout=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;if(this.__dragscrollloop){window.clearInterval(this.__dragscrollloop);this.__dragscrollloop='';}
if(this.__dragopentimer){window.clearTimeout(this.__dragopentimer[0]);this.__dragopentimer='';}
if(this.___lastdragover){removecss(this.___lastdragover[0],'dragover');this.___lastdragover='';}};_me._ondrop=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;var size,elm,id='';for(var i=0;i<this.__aDragFolders.length;i++){if(!this.__aDragFolders[i][1]||!(elm=document.getElementById(this._pathName+'/'+this.__aDragFolders[i][0])))
continue;size=getSize(elm);if(v.y>=size.y&&v.y<=size.y+elm.firstChild.offsetHeight){id=this.__aDragFolders[i][0];break;}}
if(!id)return false;var pos=id.indexOf('/'),fol='',acc=id;if(pos>-1){fol=id.substr(pos+1);acc=id.substr(0,pos);}
switch(v.type){case'folder':gui.frm_main.dnd.remove_drag(true);if(fol&&dataSet.get('folders',[v.value[0].aid,v.value[0].fid,'DEFAULT'])){gui._create('move','frm_confirm','','',[function(){storage.library('obj_context_folder');obj_context_folder.__moveFolder(v.value[0].aid,v.value[0].fid,(fol?fol+'/':'')+Path.basename(v.value[0].fid));}],'POPUP_FOLDERS::MOVE_FOLDER','POPUP_FOLDERS::MOVE_DEFAULT');}
else{storage.library('obj_context_folder');obj_context_folder.__moveFolder(v.value[0].aid,v.value[0].fid,(fol?fol+'/':'')+Path.basename(v.value[0].fid));}
break;case'item':gui.frm_main.dnd.remove_drag(true);if(!fol)return;Item.__convertToFolder(acc,fol,v);}};_me.__getGroup=function(group){return Object.keys(dataSet.get('folders',[sPrimaryAccount])).filter(function(folder){return~folder.indexOf(group);}).map(function(folder){return dataSet.get('folders',[sPrimaryAccount,folder]);});};_me.__prepare_data=function(aData)
{var aResult={},aFrame,aSplitFolder,aParcSplitFolder,sFolder,sFolderType,sTotal,bRecent,iCount,sIconClass,sMainClass,sLiClass,bDisabled,aAccounts={},aAccounts_tmp=dataSet.get('accounts',null,true),group=0;for(var i in aData)
if(!aAccounts_tmp[i])
aAccounts_tmp[i]={};var srt=[];for(var i in aAccounts_tmp)
if(i!=sPrimaryAccount)
srt.push(i);srt=srt.sort();if(!this.sFilterAccountId||this.sFilterAccountId==sPrimaryAccount)
aAccounts[sPrimaryAccount]=aAccounts_tmp[sPrimaryAccount];for(var i=0;i<srt.length;i++)
aAccounts[srt[i]]=aAccounts_tmp[srt[i]];aAccounts_tmp=null;storage.library('wm_folders');var sSpamPath=dataSet.get('main',['spam_path']),sArchivePath=dataSet.get('main',['archive_path']),aDFolders=GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES'],aCalendars=false,aActive=this._getActive();if(aActive[0]==sPrimaryAccount&&aActive[1]=='__@@VIRTUAL@@__/__@@EVENTS@@__'){aCalendars=dataSet.get('folders',[aActive[0],aActive[1],'VIRTUAL','FOLDERS'],true)||{};for(var i in aCalendars){aCalendars[i]=[aCalendars[i],getCalendarColor(i)];if(aCalendars[i][0]){this.__currentVirtualFolder=i;var id,a=i.split("/");do{a.pop();if((id=a.join("/")))
this._open(sPrimaryAccount+'/'+id,'minus');}
while(a.length>0);}}}
for(var sAccId in aAccounts)
{if(this.sFilterAccountId&&sAccId!=this.sFilterAccountId)
continue;if(aAccounts[sAccId]['DESCRIPTION'])
aResult[sAccId]={"nodes":{},"arg":{"aid":sAccId},"text":aAccounts[sAccId]['DESCRIPTION']};else
aResult[sAccId]={"nodes":{},"arg":{"aid":sAccId}};if(sAccId==sPrimaryAccount){aResult[sAccId].text=dataSet.get('main',['fullname']);aResult[sAccId].ico='ico_home';}
var sLastPublic='';for(var sFolId in aData[sAccId]){if((aCalendars||this._sFilterVirtual)&&sAccId==sPrimaryAccount&&sFolId.indexOf('__@@VIRTUAL@@__/')==0)
continue;if(sAccId==sPrimaryAccount&&sFolId=='__@@VIRTUAL@@__/__@@EVENTS@@__')
continue;if(this._bFilterPublic){if(aData[sAccId][sFolId]['PUBLIC']){sLastPublic=sFolId;continue;}
else if(sLastPublic&&sFolId.indexOf(sLastPublic)===0){continue;}}
if(this._sFilterFolderType){if(aData[sAccId][sFolId]['TYPE']=='M'&&aData[sAccId][sFolId]['RSS']&&!this._sFilterFolderType['R'])
continue;else if(this._sFilterFolderType['B']&&aData[sAccId][sFolId]['TYPE']=='M'&&aData[sAccId][sFolId]['DEFAULT']=='H'){}else if(!this._sFilterFolderType[aData[sAccId][sFolId]['TYPE']]){continue;}}
if((aData[sAccId][sFolId]['TYPE']=='Y'||aData[sAccId][sFolId]['TYPE']=='I')&&this._sFilterFolderType&&!this._sFilterFolderType['Y'])
continue;if(this._sFilterRights){var bSkip=false,sRights=Cookie.get(['rights',sAccId,sFolId]).join('');if(sRights.length){for(var r in this._sFilterRights)
if(sRights.indexOf(this._sFilterRights[r])<0){bSkip=true;break;}
if(bSkip)
continue;}}
if(this._sFilterRightsOr){var bSkip=true,sRights=Cookie.get(['rights',sAccId,sFolId]).join('');for(var r in this._sFilterRightsOr)
if(sRights.indexOf(this._sFilterRightsOr[r])>-1){bSkip=false;break;}
if(bSkip)
continue;}
aSplitFolder=sFolId.split("/");aParcSplitFolder=[];aFrame=aResult[sAccId]["nodes"];for(var i in aSplitFolder)
{aParcSplitFolder.push(aSplitFolder[i]);sFolder=aParcSplitFolder.join('/');sMainClass='';sLiClass='';group=0;if(typeof aFrame[aSplitFolder[i]]!='object'||(aFrame[aSplitFolder[i]].arg&&aFrame[aSplitFolder[i]].arg.disabled)){if(aData[sAccId][sFolder]&&(sFolderType=aData[sAccId][sFolder]['TYPE'])){if(sFolderType==='I'&&(!aData[sAccId][sFolder].SYNC||aData[sAccId][sFolder].SYNC==='0')){continue;}
if(this._sFilterFolderType&&this._sFilterFolderType['Y']&&this._sFilterFolderType['I']&&count(this._sFilterFolderType)==2){if(!this._sFilterFolderType[sFolderType])
sLiClass='skip';if(aData[sAccId][sFolder]['TYPE']=='Y'){if(aData[sAccId][sFolder]['OWNER'])
aData[sAccId][sFolder]['NAME']=aSplitFolder[i-1];group=this.__getGroup(aSplitFolder[i-1]).filter(function(folder){return folder.TYPE==='I';}).reduce(function(previous,current){return previous+(current.RECENT||0)*1;},0);sLiClass='menu';}}
if(aData[sAccId][sFolder]['TYPE']==='X'&&dataSet.get('active_folder',['TYPE'])==='I'){group=this.__getGroup(sFolder).filter(function(folder){return folder.TYPE==='I';}).reduce(function(previous,current){return previous+(current.RECENT||0)*1;},0);}
bDisabled=(sFolder!=sFolId)||sFolderType=='VA'||sFolderType=='Y';bRecent=aData[sAccId][sFolder]['RECENT']>0?true:false;sTotal=bRecent?'&#8234;'+aData[sAccId][sFolder]['RECENT']:'';iCount=+(aData[sAccId][sFolder]['COUNT']||0);sMainClass=bRecent?'recent':'';bRecent&&(sLiClass+=' unread ');if(sFolderType=='G')
sIconClass='ico_gwtrash';else
switch(sAccId+'/'+sFolId){case(sAccId+'/INBOX'):sIconClass='ico_inbox';break;case aDFolders.trash:sIconClass='ico_trash';break;case aDFolders.sent:sIconClass='ico_sent';break;case aDFolders.drafts:sIconClass='ico_drafts';break;case sSpamPath:sIconClass='ico_spam';break;case sArchivePath:sIconClass='ico_archive';break;case(sAccId+'/Quarantine'):sIconClass='ico_quarantine';break;case(sAccId+'/SPAM_QUEUE/Blacklist'):sIconClass='ico_black';break;case(sAccId+'/SPAM_QUEUE/Whitelist'):sIconClass='ico_white';break;default:if(aData[sAccId][sFolder].RSS)
sIconClass='ico_r';else
if((sFolderType=='M'||sFolderType=='X')&&sFolId.indexOf(sPrimaryAccountSPREFIX)==0&&sFolId.indexOf('@')>0&&sFolId.indexOf('/')<0)
sIconClass='ico_a';else
if(aData[sAccId][sFolder].PUBLIC)
sIconClass='ico_shared';else{sIconClass=sFolderType?'ico_'+sFolderType.toLowerCase():'';if(sArchivePath&&(sAccId+'/'+sFolId).indexOf(sArchivePath+'/')==0){switch(sAccId+'/'+(sAccId+'/'+sFolId).replace(sArchivePath+'/','')){case sAccId+'/Inbox':sIconClass='ico_inbox';break;case aDFolders.trash:sIconClass='ico_trash';break;case aDFolders.sent:sIconClass='ico_sent';break;case aDFolders.drafts:sIconClass='ico_drafts';break;}}
else
switch(sAccId+'/'+sFolId){case aDFolders.contacts:case aDFolders.events:case aDFolders.notes:case aDFolders.journal:case aDFolders.files:sMainClass+=' default';}
if(sFolderType=='E'&&aCalendars){sIconClass='color';sTotal='';if(aCalendars[sFolId]){sLiClass=aCalendars[sFolId][0]?'active':'';sIconClass+=' checked'+(aCalendars[sFolId][1]?' '+aCalendars[sFolId][1]:'');}}}}
if(sFolder!=sFolId){sIconClass+=' ico_x';var folder_dataset=dataSet.get('folders',[sAccId,sFolder])||{};var write=~(folder_dataset.RIGHTS||'').indexOf('k');if(folder_dataset.TYPE==='Y'){write=write||~(dataSet.get('folders',[sAccId,sFolder.replace('/TeamChat',''),'RIGHTS'])||'').indexOf('k');}
if(!write){sIconClass+=' no-write ';}}
aFrame[aSplitFolder[i]]={"nodes":(aFrame[aSplitFolder[i]]&&aFrame[aSplitFolder[i]].nodes?aFrame[aSplitFolder[i]].nodes:{}),"arg":{"aid":sAccId,"fid":sFolder,"ftype":sFolderType,"disabled":bDisabled,"public":aData[sAccId][sFolId].PUBLIC,"spam":aData[sAccId][sFolId].SPAM==='true'},"title2":iCount||sTotal,"ico":sIconClass,"itmclass":sMainClass,"liclass":sLiClass,group:group};if(aData[sAccId][sFolder]['NAME'])
aFrame[aSplitFolder[i]]['text']=aData[sAccId][sFolder]['NAME'];}
else
if(sFolder=='SPAM_QUEUE')
aFrame[aSplitFolder[i]]={"nodes":(aFrame[aSplitFolder[i]]&&aFrame[aSplitFolder[i]].nodes?aFrame[aSplitFolder[i]].nodes:{}),"arg":{"aid":sAccId,"fid":sFolder,"ftype":"X","disabled":"true"},"title":'COMMON_FOLDERS::SPAM_QUEUE',"title2":'',"itmclass":sMainClass,"ico":'ico_spamqueue'};else
if(sFolder=='__@@VIRTUAL@@__')
aFrame[aSplitFolder[i]]={"nodes":(aFrame[aSplitFolder[i]]&&aFrame[aSplitFolder[i]].nodes?aFrame[aSplitFolder[i]].nodes:{}),"arg":{"aid":sAccId,"fid":sFolder,"ftype":"X"},"title":'COMMON_FOLDERS::VIRTUAL-FOLDERS',"title2":'',"itmclass":sMainClass,"ico":'ico_virtual'};else
aFrame[aSplitFolder[i]]={"nodes":(aFrame[aSplitFolder[i]]&&aFrame[aSplitFolder[i]].nodes?aFrame[aSplitFolder[i]].nodes:{}),"arg":{"aid":sAccId,"fid":sFolder,"ftype":"X","disabled":"true"},"title2":'',"itmclass":sMainClass,"ico":'ico_x'};}
else
if(sFolder==sFolId&&aData[sAccId][sFolder])
aFrame[aSplitFolder[i]]["arg"]["disabled"]=false;aFrame=aFrame[aSplitFolder[i]]["nodes"];}}
if(this._sFilterFolderType&&Is.Empty(aResult[sAccId]['nodes'])&&sAccId!=sPrimaryAccount)delete aResult[sAccId];}
return aResult;};

/* client/inc/obj_tree_folder2.js */
_me=obj_tree_folder2.prototype;function obj_tree_folder2(){};_me.__constructor=function(sFilterAccountId,sFilterFolderType,sFilterRights,bSkipVirtual)
{this._opt={privateRootActive:true};if(sFilterAccountId)
this._filter_account(sFilterAccountId);if(sFilterFolderType)
this._filter_folder(sFilterFolderType);if(sFilterRights)
this._filter_rights(sFilterRights);if(bSkipVirtual)
this._sFilterVirtual=true;this._listen_data('folders');};_me.__prepare_data=function(aData)
{var aResult={},aAccounts=dataSet.get('accounts'),aCalendars=false,sTrashPath=GWOthers.getItem('DEFAULT_FOLDERS','trash');if(this._sFilterFolderType&&this._sFilterFolderType['E']&&count(this._sFilterFolderType)==1){aCalendars=dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS'],true)||{};for(var i in aCalendars){aCalendars[i]=[aCalendars[i],getCalendarColor(i)];}}
var accounts=Object.keys(aAccounts).filter(function(sAccId){return Is.Defined(aData[sAccId])&&(!this._sFilterAccountId||this._sFilterAccountId==sAccId);},this).sort(function(a,b){if(aAccounts[a].PRIMARY)
return-1;else
if(aAccounts[b].PRIMARY)
return 1;else
if(a==b)
return 0;else
return a>b?1:-1;});accounts.forEach(function(sAccId){if(aAccounts[sAccId].PRIMARY){aResult[sAccId]={nodes:[],arg:{},text:dataSet.get('main',['fullname']),ico:'ico_home',liclass:'skip'};}
else{if(!aResult['other']){aResult['other']={nodes:{},text:getLang('SETTINGS::OTHER_ACCOUNTS'),liclass:'external',id:'root::other',arg:{disabled:true}};}
aResult['other'].nodes[sAccId]={nodes:[],arg:{disabled:true},liclass:'root_private',ico:'root_private'};if(aAccounts[sAccId].DESCRIPTION)
aResult['other'].nodes[sAccId].text=aAccounts[sAccId]['DESCRIPTION'];}
var oFolders=aData[sAccId],nodes={'private':[],'public':[],'shared':[],resources:[]};for(var fid in oFolders){if(oFolders.hasOwnProperty(fid)){if((aCalendars||this._sFilterVirtual)&&sAccId==sPrimaryAccount&&fid.indexOf('__@@VIRTUAL@@__/')==0)
continue;if(sAccId==sPrimaryAccount&&fid=='__@@VIRTUAL@@__/__@@EVENTS@@__')
continue;if(this._sFilterFolderType){if(!this._sFilterFolderType['R']&&oFolders[fid].TYPE=='M'&&oFolders[fid].RSS){continue;}
if(!this._sFilterFolderType[oFolders[fid].TYPE]){if(!this._sFilterFolderType['B']||oFolders[fid].TYPE!='M'||!(oFolders[fid].DEFAULT=='H'||(sAccId+'/'+fid).indexOf(sTrashPath+'/')==0)){continue;}}}
if((oFolders[fid].TYPE=='Y'||oFolders[fid].TYPE=='I'||oFolders[fid].PRIVATE_ROOT)&&(!this._sFilterFolderType||!this._sFilterFolderType['Y']))
continue;if(this._sFilterRights){var bSkip=false,sRights=Cookie.get(['rights',sAccId,fid]).join('');if(sRights.length){for(var r in this._sFilterRights)
if(sRights.indexOf(this._sFilterRights[r])<0){bSkip=true;break;}
if(bSkip)
continue;}}
if(this._sFilterRightsOr){var bSkip=true,sRights=Cookie.get(['rights',sAccId,fid]).join('');for(var r in this._sFilterRightsOr)
if(sRights.indexOf(this._sFilterRightsOr[r])>-1){bSkip=false;break;}
if(bSkip)
continue;}
var node_type,root='';if(oFolders[fid].TYPE=='Y'||(((oFolders[fid].OWNER&&oFolders[fid].OWNER!=sPrimaryAccount)||oFolders[fid].SHARED||oFolders[fid].PUBLIC||oFolders[fid].SUBSCRIPTION_TYPE)&&!oFolders[fid].PRIVATE_ROOT)){if(oFolders[fid].PUBLIC){node_type='public';}
else
if(oFolders[fid].SHARED){node_type='shared';}
else{if(oFolders[fid].RELATIVE_PATH){root=fid.slice(0,-(oFolders[fid].RELATIVE_PATH.length+1));}
else
if(oFolders[fid].SUBSCRIPTION_TYPE){root=fid.split('/').shift();}
else{root=fid.split('/').slice(0,-1).join('/');}
if(root!==''&&oFolders[root]){if(oFolders[root].PRIVATE_ROOT){node_type='private';}
else
if(oFolders[root].PUBLIC){node_type='public';}
else
if(aCalendars&&oFolders[root].RESOURCE){node_type='resources';}
else{node_type='shared';}}
else{node_type='public';}}}
else{node_type='private';if(aCalendars&&oFolders[fid].RELATIVE_PATH){root=fid.slice(0,-(oFolders[fid].RELATIVE_PATH.length+1));if(oFolders[root]&&oFolders[root].RESOURCE)
node_type='resources';}}
if(this._bFilterPublic&&node_type=='public')
continue;if(this._filterData&&this._filterData({aid:sAccId,fid:fid,data:oFolders[fid]}))
continue;nodes[node_type].push({aid:sAccId,fid:fid,data:oFolders[fid]});}}
for(var t in nodes){if(nodes.hasOwnProperty(t)){nodes[t]=this.__cleanup(this.__fillIn(nodes[t],sAccId));var tree=this.__toTree(nodes[t],t,aCalendars);nodes[t]=tree.nodes;if(tree.group)
nodes[t].group=tree.group;}}
if(nodes.private.length){var private={nodes:this.__privateSort(nodes.private),liclass:'root_private',ico:'root_private',group:nodes.private.group,arg:{disabled:!this._opt.privateRootActive||(this._sFilterFolderType&&(this._sFilterFolderType['Y']||this._sFilterFolderType['E'])),aid:sAccId}};if(aAccounts[sAccId].PRIMARY){private.text=dataSet.get('accounts',[sPrimaryAccount,'FULLNAME'])||dataSet.get('accounts',[sPrimaryAccount,'USERNAME']);aResult[sAccId].nodes.push(private);}
else{aResult['other'].nodes[sAccId].nodes=private.nodes;}}
if(aAccounts[sAccId].PRIMARY){if(nodes.public.length){aResult[sAccId].nodes.push({nodes:nodes.public,title:'COMMON_FOLDERS::PUBLIC_ROOT',liclass:'root_public',ico:'root_public',arg:{disabled:true}});}
if(nodes.resources.length){aResult[sAccId].nodes.push({nodes:nodes.resources,title:'COMMON_FOLDERS::RESOURCES',liclass:'root_resources',ico:'root_resources',arg:{disabled:true}});}
if(nodes.shared.length){aResult[sAccId].nodes.push({nodes:nodes.shared,title:'COMMON_FOLDERS::SHARED_ROOT',liclass:'root_shared',ico:'root_shared',arg:{disabled:true}});}}
else
if(!aResult['other'].nodes[sAccId].nodes.length){delete aResult['other'].nodes[sAccId];}}.bind(this));if(aResult['other']&&Is.Empty(aResult['other'].nodes)){delete aResult['other'];}
this.__mapTree(aResult);if(aCalendars){var treeID;for(var i in aCalendars){treeID=this._getTreeId(sPrimaryAccount+'/'+i);if(aCalendars[i][0]&&treeID){this.__value=this.__cleanup(this.__value.concat(treeID.split('/').map(function(v,i,a){return a.slice(0,i).concat(v).join('/');})));}}}
return aResult;};_me.__mapTree=function(aData,sPath){if(!sPath){this.__idTableReal={};this.__idTableTree={};sPath='';}
for(var id in aData){if(aData.hasOwnProperty(id)){if(aData[id].arg.aid){var tmp=aData[id].arg.aid+(Is.Defined(aData[id].arg.fid)?'/'+aData[id].arg.fid:'');this.__idTableReal[tmp]=this.__idTableReal[tmp]||[];this.__idTableReal[tmp].push(sPath+id);this.__idTableTree[sPath+id]=tmp;}
else{var pathId=sPath+(aData[id].id||id);this.__idTableTree[pathId]=pathId;this.__idTableReal[pathId]=[pathId];}
if(aData[id].nodes){this.__mapTree(aData[id].nodes,sPath+id+'/');}}}};_me._getTreeId=function(id,bArray){return bArray?(this.__idTableReal[id]||[]):(this.__idTableReal[id]?this.__idTableReal[id][0]:null);};_me._getRealId=function(id){return this.__idTableTree[id];};_me._filter=function(aData){var aData2={},filter=this.__filter,sName,aFolders,aKey,bFound,sLast,oOpen={};for(var sDomain in aData){sLast='';aFolders=aData[sDomain];aKey=Object.keys(aFolders).sort().reverse().filter(function(v){sName=(aFolders[v].NAME||Path.basename(v)).toLowerCase();bFound=~sName.indexOf(filter);if(v==sLast||bFound){sLast=Path.basedir(v);oOpen[sDomain+(sLast?'/'+sLast:'')]=true;return!!bFound;}});if(aKey.length){aData2[sDomain]={};aKey.reverse().forEach(function(v){aData2[sDomain][v]=aFolders[v];});}}
return{aData:aData2,aOpen:Object.keys(oOpen).sort()};};_me.__fillIn=function(arr,sAccId){var aFolders=dataSet.get('folders',[sAccId]);if(Intl&&'Collator'in Intl){var coll=new Intl.Collator();arr.sort(function(a,b){return coll.compare(a.fid,b.fid);});}
else{arr.sort(function(a,b){return a.fid.localeCompare(b.fid);});}
for(var i=0,j=arr.length;i<j;i++){if(arr[i].fid&&~arr[i].fid.indexOf('/')){var prev=arr[i].fid.split('/').slice(0,-1).join('/'),data,parent=arr.some(function(folder){return folder.fid===prev;});if(!parent){data={TYPE:"X",RIGHTS:"rl",};switch(prev){case'__@@VIRTUAL@@__':data.NAME=getLang('COMMON_FOLDERS::VIRTUAL-FOLDERS');break;case'SPAM_QUEUE':data.NAME=getLang('COMMON_FOLDERS::SPAM_QUEUE');break;default:if(aFolders[prev]){if(aFolders[prev].NAME){data.NAME=aFolders[prev].NAME;}
if(aFolders[prev].TYPE){data.TYPE=aFolders[prev].TYPE;data.disabled=true;}
if(aFolders[prev].RESOURCE){data.RESOURCE=aFolders[prev].RESOURCE;}}}
arr.splice(i,0,{aid:arr[i].aid,fid:prev,data:data});i--;j++;}}}
return arr;};_me.__cleanup=function(arr){for(var i=arr.length;i--;){if(arr[i].data&&(arr[i].data.TYPE=='X'||arr[i].data.TYPE=='Y')){if(!arr[i+1]||arr[i].aid!=arr[i+1].aid||arr[i+1].fid.indexOf(arr[i].fid+'/')!=0){arr.splice(i,1);}}}
return arr;};_me.__toTree=function(arr,sNodeType,aCalendars){var aOut=[],tmp={},group=0;arr.forEach(function(f,i){var path=f.fid.split('/');var item={arg:{aid:f.aid,fid:f.fid,data:f.data,ftype:f.data.TYPE||'X'},text:f.data.NAME||Path.basename(f.fid),ico:this.__getIcon(f)};if(sNodeType=='shared'&&~item.text.indexOf('@')){item.text='<img src="'+getAvatarURL(item.text)+'" class="avatar"/>'+item.text;}
if(sNodeType=='resources'&&f.data.RESOURCE){item.liclass='skip';}
if(item.arg.ftype=='X'||f.data.disabled)
item.arg.disabled=true;else
if(item.arg.ftype=='Y'){item.liclass='skip';item.arg.disabled=true;}
else
if(aCalendars&&item.arg.ftype=='E'){item.ico='color';if(aCalendars[f.fid]){if(aCalendars[f.fid][0]){item.liclass='active';}
item.ico+=' checked'+(aCalendars[f.fid][1]?' '+aCalendars[f.fid][1]:'');}}
else
if(f.data.RECENT>'0'||f.data.COUNT>'0'){item.title2=+f.data.COUNT||+f.data.RECENT;if(f.data.TYPE=='I'&&item.title2>999){item.title2='999+';}
item.itmclass="recent";item.liclass="unread";}
if(!WMFolders.getRights([f.aid,f.fid],'write')){item.ico+=' no-write';}
if(path.length===1){aOut.push(item);}
else{var parentPath=path.slice(0,-1).join('/');if(tmp[parentPath]){if(!tmp[parentPath].nodes)
tmp[parentPath].nodes=[];tmp[parentPath].nodes.push(item);if(sNodeType=='private'){if(f.data.TYPE=='Y')
tmp[parentPath].liclass='skip';}
if(f.data.TYPE=='I'&&f.data.RECENT>'0'){if(sNodeType=='private'){group=group+(+f.data.RECENT);if(group>999){group='999+';}}
else{parentPath=path.slice(0,-2).join('/');if(parentPath){tmp[parentPath].group=+(tmp[parentPath].group||0)+(+f.data.RECENT);if(tmp[parentPath].group>999){tmp[parentPath].group='999+';}}}}}}
tmp[f.fid]=item;}.bind(this));return{nodes:aOut,group:group};};_me.__getIcon=function(folder){var ico='';if(folder.data){switch(folder.data.TYPE){case'M':if(folder.data.RSS){ico='r';}
else
if(folder.fid==='INBOX'&&folder.aid===sPrimaryAccount){ico='inbox';}
else
if(folder.data.SPAM){ico='spam';}
else
if(folder.data.ARCHIVE){ico='archive';}
else
if(folder.data.DEFAULT){ico=({H:'trash',S:'sent',D:'drafts'})[folder.data.DEFAULT]||'m';}
else
ico='m';break;case'Q':ico='quarantine';break;case'G':ico='gwtrash';break;case'QL':ico=folder.fid==='SPAM_QUEUE/Blacklist'?'black':'white';break;default:if(folder.fid=='SPAM_QUEUE')
ico='spamqueue';else
if(folder.fid=='__@@VIRTUAL@@__')
ico='virtual';else
if(folder.data.TYPE)
ico=folder.data.TYPE.toLowerCase();}
ico=(ico?'ico_'+ico:'')+(folder.data.DEFAULT?' default':'');}
return ico;};_me.__privateSort=function(aFolders){var aInbox=[],aSent=[],aDraft=[],aArchive=[],aSpam=[],aTrash=[],aDefaultMail=[],aDefaultGW=[];var aFilter=aFolders.filter(function(folder,i){if(folder.arg.ftype!='X'){if(folder.arg.fid=='INBOX'){aInbox.push(folder);return false;}
if(folder.arg.data){if(folder.arg.data.ARCHIVE){aArchive.push(folder);return false;}
if(folder.arg.data.SPAM){aSpam.push(folder);return false;}
if(folder.arg.data.DEFAULT){switch(folder.arg.data.DEFAULT){case'S':aSent.push(folder);break;case'D':aDraft.push(folder);break;case'H':aTrash.push(folder);break;case'P':aDefaultMail.push(folder);break;default:aDefaultGW.push(folder);}
return false;}}}
return true;});return[].concat(aInbox,aSent,aDraft,aArchive,aSpam,aTrash,aDefaultMail,aDefaultGW,aFilter);};_me._listen_cookie=function(sCookieName)
{this._treeCookie=sCookieName;var aCookieValue=Cookie.get([sCookieName]);if(!Is.Array(aCookieValue)||!aCookieValue.length)
aCookieValue=[sPrimaryAccount];this._value(aCookieValue);};_me._filter_account=function(sFilterAccountId){this._sFilterAccountId=sFilterAccountId;};_me._filter_folder=function(filterFolderType){this._sFilterFolderType={};if(Is.String(filterFolderType)){this._sFilterFolderType[filterFolderType]=true;}
else{for(var i in filterFolderType){if(filterFolderType.hasOwnProperty(i)){this._sFilterFolderType[filterFolderType[i]]=true;}}}
if(Is.Empty(this._sFilterFolderType))
removecss(this._main,'filter');else
addcss(this._main,'filter');};_me._filter_public=function(bFilterPublic){this._bFilterPublic=!!bFilterPublic;};_me._filter_rights=function(sFilterRights){this._sFilterRights=(sFilterRights||'').split('');};_me._filter_rights_or=function(sFilterRightsOr){this._sFilterRightsOr=(sFilterRightsOr||'').split('');};_me._rename=function(arg){if(this.rename)this.rename._onclose();this._norefresh=true;var sLiId=this._getElmId(this._getTreeId(arg.aid+(arg.fid?'/'+arg.fid:''))),hDiv=document.getElementById(sLiId).getElementsByTagName('DIV')[0];addcss(hDiv,'edit');var sAnchor=sLiId+'#editDiv';this._anchors['editDiv']=sAnchor;hDiv.id=sAnchor;var nPos=arg.fid.lastIndexOf('/'),sParentName=arg.fid.substring(0,nPos),sFolderName=dataSet.get("folders",[arg['aid'],arg['fid'],'NAME'])||arg.fid.substring(nPos+1);var rename=this._create('rename','obj_input','editDiv');rename._restrict('![/\\\\:\?\"\<\>\|\~]+','','^.{1,255}$');rename.__eIN.onclick=function(e){var e=e||window.event;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;};rename._value(sFolderName);rename._setRange(0,sFolderName.length);rename._onsubmit=function(e){if(this._checkError&&this._checkError.length)return;var snew=(this._value()||'').trim();var sold=sFolderName;if(sold==snew){this._onclose();return;}
var sNewFolderID=(sParentName?sParentName+'/':'')+snew;obj_context_folder.__moveFolder(arg.aid,arg.fid,sNewFolderID);this._onclose();};rename._onclose=function(e){if(this.rename._destructed)return false;this.rename._destruct();removecss(hDiv,'edit');this._norefresh=false;if(!e||this._updateBuffer)
this.__update(this._listener_data);}.bind(this);rename._onkeydown=function(e){var e=e||window.event;if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;};rename._onblur=rename._onclose;delete this._anchors['editDiv'];};_me._filterData=function(aData){return(this._sFilterFolderType&&this._sFilterFolderType['Y']&&aData.data.TYPE=='I'&&aData.data.SYNC!=1);};

/* client/inc/obj_tree_folder2_archive.js */
function obj_tree_folder2_archive(){}
_me=obj_tree_folder2_archive.prototype;_me.__constructor=function(){this._opt.privateRootActive=false;this._filter_folder(['Y','I']);this._fill();this._add_destructor('__off');dataSet.on('active_folder',[],this.__activate,this).on('cookies',['active_groupchat_view'],this.__activate,this);};_me._filterData=function(aData){return!(aData.data.TYPE=='Y'||(aData.data.SYNC||0)==0);};_me._onclick=function(e,elm,id,arg){if(e.type=='contextmenu'){var sFolType=WMFolders.getType(arg);if(sFolType=='I'){var aMenu=this.__createMenu(arg);if(aMenu.length){var cmenu=gui._create("cmenu","obj_context_folder",'','',this);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);}}}
else
if(arg){if(arg['fid']=='__@@VIRTUAL@@__'||arg.ftype=='X')
this._open(id);else{arg=clone(arg);arg.elm=elm;return this._handleNode(arg);}}};_me.__createMenu=function(arg){var rights=WMFolders.getRights(arg);return[{'title':'FORM_BUTTONS::RENAME',css:'ico2 edit_folder','arg':{aid:sPrimaryAccount,fid:arg.fid,ftype:'I',method:'rename_folder'},disabled:!rights.edit_folder},{title:'FORM_BUTTONS::SUBSCRIBE',css:'ico2 sync_folder','arg':{aid:sPrimaryAccount,fid:arg.fid,ftype:'I',method:'subscribe',callback:[this,'__subscribe_cb',[arg]]}},rights.owner?{'title':'POPUP_FOLDERS::MEMBERS',css:'ico2 color1 members','arg':{aid:sPrimaryAccount,fid:arg.fid,method:'share'}}:false,{'title':'POPUP_ITEMS::DELETE',css:'ico2 color2 delete_folder','arg':{aid:sPrimaryAccount,fid:arg.fid,method:'delete_folder'},disabled:!rights.remove}].filter(Boolean);};_me._handleNode=function(arg){if(arg.ftype=='I'){var aFolder=dataSet.get('active_folder');if(aFolder!=arg['aid']+'/'+arg['fid'])
gui.frm_main._selectView(arg);else
gui.__exeEvent('folderSelected',arg);}};_me.__subscribe_cb=function(bOK,arg){};_me.__activate=function(){if(Cookie.get(['active_groupchat_view'])==3)
this._setActive(dataSet.get('active_folder'),false,true);};_me.__off=function(){dataSet.off('active_folder',[],this.__activate).off('cookies',['active_groupchat_view'],this.__activate);};

/* client/inc/obj_tree_folder_context.js */
_me=obj_tree_folder_context.prototype;function obj_tree_folder_context(){};_me.__constructor=function(){this._listen_cookie('tree');if(sPrimaryAccountGUEST)
addcss(this._main,'guest');};obj_tree_folder_context.__createFolderMenu=function(arg,bMoreMenu){var aMenu=[];if(arg){if(arg['fid']){var sFolType=WMFolders.getType(arg);if(sFolType=='Y'){var aRights=WMFolders.getRights(arg),folder_write=~(dataSet.get('folders',[arg.aid,arg.fid,'RIGHTS'])||'').indexOf('k'),bPrivate=dataSet.get('folders',[arg.aid,Path.basedir(arg.fid),'PRIVATE_ROOT'])==="true";aMenu.push({'title':'POPUP_FOLDERS::ADD_ROOM','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'add_room'},css:'ico2 add_folder','disabled':!(folder_write||bPrivate)});if(!bPrivate&&aRights.owner)
aMenu.push({'title':'POPUP_FOLDERS::MEMBERS','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'share'},css:'color1 ico2 members'});if(~(dataSet.get('folders',[arg.aid,Path.basedir(arg.fid),'RIGHTS'])||'').indexOf('a'))
aMenu.push({title:'-'},{anchor:'storage'});}
else
if(sFolType=='I'){var aRights=WMFolders.getRights(arg);aMenu.push({'title':'POPUP_FOLDERS::RENAME_ROOM','arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':arg['ftype'],'method':'rename_folder'},css:'ico2 edit_folder','disabled':!aRights.edit_folder},{'title':'FORM_BUTTONS::UNSUBSCRIBE',css:'ico2 archive_folder','arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':arg['ftype'],method:'unsubscribe'}});aRights.owner&&aMenu.push({'title':'POPUP_FOLDERS::MEMBERS','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'share'},css:'color1 ico2 members'});!sPrimaryAccountGUEST&&aMenu.push({'title':'POPUP_FOLDERS::CLONE_ROOM','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'clone'},css:'ico2 clone_room','disabled':!WMFolders.getRights([arg.aid,Path.basedir(arg.fid)]).write},{'title':'IM::SEND_MAIL_TO_ALL','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'sendEmailToAllMembers'},css:'ico2 from_template'});aMenu.push({'title':'-'},{'title':'POPUP_FOLDERS::DELETE_ROOM','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'delete_folder'},css:'ico2 color2 delete_folder','disabled':!aRights.remove});}
else
if(sFolType=='G'){if(!dataSet.get('main',['keep_deleted_items_force_expiration'])){aMenu.push({'title':'MAIN_MENU::EMPTY_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'empty_folder',css:'ico2 color2 empty_folder'}});}}
else
{var bVirtual=arg['fid'].indexOf('__@@VIRTUAL@@__/')==0,bArchive=dataSet.get('folders',[arg['aid'],arg['fid'].split('/')[0],'ARCHIVE'])?true:false,aRights=WMFolders.getRights(arg),aAccess=WMFolders.getAccess(arg);if(sFolType=='M'){var title;if(gui.frm_main.main&&gui.frm_main.main.list&&gui.frm_main.main.list._SQLsearch){title='POPUP_FOLDERS::ITEM_ACTIONS_FILTERED';}else{title='POPUP_FOLDERS::ITEM_ACTIONS';}
aMenu.push({'title':title,css:'ico2 manage',nodes:[{'title':'POPUP_FOLDERS::MARK_ALL_AS_READ','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'mark_all_as_read'},css:'ico2 markread','disabled':!aAccess.modify},{'title':'-'},{'title':'POPUP_ITEMS::COPY_MAIL_TO','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'copyall'},css:'ico2 copy','disabled':bVirtual},{'title':'POPUP_ITEMS::MOVE_MAIL_TO','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'moveall'},css:'ico2 move','disabled':!aAccess.remove||bVirtual},{'title':'-'},{'title':'MAIN_MENU::EMPTY_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'empty_folder'},'disabled':!aAccess.remove,'css':'ico2 color2 empty_folder'}]},{'title':'-'});if(bMoreMenu)
aMenu.push({title:'MAIN_MENU::NEW_MESSAGE',css:'ico2 new_template',arg:{method:'new_template'}});}
if(sFolType=='VA'){if(dataSet.get('folders',[arg['aid'],arg['fid'],'SUBSCRIPTION_TYPE'])=='account')
aMenu.push({'title':'POPUP_FOLDERS::ADD_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'add_folder'},css:'ico2 add_folder','disabled':!aRights.write},{'title':'POPUP_FOLDERS::SHARING','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'share'},css:'ico2 color1 share_folder','disabled':!aRights.owner},{'title':'-'},{'title':'POPUP_FOLDERS::REMOVE_ACCOUNT','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'delete_folder'},css:'ico2 color2 delete_folder','disabled':!aRights.remove});}
else
if(sFolType=='X'&&arg['fid']=='__@@VIRTUAL@@__'){if(GWOthers.getItem('RESTRICTIONS','disable_virtual')!='1')
aMenu.push({'title':'POPUP_FOLDERS::ADD_VIRTUAL',css:'ico2 add_vfolder','arg':{'method':'add_virtual'}});}
else
if(sFolType!='Q'&&sFolType!='QL'){if(sFolType=='E'&&dataSet.get('active_folder')==sPrimaryAccount+'/__@@VIRTUAL@@__/__@@EVENTS@@__'){aMenu.push({'title':'POPUP_FOLDERS::COLOR',nodes:[{'title':'COLORS::BLUE','arg':{'fid':arg['fid'],color:'blue','method':'cal_color'},css:'ico2 color blue'},{'title':'COLORS::GREEN','arg':{'fid':arg['fid'],color:'green','method':'cal_color'},css:'ico2 color green'},{'title':'COLORS::BROWN','arg':{'fid':arg['fid'],color:'brown','method':'cal_color'},css:'ico2 color brown'},{'title':'COLORS::PURPLE','arg':{'fid':arg['fid'],color:'purple','method':'cal_color'},css:'ico2 color purple'},{'title':'COLORS::YELLOW','arg':{'fid':arg['fid'],color:'yellow','method':'cal_color'},css:'ico2 color yellow'},{'title':'COLORS::TEAL','arg':{'fid':arg['fid'],color:'teal','method':'cal_color'},css:'ico2 color teal'},{'title':'COLORS::PLUM','arg':{'fid':arg['fid'],color:'plum','method':'cal_color'},css:'ico2 color plum'},{'title':'COLORS::RED','arg':{'fid':arg['fid'],color:'red','method':'cal_color'},css:'ico2 color red'},{'title':'COLORS::AQUA','arg':{'fid':arg['fid'],color:'aqua','method':'cal_color'},css:'ico2 color aqua'},{'title':'COLORS::AQUAMARINE','arg':{'fid':arg['fid'],color:'aquamarine','method':'cal_color'},css:'ico2 color aquamarine'},{'title':'COLORS::ORCHID','arg':{'fid':arg['fid'],color:'orchid','method':'cal_color'},css:'ico2 color orchid'},{'title':'COLORS::PINK','arg':{'fid':arg['fid'],color:'pink','method':'cal_color'},css:'ico2 color pink'},{'title':'COLORS::SILVER','arg':{'fid':arg['fid'],color:'silver','method':'cal_color'},css:'ico2 color silver'},{'title':'COLORS::WHITE','arg':{'fid':arg['fid'],color:'white','method':'cal_color'},css:'ico2 color white'},{'title':'COLORS::GRAY','arg':{'fid':arg['fid'],color:'gray','method':'cal_color'},css:'ico2 color gray'},{'title':'COLORS::LEMON','arg':{'fid':arg['fid'],color:'lemon','method':'cal_color'},css:'ico2 color lemon'}],css:'ico2 color '+getCalendarColor(arg['fid'])},{'title':'-'});}
if(bVirtual)
aMenu.push({'title':'POPUP_FOLDERS::EDIT_VIRTUAL',css:'ico2 add_vfolder','arg':{'fid':arg['fid'],'method':'add_virtual'}});else{aMenu.push({'title':'POPUP_FOLDERS::ADD_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'add_folder'},css:'ico2 add_folder','disabled':!aRights.write});if(arg['aid']==sPrimaryAccount&&GWOthers.getItem('RESTRICTIONS','disable_virtual')!='1'&&sFolType!='X'){aMenu[aMenu.length-1].nodes=[{'title':'POPUP_FOLDERS::ADD_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'add_folder'},css:'ico2 add_folder'},{'title':'POPUP_FOLDERS::ADD_VIRTUAL','arg':{'fid':arg['fid'],'method':'add_virtual'},css:'ico2 add_vfolder'}];}}
if(sFolType==='F'){aMenu.push({'title':'ATTACHMENT::UPLOAD','arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':arg['ftype'],'method':'upload'},css:'ico2 upload','disabled':!aRights.write});}
var rename_title='POPUP_FOLDERS::RENAME_FOLDER';if(sFolType==='E'){rename_title='POPUP_FOLDERS::RENAME_CALENDAR';}
aMenu.push({'title':rename_title,'arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':arg['ftype'],'method':'rename_folder'},css:'ico2 edit_folder','disabled':bArchive||!aRights.modify||sFolType=='A'||sFolType=='X'});if(!bVirtual)
aMenu.push({'title':'POPUP_FOLDERS::MOVE_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'move_folder'},css:'ico2 move_folder','disabled':bArchive||!aRights.modify||sFolType=='A'||sFolType=='X'});if(GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0&&!bMoreMenu)
aMenu.push({'title':'POPUP_FOLDERS::ADD_FAVORITES','arg':{aid:arg['aid'],fid:arg['fid'],'method':'add_favorite'},css:'ico2 fav_folder'});var aOtherMenu={'title':'COMMON::MORE_OPTIONS',css:'ico2 more',nodes:[]};if(sFolType=='M'&&dataSet.get('folders',[arg['aid'],arg['fid'],'RSS']))
aMenu.push({'title':'POPUP_FOLDERS::CHANGE_CHANNEL','arg':{'aid':arg['aid'],'fid':arg['fid'],'ftype':arg['ftype'],'method':'change_channel'},css:'ico2 manage_rss','disabled':!aRights.modify});else
if(arg['aid']==sPrimaryAccount&&!bVirtual){if(arg['fid'].indexOf(sPrimaryAccountSPREFIX)<0)
if(sFolType=='M'){if(!bArchive&&arg['fid'].indexOf('/')<0&&arg['fid']!='INBOX'&&!dataSet.get('folders',[arg['aid'],arg['fid'],'SPAM'])&&!dataSet.get('folders',[arg['aid'],arg['fid'],'PUBLIC'])){aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::DEFAULT',css:'ico2 default_folder',nodes:[{'title':'COMMON_FOLDERS::DRAFTS','arg':{'aid':arg['aid'],'fid':arg['fid'],'default':'D','method':'default'},css:'draft_folder',disabled:GWOthers.getItem('DEFAULT_FOLDERS','drafts')==arg['aid']+'/'+arg['fid']},{'title':'COMMON_FOLDERS::SENT','arg':{'aid':arg['aid'],'fid':arg['fid'],'default':'S','method':'default'},css:'sent_folder',disabled:GWOthers.getItem('DEFAULT_FOLDERS','sent')==arg['aid']+'/'+arg['fid']},{'title':'COMMON_FOLDERS::TRASH','arg':{'aid':arg['aid'],'fid':arg['fid'],'default':'H','method':'default'},css:'trash_folder',disabled:GWOthers.getItem('DEFAULT_FOLDERS','trash')==arg['aid']+'/'+arg['fid']},{'title':'COMMON_FOLDERS::TEMPLATES','arg':{'aid':arg['aid'],'fid':arg['fid'],'default':'P','method':'default'},css:'template_folder',disabled:GWOthers.getItem('DEFAULT_FOLDERS','templates')==arg['aid']+'/'+arg['fid']}]});}}
else
if(sFolType!='A'&&sFolType!='X'){if(arg['fid'].indexOf('/')<0)
aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::DEFAULT',css:'ico2 default_folder','arg':{'aid':arg['aid'],'fid':arg['fid'],'default':sFolType,'method':'default'},disabled:GWOthers.getItem('DEFAULT_FOLDERS',{C:'CONTACTS',E:'EVENTS',T:'TASKS',N:'NOTES',J:'JOURNAL',F:'FILES'}[sFolType])==arg['aid']+'/'+arg['fid']});}}
if(sFolType!='A'&&sFolType!='X'){aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::EXPORT','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'save_folder'},css:'ico2 export_folder',disabled:arg['aid']!=sPrimaryAccount});if(sFolType!='M'&&dataSet.get('folders',[sPrimaryAccount,'__@@GWTRASH@@__']))
aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::RECOVERY','arg':{'aid':sPrimaryAccount,'fid':'__@@GWTRASH@@__','search':'folder:"'+Path.backslash(arg['fid']).replace(/\"/g,'\\\"')+'"','method':'view'},css:'ico2 rec_folder',disabled:arg['aid']!=sPrimaryAccount});}
if(sFolType=='M'&&arg['fid']!='INBOX'&&!bArchive){if(dataSet.get("folders",[arg['aid'],arg['fid'],'SYNC']))
aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::SUBSCRIBED','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'unsubscribe'},css:'ico2 check'});else
aOtherMenu.nodes.push({'title':'POPUP_FOLDERS::SUBSCRIBE','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'subscribe'},css:'ico2 sync_folder'});}
if(aOtherMenu.nodes.length)
aMenu.push(aOtherMenu);if(!bVirtual)
aMenu.push({'title':'POPUP_FOLDERS::SHARING','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'share'},css:'ico2 color1 share_folder',disabled:(sFolType=='M'&&sPrimaryAccountProtocol!='imap')||!aRights.owner||bArchive||!sPrimaryAccountSHARING});else
aMenu.push({'title':'-'});var bProtected=false;if(aRights.remove){var aSubFol=dataSet.get('folders',[arg['aid']]);for(var i in aSubFol)
if((arg['fid']==i||i.indexOf(arg['fid']+'/')==0)&&aSubFol[i].DEFAULT){bProtected=true;break;}}
else
bProtected=true;if(arg['aid']==sPrimaryAccount&&arg['fid'].indexOf(sPrimaryAccountSPREFIX)==0)
aMenu.push({'title':'POPUP_FOLDERS::UNSUBSCRIBE_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'unsubscribe_folder'},'css':'ico2 color2 delete_folder','disabled':dataSet.get('folders',[arg.aid,arg.fid,'SUBSCRIPTION_TYPE'])!='folder'});aMenu.push({'title':'POPUP_FOLDERS::DELETE_FOLDER','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'delete_folder'},'css':'ico2 color2 delete_folder','disabled':bProtected||sFolType=='X'});}
else{if(GWOthers.getItem('LAYOUT_SETTINGS','favorites')>0&&!bMoreMenu)
aMenu.push({'title':'POPUP_FOLDERS::ADD_FAVORITES','arg':{aid:arg['aid'],fid:arg['fid'],'method':'add_favorite'},css:'ico2 fav_folder'});if(sFolType=='Q')
aMenu=[{'title':'MAIN_MENU::EMPTY_FOLDER','css':'color2','arg':{'aid':arg['aid'],'fid':arg['fid'],'method':'empty_folder',css:'ico2 color2 empty_folder'}}];}}}
else
if(arg['aid']){if(!this._sFilterFolderType||!this._sFilterFolderType['Y']){aMenu.push({'title':'POPUP_FOLDERS::ADD_FOLDER','arg':{'aid':arg['aid'],'method':'add_folder'},css:'ico2 add_folder'});if(GWOthers.getItem('RESTRICTIONS','disable_virtual')!='1')
aMenu.push({'title':'POPUP_FOLDERS::ADD_VIRTUAL','arg':{'method':'add_virtual'},css:'ico2 add_vfolder','disabled':arg['aid']!=sPrimaryAccount});aMenu.push({'title':'-'},{'title':'POPUP_FOLDERS::ADD_SHARED_ACCOUNT','arg':{'aid':arg['aid'],'method':'add_account'},css:'ico2 share_account',disabled:arg['aid']!=sPrimaryAccount||!sPrimaryAccountSHARING},{'title':'POPUP_FOLDERS::SHARING','arg':{'aid':arg['aid'],'method':'share'},css:'ico2 color1 share_folder',disabled:arg['aid']!=sPrimaryAccount||!sPrimaryAccountSHARING},{'title':'-'});}
aMenu.push({'title':'COMMON::APPEARANCE',nodes:[{'title':'COMMON::EXPAND','arg':{method:'tree_mode',v:2},css:'ico2'+(Cookie.get(['hide_tree'])==2?' check':'')},{'title':'COMMON::COLLAPSED','arg':{method:'tree_mode',v:1},css:'ico2'+(Cookie.get(['hide_tree'])==1?' check':'')},{'title':'COMMON::AUTOCOLLAPSED','arg':{method:'tree_mode'},css:'ico2'+(Cookie.get(['hide_tree'])?'':' check')}]});}}
return aMenu;};_me._onclick=function(e,elm,id,arg){if(arg.fid&&arg.fid=='~')
delete arg.fid;if(e.type=='contextmenu'){var aMenu=obj_tree_folder_context.__createFolderMenu.call(this,arg),sFolType=WMFolders.getType(arg);if(aMenu.length){var cmenu=gui._create("cmenu","obj_context_folder",'','',this);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);if(sFolType==='Y'){var args={aid:arg['aid'],fid:arg['fid'].replace('/TeamChat','')};if(~(dataSet.get('folders',[args.aid,args.fid]).RIGHTS||'').indexOf('a')){WMFolders.list(args,'','',[function(data){if(cmenu&&!cmenu._destructed){data=data[args.aid][args.fid];args.owner_id=dataSet.get('folders',[args.aid,args.fid+'/TeamChat','OWNER']);cmenu._create('storage','obj_storage_usage','storage','',data.QUOTA,data.SIZE,args);}}]);}}}}
else
if(arg){if(arg['fid']=='__@@VIRTUAL@@__'||arg.ftype=='X')
this._open(id);else{arg=clone(arg);arg.elm=elm;return this._handleNode(arg);}}};_me._handleNode=function(arg,bUpdate)
{if(arg['aid']){var t=arg.ftype||dataSet.get("folders",[arg['aid'],arg['fid'],'TYPE']);if(arg['fid']&&(t=='A'||t=='VA'||t=='X'))
return false;if(!arg['fid']&&(t=='rss'||arg['aid'].indexOf('_rss')==arg['aid'].length-4))
return false;var aFolder=dataSet.get('active_folder');if(aFolder==sPrimaryAccount+'/__@@VIRTUAL@@__/__@@EVENTS@@__'&&t=='E'&&arg['fid']!='__@@VIRTUAL@@__/__@@EVENTS@@__'){var aVirtual=dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS'],true)||{},bUpdate=false;if(!Is.Defined(aVirtual[arg['fid']])){if(arg.elm&&arg.elm.tagName=='I')
aVirtual[arg['fid']]=false;else{for(var i in aVirtual)
aVirtual[i]=false;aVirtual[arg['fid']]=true;}
bUpdate=true;}
else
if(arg.elm&&arg.elm.tagName=='I'){if(count(aVirtual)>1){if(aVirtual[arg['fid']]==true){delete aVirtual[arg['fid']];for(var sLast in aVirtual);if(sLast)
aVirtual[sLast]=true;}
else
delete aVirtual[arg['fid']];bUpdate=true;}}
else
if(!aVirtual[arg['fid']]){for(var i in aVirtual)
aVirtual[i]=false;aVirtual[arg['fid']]=true;bUpdate=true;}
this._setActive(sPrimaryAccount+'/__@@VIRTUAL@@__/__@@EVENTS@@__');this._fill();if(bUpdate)
WMFolders.add({'aid':sPrimaryAccount,'fid':'__@@VIRTUAL@@__/__@@EVENTS@@__','name':'__@@VIRTUAL@@__/__@@EVENTS@@__','type':'E','virtual':{folders:aVirtual}},'folders','',[this,'__refresh',[arg]]);else
gui.__exeEvent('folderSelected',arg);return false;}
else{if(aFolder!=arg['aid']+'/'+(arg['fid']||'~')||bUpdate)
gui.frm_main._selectView(arg);else
gui.__exeEvent('folderSelected',arg);}
return true;}};_me.__refresh=function(aData){if(aData&&aData.virtual){dataSet.add('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__','VIRTUAL','FOLDERS'],aData.virtual.folders);}
gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@EVENTS@@__'},'',true);};

/* client/inc/obj_tree_folder_drag.js */
_me=obj_tree_folder_drag.prototype;function obj_tree_folder_drag(){};_me.__constructor=function()
{this._main.onmousedown=function(e){if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
if(this.rename)return;var e=e||window.event;if(e.button>1||e.ctrlKey||!this.__initdrag)return;var elm=e.target||e.srcElement;if(elm==this._main)return;if(elm.tagName!='LI')
elm=Is.Child(elm,'LI');if(!elm||!elm.id)return;var id=Path.split(this._getRealId(this._parseElmId(elm.id)),true);if(!id.fid.length)return true;var sType=WMFolders.getType(id),sDragType='folder';if(!sType||sType=='A'||sType=='X')
return true;else
if(id.aid==sPrimaryAccount&&id.fid.indexOf('__@@VIRTUAL@@__/')==0)
sDragType='virtual_folder';var x=e.clientX,y=e.clientY;gui._obeyEvent('mouseup',[this,'__dndDispatch']);this.__dndtimer=setTimeout(function(){this.__initdrag([id],sType,x,y,sDragType);}.bind(this),500);if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;}.bind(this);this.___lastdragover='';if(gui.frm_main&&gui.frm_main.dnd){gui.frm_main.dnd.registr_drop(this,['item','folder']);}};_me.__dndDispatch=function(){if(this.__dndtimer){window.clearTimeout(this.__dndtimer);delete this.__dndtimer;}
return false;};_me.__initdrag=function(id,sType,x,y,sDragType){if(!sDragType||this.rename)
return false;var path=id[0],ds=dataSet.get('folders',[path.aid,path.fid]);if(!ds)
return false;var sBody=mkElement('div',{className:'drag_folder drag_folder_'+sType,text:(ds.NAME||Path.basename(path.fid))}).outerHTML;gui.frm_main.dnd.create_drag(sBody,{type:sDragType||'folder',value:id},x,y);};_me._active_dropzone=function(v){this.__aDragFolders=[];var me=this;if(v){var tmp=arrUnique([].concat(this._value(),this.__filter&&this.__filterOpen?this.__filterOpen:[])),val={};for(var i=0,j=tmp.length;i<j;i++)
val[tmp[i]]=1;switch(v['type']){case'item':var sType=WMFolders.getType(v.value[0]);var getTargets=function(data,out){out=out||[];if(typeof data!='object')return out;var i,sPath,bActive;for(i in data){if(data.hasOwnProperty(i)){if(data[i].arg.aid){bActive=false;sPath=data[i].arg.aid+(data[i].arg.fid?'/'+data[i].arg.fid:''),treeId=me._getTreeId(sPath);if(data[i].arg.fid&&!data[i].arg.disabled&&(data[i].arg.aid!=v.value[0].aid||data[i].arg.fid!=v.value[0].fid)){if((sType=='M'||sType=='P')&&data[i].arg.ftype=='QL')
bActive=true;else
if((sType=='M'||sType=='P'||data[i].arg.ftype!='M')&&WMFolders.getAccess(data[i].arg,'write'))
bActive=true;}
out.push([treeId,bActive]);}
if(data[i].nodes&&val[sPath])
getTargets(data[i].nodes,out);}}
return out;};this.__aDragFolders=getTargets((this.__aFillData[v.value[0].aid]||(this.__aFillData.other||{}).nodes[v.value[0].aid]).nodes);break;case'folder':var sType=WMFolders.getType(v.value[0]);if(!this.__aFillData[v.value[0].aid]||!this.__aFillData[v.value[0].aid].nodes||!WMFolders.getRights(v.value[0],'remove')||sType=='QL'||sType=='I'||sType=='Y')
break;var getTargets=function(data,out){out=out||[];if(typeof data!='object')return out;var i,sPath,bActive;for(i in data){if(data.hasOwnProperty(i)&&data[i].arg.ftype!='QL'&&data[i].arg.aid==v.value[0].aid){if(data[i].arg.aid&&data[i].arg.fid!=v.value[0].fid){sPath=data[i].arg.aid+(data[i].arg.fid?'/'+data[i].arg.fid:'');bActive=false;if(!data[i].arg.fid||(!data[i].arg['disabled']&&WMFolders.getAccess(data[i].arg,'write')))
bActive=true;var treeId=me._getTreeId(sPath);out.push([treeId,bActive]);}
if(data[i].nodes&&val[sPath])
getTargets(data[i].nodes,out);}}
return out;};this.__aDragFolders=getTargets((this.__aFillData[v.value[0].aid]||(this.__aFillData.other||{}).nodes[v.value[0].aid]).nodes);break;default:return;}}
if(this.__aDragFolders.length){addcss(this._main,'active_drop');this.__objPos=getSize(this.__eBody);}
else{removecss(this._main,'active_drop');this._ondragout();}};_me._ondragover=function(v){var me=this;if(!this.__dragON){this.__dragON=true;gui._obeyEvent('mousewheel',[this,'__mousewheel']);this.__dragscrollloop=window.setInterval(function(){if(me.__objPos){var delta;if(((delta=gui.__Y-me.__objPos.y)<51&&(delta-=50))||((delta=gui.__Y-me.__objPos.y-me.__objPos.h)>-51&&(delta+=50)))
me.__eBody.scrollTop+=Math.floor(delta/4);}},100);}
var a,size,elm,bOK=false,bFound=false;if(this.__aDragFolders){for(var i=0,j=this.__aDragFolders.length;i<j;i++){if(!(elm=document.getElementById(this._getElmId(this.__aDragFolders[i][0]))))
continue;size=getSize(elm);if(v.y>=size.y&&v.y<=size.y+elm.firstChild.offsetHeight){bOK=this.__aDragFolders[i][1];if((a=elm.firstChild.getElementsByTagName('B')[0])){bFound=true;if(!this.___lastdragover||this.___lastdragover[1]!=this.__aDragFolders[i][0]){if(this.___lastdragover)
removecss(this.___lastdragover[0],'dragover');addcss(a,'dragover');this.___lastdragover=[a,this.__aDragFolders[i][0]];if(this.__dragopentimer)
if(this.__dragopentimer[1]!=this.__aDragFolders[i][0]){window.clearTimeout(this.__dragopentimer[0]);this.__dragopentimer='';}
else
break;if(hascss(elm,'plus')){this.__dragopentimer=[window.setTimeout(function(){if(me.__dragopentimer){me.__open(me.__dragopentimer[1]);me._active_dropzone(v);}},800),me.__aDragFolders[i][0]];}}}
break;}}
if(!bFound&&this.___lastdragover){removecss(this.___lastdragover[0],'dragover');this.___lastdragover='';}}
a=null;elm=null;return bOK;};_me._ondragout=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;if(this.__dragscrollloop){window.clearInterval(this.__dragscrollloop);this.__dragscrollloop='';}
if(this.__dragopentimer){window.clearTimeout(this.__dragopentimer[0]);this.__dragopentimer='';}
if(this.___lastdragover){removecss(this.___lastdragover[0],'dragover');this.___lastdragover='';}};_me._ondrop=function(v){gui._disobeyEvent('mousewheel',[this,'__mousewheel']);this.__dragON=false;var size,elm,id='';for(var i=0,j=this.__aDragFolders.length;i<j;i++){if(!this.__aDragFolders[i][1]||!(elm=document.getElementById(this._getElmId(this.__aDragFolders[i][0]))))
continue;size=getSize(elm);if(v.y>=size.y&&v.y<=size.y+elm.firstChild.offsetHeight){id=this.__aDragFolders[i][0];break;}}
if(!id)return false;var realId=this._getRealId(id);if(!realId)return false;var path=Path.split(realId,true);gui.frm_main.dnd.remove_drag(true);switch(v.type){case'folder':var bIsDefault=dataSet.get('folders',[v.value[0].aid,v.value[0].fid,'DEFAULT']);gui._create('move','frm_confirm','','',[function(){storage.library('obj_context_folder');obj_context_folder.__moveFolder(v.value[0].aid,v.value[0].fid,(path.fid?path.fid+'/':'')+Path.basename(v.value[0].fid));}],'POPUP_FOLDERS::MOVE_FOLDER',bIsDefault?'POPUP_FOLDERS::MOVE_DEFAULT':'POPUP_FOLDERS::MOVE_FOLDER_CONFIRMATION');break;case'item':if(path.fid)
Item.__convertToFolder(path.aid,path.fid,v);}};_me.__mousewheel=function(e){this.__eBody.scrollTop+=e.delta*20;};_me.__dragscroll=function(){if(this.__objPos){var delta;if(((delta=gui.__Y-this.__objPos.y)<51&&(delta-=50))||((delta=gui.__Y-this.__objPos.y-this.__objPos.h)>-51&&(delta+=50)))
this.__eBody.scrollTop+=Math.floor(delta/10);}};

/* client/inc/obj_tree_list.js */
_me=obj_tree_list.prototype;function obj_tree_list(){};_me.__constructor=function(){this._recent=[];this._search_query=false;this._rowHeight=48;this._search_query='';this._norefresh=false;this.__eBody=this._getAnchor('body');this._create('scrollbar','obj_scrollbar');this.scrollbar._scrollbar(this.__eBody,this.__eBody.parentElement);this.__eBody.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,room='';if(elm===this.__eBody)return;while(!(room=elm.getAttribute('data-room'))){elm=elm.parentElement;if(elm==this.__eBody)
break;}
if(room){this.__clickOnRow(e,room);}}.bind(this);this.__eBody.oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement,room='';if(elm===this.__eBody)return;while(!(room=elm.getAttribute('data-room'))){elm=elm.parentElement;if(elm==this.__eBody)
break;}
if(room){this.__contextMenuForRow(e,room);}}.bind(this);this.inp_search._onkeyup=function(e){var v=this.inp_search._value();if(e.keyCode==27){if(v==='')
this._focus();else{this.inp_search._value('');}
v=false;}
window[v.length?'addcss':'removecss'](this._main,'search');this.__search(v);}.bind(this);this.inp_search._onblur=function(){if(!this.inp_search._value())removecss(this._main,'search');}.bind(this);var hasFocus=false;this._main.setAttribute('tabindex',-1);if(~currentBrowser().indexOf('MSIE')){AttachEvent(this._main,'onclick',function(){hasFocus=true;});}
else{AttachEvent(this._main,'onfocus',function(){hasFocus=true;});}
AttachEvent(this._main,'onblur',function(){hasFocus=false;});AttachEvent(this._main,'onkeydown',function(e){if(hasFocus&&!e.isComposing&&e.keyCode!==229&&(e.key||'').length===1)
this.inp_search._focus();}.bind(this));dataSet.on('active_folder',null,this.__setActiveRow,this).on('cookies',['recent'],this._prepareData,this);this._add_destructor('__removeListeners');this._listen('folders');};_me.__clickOnRow=function(e,room){if(hascss(e.target||e.srcElement,'close')){this.__removeRecent(room);}
else{var roomPath=Path.split(room);gui.frm_main._selectView({aid:roomPath[0],fid:roomPath[1]});}};_me.__contextMenuForRow=function(e,room){e.preventDefault();var cmenu=gui._create("cmenu","obj_context_folder",'','',this),room=Path.split(room)[1],rights=WMFolders.getRights({aid:sPrimaryAccount,fid:room});cmenu._fill([{'title':'FORM_BUTTONS::RENAME',css:'ico2 edit_folder','arg':{aid:sPrimaryAccount,fid:room,ftype:'I',method:'rename_folder'},disabled:!rights.edit_folder},{'title':'FORM_BUTTONS::UNSUBSCRIBE',css:'ico2 archive_folder','arg':{aid:sPrimaryAccount,fid:room,ftype:'I',method:'unsubscribe',callback:function(folder_info){gui.frm_main.bar.top.switch.__unsubscribeRoom(elm,{aid:sPrimaryAccount,fid:room},folder_info,[this,'__update']);}.bind(this)}},rights.owner?{'title':'POPUP_FOLDERS::MEMBERS',css:'ico2 color1 members','arg':{aid:sPrimaryAccount,fid:room,method:'share'}}:false,{'title':'POPUP_ITEMS::DELETE',css:'ico2 color2 delete_folder','arg':{aid:sPrimaryAccount,fid:room,method:'delete_folder'},disabled:!rights.remove}].filter(Boolean));cmenu._place(e.clientX,e.clientY);};_me.__removeListeners=function(){dataSet.off('active_folder',null,this.__setActiveRow).off('cookies',['recent'],this._prepareData);};_me._teamChatOnline=function(){var folders=dataSet.get('folders',[sPrimaryAccount]);for(var i in folders){if(~['I','Y'].indexOf(folders[i].TYPE)){return true;}}
return false;};_me._prepareData=function(){if(this._norefresh)return;var aData=[],ds=dataSet.get('folders',[sPrimaryAccount]),recent=Cookie.get(['recent'])||[],active=dataSet.get('active_folder');var new_recent=recent.filter(function(room){var path=Path.split(room),parts=path[1].split('/'),folder=ds[path[1]];if(folder&&folder.TYPE=="I"&&folder.SYNC=='1'){aData.push({room:room,name:folder.NAME||parts.pop(),group:parts.shift(),recent:folder.RECENT||0,active:active===room});return true;}});if(recent.length!==new_recent.length&&this._teamChatOnline()){Cookie.set(['recent'],new_recent);return;}
this._recent=new_recent;this._aData=aData;this._fill();};_me._getFocusElement=function(){return this._main;};_me._focus=function(){return this._main.focus();};_me._fill=function(aData){aData=aData||this._aData||[];var rows={},data_rows=aData.map(function(room){return room.room});[].forEach.call(this.__eBody.querySelectorAll('div[data-room]'),function(elm){var room=elm.getAttribute('data-room');if(!~data_rows.indexOf(room)){elm.removeAttribute('data-room');addcss(elm,'shrink');setTimeout(function(){elm&&elm.parentNode&&elm.parentNode.removeChild(elm);},300);}
else
rows[room]=elm;});window[aData.length?'removecss':'addcss'](this._main,'empty');var qs=(this._search_query||'').toLowerCase();(qs.length?aData.filter(function(room){if(!~room.name.toLowerCase().indexOf(qs)){if(rows[room.room]){rows[room.room].style.display='none';}
return false;}
return true;}):aData).forEach(function(room,i){var row;if(rows[room.room]){row=rows[room.room];row.innerHTML='';row.style.display='block';}
else{row=mkElement('div',{'class':'recent-row','data-room':room.room,'id':this._pathName+'/'+room.room});this.__eBody.appendChild(row);}
this.__createRowBody(row,room);row.style.transform='translateY('+(i*this._rowHeight)+'px)';row.style.transform.zIndex=10+i;}.bind(this));};_me._rename=function(arg){if(this.rename)this.rename._onclose();this._norefresh=true;var sLiId=this._pathName+'/'+arg.aid+(arg.fid?'/'+arg.fid:''),hDiv=document.getElementById(sLiId).getElementsByTagName('DIV')[0];addcss(hDiv,'edit');var sAnchor=sLiId+'#editDiv';this._anchors['editDiv']=sAnchor;hDiv.id=sAnchor;var nPos=arg.fid.lastIndexOf('/'),sParentName=arg.fid.substring(0,nPos),sFolderName=dataSet.get("folders",[arg['aid'],arg['fid'],'NAME'])||arg.fid.substring(nPos+1);var rename=this._create('rename','obj_input','editDiv');rename._restrict('![/\\\\:\?\"\<\>\|\~]+','','^.{1,255}$');rename.__eIN.onclick=function(e){var e=e||window.event;if(e.preventDefault)e.preventDefault();if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;return false;};rename._value(sFolderName);rename._setRange(0,sFolderName.length);rename._onsubmit=function(e){if(this._checkError&&this._checkError.length)return;var snew=(this._value()||'').trim();var sold=sFolderName;if(sold==snew){this._onclose();return;}
var sNewFolderID=(sParentName?sParentName+'/':'')+snew;obj_context_folder.__moveFolder(arg.aid,arg.fid,sNewFolderID);this._onclose();};rename._onclose=function(e){if(this.rename._destructed)return false;this.rename._destruct();removecss(hDiv,'edit');this._norefresh=false;if(!e||this._updateBuffer)
this.__update(this._listener_data);}.bind(this);rename._onblur=rename._onclose;delete this._anchors['editDiv'];};_me.__createRowBody=function(row,room){row.appendChild(mkElement('div',{class:"body"},null,[mkElement('div',{class:"room-name",text:room.name}),mkElement('div',{class:"group-name",text:room.group})]));var control=mkElement('div',{class:"control"},null,mkElement('div',{class:"close"}));if(+room.recent>0){control.appendChild(mkElement('div',{class:"bubble",text:room.recent}));addcss(row,'unread');}
else
removecss(row,'unread');row.appendChild(control);window[room.active?'addcss':'removecss'](row,'active');};_me.__removeRecent=function(room){var recent=Cookie.get(['recent'])||[];if(recent.length&&this._teamChatOnline()){Cookie.set(['recent'],recent.filter(function(v){return v!==room;}));}};_me.__setActiveRow=function(room){[].forEach.call(this.__eBody.querySelectorAll('[data-room]'),function(row){removecss(row,'active');});var row=this.__eBody.querySelector('[data-room="'+room+'"]');if(row){this._aData.map(function(v){v.active=v.room===room;return v;});addcss(row,'active');}};_me.__search=function(query){query=query||false;if(this._search_query!==query){this._search_query=query||false;this._fill();}};_me.__update=function(){if(this._teamChatOnline()){if(this.__applyFoldersUnreadSnapshot())
this.__saveFoldersUnreadSnapshot();else
this._prepareData();}};_me.__saveFoldersUnreadSnapshot=function(){var ds=dataSet.get('folders',[sPrimaryAccount]),oSnapshot={};for(var sFolder in ds){if(ds.hasOwnProperty(sFolder)&&'I'===ds[sFolder]['TYPE']){oSnapshot[sFolder]={'recent':parseInt(ds[sFolder]['RECENT'])};}}
Cookie.set(['recent_folders_snapshot'],oSnapshot);};_me.__applyFoldersUnreadSnapshot=function(){var ds=dataSet.get('folders',[sPrimaryAccount]),oSnapshot=Cookie.get(['recent_folders_snapshot']),aRecent=Cookie.get(['recent'])||[],aFoldersWithNewPosts=[],bUpdate=false;for(var sFolder in ds){if(ds.hasOwnProperty(sFolder)&&'I'===ds[sFolder]['TYPE']){if((!Is.Object(oSnapshot)&&parseInt(ds[sFolder]['RECENT'])>0)||(Is.Object(oSnapshot)&&(!oSnapshot.hasOwnProperty(sFolder)||parseInt(ds[sFolder]['RECENT'])>oSnapshot[sFolder]['recent']))){aFoldersWithNewPosts.push(sPrimaryAccount+'/'+sFolder);}}}
aFoldersWithNewPosts.forEach(function(path){if(!~aRecent.indexOf(path)){aRecent.unshift(path);bUpdate=true;}});bUpdate&&Cookie.set(['recent'],aRecent);return bUpdate;};

/* client/inc/obj_troubleshooting.js */
function obj_troubleshooting(){};obj_troubleshooting.prototype.__constructor=function(){this._render();};obj_troubleshooting.prototype._render=function(){var ts=Cookie.get(['troubleshooting']);if(ts&&ts.timestamp&&(ts.timestamp*1000<+new Date())){auth.deleteTroubleshooting(ts.session);ts=false;}
this._clean();this._draw('obj_troubleshooting','',ts&&{link:location.origin+location.pathname+'?sid='+ts.session,validity:new IcewarpDate(new Date(ts.timestamp*1000)).format('D/M/Y HH:mm:ss')});(this.generate||{})._onclick=function(){auth.troubleshootingSession(this.validity._value(),[this,'_render']);}.bind(this);(this.remove||{})._onclick=function(){auth.deleteTroubleshooting(ts.session,[this,'_render']);}.bind(this);};

/* client/inc/obj_upload.js */
_me=obj_upload.prototype;function obj_upload(){};_me.__constructor=function(sButtonValue,noFlash){var me=this;this.__idtable=[];if(window.FormData){this._create('file','obj_attach_multiple','main',sButtonValue?'':'img',sButtonValue);this.__info=this.file._getAnchor('info');}
else{this._create('file','obj_attach_old','main',sButtonValue?'':'img',sButtonValue);}
this.file._onuploadstart=function(){me.__idtable=[];me._info_show();if(me._onuploadstart)
me._onuploadstart();};this.file._onuploadprogress=function(file,a,b,xhr){me._info_progress(file,Math.min(100,a/(b/100)));if(me._onuploadprogress)
me._onuploadprogress(file,a,b,xhr);};this.file._onuploadaborted=function(){if(me._onuploadaborted)
me._onuploadaborted();};this.file._onuploadsuccess=function(file){me.__idtable.push(file);if(me._onuploadsuccess)
me._onuploadsuccess(file);};this.file._onuploadend=function(){me._info_hide();if(me._onuploadend)
me._onuploadend(me.__idtable);};this._add_destructor('__destructor');};_me._setPostParam=function(sName,sVal){if(this.file._setPostParam)
this.file._setPostParam(sName,sVal);};_me._getFolder=function(){return this.file._getFolder();};_me._setFolder=function(sFolder){this.file._setFolder(sFolder);};_me._setFileQueueLimit=function(i){if(this.file._setFileQueueLimit)
this.file._setFileQueueLimit(i);};_me._setMultipleSelection=function(b){if(this.file._setMultipleSelection)
this.file._setMultipleSelection(b);};_me._setFileTypes=function(sTypes,sDescription){if(this.file._setFileTypes)
this.file._setFileTypes(sTypes,sDescription);};_me._info_show=function(){if(this.__info)
this.__info.style.display='block';};_me._info_progress=function(file,i){if(this.__info){this.__info.style.backgroundPosition=((this.__info.clientWidth/100)*i-300)+'px';document.title=getLang('UPLOAD::TITLE',[file.name,Math.ceil(parseInt(i,10))]);}};_me._info_hide=function(){if(this.__info){this.__info.style.display='none';gui.frm_main.title._reset();}};_me.__destructor=function(){if(this.__info)
gui.frm_main.title._reset();};_me._disabled=function(b){if(this.file._disabled)
return this.file._disabled(b);};_me._value=function(){return{path:this._getFolder(),values:this.__idtable};};_me._click=function(){if(!this.file.__eIN||(this.file._disabled&&this._disabled()))
return;this.file.__eIN.click();};_me._reset=function(bFolder){this.__idtable=[];if(bFolder)
this._setFolder='';};_me.__ondropfile=function(aFiles,aHandler){if(window.FormData&&this.file.__ondropfile)
this.file.__ondropfile(aFiles,aHandler);};

/* client/inc/obj_upload_edit.js */
_me=obj_upload_edit.prototype;function obj_upload_edit(){};_me.__constructor=function(sAttLabel,sDropLabel){this.__hasRename=true;this.__hasRemove=true;this.__hasRemoveAll=true;var me=this;this._create('list','obj_upload_list','list','',this.file.__dropzones.length>0,sAttLabel,sDropLabel);this.__idtable=this.list.__idtable;this.list.__hasRename=this.__hasRename;this.list.__hasRemove=this.__hasRemove;this.list.__hasRemoveAll=this.__hasRemoveAll;this.list._onchange=function(){if(me._onchange)
me._onchange();};this.file._onuploadsuccess=function(file){me._add(file);};this.file._onuploadstart=function(){if(me._onuploadstart)
me._onuploadstart();};this.file._onuploadend=function(){if(me._onuploadend)
me._onuploadend();};this.file._onuploadprogress=function(){if(me._onuploadprogress)
me._onuploadprogress.apply(me,arguments);};};_me._remove=function(id){this.list._remove(id);};_me._rename=function(id){this.list._rename(id);};_me._add=function(aArg){if(this._destructed)
return;aArg.folder=this.file._getFolder();if(this.list._add(aArg)&&this._onuploadsuccess)
this._onuploadsuccess(aArg);};_me._value=function(v){if(typeof v=='undefined')
return this.list._value();else{if(v.path)
this.file._setFolder(v.path);if(v.values)
this.list._value(v);}};_me._dropzone=function(elm,body,css,callback){this.file._dropzone(elm,body,css,callback);if(this.file.__dropzones.length>0){this.list.__dropSupport=true;var list=this.list._getAnchor('list');if(list.getElementsByTagName('SPAN').length<1)
this.list._getAnchor('list').innerHTML='<i>'+this.list.__labels[1]+'</i>';}};_me._disabled=function(b){if(Is.Defined(b)){this.__disabled=b?true:false;this.file._disabled(this.__disabled);}
else
return this.__disabled;};_me._getName=function(id){return this.list._getName(id);};_me._getSize=function(id){return this.list._getSize(id);};

/* client/inc/obj_upload_edit_cert.js */
_me=obj_upload_edit_cert.prototype;function obj_upload_edit_cert(){};_me.__constructor=function(bPublic){var me=this;this.__idtable=[];this.__public=bPublic;this.attachments.__sortColumn='expires';if(this.__public)
this.attachments._addColumns({name:{title:"DATAGRID_ITEMS_VIEW::SNDOWNER",width:100,mode:'%',arg:{sort:'asc'}},serial:{title:"CERTIFICATE::SERIAL",width:200,arg:{sort:'asc'}},expires:{title:"DATAGRID_ITEMS_VIEW::EXPIRES",width:100,arg:{sort:'asc'}}});else
this.attachments._addColumns({name:{title:"DATAGRID_ITEMS_VIEW::SNDOWNER",width:100,mode:'%',arg:{sort:'asc'}},email:{title:"DATAGRID_ITEMS_VIEW::CONTACT_EMAIL",width:200,arg:{sort:'asc'}},expires:{title:"DATAGRID_ITEMS_VIEW::EXPIRES",width:100,arg:{sort:'asc'}}});this.attachments._ondblclick=function(e,elm,arg,sLineId){if(typeof sLineId!='undefined')me.__viewItem([sLineId]);};this.attachments._oncontext=function(e,elm,arg,sLineId,sColumn){if(typeof sLineId=='undefined')return;gui._create("cmenu","obj_context",'','',me);var aMenu=[{"title":'ATTACHMENT::SAVE','arg':[me,'_save',[sLineId]],disabled:arg['class']=='item'},{"title":'ATTACHMENT::VIEW','arg':[me,'__viewItem',[[sLineId]]],disabled:arg['class']=='item'},{"title":'ATTACHMENT::REMOVE','arg':[me,'__deleteItems',[[sLineId]]],'disabled':me.__disabled}];gui.cmenu._fill(aMenu);gui.cmenu._place(e.clientX,e.clientY);};this.view._onclick=function(){var v=me.attachments._value();if(v.length)
me.__viewItem(v);};this.remove._onclick=function(){me.__deleteItems(me.attachments._value());};this.file._onuploadsuccess=function(file){me._add(file);};};_me.__viewItem=function(aIDs){for(var i in aIDs)
if(this.__idtable[aIDs[i]].data)
gui._create('certificate','frm_certificate','','',this.__idtable[aIDs[i]].data,this);};_me._value=function(v){if(typeof v=='undefined'){var out=[];for(var i in this.__idtable)
if(this.__idtable[i]['class']=='attachment'&&!this.__idtable[i]['fullpath']){if(this.__idtable[i]['removed'])
out.push({uid:this.__idtable[i].id});}
else
if(!this.__idtable[i]['removed'])
out.push({'class':this.__idtable[i]['class']||'file','fullpath':this.__idtable[i]['fullpath']||((this.__idtable[i]['folder']||this.file._getFolder())+"/"+this.__idtable[i]['id']),'passphrase':this.__idtable[i]['passphrase']});return out;}
else{if(v.path)
this._gwPath=v.path;if(v.values)
for(var i in v.values)
this.__idtable.push(v.values[i]);this.__fillDataGrid();}};_me._add=function(aArg){if(!aArg.fullpath)
aArg.folder=this.file._getFolder();aArg['class']=aArg['class']||'file';if(/\.(p12|pfx)$/gi.test(aArg.name)||/\.(p12|pfx)$/gi.test(aArg.name))
gui._create('passphrase','frm_password','','',[this,'__infoQuery',[aArg]],'CERTIFICATE::PASSPHRASE');else
this.__infoQuery('',aArg);};_me.__infoQuery=function(sPass,aArg){if(sPass)
aArg.passphrase=sPass;storage.library('wm_upload');var oUP=new wm_upload();oUP.certificate(this.file._getFolder(),aArg.id,sPass,[this,'__infoResponse',[aArg]]);};_me.__infoResponse=function(aData,aArg){if(!aData)
gui.notifier._value({type:'alert',args:{header:'',text:'CERTIFICATE::INVALID'}});else{if(!this.__public&&aData.TYPE[0].VALUE=='public')
gui.notifier._value({type:'alert',args:{header:'',text:'CERTIFICATE::BADTYPE'}});else{aArg.data=aData.INFO[0];if(aData.INFO[0].SUBJECT){if(aData.INFO[0].SUBJECT[0].CN)
aArg.name=aData.INFO[0].SUBJECT[0].CN[0].VALUE;if(aData.INFO[0].SUBJECT[0].EMAILADDRESS)
aArg.email=aData.INFO[0].SUBJECT[0].EMAILADDRESS[0].VALUE;}
if(aData.INFO[0].SERIALNUMBER)
aArg.serial=aData.INFO[0].SERIALNUMBER[0].VALUE;if(aData.INFO[0].VALIDTO)
aArg.expires=aData.INFO[0].VALIDTO[0].VALUE;this.__idtable.push(aArg);this.__fillDataGrid();return;}}};_me._remove=function(id){if(typeof id=='undefined'){for(var i in this.__idtable)
this._remove(i);}
else
if(this.__idtable[id]&&!this.__idtable[id].removed){this.__idtable[id].removed=true;this.__fillDataGrid();}};_me.__fillDataGrid=function(){var aData={};for(var i in this.__idtable)
if(!this.__idtable[i]['removed']){if(this.__public)
aData[i]={id:i,data:{name:this.__idtable[i].name,serial:this.__idtable[i].serial}};else
aData[i]={id:i,data:{name:this.__idtable[i].name,email:this.__idtable[i].email}};aData[i].arg={path:this.__idtable[i].fullpath,'class':this.__idtable[i]['class']};if(this.__idtable[i].expires){aData[i].data.expires=[IcewarpDate.utct(this.__idtable[i].expires).format('L'),this.__idtable[i].expires];}}
this.attachments._serverSort(aData);};_me.__deleteItems=function(aIDs){for(var i in aIDs)
this._remove(aIDs[i]);};_me._save=function(id){var aUrl={'sid':dataSet.get('main',['sid'])};if(this.__idtable[id]['class']=='attachment'){if(this.__public){aUrl['class']='contact_certificate';aUrl.fullpath=WMItems.__serverID(this._gwPath)+'/'+this.__idtable[id].id;}
else{aUrl['class']='personal_certificate';aUrl.fullpath=this.__idtable[id].id;}}
else
if(this.__idtable[id]['class']!='item'){aUrl['class']='uploaded_certificate';aUrl.fullpath=this.file._getFolder()+'/'+this.__idtable[id].id;}
downloadItem(buildURL(aUrl));};_me._disabled=function(b){if(Is.Defined(b)){this.__disabled=b?true:false;this.remove._disabled(this.__disabled);this.file._disabled(this.__disabled);}
else
return this.__disabled;};

/* client/inc/obj_upload_edit_select.js */
_me=obj_upload_edit_select.prototype;function obj_upload_edit_select(){};_me.__constructor=function(){var me=this;this.__atts={};this.__idtable=[];this.__itempath='';this.attachments.__sortColumn='name';this.attachments._addColumns({ico:{width:20,css:'file_type',type:'static'},name:{title:"DATAGRID_ITEMS_VIEW::EVNFILENAME",width:100,mode:'%',encode:true,arg:{sort:'asc'}},size:{title:"DATAGRID_ITEMS_VIEW::EVNFILESIZE",width:100,css:'size',arg:{sort:'asc'}}});if(GWOthers.getItem('RESTRICTIONS','disable_dropbox')>0)
this.dropbox._destruct();else
this.dropbox._onclick=function(){if(!(GWOthers.getItem('EXTERNAL_SETTINGS','dropbox_app_key')||'').length)
gui.notifier._value({type:'alert',args:{header:'DROPBOX::ERRORALERT',text:'DROPBOX::MISSINGKEY'}});else if(typeof Dropbox=="undefined")
gui.notifier._value({type:'alert',args:{header:'DROPBOX::ERRORALERT',text:'DROPBOX::UNAVAILABLE'}});else
Dropbox.choose({linkType:'preview',success:function(files){var aItems=[];for(var i in files)
aItems.push({type:'url',title:files[i].name,fullpath:files[i].link,size:files[i].bytes});me.__addItems(aItems);}});};this.attachments._ondblclick=function(e,elm,arg,id){if(arg&&Is.Defined(arg.id)){me._save(arg.id,'auto');}};this.attachments._oncontext=function(e,elm,arg,sLineId,sColumn){if(typeof sLineId=='undefined')return;gui._create("cmenu","obj_context",'','',me);var aMenu=[],idtbl=me.__idtable[arg.id];var x=new RegExp(/\.eml$/ig);if(idtbl){if(idtbl['class']=='itemlink'||(idtbl['class']=='attachment'&&(x.test(idtbl.name)||(sPrimaryAccountWebDAV&&Item.officeSupport(idtbl.name))))){var bIWD=dataSet.get('accounts',[sPrimaryAccount,'OFFICE_SUPPORT'])=='true';aMenu.push({title:'POPUP_ITEMS::OPEN',arg:[me,'_save',[sLineId,'force']],'nodes':[{"title":'DOCUMENT::OPENDOCUMENT','arg':[me,'_save',[sLineId,'edit']],disabled:!bIWD},{"title":'DOCUMENT::OPENDOCUMENTVIEW','arg':[me,'_save',[sLineId,'view']],disabled:!bIWD},{"title":'OFFICELAUNCHER::OFFICESUITE','arg':[me,'_save',[sLineId,'external']]}]});}
else
if(Path.extension(idtbl.name)=='pdf'){aMenu.push({title:'POPUP_ITEMS::OPEN',arg:[me,'_save',[sLineId,'force']]});}
if(idtbl['class']!='itemlink'){aMenu.push({"title":'ATTACHMENT::DOWNLOAD','arg':[me,'_save',[sLineId]]},{"title":'ATTACHMENT::DOWNLOAD_ALL','arg':[me,'_save',[]],disabled:me.__disable_save_all});}}
aMenu.push({"title":'ATTACHMENT::REMOVE','arg':[me,'_remove',[sLineId]],disabled:me.__disabled});gui.cmenu._fill(aMenu);gui.cmenu._place(e.clientX,e.clientY);};this.add_item._onclick=function(){if('1'===GWOthers.getItem('RESTRICTIONS','disable_attach_item')){(me.upload||me.file)._click();return;}
var sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[sPrimaryAccount,sFolder]))
sFolder='';gui._create('insert_item','frm_insert_item','','',[me,'__addItems'],sPrimaryAccount,sFolder,void 0,void 0,void 0,['M','C','F','E','J','N','T','X']);};this.remove._onclick=function(){var out=[],vd=me.attachments.__valueData;for(var i in vd)
out.push(vd[i].id);me.__deleteItems(out);};this.file._main.style.display='none';this.file._onuploadstart=function(){me.__disable_save_all=true;me.attachments._create('progress','obj_upload_info','','bottom');if(me._onuploadstart)
me._onuploadstart();};this.file._onuploadprogress=function(file,a,b,xhr){me.attachments.progress._value(file.name,a,b,[function(){xhr.abort()}]);};this.file._onuploadsuccess=function(file){me.attachments.progress&&me.attachments.progress._handler(null);me._add(file);};this.file._onuploadend=function(){me.__disable_save_all=false;me.attachments.progress&&me.attachments.progress._destruct();if(me._onuploadend)
me._onuploadend();};this._main.addEventListener('paste',function(e){if(!me.file||!me.file.file||!me.file.file.__ondropfile){return;}
var items=(e.clipboardData||(e.originalEvent||{}).clipboardData||{}).items||(window.clipboardData||{}).files||[];for(var i=0;i<items.length;i++){if(items[i].getAsFile&&items[i].type.indexOf('image')===0){var file=items[i].getAsFile();try{file=new File([file],'clipboard-'+new IcewarpDate()+'.png',{type:items[i].type});}catch(e){}
me.file.file.__ondropfile([file]);}}});};_me._value=function(v){if(typeof v=='undefined'){var out=[];for(var i in this.__idtable)
if((this.__idtable[i]['class']=='attachment'||this.__idtable[i]['class']=='P'||this.__idtable[i]['class']=='itemlink'||this.__idtable[i]['class']=='url')&&!this.__idtable[i]['fullpath']){if(this.__idtable[i]['removed'])
out.push({uid:this.__idtable[i].id});}
else
if(!this.__idtable[i]['removed'])
out.push({values:{'class':this.__idtable[i]['class']||'file',description:this.__idtable[i]['name'],size:this.__idtable[i]['size']||0,fullpath:this.__idtable[i]['fullpath']||((this.__idtable[i]['folder']||this.file._getFolder())+"/"+this.__idtable[i]['id'])}});return out;}
else{if(v.path)
this.__itempath=v.path;if(v.values)
for(var i in v.values)
this.__idtable.push(v.values[i]);this.__fillDataGrid();}};_me._add=function(aArg){if(!aArg.fullpath)
aArg.folder=this.file._getFolder();aArg['class']=aArg['class']||'file';this.__idtable.push(aArg);this.__fillDataGrid();};_me._remove=function(id){if(typeof id=='undefined'){for(var i in this.__idtable)
if(!this.__idtable[id].removed)
this._remove(i);}
else
if(this.__idtable[id]&&!this.__idtable[id].removed){this.__idtable[id].removed=true;this.__fillDataGrid();}};_me.__fillDataGrid=function(){var aData={};for(var i in this.__idtable)
if(!this.__idtable[i]['removed'])
aData[i]={id:i,data:{ico:['','','','ico_'+Path.extension(this.__idtable[i].name)],name:this.__idtable[i].name,size:[parseFileSize(this.__idtable[i].size||0),parseInt(this.__idtable[i].size||0)]},arg:{id:i}};this.attachments._serverSort(aData);};_me.__deleteItems=function(aIDs){for(var i in aIDs)
this._remove(aIDs[i]);};_me._save=function(id,sMode){if(typeof id=='undefined'){var aUrl={'sid':dataSet.get('main',['sid']),'class':'allattachments','fullpath':this.__itempath||this.file._getFolder()};downloadItem(buildURL(aUrl));}
else
if(this.__idtable[id]){var sClass=this.__idtable[id]['class']||'file',sFullPath='';switch(sClass){case'P':sClass='attachment';case'file':case'attachment':if(sMode){switch(Path.extension(this.__idtable[id].name)){case'eml':var aPath=this.__splitFullPath(this.__idtable[id]['fullpath']||this.__itempath||this.file._getFolder());aPath[2]=WMItems.__clientID(aPath[2]+'|'+this.__idtable[id]['id']);OldMessage.openwindow(aPath);return;case'pdf':if(sMode=='force'||GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')!=1){var aPath=this.__splitFullPath(this.__itempath);var sPath='';if(!aPath||!aPath.length){sPath='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':sClass,'fullpath':this.__idtable[id]['fullpath']||((this.__idtable[id]['folder']||this.__itempath||this.file._getFolder())+'/'+this.__idtable[id]['id'])});}else{sPath='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment','fullpath':aPath[0]+'/'+aPath[1]+'/'+WMItems.__serverID(aPath[2])+'/'+this.__idtable[id]['id']});}
if(currentBrowser().match(/^MSIE([6-9]|10)$/)){downloadItem(sPath,true);}else{gui._create('pdf','frm_pdf')._load(sPath,this.__idtable[id].name);}
return;}
default:if(sPrimaryAccountWebDAV&&this.__itempath&&this.__idtable[id].ticket&&Item.officeSupport(this.__idtable[id].name)){var aPath=this.__splitFullPath(this.__itempath);Item.officeOpen({aid:aPath[0],fid:aPath[1],iid:aPath[2],attid:this.__idtable[id].id},[downloadItem,[this.__idtable[id].ticket,true]],Path.extension(this.__idtable[id].name),sMode);return;}}}
case'url':case'item':sFullPath=this.__idtable[id]['fullpath']||((this.__idtable[id]['folder']||this.__itempath||this.file._getFolder())+'/'+this.__idtable[id]['id']);if(this.__idtable[id].attachment){sFullPath+='/'+this.__idtable[id].attachment;sClass='attachment';}
break;case'itemlink':var aPath,aValues='';if(this.__idtable[id]['fullpath']){aPath=this.__splitFullPath(this.__idtable[id]['fullpath']);aPath[2]=this.__idtable[id].id;}
else
if(this.__itempath){aPath=this.__splitFullPath(this.__itempath);var aValues=WMItems.list({"aid":aPath[0],"fid":aPath[1],"iid":aPath[2],"atid":this.__idtable[id].id});for(var sAccount in aValues)
for(var sFolder in aValues[sAccount])
for(var sItem in aValues[sAccount][sFolder]);aPath=[sAccount,sFolder,sItem];aValues=aValues[sAccount][sFolder][sItem];}
Item.openwindow(aPath,aValues);return;}
if(sFullPath){var sUrl=buildURL({'sid':dataSet.get('main',['sid']),'class':sClass,'fullpath':sFullPath});if(sClass=='url')
openItem(sUrl,false,this.__idtable[id]['name']);else
downloadItem(sUrl);}}};_me.__splitFullPath=function(sPath){var aRet=[];var nIndex;if((nIndex=sPath.indexOf('/'))>=0){aRet[0]=sPath.substring(0,nIndex);sPath=sPath.substring(nIndex+1);}else return[];if((nIndex=sPath.lastIndexOf('/'))>=0){aRet[2]=sPath.substring(nIndex+1);sPath=sPath.substring(0,nIndex);}else return[];aRet[1]=sPath;return aRet;};_me.__addItems=function(aItems){for(var i in aItems){var out={'name':aItems[i]['title'],'attachment':aItems[i]['title'],'id':aItems[i]['id'],'size':aItems[i]['size'],'class':aItems[i]['type']||(aItems[i]['embedded']?'item':'itemlink'),'fullpath':aItems[i]['fullpath']};if(out['class']=='item')
for(var j in this.__idtable)
if(this.__idtable[j]['id']==aItems[i]['id']&&this.__idtable[j]['class']=='item')
continue;this._add(out);}};_me._disabled=function(b){if(Is.Defined(b)){this.__disabled=b?true:false;this.add_item._disabled(this.__disabled);this.remove._disabled(this.__disabled);this.file._disabled(this.__disabled);this.dropbox&&this.dropbox._disabled(this.__disabled);}
else
return this.__disabled;};

/* client/inc/obj_upload_edit_single.js */
_me=obj_upload_edit_single.prototype;function obj_upload_edit_single(){};_me.__constructor=function(){this.file._setFileQueueLimit(1);this.file._setMultipleSelection(false);this.__hasRemoveAll=false;};_me._add=function(aArg){if(this.__idtable.length>0)
this._remove();aArg.folder=this.file._getFolder();if(this.list._add(aArg)&&this._onuploadsuccess)
this._onuploadsuccess(aArg,id);};

/* client/inc/obj_upload_editgw.js */
_me=obj_upload_editgw.prototype;function obj_upload_editgw(){};_me.__constructor=function(sTypes){var me=this;this._create('add_item','obj_button','controls','ico img big gw simple');this.add_item._title('FORM_BUTTONS::ADD_ITEM');this.add_item._onclick=function(){var sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[sPrimaryAccount,sFolder]))
sFolder='';gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[me,'__addItems'],sPrimaryAccount,sFolder,sTypes,'r',false,['M','C','F','E','J','N','T','X']);};};_me.__addItems=function(aItems){for(var i in aItems){var out={'name':aItems[i]['title'],'id':aItems[i]['id'],'size':aItems[i]['size'],'class':aItems[i]['type']||(aItems[i]['embedded']?'item':'itemlink'),'fullpath':aItems[i]['fullpath']};if(out['class']=='item')
for(var j in this.__idtable)
if(this.list.__idtable[j]['id']==aItems[i]['id']&&this.list.__idtable[j]['class']=='item')
continue;this.list._add(out);}};

/* client/inc/obj_upload_info.js */
_me=obj_upload_info.prototype;function obj_upload_info(){};_me.__constructor=function(aAbortHandler){this.__eSize=this._getAnchor('size');this.__eName=this._getAnchor('name');this._create('progress','obj_progress','','noborder max transparent simple mono');this._getAnchor('close').onclick=function(){if(this.__handler)
executeCallbackFunction(this.__handler);}.bind(this);};_me._value=function(oName,iDone,iSize,aAbortHandler){this.__eName.innerText=oName;this.__updateSize(iDone,iSize);this._handler(aAbortHandler);};_me._handler=function(aAbortHandler){this.__handler=aAbortHandler;};_me.__updateSize=function(iDone,iSize){iDone=Math.min(iDone,iSize);var p=iDone/(iSize/100);this.__eSize.innerText=getLang('UPLOAD::SIZE_INFO',[Math.floor(p),parseFileSize(iDone),parseFileSize(iSize)]);this.progress._value(p);};

/* client/inc/obj_upload_list.js */
_me=obj_upload_list.prototype;function obj_upload_list(){};_me.__constructor=function(bDrop,sAttLabel,sDropLabel){this.__hasRename=true;this.__hasRemove=true;this.__hasRemoveAll=true;this.__dropSupport=bDrop;this.__labels=[getLang(sAttLabel||'ATTACHMENT::ATTACHMENTS'),getLang(sDropLabel||'ATTACHMENT::DROP_HOLDER')];this.__idtable=[];var me=this,list=this._getAnchor('list');list.innerHTML='<i>'+this.__labels[0]+'</i>';this._scrollbar(list,list.parentNode);list.oncontextmenu=list.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='INPUT')
elm=elm.parentNode;if(elm.tagName=='SPAN'){if(e.type=='contextmenu'&&me._oncontext)
me._oncontext(e,elm.id.substr(me._pathName.length+1));else
if(me._onclick)
me._onclick(elm.id.substr(me._pathName.length+1));}
else
if(elm.tagName=='B'){elm=elm.parentNode;me._remove(elm.id.substr(me._pathName.length+1));}
return false;};};_me._add=function(aArg,id){this.__idtable.push(aArg);if(!aArg.removed){var id=this.__idtable.length-1;var sName,ico='',list=this._getAnchor('list');if(aArg.name&&aArg.name.indexOf('.')>-1)
ico='ico_'+Path.extension(aArg.name);if(list.getElementsByTagName('I').length>0)
list.innerHTML='';if(aArg.name&&aArg.name.length>32)
sName=aArg.name.substr(0,24)+'..'+Path.extension(aArg.name);else
sName=aArg.name||'';if(sName&&sName.escapeHTML){sName=sName.escapeHTML();}
var itm=mkElement('span',{href:"",title:aArg.name,innerHTML:sName+(Is.Defined(aArg.size)?' <br>'+parseFileSize(aArg.size||0):'')+(this.__hasRemove?'<b></b>':''),className:(this.__hasRemove?'remove ':'')+ico,id:this._pathName+'/'+id});list.appendChild(itm);list.scrollLeft=(list.scrollWidth-list.offsetWidth);if(this._onchange)
this._onchange();return true;}
return false;};_me._remove=function(id){if(typeof id=='undefined'){for(var i in this.__idtable)
this._remove(i);return;}
else
if(this.__idtable[id]&&!this.__idtable[id].removed){this.__idtable[id].removed=true;var elm=document.getElementById(this._pathName+'/'+id);if(elm)
elm.parentNode.removeChild(elm);}
if(this._getAnchor('list').getElementsByTagName('SPAN').length<1)
this._getAnchor('list').innerHTML='<i>'+(this.__dropSupport?this.__labels[1]:this.__labels[0])+'</i>';if(this._onchange)
this._onchange();};_me._rename=function(id){if(this.__idtable[id]&&!this.__idtable[id].removed){var elm=document.getElementById(this._pathName+'/'+id);if(elm){elm.innerHTML='';var me=this;inp=mkElement('input');inp.onkeydown=function(e){var e=e||window.event;switch(e.keyCode){case 27:this.value=me.__idtable[id].name;case 13:if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();e.cancelBubble=true;this.onblur();return false;}};inp.oninput=function(e){elm.title=this.value||'';};inp.onblur=function(){this.onblur=null;var sName=me.__idtable[id].name,v=this.value.trim(),ext=Path.extension(v);if(v.indexOf(".")===0)
v=getLang('POPUP_ITEMS::NEW')+v;if(v&&v!=sName&&Is.Filename(v)){me.__idtable[id].description=sName=v;elm.className=(me.__hasRemove?'remove ':'')+(ext?'ico_'+ext:'');}
elm.title=sName;elm.innerHTML=(sName.length>32?sName.substr(0,24).escapeXML()+'..'+ext:sName.escapeXML())+(Is.Defined(me.__idtable[id].size)?' <br>'+parseFileSize(me.__idtable[id].size||0):'')+(me.__hasRemove?'<b></b>':'');if(me._onchange)
me._onchange();};inp.onclick=function(e){var e=e||window.event;if(e.stopPropagation)e.stopPropagation();e.cancelBubble=true;};inp.value=me.__idtable[id].description||this.__idtable[id].name;elm.appendChild(inp);try{var pos2=inp.value.lastIndexOf('.');pos2=pos2<0?0:pos2;if(document.selection){var r=inp.createTextRange();r.collapse(true);r.moveStart("character",0);if(pos2)r.moveEnd("character",pos2);r.select();}
else
inp.setSelectionRange(0,pos2);}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
inp.focus();}}};_me._value=function(v){if(typeof v=='undefined'){var out=[];for(var i in this.__idtable)
if(this.__idtable[i]['class']=='attachment'&&!this.__idtable[i]['fullpath']){if(this.__idtable[i]['removed'])
out.push({uid:this.__idtable[i].id});else
if(this.__idtable[i]['description']&&this.__idtable[i]['description']!=this.__idtable[i]['name'])
out.push({'uid':this.__idtable[i].id,'values':{'description':this.__idtable[i]['description']}});}
else
if(!this.__idtable[i]['removed']){out.push({values:{'class':this.__idtable[i]['class']||'file',description:this.__idtable[i]['description']||this.__idtable[i]['name'],size:this.__idtable[i]['size'],fullpath:this.__idtable[i]['fullpath']||(Is.Defined(this.__idtable[i]['id'])?this.__idtable[i]['folder']+"/"+this.__idtable[i]['id']:'')}});}
return out;}
else
if(v.values){for(var i in v.values)
switch(v.values[i]['class']){case'pdf':case'thumbnail':break;default:this._add(v.values[i]);}
if(this._onchange)
this._onchange();}};_me._oncontext=function(e,id){if(this.__disabled)
return;var aMenu=[],name=this.__idtable[id].name||this.__idtable[id].attachement,ext=Path.extension(name);if(Item.imageSupport(name))
aMenu.push({"title":'ATTACHMENT::SHOW_IMAGE','arg':[this,'_open',[id]]});else
if(ext==='mp3')
aMenu.push({"title":'ATTACHMENT::PLAY_SOUND','arg':[this,'_open',[id]]});else
if(Item.officeSupport(name)||'pdf'===ext)
aMenu.push({"title":'POPUP_ITEMS::OPEN','arg':[this,'_open',[id]]});aMenu.push({"title":'ATTACHMENT::DOWNLOAD','arg':[this,'_onclick',[id,true]]});if(this.__hasRename)
aMenu.push({"title":'-'},{"title":'FORM_BUTTONS::RENAME','arg':[this,'_rename',[id]]});if(this.__hasRemove){aMenu.push({"title":'-'},{"title":'ATTACHMENT::REMOVE',css:'color2','arg':[this,'_remove',[id]]});if(this.__hasRemoveAll)
aMenu.push({"title":'ATTACHMENT::REMOVE_ALL',css:'color2','arg':[this,'_remove',[]]});}
var cmenu=gui._create("cmenu","obj_context",'','',this);cmenu._fill(aMenu);cmenu._place(e.clientX,e.clientY);};_me._open=function(id){var sClass=this.__idtable[id]['class']||'file',sFullPath='';switch(sClass){case'file':sFullPath=this.__idtable[id]['folder']+'/'+this.__idtable[id]['id'];break;case'item':sFullPath=this.__idtable[id]['fullpath'];if(this.__idtable[id].attachement){sFullPath+='/'+this.__idtable[id].attachement;sClass='attachment';}
else{var aPath=Path.split(sFullPath);if(WMFolders.getType([aPath[0],Path.basedir(aPath[1])])=='F')
sClass='file_attachment';}
break;case'attachment':sFullPath=this.__idtable[id]['fullpath']||(this.__idtable[id]['folder']+'/'+this.__idtable[id]['id']);break;}
var name=this.__idtable[id].name||this.__idtable[id].attachement,ext=Path.extension(name),url='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':sClass,'fullpath':sFullPath});switch(ext){case"pdf":if(GWOthers.getItem('LAYOUT_SETTINGS','disable_pdf')==1||currentBrowser().match(/^MSIE([6-9]|10)$/))
return downloadItem(url,true);gui._create('pdf','frm_pdf')._load(url,name);return true;case"mp3":if(gui.audio)
gui.audio._value(url,name);return true;default:if(Item.imageSupport(name)){var img=gui._create('imgview','frm_imgview');img._fill([{title:name,url:url}]);img._value(0);return true;}
else
if(Item.officeSupport(name)){var sURL=document.location.origin+document.location.pathname+url;Item.officeOpen({EVNTITLE:name,url:sURL},[this,'_onclick',[id,true]],Path.extension(name),'view');return true;}}
return false;};_me._onclick=function(id,bDownload){if(bDownload||this._open(id)===false){var sClass=this.__idtable[id]['class']||'file',sFullPath='';switch(sClass){case'file':sFullPath=this.__idtable[id]['folder']+'/'+this.__idtable[id]['id'];break;case'message':sFullPath=this.__idtable[id]['fullpath'];break;case'item':sFullPath=this.__idtable[id]['fullpath'];if(this.__idtable[id].attachement){sFullPath+='/'+this.__idtable[id].attachement;sClass='attachment';}
else{var aPath=Path.split(sFullPath);if(WMFolders.getType([aPath[0],Path.basedir(aPath[1])])=='F')
sClass='file_attachment';}
break;case'attachment':sFullPath=this.__idtable[id]['fullpath']||(this.__idtable[id]['folder']+'/'+this.__idtable[id]['id']);break;}
if(sFullPath){var aUrl={'sid':dataSet.get('main',['sid']),'class':sClass,'fullpath':sFullPath};downloadItem(buildURL(aUrl));}}};_me._getName=function(id){id=typeof id=='undefined'?this.__idtable.length-1:id;return this.__idtable[id]?this.__idtable[id].name:'';};_me._getSize=function(id){id=typeof id=='undefined'?this.__idtable.length-1:id;return this.__idtable[id]?this.__idtable[id].size:0;};

/* client/inc/obj_upload_mail.js */
_me=obj_upload_mail.prototype;function obj_upload_mail(){};_me.__constructor=function(){var me=this;this._draw('obj_upload_mail','main',{disable_item:GWOthers.getItem('RESTRICTIONS','disable_attach_item')=='1'});this.list=this._parent.attach;this.list._value=function(v){if(typeof v=='undefined'){var out=[];for(var i in this.__idtable)
if(this.__idtable[i]['class']=='attachment'&&!this.__idtable[i]['fullpath']){if(this.__idtable[i]['removed'])
out.push({uid:this.__idtable[i].id});}
else
if(!this.__idtable[i]['removed']){this.__idtable[i]['class']=this.__idtable[i]['class']||'file';this.__idtable[i]['fullpath']=this.__idtable[i]['fullpath']||(this.__idtable[i]['folder']+"/"+this.__idtable[i]['id']);out.push(this.__idtable[i]);}
return{attachments:out};}
else
if(v.attachments)
for(var i in v.attachments)
this._add(v.attachments[i].values);};this.file._onuploadstart=function(){if(me._onuploadstart)
me._onuploadstart();};this.file._onuploadprogress=function(){if(me._onuploadprogress)
me._onuploadprogress.apply(me,arguments);};this.file._onuploadsuccess=function(file){me._add(file);if(me._onuploadsuccess)
me._onuploadsuccess(file);};this.file._onuploadend=function(){if(me._onuploadend)
me._onuploadend();};if(this.item)
this.item._onclick=function(defaultFolderType){var sFolder;var allowed_folder_types=['M','C','F','E','J','N','T','X'];if(Alfresco.enabled()){allowed_folder_types.push('K');sFolder=Alfresco.getLastFolder();}
if(!defaultFolderType){defaultFolderType='F';sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[sPrimaryAccount,sFolder]))
sFolder='';}
gui._create('insert_item','frm_insert_item','','frm_insert_item_nobottomdiv',[me,'__addItems'],sPrimaryAccount,sFolder,'','r',false,allowed_folder_types,defaultFolderType);};};_me._add=function(aArg){aArg.folder=this.file._getFolder();if(this.list._add(aArg)&&this._onuploadsuccess)
this._onuploadsuccess(aArg);};_me.__addItems=function(aItems){if(this._onuploadstart)
this._onuploadstart();var count=aItems.length;aItems.forEach(function(item,i){var aItemsInfo={aid:item.aid,fid:item.fid,iid:item.id,values:[]};var me=this;WMItems.list(aItemsInfo,'','','',[function(aData){var attachements=aData[item.aid][item.fid][item.id].ATTACHMENTS;var attachement=false;for(var j in attachements){if(attachements[j].values.ATTDESC===item.title){attachement=j;break;}}
var out={'name':item['title'],'attachement':attachement,'id':item['id'],'size':item['size'],'class':item['type']||(item['embedded']?'item':'itemlink'),'fullpath':item['fullpath']};if(out['class']=='item')
for(var j in me.list.__idtable)
if(me.list.__idtable[j]['id']==item['id']&&me.list.__idtable[j]['class']=='item')
continue;me.list._add(out);if(!--count){if(me._onuploadend)
me._onuploadend();}}]);},this);};_me._dropzone=function(elm,body,css,callback){this.file._dropzone(elm,body,css,callback);if(GWOthers.getItem('RESTRICTIONS','disable_attach_item')<1){this.__eDropZoneTarget=elm||this._main;gui.frm_main.dnd.registr_drop(this,['item']);}};_me._active_dropzone=function(v){if(v){this.__eDropZone=mkElement('div',{className:'dropzone'});this.__eDropZoneTarget.appendChild(this.__eDropZone);return this.__eDropZone;}
else
if(this.__eDropZone){if(this.__eDropZone.parentNode)
this.__eDropZone.parentNode.removeChild(this.__eDropZone);this.__eDropZone=null;}};_me._ondrop=function(v){if((v=v.value)){var sType=WMFolders.getType(v[0]),aCol=[];switch(sType){case'M':aCol.push('SUBJECT');break;case'C':aCol.push('ITMCLASSIFYAS');break;case'F':aCol.push('EVNLOCATION','EVNCOMPLETE');break;case'E':case'J':case'N':case'T':aCol.push('EVNTITLE');break;default:return;}
for(var ids=[],i=0;i<v.length;i++)
if(v[i].iid)
ids.push(WMItems.__serverID(v[i].iid));if(ids.length){var me=this;WMItems.list({aid:v[0].aid,fid:v[0].fid,values:aCol,filter:{search:'items:('+ids.join(' OR ')+')'}},'','','',[function(aData){if(aData&&(aData=aData[v[0].aid])&&(aData=aData[v[0].fid])){var out=[],tmp;for(var id in aData)
if(Is.Object(aData[id])&&id!=='@'){tmp={id:id,aid:v[0].aid,fid:v[0].fid,type:'item',fullpath:v[0].aid+'/'+v[0].fid+'/'+WMItems.__serverID(id)};if(aData[id].EVNCOMPLETE)
tmp.size=aData[id].EVNCOMPLETE;switch(sType){case'M':tmp.title=(aData[id]['SUBJECT']?aData[id]['SUBJECT']+' - ':'')+WMItems.__serverID(id)+'.eml';break;case'C':tmp.title=(aData[id]['ITMCLASSIFYAS']||WMItems.__serverID(id))+'.vcf';break;case'F':tmp.title=aData[id]['EVNLOCATION'];break;case'E':case'J':case'N':case'T':tmp.title=(aData[id]['EVNTITLE']||WMItems.__serverID(id))+'.ics';break;}
out.push(tmp);}
if(out.length)
me.__addItems(out);}}]);}}};

/* client/inc/obj_urlpreview.js */
function obj_urlpreview(){};_me=obj_urlpreview.prototype;function obj_urlpreview(){};_me.__constructor=function(aData){this.__aData=aData;this.__imgID=0;this.__images=[];if(aData.IMAGES&&aData.IMAGES[0].IMAGE){for(var id in aData.IMAGES[0].IMAGE)
if(aData.IMAGES[0].IMAGE[id].PROXYID)
this.__images.push(document.location.origin+'/.well-known/icewarp-imageproxy/'+aData.IMAGES[0].IMAGE[id].PROXYID[0].VALUE);else
if(aData.IMAGES[0].IMAGE[id].URL)
this.__images.push(aData.IMAGES[0].IMAGE[id].URL[0].VALUE);}
var a=mkElement('A',{href:aData.URL?aData.URL[0].VALUE:''}),aOut={title:aData.TITLE[0].VALUE||'',desc:aData.DESC[0].VALUE||'',url:a.hostname,buttons:this.__images.length>1};this._draw('obj_urlpreview','main',aOut);this._getAnchor('close').onclick=function(){if(this._onclose)
this._onclose();this._destruct();}.bind(this);if(this.__images.length){this._getAnchor('image').appendChild(mkElement('img'));addcss(this._main,'images');this.__image();if(this.__images.length>1){this._getAnchor('prev').onclick=function(){this.__image(this.__imgID-1);}.bind(this);this._getAnchor('next').onclick=function(){this.__image(this.__imgID+1);}.bind(this);}}};_me.__image=function(id){if(id<0)
id=this.__images.length-1;else
if(!this.__images[id])
id=0;this._getAnchor('image').querySelector('img').src=this.__images[id];if(this.__images.length>1)
this._getAnchor('tbn').innerHTML=getLang('CHAT::THUMBNAIL_COUNT',[id+1,this.__images.length]);this.__imgID=id;};_me._value=function(){if(this.__aData)
try{var out={url:this.__aData.URL[0].VALUE};if(this.__aData.TITLE)
out.title=this.__aData.TITLE[0].VALUE||'';if(this.__aData.DESC)
out.desc=this.__aData.DESC[0].VALUE||'';if(this.__aData.IMAGES&&this.__aData.IMAGES[0].IMAGE&&this.__aData.IMAGES[0].IMAGE[this.__imgID]&&this.__aData.IMAGES[0].IMAGE[this.__imgID].PROXYID)
out.thumbnailimageid=this.__aData.IMAGES[0].IMAGE[this.__imgID].PROXYID[0].VALUE;if(this.__aData.TYPE)
out.type=this.__aData.TYPE[0].VALUE;if(this.__aData.VIDEOURL)
out.videourl=this.__aData.VIDEOURL[0].VALUE;if(this.__aData.VIDEOTYPE)
out.videotype=this.__aData.VIDEOTYPE[0].VALUE;}
catch(r){console.log('Error','obj_urlpreview',r);}
return out;};

/* client/inc/obj_vdock.js */
_me=obj_vdock.prototype;function obj_vdock(){};_me.__constructor=function(bDefault){if(bDefault)gui._dock=this;this._docked={};this._add_destructor('__unregistr');var me=this;this._main.onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm!=this){var action=(elm.tagName=='SPAN'&&hascss(elm,'close'))?'_close':'_remove';if((elm=Is.Child(elm,'div',this))&&elm.id){var obj=me._docked[elm.id.substr(me._pathName.length)];if(obj){me[action](obj);if(obj._type=='collapse'){e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();}
return false;}}}};this._main.oncontextmenu=function(e){var e=e||window.event;e.cancelBubble=true;if(e.preventDefault)
e.preventDefault();if(e.stopPropagation)
e.stopPropagation();this.onclick(e);return false;};this.__oCollapse={'_docked':false,'_type':'collapse','_undock':function(parent,id){if(this._cmenu&&!this._cmenu._destructed)
this._cmenu._destruct();else{var ids=me.__getCollapsed(),elm=document.getElementById(parent._pathName+id);if(elm&&(ids=ids.ids)){var pos=getSize(elm),aMenu=[];this._cmenu=gui._create("cmenu","obj_context",'','vdock',parent);for(var i=ids.length-1;i>=0;i--)
aMenu.push({text:ids[i][1]?(ids[i][1].length>26?ids[i][1].substr(0,24)+'<b>...</b>':ids[i][1]):'',css:'ico2 '+ids[i][2],arg:ids[i][0]});this._cmenu._fill(aMenu);this._cmenu._place(pos.x+(pos.w/2),pos.y,'',2);this._cmenu._onclick=function(e,elm,id,arg){me._docked[arg]._undock();};}}
return false;}};gui._obeyEvent('resize',[this,'__checkSize']);};_me.__checkSize=function(){var dock=this._main;if(dock.scrollHeight>dock.clientHeight+10){var out=this.__getCollapsed(),elm=this._add(this.__oCollapse,out.ids.length.toString(),'vdock_collapse');if(elm){elm.style[gui._rtl?'right':'left']=out.offset+'px';}}
else{this._remove(this.__oCollapse,true);}};_me.__getCollapsed=function(){var out={ids:[],offset:0},elm;for(var id in this._docked)
if(this._docked[id]._type!='collapse'&&(elm=document.getElementById(this._pathName+id))){if((elm.offsetTop||elm.clientTop)>10)
out.ids.push([id,elm.title,elm.className]);else
if(!gui._rtl&&out.offset<elm.offsetLeft+elm.offsetWidth)
out.offset=elm.offsetLeft+elm.offsetWidth;else
if(gui._rtl)
out.offset+=elm.offsetWidth+5;}
if(gui._rtl)
out.offset+=9;return out;};_me.__unregistr=function(){if(gui._dock===this)delete gui._dock[this._name];for(var i in this._docked){if(this._docked[i]._onundock)
this._docked[i]._onundock(this,i);}};_me._close=function(Obj){if(Obj._close&&Obj._close(true)==true)
return;this._remove(Obj);};_me._remove=function(Obj,bForce){var id,elm;if(typeof Obj!='object'||(id=inArray(this._docked,Obj))<0||(!bForce&&Obj._undock&&Obj._undock(this,id)===false))
return;if((elm=document.getElementById(this._pathName+(id)))){var elms=elm.parentNode.getElementsByTagName('div');for(var i=0;i<elms.length;i++)
if(elms[i]===elm){Obj.__lastDockPosition=i;break;}
elm.parentNode.removeChild(elm);delete this._docked[id];}
if(Obj._type!='collapse')
this.__checkSize();if(this._onchange)
this._onchange(Is.Empty(this._docked)?false:true);};_me._add=function(Obj,sTitle,sClass){var id,elm;if((id=inArray(this._docked,Obj))>-1)
elm=document.getElementById(this._pathName+id);else{for(id=0;this._docked[id];id++);this._docked[id]=Obj;elm=mkElement('div',{"id":this._pathName+id});var elms=this._main.getElementsByTagName('div');if(Is.Defined(Obj.__lastDockPosition)){if(Obj.__lastDockPosition<elms.length)
this._main.insertBefore(elm,elms[Obj.__lastDockPosition]);else
delete Obj.__lastDockPosition;}
if(!Is.Defined(Obj.__lastDockPosition)){Obj.__lastDockPosition=elms.length;this._main.appendChild(elm);}}
elm.className='ico_'+Obj._type+(sClass?' '+sClass:'')+(Obj.__closable?' closable':'');elm.title=sTitle;elm.innerHTML=(sTitle?(sTitle.length>24?sTitle.substr(0,22).escapeHTML()+'...':sTitle.escapeHTML()):'&nbsp;')+(Obj.__closable?'<span class="close"></span>':'');if(Obj._type!='collapse')
this.__checkSize();if(this._onchange)
this._onchange(Is.Empty(this._docked)?false:true);return elm;};

/* client/inc/obj_view_filter.js */
_me=obj_view_filter.prototype;function obj_view_filter(){};_me.__constructor=function(){var me=this,aDisabled={},i,type,anchor,aFilter,elm,sInitPage,sActiveFolder,sActiveFolderType,sType,tips,span,tip;this.__btncss={};this.__aTypes=['M','C','E','J','N','F','T','B','I','Y','X','W','K'];this._telemetry='full';var opt={sip:!sPrimaryAccountGUEST&&window.sPrimaryAccountSIP&&(GWOthers.getItem('RESTRICTIONS','disable_sip')||0)<1,conference:!sPrimaryAccountGUEST&&window.sPrimaryAccountCONFERENCE,alfresco:Alfresco&&Alfresco.enabled(),quota:dataSet.get('accounts',[sPrimaryAccount,'MBOX_QUOTA']),extended:this._parent._name=='frm_main'};var dgw=(sPrimaryAccountGW?(GWOthers.getItem('RESTRICTIONS','disable_gw_types')||''):'cetfnj').split('');if(sPrimaryAccountGUEST){dgw='mcetfnjb';}
for(i in dgw){aDisabled[dgw[i]]=true;}
if(count(aDisabled)==this.__aTypes.length-1){aDisabled.gw=true;}
if(!sPrimaryAccountCHAT){aDisabled.i=true;}
this._draw('obj_view_filter','main',opt);for(type in aDisabled){anchor=this._getAnchor(type.toUpperCase());addcss(anchor,'hide');}
aFilter=((TeamChatAPI&&TeamChatAPI.teamChatOnly()&&'I,Y')||Cookie.get(['filter_tree']));sInitPage=(sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly()))?'':GWOthers.getItem('LAYOUT_SETTINGS','init_page');if(!aFilter){if(sInitPage==='h'||sInitPage==='i'){aFilter='M';}
else
if(sInitPage==='r'){aFilter='M';sActiveFolder=Cookie.get(['last_folder']);if(sActiveFolder){sType=WMFolders.getType(Path.split(sActiveFolder));if(sType&&sType!=='X')
aFilter=sType;}}}
else
if(Is.String(aFilter)){if(sInitPage=='i'&&aFilter.indexOf('M')<0){aFilter='M';}
if((aFilter=aFilter.split(','))){for(i in aFilter){if(elm=this._getAnchor(aFilter[i])){addcss(elm,'active');}}}}
this._getAnchor('buttons').onclick=function(e){var e=e||window.event,elm=e.target||e.srcElement,bInfo=false;if(elm.tagName=='I'){elm=elm.parentNode;bInfo=true;}
if(elm.tagName=='SPAN'){var id=elm.id.substring(me._pathName.length+1);Cookie.set(['show_all_folders'],0);gui.frm_main.bar.tree.folders.btn_all._active(false);me.__filter(id,bInfo,e.ctrlKey);}};if(opt.extended){this._listen('active_folder');this._listen('folders');this._getAnchor('buttons').oncontextmenu=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName=='I')
elm=elm.parentNode;if(elm.tagName=='SPAN'){var sType=elm.id.substring(me._pathName.length+1);switch(sType){case'F':case'S':case'H':case'A':case'B':case'I':case'W':break;case'M':NewMessage.compose();break;default:gui.frm_main.hmenu1.__createNewGW(sType);}}
e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;};this._getAnchor('loader').onclick=function(){me._getEmails();};gui.tooltip._add(this._getAnchor('loader'),getLang('MAIN_MENU::UPDATE'),{x:'+48',y:'+35'});if(GWOthers.getItem('MAIL_SETTINGS_GENERAL','autoupdate')>0){var iRefresh=parseInt(GWOthers.getItem('MAIL_SETTINGS_GENERAL','autoupdate_minutes'),10);if(iRefresh>0){iRefresh*=60000;var me=this;this.__interval=setInterval(function(){me._getEmails(1);},iRefresh);}}
this._add_destructor('__destructor');gui.__loading_counter=0;gui.__loading_obj=this;tips={M:getLang('FOLDERS::MAILS'),E:getLang('FOLDERS::EVENTS'),C:getLang('FOLDERS::CONTACTS'),F:getLang('FOLDERS::FILES_DOCUMENTS'),T:getLang('FOLDERS::TASKS'),N:getLang('FOLDERS::NOTES'),I:getLang('FOLDER_TYPES::GROUPCHAT'),W:getLang('FOLDER_TYPES::CONFERENCES'),B:getLang('COMMON_FOLDERS::TRASH'),K:getLang('COMMON_FOLDERS::ALFRESCO')};span=this._getAnchor('buttons').getElementsByTagName('span');for(i=span.length;i;){tip=tips[span[--i].id.substring(this._pathName.length+1)];tip&&gui.tooltip._add(span[i],tip,{x:'+48',y:'+35'});}
if(gui.frm_main&&gui.frm_main.dnd){gui.frm_main.dnd.registr_drop(this,['item','folder','jabber','favorite']);}
if(opt.quota){this._create('quota','obj_progress','quota','max white');this.quota.__update=function(sDName,sDPath){if(sDPath&&sDPath[0]=='MBOX_USAGE'){var q=dataSet.get('main',['MBOX_QUOTA']),u=dataSet.get('main',['MBOX_USAGE']);this._range(q);this._value(u);this._title(roundTo(u/q*100,1)+'%');}};this.quota._listen('main');addcss(this._main,'quota');}
this.__eSip=this._getAnchor('sip');if(opt.sip&&this.__eSip){this.__eSip.oncontextmenu=function(e){if(GWOthers.getItem('SIP','mode')=='integrate'&&!gui.sipalert){var s=dataSet.get('sip',['state']),aMenu=[{title:'STATUS::ONLINE',css:'ico ico2 sip online'+(s=='offline'?'':' check'),arg:[me,'__sip',['online']]},{title:'STATUS::OFFLINE',css:'ico ico2 sip offline'+(s=='offline'?' check':''),arg:[me,'__sip',['offline']]}];var pos=getSize(this);me.cmenu=gui._create('cmenu','obj_context','','sip');me.cmenu._fill(aMenu);me.cmenu._place(pos.x+pos.w,pos.y+(pos.h/2),170);me.cmenu.__deactive=function(){removecss(this,'active')}.bind(this);me.cmenu._add_destructor('__deactive');addcss(this,'active');e.cancelBubble=true;if(e.stopPropagation)e.stopPropagation();if(e.preventDefault)e.preventDefault();return false;}};this.__eSip.onclick=function(){switch(dataSet.get('sip',['activity'])){case'Ringing':case'Calling':return;case'Phoning':if(!gui.sipalert){var cmenu=gui._create('sipalert','obj_call');cmenu._placeElement(this._main);}else
gui.sipalert._destruct();return;}
if(gui.dial){if(gui.dial._docked)
gui.dial._undock();else
gui.dial._destruct();}
else
gui._create('dial','frm_dial','','');};gui.tooltip._add(this.__eSip,getLang('SIP::SIP')+'  '+getLang('STATUS::OFFLINE'));this.__btncss['sip']=this.__eSip.className;this._listen('sip');}}};_me._loading=function(b){var elm=this._getAnchor('loader');if(elm)
if(b>0)
addcss(elm,'start');else
removecss(elm,'start');};_me._getEmails=function(bMain){return this._parent&&this._parent._getNew&&this._parent._getNew(bMain);};_me.__openEvents=function(){gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@EVENTS@@__'});};_me.__hideQuota=function(){this.quota&&this.quota._main.classList.add('hidden');return this;};_me.__hideUnread=function(){[].map.call(this._main.querySelectorAll('i'),function(element){element.classList.add('absolute');element.classList.add('hidden');});return this;};_me.__filter=function(id,bInfo,bCtrl){gui.frm_main.bar.tree.folders.inp_search._value('',true);gui.frm_main.bar.tree.folders.__filter='';var oTree=gui.frm_main.bar.tree.folders,aActive=oTree._getActive(),bInfo=bInfo||false;var args=arguments;var me=this;if(gui.frm_main.main&&gui.frm_main.main._uploading){gui._create('stop_upload','frm_confirm','','',[function(){gui.frm_main.main._uploading=false;me.__filter.apply(me,args);}],'ALERTS::ALERT','CONFIRMATION::STOPUPLOAD');return false;}
if(id=='A'){oTree._filter_folder();}
else
if(id=='I'){oTree._filter_folder(['I','Y']);}
else{if(bCtrl&&Is.Object(oTree._sFilterFolderType)){bInfo=false;if(id=='M')
oTree._sFilterFolderType['Q']=oTree._sFilterFolderType['QL']=oTree._sFilterFolderType['R']=oTree._sFilterFolderType['M']=oTree._sFilterFolderType['M']?false:true;else
oTree._sFilterFolderType[id]=oTree._sFilterFolderType[id]?false:true;oTree._sFilterFolderType['G']=(oTree._sFilterFolderType['C']||oTree._sFilterFolderType['E']||oTree._sFilterFolderType['J']||oTree._sFilterFolderType['N']||oTree._sFilterFolderType['F']||oTree._sFilterFolderType['T'])?true:false;var bEmpty=true;for(var i in oTree._sFilterFolderType)
if(oTree._sFilterFolderType[i]){bEmpty=false;break;}
if(bEmpty){oTree._sFilterFolderType={};addcss(this._getAnchor('A'),'active');}}
else
if(id=='M')
oTree._filter_folder(['M','R','QL','Q']);else
if(id=='E')
oTree._filter_folder(['E']);else
if(id=='B')
oTree._filter_folder(['B','G','QL','Q']);else
if(id=='W'){oTree._filter_folder(['W']);oTree._setActive([sPrimaryAccount+'/__@@VIRTUAL@@__/__@@MEETINGS@@__']);}else
oTree._filter_folder([id]);}
var bActive=false,aActiveFilters=[];for(var i in this.__aTypes)
if(oTree._sFilterFolderType[this.__aTypes[i]]){addcss(this._getAnchor(this.__aTypes[i]),'active');aActiveFilters.push(this.__aTypes[i]);bActive=true;}
else
removecss(this._getAnchor(this.__aTypes[i]),'active');if((!oTree._sFilterFolderType['E']||aActiveFilters.length>1)&&sPrimaryAccount==aActive[0]&&'__@@VIRTUAL@@__/__@@EVENTS@@__'==aActive[1]){gui.frm_main._selectView({aid:sPrimaryAccount,fid:Mapping.getDefaultFolderForGWType('E')},'',true);oTree._setActive(sPrimaryAccount+'/'+Mapping.getDefaultFolderForGWType('E'));}
Cookie.set(['filter_tree'],aActiveFilters.join(','));if(!bActive){delete oTree._sFilterFolderType;oTree._fill();}
else{oTree._fill();if((oTree._sFilterFolderType['E']&&aActiveFilters.length==1)||(!bCtrl&&(!aActive[0]||!aActive[1]||dataSet.get('folders',[aActive[0],aActive[1],'TYPE'])!=id))||bInfo||(id=='M'&&dataSet.get('folders',[aActive[0],aActive[1],'DEFAULT'])=='H')){if(id=='M'){gui.frm_main._selectView({aid:sPrimaryAccount,fid:'INBOX'});}
else
if(id=='W'){gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@VIRTUAL@@__/__@@MEETINGS@@__'});}
else{if(id=='E'){if(dataSet.get('folders',[sPrimaryAccount,'__@@VIRTUAL@@__/__@@EVENTS@@__'])){this.__openEvents();return false;}
else
if(Mapping.getDefaultFolderForGWType('E')){var folders={};folders[Mapping.getDefaultFolderForGWType('E')]=true;WMFolders.add({'aid':sPrimaryAccount,'name':'__@@VIRTUAL@@__/__@@EVENTS@@__','type':'E','virtual':{folders:folders}},'folders','',[this,'__openEvents']);return false;}}
if(id=='B'){var trash=Path.split(GWOthers.get('DEFAULT_FOLDERS','storage')['VALUES']['trash']);if(dataSet.get('folders',trash)){gui.frm_main._selectView({aid:sPrimaryAccount,fid:trash[1]});}else{gui.frm_main._selectView({aid:sPrimaryAccount,fid:'__@@GWTRASH@@__'});}}
else
if(id=='I'){var aActive=Path.split(dataSet.get('active_folder'));if(WMFolders.getType(aActive)!='I'){var last=Path.split(Cookie.get(['last','I']));if(last[0]==sPrimaryAccount&&last[1]&&WMFolders.getType([sPrimaryAccount,last[1]])=='I'){gui.frm_main._selectView({aid:sPrimaryAccount,fid:last[1]},'chat_view');}
else{var f=dataSet.get('folders',[sPrimaryAccount]);var fid;for(var n in f){if(f[n].TYPE=='I'){fid=n;break;}else if(!fid&&f[n].TYPE=='Y'){fid=n;}}
fid&&gui.frm_main._selectView({aid:sPrimaryAccount,fid:fid},'chat_view');}}}
else
if(Mapping.getDefaultFolderForGWType(id)!==false&&WMFolders.getType([sPrimaryAccount,Mapping.getDefaultFolderForGWType(id)])==id){gui.frm_main._selectView({aid:sPrimaryAccount,fid:Mapping.getDefaultFolderForGWType(id)});}}}}
if(gui.frm_main&&gui.frm_main.main&&gui.frm_main.main.list){gui.frm_main.main.list._focus();}};_me.__sip=function(sStatus){if(sStatus=='online'){if(gui.frm_main.sip)
gui.frm_main.sip._login(function(ok){if(!ok)
gui._create('alert','frm_alert','','','','SIP::ERROR','SIP::REGISTRATION_FAILED');});else
if(!gui.frm_main.sip)
gui.frm_main._create('sip','obj_sip','','',function(ok){if(!ok)
gui._create('alert','frm_alert','','','','SIP::ERROR','SIP::REGISTRATION_FAILED');});}
else
if(gui.frm_main.sip){if(gui.frm_main.sip.phone){if(gui.dial){gui.frm_main.sip._hangup();gui.dial._destruct();}
gui.frm_main.sip.phone.terminate();gui.frm_main.sip.phone.unregister();}else
gui.frm_main.sip._destruct('sip','obj_sip');}};_me._recent=function(sAnchor,i){var elm=this._getAnchor(sAnchor);if(elm){elm=elm.getElementsByTagName('I');if(elm&&(elm=elm[0])){if(i)
elm.innerHTML=i;else
elm.parentNode.removeChild(elm);}
else
if(i){elm=mkElement('I');elm.innerHTML=i;this._getAnchor(sAnchor).appendChild(elm);}}};_me.__update=function(sDName){var f,n,r,rec,b=false,allFolders,groupwareTypes,searchedTypes,i,anchor,oTree,active;switch(sDName){case'folders':this._recent('M',parseInt(dataSet.get('folders',[sPrimaryAccount,'INBOX','RECENT'])||0,10));if(sPrimaryAccountCHAT){f=dataSet.get('folders',[sPrimaryAccount]);for(n in f){if(f[n].TYPE=='I'&&parseInt(f[n].RECENT)){r=true;}}
removecss(this._getAnchor('I'),'hide');this._recent('I',r&&' ');}
allFolders=dataSet.get('folders',[sPrimaryAccount]);groupwareTypes=['E','C','F','T','N'];searchedTypes={'E':false,'C':false,'F':false,'T':false,'N':false};for(i in allFolders){if(i==='__@@VIRTUAL@@__/__@@EVENTS@@__'){continue;}
if(groupwareTypes.indexOf(allFolders[i].TYPE)!==-1){searchedTypes[allFolders[i].TYPE]=true;}}
for(i in searchedTypes){anchor=this._getAnchor(i);if(searchedTypes[i]){removecss(anchor,'hide');}
else{addcss(anchor,'hide');}}
break;case'active_folder':oTree=gui.frm_main.bar.tree.folders;if(oTree&&!Is.Empty(oTree._sFilterFolderType)){active=dataSet.get('active_folder');if(active){active=Path.split(active);active[2]='TYPE';if(oTree._sFilterFolderType['E']&&active[1]!='__@@VIRTUAL@@__/__@@EVENTS@@__'&&count(oTree._sFilterFolderType)==1){if(this._getAnchor('E'))
removecss(this._getAnchor('E'),'active');Cookie.set(['filter_tree'],'');delete oTree._sFilterFolderType;oTree._fill();}}}
break;case'sip':if(this.__eSip){var ds=dataSet.get('sip'),aStatus=[ds.state];switch(ds.activity){case'Ringing':case'Phoning':case'Calling':aStatus.push('activity');if(this.cmenu&&!this.cmenu._destructed)
this.cmenu._destruct();if(!gui.sipalert){var cmenu=gui._create('sipalert','obj_call');cmenu._placeElement(this.__eSip);}
break;}
if(aStatus.length){this.__eSip.className=this.__btncss['sip']+' '+aStatus.join(' ');gui.tooltip._title(this.__eSip,getLang('CONTACT::PHONE')+'  '+getLang('STATUS::'+(ds.state&&ds.state.toUpperCase()||'OFFLINE')));}}}};_me._active_dropzone=function(v){if(v){if(v.type=='item'){var sLockID=dataSet.get('items',[v.value[0].aid,v.value[0].fid,v.value[0].iid,'EVNLOCKOWN_ID']),bDelete=(!sLockID||sLockID==sPrimaryAccountGWID)&&WMFolders.getAccess({aid:v.value[0].aid,fid:v.value[0].fid},'remove');this.__trgets={};var itmtype=WMFolders.getType(v.value[0]),aspan=this._getAnchor('buttons').getElementsByTagName('SPAN'),stype;if(itmtype!='QL')
for(var i=aspan.length-1;i>-1;i--){stype=aspan[i].id.substr(this._pathName.length+1);if(stype!='A'&&(stype!='B'||bDelete))
this.__trgets[stype]=getSize(aspan[i]);}}
else
this.__trgets={'B':getSize(this._getAnchor('B'))};if(this.__trgets['B'])
addcss(this._getAnchor('B'),'delete');}
else
removecss(this._getAnchor('B'),'delete');};_me._ondragover=function(v){var out='';if(v.y){var itmtype=WMFolders.getType(v.value[0]);for(var i in this.__trgets){if(itmtype!=i&&this.__trgets[i].y<v.y&&this.__trgets[i].y+this.__trgets[i].h>v.y){out=i;addcss(this._getAnchor(i),'hover');}
else
removecss(this._getAnchor(i),'hover');}}
this.__lastDrop=out;return out?true:false;};_me._ondragout=function(v){for(var i in this.__trgets)
removecss(this._getAnchor(i),'hover');};_me._ondrop=function(v){if(this.__lastDrop){if(this.__lastDrop=='B'){switch(v.type){case'folder':var val=v.value[0];if(val){if(WMFolders.getRights(val,'remove')&&!dataSet.get('folders',[val.aid,val.fid,'DEFAULT'])){storage.library('obj_context_folder');if(v.ctrl)
window.obj_context_folder.__deleteFolder(val.aid,val.fid);else
window.obj_context_folder.prototype._onclick(null,null,null,{method:'delete_folder',aid:val.aid,fid:val.fid});}
else
gui.notifier._value({type:'alert',args:{header:'',text:'CONTEXT_FOLDER::CANTDELETE'}});}
break;case'item':var ids=[];for(var i in v.value){if(Is.Defined(ids[0])){if(ids[0]==v.value[i].aid&&ids[1]==v.value[i].fid)
ids[2].push(v.value[i].iid);}
else
ids=[v.value[i].aid,v.value[i].fid,[v.value[i].iid]];}
if(ids.length)
Item.remove(ids,v.ctrl);break;case'jabber':if(v.value&&gui.frm_main.im&&gui.frm_main.im._is_active()){if(v.ctrl)
gui.frm_main.im._removeUsr(v.value);else
if(v.value.length>1)
gui.frm_main.im._oncontext('','','',{method:'user_remove'});else
gui.frm_main.im._oncontext('','','',{method:'user_remove',id:v.value});}
break;case'favorite':if(v.value&&v.value[0].aid&&v.value[0].fid&&gui.frm_main.bar.fav)
gui.frm_main.bar.fav.__remove('','','',v.value[0]);}}
else
if(v.type=='item')
Item.__convertToFolder(sPrimaryAccount,this.__lastDrop=='M'?'INBOX':Mapping.getDefaultFolderForGWType(this.__lastDrop),v);}};

/* client/inc/obj_vtabs.js */
_me=obj_vtabs.prototype;function obj_vtabs(){};_me.__constructor=function(){this._scrollbar(this._getAnchor('header2'));};_me._scrollHeader=function(eLi){var eHead=this._getAnchor('header2'),p1=getSize(eHead),p2=getSize(eLi);if(p1.y>p2.y)
eHead.scrollTop+=(p2.y-p1.y);else
if(p1.y+p1.h<p2.y+p2.h)
eHead.scrollTop+=((p2.y+p2.h)-(p1.y+p1.h));};

/* client/inc/obj_websocket.js */
_me=obj_websocket.prototype;function obj_websocket(){};_me.__constructor=function(sURL){this.__sURL=sURL||(location.protocol=='https:'?'wss:':'ws:')+'//'+location.hostname+(location.port?':'+location.port:'');this.__sProtocol='xmpp';this.__buffer=[];this.__heartBeatTimer=0;this._add_destructor('__destruct');this.reopenTimeout;this._open();};_me._open=function(){if(!this.__socket&&WebSocket){console.log('obj_websocket','Connecting',this.__sURL);try{this.__socket=new WebSocket(this.__sURL,this.__sProtocol);}
catch(r){console.log("obj_websocket","Your browser does not support WebSocket object",r);return;}
this.__socket.onopen=function(e){this.__heartBeat();if(this._onopen)
this._onopen();this.__exeEvent('onopen',e,{"owner":this});this._buffer_flush();}.bind(this);this.__socket.onmessage=function(e){if(this.__socket!==e.target){return;}
this.__heartBeat();var aResponse=XMLTools.Str2Arr('<root>'+e.data+'</root>');if(aResponse&&aResponse.ROOT){aResponse=aResponse.ROOT[0];if(this._onmessage)
this._onmessage(e,aResponse);this.__exeEvent('onmessage',e,aResponse,{"owner":this});}}.bind(this);this.__socket.onerror=function(e){console.log('websocket','ERROR',e);if(this._onerror)
this._onerror();this.__exeEvent('onerror',e,{"owner":this});}.bind(this);this.__socket.onclose=function(e){if(this.__socket!==e.target){return;}
console.log('websocket','CLOSE',e);this.__cancelHeartBeat();if(this._onclose)
this._onclose(e);this.__exeEvent('onclose',e,{"owner":this});if(this.__socket){delete this.__socket.onopen;delete this.__socket.onmessage;delete this.__socket.onerror;delete this.__socket.onclose;delete this.__socket;}
if(e.wasClean==false&&!this._destructed){if(gui.__online){clearTimeout(this.reopenTimeout);this.reopenTimeout=setTimeout(function(){if(!this._destructed)
this._open();}.bind(this),e.code===1013?10000:5000);}else{gui._obeyEvent('online',[function(){if(!this._destructed){clearTimeout(this.reopenTimeout);this.reopenTimeout=setTimeout(function(){this._open();}.bind(this),5);}
return false;}.bind(this)]);}}}.bind(this);}};_me._close=function(forceClose){var socket=this.__socket;if(socket&&(socket.readyState<2||forceClose)){socket.close(1000,'bye bye');setTimeout(function(){if(socket===this.__socket){this.__socket&&this.__socket.onclose({wasClean:false});}}.bind(this),5);}};_me._getState=function(){return this.__socket?this.__socket.readyState:3;};_me._send=function(sData){if(!this.__socket){sData&&this.__buffer_queue(sData);clearTimeout(this.reopenTimeout);this.reopenTimeout=setTimeout(function(){this._open();}.bind(this),5000);}else if(this.__socket.readyState>this.__socket.OPEN){sData&&this.__buffer_queue(sData);this._close(true);}
else
if(this.__socket.readyState===this.__socket.OPEN){try{this.__socket.send(sData);if(sData)
this.__heartBeat();return true;}
catch(r){console.log("obj_websocket","Unable to send request:",sData);}}
else
if(sData)
this.__buffer_queue(sData);return false;};_me._sendArray=function(aData,bPreserveCase){this._send(XMLTools.Arr2Str(aData,'',bPreserveCase));};_me._sendJSON=function(aData){this._send(JSON.stringify(aData));};_me._sendText=function(sData){this._send(sData);};_me.__heartBeat=function(){this.__cancelHeartBeat();this.__heartBeatTimer=setTimeout(function(){if(this._getState()===1){this.__socket.send('');this.__heartBeat();}}.bind(this),20000);};_me.__cancelHeartBeat=function(){this.__heartBeatTimer&&clearTimeout(this.__heartBeatTimer);};_me.__buffer_queue=function(sXML){this.__buffer.push(sXML);};_me._buffer_flush=function(){while(this.__buffer.length){setTimeout(function(message){this._send(message);}.bind(this,this.__buffer.shift()),5)}};_me._buffer_clear=function(){this.__buffer=[];};_me._buffer_size=function(){return this.__buffer.length;};_me.__destruct=function(){this.__cancelHeartBeat();this._buffer_clear();delete this._onclose;this._close();};

/* client/inc/obj_websocket_api.js */
_me=obj_websocket_api.prototype;function obj_websocket_api(){};_me.__constructor=function(){this._idPrefix='api-';this._xmlns='http://icewarp.com/api/';if(this._parent._getState()==1)
this._login();};_me._onmessage=function(e,aResponse){if(aResponse.IQ&&aResponse.IQ[0].ATTRIBUTES&&aResponse.IQ[0].ATTRIBUTES.XMLNS===this._xmlns){var id=aResponse.IQ[0].ATTRIBUTES.ID,bFailure=false,aHandler;if(id&&this.__requests[id]){if(aResponse.IQ[0].FAILURE){if(aResponse.IQ[0].FAILURE[0].STATUS&&aResponse.IQ[0].FAILURE[0].STATUS[0].VALUE=='User not authenticated'){this._state(0);this.__buffer_queue(this.__requests[id].iq,true);this._login();return;}
bFailure=true;}
if(bFailure&&this.__requests[id].error)
aHandler=this.__requests[id].error;else
aHandler=this.__requests[id].response;if(aHandler)
executeCallbackFunction(aHandler,aResponse);delete this.__requests[id];}
else{if(aResponse.IQ[0].STATUSLIST)
this.__exeEvent('onStatusChange',aResponse.IQ[0].STATUSLIST[0].ITEM,{"owner":this});if(aResponse.IQ[0].NOTIFY)
for(var i in aResponse.IQ[0].NOTIFY)
this._notify(aResponse.IQ[0].NOTIFY[i].ATTRIBUTES);if(aResponse.IQ[0].URLINFO)
for(var i in aResponse.IQ[0].URLINFO)
this.__exeEvent('onurlinfo',aResponse.IQ[0].URLINFO[i],{"owner":this});}}};_me._onclose=function(e){this._state(0);};_me._onopen=function(e){if(gui.connection&&this.__errorID)
gui.connection._hide(this.__errorID);this._login();};_me._onerror=function(e){if(gui.connection){if(this.__errorID)
gui.connection._hide(this.__errorID);this.__errorID=gui.connection._queue(500);}};_me._create_iq=function(aData,aHandler,aErrHandler,bNoBuffer){do{var id=this._idPrefix+unique_id()}while(this.__requests[id]);var aData=aData||{};aData.ATTRIBUTES={XMLNS:"http://icewarp.com/api/",ID:id};var iq={IQ:[aData]};this.__requests[id]={type:'iq',request:iq,data:aData,response:aHandler,error:aErrHandler};this._request(iq,null,bNoBuffer);};_me._login=function(aData,bSkip){if(!aData){this._state(1);this._create_iq({'AUTH':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-sasl'},MECHANISM:[{VALUE:'DIGEST-MD5'}]}]},[this,'_login'],'',true);}
else{if(aData.IQ){if(aData.IQ[0].CHALLENGE){if(bSkip){this._create_iq({'RESPONSE':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-sasl'}}]},[this,'_login'],'',true);}
else{auth.get_digest({hash:aData.IQ[0].CHALLENGE[0].VALUE,command:'AUTHENTICATE'},'WEBSOCKET',[this,'_login']);}}
else
if(aData.IQ[0].SUCCESS){this._state(2);this._buffer_flush();}
else
if(aData.IQ[0].FAILURE){this._state(0);}}
else
if(Is.String(aData)){this._create_iq({'RESPONSE':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-sasl'},VALUE:aData}]},[this,'_login',[true]],'',true);}}};_me._subscribe=function(aType,aHandler,aErrHandler){TeamChatAPI&&TeamChatAPI.Notifier.action('deviceid',{deviceid:dataSet.get('main',['device_id'])});if(aType=='ALL'){var aRequest={'SUBSCRIBE':[{ATTRIBUTES:{XMLNS:'api:iq:control'},'DEVICEID':[{VALUE:dataSet.get('main',['device_id'])}],'ITEMS':[{'ALL':[true]}]}]};}
else
if(Is.Array(aType)&&aType.length){var aRequest={'SUBSCRIBE':[{ATTRIBUTES:{XMLNS:'api:iq:control'},'DEVICEID':[{VALUE:dataSet.get('main',['device_id'])}],'ITEMS':[{'ITEM':[]}]}]};for(var i=0;aType.length>i;i++)
aRequest.SUBSCRIBE[0].ITEMS[0].ITEM.push({VALUE:aType[i]});}
this._create_iq(aRequest,[this,'__subscribers',[aHandler]],aErrHandler);};_me._unsubscribe=function(aType,aHandler,aErrHandler){if(Is.Array(aType)&&aType.length){var aRequest={'UNSUBSCRIBE':[{ATTRIBUTES:{XMLNS:'api:iq:control'},'ITEMS':[{'ITEM':[]}]}]};for(var i=0;aType.length>i;i++)
aRequest.UNSUBSCRIBE[0].ITEMS[0].ITEM.push({VALUE:aType[i]});this._create_iq(aRequest,[this,'__subscribers',[aHandler]],aErrHandler);}};_me.__subscribers=function(aResponse,aHandler){var iq,arr=[];if(aResponse.IQ&&(iq=aResponse.IQ[0])){var item,sub=iq.SUBSCRIBE||iq.UNSUBSCRIBE;if(sub[0].ITEMS&&(item=sub[0].ITEMS[0].ITEM))
for(var i in item)
arr.push(item[i].VALUE);}
if(aHandler)
executeCallbackFunction(aHandler,arr);};_me._notify=function(attr){if(this._onnotify)
this._onnotify(attr);this.__exeEvent('onnotify',attr,{"owner":this});};_me._linkpreview=function(sURL,aHandler,aErrHandler){if(Is.String(sURL)){var aRequest={'LINKPREVIEW':[{ATTRIBUTES:{XMLNS:'api:iq:control'},'URL':[{VALUE:sURL}]}]};this._create_iq(aRequest,[this,'__response',[aHandler]],aErrHandler);}};_me._pushGroupChatStatus=function(status,statusparam,handler,errHandler){var parts=dataSet.get('active_folder');if(parts){parts=parts.split('/');var active_folder=dataSet.get('folders',[parts.shift(),parts.join('/')]);if(active_folder){var msg={status:[{ATTRIBUTES:{xmlns:"api:iq:control"},email:[{VALUE:active_folder.OWNER}],folder:[{VALUE:active_folder.RELATIVE_PATH.replace('/','\\')}],status:[{VALUE:status}]}]};statusparam&&(msg.status[0].statusparam=[{VALUE:statusparam}]);this._create_iq(msg,handler,errHandler);}}};_me.__response=function(aResponse,aHandler){if(aHandler&&aResponse.IQ&&aResponse.IQ[0])
executeCallbackFunction(aHandler,aResponse.IQ[0]);};

/* client/inc/obj_websocket_generic.js */
_me=obj_websocket_generic.prototype;function obj_websocket_generic(){};_me.__constructor=function(){this.__state=0;this.__requests={};this.__buffer=[];this._idPrefix='';this.__errorID;this._parent._obeyEvent('onmessage',[this,'_onmessage']);this._parent._obeyEvent('onclose',[this,'_onclose']);this._parent._obeyEvent('onopen',[this,'_onopen']);this._parent._obeyEvent('onerror',[this,'_onerror']);};_me._state=function(v){if(Is.Defined(v)){this.__state=v;this._onstatechange&&this._onstatechange(this.__state);this.__exeEvent('onstatechange',this.__state,{"owner":this});}
else
return this.__state;};_me._request=function(aRq,aHandler,bNoBuffer){if(bNoBuffer||this._state()==2){this._parent._sendArray(aRq);aHandler&&executeCallbackFunction(aHandler);}
else{this.__buffer_queue(aRq,aHandler);if(this._parent._getState()==1&&this._state()==0&&this._login)
this._login();}};_me.__buffer_queue=function(aRq,aHandler,bTop){if(bTop)
this.__buffer.unshift({request:aRq,handler:aHandler});else
this.__buffer.push({request:aRq,handler:aHandler});};_me._buffer_flush=function(){var aRq;while(this.__buffer.length){aRq=this.__buffer.shift();this._parent._sendArray(aRq.request);if(aRq.handler)
executeCallbackFunction(aRq.handler);}};_me._buffer_size=function(){return this.__buffer.length;};

/* client/inc/obj_websocket_xmpp.js */
_me=obj_websocket_xmpp.prototype;function obj_websocket_xmpp(){};_me.__constructor=function(){this._idPrefix='xmpp-';this._add_destructor('_close');this._opt={status:'',statusText:'',resource:'WebClient-WS',resourceHash:'',imageHash:'',carbons:false};this.__streamBuffer={};};_me._init=function(){if(this._parent._getState()===1){this._onopen();}};_me._close=function(e){if(this._state()){this._state(0);this._parent._sendArray({'CLOSE':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-framing'}}]});}};_me._onstatechange=function(state){console.log('xmpp.state',state);if(state===0){if(dataSet.get('xmpp',['status'])!=='offline'){dataSet.add('xmpp',['status'],'offline');this.__exeEvent('status',{status:'offline',state:0});var ds=dataSet.get('xmpp',['roster']),bUpdate=false;for(var jid in ds){if(ds.hasOwnProperty(jid)){if(ds[jid].show&&ds[jid].show!='offline'){ds[jid].show='offline';ds[jid].status='';if(Is.Defined(ds[jid].active)){dataSet.update('xmpp',['roster',jid]);}
bUpdate=true;}
if(ds[jid].history){if(ds[jid].active){ds[jid].invalid_history=true;}
else{delete ds[jid].history;delete ds[jid].last_history;}}}}
bUpdate&&dataSet.update('xmpp',['roster']);dataSet.update('main',['im']);}}};_me._onclose=function(e){this._state(0);};_me._onopen=function(e){if(this._state()===0&&this._opt.status&&this._opt.status!='offline'){this._state(1);this._parent._sendArray({'OPEN':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-framing',VERSION:'1.0',TO:dataSet.get('main',['domain'])}}]});}};_me._onerror=function(e,bTerminate){console.warn('xmpp.error',e);if(bTerminate&&this._state()>0){this._state(0);this._close();}};_me._getResourceHash=function(){var hash;var account=SHA1(sPrimaryAccount);var xmpp_resource_hash=JSON.parse(localStorage.getItem('xmpp_resource_hash')||'{}');var account_resource_hashes=xmpp_resource_hash[account]||{};for(var i in account_resource_hashes){if(account_resource_hashes[i]+60000<+new Date()){hash=i;break;}}
if(!hash){hash=SHA1(unique_id()).slice(-6);xmpp_resource_hash[account]=xmpp_resource_hash[account]||{};this.__resourceHashUpdateInterval=setInterval(function(){xmpp_resource_hash[account][hash]=+new Date();localStorage.setItem('xmpp_resource_hash',JSON.stringify(xmpp_resource_hash));},59000);}
xmpp_resource_hash[account][hash]=+new Date();localStorage.setItem('xmpp_resource_hash',JSON.stringify(xmpp_resource_hash));return hash;};_me._onmessage=function(e,aResponse){if(aResponse.IQ&&aResponse.IQ[0].ATTRIBUTES&&aResponse.IQ[0].ATTRIBUTES.XMLNS==='http://icewarp.com/api/')
return;if(aResponse.OPEN){this._state(2);}
else
if(aResponse['STREAM:FEATURES']){this._login();return;this._onerror('STREAM:FEATURES',true);}
else
if(aResponse['STREAM:ERROR']){console.warn('xmpp.error',aResponse);if(aResponse['STREAM:ERROR'][0].CONFLICT){this._opt.resourceHash=this._getResourceHash();}}
else
if(aResponse.CHALLENGE){this.__login_challenge(aResponse);}
else
if(aResponse.SUCCESS){this._opt.resourceHash=this._opt.resourceHash||this._getResourceHash();this._create_iq({BIND:[{ATTRIBUTES:{XMLNS:"urn:ietf:params:xml:ns:xmpp-bind"},RESOURCE:[{VALUE:this._opt.resource+'-'+this._opt.resourceHash}]}]},{type:'set'},[function(aData){this._state(4);this._gateway_list(dataSet.get('main',['domain']),[function(){this._roster_get([function(){this._vcard('','',[function(){this._create_iq({SESSION:[{ATTRIBUTES:{XMLNS:"urn:ietf:params:xml:ns:xmpp-session"}}]},{type:'set'},[function(){console.log('xmpp.session','started');this._state(5);this._presence();this.__carbons_support();this._buffer_flush();}.bind(this)],[function(){this._onerror('session.start',true);}.bind(this)],true);}.bind(this)],[function(){this._onerror('vcard.get',true);}.bind(this)]);}.bind(this)],[function(){this._onerror('roster.get',true);}.bind(this)],true);}.bind(this)],[function(){this._onerror('gateway.list',true);}.bind(this)],true);}.bind(this)],[function(){this._onerror('bind',true);}.bind(this)],true);}
else
if(aResponse.FAILURE){this._state(0);}
else
if(aResponse.CLOSE){if(this._state()){this._state(0);return this._parent.__socket.onclose({wasClean:false});}}
if(aResponse.IQ){for(var i in aResponse.IQ){var id=aResponse.IQ[i].ATTRIBUTES.ID;if(id&&this.__requests[id]){var bError=false;if(aResponse.IQ[i].ATTRIBUTES.TYPE=='error'){bError=true;}
if(bError&&this.__requests[id].error)
aHandler=this.__requests[id].error;else
aHandler=this.__requests[id].response;delete this.__requests[id];if(aHandler)
executeCallbackFunction(aHandler,aResponse);}
var query;if(aResponse.IQ[i].QUERY&&(query=aResponse.IQ[i].QUERY[0])&&query.ATTRIBUTES){var sIQType=aResponse.IQ[i].ATTRIBUTES.TYPE;switch(query.ATTRIBUTES.XMLNS){case'jabber:iq:roster':this.__exeEvent('response','roster',query);break;case'http://jabber.org/protocol/disco#info':if(sIQType=='get'){var q=this._create_query({IDENTITY:[{ATTRIBUTES:{CATEGORY:'client',NAME:'IceWarp '+GWOthers.getItem('LOGIN_SETTINGS','version'),TYPE:'pc'}}],FEATURE:[{ATTRIBUTES:{VAR:'http://jabber.org/protocol/bytestreams'}},{ATTRIBUTES:{VAR:'http://jabber.org/protocol/si'}},{ATTRIBUTES:{VAR:'http://jabber.org/protocol/si/profile/file-transfer'}},{ATTRIBUTES:{VAR:'http://jabber.org/protocol/disco#info'}},{ATTRIBUTES:{VAR:'http://jabber.org/protocol/commands'}},{ATTRIBUTES:{VAR:'jabber:x:data'}},{ATTRIBUTES:{VAR:'http://jabber.org/protocol/geoloc+notify'}},{ATTRIBUTES:{VAR:'jabber:x:oob'}}]},'http://jabber.org/protocol/disco#info');q.QUERY[0].ATTRIBUTES.NODE='http://icewarp.com#'+GWOthers.getItem('LOGIN_SETTINGS','version');this._create_iq(q,{type:'result',id:aResponse.IQ[i].ATTRIBUTES.ID,to:aResponse.IQ[i].ATTRIBUTES.FROM});}
break;case'jabber:iq:oob':if(sIQType=='set'){var aX={X:[query],ATTRIBUTES:aResponse.IQ[i].ATTRIBUTES};this.__exeEvent('response','x',aX);}
break;case'http://jabber.org/protocol/bytestreams':if(query.STREAMHOST&&query.ATTRIBUTES&&query.ATTRIBUTES.SID&&this.__streamBuffer[query.ATTRIBUTES.SID]){storage.library('sha1');var out=[];var sHash=SHA1(query.ATTRIBUTES.SID+aResponse.IQ[i].ATTRIBUTES.FROM+aResponse.IQ[i].ATTRIBUTES.TO);for(var j in query.STREAMHOST){out.push({jid:query.STREAMHOST[j].ATTRIBUTES.JID,host:query.STREAMHOST[j].ATTRIBUTES.HOST+(query.STREAMHOST[j].ATTRIBUTES.PORT?':'+query.STREAMHOST[j].ATTRIBUTES.PORT:''),hash:sHash});}
var oUpload=new wm_upload();oUpload.socks_connect(out,[this,'_socks_connect',[query.ATTRIBUTES.SID,aResponse.IQ[i].ATTRIBUTES.ID,aResponse.IQ[i].ATTRIBUTES.FROM]]);}
break;}}
if(aResponse.IQ[i].SI&&aResponse.IQ[i].SI[0].FILE){var si=aResponse.IQ[i].SI[0];si.FROM=[{VALUE:aResponse.IQ[i].ATTRIBUTES.FROM}];si.ID=[{VALUE:id}];this.__exeEvent('response','download',si);}}}
if(aResponse.PRESENCE){var attr,presenceBuffer={};aResponse.PRESENCE.sort(function(a,b){var a=a.ATTRIBUTES||{},b=b.ATTRIBUTES||{};if(a.TYPE==b.TYPE)
return 0;else
if(a.TYPE=='unavailable')
return-1;else
if(b.TYPE=='unavailable')
return 1;});for(var i in aResponse.PRESENCE){if(aResponse.PRESENCE[i].ERROR){this.__exeEvent('response','error',aResponse.PRESENCE[i].ERROR[0]);continue;}
attr=aResponse.PRESENCE[i].ATTRIBUTES||{};if(attr.FROM){var sFrom=attr.FROM.split('/').shift().toLowerCase();if(sFrom!==sPrimaryAccount){if(!presenceBuffer[sFrom])
presenceBuffer[sFrom]={status:this._user_status(sFrom),probe:false};presenceBuffer[sFrom].probe=presenceBuffer[sFrom].status!=='offline'&&attr.TYPE==='unavailable';}}
if(!~['subscribe','unavailable','subscribed','unsubscribe','unsubscribed'].indexOf(attr.TYPE)){attr.TYPE='state_change';}
this.__exeEvent('response',attr.TYPE,aResponse.PRESENCE[i]);}
for(var sFrom in presenceBuffer){if(presenceBuffer.hasOwnProperty(sFrom)&&presenceBuffer[sFrom].probe)
this._request(this._create_presence('','probe',sFrom));}}
if(aResponse.MESSAGE){for(var i in aResponse.MESSAGE){var aMessage=aResponse.MESSAGE[i],sType='',data='';if(aMessage.ERROR){sType='error';data=aMessage.ERROR[0];}
else
if(aMessage.COMPOSING){sType='composing',data=aMessage.ATTRIBUTES.FROM;}
else
if(aMessage.PAUSED){sType='paused',data=aMessage.ATTRIBUTES.FROM;}
else
if(aMessage.GONE){sType='gone',data=aMessage.ATTRIBUTES.FROM;}
else
if(aMessage.EVENT){sType='event',data=aMessage;}
else
if(aMessage.X){sType='x',data=aMessage;}
else
if(aMessage.BODY){sType='message',data=aMessage;}
else
if(aMessage.SENT&&aMessage.SENT[0].FORWARDED){sType='sent',data=aMessage.SENT[0].FORWARDED[0];}
else
if(aMessage.RECEIVED&&aMessage.RECEIVED[0].FORWARDED){sType='received',data=aMessage.RECEIVED[0].FORWARDED[0];}
this.__exeEvent('response',sType,data);}}};_me._login=function(){switch(this._state()){case 0:this._init();break;case 2:this._state(3);this._parent._sendArray({'AUTH':[{ATTRIBUTES:{XMLNS:'jabber:iq:auth'},MECHANISM:[{VALUE:'DIGEST-MD5'}]}]});}};_me.__login_challenge=function(aResponse){auth.get_digest({hash:aResponse.CHALLENGE[0].VALUE,command:'AUTHENTICATE'},'WEBSOCKET',[function(aData){this._parent._sendArray({'RESPONSE':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-sasl'},VALUE:aData}]});}.bind(this)]);};_me._request=function(aRq,aHandler,bNoBuffer){if(bNoBuffer||this._state()>3){this._parent._sendArray(aRq);aHandler&&executeCallbackFunction(aHandler);}
else{this.__buffer_queue(aRq,aHandler);if(this._parent._getState()===1&&this._state()===0)
this._login();}};_me._create_iq=function(aData,opt,aHandler,aErrHandler,bNoBuffer){var sType=opt.type||'get',sTo=opt.to,id=opt.id;if(!Is.Defined(id))
do{var id=this._idPrefix+unique_id()}while(this.__requests[id]);var aData=aData||{};if(!aData.ATTRIBUTES)
aData.ATTRIBUTES={};aData.ATTRIBUTES.ID=id;if(sType)
aData.ATTRIBUTES.TYPE=sType;if(sTo)
aData.ATTRIBUTES.TO=sTo;var iq={IQ:[aData]};this.__requests[id]={type:'iq',request:iq,data:aData,response:aHandler,error:aErrHandler};this._request(iq,null,bNoBuffer);};_me._create_query=function(aData,sXMLns){var aRequest={'QUERY':[{}]};if(aData)
aRequest.QUERY=[aData];if(sXMLns){if(!aRequest.QUERY[0].ATTRIBUTES)
aRequest.QUERY[0].ATTRIBUTES={};aRequest.QUERY[0].ATTRIBUTES['XMLNS']=sXMLns;}
return aRequest;};_me._create_message=function(aData,sType,sTo){var aRequest={MESSAGE:[]},tmp={};if(typeof sTo=='string')
sTo=[sTo];for(var i in sTo)
if(sTo[i]){if(aData)
tmp=clone(aData,true);else
tmp={};if(!tmp.ATTRIBUTES)
tmp.ATTRIBUTES={};if(sType)
tmp.ATTRIBUTES.TYPE=sType;tmp.ATTRIBUTES.TO=sTo[i];aRequest.MESSAGE.push(tmp);}
return aRequest;};_me._create_presence=function(aData,sType,sTo){var aRequest={PRESENCE:[{}]};if(aData)
aRequest.PRESENCE=[aData];if(!aRequest.PRESENCE[0].ATTRIBUTES)
aRequest.PRESENCE[0].ATTRIBUTES={};aRequest.PRESENCE[0].ATTRIBUTES.XMLNS="jabber:client";aRequest.PRESENCE[0].ATTRIBUTES.FROM=sPrimaryAccount+'/'+this._opt.resource+'-'+this._opt.resourceHash;if(sType)
aRequest.PRESENCE[0].ATTRIBUTES.TYPE=sType;if(sTo)
aRequest.PRESENCE[0].ATTRIBUTES.TO=sTo;return aRequest;};_me.__carbons_support=function(){this._create_iq(this._create_query('','http://jabber.org/protocol/disco#info'),{type:'get',to:dataSet.get('main',['domain'])},[function(aData){if(aData.IQ){aData=aData.IQ[0];if(aData.QUERY){var aFeatures=aData.QUERY[0].FEATURE;for(var id in aFeatures){if(aFeatures.hasOwnProperty(id)&&aFeatures[id].ATTRIBUTES&&aFeatures[id].ATTRIBUTES.VAR==="urn:xmpp:carbons:2"){var aData={ENABLE:[{ATTRIBUTES:{XMLNS:"urn:xmpp:carbons:2"}}]};this._create_iq(aData,{type:'set'},[function(aData){if(aData.IQ){aData=aData.IQ[0];if(aData&&aData.ATTRIBUTES&&aData.ATTRIBUTES.TYPE==="result"){console.log('xmpp.carbons','active');this._opt.carbons=true;}}}.bind(this)]);break;}}}}}.bind(this)]);};_me._presence=function(sStatus,sStatusText,aHandler){var state=this._state(),aExtHandler=[function(){dataSet.add('xmpp',['statusText'],this._opt.statusText);if(dataSet.get('xmpp',['status'])!==this._opt.status){dataSet.add('xmpp',['status'],this._opt.status);this.__exeEvent('status',{status:this._opt.status,state:state});dataSet.update('main',['im']);}
aHandler&&executeCallbackFunction(aHandler);}.bind(this)];this._opt.status=(sStatus||this._opt.status||'').toLowerCase();this._opt.statusText=Is.Defined(sStatusText)?sStatusText:this._opt.statusText;if(this._opt.status=='offline'){if(state===5){var rq=this._create_presence({STATUS:[{VALUE:'Logged out'}]},'unavailable');this._request(rq,[function(){this._close();executeCallbackFunction(aExtHandler);}.bind(this)]);}
else{if(state>0)
this._close();executeCallbackFunction(aExtHandler);}}
else
if(this._opt.status){switch(state){case 5:var aPresence={PRIORITY:[{VALUE:5}],STATUS:[{VALUE:this._opt.statusText}],C:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/caps",NODE:"http://psi-im.org/caps",VER:GWOthers.getItem('LOGIN_SETTINGS','version')}}],X:[{ATTRIBUTES:{XMLNS:'vcard-temp:x:update'},PHOTO:[{VALUE:this._opt.imageHash}]}]};if(this._opt.status!='online')
aPresence.SHOW=[{VALUE:this._opt.status}];this._request(this._create_presence(aPresence),aExtHandler);break;default:this._close();case 0:this._init();}}};_me._gateway_list=function(sDomain,aHandler,aErrHandler,bNoBuffer){this._create_iq(this._create_query('','http://jabber.org/protocol/disco#items'),{to:sDomain},[this,'__gateways_parse',[aHandler]],aErrHandler,bNoBuffer);};_me.__gateways_parse=function(aData,aHandler){var aGateways={};if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.QUERY&&aData.QUERY[0]&&(aData=aData.QUERY[0].ITEM)){for(var i in aData){aData[i].ATTRIBUTES.TYPE&&aData[i].ATTRIBUTES.TYPE.toLowerCase();aGateways[aData[i].ATTRIBUTES.JID]=aData[i].ATTRIBUTES;}
dataSet.add('xmpp',['gateways'],aGateways);}
if(aHandler)
executeCallbackFunction(aHandler,aGateways);};_me._gateway_registr=function(aData,sTo,aHandler){this._create_iq(this._create_query(aData,'jabber:iq:register'),{type:aData?'set':'get',to:sTo},aHandler);};_me._vcard=function(sTo,aValue,aHandler,aErrHandler){var aData={vCard:[{}]};if(aValue)
aData.vCard[0]=aValue;aData.vCard[0].ATTRIBUTES={xmlns:"vcard-temp",version:'2.0',prodid:'-//HandGen//NONSGML vGen v1.0//EN'};this._create_iq(aData,{type:aValue?'set':'get',to:sTo||sPrimaryAccount},sTo?aHandler:[this,'__photo_hash',[aHandler]],aErrHandler,!aValue&&!sTo);};_me.__photo_hash=function(aData,aHandler){if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.VCARD&&aData.VCARD[0]&&(aData=aData.VCARD[0])){if(aData.PHOTO&&aData.PHOTO[0]&&aData.PHOTO[0].TYPE&&aData.PHOTO[0].BINVAL){storage.library('sha1');this._opt.imageHash=SHA1(base64.decode(aData.PHOTO[0].BINVAL[0].VALUE));}
else
this._opt.imageHash='';}
if(aHandler){executeCallbackFunction(aHandler,aData);}};_me._oob_cancel=function(aData,sTo){if(sTo){var q=this._create_query(aData,'jabber:iq:oob');q.ERROR=[{ATTRIBUTES:{CODE:406,TYPE:'modify'},'NOT-ACCEPTABLE':[{ATTRIBUTES:{XMLNS:'urn:ietf:params:xml:ns:xmpp-stanzas'}}]}];this._create_iq(q,{type:'error',to:sTo});}};_me._stream_cancel=function(sTo){if(sTo)
this._create_iq({ERROR:[{ATTRIBUTES:{CODE:403},VALUE:'Declined'}]},{type:'error',to:sTo});};_me._stream_accept=function(aData,sID,sTo){if(sID&&sTo&&aData&&aData.ATTRIBUTES&&aData.ATTRIBUTES.ID&&aData.FILE&&aData.FILE[0].ATTRIBUTES&&aData.FILE[0].ATTRIBUTES.NAME&&aData.FILE[0].ATTRIBUTES.SIZE){var si={SI:[{ATTRIBUTES:{XMLNS:'http://jabber.org/protocol/si'},FEATURE:[{ATTRIBUTES:{XMLNS:'http://jabber.org/protocol/feature-neg'},X:[{ATTRIBUTES:{XMLNS:'jabber:x:data',TYPE:'submit'},FIELD:[{ATTRIBUTES:{VAR:'stream-method'},VALUE:[{VALUE:'http://jabber.org/protocol/bytestreams-oob'}]}]}]}]}]};this.__streamBuffer[aData.ATTRIBUTES.ID]={name:aData.FILE[0].ATTRIBUTES.NAME,size:aData.FILE[0].ATTRIBUTES.SIZE};this._create_iq(si,{type:'result',id:sID,to:sTo});}};_me._socks_connect=function(aData,sSID,sFrom){if(aData){var out=this.__streamBuffer[sSID];if(out&&sFrom){out.jid=aData.jid;out.socket=aData.socket;this._create_iq(this._create_query({'STREAMHOST-USED':[{ATTRIBUTES:{JID:out.jid}}]},'http://jabber.org/protocol/bytestreams'),{type:'result',to:sFrom},[function(){this.__exeEvent('response','streamhost',out);}.bind(this)]);}}
else
this.__exeEvent('response','streamhost');delete this.__streamBuffer[sSID];};_me._stream_send=function(sFolder,sFile,sClass,iSize,sName,sTo,sDesc){if(!iSize){storage.library('wm_upload');var up=new wm_upload();up.extract(sFolder,sFile,sClass,[this,'_stream_send',[sTo,sDesc]]);return;}
storage.library('sha1');var sHash=SHA1(unique_id()+sPrimaryAccount+'/WebClient'+sTo);var q={SI:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/si",PROFILE:"http://jabber.org/protocol/si/profile/file-transfer",ID:sHash},FILE:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/si/profile/file-transfer",SIZE:iSize||'0',NAME:sName},DESC:[{VALUE:sDesc}]}],FEATURE:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/feature-neg"},X:[{ATTRIBUTES:{XMLNS:"jabber:x:data",TYPE:"form"},FIELD:[{ATTRIBUTES:{TYPE:"list-single",VAR:"stream-method"},OPTION:[{VALUE:[{VALUE:'http://jabber.org/protocol/bytestreams'}]}]}]}]}]}]};this._create_iq(q,{type:'set',to:sTo},[this,'_stream_support',[sHash,sFolder,sFile,sClass,sDesc]]);};_me._stream_support=function(aData,sHash,sFolder,sFile,sClass,sDesc){if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.ATTRIBUTES&&aData.ATTRIBUTES.TYPE=='result'){var bSupport=false;try{bSupport=aData.SI[0].FEATURE[0].X[0].FIELD[0].VALUE[0].VALUE=='http://jabber.org/protocol/bytestreams'&&aData.SI[0].FEATURE[0].X[0].FIELD[0].ATTRIBUTES.VAR=='stream-method';}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r)}
if(bSupport){var q=this._create_query('','http://jabber.org/protocol/bytestreams');q.QUERY[0].ATTRIBUTES.MODE='tcp';q.QUERY[0].ATTRIBUTES.SID=sHash;q.QUERY[0].STREAMHOST=[{ATTRIBUTES:{'JID':GWOthers.getItem('STREAMHOST','jid'),'HOST':GWOthers.getItem('STREAMHOST','host'),'PORT':GWOthers.getItem('STREAMHOST','port')}}];this._create_iq(q,{type:'set',to:aData.ATTRIBUTES.FROM},[this,'_stream_upload',[sHash,sFolder,sFile,sClass]]);}
else{this._oob_send(sFolder,sFile,sClass,aData.ATTRIBUTES.FROM,sDesc);}}
else{gui.notifier._value({type:'alert',args:{header:'IM::SEND_FILE',text:'IM::ERROR_CANCEL'}});this.__exeEvent('response','notice',{FROM:aData.ATTRIBUTES.FROM,TEXT:getLang('IM::ERROR_CANCEL')});}};_me._stream_upload=function(aData,sHash,sFolder,sFile,sClass){if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.ATTRIBUTES&&aData.ATTRIBUTES.TYPE=='result'&&aData.QUERY&&aData.QUERY[0]['STREAMHOST-USED']&&aData.QUERY[0]['STREAMHOST-USED'][0].ATTRIBUTES&&aData.QUERY[0]['STREAMHOST-USED'][0].ATTRIBUTES.JID==GWOthers.getItem('STREAMHOST','jid')){storage.library('wm_upload');storage.library('sha1');var sHash=SHA1(sHash+sPrimaryAccount+'/WebClient'+aData.ATTRIBUTES.FROM);var up=new wm_upload();up.socket(sFolder,sFile,sClass,sHash,[function(){this.__exeEvent('response','bytestream',arguments);}.bind(this)]);}
else
gui.notifier._value({type:'alert',args:{header:'IM::SEND_FILE',text:'IM::ERROR_BYTESTREAM'}});};_me._oob_send=function(sFolder,sFile,sClass,sTo,sDesc){storage.library('wm_upload');var up=new wm_upload();up.ticket(sFolder,sFile,sClass,[this,'_oob_support',[sTo,sDesc]]);};_me._oob_support=function(aData,sTo,sDesc){if(aData.ticket){this._create_iq(this._create_query('','http://jabber.org/protocol/disco#info'),{to:sTo},[this,'_oob_upload',[aData,sTo,sDesc]]);}
else
gui.notifier._value({type:'alert',args:{header:'',text:'IM::ERROR_TICKET'}});};_me._oob_upload=function(aData,aTicket,sTo,sDesc){var sURL=document.location.href;sURL=sURL.substr(0,sURL.lastIndexOf('/')+1)+'server/download.php/ticket/'+encodeURIComponent(aTicket.ticket)+'/'+encodeURIComponent(aTicket.name);var f;if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.QUERY&&aData.QUERY[0]&&(f=aData.QUERY[0].FEATURE))
for(var i in f)
if(f[i].ATTRIBUTES&&f[i].ATTRIBUTES.VAR=='jabber:iq:oob'){var q={URL:[{VALUE:sURL}],DESC:[{VALUE:sDesc}]};this._create_iq(this._create_query(q,'jabber:iq:oob'),{type:'set',to:sTo},[this,'_oob_finish']);return;}
this._message(sTo,getLang('IM::FILE_MESSAGE',[sDesc||'',sURL]));};_me._oob_finish=function(aData,aHandler){if(aData&&aData.IQ&&(aData=aData.IQ[0])){if(aData.ERROR)
gui.notifier._value({type:'alert',args:{header:'',text:'IM::FILE_CANCEL'}});else
if(aData.ATTRIBUTES&&aData.ATTRIBUTES.TYPE=='error')
gui.notifier._value({type:'alert',args:{header:'',text:'IM::FILE_ERROR'}});else
gui.notifier._value({type:'alert',args:{header:'',text:'IM::FILE_OK'}});aHandler&&executeCallbackFunction(aHandler);}};_me._file_upload=function(sTo,aArg,aHandler){var sStatus=Is.Array(sTo)?'offline':this._user_status(sTo);if(sStatus=='offline')
this._xlink(sTo,aArg,aHandler);else{this._create_iq(this._create_query('','http://jabber.org/protocol/disco#info'),{to:sTo},[this,'_file_upload_support',[sTo,aArg,aHandler]]);}};_me._file_upload_support=function(aData,sTo,aArg,aHandler){var f,s='msg';if(aData&&aData.IQ&&(aData=aData.IQ[0])&&aData.QUERY&&aData.QUERY[0]&&(f=aData.QUERY[0].FEATURE))
for(var i in f)
if(f[i].ATTRIBUTES&&f[i].ATTRIBUTES.VAR)
if(f[i].ATTRIBUTES.VAR=='jabber:x:oob')
s='x';switch(s){case'oob':this._ooblink(sTo,aArg,aHandler);break;case'x':this._xlink(sTo,aArg,aHandler);break;default:var sBody=getLang('IM::FILE_MESSAGE',[aArg.desc||'',aArg.link]);this._message(sTo,sBody,aHandler);}};_me._ooblink=function(sTo,aArg,aHandler){if(sTo){var q={URL:[{VALUE:aArg.link}],DESC:[{VALUE:aArg.desc||''}],SIZE:[{VALUE:aArg.size||0}]};this._create_iq(this._create_query(q,'jabber:iq:oob'),{type:'set',to:sTo},[this,'_oob_finish',[aHandler]]);}};_me._xlink=function(sTo,aArg,aHandler){if(sTo){var aData={DISPLAYED:[{ATTRIBUTES:{XMLNS:"rn:xmpp:chat-markers:0"}}],X:[{ATTRIBUTES:{XMLNS:"jabber:x:oob"},URL:[{VALUE:aArg.link}],DESC:[{VALUE:aArg.desc||''}],SIZE:[{VALUE:aArg.size||0}]}]};this._request(this._create_message(aData,'chat',sTo),aHandler);}};_me._roster_get=function(aHandler,aErrorHandler,bNoBuffer){this._create_iq({QUERY:[{ATTRIBUTES:{XMLNS:"jabber:iq:roster"}}]},{},[this,'__roster_parse',[aHandler]],aErrorHandler,bNoBuffer);};_me.__roster_parse=function(aData,aHandler){if(aData&&aData.IQ&&aData.IQ[0].QUERY&&(aData=aData.IQ[0].QUERY[0])){var sSub,sJID,sName,sGroup,oldShow,bRefresh,bRefreshJid,aGateways=dataSet.get('xmpp',['gateways'])||{};for(var i in aData.ITEM){sSub=aData.ITEM[i].ATTRIBUTES.SUBSCRIPTION;sJID=aData.ITEM[i].ATTRIBUTES.JID;sName=aData.ITEM[i].ATTRIBUTES.NAME;sGroup=aData.ITEM[i].GROUP?aData.ITEM[i].GROUP[0].VALUE:'*';if(sSub=='remove')
dataSet.remove('xmpp',['roster',sJID],true);else{oldShow=dataSet.get('xmpp',['roster',sJID,'show']);bRefreshJid=Is.Boolean(dataSet.get('xmpp',['roster',sJID,'active']));if(!oldShow||sSub!='both'||(sSub=='both'&&(oldShow=='from'||oldShow=='to')))
dataSet.add('xmpp',['roster',sJID,'show'],sSub,!bRefreshJid);dataSet.add('xmpp',['roster',sJID,'name'],sName,!bRefreshJid);dataSet.add('xmpp',['roster',sJID,'user'],sJID,true);dataSet.add('xmpp',['roster',sJID,'group'],sGroup,true);var tmp=aGateways[sJID];if(tmp||((tmp=sJID.indexOf('@'))>-1&&(tmp=aGateways[sJID.substr(tmp+1)])))
dataSet.add('xmpp',['roster',sJID,'type'],tmp.TYPE,true);}
bRefresh=true;}
if(bRefresh)
dataSet.update('xmpp',['roster']);}
aHandler&&executeCallbackFunction(aHandler);};_me._history_get=function(aData,aHandler){var q={RETRIEVE:[{ATTRIBUTES:{XMLNS:'urn:xmpp:archive',WITH:aData.from},SET:[{ATTRIBUTES:{XMLNS:'http://jabber.org/protocol/rsm'}}]}]};if(aData['start'])
q.RETRIEVE[0].ATTRIBUTES.START=typeof aData['start']=='date'?aData['start'].format('imDateTime'):aData['start'];if(aData['search'])
q.RETRIEVE[0].BODY=[{VALUE:aData['search']}];if(aData['max'])
q.RETRIEVE[0].SET[0].MAX=[{VALUE:aData['max']}];if(typeof aData['before']!='undefined')
q.RETRIEVE[0].SET[0].BEFORE=[{VALUE:aData['before']||''}];if(aData['after'])
q.RETRIEVE[0].SET[0].AFTER=[{VALUE:aData['after']}];this._create_iq(q,{},aHandler);};_me._user_status=function(sJID,bReal){var sStatus;if(!sJID||sJID===sPrimaryAccount)
sStatus=dataSet.get('xmpp',['status']);else{sStatus=dataSet.get('xmpp',['roster',sJID,'show']);if(!bReal&&(sStatus=='none'||sStatus=='both'))
sStatus='offline';}
return sStatus||'offline';};_me._user_add=function(sJID,sName,sGroup,aHandler){this._user_rename(sJID,sName,sGroup,[this,'_user_subscribe',[sJID,aHandler]]);};_me._user_rename=function(sJID,sName,sGroup,aHandler){if(sJID){var aData={ITEM:[{ATTRIBUTES:{jid:sJID}}]};if(sGroup)
aData.ITEM[0].GROUP=[{VALUE:sGroup}];if(sName)
aData.ITEM[0].ATTRIBUTES.NAME=sName;this._create_iq(this._create_query(aData,'jabber:iq:roster'),{type:'set'},aHandler);}};_me._group_rename=function(sGroup,sNewGroup,aHandler){var ds=dataSet.get('xmpp',['roster']);for(var sJID in ds)
if(ds[sJID].group==sGroup)
this._user_rename(sJID,ds[sJID].name,sNewGroup);aHandler&&executeCallbackFunction(aHandler);};_me._user_remove=function(aJID,aHandler){if(aJID.length){var aData;for(var i in aJID){aData={ITEM:[{ATTRIBUTES:{subscription:'remove',jid:aJID[i]}}]};this._create_iq(this._create_query(aData,'jabber:iq:roster'),{type:'set'});if(aJID[i].indexOf('@')<0)
this._create_iq(this._create_query({'REMOVE':[{}]},'jabber:iq:register'),{type:'set',to:aJID[i]});}
if(aHandler)
executeCallbackFunction(aHandler);}};_me._user_subscribe=function(sJID,aHandler){if(sJID)
this._request(this._create_presence('','subscribe',sJID),aHandler);};_me._user_subscribed=function(sJID,aHandler){if(sJID){this._request(this._create_presence('','subscribed',sJID));this._request(this._create_presence('','subscribe',sJID));executeCallbackFunction(aHandler);}};_me._user_unsubscribed=function(sJID,aHandler){if(sJID)
this._request(this._create_presence('','unsubscribed',sJID),aHandler);};_me._invitation=function(sTo,sBody,aHandler){if(sTo){var aData={BODY:[{VALUE:sBody}],X:[{ATTRIBUTES:{XMLNS:"jabber:x:icewarpconference"},ID:[{VALUE:dataSet.get('conference',['id'])||0}]}],ACTIVE:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/chatstates"}}]};this._request(this._create_message(aData,'chat',sTo),aHandler);}};_me._message=function(sTo,sBody,aHandler){var aData={BODY:[{VALUE:sBody}],ACTIVE:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/chatstates"}}]};this._request(this._create_message(aData,'chat',sTo),aHandler);};_me._msg_status=function(sTo,sType,aHandler){if(sTo&&this._state()===5){var aData={};aData[sType.toUpperCase()]=[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/chatstates"}}];this._request(this._create_message(aData,'chat',sTo),aHandler);}};_me._geo=function(sTo,aArg,aHandler){if(sTo){var aData={DISPLAYED:[{ATTRIBUTES:{XMLNS:"rn:xmpp:chat-markers:0"}}],EVENT:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/pubsub#event"},ITEMS:[{ATTRIBUTES:{NODE:"http://jabber.org/protocol/geoloc"},ITEM:[{GEOLOC:[{ATTRIBUTES:{XMLNS:"http://jabber.org/protocol/geoloc",'XML\:LANG':"en"},LAT:[{VALUE:aArg.lat}],LON:[{VALUE:aArg.lon}]}]}]}]}]};this._request(this._create_message(aData,'chat',sTo),aHandler);}};_me._updatePresencePhoto=function(){if(this._user_status()!=='offline'){this._vcard('','',[function(){this._presence();}.bind(this)]);}};

/* client/inc/obj_wysiwyg.js */
_me=obj_wysiwyg.prototype;function obj_wysiwyg(){}
_me.__constructor=function(opt){var me=this,lang=GWOthers.getItem('LAYOUT_SETTINGS','language')||'en';this.__opt=opt||{};this.__aAvailableFontSizes=[10,13,16,18,24,32];this.__sDefaultFontSize=13;this.__allowTabElements={'TD':1,'TH':1,'UL':1,'LI':2,'OL':2};if(lang!=='en'){var languages={ar:'ar',bs:'bs',cs:'cs',da:'da',de:'de',el:'el',en:'en_gb',es:'es',et:'et',fa:'fa',fi:'fi',fr:'fr',he:'he',hr:'hr',hu:'hu',id:'id',it:'it',ja:'ja',ko:'ko',ku:'ku',me:'me',nb:'nb',nl:'nl',pl:'pl',pt:'pt_br',ro:'ro',ru:'ru',sk:'sk',sr:'sr',sv:'sv',th:'th',tr:'tr',uk:'uk',vi:'vi',cn:'zh_cn'};if(languages[lang])
storage.library('languages/'+languages[lang],'froala');}
this._tableStyles=[{label:getLang('COMPOSE::DOTTED_BORDER'),class:'fr-table-border-style-dotted',styles:[{selector:'.fr-table-border-style-dotted',style:{'border-style':'dotted!important'}},{selector:'.fr-table-border-style-dotted td',style:{'border':'1px dotted #000'}}]},{label:getLang('COMPOSE::DASHED_BORDER'),class:'fr-table-border-style-dashed',styles:[{selector:'.fr-table-border-style-dashed',style:{'border-style':'dashed!important'}},{selector:'.fr-table-border-style-dashed td',style:{'border':'1px dashed #000'}}]},{label:getLang('COMPOSE::SOLID_BORDER'),class:'fr-table-border-style-solid',styles:[{selector:'.fr-table-border-style-solid',style:{'border-style':'solid!important'}},{selector:'.fr-table-border-style-solid td',style:{'border':'1px solid #000'}}]},{label:getLang('COMPOSE::COLLAPSED_BORDER'),class:'fr-table-border-collapse-collapse',styles:[{selector:'.fr-table-border-collapse-collapse',style:{'border-collapse':'collapse'}}]}];this._tableCellStyles=[{label:getLang('COMPOSE::DOTTED_BORDER'),class:'fr-table-cell-border-style-dotted',styles:[{selector:'td.fr-table-cell-border-style-dotted',style:{'border':'1px dotted #000'}}]},{label:getLang('COMPOSE::DASHED_BORDER'),class:'fr-table-cell-border-style-dashed',styles:[{selector:'td.fr-table-cell-border-style-dashed',style:{'border':'1px dashed #000'}}]},{label:getLang('COMPOSE::SOLID_BORDER'),class:'fr-table-cell-border-style-solid',styles:[{selector:'td.fr-table-cell-border-style-solid',style:{'border':'1px solid #000'}}]}];storage.library('textversion','textversion');storage.library('froala_editor.min','froala');storage.library('plugins/align.min','froala');storage.library('plugins/colors.min','froala');storage.library('plugins/draggable.min','froala');storage.library('plugins/entities.min','froala');storage.library('plugins/font_family.min','froala');storage.library('plugins/font_size.min','froala');storage.library('plugins/image.min','froala');storage.library('plugins/link.min','froala');storage.library('plugins/lists.min','froala');storage.library('plugins/paragraph_format.min','froala');storage.library('plugins/paragraph_style.min','froala');storage.library('plugins/table.min','froala');storage.library('plugins/word_paste.min','froala');if(!document.head.querySelector('#font-awesome')){document.head.appendChild(function(){var style=document.createElement('link');style.setAttribute('id','font-awesome');style.setAttribute('rel','stylesheet');style.setAttribute('type','text/css');style.setAttribute('href','https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css');return style;}());}
msiebox(this._getAnchor('msiebox'));var scrollableContainer=this._getAnchor('frame');FroalaEditor.DefineIcon('imageSmall',{NAME:getLang('RICH::IMG_SMALL'),SVG_KEY:'alignCenter'});FroalaEditor.RegisterCommand('imageSmall',{title:getLang('RICH::IMG_SMALL'),focus:true,undo:true,refreshAfterCallback:true,callback:function(){var activeImage=this.image.get()[0];activeImage.style.maxWidth='';var w=activeImage.style.width,h=activeImage.style.height;w=!~w.indexOf('%')&&parseFloat(w)||activeImage.naturalWidth,h=!~h.indexOf('%')&&parseFloat(h)||activeImage.naturalHeight;if(w>800){activeImage.style.width=800+'px';activeImage.style.height=800*(h/w)+'px';}else if(h>600){activeImage.style.width=600*(w/h)+'px';activeImage.style.height=600+'px';}else if(w>640){activeImage.style.width=640+'px';activeImage.style.height=640*(h/w)+'px';}else if(h>480){activeImage.style.width=480*(w/h)+'px';activeImage.style.height=480+'px';}
activeImage.click();}});FroalaEditor.DefineIcon('imageFit',{NAME:getLang('RICH::IMG_ADAPT'),SVG_KEY:'fullscreen'});FroalaEditor.RegisterCommand('imageFit',{title:getLang('RICH::IMG_ADAPT'),focus:true,undo:true,refreshAfterCallback:true,callback:function(){var activeImage=this.image.get()[0];activeImage.style.width='100%';activeImage.style.maxWidth=activeImage.naturalWidth+'px';activeImage.style.height='';activeImage.click();}});FroalaEditor.DefineIcon('imageOriginal',{NAME:getLang('RICH::IMG_ORIGINAL'),SVG_KEY:'imageSize'});FroalaEditor.RegisterCommand('imageOriginal',{title:getLang('RICH::IMG_ORIGINAL'),focus:true,undo:true,refreshAfterCallback:true,callback:function(){var activeImage=this.image.get()[0];activeImage.style.width=activeImage.naturalWidth+'px';activeImage.style.height=activeImage.naturalHeight+'px';activeImage.style.maxWidth='';activeImage.click();}});FroalaEditor.DefineIcon('imageEdit',{NAME:getLang('RICH::IMAGE'),SVG_KEY:'insertImage'});FroalaEditor.RegisterCommand('imageEdit',{title:getLang('RICH::IMAGE'),focus:true,undo:true,refreshAfterCallback:true,callback:function(){this.popups.hideAll();me.__initpopup('I',false,{image:this.image.get()[0]});}});this._editor=new FroalaEditor(scrollableContainer,{enter:FroalaEditor.ENTER_DIV,scrollableContainer:scrollableContainer,useClasses:false,key:'eHE5C-11E2C2H2D2B2A3D-17d1F1FOOLb2KOPQGe1CWCQVTDWXGcA5A4D4D3E4C2H3E3D1B3==',height:'100%',iframe:true,charCounterCount:false,toolbarButtons:[],spellcheck:true,language:lang,disableRightClick:false,pasteDeniedAttrs:[],pasteAllowedStyleProps:['width','height'],imageEditButtons:['imageSmall','imageFit','imageOriginal','-','imageEdit','imageRemove','-','imageLink','linkOpen','linkEdit','linkRemove'],linkEditButtons:['linkOpen','linkEdit','linkRemove'],linkInsertButtons:['linkBack'],tableInsertHelper:false,tableEditButtons:['tableRows','tableColumns','tableCells','tableStyle','-','tableCellVerticalAlign','tableCellHorizontalAlign','tableCellBackground','tableCellStyle','-','tableRemove'],tableStyles:this._tableStyles.reduce(function(acc,cur){acc[cur.class]=cur.label;return acc;},{}),tableCellStyles:this._tableCellStyles.reduce(function(acc,cur){acc[cur.class]=cur.label;return acc;},{}),iframeDefaultStyle:[].concat(me._tableStyles,me._tableCellStyles).map(function(style){return style.styles.map(function(style){return style.selector+'{'+Object.keys(style.style).map(function(prop){return prop+':'+style.style[prop];}).join(';')+'}';}).join('');}).join(''),iframeStyleFiles:['font.css','froala_editor.css','froala_plugins_table.css','obj_rich_body.css'].map(function(file){return'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/css/css.php?'+buildURL({skin:GWOthers.getItem('LAYOUT_SETTINGS','skin'),palette:GWOthers.getItem('LAYOUT_SETTINGS','skin_style'),file:file});}),imagePaste:false,events:{initialized:function(){me.__initialized=true;setTimeout(function(){me.__nightMode();},200);me._editor.toolbar.hide();},'popups.show.image.edit':positionPopup('image.edit'),'popups.show.link.insert':positionPopup('link.insert'),'popups.show.link.edit':positionPopup('link.edit'),'popups.show.table.edit':positionPopup('table.edit'),'buttons.refresh':function(){return false;},'focus':function(e){mouseEvn(e||{type:'focus'});},'blur':function(e){mouseEvn(e||{type:'blur'});},'keyup':keyupEvn,'keydown':keydownEvn,'keypress':keypressEvn,'paste.before':pasteBeforeEvn,'paste.after':pasteAfterEvn,'dragover':dragoverEvn,'dragenter':dragenterEvn,'dragstart':dragstartEvn,'dragend':dragendEvn,'drop':dropEvn,'commands.after':function(e,editor,cmd){~['bold','underline','italic','align','indent'].indexOf(cmd)&&me.select._value('enabled');},'contentChanged':function(){clearTimeout(me.__contentChangedTimeout);me.__contentChangedTimeout=setTimeout(function(){[].forEach.call(me.__doc.querySelectorAll('table, td'),function(el){if(el.style.width.match(/%$/)){if(el.tagName==='TD'){if(parseFloat(el.style.width)>100){el.style.width='100%';}
return;}
el.style.width=el.clientWidth+'px';el.style.marginRight=null;}});},200);}}});this._add_destructor('__destruct');if(this.__opt.readonly)
this._readonly(true);this.__eFrame=this._editor.$iframe[0];this.__doc=this._editor.iframe_document;var ep=me.__eFrame.contentWindow.Element.prototype;if(!ep.matches){ep.matches=window.Element.prototype.matches;}
if(!ep.closest){ep.closest=window.Element.prototype.closest;}
this.__eFrame.contentWindow&&this.__eFrame.contentWindow.addEventListener('scroll',function(){var html=me._editor.$html[0];[].forEach.call(me._main.querySelectorAll('.fr-image-resizer, .fr-popup'),function(elm){elm.style.marginTop=-html.scrollTop+'px';elm.style.marginLeft=-html.scrollLeft+'px';});});function positionPopup(id){return function(){var popup=this.popups.get(id)[0];var focus=this.selection.element();var scrollTop=this.$html[0].scrollTop;var scrollLeft=this.$html[0].scrollLeft;var top=Math.max(20,focus.offsetTop+(focus.clientHeight-popup.clientHeight)/2)-40;var left=Math.max(20,focus.offsetLeft+(focus.clientWidth-popup.clientWidth)/2);if(top<scrollTop){top=scrollTop+20;}else if(top+popup.clientHeight>this.$iframe[0].clientHeight){top=this.$iframe[0].clientHeight-popup.clientHeight+scrollTop-20;}
if(left<scrollLeft){left=scrollLeft+20;}else if(left+popup.clientWidth>this.$iframe[0].clientWidth){left=this.$iframe[0].clientWidth-popup.clientWidth+scrollLeft-20;}
popup.style.top=top+'px';popup.style.left=left+'px';popup.style.marginTop=-scrollTop+'px';popup.style.marginLeft=-scrollLeft+'px';};}
if(this.__doc.getSelection){var s=this.__doc.getSelection();if(s&&typeof s==="object"&&s.selectAllChildren&&s.collapseToStart){if(this._MSIE)
this.__doc.body.innerHTML='';try{s.selectAllChildren(this.__doc.body);s.collapseToStart();}catch(e){}}}
var head=this.__doc.querySelector('head');head.appendChild(mkElement('meta',{'http-equiv':'x-dns-prefetch-control'},this.__doc));head.insertBefore(mkElement('base',{href:document.location.protocol+'//'+document.location.hostname+(document.location.port?':'+document.location.port:'')+document.location.pathname},this.__doc),head.firstChild);if(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','html_message')!='0'){var sBodyStyle='';if(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','font_family')!='0'){this.__font_family=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','font_family');sBodyStyle='font-family: '+this.__font_family+';';}
var i=this.__aAvailableFontSizes.indexOf(parseInt(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','font_size')||this.__sDefaultFontSize));this.__font_size=(-1===i)?this.__sDefaultFontSize:this.__aAvailableFontSizes[i];sBodyStyle+='font-size: '+this.__font_size+'px;';this.__doc.body.setAttribute('style',sBodyStyle);this._rtl=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','text_direction')==='RTL';this.__doc.body.setAttribute('dir',this._rtl?'rtl':'ltr');}
this.__doc.body.classList.add('fr-element');this.__fonts={};var aFonts={'0':getLang('SETTINGS::DEFAULT')};var aTmp=dataSet.get('storage',['FONTS','ITEMS']);for(var i in aTmp){if(aTmp[i].VALUES.FAMILY.VALUE){aFonts[aTmp[i].VALUES.FAMILY.VALUE]=aTmp[i].VALUES.NAME.VALUE;this.__fonts[aTmp[i].VALUES.FAMILY.VALUE]=[aTmp[i].VALUES.NAME.VALUE,aTmp[i].VALUES.FAMILY.VALUE.toLowerCase().split(',')];}}
this.font._fill(aFonts);this.font._onchange=function(){var val=this._value();if(val!=0){me.__exec('fontFamily.apply',[val]);}};this.font._obeyEvent('show',[function(e,args){[].forEach.call(args.owner.block._main.querySelectorAll('a'),function(a){a.style.fontFamily=a.getAttribute('rel');});}]);if(GWOthers.getItem('RESTRICTIONS','disable_dropbox')!=0){document.getElementById(this._pathName+'/dropbox').setAttribute('hidden','');}
if(GWOthers.getItem('MAIL_SETTINGS_DEFAULT','text_direction_switch')==1)
addcss(this._main,'bidirectional');this._MSIE=currentBrowser().indexOf('MSIE')>-1;this.__oldFcolor='#000000';this.__oldBcolor='#FFFFFF';this.__oldCcolor='#000000';this.__disabled=false;this.__coded=false;this.__output_format=false;this.__currentStyle={};this.__currentSelectionElements=[];this.__doc.onselectionchange=function(){me._saveRange();};function mouseEvn(e){if(me.__opt.readonly){return;}
var e=e.originalEvent||e;if(e.type==='click'){me.__checkMenu(e);me.cmenu&&me.cmenu._destruct();}
if(e.type==='blur'){removecss(me._main,'focus');}
if(e.type==='focus'){addcss(me._main,'focus');try{var evn=new FocusEvent('focus');}catch(e){var evn=document.createEvent('FocusEvent');evn.initFocusEvent('focus',false,true,window,0,me._main);}
me._main.dispatchEvent(evn);}
if(me['_on'+e.type])
if(me['_on'+e.type](e)===false){e.cancelBubble=true;e.preventDefault&&e.preventDefault();e.stopPropagation&&e.stopPropagation();return false;}
if(me.__editable()&&me.__doc['on'+e.type])
if(me.__doc['on'+e.type](e)===false)
return false;if(e.type==='mouseup'&&e.target.tagName==='TD'){return false;}
if(e.initMouseEvent&&e.type!=='focus'){var pos=getSize(me.__eFrame);var evn=document.createEvent("MouseEvent");evn.initMouseEvent(e.type,true,true,window,0,e.screenX,e.screenY,e.clientX+pos.x,e.clientY+pos.y,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,0,null);me._main.dispatchEvent(evn);}
else
if(document.createEventObject){try{var evn=document.createEventObject(e);evn.button=1;me._main.fireEvent('on'+e.type,evn);}catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}}}
function pasteBeforeEvn(e){var cd=(e.clipboardData||(e.originalEvent||{}).clipboardData||{});var items=(cd.types&&cd.types.length&&cd.types)||cd.items||(window.clipboardData||{}).files||[];if([].some.call(items,function(item){return item==='text/html'||item.type==='text/html';})){me.select._value('enabled');me._editor.opts.enter=FroalaEditor.ENTER_P;return;}
((e.clipboardData||window.clipboardData||{}).files||[]).length&&e.preventDefault();if(me._onpaste)
return me._onpaste(e.originalEvent);return;}
function pasteAfterEvn(e){[].forEach.call(me.__doc.body.querySelectorAll('font'),function(font){!font.innerText&&font.parentNode.removeChild(font);});me._editor.opts.enter=FroalaEditor.ENTER_DIV;}
function dropEvn(e){var r,tmp,e=e.originalEvent;try{tmp=e.dataTransfer.getData("text/plain");}
catch(err){tmp=e.dataTransfer.getData("text");}
if(me.__doc.caretPositionFromPoint){var pos=me.__doc.caretPositionFromPoint(e.clientX,e.clientY);r=me.__doc.createRange();r.setStart(pos.offsetNode,pos.offset);r.collapse();}else
if(me.__doc.caretRangeFromPoint)
r=me.__doc.caretRangeFromPoint(e.clientX,e.clientY);if(tmp===me._pathName&&me.__activeImage){if(r){me.__activeImage.box.parentNode.removeChild(me.__activeImage.box);r.insertNode(me.__activeImage.box);}else
if(me.__doc.body.createTextRange){r=me.__doc.body.createTextRange();r.moveToPoint(e.clientX,e.clientY);var spanId="temp_"+(""+Math.random()).slice(2);r.pasteHTML('<span id="'+spanId+'">&nbsp;</span>');var span=me.__doc.getElementById(spanId);span.parentNode.replaceChild(me.__activeImage.box,span);}
e.preventDefault();return false;}
if(me._ondrop)
return me._ondrop(e);return false;}
function keypressEvn(e){if(me.__activeImage&&me.__activeImage.box){var img=me.__activeImage.original;me.__img_removeEdit();var s=me._getSelection();if(s.rangeCount>0)
s.removeAllRanges();var range=me.__doc.createRange();range.selectNode(img);s.addRange(range);}
if(me._onkeypress)
me._onkeypress(e.originalEvent);}
function keyupEvn(e){if(me.__activeImage&&me.__activeImage.box){var img=me.__activeImage.original;me.__img_removeEdit();var s=me._getSelection();if(s.rangeCount>0)
s.removeAllRanges();var range=me.__doc.createRange();range.selectNode(img);s.addRange(range);}
e=e.originalEvent||e;me._saveRange();me.__checkMenu(e);if(me._onkeyup)
return me._onkeyup(e);};function keydownEvn(e){if(e.keyCode==116){e.cancelBubble=true;e.preventDefault&&e.preventDefault();e.stopPropagation&&e.stopPropagation();return false;}
if(me.onkeydown){var result=me.onkeydown(e);if(result!==void 0){return result;}}
clearTimeout(me.__checkMenuTimeout);if(me.__activeImage&&me.__activeImage.box){var img=me.__activeImage.original;me.__img_removeEdit();var s=me._getSelection();if(s.rangeCount>0)
s.removeAllRanges();var range=me.__doc.createRange();range.selectNode(img);s.addRange(range);}
switch(e.keyCode){case 9:var r=me._getRange();if(r.startContainer&&e.originalEvent){var tmp=r.startContainer;while(tmp.nodeType===3){tmp=r.startContainer.parentElement||r.startContainer.parentNode;}
var tag=tmp.tagName;switch(me.__allowTabElements[tag]){case 2:if(r.startOffset>0)
break;case 1:e.originalEvent.cancelBubble=true;return true;}}
if(me.__tabIndex_dock){if(e.originalEvent.shiftKey)
me.__tabIndex_dock._tabIndexPrev(me);else
me.__tabIndex_dock._tabIndexNext(me);}
return false;case 13:case 46:return true;case 27:if(me._onesc)
me._onesc();if(e.preventDefault)
e.preventDefault();return false;}
if(me._onkeydown)
return me._onkeydown(e);};function dragoverEvn(e){e.originalEvent.preventDefault();}
function dragenterEvn(e){e.originalEvent.preventDefault();}
function dragstartEvn(e){gui.frm_main.__filedrag=false;}
function dragendEvn(e){gui.frm_main.__filedrag=true;}
this.__doc.addEventListener('click',mouseEvn,false);this.__doc.addEventListener('mouseup',mouseEvn,false);this.__doc.addEventListener('mousedown',mouseEvn,false);this.__doc.addEventListener('mousemove',mouseEvn,false);this._getAnchor('header').onmousedown=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!=='A')
elm=elm.parentNode;if(elm.tagName!=='A'||!elm.id)
return false;var id=elm.id.substr(me._pathName.length);switch(id){case'/undo':case'/redo':me.__exec('commands.'+id.replace('/',''));me.__checkMenu();break;case'/spell':if(!me.__coded){me.__spell();}
break;case'/format':if(me._getAnchor('format_toolbar').classList.contains('hidden')){me._showToolbar('format');}else{me._hideToolbars();}
break;case'/insert':if(me._getAnchor('insert_toolbar')){if(me._getAnchor('insert_toolbar').classList.contains('hidden')){me._showToolbar('insert');}else{me._hideToolbars();}}
break;case'/removeFormat':if(!me.__disabled){me.__exec('commands.clearFormatting');}
break;case'/bold':case'/italic':case'/underline':case'/strikeThrough':case'/subscript':case'/superscript':if(!me.__disabled){me.__exec('commands.'+id.replace('/',''));}
break;case'/direction':if(me.__disabled){break;}
var range=me._getRange();if(range){range.collapse(true);elm=range.startContainer;}else
elm=me.__doc.body;if(elm.nodeType==3)
elm=elm.parentElement||elm.parentNode;var block={p:true,h1:true,h2:true,h3:true,h4:true,h5:true,h6:true,div:true,ol:true,ul:true,table:true,body:true};if(me._MSIE&&elm.nodeName=='DIV'&&elm.parentNode.nodeName=='LI')
elm=elm.parentNode;while(elm.parentNode&&!block[elm.nodeName.toLowerCase()])
elm=elm.parentNode;if(elm.nodeName=='HTML')
elm=me.__doc.body;if(elm.nodeName=='BODY')
me._rtl=!me._rtl;switch(elm.dir){case'ltr':elm.dir='rtl';break;case'rtl':elm.dir='ltr';break;default:elm.dir=me._rtl?'ltr':'rtl';}
break;}
e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();return false;};this._getAnchor('header').onclick=function(e){if(me.__disabled){return false;}
var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName!=='A')
elm=elm.parentNode;if(elm.tagName!=='A'||!elm.id)
return false;var id=elm.id.substr(me._pathName.length);if(!me.cmenu||me.cmenu._destructed){var aCData=[];switch(id){case'/image':me.__initpopup('I');break;case'/link':me.__initpopup('L');break;case'/hr':me.__exec('commands.insertHR');break;case'/dropbox':me.__dropboxHandler();break;case'/paste_text':me.__initpopup('P');break;case'/paragraph':if(me.__coded||me.__disabled){break;}
aCData.push({title:'RICH::PARAGRAPH',css:'paragraph p'+(!me.__currentStyle.HEAD?' active':''),arg:[me,'_paragraphFormat',['p']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 1',css:'paragraph h1'+(me.__currentStyle.HEAD===1?' active':''),tag:'h1',arg:[me,'_paragraphFormat',['h1']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 2',css:'paragraph h2'+(me.__currentStyle.HEAD===2?' active':''),tag:'h2',arg:[me,'_paragraphFormat',['h2']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 3',css:'paragraph h3'+(me.__currentStyle.HEAD===3?' active':''),tag:'h3',arg:[me,'_paragraphFormat',['h3']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 4',css:'paragraph h4'+(me.__currentStyle.HEAD===4?' active':''),tag:'h4',arg:[me,'_paragraphFormat',['h4']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 5',css:'paragraph h5'+(me.__currentStyle.HEAD===5?' active':''),tag:'h5',arg:[me,'_paragraphFormat',['h5']],disabled:me.__disabled},{text:getLang('RICH::HEADING')+' 6',css:'paragraph h6'+(me.__currentStyle.HEAD===6?' active':''),tag:'h6',arg:[me,'_paragraphFormat',['h6']],disabled:me.__disabled});break;case'/table':var label=mkElement('div',{textContent:getLang('RICH::CREATE_TABLE',[0,0])});var trs=[];for(var i=1;i<=8;i++){var tds=[];for(var j=1;j<=10;j++){tds.push(mkElement('td',{'data-r':i,'data-c':j,onclick:function(){me.__closeInsertTooltip();me._insTable({border:1,rows:+this.getAttribute('data-r'),columns:+this.getAttribute('data-c')});},onmouseover:function(){[].forEach.call(this.parentNode.parentNode.querySelectorAll('td'),function(td){if(+td.getAttribute('data-r')<=+this.getAttribute('data-r')&&+td.getAttribute('data-c')<=+this.getAttribute('data-c')){td.classList.add('active');}else{td.classList.remove('active');}},this);label.innerText=getLang('RICH::CREATE_TABLE',[this.getAttribute('data-c'),this.getAttribute('data-r')]);}}));}
trs.push(mkElement('tr',{'data-r':i},false,tds));}
var tableElement=mkElement('table',{className:'createTable'},false,trs);aCData.push({element:mkElement('div',{},false,[label,tableElement])},{title:'RICH::CUSTOM_TABLE',css:'ico2 icotable',arg:[me,'__initpopup',['T']],disabled:me.__disabled});break;case'/align':if(me.__disabled){break;}
aCData.push({title:'RICH::LEFT',css:'ico2 img icoleft',arg:[me,'__exec',['align.apply',['left']]]},{title:'RICH::CENTER',css:'ico2 img icocenter',arg:[me,'__exec',['align.apply',['center']]]},{title:'RICH::RIGHT',css:'ico2 img icoright',arg:[me,'__exec',['align.apply',['right']]]},{title:'RICH::JUSTIFY',css:'ico2 img icojustify',arg:[me,'__exec',['align.apply',['justify']]]});break;case'/ordered':if(me.__disabled){break;}
aCData.push({title:'RICH::NUMBEREDLIST',css:'ico2 img icoordered'+(me.__currentStyle.ORDERED?' active':''),arg:[me,'__exec',['lists.format',['OL']]]},{title:'RICH::BULLETEDLIST',css:'ico2 img icounordered'+(me.__currentStyle.UNORDERED?' active':''),arg:[me,'__exec',['lists.format',['UL']]]},{title:'RICH::LEFTINDENT',css:'ico2 img icooutdent',arg:[me,'__exec',['commands.outdent']],keep:true},{title:'RICH::RIGHTINDENT',css:'ico2 img icoindent',arg:[me,'__exec',['commands.indent']],keep:true});}
if(aCData.length){e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();addcss(elm,'active');me.cmenu=gui._create('cmenu','obj_context','','obj_rich_menu');me.cmenu._onclose=function(){removecss(elm,'active');};me.cmenu._fill(aCData);var pos=getSize(elm);me.cmenu._place(pos.x+pos.w/2,pos.y+pos.h,'',2);}}
if(elm.href){if(me._MSIE)
me._focus(true);return false;}};me.size._obeyEvent('onchange',[function(e){var val=me.size._value();val&&me.__exec('fontSize.apply',[val+'px']);}]);me.size._obeyEvent('onkeyup',[function(e){var val=me.size._value();val&&me.__exec('fontSize.apply',[val+'px'],(e.which||e.keyCode)!==13);me.size.block&&me.size.block._destruct();}]);me._getAnchor('color').onclick=function(e){me.__clickColor(e);};me._getAnchor('bgcolor').onclick=function(e){me.__clickColor(e);};var last_select_value=this.select._value();this.select._obeyEvent('onchange',[function(){switch(me.select._value()){case'enabled':if(me.__coded)
me.__code();try{me.__doc.body.dir=gui._rtl==undefined?'auto':(gui._rtl?'rtl':'ltr');}catch(e){}
if(gui._rtl&&!me._value()){me.__exec('format.apply',["p"]);if(me.__doc.body.firstChild&&me.__doc.body.firstChild.nodeName==='BR')
me.__doc.body.removeChild(me.__doc.body.firstChild);}
me._disable(false);if(last_select_value==='code'){setTimeout(function(){me.__nightMode();},200);}
break;case'disabled':if(me.__coded)
me.__code();try{me.__doc.body.dir=gui._rtl==undefined?'auto':(gui._rtl?'rtl':'ltr');}catch(e){}
me._disable(true);if(last_select_value==='code'){setTimeout(function(){me.__nightMode();},200);}
break;case'code':me.__nightMode();if(me.__spelled)
me.select._value('enabled');else
me.__code();}
last_select_value=me.select._value();}]);this.__checkMenu();if(true===this._aTemplateData.disable_html){this.select._value('disabled');}};_me._readonly=function(readonly){if((this.__opt.readonly=!!readonly)){this.__exec('edit.off');this._getAnchor('header').parentNode.style.display='none';}
else{this.__exec('edit.on');this._getAnchor('header').parentNode.style.display='';}};_me._showToolbar=function(type){this._hideToolbars();switch(type){case'insert':case'format':var disable_mailformat=+GWOthers.getItem('RESTRICTIONS','disable_mailformat');if((isNaN(disable_mailformat)||disable_mailformat===0)&&true!==this._aTemplateData.disable_html){if(!this.__firstFormatToolbarToggle){this.__firstFormatToolbarToggle=true;this.select._value('enabled');}}
break;}
document.getElementById(this._pathName+'/'+type).classList.add('active');this._main.querySelector('.'+type+'_toolbar').classList.remove('hidden');};_me._hideToolbars=function(){[].forEach.call(this._main.querySelectorAll('.toolbar'),function(elm){elm.classList.add('hidden');});['insert','format','emoji'].forEach(function(type){var el=document.getElementById(this._pathName+'/'+type);el&&el.classList.remove('active');},this);if(this.emoji&&!this.emoji._destructed)
this.emoji._destruct();};_me.__dropboxHandler=function(){if(!(GWOthers.getItem('EXTERNAL_SETTINGS','dropbox_app_key')||'').length){gui.notifier._value({type:'alert',args:{header:'DROPBOX::ERRORALERT',text:'DROPBOX::MISSINGKEY'}});}else if(typeof Dropbox==="undefined"){gui.notifier._value({type:'alert',args:{header:'DROPBOX::ERRORALERT',text:'DROPBOX::UNAVAILABLE'}});}else{var me=this;Dropbox.choose({linkType:'preview',success:function(files){var links=[];for(var i in files)
links.push('<a href="'+files[i].link.escapeXML(true)+'">'+files[i].name.escapeXML()+'</a>');me.__exec('html.insert',[links.join(', ')],false,function(){me.__exec('undo.saveStep');});}});}};_me.__nightMode=function(bResize){if(GWOthers.getItem('LAYOUT_SETTINGS','night_mode')==1){var spell=this._getAnchor('header').querySelector('.icospell');if(spell){spell.parentNode.parentNode.removeChild(spell.parentNode.nextElementSibling);spell.parentNode.parentNode.removeChild(spell.parentNode);}
storage.library('night_mode');NightMode(this.__eFrame.contentWindow).activate();}};_me._paragraphFormat=function(tag){this.__exec('format.removeStyle',['font-size']);this.__exec('paragraphFormat.apply',[tag]);};_me._placeholder=function(placeholder){this._editor.opts.placeholderText=getLang(placeholder||'');setTimeout(function(){this.__exec('placeholder.refresh',[],true);}.bind(this),5);};_me.__editable=function(b){if(Is.Defined(b)){this.__exec('edit.'+(b?'on':'off'),null,true);}else{return this.__doc.body.contentEditable==='true';}};_me.__checkMenu=function(e){clearTimeout(this.__checkMenuTimeout);var me=this;this.__checkMenuTimeout=setTimeout(function(){me.__checkMenuHandler(e);},150);};_me._parentElementTag=function(el,parentTagNames){while(el.tagName!=='BODY'){if(~parentTagNames.indexOf(el.tagName)){return el;}
el=el.parentNode;}};_me.__checkMenuHandler=function(e){if(this._destructed||this.__coded||(e&&(e.which||e.keyCode)===13))
return;var buffer={},buffers=[],elms,r;r=this._getRange();this.__currentSelectionElements=[];if(r){if(r.startContainer===r.endContainer){if('BODY'===r.startContainer.nodeName){this.__currentSelectionElements.push(r.startContainer);}else{this.__currentSelectionElements.push(r.startContainer.parentNode);}}else{this.__traverseSelection(r.startContainer,r.endContainer);}}
elms=this.__currentSelectionElements;for(var i in elms){if(!elms[i]){continue;}
if(r.startContainer!==r.endContainer){buffer={};}
if(!buffer.BOLD)
buffer.BOLD=this.__testStyle(elms[i],'font-weight','bold')||this._parentElementTag(elms[i],['B','STRONG']);if(!buffer.ITALIC)
buffer.ITALIC=this.__testStyle(elms[i],'font-style','italic')||this._parentElementTag(elms[i],['I','EM']);if(!buffer.UNDERLINE)
buffer.UNDERLINE=this._parentElementTag(elms[i],['U']);if(!buffer.STRIKETHROUGH)
buffer.STRIKETHROUGH=this._parentElementTag(elms[i],['STRIKE','S']);if(!buffer.SUBSCRIPT)
buffer.SUBSCRIPT=this._parentElementTag(elms[i],['SUB']);if(!buffer.SUPERSCRIPT)
buffer.SUPERSCRIPT=this._parentElementTag(elms[i],['SUP']);if(!buffer.LEFT&&!buffer.RIGHT&&!buffer.CENTER&&!buffer.JUSTIFY){buffer.LEFT=this.__testStyle(elms[i],'text-align','left');if(!buffer.LEFT){buffer.RIGHT=this.__testStyle(elms[i],'text-align','right');if(!buffer.RIGHT){buffer.CENTER=this.__testStyle(elms[i],'text-align','center');if(!buffer.CENTER){buffer.JUSTIFY=this.__testStyle(elms[i],'text-align','justify');var tmp=elms[i].getAttribute('align');if(tmp)
buffer[tmp.toUpperCase()]=true;}}}}
if(!buffer.UNORDERED)
buffer.UNORDERED=this._parentElementTag(elms[i],['UL']);if(!buffer.ORDERED)
buffer.ORDERED=this._parentElementTag(elms[i],['OL']);var elm=elms[i];while(!buffer.HEAD&&elm.tagName!=='BODY'){var match=elm.tagName.match(/^H(\d)$/);if(match&&match[1]){buffer.HEAD=+match[1];}
elm=elm.parentNode;}
if(!buffer.INDENT){var tmp=getStyle(elms[i],'margin-left');buffer.INDENT=(tmp&&tmp!=0&&tmp!='0px');}
if(!buffer.FAMILY)
buffer.FAMILY=getStyle(elms[i],'font-family')||elms[i].getAttribute('face')||this.__font_family;if(elms[i].getAttribute('size'))
buffer.SIZE={1:'10',2:'13',3:'16',4:'18',5:'24',6:'32'}[elms[i].getAttribute('size')];else{var tmp=getStyle(elms[i],'font-size');if(tmp||this.__font_size)
buffer.SIZE=parseInt(tmp||this.__font_size,10);}
buffer.color=getStyle(elms[i],'color',this.__doc);if(buffer.color){this.__oldFcolor=buffer.color;}
buffer.bgcolor=getStyle(elms[i],'background-color',this.__doc);if(buffer.bgcolor){this.__oldBcolor=buffer.bgcolor;}
buffers.push(buffer);}
buffer=this.__mergeStyles(buffers);var f='0';if(buffer.FAMILY){var aFamily=buffer.FAMILY.toLowerCase().str_replace('"','').split(','),iTmp1,iTmp2=-1;for(var ifn in aFamily)
for(var sfn in this.__fonts)
if((iTmp1=inArray(this.__fonts[sfn][1],aFamily[ifn]))>-1&&(iTmp2<0||iTmp1<iTmp2)){iTmp2=iTmp1;f=sfn;}}
buffer.FONT=f;this.font._value(buffer.FONT,true);this.size._value(buffer.SIZE,true);var tmp=document.getElementById(this._pathName+'/bold');if(buffer.BOLD)
addcss(tmp,'active');else
removecss(tmp,'active');tmp=document.getElementById(this._pathName+'/italic');if(buffer.ITALIC)
addcss(tmp,'active');else
removecss(tmp,'active');tmp=document.getElementById(this._pathName+'/underline');if(buffer.UNDERLINE)
addcss(tmp,'active');else
removecss(tmp,'active');tmp=document.getElementById(this._pathName+'/strikeThrough');if(buffer.STRIKETHROUGH)
addcss(tmp,'active');else
removecss(tmp,'active');tmp=document.getElementById(this._pathName+'/subscript');if(buffer.SUBSCRIPT)
addcss(tmp,'active');else
removecss(tmp,'active');tmp=document.getElementById(this._pathName+'/superscript');if(buffer.SUPERSCRIPT)
addcss(tmp,'active');else
removecss(tmp,'active');if((tmp=document.getElementById(this._pathName+'/font')))
tmp.innerHTML=this.__fonts[buffer.FONT]?this.__fonts[buffer.FONT][0].escapeHTML():getLang('RICH::FONT');tmp=document.getElementById(this._pathName+'/align');if(buffer.JUSTIFY)
tmp.className='ico icojustify';else
if(buffer.CENTER)
tmp.className='ico icocenter';else
if(buffer.RIGHT)
tmp.className='ico icoright';else
tmp.className='ico icoleft';tmp=document.getElementById(this._pathName+'/ordered');if(buffer.UNORDERED)
tmp.className='ico icounordered';else
tmp.className='ico icoordered';this._getAnchor('color').getElementsByTagName('SPAN')[0].style.backgroundColor=buffer.color;this._getAnchor('bgcolor').getElementsByTagName('SPAN')[0].style.backgroundColor=buffer.bgcolor;this.__currentStyle=buffer;tmp=document.getElementById(this._pathName+'/undo');if(this.__exec('undo.canDo',[],true))
removecss(tmp,'disabled');else
addcss(tmp,'disabled');tmp=document.getElementById(this._pathName+'/redo');if(this.__exec('undo.canRedo',[],true))
removecss(tmp,'disabled');else
addcss(tmp,'disabled');};_me.__testStyle=function(elm,attr,styleValue){var style=getStyle(elm,attr,this.__doc);var font=getStyle(elm,'font',this.__doc);if(style||font)
return(style.toLowerCase()==styleValue||font.toLowerCase().indexOf(styleValue.toLowerCase())!=-1)?true:false;else
return false;};_me._getSelection=function(){return window.getSelection?this.__eFrame.contentWindow&&this.__eFrame.contentWindow.getSelection():this.__doc.selection;};_me._getRange=function(){var s=this._getSelection();if(!s||s.rangeCount===0){return}
return(s.rangeCount>0)?s.getRangeAt(0):s.createRange();};_me._selectRange=function(rng,s){if(window.getSelection){s.removeAllRanges();s.addRange(rng);}
else
rng.select();};_me._saveRange=function(){if(this._MSIE){this.__savedRange=this._getRange();this.__savedSel=this._getSelection();}};_me._restoreRange=function(){if(this.__savedRange)
this._selectRange(this.__savedRange,this.__savedSel);};_me.__exec=function(cmd,args,bSkipFocus,callback){if(!this.__initialized){return setTimeout(this.__exec.bind(this,cmd,args,bSkipFocus,callback),5);}
var result,fn=this._editor;try{if(!bSkipFocus){this._restoreRange();}
cmd=cmd.split('.');while(cmd.length){fn=fn[cmd.shift()];}
result=fn.apply(this._editor,args);if(!bSkipFocus){this._focus(true);this.__checkMenu();}}catch(e){console.warn(this._name,'__exec',cmd,e);}
callback&&callback();return result;};_me.__code=function(){if(this.__coded){this._disable(0,'code');var v='';if(this.__coded.parentNode){v=this.__coded.value;this.__coded.parentNode.removeChild(this.__coded);}
this.__coded=false;this._value(v);this._getAnchor('frame').style.display='';}else{this._disable(1,'code');this.__img_removeEdit();var txt=this.__doc.body.innerHTML.replace(/\r/gm,'').replace(/\n/gm,"\r\n");this._getAnchor('frame').style.display='none';var me=this;this.__coded=mkElement('textarea',{dir:"auto"});this.__coded.onblur=function(e){var e=e||window.event;if(me['_on'+e.type]&&!me['_on'+e.type](e)){e.cancelBubble=true;try{e.preventDefault();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
try{e.stopPropagation();}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
return false;}};this._getAnchor('msiebox').firstElementChild.appendChild(this.__coded);this.__coded.value=txt;}};_me.__getSpellLang=function(){storage.library('gw_others');return GWOthers.getItem('MAIL_SETTINGS_DEFAULT','spellchecker');};_me.__spell_uncheck=function(elm,doc){if(elm&&elm.tagName=='SPAN'){elm=[elm];}
else{elm=elm||this.__doc.body;elm=elm.querySelectorAll('span[fr-iw-spell]');}
var doc=doc||this.__doc;for(var i=elm.length;i--;){elm[i].parentNode.replaceChild(doc.createTextNode(elm[i].innerHTML),elm[i]);}};_me.__spell=function(){if(this.__spelled){if(this.__spelled==2)
return;else
this.__spelled=2;this.__spell_uncheck();this._onclick=null;this.__spelled=false;this._disable(this.__disable_status);removecss(document.getElementById(this._pathName+'/spell'),'active');this.__doc.body.setAttribute('spellcheck','true');return;}
var checklang=this.__getSpellLang();if(!checklang)
return;this.__doc.body.setAttribute('spellcheck','false');this.__spellwords=[];this.__spelled=2;this.__disable_status=this.__disabled;var arr=[],str=this._value(null,false,true);var sOld=str.removeTags(' ').unescapeHTML();sOld=sOld.replace(/([\.,;\&\:\"\`\[\]\{\}\(\)\~\=\_\!\?\|\\/\<\ \>]+)/gm,' ');storage.library('wm_spellchecker');var iqspell=new wm_spellchecker(),aStr=iqspell.get({type:'check',lang:checklang,input:sOld});if(Is.Empty(aStr)){this.__spelled=false;return;}
var tmp='',istart=0,iend=0,ilen=str.length,arr=[],tmpIndex,tmpString,tmpLength,regexp=/^([\.,\:\"\'\`\[\]\{\}\(\)\~\s\=\_\!\?\<\>\|\\/]+)$/g;while(true){iend=str.indexOf('<',istart);if(iend<0)
iend=ilen;else
if(iend==0){istart=str.indexOf('>');if(istart<0)
break;istart++;continue;}
tmp=str.substring(istart,iend);if(tmp.trim()){for(var j in aStr){tmpLength=aStr[j].length;while(true){tmpIndex=tmp.indexOf(aStr[j],tmpIndex);if(tmpIndex<0)
break;tmpString='';if(tmpIndex>0)
tmpString+=tmp.charAt(tmpIndex-1);if(tmpIndex+tmpLength<(iend-istart))
tmpString+=tmp.charAt(tmpIndex+tmpLength);if(tmpString.length==0||tmpString.match(regexp))
arr.push([istart+tmpIndex,tmpLength,aStr[j]]);tmpIndex+=tmpLength;}}}
if(iend==ilen)
break;istart=str.indexOf('>',iend);istart=istart>0?istart+1:iend;}
if(count(arr)){function sortarr(a,b){return a[0]-b[0];}
arr.sort(sortarr);var subcount=0,sublen='<span fr-iw-spell="true"></span>'.length;for(var i in arr){str=str.substring(0,arr[i][0]+subcount)+'<span fr-iw-spell="true">'+str.substr(arr[i][0]+subcount,arr[i][1])+'</span>'+str.substring(arr[i][0]+arr[i][1]+subcount);subcount+=sublen;}
this._disable(true);addcss(document.getElementById(this._pathName+'/spell'),'active');var me=this;this._onclick=function(e){var e=e||me.__doc.parentWindow.event,elm=e.target||e.srcElement;if(!(elm.tagName==='SPAN'&&elm.hasAttribute('fr-iw-spell'))||e.button!=0&&document.documentMode!=8)
return true;var aMenu=[],plain=elm.innerHTML.removeTags();if(elm.id){aMenu.push({text:me.__spellwords[elm.id].entityify(),arg:[me,'__swapword',[elm,me.__spellwords[elm.id]],true]});if(me.__spellwords[elm.id]!=plain)
aMenu.push({text:plain.entityify(),arg:[me,'__swapword',[elm,elm.innerHTML]]});}else{elm.id=me.__spellwords.length;me.__spellwords[elm.id]=plain;aMenu.push({text:plain.entityify(),arg:[me,'__swapword',[elm,elm.innerHTML]]});}
try{var aSuggest=iqspell.get({type:'suggest',lang:checklang,input:me.__spellwords[elm.id]});aSuggest=aSuggest[aSuggest[0]];if(!Is.Empty(aSuggest))
aMenu.push({"title":'-'});var j=0;for(var i in aSuggest){if(j>15)
break;aMenu.push({text:aSuggest[i].entityify(),arg:[me,'__swapword',[elm,aSuggest[i],true]]});j++;}}catch(er){gui._REQUEST_VARS.debug&&console.log(this._name||false,er);}
me.spell=gui._create('spellcheck','obj_context');me.spell._fill(aMenu);var pos1=getSize(me.__eFrame);var pos2=getSize(elm,me.__doc);me.spell._place(pos1.x+pos2.x+(pos2.w/2),pos1.y+pos2.y+pos2.h,'',1);return false;};this.__spelled=true;this._value(str,true);}else{this.__spelled=false;this.__doc.body.setAttribute('spellcheck','true');}};_me.__swapword=function(elm,str,ok){if(elm){elm.innerHTML=str;elm.setAttribute('fr-iw-spell',ok?'false':'true');}};_me.__closeInsertTooltip=function(){var elm=document.getElementById(this._pathName+'/insert');elm&&elm.classList.remove('active');elm=this._getAnchor('insert_toolbar');elm&&this._getAnchor('insert_toolbar').classList.add('hidden');};_me.__initpopup=function(type,skipDestruct,options){var me=this;if(this.popup&&!skipDestruct)
this.popup._destruct();if(gui.focus)
gui.focus._suppress=true;var popup=gui._create('rich_popup','obj_popup_tab','','noblur obj_rich_popup obj_rich_popup_'+type);popup._size(300,200,true);popup._modal(true);popup._resizable(false);popup._dockable(false);if(!skipDestruct)
this.popup=popup;popup._create('btn_ok','obj_button','footer','ok noborder color1')._value('FORM_BUTTONS::OK');popup._create('btn_cancel','obj_button','footer','cancel noborder')._value('FORM_BUTTONS::CANCEL');popup.btn_cancel._onclick=function(){this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};switch(type){case'P':popup._size(450,250,true);popup._title('RICH::PASTEW');popup._draw('obj_rich_paste','main');popup.btn_ok._onclick=function(){me.__closeInsertTooltip();me.__exec('html.insert',[this._parent.input._value().entityify().replace(/\n/g,'<br>\n').replace(/\t/g,'    ').replace(/\s{2}/gm,' &nbsp;').replace(/\n/g,''),true],false,function(){me.__exec('undo.saveStep');});this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};break;case'T':popup._size(520,245,true);popup._title('RICH::TABLE');popup._draw('obj_rich_table','main');popup._border_color='000000';popup._getAnchor('color_picker').onclick=function(e){me.__clickColor(e);};popup._getAnchor('color_picker').getElementsByTagName('SPAN')[0].style.backgroundColor=this.__oldCcolor;popup.btn_ok._onclick=function(){me.__closeInsertTooltip();me._insTable({"padding":(!this._parent.padding._checkError||!this._parent.padding._checkError.length?this._parent.padding._value():0),"spacing":(!this._parent.spacing._checkError||!this._parent.spacing._checkError.length?this._parent.spacing._value():0),"border":this._parent.border._value(),"color":me.__oldCcolor.replace('#',''),"columns":(!this._parent.columns._checkError||!this._parent.columns._checkError.length?this._parent.columns._value():4),"rows":(!this._parent.rows._checkError||!this._parent.rows._checkError.length?this._parent.rows._value():4)});this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};break;case'I':var screenshot=this.__oUpload&&document.addEventListener;options=options||{};popup._size(550,options.image?245:(455-(screenshot?0:130)),true);popup._title('RICH::IMAGE');popup._draw('obj_rich_image','main',options.image?{image:options.image}:{upload:this.__oUpload?true:false,screenshot:screenshot,insert_image:(GWOthers.getItem('RESTRICTIONS','disable_attach_item')||0)<1});if(options.image){popup.alt._value(options.image.getAttribute('alt'));popup.border._value(options.image.getAttribute('border'));popup.spacing._value(options.image.getAttribute('hspace'));var match;['width','height'].forEach(function(m){if(match=options.image.style[m].match(/^([\d\.]+)(px|%)?$/)){popup[m]._value(match[1]);popup[m+'_unit']._value({px:0,'%':1}[match[2]||'px']);}});}
var guest=sPrimaryAccountGUEST||(TeamChatAPI&&TeamChatAPI.teamChatOnly());if(popup.radio){var aFill={url:'RICH::URL'};if(popup.internal&&!guest)
aFill.internal='RICH::INTERNAL';if(this.__oUpload)
aFill.uploaded='RICH::UPLOADED';popup.radio._fill(aFill);popup.radio._value(this.__oUpload?'uploaded':'url');}
if(popup.url){popup.url._onfocus=function(){this._parent.radio._value('url');};}
if(popup.internal){popup.internal._onfocus=function(){this._parent.radio._value('internal');};popup.add_item._onclick=function(){var sFolder=Mapping.getDefaultFolderForGWType('F');if(!dataSet.get('folders',[sPrimaryAccount,sFolder]))
sFolder='';gui._create('insert_item','frm_insert_item','','',[me,function(aItems){var aItemsInfo={aid:aItems[0].aid,fid:aItems[0].fid,iid:aItems[0].id,values:[]};WMItems.list(aItemsInfo,'','','',[function(aData){var attachements=aData[aItems[0].aid][aItems[0].fid][aItems[0].id].ATTACHMENTS;var attachement=false;for(var i in attachements){if(attachements[i].values.ATTDESC===aItems[0]['title']){attachement=i;break;}}
var out={'name':aItems[0]['title'],'attachement':attachement,'id':aItems[0]['id'],'size':aItems[0]['size'],'class':aItems[0]['type']||(aItems[0]['embedded']?'item':'itemlink'),'fullpath':aItems[0]['fullpath']};if(this.__oUpload&&this.__oUpload.__idtable){this.__oUpload.__idtable.push(out);popup._listImages();}else
popup._listImages([out]);popup.radio._value('internal');}]);}],sPrimaryAccount,sFolder,void 0,void 0,void 0,['F','X','I'],'F');};}
if(guest){popup.internal._main.parentNode.parentNode.setAttribute('hidden','');}
if(this.__oUpload&&popup.upload){popup.upload.file._main.className+=' ico';if(document.addEventListener){popup.__eCatcher=mkElement('div',{contenteditable:'true',style:{position:'absolute',top:'-10px',left:'-10px',width:'1px',height:'1px',overflow:'hidden'}});popup.__eCatcher.addEventListener('DOMSubtreeModified',function(){if(!this.__skip&&this.children.length==1&&this.firstElementChild.src){var img=new Image();img.onload=function(){var c=mkElement('canvas',{width:this.width,height:this.height}),ctx=c.getContext("2d");ctx.drawImage(this,0,0);if(c.toBlob)
c.toBlob(function(blob){blob.name='screenshot.png';popup.upload.__ondropfile([blob]);},"image/png");else{var image=c.toDataURL();image=image.replace(/^data:[\w\;\/]*,/g,'');var byteString=atob(image),buffer=new ArrayBuffer(byteString.length),intArray=new Uint8Array(buffer);for(var i=0;i<byteString.length;i++)
intArray[i]=byteString.charCodeAt(i);var blob=new Blob([buffer],{type:"image/png"});blob.name='screenshot.png';popup.upload.__ondropfile([blob]);}};img.src=this.firstElementChild.src;}
setTimeout(function(){if(me&&popup&&popup.__eCatcher)
popup.__eCatcher.innerHTML='';},20);},false);popup._getAnchor('main').appendChild(popup.__eCatcher);popup.__keydown=function(e){if(e.keyCode==86&&(e.ctrlKey||e.metaKey)&&me&&popup){var elm=e.target||e.srcElement;if(!elm||elm.tagName!='INPUT'||elm.readOnly)
popup.__eCatcher.focus();}};gui._obeyEvent('keydown',[popup.__keydown]);popup.__paste=function(e){if(!me||!popup||!popup.upload)
return false;if(e.clipboardData){var items=e.clipboardData.items;if(items)
for(var i=0;i<items.length;i++)
if(items[i].type.indexOf("image")>-1){popup.__eCatcher.__skip=true;var blob=items[i].getAsFile();blob.name=items[i].name||'screenshot.'+items[i].type.split('/')[1];popup.upload.__ondropfile([blob]);}}};gui._obeyEvent('paste',[popup.__paste]);popup.__dispatch=function(){gui._disobeyEvent('keydown',[popup.__keydown]);gui._disobeyEvent('paste',[popup.__paste]);};popup._add_destructor('__dispatch');}
popup.upload._setFileTypes('*.jpg;*.jpeg;*.gif;*.png',getLang('UPLOAD::IMAGES'));popup.upload._setFolder(this.__oUpload.file._getFolder());popup.upload._onuploadend=function(aAttach){if(me.__oUpload.file._getFolder()!=this._getFolder())
me.__oUpload.file._setFolder(this._getFolder());for(var i in aAttach){aAttach[i].removed=true;aAttach[i].fullpath=aAttach[i].folder+'/'+aAttach[i].id;me.__oUpload._add(aAttach[i]);}
this._parent._listImages();this._parent.radio._value('uploaded');var att=aAttach[aAttach.length-1];if(att){var img=new Image();img.onload=function(){var p=popup._getAnchor('canvas');if(p)
p.getContext("2d").drawImage(this,0,0,p.width,p.height);};img.src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'file','fullpath':att.fullpath});}};popup.upload._onuploadstart=function(){this._parent.uploaded._focus();};popup.uploaded._onfocus=function(){this._parent.radio._value('uploaded');};}
popup.internal&&(popup._listImages=function(out){var att=out||(me.__oUpload?me.__oUpload.list.__idtable:{});if(att.length){var rx=/\.(jpe?g|png|gif)$/i,aUploadFill={},aItemFill={},a='',f='';for(var i in att)
if(att[i].name.match(rx))
if(att[i]['class']&&att[i]['class']=='item'){a=att[i].fullpath+'/'+encodeURIComponent(att[i].attachement||att[i].name);aItemFill[a]=att[i].name;}else{f=(att[i].fullpath||(att[i].folder+'/'+att[i].id))+'|file';aUploadFill[f]=att[i].name;}
if(popup.uploaded){popup.uploaded._fill(aUploadFill);popup.uploaded._value(f);}
popup.internal._fill(aItemFill);popup.internal._value(a);}})();popup.btn_ok._onclick=function(){me.__closeInsertTooltip();var src='',border=this._parent.border._value(),spacing=parseInt(this._parent.spacing._value(),10),width=parseFloat(this._parent.width._value()),height=parseFloat(this._parent.height._value());if(options.image){src=options.image.getAttribute('src');width=width?width+['px','%'][this._parent.width_unit._value()]:(options.image.style.width||options.image.parentNode.style.width);height=height?height+['px','%'][this._parent.height_unit._value()]:(options.image.style.height||options.image.parentNode.style.height);}else{if(width)
width=width+['px','%'][this._parent.width_unit._value()];if(height)
height=height+['px','%'][this._parent.height_unit._value()];switch(this._parent.radio._value()){case'url':var v=this._parent.url._value();if(v&&v!=='http://')
src=encodeURI(v.trim());else{this._parent.url._focus();return;}
break;case'internal':var aFullPath=this._parent.internal._value();if(aFullPath)
src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':'attachment'})+'&fullpath='+aFullPath;else{this._parent.internal._focus();return;}
break;case'uploaded':var aFullPath=this._parent.uploaded._value().split('|');if(aFullPath.length===2)
src='server/download.php?'+buildURL({'sid':dataSet.get('main',['sid']),'class':aFullPath[1],'fullpath':aFullPath[0]});else{this._parent.uploaded._focus();return;}
break;}}
var opt={id:'img-'+unique_id(),src:src,alt:this._parent.alt._value(),style:[]};if(border){opt.border=border;}
if(spacing){opt.hspace=spacing;opt.vspace=spacing;}
if(!width&&!height){opt.style.push('max-width: 100%; height: auto; width: auto;');}
else{if(width){opt.style.push('width: '+width);}
if(height){opt.style.push('height: '+height);}}
opt.style=opt.style.join('; ');var img=mkElement('img',opt);img.setAttribute('style',opt.style);var original;if(options.image){original=options.image;}
me.__img_removeEdit();if(original){var range=me.__doc.createRange();var selection=me.__doc.defaultView.getSelection();var index=[].slice.call(original.parentNode.children).indexOf(original);range.setStart(original.parentNode,index);range.setEnd(original.parentNode,index+1);selection.removeAllRanges();selection.addRange(range);original.parentNode.removeChild(original);}
me.__exec('html.insert',[img.outerHTML,true],false,function(){me.__exec('undo.saveStep');});this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};break;case'L':this._restoreRange();var s=this._getSelection(),surl='',slabel='',sstyle='',r,a;if(s&&s.getRangeAt&&s.rangeCount){r=s.getRangeAt(0);}
try{a=s.anchorNode&&this._parentElementTag(s.anchorNode,['A']);if(s&&s.anchorNode&&a){surl=a.getAttribute('href');slabel=a.textContent;sstyle=a.getAttribute('style');}
else
if(r){slabel=s.toString();var oTrim=/\s+$/g.exec(slabel);if(oTrim&&oTrim.index>0){r.setEnd(r.endContainer,r.endOffset+oTrim.index-slabel.length);slabel=s.toString();}}}catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}
popup._size(400,186,true);popup._title('RICH::ADDLINK');popup._draw('obj_rich_link','main');if(a){popup._create('btn_remove','obj_button','footer','simple color2 x_btn_right');popup.btn_remove._value('FORM_BUTTONS::REMOVE');popup.btn_remove._onclick=function(){me.__closeInsertTooltip();me.__exec('link.remove');popup._destruct();};}
popup.input._value(surl);popup.label._value(slabel);if(!popup.input._value()){popup.input._focus();}
popup.label.__eIN.addEventListener('change',function(e){if(!e.target.value.indexOf('http')&&!popup.input._value()){popup.input._value(e.target.value);}});popup.input._onsubmit=function(){this._parent.btn_ok._onclick();};popup.label._onsubmit=function(){this._parent.btn_ok._onclick();};popup.input._onkeyup=function(){if(!slabel){popup.label._value(this._value());}};popup.label._onkeyup=function(){slabel=this._value();};popup.btn_ok._onclick=function(){me.__closeInsertTooltip();me._restoreRange();var v=this._parent.input._value().trim();if(a){if(s.isCollapsed){if(s.rangeCount>0)
s.removeAllRanges();var range=document.createRange();range.selectNode(a);s.addRange(range);}
me.__exec('link.remove');}
if(v){var a=mkElement('A',{href:v});var sProtocol=a.protocol.slice(0,-1);if(!~FroalaEditor.LinkProtocols.indexOf(sProtocol))
FroalaEditor.LinkProtocols.push(sProtocol);me.__exec('link.insert',[v,slabel||v||'',{'target':'_blank','rel':'nofollow',style:sstyle||''}]);}
popup._destruct();if(gui.focus)
gui.focus._suppress=false;};break;case'B':case'F':case'C':popup._title('RICH::'+(type==='C'?'BORDERCOLOR':(type==='B'?'BGCOLOR':'COLOR')));popup._size(384,300,true);popup._create('color_picker','obj_colorpicker');var v=this['__old'+type+'color'];if(v==='transparent'){v='#000000';}
if(~v.indexOf('#')){popup.color_picker._value(v);}else{v=v.match(/(\d{1,3}).*?(\d{1,3}).*?(\d{1,3})/);popup.color_picker._rgb_value([v[1],v[2],v[3]]);}
popup.btn_ok._onclick=function(){me[type==='C'?'_setBorderColor':(type==='B'?'_setBColor':'_setFColor')](popup.color_picker._value());this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};popup._create('btn_cancel2','obj_button','footer','cancel noborder color2 x_btn_right')._value('FORM_BUTTONS::REMOVE');popup.btn_cancel2._onclick=function(){me[type==='C'?'_setBorderColor':(type==='B'?'_setBColor':'_setFColor')](false);this._parent._destruct();if(gui.focus)
gui.focus._suppress=false;};break;}};_me._getFocusElement=function(){return this.__eFrame.contentWindow;};_me._focus=function(bNow,bTop){if(!this.__eFrame.offsetParent||this.__eFrame.offsetParent.tagName==='BODY')
return false;var elm=this.__doc.getElementsByTagName("body")[0];setTimeout(function(){elm.focus();},0);if(bTop){try{var sel=this.__eFrame.contentWindow.getSelection();}catch(e){var sel=this.__doc.selection.createRange();}
if(sel&&elm)
sel.collapse(elm,0);}
return true;};_me._disable=function(b,css){this.font._disabled(b);this.size._disabled(b);if(this._getAnchor('insert_toolbar'))
[].forEach.call(this._getAnchor('insert_toolbar').querySelectorAll('span a:not(.icopastew)'),function(a){a.classList[b?'add':'remove']('disabled');});if(b){if(this.__spelled&&this.__spelled!==2)
this.__disable_status=true;if(this.__coded&&!css)
this.__code();this.__disabled=true;addcss(this._main,'disabled',css);}else{if(this.__spelled&&this.__spelled!==2)
this.__disable_status=false;else{this.__disabled=false;removecss(this._main,'disabled',css);}}};_me._value=function(v,bSkipSpell,bForceHTML,callback){var aStyles=[],dir=GWOthers.getItem('MAIL_SETTINGS_DEFAULT','text_direction')||"ltr";if(Is.String(v)){if(!bSkipSpell&&this.__spelled)
this.__spell();removecss(this.__doc.body,'placeholder');v=v.replace(/<!--\[if[\w\W]*?\[endif\]-->/g,'');v=v.replace(/<style[\w\W]*?<\/style>/g,function(match){aStyles.push(match);return'';});v=v.replace(/(style="[^"]*?:)\n([^"]*?")/g,'$1$2');v=DOMPurify.sanitize(v);v=v.replace(/<br\s*\/?>\s+/g,'<br>');if(this.__coded)
this.__coded.value=v;else{if(this.__disabled&&!this.__spelled){v=v.replace(/\n/g,'<br>');}
this.__exec('html.set',[v],true,function(){aStyles.length&&this.__doc.body.insertAdjacentHTML('beforeend',aStyles.join(''));if(this.__doc.onfocus)
this.__doc.onfocus();callback&&callback();}.bind(this));}}else{var sBody='';if(this.__coded)
sBody=this.__coded.value;else{this.__img_removeEdit();dir=this.__doc.body.getAttribute('dir')||dir;[].concat(this._tableStyles,this._tableCellStyles).forEach(function(style){style.styles.forEach(function(style){[].forEach.call(this.__doc.body.querySelectorAll(style.selector),function(el){for(var i in style.style){el.style.setProperty(i,style.style[i]);}});},this);},this);sBody=this.__doc.body.innerHTML;if(!bSkipSpell&&this.__spelled){var tmp=mkElement('div');tmp.innerHTML=sBody;this.__spell_uncheck(tmp,document);sBody=tmp.innerHTML;if(this.__disable_status&&!bForceHTML){sBody=createTextVersion(sBody);}}
else
if(this.__disabled&&!bForceHTML){sBody=createTextVersion(sBody);}}
var xtmp=mkElement('div',{innerHTML:DOMPurify.sanitize(sBody)});sBody=xtmp.innerHTML;if(this.__output_format){if(xtmp.firstElementChild&&xtmp.firstElementChild.className!=='iw_mail'){var sBodyStyle='';if(this.__font_family)
sBodyStyle='font-family: '+this.__font_family+';';if(this.__font_size)
sBodyStyle+='font-size: '+this.__font_size+'px;';sBody='<div class="iw_mail" dir="'+dir.toLowerCase()+'"'+(sBodyStyle?' style="'+sBodyStyle+'"':'')+'>'+sBody+'</div>';}}
xtmp=null;return sBody.trim();}};_me._insAdjacentHTML=function(elm){if(elm){elm.insertAdjacentHTML.apply(elm,[].slice.call(arguments,1));this._editor.size.syncIframe();}};_me._insTable=function(aData){var me=this,html='<span>&nbsp;</span><table style="width:'+(aData.columns*30)+'px; border: '+aData.border+'px #'+(aData.color||'000000')+'"'+(aData.padding?' cellpadding="'+aData.padding+'"':'')+(aData.spacing?' cellspacing="'+aData.spacing+'"':'')+'>';for(var i=0;i<aData.rows;i++){html+='<tr>';for(var j=0;j<aData.columns;j++)
html+='<td></td>';html+='</tr>';}
html+='</table><span>&nbsp;</span>';this.__exec('html.insert',[html,true],false,function(){me.__exec('undo.saveStep');});};_me.__clickColor=function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm.tagName==='A'){var id=elm.id.substr(elm.id.indexOf('#'));this.__initpopup(id==='#color_picker'?'C':(id==='#color'?'F':'B'),true);}};_me._setFColor=function(color){if(color){var selection=this._getSelection();if(selection&&selection.focusNode&&selection.focusNode.nodeType===3&&selection.focusNode.parentNode.nodeName==='A'){selection.focusNode.parentNode.style.color=color;}else{this.__exec('format.applyStyle',['color',color]);}}else{this.__exec('format.removeStyle',['color']);}};_me._setBColor=function(color){if(color){this.__exec('colors.background',[color]);}else{this.__exec('format.removeStyle',['background-color']);}};_me._setBorderColor=function(color){gui.rich_popup._getAnchor('color_picker').getElementsByTagName('SPAN')[0].style.backgroundColor=this.__oldCcolor=color;};_me.__img_removeEdit=function(bRemove){var out;if(this.__activeImage){if(this.__activeImage.box&&this.__activeImage.box.parentNode)
if(bRemove)
this.__activeImage.box.parentNode.removeChild(this.__activeImage.box);else{this.__img_applyEdit();this.__activeImage.box.parentNode.replaceChild(this.__activeImage.original,this.__activeImage.box);out=this.__activeImage.original;}
delete this.__activeImage;}
this.__editable(true);return out;};_me.__img_applyEdit=function(){var elm=this.__activeImage.original;if(this.__activeImage&&elm){switch(this.__activeImage.mode){case'adopt':elm.style.maxWidth='100%';elm.style.width='auto';elm.style.height='auto';break;case'native':elm.style.maxWidth='';elm.style.width='auto';elm.style.height='auto';break;default:elm.style.maxWidth='';elm.style.width=this.__activeImage.w+'px';elm.style.height=this.__activeImage.h+'px';if(this.__activeImage.abs){elm.style.top=this.__activeImage.abs.t+'px';elm.style.left=this.__activeImage.abs.l+'px';}}}};_me.__img_dispatch=function(){gui._disobeyEvent('mousemove',[this,'__img_resize']);gui._disobeyEvent('mousemove',[this,'__img_move']);return false;};_me.__img_move=function(e,info,arg){if(arg.abs){this.__activeImage.abs.l=arg.abs.l+gui.__X-arg.x;this.__activeImage.box.style.left=this.__activeImage.abs.l+'px';this.__activeImage.abs.t=arg.abs.t+gui.__Y-arg.y;this.__activeImage.box.style.top=this.__activeImage.abs.t+'px';}};_me.__img_resize=function(e,info,arg){if(this.__activeImage){var c=arg.h/arg.w,abs=0;switch(arg['type']){case't':this.__activeImage.h=arg.h-(e.clientY-arg.y);abs=3;break;case'b':this.__activeImage.h=arg.h+e.clientY-arg.y;break;case'lm':this.__activeImage.w=arg.w-(e.clientX-arg.x);abs=3;break;case'rm':this.__activeImage.w=arg.w+e.clientX-arg.x;break;case'lt':if(arg.x-e.clientX<arg.y-e.clientY){this.__activeImage.h=arg.h-(e.clientY-arg.y);this.__activeImage.w=this.__activeImage.h/c;}else{this.__activeImage.w=arg.w-(e.clientX-arg.x);this.__activeImage.h=this.__activeImage.w*c;}
abs=3;break;case'rt':if(e.clientX-arg.x>arg.y-e.clientY){this.__activeImage.h=arg.h-(e.clientY-arg.y);this.__activeImage.w=this.__activeImage.h/c;}else{this.__activeImage.w=arg.w+e.clientX-arg.x;this.__activeImage.h=this.__activeImage.w*c;}
abs=1;break;case'lb':if(arg.x-e.clientX>e.clientY-arg.y){this.__activeImage.h=arg.h+(e.clientY-arg.y);this.__activeImage.w=this.__activeImage.h/c;}else{this.__activeImage.w=arg.w-(e.clientX-arg.x);this.__activeImage.h=this.__activeImage.w*c;}
abs=2;break;case'rb':if(e.clientX-arg.x>e.clientY-arg.y){this.__activeImage.h=arg.h+e.clientY-arg.y;this.__activeImage.w=this.__activeImage.h/c;}else{this.__activeImage.w=arg.w+e.clientX-arg.x;this.__activeImage.h=this.__activeImage.w*c;}
break;}
this.__activeImage.box.style.width=this.__activeImage.w+'px';this.__activeImage.box.style.height=this.__activeImage.h+'px';if(abs&&arg.abs){if(abs&1){this.__activeImage.abs.t=arg.abs.t+arg.h-this.__activeImage.h;this.__activeImage.box.style.top=this.__activeImage.abs.t+'px';}
if(abs&2){this.__activeImage.abs.l=arg.abs.l+arg.w-this.__activeImage.w;this.__activeImage.box.style.left=this.__activeImage.abs.l+'px';}}}};_me.__traverseSelection=function(currentNode,endNode,fromChild){if((Node.TEXT_NODE===currentNode.nodeType&&''!==currentNode.nodeValue.trim())||'BR'===currentNode.nodeName){this.__currentSelectionElements.push(currentNode.parentNode);}
if(currentNode===endNode&&(0===currentNode.childNodes.length||fromChild)){return;}
if(currentNode.childNodes.length>0&&!fromChild){this.__traverseSelection(currentNode.firstChild,endNode);return;}
if(currentNode.nextSibling){this.__traverseSelection(currentNode.nextSibling,endNode);return;}
this.__traverseSelection(currentNode.parentNode,endNode,currentNode);};_me.__mergeStyles=function(styles){var result={},i,property;if(styles.length>0){result=styles[0];}
for(i=1;i<styles.length;i++){for(property in styles[i]){if(styles[i][property]!==styles[0][property]){result[property]=undefined;}}}
return result;};_me._emoji=function(){if(this.__emoji)return;this.__emoji=true;var tmp=mkElement('A',{className:'ico icosmile',title:getLang('SMILES::SMILES'),id:this._pathName+'/emoji'});var me=this;tmp.addEventListener('click',function(e){if(this.classList.contains('active')){me._hideToolbars();}else{me._showToolbar('emoji');me._create('emoji','obj_smilebox','emoji_toolbar','',[function(smile){var src='client/skins/default/images/smiles/'+smile.sprite+'/'+smile.smiley+'.png';var html='<img class="smiley" src="'+src+'" alt="'+smile.name+'" width="20" height="20" style="height: 1.2em; width: 1.2em">';me.__exec('html.insert',[html,true],true,function(){me.__exec('undo.saveStep');});}]);}
e.cancelBubble=true;if(e.stopPropagation)
e.stopPropagation();if(e.preventDefault)
e.preventDefault();return false;});this._getAnchor('additional').appendChild(tmp);};_me.__destruct=function(){try{}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name,'destroy',r);}};

/* client/inc/sha1.js */
function SHA1(msg){function rotate_left(n,s){var t4=(n<<s)|(n>>>(32-s));return t4;};function lsb_hex(val){var str="";var i;var vh;var vl;for(i=0;i<=6;i+=2){vh=(val>>>(i*4+4))&0x0f;vl=(val>>>(i*4))&0x0f;str+=vh.toString(16)+vl.toString(16);}
return str;};function cvt_hex(val){var str="";var i;var v;for(i=7;i>=0;i--){v=(val>>>(i*4))&0x0f;str+=v.toString(16);}
return str;};function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");var utftext="";for(var n=0;n<string.length;n++){var c=string.charCodeAt(n);if(c<128){utftext+=String.fromCharCode(c);}
else if((c>127)&&(c<2048)){utftext+=String.fromCharCode((c>>6)|192);utftext+=String.fromCharCode((c&63)|128);}
else{utftext+=String.fromCharCode((c>>12)|224);utftext+=String.fromCharCode(((c>>6)&63)|128);utftext+=String.fromCharCode((c&63)|128);}}
return utftext;};var blockstart;var i,j;var W=new Array(80);var H0=0x67452301;var H1=0xEFCDAB89;var H2=0x98BADCFE;var H3=0x10325476;var H4=0xC3D2E1F0;var A,B,C,D,E;var temp;msg=Utf8Encode(msg);var msg_len=msg.length;var word_array=new Array();for(i=0;i<msg_len-3;i+=4){j=msg.charCodeAt(i)<<24|msg.charCodeAt(i+1)<<16|msg.charCodeAt(i+2)<<8|msg.charCodeAt(i+3);word_array.push(j);}
switch(msg_len%4){case 0:i=0x080000000;break;case 1:i=msg.charCodeAt(msg_len-1)<<24|0x0800000;break;case 2:i=msg.charCodeAt(msg_len-2)<<24|msg.charCodeAt(msg_len-1)<<16|0x08000;break;case 3:i=msg.charCodeAt(msg_len-3)<<24|msg.charCodeAt(msg_len-2)<<16|msg.charCodeAt(msg_len-1)<<8|0x80;break;}
word_array.push(i);while((word_array.length%16)!=14)word_array.push(0);word_array.push(msg_len>>>29);word_array.push((msg_len<<3)&0x0ffffffff);for(blockstart=0;blockstart<word_array.length;blockstart+=16){for(i=0;i<16;i++)W[i]=word_array[blockstart+i];for(i=16;i<=79;i++)W[i]=rotate_left(W[i-3]^W[i-8]^W[i-14]^W[i-16],1);A=H0;B=H1;C=H2;D=H3;E=H4;for(i=0;i<=19;i++){temp=(rotate_left(A,5)+((B&C)|(~B&D))+E+W[i]+0x5A827999)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=20;i<=39;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+0x6ED9EBA1)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=40;i<=59;i++){temp=(rotate_left(A,5)+((B&C)|(B&D)|(C&D))+E+W[i]+0x8F1BBCDC)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
for(i=60;i<=79;i++){temp=(rotate_left(A,5)+(B^C^D)+E+W[i]+0xCA62C1D6)&0x0ffffffff;E=D;D=C;C=rotate_left(B,30);B=A;A=temp;}
H0=(H0+A)&0x0ffffffff;H1=(H1+B)&0x0ffffffff;H2=(H2+C)&0x0ffffffff;H3=(H3+D)&0x0ffffffff;H4=(H4+E)&0x0ffffffff;}
var temp=cvt_hex(H0)+cvt_hex(H1)+cvt_hex(H2)+cvt_hex(H3)+cvt_hex(H4);return temp.toLowerCase();}

/* client/inc/sip_bridge.js */
var IceSIP=function(config){IceSIP.instantiated=true;var me=this;this.activity=null;this.state=null;this.type=null;config.stun_servers=[];var ws=location.protocol.replace('http','ws')+'//'+document.location.host;config.sockets=[new JsSIP.WebSocketInterface(ws)];config.register_expires=120;config.session_timers=false;this.sip=new JsSIP.UA(config);this.sip.on('registered',function(e){if(me.state!='online'){me.state='online';me.activity='ready';var host=e&&e.data&&e.data.response&&e.data.response.from&&e.data.response.from.uri&&e.data.response.from.uri.host?e.data.response.from.uri.host:'';me.onconnect({host:host});}});this.sip.on('unregistered',function(e){me.state='offline';me.activity=null;me.ondisconnect({reason:'offline'});});this.sip.on('registrationFailed',function(e){me.state='failed';me.activity=null;me.ondisconnect({reason:'failed'});});this.sip.on('newRTCSession',function(e){if(e.session){e.session.on('getusermediafailed',function(e){me.onmedia({granted:false,reason:e&&e.name});});if(e.originator=='remote'){for(var i in me.sip._sessions)
if(e.session._id!=i){e.session.terminate({status_code:486});return;}
me.activity='Ringing';var call=new IceSIP.Call(me,e.session);var session=e.session;var audio=false;var video=false;var ended=function(e){if(audio)
audio.pause();call.onhangup({reason:e.cause||'Ended',remote:e.originator=='remote'});};session.on('ended',ended);session.on('failed',ended);session.on('confirmed',(function(call){return function(e){me.activity='Talking';call.onanswer({name:session._remote_identity._display_name,user:session._remote_identity._uri._user+'@'+session._remote_identity._uri._host});};}(call)));var sdp=e.request.body;var presentation=sdp&&sdp.indexOf("m=video")!=-1&&sdp.indexOf("a=sendonly")!=-1;var video=presentation||sdp&&sdp.indexOf("m=video")!=-1&&sdp.indexOf("a=sendrecv")!=-1;me.oncall({name:session._remote_identity._display_name,user:session._remote_identity._uri._user+'@'+session._remote_identity._uri._host,call:call,video:video,show:presentation});}}});this.sip.on('newMessage',function(e){if(e&&e.originator=='remote'&&e.message){var message=new IceSIP.Message(me,e.message._request.body);message.from=e.message._remote_identity._uri._user+'@'+e.message._remote_identity._uri._host;if(e.message._request.getHeader('X-IceWarp-Conference')){var id=e.message._request.getHeader('X-IceWarp-Conference').match(/id=([0-9]+)/);if(id)
message.conference_id=id[1];var data=e.message._request.getHeader('X-IceWarp-Message').split(',');var tmp=data.pop();do{if(tmp.indexOf("is_private=")===0)
message.group=tmp=="is_private=0"?true:false;else if(tmp.indexOf("from_id=")===0)
message.from_id=tmp.substr(8);}while(tmp=data.pop());}
me.onmessage(message);}});};IceSIP.supported=function(){if(window.RTCPeerConnection&&navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)
return true;else if(document.body&&'WebSocket'in window&&'ActiveXObject'in window){var supported=false;try{if(new ActiveXObject('Tem.TemWebRTCPlugin'))
supported=true;}catch(e){}
return supported;}else if(window.webkitAudioContext){if(navigator.plugins&&navigator.plugins.namedItem&&navigator.plugins.namedItem('TemWebRTCPlugin'))
return true;else
return false;}else return false;};IceSIP.devices=function(callback){if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){navigator.mediaDevices.enumerateDevices().then(function(devices){var media={microphone:false,camera:false};devices.forEach(function(device){switch(device.kind){case'audioinput':media.microphone=true;break;case'videoinput':media.camera=true;break;}});callback(media);}).catch(function(err){callback({});});}else callback({});};IceSIP.instantiated=false;IceSIP.prototype.start=function(){this.sip.start();};IceSIP.prototype.stop=function(){this.sip.stop();};IceSIP.prototype.unregister=function(){this.sip.unregister();};IceSIP.prototype.register=function(){this.sip.register();};IceSIP.prototype.terminate=function(){for(var i in this.sip.sessions)
this.sip.sessions[i].terminate();};IceSIP.prototype.online=function(){return this.sip.isConnected()&&this.sip.isRegistered();};IceSIP.prototype.busy=function(){return!this.sip.isConnected()||!this.sip.isRegistered()||this.activity!='ready';};IceSIP.prototype.onconnect=function(e){console.warn('No handler assigned: Connected to '+e.host);};IceSIP.prototype.ondisconnect=function(e){console.warn('No handler assigned: Disconnected');};IceSIP.prototype.onmedia=function(e){console.warn('No handler assigned: Media');};IceSIP.attachVideoStream=function(stream){var video;if(window.AdapterJS&&AdapterJS.WebRTCPlugin&&AdapterJS.WebRTCPlugin.plugin){var elmId='WebRTCPluginVideo'+Math.random().toString(36).slice(2);var elm=document.createElement('div');elm.innerHTML='<object id="'+elmId+'" type="application/x-temwebrtcplugin">'+'<param name="pluginId" value="'+elmId+'" /> '+'<param name="pageId" value="'+AdapterJS.WebRTCPlugin.pageId+'" /> '+'<param name="windowless" value="true" /> '+'<param name="streamId" value="'+stream.id+'" /> '+'<param name="tag" value="video" /> '+'</object>';video=elm.firstChild;}else{video=document.createElement('video');video.setAttribute('autoplay',true);video.srcObject=stream;}
return video;};IceSIP.Call=function(gear,session){this.sip=gear.sip;this.state=session?'Ringing':'Calling';this.sip.activity=this.state;this.incoming=!!session;this.session=session;};IceSIP.Call.prototype.getLocalStreams=function(){var stream=new MediaStream(),senders=this.session._connection.getSenders();senders.forEach(function(sender){stream.addTrack(sender.track);if(sender.track.kind==='video')
camera=true;});return stream;};IceSIP.Call.prototype.getRemoteStreams=function(){var stream=new MediaStream();this.session._connection.getReceivers().forEach(function(receiver){stream.addTrack(receiver.track);});return stream;};IceSIP.Call.prototype.make=function(address,bVideo,bScreen){var me=this;var mc={audio:true,video:bVideo||false};if(bScreen)
mc.screen=true;var oc={offerToReceiveAudio:true,offerToReceiveVideo:bVideo||false};var audio=false;this.session=this.sip.call('sip:'+address,{eventHandlers:{progress:function(e){me.state='Calling';},connecting:function(e){me.oncalling({call:me.session,name:me.session._remote_identity._display_name,user:me.session._remote_identity._uri._user+'@'+me.session._remote_identity._uri._host});},failed:function(e){me.state='Failed';me.onhangup({reason:e.cause?e.cause:'Unknown',remote:e.originator=='remote'});},confirmed:function(e){if(me.session&&me.session._remote_identity){me.state='Talking';me.onanswer({name:me.session._remote_identity._display_name,user:me.session._remote_identity._uri._user+'@'+me.session._remote_identity._uri._host});}},ended:function(e){me.state='Ended';if(audio)
audio.pause();me.onhangup({reason:'Ended',remote:e.originator=='remote'});},newDTMF:function(e){if(e.originator=='remote')
me.ondial({tone:e.dtmf.tone});},newInfo:function(e){if(e.info){if(e.info.contentType=="application/media_control+xml"){var xml=e.info.body;xml=new DOMParser().parseFromString(xml,'text/xml');var command=xml.getElementsByTagName('to_encoder')[0];command=command.firstElementChild.nodeName;if(command=="picture_fast_update"&&pc){var videotrack=pc.getLocalStreams()[0].getVideoTracks()[0];videotrack.enabled=false;setTimeout(function(){videotrack.enabled=true;},250);}}}},refer:function(e){e.accept();},replaces:function(e){e.accept();}},mediaConstraints:mc,rtcOfferConstraints:oc});var pc=this.session._connection;pc.addEventListener('addstream',function(e){var localstream=me.getLocalStreams(),camera=!mc.screen&&localstream.getVideoTracks().length;var remote=false,local=false;var audiostream=false,videostream=false;if(e.stream.getVideoTracks().length){videostream=e.stream;}
else
if(e.stream.getAudioTracks().length){audiostream=e.stream;audiostream.onaddtrack=function(e){if(e.track.kind=='video'){var localstream=me.getLocalStreams(),camera=localstream.getVideoTracks().length>0;var video={remote:IceSIP.attachVideoStream(e.target),local:camera?IceSIP.attachVideoStream(localstream):false};me.onstreaming({camera:camera?true:false,video:video,audio:false});}};}
if(audiostream){me.session.audio=audio=new Audio();me.session.audio.srcObject=e.stream;me.session.audio.play();}
else
if(videostream){remote=IceSIP.attachVideoStream(e.stream);if(camera){local=IceSIP.attachVideoStream(localstream);local.muted=true;}}
var video=remote||local?{remote:remote,local:camera?local:false}:false;me.onstreaming({camera:camera?true:false,video:video,audio:audiostream});},false);};IceSIP.Call.prototype.answer=function(bShow){var me=this;if(this.sip.isConnected()&&this.sip.isRegistered()&&this.session){var mc={audio:true};if(bShow)
mc.video=false;this.session.answer({mediaConstraints:mc});this.session._connection.addEventListener('addstream',function(e){var remote,local;var ext_stream=me.getRemoteStreams(),video=ext_stream.getVideoTracks().length>0;var loc_stream=me.getLocalStreams(),camera=loc_stream.getVideoTracks().length>0;if(video){remote=IceSIP.attachVideoStream(ext_stream);if(camera){local=IceSIP.attachVideoStream(loc_stream);local.muted=true;}}
else
if(ext_stream.getAudioTracks().length){me.session.audio=audio=new Audio();me.session.audio.srcObject=ext_stream;me.session.audio.play();}
me.onstreaming({name:me.session._remote_identity._display_name,user:me.session._remote_identity._uri._user+'@'+me.session._remote_identity._uri._host,camera:camera,video:video?{remote:remote,local:local}:false,audio:video?false:ext_stream});},false);return true;}else
return false;};IceSIP.Call.prototype.decline=function(){if(this.sip.isConnected()&&this.sip.isRegistered()&&this.session)
this.session.terminate();else
return false;};IceSIP.Call.prototype.dial=function(n,bInband){if(this.sip.isConnected()&&this.sip.isRegistered()&&this.session&&/^[*0-9#]+$/.test(n)){var stream=this.session._localMediaStream;var audio=stream.getAudioTracks()||null;var peer=this.session._connection.pc;if(bInband&&audio&&audio.length&&peer&&peer.createDTMFSender){var dtmf=peer.createDTMFSender(audio[0]);dtmf.ontonechange=function(e){if(e.tone){}};if(dtmf.canInsertDTMF)
dtmf.insertDTMF(n);}else
this.session.sendDTMF(n);}};IceSIP.Call.prototype.mute=function(mute){if(this.session){if(mute)
this.session.mute();else
this.session.unmute();return true;}else
return false;};IceSIP.Call.prototype.hold=function(hold){if(this.session){if(hold)
return this.session.hold();else
return this.session.unhold();}else
return false;};IceSIP.Call.prototype.transfer=function(sip){if(this.session){this.session.refer('sip:'+sip);};};IceSIP.Call.prototype.hangup=function(code){if(this.sip.isConnected()&&this.sip.isRegistered()&&this.session){this.state='Ended';this.sip.activity='Ready';if(this.session._state!=8){if(this.session.audio)
this.session.audio.pause();if(code)
this.session.terminate({status_code:code});else
this.session.terminate();}}};IceSIP.Call.prototype.addvideo=function(code){if(this.sip.isConnected()&&this.sip.isRegistered()&&this.session){var session=this.session;var connection=this.session._connection;var promise=navigator.mediaDevices.getUserMedia({audio:false,video:true});promise.then(function(stream){if('addTrack'in connection){stream.getTracks().forEach(function(track){if(track.kind=='video')
connection.addTrack(track,stream);});}
session.renegotiate({useUpdate:false},function(){console.log("Renegotiate",arguments);});}).catch(function(){});}};IceSIP.Call.prototype.camera=function(conference_id,data){var me=this;var constraints={audio:true,video:true};var addStream=function(stream){me.session.rtcMediaHandler.addStream(stream);};try{navigator.webkitGetUserMedia(constraints,addStream,function(){console.log("No stream!");});}catch(e){console.log('Failed',e);}};IceSIP.Call.prototype.ondial=function(e){console.warn('No handler assigned: '+e.number+' was dialed');};IceSIP.Call.prototype.onanswer=function(e){console.warn('No handler assigned: '+e.user+' has picked up');};IceSIP.Call.prototype.ondecline=function(e){console.warn('No handler assigned: '+e.user+' has declined call');};IceSIP.Call.prototype.oncalling=function(e){console.warn('No handler assigned: you are calling '+e.user);};IceSIP.Call.prototype.onhangup=function(e){console.warn('No handler assigned: '+e.user+' has hanged up');};IceSIP.Conference=function(gear,session){this.sip=gear.sip;this.state='Calling';this.session=session;this.sip.type='Conference';IceSIP.Conference.current=this;this.microphone=true;this.tracking='';};IceSIP.Conference.current=null;IceSIP.Conference.prototype.join=function(conference_id){var me=this;var id=conference_id.match(/^conference\*([0-9]+)/);id=id.length?id[1]:'null';this.full_id=conference_id;this.numeric_id=id;var mc={audio:this.microphone||false,video:false};var oc={offerToReceiveAudio:true,offerToReceiveVideo:false};var guest=window.sPrimaryAccountGUEST?{email:dataSet.get('main',['user']),name:dataSet.get('main',['fullname'])}:false;this.session=this.sip.call('sip:'+conference_id,{eventHandlers:{progress:function(e){me.state='Ringing';},failed:function(e){me.state='Failed';me.onfailed({reason:e.data&&e.data.cause?e.data.cause:'Unknown'});},confirmed:function(e){if(me.session&&me.session._request){me.state='Joining';me.onjoined({audio:true,callid:me.session._request.call_id});}},ended:function(e){me.state='Ended';if(me.session.audio)
me.session.audio.pause();me.onended({reason:'Ended'});},newInfo:function(e){var speakers=e.info.body;if(speakers)
me.oninfo({message:speakers,mimetype:e.info.contentType});}},mediaConstraints:mc,RTCOfferConstraints:oc,extraHeaders:['X-IceWarp-Conference: id='+id,'X-IceWarp-ParticipantData: '+this.tracking],guest:guest});var pc=this.session._connection;pc.addEventListener('addstream',function(e){if(me.session&&me.session._remote_identity){var audiostream=e.stream;if(audiostream){me.session.audio=audio=new Audio();me.session.audio.srcObject=audiostream;var promise=me.session.audio.play();if(promise){promise.catch(function(){gui._create('alert','frm_alert','','',[function(){me.session.audio.play();}],'SIP::ERROR','SIP::PLAYBLOCKED');}).then(function(){});}}}},false);};IceSIP.Sharing=function(conference){this.sip=conference.sip;this.conference_id=conference.full_id;conference.share=this;this.reference=conference.session._dialog._id.call_id;this.live=false;};IceSIP.Sharing.prototype.join=function(){this.screen();};IceSIP.Sharing.prototype.share=function(){var me=this;if(navigator.browser&&navigator.browser.application=="Chrome"){WebRTCSharing.getScreenId(function(error,screen_capture_id){var screen_constraints={audio:false,video:{mandatory:{chromeMediaSource:screen_capture_id?'desktop':'screen',maxWidth:screen.width>1920?1920:screen.width,maxHeight:screen.height>1080?1080:screen.height,maxFrameRate:30},optional:[{minFrameRate:10}]}};if(screen_capture_id)
screen_constraints.video.mandatory.chromeMediaSourceId=screen_capture_id;me.screen(screen_constraints);});}else if(navigator.browser&&navigator.browser.application=="Firefox"){var screen_constraints={video:{mediaSource:"window",width:{max:'1920'},height:{max:'1080'},frameRate:{max:'10'}}};this.screen(screen_constraints);}};IceSIP.Sharing.prototype.screen=function(mc){var me=this;mc=mc||{audio:false,video:false};var conference_id=this.conference_id;var id=conference_id.match(/^conference\*([0-9]+)/);id=id.length?id[1]:'null';var oc={offerToReceiveAudio:false,offerToReceiveVideo:!mc.video};var guest=window.sPrimaryAccountGUEST?{email:dataSet.get('main',['user']),name:dataSet.get('main',['fullname'])}:false;var videostream=null;this.session=this.sip.call('sip:'+this.conference_id,{eventHandlers:{failed:function(e){me.onfailed({reason:e&&e.cause?e.cause:'Unknown'});},confirmed:function(e){if(me.session&&me.session._remote_identity){me.onstarted({sending:!!mc.video});}},ended:function(e){me.onended({reason:'Ended'});}},mediaConstraints:mc,rtcOfferConstraints:oc,extraHeaders:['X-IceWarp-Conference: id='+id,'X-IceWarp-Reference: callid='+me.reference],guest:guest});var pc=this.session._connection;pc.addEventListener('addstream',function(e){if(me.session&&me.session._remote_identity){if(e.stream.getVideoTracks()[0])
videostream=e.stream;var video=false;if(videostream)
video=IceSIP.attachVideoStream(videostream);me.onstarted({receiving:!mc.video,video:video});}},false);};IceSIP.Sharing.prototype.stop=function(){this.live=false;if(this.session)
this.session.terminate();};IceSIP.Conference.prototype.mute=IceSIP.Call.prototype.mute;IceSIP.Conference.prototype.silence=function(quiet){if(this.session&&this.session.audio)
this.session.audio.muted=quiet;};IceSIP.Conference.prototype.leave=function(){if(this.sip.isConnected()&&this.session){this.state='Ended';this.sip.activity='Ready';if(this.session.audio)
this.session.audio.pause();try{this.session.terminate();}catch(e){}}
IceSIP.Conference.current=null;};IceSIP.Conference.prototype.send=function(from,message,to){var me=this;var guest=window.sPrimaryAccountGUEST?{email:dataSet.get('main',['user']),name:dataSet.get('main',['fullname'])}:false;if(this.sip.isConnected()){this.sip.sendMessage('sip:'+this.full_id,message,{eventHandlers:{succeeded:function(e){me.onsent({failed:false});},failed:function(e){me.onsent({failed:true});}},extraHeaders:['Content-Encoding: utf-8','X-IceWarp-Conference: id='+this.numeric_id,'X-IceWarp-Message: from_id=sender,to_id='+(to||'*')+',is_private='+(!to?0:1)],guest:guest});}else
this.onsent({failed:true});};IceSIP.Conference.prototype.message=function(m){if(IceSIP.Conference.current)
IceSIP.Conference.current.onmessage(m);};IceSIP.Conference.prototype.onsent=function(e){console.warn('No handler assigned: '+e.successful+' received');};IceSIP.Conference.prototype.onmessage=function(e){console.warn('No handler assigned: '+e.text+' received');};IceSIP.Conference.prototype.oninfo=function(e){console.warn('No handler assigned: '+e.message+' received');};IceSIP.Conference.prototype.onjoined=function(e){console.warn('No handler assigned: '+e.conference+' started');};IceSIP.Conference.prototype.onfailed=function(e){console.warn('No handler assigned: '+e.conference+' failed');};IceSIP.Conference.prototype.onended=function(e){console.warn('No handler assigned: '+e.conference+' has ended');};IceSIP.Message=function(connection,content){this.sip=connection.sip;this.content=content;};IceSIP.Message.prototype.send=function(to){this.to=to;this.sip.sendMessage('sip:'+to,this.content,{eventHandlers:{succeeded:function(e){me.onsent({failed:false});},failed:function(e){me.onsent({failed:true});}},extraHeaders:[]});};IceSIP.Conference.prototype.onsent=function(e){console.warn('No handler assigned: Message sent '+e.failed);};

/* client/inc/smiles.js */
Smiles={loaded:false,flat_smiles_list:false,smiles_regex:'',smiles_list:{},escape_regex:/([\(\)\[\]\{\}\|\\\/\+\*])/g,loadSmiles:function(callback,context){var req=new XMLHttpRequest();req.addEventListener("load",function(e){this.smiles_list=JSON.parse(e.target.responseText);this.loaded=true;callback&&callback.call(context||this,this.smiles_list);}.bind(this));req.open("GET",'client/skins/'+GWOthers.getItem('LAYOUT_SETTINGS','skin')+'/images/smiles/list.json');req.send();},getSmiles:function(callback,context){if(this.loaded){callback.call(context||this,this.smiles_list);}else{this.loadSmiles(callback,context);}},getFlatSmilesList:function(){if(this.flat_smiles_list!==false){return this.flat_smiles_list;}
this.flat_smiles_list={};for(var type in this.smiles_list){for(var name in this.smiles_list[type]){this.smiles_list[type][name].forEach(function(item){this.flat_smiles_list[item.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(this.escape_regex,'\\$1')]={name:name,type:type};},this);}}
this.smiles_regex=new RegExp('(^|\\B|\\s)('+Object.keys(this.flat_smiles_list).join('|')+')(&|\\B|\\b|\\s)','g');return this.flat_smiles_list;},replaceSmiles:function(text){var list=this.getFlatSmilesList();if(Object.keys(list)){text=text.replace(this.smiles_regex,function(whole,before,match,after){var eImg=mkElement('span',{className:'smile'});eImg.classList.add('smiley-'+list[match.replace(this.escape_regex,'\\$1')].name);eImg.classList.add('sprite-'+list[match.replace(this.escape_regex,'\\$1')].type);return before+eImg.outerHTML+after;}.bind(this));}
return text;},replaceSmilesArray:function(str,sReplace){var sReplace=sReplace||'~~';sPathlist=this.getFlatSmilesList(),arr=[],eImg=mkElement('span',{className:'smile'});str=str.replace(this.smiles_regex,function(whole,before,match,after){eImg.classList.add('smiley-'+sPathlist[match.replace(this.escape_regex,'\\$1')].name);eImg.classList.add('sprite-'+sPathlist[match.replace(this.escape_regex,'\\$1')].type);arr.push(before+eImg.outerHTML+after);return sReplace;}.bind(this));return{string:str,replace:sReplace,smiles:arr};}};Smiles.loadSmiles();

/* client/inc/team_chat_api.js */
(function(){function folderChangeHandler(){this.rooms=0;this.chats=0;}
folderChangeHandler.prototype.__update=function(set,path){if(set!=='folders'){return;}
var folders_raw=dataSet.get('folders',[sPrimaryAccount]);var rooms=0,chats=0;Object.keys(folders_raw).filter(function(folder_name){return folders_raw[folder_name].TYPE==='I';}).forEach(function(folder_name){if(folders_raw[folder_name].RECENT&&folders_raw[folder_name].RECENT!==0){rooms++;chats+=+folders_raw[folder_name].RECENT;}});if(rooms!==this.rooms||chats!==this.chats){this.rooms=rooms;this.chats=chats;TeamChatAPI.Notifier.action('recentchats',{rooms:rooms,chats:chats});}};function getURLParams(){var data={};if(!location.search){return data;}
var regex=/\??([^&]+?)(?:=([^&]+?))?(?=(?:&|#|$))/g;var result;while((result=regex.exec(location.search))!==null){data[result[1]]=result[2]||'';}
return data;}
function xhr(url,data,callback,usePost){for(var i in data){data[i]=(typeof data[i]==='Boolean')?+data[i]:data[i];}
var request=new XMLHttpRequest();if(usePost){request.open('POST',url);}else{request.open("GET",url+'?'+buildURL(data));}
if(callback){request.onload=function(){var response=JSON.parse(this.response);if(response.ok){callback.success&&callback.success.call(callback.context,response);}else{callback.error&&callback.error.call(callback.context,response);}};callback.abort&&(request.onabort=callback.abort.bind(callback.context));callback.error&&(request.onerror=callback.error.bind(callback.context));callback.progress&&(request.onprogress=callback.progress.bind(callback.context));}
request.send(usePost?buildURL(data):data);}
function notify(action,data){data.action=action;data.token=TeamChatAPI.getToken();xhr(TeamChatAPI.getNotifyURI(),data);}
function onStatusChange(users){TeamChatAPI.Notifier.notify({type:'status_change',email:users[0].ATTRIBUTES.STATUSEMAIL,status:+users[0].ATTRIBUTES.STATUSID});}
var rooms={};function getFolderByRelativePath(owner,relative_path){var folders=dataSet.get('folders',[sPrimaryAccount]);if(!rooms[owner]){rooms[owner]={};}
if(rooms[owner][relative_path]){return rooms[owner][relative_path];}
for(var id in folders){if(folders[id].OWNER===owner&&folders[id].RELATIVE_PATH===relative_path){return rooms[owner][relative_path]={id:id,folder:folders[id]};}}}
function onNotify(attr){if(attr['FOLDER-TYPE']=='I'){var room=getFolderByRelativePath(attr.EMAIL,attr.FOLDER.replace(/\\/g,'/'));if(Is.Defined(room)){if(~['comment'].indexOf(attr.ACTION)){return;}
TeamChatAPI.Notifier.notify({type:'notification',notification_action:attr.ACTION,body:attr.TITLE||attr.BODY,from:attr['ORIGINATOR-NAME'],deviceid:attr['ORIGINATOR-DEVICEID'],'item-type':attr['ITEM-TYPE'],room_id:room.id,room_name:room.folder.NAME});}}
else{var callback;if(attr.ACTION=='edit_session_finished'&&attr['ITEM']&&(callback=edit_buffer[attr['ITEM']])){callback&&callback.success&&callback.success.call(callback.context||this);delete edit_buffer[attr['ITEM']];}}}
var edit_buffer={};var network_status=true;var network_timer=false;function onConnectionQueue(){if(!network_status){return;}
network_status=false;TeamChatAPI.Notifier.network(network_status);}
function onConnectionFlush(){if(network_timer){clearTimeout(network_timer);}
network_status=true;network_timer=setTimeout(function(){network_status&&TeamChatAPI.Notifier.network(network_status);},500);}
function onGUIDone(){TeamChatAPI.Notifier.loaded();}
var TeamChatAPI={};TeamChatAPI.url_params=false;TeamChatAPI.init=function(){if(!this.url_params){this.url_params=getURLParams();}
if(!this.listening){this.listening=true;gui.socket&&gui.socket.api._obeyEvent('onStatusChange',[onStatusChange]);gui.socket&&gui.socket.api._obeyEvent('onnotify',[onNotify]);gui.connection._obeyEvent('_queue',[onConnectionQueue]);gui.connection._obeyEvent('_flush',[onConnectionFlush]);gui._obeyEvent('GUIDone',[onGUIDone]);dataSet.obey(new folderChangeHandler(),'_listener','folders');if(this.url_params.tconly){window.onbeforeunload=null;this.hideAllButTeamChat();}}
return this;};TeamChatAPI.hideAllButTeamChat=function(){storage.css('frm_main_desktop');document.body.setAttribute('tconly',true);};TeamChatAPI.teamChatOnly=function(){return!!this.init().url_params.tconly;};TeamChatAPI.getToken=function(){return this.init().url_params.token;};TeamChatAPI.getNotifyURI=function(){return this.init().url_params.notifyuri;};TeamChatAPI.Notifier={};TeamChatAPI.Notifier.ping=function(){TeamChatAPI.teamChatOnly()&&notify('ping',{});};TeamChatAPI.Notifier.action=function(action,data){TeamChatAPI.teamChatOnly()&&notify(action,data||{});};TeamChatAPI.Notifier.notify=function(data){TeamChatAPI.teamChatOnly()&&notify('notify',data||{});};TeamChatAPI.Notifier.loaded=function(data){TeamChatAPI.teamChatOnly()&&notify('loaded',data||{});};TeamChatAPI.Notifier.network=function(status){TeamChatAPI.teamChatOnly()&&notify('loaded',{status:status?'online':'offline'});};TeamChatAPI.changeView=function(folder_id,account){account=account||sPrimaryAccount;if(!folder_id){console.error("Missing folder ID");return this;}
gui.frm_main._selectView({aid:account,fid:folder_id});dataSet.add('active_folder',false,account+'/'+folder_id);return this;};TeamChatAPI.changeViewByRelativePath=function(owner,relative_path,account){if(!owner){console.error("Missing owner");return this;}
if(!relative_path){console.error("Missing relative path");return this;}
var folders=dataSet.get('folders',[account||sPrimaryAccount]);for(var id in folders){if(folders[id].OWNER===owner&&folders[id].RELATIVE_PATH===relative_path){return this.changeView(id,account);}}
console.error("No match for given input");return this;};TeamChatAPI.search=function(query){var chat_object=gui.frm_main.main.tabs.room.list;chat_object._serverSort(chat_object.__aRequestData.folder,true,{search:query});return this;};TeamChatAPI.searchReset=function(){this.search('');return this;};TeamChatAPI.filesEdit=function(aData,mode,callback){var data={token:sPrimaryAccountTeamchatToken,deviceid:dataSet.get('main',['device_id']),mode:mode,fallback:0};if(aData.password){data.password=aData.password;}
if(aData.ticket){data.ticket=aData.ticket;}
else
if(aData.url){data.url=aData.url;}else{data.id=aData.iid.replace('*','');aData.attid&&(data.attid=aData.attid);}
data._=+new Date();xhr(sTeamchatApiUrl+'files.edit',data,callback,true);return this;};TeamChatAPI.filesStopEdit=function(aData,callback,finish_cb){var data={token:sPrimaryAccountTeamchatToken,deviceid:dataSet.get('main',['device_id'])};if(aData.ticket){data.ticket=aData.ticket;}
else
if(aData.url){data.url=aData.url;}
else{data.id=aData.iid.replace('*','');aData.attid&&(data.attid=aData.attid);edit_buffer[data.id]=finish_cb;}
data._=+new Date();xhr(sTeamchatApiUrl+'files.stopedit',data,callback);return this;};TeamChatAPI.filesInvite=function(aData,callback){var data={token:sPrimaryAccountTeamchatToken,id:aData.id,editable:+aData.editable,deviceid:dataSet.get('main',['device_id'])};if(aData.password){data.password=aData.password;}
xhr(sTeamchatApiUrl+'files.invite',data,callback,true);return this;};TeamChatAPI.filesUninvite=function(aData,callback){var data={token:sPrimaryAccountTeamchatToken,id:aData.id,deviceid:dataSet.get('main',['device_id'])};xhr(sTeamchatApiUrl+'files.uninvite',data,callback);return this;};TeamChatAPI.getTeamchatNotificationSettings=function(callback){WMStorage.get({'resources':['teamchat_notify']},'storage','',callback&&[function(){callback(GWOthers.get('TEAMCHAT_NOTIFY','storage').VALUES);}],true);};TeamChatAPI.setTeamchatNotificationSettings=function(settings,callback){var values={};for(var i in settings){values[i]={ATTRIBUTES:{},VALUE:settings[i]};}
var resources={TEAMCHAT_NOTIFY:{ATTRIBUTES:{},ITEMS:[{ATTRIBUTES:{},VALUES:values}]}};WMStorage.set({resources:resources},'storage','',callback&&[callback]);};TeamChatAPI.requestUnlock=function(sFolder,sTitle,sEmail,sType){var room=dataSet.get('folders',[sPrimaryAccount,sFolder]);var group='';if(room.TYPE=='I'&&room.NAME){group=sFolder.split('/');group.splice(-1,1,room.NAME);group=group.join('/');}
var body_header=getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_GREETINGS',[dataSet.get('xmpp',['roster',sEmail,'name'])||sEmail]),body=getLang(sType=='remove'?'DOCUMENT::REQUEST_UNLOCK_REMOVE':'DOCUMENT::REQUEST_UNLOCK_TEXT',[sTitle,(group||room.NAME||room.RELATIVE_PATH)]);if(!dataSet.get('xmpp',['roster',sEmail])||~['both','none','offline','',void 0].indexOf(dataSet.get('xmpp',['roster',sEmail,'show']))){if((TeamChatAPI&&TeamChatAPI.teamChatOnly())||sPrimaryAccountGUEST){Item.sendEmailTo(sEmail,{sBody:'<div>'+body_header+'</div><div><br></div><div>'+body+'</div>',sSubject:getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_SUBJECT',[(group||room.NAME||room.RELATIVE_PATH)+'/'+sTitle]),addSignature:false});}else{NewMessage.compose({to:sEmail,subject:getLang('DOCUMENT::REQUEST_UNLOCK_TEXT_SUBJECT',[(room.NAME||room.RELATIVE_PATH)+'/'+sTitle]),mailBody:'<div>'+body_header+'</div><div><br></div><div>'+body+'</div>'});}}else{gui.frm_main.im._activate(sEmail);gui.frm_main.im._chat(sEmail);gui.frm_chat.tabs[gui.frm_chat.tabs._value()].text._value(body);gui.frm_chat._focus();}};window.TeamChatAPI=TeamChatAPI;}());

/* client/inc/telemetry.js */
function telemetry(){}
telemetry.prototype.__constructor=function(){var me=this;this.__storage={};this.__pending=false;AttachEvent(document.body,'onmouseup',function(e){var e=e||window.event,elm=e.target||e.srcElement;if(elm){while(!elm.id)
if(!(elm=elm.parentNode))
return;if(elm.id){var oid=elm.id.split('#')[0].split('/')[0],obj=arrayPath(window,oid.split('.'));if(obj&&obj._type&&obj._telemetry!='off'){var out={id:obj._telemetry=='full'?elm.id:oid,type:obj._type};if(e.button)
out.button=e.button;if(e.shiftKey)
out.shift=true;if(e.ctrlKey||e.metaKey)
out.ctrl=true;me._add(out);}}}});storage.library('wm_tools');this.tools=new wm_tools();setInterval(function(){me.__store();},30000);};telemetry.prototype._add=function(aIn){var id=buildURL(aIn);try{this.__storage[id]=this.__storage[id]?this.__storage[id]+1:1;}
catch(r){gui._REQUEST_VARS.debug&&console.log(this._name||false,r);}};telemetry.prototype.__response=function(){this.__pending=false;};telemetry.prototype.__store=function(){if(!Is.Empty(this.__storage)&&!this.__pending){this.__pending=true;this.tools.telemetry(this.__storage,[this,'__response']);this.__storage={};}};

/* client/inc/wm_conference.js */
function wm_conference(id,aData){id=id||'tmp';if(!~id.indexOf('_')){id=id+'_'+location.hostname;}
this.id=id;this.messageID=1;this.messageCallbacks={};this.data=aData||{};this.isRunning=false;wm_conference.conferences[id]=this;var windowExistsInterval=setInterval(function(){if(this.isRunning&&(!this.window||this.window.closed)){clearInterval(windowExistsInterval);this.close();}}.bind(this),1000);};wm_conference.linkRegExp=/https?:\/\/([^\/]*)\/(?:conference\/|.*\?meeting=)([0-9]{5,})/;wm_conference.conferences={};wm_conference.get=function(id,aData){return wm_conference.conferences[id]||new wm_conference(id,aData);};wm_conference.create=function(callback,options){options=options||{};icewarpapi.send({commandname:'GWAddMeetingInfo',commandparams:{meetingtype:'conference',organizer:sPrimaryAccount,summary:options.subject||'',password:options.password||'',folder:options.folder||''}},{success:function(response){var conference=wm_conference.get(response.meetingid);Object.assign(conference.data,options);conference.getDetail(function(){callback(conference);});},error:function(error){console.error('Unable to create conference',error);},context:this});};var _me=wm_conference.prototype;_me.getDetail=function(callback){icewarpapi.authenticate({success:function(){icewarpapi.send({commandname:'GWGetMeetingInfo',commandparams:{meetingid:this.id}},{success:function(response){for(var i in response){this.data[i]=response[i]||this.data[i];}
this.data.organizer=this.data.organizer||sPrimaryAccount;callback(this.data);},error:function(error){console.error('Unable to get conference detail',error);},context:this});},context:this});};_me.join=function(){if(this.isRunning){return this.focus();}
var conference=wm_conference.conferences[dataSet.get('main',['conference'])];if(conference&&conference.window){gui.notifier._value({type:'conference',args:{header:'CONFERENCE::CANNOT_START_NEW',text:getLang('CONFERENCE::ALREADY_RUNNING')}});return conference.focus();}
this.getDetail(function(){this.open();}.bind(this));};_me.invite=function(aRecipients){gui.frm_main.im&&(aRecipients||[]).forEach(function(sRecipient){gui.frm_main.im._send(sRecipient,getLang('CONFERENCE::CHATINVITE',[this.getLink()]),void 0,true);},this);};_me.focus=function(){this.isRunning=true;this.window&&!this.window.closed&&this.window.focus();};_me.open=function(){this.window=open(this.getLink(),'jitsi_'+sPrimaryAccount,'menubar=no,location=no,resizable=yes,scrollbars=no,status=no');this.isRunning=true;};_me.close=function(){this.isRunning=false;if(this.window&&!this.window.closed){this.postMessage({event:'executeCommand',args:['hangup']},function(){this.window.close();this.window=null;dataSet.remove('main',['conference']);gui.__exeEvent('conference_ended');gui.__exeEvent('conference_window_closed');delete wm_conference.conferences[this.id];}.bind(this));}else{dataSet.remove('main',['conference']);gui.__exeEvent('conference_ended');gui.__exeEvent('conference_window_closed');delete wm_conference.conferences[this.id];}};_me.postMessage=function(data,callback){if(!this.window||this.window.closed){return;}
if(callback){this.messageCallbacks[this.messageID]=callback;}
data.cid=this.id;data.mid=this.messageID++;this.window.postMessage(data,'*');};_me.receiveMessage=function(event){switch(event.data.event){case'readyToClose':setTimeout(function(){this.close();}.bind(this),500);break;case'setup':this.postMessage({event:'setup',data:{session:dataSet.get('main',['sid']),password:this.data.password,language:(GWOthers.getItem('LAYOUT_SETTINGS','language')||navigator.language||navigator.userLanguage).split(/[_-]/)[0]}});break;case'load':dataSet.add('main',['conference'],this.id);Object.assign(this.data,event.data.data);this.isRunning=true;this.window=event.source;this.getDetail(function(){gui.__exeEvent('conference_started');}.bind(this));break;default:gui.__exeEvent('conference_event',event.data);}
if(event.data.mid&&this.messageCallbacks[event.data.mid]){this.messageCallbacks[event.data.mid](event.data.data);delete this.messageCallbacks[event.data.mid];}};_me.getLink=function(){var ids=this.id.split(/[_@]/);var host=ids[1]?'https://'+ids[1]:location.origin;return host+'/conference/'+ids[0];};

/* client/inc/wm_domains.js */
function wm_domains(){};var _me=wm_domains.prototype;_me.get=function(sDataSet,bSet){if(!sDataSet)return;var aDomains=dataSet.get(sDataSet,['DOMAINS_SETTINGS','ITEMS']);if(typeof aDomains=='object'){var aDomainValues=[];for(var n in aDomains){if(aDomains[n]['VALUES']&&aDomains[n]['VALUES']['DOMAIN']&&(!bSet||(bSet&&aDomains[n].VALUES.DOMAIN.ATTRIBUTES.SET)))
aDomainValues.push({'domain':aDomains[n]['VALUES']['DOMAIN']['VALUE']});}}
return aDomainValues;};_me.set=function(aDomainsInfo,sDataSet){if(!sDataSet)
return false;if(typeof aDomainsInfo=='object'){if(compareObj(this.get(sDataSet,true),aDomainsInfo))return;var aDomains={"ITEMS":[],"ATTRIBUTES":{"DONT_SEND":false}};var aDomainInfo,aItem,aValues;for(var n in aDomainsInfo){aDomainInfo=aDomainsInfo[n];aItem={"ATTRIBUTES":{"DONT_SEND":false},"VALUES":{}};aValues=aItem['VALUES'];for(var sValue in aDomainInfo)
aValues[sValue.toUpperCase()]={"VALUE":aDomainInfo[sValue],"ATTRIBUTES":{}};aDomains['ITEMS'].push(aItem);}}
dataSet.add(sDataSet,['DOMAINS_SETTINGS'],aDomains);return true;};

/* client/inc/wm_freebusy.js */
function wm_freebusy()
{this.xmlns='freebusy';}
wm_freebusy.inherit(wm_generic);var _me=wm_freebusy.prototype;_me.get=function(aFreebusyInfo,sDataSet,aDataPath,aHandler)
{if(aHandler){var aRequest={ACCOUNT:[{VALUE:sPrimaryAccount}]};if(aFreebusyInfo.from)
aRequest.FROM=[{VALUE:aFreebusyInfo.from}];if(aFreebusyInfo.to)
aRequest.TO=[{VALUE:aFreebusyInfo.to}];if(aFreebusyInfo.evnid)
aRequest.EVN_ID=[{VALUE:aFreebusyInfo.evnid}];if(aFreebusyInfo.tzid)
aRequest.TZID=[{VALUE:aFreebusyInfo.tzid}];else
aRequest.CTZ=[{VALUE:new IcewarpDate().utcOffset()}];aRequest.USERS=[{USER:[]}];var tmp;for(var i in aFreebusyInfo.users){tmp={VALUE:aFreebusyInfo.users[i]};if(aFreebusyInfo.evnid&&aFreebusyInfo.owner==aFreebusyInfo.users[i])
tmp.ATTRIBUTES={OWNER:'true'};aRequest.USERS[0].USER.push(tmp);}
this.create_iq(aRequest,[this,'response',[aHandler,aFreebusyInfo.from,aFreebusyInfo.to]]);return true;}};_me.response=function(aData,aHandler,iFrom,iTo){var aXMLResponse=aData['Array'],aIQAttribute=aXMLResponse['IQ'][0]['ATTRIBUTES'];var out={},bOK=false;if(aIQAttribute['TYPE']=='result'){bOK=true;var itm,uid,tmp,user=aXMLResponse.IQ[0].QUERY[0].USER;for(var i=0;i<user.length;i++){if(!user[i].ITEM)continue;for(var j=0,k=user[i].ITEM.length;j<k;j++){itm=user[i].ITEM[j];uid=itm.ATTRIBUTES.UID;tmp={ACCOUNT:user[i].ATTRIBUTES.EMAIL};if(itm.ATTRIBUTES&&itm.ATTRIBUTES.EVNUID)
tmp.EVNUID=itm.ATTRIBUTES.EVNUID;for(var l in itm){if(itm[l][0]&&Is.Defined(itm[l][0].VALUE))
tmp[l]=itm[l][0].VALUE;}
out[uid]=tmp;}}}
executeCallbackFunction(aHandler,bOK,out);};

/* client/inc/wm_import.js */
function wm_import(){this.xmlns='import';};wm_import.inherit(wm_generic);var _me=wm_import.prototype;_me.import_data=function(aData,callback)
{var aRequest={'IMPORT':[{'ATTRIBUTES':{'ACTION':aData.action},'ACCOUNT':[{'ATTRIBUTES':{'UID':aData.account}}],'FULLPATH':[{'VALUE':aData.path}]}]};if(aData.action!='groupware'){if(aData.action=='csv'){if(aData.lines)
aRequest.IMPORT[0].LINES=[{VALUE:aData.lines}];if(aData.skipfirst)
aRequest.IMPORT[0].SKIPFIRST=[{VALUE:'true'}];if(aData.charset)
aRequest.IMPORT[0].CHARSET=[{VALUE:aData.charset}];if(aData.format)
aRequest.IMPORT[0].FORMAT=[{VALUE:aData.format}];if(aData.values){aRequest.ACCOUNT=[{ATTRIBUTES:{UID:aData.account},FOLDER:[{ATTRIBUTES:{UID:aData.folder},ITEM:[aData.values]}]}];aRequest.ACCOUNT[0].FOLDER[0].ITEM[0].ATTRIBUTES={action:'add'};if(aData['share'])
aRequest.ACCOUNT[0].FOLDER[0].ITEM[0].VALUES[0].ITMSHARETYPE=[{VALUE:aData['share']}];delete aRequest.IMPORT[0].ACCOUNT;}}
else
if(aData.folder)
aRequest.IMPORT[0].ACCOUNT[0].FOLDER=[{ATTRIBUTES:{UID:aData.folder}}];}
if(callback){this.create_iq(aRequest,[this,function(aResponse){if(aResponse&&aResponse['Array']&&aResponse['Array']['IQ']&&aResponse['Array']['IQ'][0]){var aIQ=aResponse['Array']['IQ'][0];if(aIQ['ATTRIBUTES']['TYPE']=='result')
var result=aData.lines?this.parse(aResponse):true;else if(aIQ['ATTRIBUTES']['TYPE']=='error')
var result=aIQ['ERROR'][0]['VALUE'];executeCallbackFunction(callback,result);}}],'',aData.lines?'get':'set');}else{var aResponse=this.create_iq(aRequest,'','',aData.lines?'get':'set');if(aResponse&&aResponse['IQ']&&aResponse['IQ'][0]){var aIQ=aResponse['IQ'][0];if(aIQ['ATTRIBUTES']['TYPE']=='result'){if(aData.lines)
return this.parse(aResponse);return true;}
else
return false;}else
return false;}};_me.import_progress=function(callback){var aRequest={'IMPORT':[{'ATTRIBUTES':{'ACTION':'status'}}]};this.create_iq(aRequest,[this,function(aResponse){var result={};if(aResponse&&aResponse['Array']&&aResponse['Array']['IQ']&&aResponse['Array']['IQ'][0]){var aIQ=aResponse['Array']['IQ'][0];if(aIQ['ATTRIBUTES']['TYPE']=='result')try{result.complete=aIQ['QUERY'][0]['IMPORT'][0]['STATUS'][0]['COMPLETED'][0]['VALUE']=='1'?true:false;if(!result.complete){result.progress=aIQ['QUERY'][0]['IMPORT'][0]['STATUS'][0]['PROCESSED'][0]['VALUE'];result.total=aIQ['QUERY'][0]['IMPORT'][0]['STATUS'][0]['TOTAL'][0]['VALUE'];}}catch(e){result={complete:true};}
executeCallbackFunction(callback,result);}}]);}
_me.parse=function(aData)
{try
{var aFrame=aData['IQ'][0]['QUERY'][0]['IMPORT'][0]['ROW'];var aResult=[],tmp;for(var i in aFrame){tmp=[];for(var j in aFrame[i].COL)
tmp.push(aFrame[i].COL[j].VALUE)
aResult.push(tmp);}
return aResult;}
catch(e){return false;}};

/* client/inc/wm_messages.js */
function wm_messages()
{this.xmlns='message';};wm_messages.inherit(wm_generic);var _me=wm_messages.prototype;_me.dial=function(sPhoneNumber,aHandler){this.create_iq({"DIAL":[{"PHONE":[{"VALUE":sPhoneNumber}]}]},[this,'response',['dial','','',aHandler]],'','set');}
_me.add=function(aMessageInfo,sDataSet,aDataPath,aHandler,aHandler2)
{if(typeof aMessageInfo['action']!='object')
return false;var aRequest={"MESSAGE":[]};var aFrame=aRequest['MESSAGE'][0]={};aFrame.RFC_DATE=[{'VALUE':(new IcewarpDate(new Date,{locale:'en'})).format('rfc2822')}];var sAccId;var sFolId;var sItmId;var bSave;var bSaved;for(var sTag in aMessageInfo)
switch(sTag)
{case'action':aFrame['ACTION']=[{}];var aActFrame=aFrame['ACTION'][0],aAction=aMessageInfo['action'];if(aAction['email']&&aAction['im']&&aAction['keep']&&aAction['html_body'])
{if(aAction['email'])
aActFrame['SEND_AS_EMAIL']=[{'VALUE':aAction['email']}];if(aAction['im'])
aActFrame['SEND_AS_IM']=[{'VALUE':aAction['im']}];if(aAction['smart_attach']){aActFrame['SMART_ATTACH']=[{'VALUE':aAction['smart_attach']}];if(aAction['smart_attach_folder'])
aActFrame['SMART_ATTACH_FOLDER']=[{'VALUE':aAction['smart_attach_folder']}];}
if(aAction['sms'])
aActFrame['SEND_AS_SMS']=[{'VALUE':aAction['sms']}];aActFrame['KEEP_ATTACHMENTS']=[{'VALUE':aAction['keep']}];aActFrame['HTML_BODY']=[{'VALUE':aAction['html_body']}];}
else
return false;if(aAction['smtp_relay'])
aActFrame['SMTP_RELAY']=[{'VALUE':aAction['smtp_relay']}];if(aAction['encrypt'])
aActFrame['ENCRYPT']=[{'VALUE':aAction['encrypt']}];if(aAction['sign'])
aActFrame['SIGN']=[{'VALUE':aAction['sign']}];if(aAction['auto_addressbook'])
aActFrame['AUTO_ADDRESSBOOK']=[{'VALUE':aAction['auto_addressbook']}];if(typeof aAction['save']=='object')
{var aSave=aAction['save'];if(aSave['aid']&&aSave['fid'])
{sAccId=aSave['aid'];sFolId=aSave['fid'];bSave=true;if(aSave['iid'])
{sItmId=aSave['iid'];bSaved=true;aActFrame['SAVE_TO_FOLDER']=[{'ACCOUNT':[{'VALUE':sAccId}],'FOLDER':[{'VALUE':sFolId}],'ITEM':[{'VALUE':WMItems.__serverID(sItmId)}]}];}
else
aActFrame['SAVE_TO_FOLDER']=[{'ACCOUNT':[{'VALUE':sAccId}],'FOLDER':[{'VALUE':sFolId}]}];}
else
return false;}
if(typeof aAction['save_chat']=='object')
{var aSave=aAction['save_chat'];if(aSave['aid']&&aSave['fid'])
{sAccId=aSave['aid'];sFolId=aSave['fid'];if(aSave['iid'])
{sItmId=aSave['iid'];aActFrame['SAVE_TO_TEAMCHAT']=[{'ACCOUNT':[{'VALUE':sAccId}],'FOLDER':[{'VALUE':sFolId}],'ITEM':[{'VALUE':WMItems.__serverID(sItmId)}]}];}
else
aActFrame['SAVE_TO_TEAMCHAT']=[{'ACCOUNT':[{'VALUE':sAccId}],'FOLDER':[{'VALUE':sFolId}]}];}
else
return false;}
break;case'attachments':if(typeof aMessageInfo['attachments']=='object')
{aFrame['ATTACHMENTS']=[];var aAttachFrame=aFrame['ATTACHMENTS'][0]={'ATTACHMENT':[]};var aAttachments=aMessageInfo['attachments'];for(var n in aAttachments)
if(typeof aAttachments[n]=='object')
{var aValFrame=aAttachFrame['ATTACHMENT'][n]={'VALUES':[]};aValFrame=aValFrame['VALUES'][0]={};var aAttachment=aAttachments[n];for(var sValue in aAttachment)
aValFrame[sValue]=[{'VALUE':aAttachment[sValue]}];}
else
return false;}
else
return false;break;case'distrib':if(typeof aMessageInfo['distrib']=='object')
aFrame['DISTRIB']=wm_messages.parse_distrib(aMessageInfo['distrib']);else
return false;break;case'headers':if(typeof aMessageInfo['headers']=='object')
{aFrame['CUSTOM_HEADERS']=[];var aHeadFrame=aFrame['CUSTOM_HEADERS'][0]={'HEADER':[]};var aHeaders=aMessageInfo['headers'];for(var n in aHeaders)
aHeadFrame['HEADER'][n]={'VALUE':aHeaders[n]};}
else
return false;break;default:aFrame[sTag]=[{'VALUE':aMessageInfo[sTag]}];}
if(sDataSet||aHandler)
{this.create_iq(aRequest,[this,'response',['add',sDataSet,aDataPath,aHandler]],aHandler2,'set');if(bSave&&sDataSet)
{if(typeof aDataPath=='object')
{aDataPath.push(sAccId);aDataPath.push(sFolId);aDataPath.push(sItmId);}
else
aDataPath=[sAccId,sFolId,sItmId];delete aMessageInfo['action'];dataSet.add(sDataSet,aDataPath,aMessageInfo);}
return true;}
else
{var aResponse=this.create_iq(aRequest,'','','set');try
{var aIQ=aResponse['IQ'][0];if(aIQ['ATTRIBUTES']['TYPE']=='result')
if(bSave&&!bSaved)
return aIQ['MESSAGE'][0]['ATTRIBUTES']['UID'];else
return true;}
catch(e){gui._REQUEST_VARS.debug&&console.log(this._name||false,e);}}
return false;};_me.response=function(aData,sMethodName,sDataSet,aDataPath,aHandler)
{try
{var aXMLResponse=aData['Array'];var aIQAttribute=aXMLResponse['IQ'][0]['ATTRIBUTES'];switch(sMethodName)
{case'add':if(typeof aHandler=='object'){var aResult;var sUId;if(aIQAttribute['TYPE']=='result')
{aResult=aXMLResponse['IQ'][0]['QUERY'][0];if(aResult['MESSAGE']&&aResult['MESSAGE'][0]['ATTRIBUTES'])
sUId=WMItems.__clientID(aResult['MESSAGE'][0]['ATTRIBUTES']['UID']);else
sUId=-1;var aOut={};for(var i in aResult['MESSAGE'][0])
if(aResult['MESSAGE'][0][i][0]&&aResult['MESSAGE'][0][i][0].VALUE)
aOut[i]=aResult['MESSAGE'][0][i][0].VALUE;executeCallbackFunction(aHandler,aOut,sUId,'');}
else
{aResult=aXMLResponse['IQ'][0]['ERROR'][0];sUId=aResult['ATTRIBUTES']['UID'];executeCallbackFunction(aHandler,false,sUId,aResult['VALUE']);}}
break;case'dial':if(typeof aHandler=='object')
executeCallbackFunction(aHandler,aIQAttribute['TYPE']=='result');break;}
return true;}
catch(e)
{return false;}};wm_messages.parse_distrib=function(aDistrib){var aDistribAccFrame=[];var aDistribFolFrame,aDistribTypeFrame,aDistribNameFrame;var aDistribAccount,aDistribFolder,aDistribType;for(var sAccId in aDistrib)
{aDistribFolFrame=[];aDistribAccount=aDistrib[sAccId];for(var sFolId in aDistribAccount)
{aDistribTypeFrame={};aDistribFolder=aDistribAccount[sFolId];for(var sType in aDistribFolder)
{aDistribNameFrame=[];aDistribType=aDistribFolder[sType];for(var n in aDistribType)
aDistribNameFrame.push({'VALUE':aDistribType[n]});aDistribTypeFrame[sType]=aDistribNameFrame;}
aDistribFolFrame.push({'TO':aDistribTypeFrame['to'],'CC':aDistribTypeFrame['cc'],'BCC':aDistribTypeFrame['bcc'],'ATTRIBUTES':{'uid':sFolId}});}
aDistribAccFrame.push({'FOLDER':aDistribFolFrame,'ATTRIBUTES':{'uid':sAccId}});}
return[{'ACCOUNT':aDistribAccFrame}];};message=new wm_messages;

/* client/inc/wm_spellchecker.js */
function wm_spellchecker(){this.xmlns='spellchecker';};wm_spellchecker.inherit(wm_generic);var _me=wm_spellchecker.prototype;_me.get=function(aSpellcheckerInfo,aHandler)
{if(!aSpellcheckerInfo['type']||!aSpellcheckerInfo['lang']||!aSpellcheckerInfo['input'])
return false;var aRequest;switch(aSpellcheckerInfo['type'])
{case'check':if(typeof aSpellcheckerInfo['input']!='string')
return false;aRequest={'CHECK':[{'ATTRIBUTES':{'UID':aSpellcheckerInfo['lang']},'TEXT':[{'VALUE':aSpellcheckerInfo['input']}]}]};break;case'suggest':if(typeof aSpellcheckerInfo['input']!='string')
return false;aRequest={'CHECK':[{'ATTRIBUTES':{'UID':aSpellcheckerInfo['lang']},'TEXT':[{'VALUE':aSpellcheckerInfo['input']}],'SUGGEST':[{}]}]};break;case'dictionary':if(typeof aSpellcheckerInfo['input']!='object')
return false;aRequest={'DICTIONARY':[{'ATTRIBUTES':{'UID':aSpellcheckerInfo['lang']},'SUGGEST':[{}]}]};var aSuggestFrame=aRequest['DICTIONARY'][0]['SUGGEST'];for(var n in aSpellcheckerInfo['input'])
aSuggestFrame.push({'ATTRIBUTES':{'WORD':aSpellcheckerInfo['input'][n]}});}
if(!aHandler)
return this.parse(this.create_iq(aRequest));else
{this.create_iq(aRequest,[this,'response',['get',aHandler]]);return true;}};_me.set=function(aSpellcheckerInfo,aHandler)
{if(!aSpellcheckerInfo['lang']||!aSpellcheckerInfo['input']||typeof aSpellcheckerWords!='object')
return false;var aRequest={'DICTIONARY':[{'ATTRIBUTES':{'UID':aSpellcheckerInfo['lang']},'ADD':[]}]};var aAddFrame=aRequest['DICTIONARY'][0]['ADD'];for(var n in aSpellcheckerInfo['input'])
aAddFrame.push({'VALUE':aSpellcheckerInfo['input'][n]});if(!aHandler)
{var aResponse=this.create_iq(aRequest,'','','set');try
{if(aResponse['IQ'][0]['ATTRIBUTES']['TYPE']=='result')
return true;}
catch(e){}
return false;}
else
{this.create_iq(aRequest,[this,'response',['set',aHandler]],'','set');return true;}};_me.response=function(aResponse,sMethodName,aHandler){if(Is.Object(aHandler)){try{var aXMLResponse=aResponse['Array'];var aIQAttribute=aXMLResponse['IQ'][0]['ATTRIBUTES'];var bOK=aIQAttribute['TYPE']=='result';switch(sMethodName){case'set':executeCallbackFunction(aHandler,bOK);break;case'get':executeCallbackFunction(aHandler,bOK,this.parse(aXMLResponse));}}
catch(e){console.warn('spellchecker error',e);}}};_me.parse=function(aData){try{var aQuery=aData['IQ'][0]['QUERY'][0];var sType;if(aQuery['CHECK'])
sType='CHECK';else
sType='DICTIONARY';var aQueryType=aQuery[sType][0];var aResult=[];for(var sTag in aQueryType)
switch(sTag){case'WORD':for(var n in aQueryType['WORD'])
aResult.push(aQueryType['WORD'][n]['VALUE']);break;case'SUGGEST':var aSuggest=aQueryType['SUGGEST'];var sOrigWord,aOrigWordFrame;for(var n in aSuggest){sOrigWord=aSuggest[n]['ATTRIBUTES']['WORD'];aOrigWordFrame=aSuggest[n]['WORD'];aResult[sOrigWord]=[];for(var m in aOrigWordFrame)
aResult[sOrigWord].push(aOrigWordFrame[m]['VALUE']);}}
return aResult;}
catch(e){return false;}};

/* client/inc/wm_tools.js */
function wm_tools()
{this.xmlns='tools';}
wm_tools.inherit(wm_generic);var _me=wm_tools.prototype;_me.weather=function(aItemInfo,aHandler){var aRequest={'TOOLS':[{'WEATHER':[{'ITEM':[]}]}]};for(var i in aItemInfo)
aRequest.TOOLS[0].WEATHER[0].ITEM.push({CITY:[{VALUE:aItemInfo[i]}]});this.create_iq(aRequest,[this,'response',['weather',aHandler]]);};_me.quota=function(aItemInfo,aHandler){var aRequest={'TOOLS':[{'QUOTA':[{'ITEM':[]}]}]};for(var i in aItemInfo)
aRequest.TOOLS[0].QUOTA[0].ITEM.push({ACCOUNT:[{VALUE:aItemInfo[i]}]});this.create_iq(aRequest,[this,'response',['quota',aHandler]]);};_me.distrib=function(sListName,aHandler){if(!sListName||!sListName.name||!aHandler)return;if(!sListName.aid&&!sListName.fid){var aDistribList=MailAddress.findDistribList({'to':sListName.name}),aid='',fid='';for(aid in aDistribList.distrib)
for(fid in aDistribList.distrib[aid])
sListName.name=aDistribList.distrib[aid][fid].to[0];if(aid&&fid){sListName.aid=aid;sListName.fid=fid;}
else
return;}
var aRequest={'TOOLS':[{'DISTRIB':[{'ITEM':[{'ACCOUNT':[{'ATTRIBUTES':{'UID':sListName.aid},'FOLDER':[{'ATTRIBUTES':{'UID':sListName.fid},'NAME':[{'VALUE':sListName.name}]}]}]}]}]}]};this.create_iq(aRequest,[this,'response',['distrib',aHandler]]);};_me.personality=function(aInfo,aHandler){if(aInfo.email){var aRequest={'TOOLS':[{'PERSONALITY':[{'NAME':[{'VALUE':aInfo.name}],'EMAIL':[{'VALUE':aInfo.email}],'ISDELEGATE':[{'VALUE':aInfo.isdelegate}]}]}]};this.create_iq(aRequest,[this,'response',['personality',aHandler]],'','set');}};_me.telemetry=function(aData,aHandler){if(aData){var tmp,a,aRequest={'TOOLS':[{'TELEMETRY':[{CLICK:[]}]}]};for(var i in aData)
if(aData[i]){tmp=parseURL(i);a={COUNT:[{'VALUE':aData[i]}]};a.ELEMENT=[{'VALUE':tmp.id}];delete tmp.id;for(var k in tmp)
if(tmp[k])
a[k.toUpperCase()]=[{'VALUE':tmp[k]}];aRequest.TOOLS[0].TELEMETRY[0].CLICK.push(a);}
this.create_iq(aRequest,[this,'response',['telemetry',aHandler]],'','set');}};_me.timezone=function(aTimeInfo,aHandler)
{var ctz=new IcewarpDate().utcOffset(),aRequest={TOOLS:[{TIMEZONE:[{SOURCE:[{ATTRIBUTES:{TYPE:aTimeInfo.from?'tzid':'ctz'},VALUE:aTimeInfo.from||ctz}],DEST:[{ATTRIBUTES:{TYPE:aTimeInfo.to?'tzid':'ctz'},VALUE:aTimeInfo.to||ctz}],TIMES:[{ITEM:[]}]}]}]};for(var i in aTimeInfo.times)
aRequest.TOOLS[0].TIMEZONE[0].TIMES[0].ITEM.push({ATTRIBUTES:{UID:i},DATE:[{VALUE:aTimeInfo.times[i].date}],TIME:[{VALUE:aTimeInfo.times[i].time}]});if(aHandler)
this.create_iq(aRequest,[this,'response',['timezone',aHandler]]);else
return this.parse(this.create_iq(aRequest));return true;};_me.delivery_report=function(aItemInfo,aHandler){var aRequest={TOOLS:[{DELIVERY_REPORT:[{MESSAGE:[{ITEM:[{MESSAGE_ID:[{VALUE:aItemInfo.id}],UNIX_TIME:[{VALUE:aItemInfo.date}]}]}]}]}]};if(aHandler)
this.create_iq(aRequest,[this,'response',['delivery_report',aHandler]]);};_me.revoke_sent=function(aItemInfo,aHandler){var aRequest={TOOLS:[{CANCEL_DELIVERY:[{MESSAGE:[{ITEM:[{MESSAGE_ID:[{VALUE:aItemInfo.id}],UNIX_TIME:[{VALUE:aItemInfo.date}]}]}]}]}]};if(aHandler)
this.create_iq(aRequest,[this,'response',['cancel_delivery',aHandler]],undefined,'set');};_me.ticket=function(aItemInfo,sRights,aHandler){var aRequest={TOOLS:[{TICKET:[{ACCOUNT:[{ATTRIBUTES:{UID:aItemInfo['aid']},FOLDER:[{ATTRIBUTES:{UID:aItemInfo['fid']},ITEM:[{ATTRIBUTES:{UID:WMItems.__serverID(aItemInfo['iid'])},RIGHTS:[{VALUE:(sRights||'rl')}]}]}]}]}]}]};if(aItemInfo['attid'])
aRequest.TOOLS[0].TICKET[0].ACCOUNT[0].FOLDER[0].ITEM[0].ATTACHMENT=[{ATTRIBUTES:{UID:aItemInfo['attid']}}];if(aHandler)
this.create_iq(aRequest,[this,'response',['ticket',aHandler]]);};_me.response=function(aData,sType,aHandler){var aXMLResponse=aData['Array'];var aIQAttribute=aXMLResponse['IQ'][0]['ATTRIBUTES'];if(aIQAttribute['TYPE']=='result')
executeCallbackFunction(aHandler,this.parse(aXMLResponse)||true);else
executeCallbackFunction(aHandler,false);};_me.parse=function(aData)
{if(!aData['IQ'][0]['QUERY'][0].TOOLS)return'';var aResult={},aItems=aData['IQ'][0]['QUERY'][0]['TOOLS'][0];if(aItems.QUOTA){aItems=aItems.QUOTA[0].ITEM;for(var i in aItems)
aResult[aItems[i].ATTRIBUTES.UID]={quota:aItems[i].QUOTA[0].VALUE,size:aItems[i].SIZE[0].VALUE};}
else
if(aItems.WEATHER){aItems=aItems.WEATHER[0].ITEM;for(var i in aItems)
aResult[aItems[i].ATTRIBUTES.UID]={city:aItems[i].CITY[0].VALUE};}
else
if(aItems.TIMEZONE){aItems=aItems.TIMEZONE[0].TIME[0].ITEM;for(var i in aItems)
aResult[aItems[i].ATTRIBUTES.UID]={date:parseInt(aItems[i].DATE[0].VALUE,10),time:parseInt(aItems[i].TIME[0].VALUE,10)};}
else
if(aItems.DELIVERY_REPORT){aResult=[];aItems=aItems.DELIVERY_REPORT[0].MESSAGE[0].ITEM[0].REPORT[0].RECIPIENTS[0].RECIPIENT;for(var i in aItems)
aResult.push({'email':aItems[i].EMAIL[0].VALUE,'status':aItems[i].STATUS[0].VALUE,'error':aItems[i].ERROR?aItems[i].ERROR[0].VALUE:'','time':aItems[i].TIME[0].VALUE});}
else
if(aItems.DISTRIB){var aResult=[],aItem=aItems.DISTRIB[0].ITEM[0].CONTACTS[0].ITEM;for(var i in aItem)
aResult.push({name:aItem[i].NAME?aItem[i].NAME[0].VALUE:'',email:aItem[i].EMAIL?aItem[i].EMAIL[0].VALUE:''});}
else
if(aItems.TICKET)
aResult=aItems.TICKET[0].VALUE;else
if(aItems.SIGNATURE){aResult=aItems.SIGNATURE[0].ITEM[0].VALUE;}
else
if(aItems.PERSONALITY){for(var i in aItems.PERSONALITY[0])
if(aItems.PERSONALITY[0][i][0]&&aItems.PERSONALITY[0][i][0].VALUE)
aResult[i]=aItems.PERSONALITY[0][i][0].VALUE;}
return aResult;};_me.signature_preview=function(sSignature,aHandler){var aRequest={'TOOLS':[{'SIGNATURE':[{'ITEM':[{VALUE:sSignature}]}]}]};this.create_iq(aRequest,[this,'response',['signature',aHandler]]);};

/* client/inc/wm_upload.js */
function wm_upload(){this.xmlns='upload';};wm_upload.inherit(wm_generic);var _me=wm_upload.prototype;_me.certificate=function(sFolder,sFile,sPass,aHandler){var request={UPLOAD:[{ATTRIBUTES:{TYPE:'certificate'},FOLDER:[{VALUE:sFolder}],FILE:[{VALUE:sFile}]}]};if(sPass)
request.UPLOAD[0].PASSPHRASE=[{VALUE:sPass}];this.create_iq(request,[this,'response',['certificate',aHandler]]);};_me.extract=function(sFolder,sFile,sClass,aHandler){var request={UPLOAD:[{ATTRIBUTES:{ACTION:'extract'},FOLDER:[{VALUE:sFolder}],FILE:[{VALUE:sFile}],CLASS:[{VALUE:sClass}]}]};this.create_iq(request,[this,'response',['extract',aHandler]],'','set');};_me.ticket=function(sFolder,sFile,sClass,aHandler){var request={UPLOAD:[{FOLDER:[{VALUE:sFolder}],FILE:[{VALUE:sFile}],CLASS:[{VALUE:sClass}]}]};this.create_iq(request,[this,'response',['ticket',aHandler]]);};_me.socks_connect=function(aData,aHandler){var request={UPLOAD:[{ATTRIBUTES:{ACTION:'socks_connect'},STREAMHOST:[]}]};for(var i in aData)
request.UPLOAD[0].STREAMHOST.push({ATTRIBUTES:{JID:aData[i].jid},HASH:[{VALUE:aData[i].hash}],HOST:[{VALUE:aData[i].host}]});this.create_iq(request,[this,'response',['socks_connect',aHandler]],'','set');};_me.socket=function(sFolder,sFile,sClass,sHash,aHandler){var request={UPLOAD:[{ATTRIBUTES:{'ACTION':'socks'},FOLDER:[{VALUE:sFolder}],FILE:[{VALUE:sFile}],CLASS:[{VALUE:sClass}],HASH:[{VALUE:sHash}]}]};this.create_iq(request,[this,'response',['socket',aHandler]],'','set');};_me.file2xml=function(sFolder,sFile,sJid,aHandler){var request={UPLOAD:[{FOLDER:[{VALUE:sFolder}],FILE:[{VALUE:sFile}],JID:[{VALUE:sJid}],ATTRIBUTES:{ACTION:'file2xml'}}]};this.create_iq(request,[this,'response',['file2xml',aHandler]],'','set','','',true);};_me.data2xml=function(sType,sData,sJid,aHandler){var request={UPLOAD:[{TYPE:[{VALUE:sType}],DATA:[{VALUE:sData}],NAME:[{VALUE:sJid}],JID:[{VALUE:sJid}],ATTRIBUTES:{ACTION:'data2xml'}}]};this.create_iq(request,[this,'response',['data2xml',aHandler]],'','set');};_me.response=function(aData,sMethodName,aHandler){var aXMLResponse=aData['Array'];var aIQAttribute=aXMLResponse['IQ'][0]['ATTRIBUTES'];switch(sMethodName){case'certificate':if(aHandler){if(aIQAttribute['TYPE']=='result')
executeCallbackFunction(aHandler,aXMLResponse.IQ[0].QUERY[0].DATA[0]);else
executeCallbackFunction(aHandler,null);}
break;case'ticket':if(aHandler){if(aIQAttribute['TYPE']=='result'){var aUpload=aXMLResponse.IQ[0].QUERY[0].UPLOAD[0];executeCallbackFunction(aHandler,{name:aUpload.NAME[0].VALUE,type:aUpload.TYPE[0].VALUE,ticket:aUpload.TICKET[0].VALUE});}
else
executeCallbackFunction(aHandler);}
break;case'socket':if(aHandler){if(aIQAttribute['TYPE']=='result'){var aUpload=aXMLResponse.IQ[0].QUERY[0].UPLOAD[0];executeCallbackFunction(aHandler,{name:aUpload.NAME[0].VALUE,size:aUpload.SIZE[0].VALUE});}
else
executeCallbackFunction(aHandler);}
break;case'extract':if(aIQAttribute['TYPE']=='result'){var sFolder=aXMLResponse.IQ[0].QUERY[0].FOLDER[0].VALUE,sFile=aXMLResponse.IQ[0].QUERY[0].FILE[0].VALUE,iSize=aXMLResponse.IQ[0].QUERY[0].SIZE[0].VALUE,iName=aXMLResponse.IQ[0].QUERY[0].NAME[0].VALUE;executeCallbackFunction(aHandler,sFolder,sFile,'file',iSize,iName);}
break;case'socks_connect':var out=false;if(aIQAttribute['TYPE']=='result')
out={jid:aXMLResponse.IQ[0].QUERY[0].UPLOAD[0].STREAMHOST[0].ATTRIBUTES.JID,socket:aXMLResponse.IQ[0].QUERY[0].UPLOAD[0].STREAMHOST[0].SOCKET[0].VALUE};executeCallbackFunction(aHandler,out);break;case'file2xml':if(aIQAttribute['TYPE']=='result'){var out,h;if(aXMLResponse.IQ[0].QUERY[0].DATA&&aXMLResponse.IQ[0].QUERY[0].DATA[0].VALUE)
out=aXMLResponse.IQ[0].QUERY[0].DATA[0].VALUE;if(aXMLResponse.IQ[0].QUERY[0].HASH&&aXMLResponse.IQ[0].QUERY[0].HASH[0].VALUE)
h=aXMLResponse.IQ[0].QUERY[0].HASH[0].VALUE;executeCallbackFunction(aHandler,out,h);}
break;case'data2xml':if(aHandler){var h;if(aXMLResponse.IQ[0].QUERY[0].HASH&&aXMLResponse.IQ[0].QUERY[0].HASH[0].VALUE)
h=aXMLResponse.IQ[0].QUERY[0].HASH[0].VALUE;executeCallbackFunction(aHandler,h);}}};